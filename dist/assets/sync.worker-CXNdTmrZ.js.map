{"version":3,"file":"sync.worker-CXNdTmrZ.js","sources":["../src/workers/sync.worker.ts"],"sourcesContent":["/**\r\n * MUSIXQUARE 2.0 â€” Sync Worker (Background Timers)\r\n * Ported from js/sync.worker.js\r\n *\r\n * Timer & Heartbeat background tasks with robust error handling.\r\n */\r\n\r\n'use strict';\r\n\r\n// self is already typed as DedicatedWorkerGlobalScope in WebWorker lib\r\n\r\nconst timers = new Map<string, ReturnType<typeof setInterval>>();\r\n\r\nfunction toId(v: unknown): string {\r\n  if (v === null || v === undefined) return '';\r\n  return String(v);\r\n}\r\n\r\nfunction normalizeIntervalMs(v: unknown, fallback = 1000): number {\r\n  const n = Number(v);\r\n  if (!Number.isFinite(n)) return fallback;\r\n  return Math.max(1, Math.floor(n));\r\n}\r\n\r\nfunction startTimer(id: string, intervalMs: number): void {\r\n  if (!id) return;\r\n  stopTimer(id);\r\n\r\n  const ms = normalizeIntervalMs(intervalMs);\r\n  const handle = setInterval(() => {\r\n    try {\r\n      self.postMessage({ type: 'TICK', id });\r\n    } catch { /* ignore */ }\r\n  }, ms);\r\n\r\n  timers.set(id, handle);\r\n}\r\n\r\nfunction stopTimer(id: string): void {\r\n  const handle = timers.get(id);\r\n  if (handle !== undefined) {\r\n    clearInterval(handle);\r\n    timers.delete(id);\r\n  }\r\n}\r\n\r\nfunction stopAllTimers(): void {\r\n  for (const [, handle] of timers.entries()) {\r\n    clearInterval(handle);\r\n  }\r\n  timers.clear();\r\n}\r\n\r\nself.onmessage = (e: MessageEvent) => {\r\n  const data = (e && e.data) ? e.data : {};\r\n  const command = data.command as string | undefined;\r\n\r\n  try {\r\n    switch (command) {\r\n      case 'START_TIMER': {\r\n        const id = toId(data.id);\r\n        const interval = normalizeIntervalMs(data.interval);\r\n        startTimer(id, interval);\r\n        break;\r\n      }\r\n      case 'STOP_TIMER': {\r\n        const id = toId(data.id);\r\n        stopTimer(id);\r\n        break;\r\n      }\r\n      case 'STOP_ALL': {\r\n        stopAllTimers();\r\n        break;\r\n      }\r\n      case 'INIT_INSTANCE': {\r\n        // No-op by design\r\n        break;\r\n      }\r\n      default:\r\n        break;\r\n    }\r\n  } catch (err: unknown) {\r\n    try {\r\n      const e2 = err as Error;\r\n      self.postMessage({\r\n        type: 'WORKER_ERROR',\r\n        scope: 'sync',\r\n        command,\r\n        error: e2?.message ?? String(err),\r\n        stack: e2?.stack,\r\n      });\r\n    } catch { /* ignore */ }\r\n  }\r\n};\r\n\r\nself.addEventListener('error', (e) => {\r\n  try {\r\n    self.postMessage({\r\n      type: 'WORKER_ERROR',\r\n      scope: 'sync',\r\n      command: 'WORKER_ERROR',\r\n      error: e?.message ?? 'Worker error',\r\n    });\r\n  } catch { /* ignore */ }\r\n});\r\n\r\nself.addEventListener('unhandledrejection', (e) => {\r\n  try {\r\n    const reason = e?.reason as Error | undefined;\r\n    self.postMessage({\r\n      type: 'WORKER_ERROR',\r\n      scope: 'sync',\r\n      command: 'UNHANDLED_REJECTION',\r\n      error: reason?.message ?? String(reason),\r\n    });\r\n  } catch { /* ignore */ }\r\n});\r\n\r\nself.addEventListener('messageerror', () => {\r\n  try {\r\n    self.postMessage({\r\n      type: 'WORKER_ERROR',\r\n      scope: 'sync',\r\n      command: 'MESSAGE_ERROR',\r\n      error: 'Message deserialization failed',\r\n    });\r\n  } catch { /* ignore */ }\r\n});\r\n"],"names":["timers","toId","v","normalizeIntervalMs","fallback","n","startTimer","id","intervalMs","stopTimer","ms","handle","stopAllTimers","data","command","interval","err","e2","reason"],"mappings":"AAWA,MAAMA,MAAa,IAEnB,SAASC,EAAKC,EAAoB,CAChC,OAAIA,GAAM,KAAgC,GACnC,OAAOA,CAAC,CACjB,CAEA,SAASC,EAAoBD,EAAYE,EAAW,IAAc,CAChE,MAAMC,EAAI,OAAOH,CAAC,EAClB,OAAK,OAAO,SAASG,CAAC,EACf,KAAK,IAAI,EAAG,KAAK,MAAMA,CAAC,CAAC,EADAD,CAElC,CAEA,SAASE,EAAWC,EAAYC,EAA0B,CACxD,GAAI,CAACD,EAAI,OACTE,EAAUF,CAAE,EAEZ,MAAMG,EAAKP,EAAoBK,CAAU,EACnCG,EAAS,YAAY,IAAM,CAC/B,GAAI,CACF,KAAK,YAAY,CAAE,KAAM,OAAQ,GAAAJ,EAAI,CACvC,MAAQ,CAAe,CACzB,EAAGG,CAAE,EAELV,EAAO,IAAIO,EAAII,CAAM,CACvB,CAEA,SAASF,EAAUF,EAAkB,CACnC,MAAMI,EAASX,EAAO,IAAIO,CAAE,EACxBI,IAAW,SACb,cAAcA,CAAM,EACpBX,EAAO,OAAOO,CAAE,EAEpB,CAEA,SAASK,GAAsB,CAC7B,SAAW,CAAA,CAAGD,CAAM,IAAKX,EAAO,UAC9B,cAAcW,CAAM,EAEtBX,EAAO,MAAA,CACT,CAEA,KAAK,UAAa,GAAoB,CACpC,MAAMa,EAAQ,GAAK,EAAE,KAAQ,EAAE,KAAO,CAAA,EAChCC,EAAUD,EAAK,QAErB,GAAI,CACF,OAAQC,EAAA,CACN,IAAK,cAAe,CAClB,MAAMP,EAAKN,EAAKY,EAAK,EAAE,EACjBE,EAAWZ,EAAoBU,EAAK,QAAQ,EAClDP,EAAWC,EAAIQ,CAAQ,EACvB,KACF,CACA,IAAK,aAAc,CACjB,MAAMR,EAAKN,EAAKY,EAAK,EAAE,EACvBJ,EAAUF,CAAE,EACZ,KACF,CACA,IAAK,WAAY,CACfK,EAAA,EACA,KACF,CACA,IAAK,gBAEH,MAEF,QACE,KAAA,CAEN,OAASI,EAAc,CACrB,GAAI,CACF,MAAMC,EAAKD,EACX,KAAK,YAAY,CACf,KAAM,eACN,MAAO,OACP,QAAAF,EACA,MAAOG,GAAI,SAAW,OAAOD,CAAG,EAChC,MAAOC,GAAI,KAAA,CACZ,CACH,MAAQ,CAAe,CACzB,CACF,EAEA,KAAK,iBAAiB,QAAU,GAAM,CACpC,GAAI,CACF,KAAK,YAAY,CACf,KAAM,eACN,MAAO,OACP,QAAS,eACT,MAAO,GAAG,SAAW,cAAA,CACtB,CACH,MAAQ,CAAe,CACzB,CAAC,EAED,KAAK,iBAAiB,qBAAuB,GAAM,CACjD,GAAI,CACF,MAAMC,EAAS,GAAG,OAClB,KAAK,YAAY,CACf,KAAM,eACN,MAAO,OACP,QAAS,sBACT,MAAOA,GAAQ,SAAW,OAAOA,CAAM,CAAA,CACxC,CACH,MAAQ,CAAe,CACzB,CAAC,EAED,KAAK,iBAAiB,eAAgB,IAAM,CAC1C,GAAI,CACF,KAAK,YAAY,CACf,KAAM,eACN,MAAO,OACP,QAAS,gBACT,MAAO,gCAAA,CACR,CACH,MAAQ,CAAe,CACzB,CAAC"}