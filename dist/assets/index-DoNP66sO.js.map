{"version":3,"mappings":"ssBAKO,MAAMA,GAAY,CACvB,MAAO,EACP,KAAM,EACN,KAAM,EACN,MAAO,EACP,OAAQ,CACV,EAIA,IAAIC,GAA2BD,GAAU,KAGzC,GAAI,CACF,MAAME,EAAO,WAAW,UAAU,UAC9BA,IAAS,aAAeA,IAAS,aAAeA,IAAS,aAC3DD,GAAYD,GAAU,MAE1B,MAAQ,CAER,CAWO,MAAMG,EAAM,CACjB,MAAO,IAAIC,IAA0B,CAC/BH,IAAaD,GAAU,OAAO,QAAQ,MAAM,GAAGI,CAAI,CACzD,EACA,KAAM,IAAIA,IAA0B,CAC9BH,IAAaD,GAAU,MAAM,QAAQ,KAAK,GAAGI,CAAI,CACvD,EACA,KAAM,IAAIA,IAA0B,CAC9BH,IAAaD,GAAU,MAAM,QAAQ,KAAK,GAAGI,CAAI,CACvD,EACA,MAAO,IAAIA,IAA0B,CAC/BH,IAAaD,GAAU,OAAO,QAAQ,MAAM,GAAGI,CAAI,CACzD,CACF,ECtCA,MAAMC,EAAa,CACT,eAAiB,IAKzB,GAAuBC,EAAUC,EAA0B,CACzD,IAAIC,EAAM,KAAK,WAAW,IAAIF,CAAe,EAC7C,OAAKE,IACHA,MAAU,IACV,KAAK,WAAW,IAAIF,EAAiBE,CAAG,GAE1CA,EAAI,IAAID,CAAE,EACH,IAAM,KAAK,IAAID,EAAOC,CAAE,CACjC,CAKA,KAAyBD,EAAUC,EAA0B,CAC3D,MAAME,EAAoB,IAAIL,IAAS,CACrC,KAAK,IAAIE,EAAOG,CAAO,EACvBF,EAAG,GAAGH,CAAI,CACZ,EACA,OAAO,KAAK,GAAGE,EAAOG,CAAO,CAC/B,CAKA,IAAwBH,EAAUC,EAAoB,CACpD,MAAMC,EAAM,KAAK,WAAW,IAAIF,CAAe,EAC3CE,IACFA,EAAI,OAAOD,CAAE,EACTC,EAAI,OAAS,GAAG,KAAK,WAAW,OAAOF,CAAe,EAE9D,CAKA,KAAyBA,KAAaF,EAAuB,CAC3D,MAAMI,EAAM,KAAK,WAAW,IAAIF,CAAe,EAC/C,GAAKE,EACL,UAAWD,KAAMC,EACf,GAAI,CACFD,EAAG,GAAGH,CAAI,CACZ,OAASM,EAAG,CACV,QAAQ,MAAM,oCAAoCJ,CAAe,KAAMI,CAAC,CAC1E,CAEJ,CAKA,MAAMJ,EAAwB,CACxBA,EACF,KAAK,WAAW,OAAOA,CAAe,EAEtC,KAAK,WAAW,OAEpB,CAKA,OAAgC,CAC9B,MAAMK,EAAiC,GACvC,SAAW,CAACC,EAAKJ,CAAG,IAAK,KAAK,WAC5BG,EAAOC,CAAG,EAAIJ,EAAI,KAEpB,OAAOG,CACT,CACF,CAGO,MAAME,EAAM,IAAIR,GC/EVS,GACV,mBAAmB,KAAK,UAAU,SAAS,GAAK,CAAE,OAA8C,UAChG,UAAU,WAAa,YAAc,UAAU,eAAiB,EAEtDC,GAAsB,WAAW,KAAK,UAAU,SAAS,EAE/D,SAASC,IAAmC,CACjD,GAAI,CAEF,GADK,UAAiD,YAClD,OAAO,aAAa,4BAA4B,EAAE,QAAS,MAAO,EACxE,MAAQ,CAER,CACA,MAAO,EACT,CAIO,SAASC,IAA4B,CAC1C,GAAKH,GACL,UAAWI,IAAO,CAAC,eAAgB,gBAAiB,YAAY,EAC9D,SAAS,iBAAiBA,EAAMR,GAAMA,EAAE,iBAAkB,CAAE,QAAS,GAAO,CAEhF,CAIA,IAAIS,GAAgB,EAChBC,GAAqB,EACrBC,GAA0B,GAE9B,SAASC,IAA2B,CAClC,MAAMC,EAAO,SAAS,gBAGtB,GAAI,CAACF,GAAyB,CAC5B,GAAI,CACEP,IAAQS,EAAK,UAAU,IAAI,KAAK,EAChCR,IAAYQ,EAAK,UAAU,IAAI,SAAS,EACxCT,IAAUE,GAAA,GAA2BO,EAAK,UAAU,IAAI,gBAAgB,EACxEP,GAAA,GAA2BO,EAAK,UAAU,IAAI,YAAY,CAChE,MAAQ,CAER,CACAF,GAA0B,EAC5B,CAEA,MAAMG,EAAK,OAAO,eACZC,EAAeT,GAAA,EAErB,IAAIU,EAAc,GAClB,GAAI,CACFA,EAAc,CAAC,CAAC,OAAO,aAAa,0BAA0B,EAAE,OAClE,MAAQ,CACNA,EAAc,OAAO,WAAa,OAAO,WAC3C,CAGA,MAAMC,EAAyB,GAC3BH,GAAM,OAAO,SAASA,EAAG,MAAM,GAAKA,EAAG,OAAS,KAAgB,KAAK,KAAK,MAAMA,EAAG,MAAM,CAAC,EAC1F,OAAO,SAAS,OAAO,WAAW,GAAK,OAAO,YAAc,GAAGG,EAAa,KAAK,KAAK,MAAM,OAAO,WAAW,CAAC,EAC/GJ,GAAQ,OAAO,SAASA,EAAK,YAAY,GAAKA,EAAK,aAAe,KAAgB,KAAK,KAAK,MAAMA,EAAK,YAAY,CAAC,EAExH,IAAIK,EAAID,EAAa,OAAS,EAAI,KAAK,IAAI,GAAGA,CAAY,EAAI,EAG1DE,EAAgB,EACpB,MAAMC,EAAM,OAAO,QAAW,GAE9B,GAAIf,IAAcW,EAAa,CAE7B,GAAI,OAAO,SAAS,OAAO,WAAW,GAAK,OAAO,YAAc,GAC5D,OAAO,SAAS,OAAO,WAAW,GAAK,OAAO,YAAc,EAAG,CACjE,MAAMK,EAAQ,KAAK,MAAM,OAAO,YAAc,OAAO,WAAW,EAC5DA,EAAQ,IAAGF,EAAgB,KAAK,IAAIE,CAAK,EAC/C,CAGA,GAAIF,IAAkB,GAAKC,EAAI,aAAe,MAAQA,EAAI,YAAc,KAAM,CAC5E,MAAME,EAAK,KAAK,OAAOF,EAAI,QAAU,IAAMA,EAAI,aAAe,EAAE,EAC5DE,EAAK,GAAKA,EAAK,MAAKH,EAAgBG,EAC1C,CAGA,GAAIH,IAAkB,EAAG,CACvB,MAAMI,EAAU,KAAK,IAAIH,EAAI,QAAU,IAAUA,EAAI,OAAS,GAAQ,EAClE,OAAO,SAASG,CAAO,GAAKA,EAAU,KACpC,KAAK,IAAIL,EAAIK,CAAO,EAAI,IAAGJ,EAAgB,GAEnD,CAGIA,EAAgB,MAAKA,EAAgB,IACrCA,EAAgB,IAAGA,EAAgB,GAGnCA,EAAgB,EAClBT,GAAqBS,EACZT,GAAqB,GAAKM,IACnCG,EAAgBT,IAGdS,EAAgB,GAAKD,EAAIC,IAC3BD,GAAKC,EACL1B,EAAI,KAAK,sDAAsD0B,CAAa,IAAI,EAEpF,MAAYH,IACVN,GAAqB,GAUvB,GANIN,IAAUW,GAAgB,CAACC,GAAe,OAAO,QACjD,OAAO,SAAS,OAAO,OAAO,MAAM,GAAK,OAAO,OAAO,OAAS,IAClEE,EAAI,KAAK,IAAIA,EAAG,KAAK,MAAM,OAAO,OAAO,MAAM,CAAC,GAI9CA,EAAI,EACN,GAAI,CAAEL,EAAK,MAAM,YAAY,eAAgB,GAAGK,CAAC,IAAI,CAAG,MAAQ,CAAe,CAGjF,MAAMM,EAAanB,IAAcW,GAAeG,EAAgB,EAAKA,EAAgB,EACrF,GAAI,CAAEN,EAAK,MAAM,YAAY,oBAAqB,GAAGW,CAAS,IAAI,CAAG,MAAQ,CAAe,CAC9F,CAEA,SAASC,IAAgC,CACvC,GAAI,CAAAhB,GACJ,GAAI,CACFA,GAAgB,sBAAsB,IAAM,CAC1CA,GAAgB,EAChB,GAAI,CAAEG,GAAA,CAAsB,MAAQ,CAAe,CACrD,CAAC,CACH,MAAQ,CACNH,GAAgB,EAChB,GAAI,CAAEG,GAAA,CAAsB,MAAQ,CAAe,CACrD,CACF,CAMO,SAASc,IAAqB,CACnCnB,GAAA,EAEA,MAAMoB,EAAM,IAAM,CAChBF,GAAA,EACIpB,KACF,WAAWoB,GAAyB,GAAG,EACvC,WAAWA,GAAyB,IAAI,EAE5C,EAEI,SAAS,aAAe,UAC1B,SAAS,iBAAiB,mBAAoBE,EAAK,CAAE,KAAM,GAAM,EAEjEA,EAAA,EAGF,GAAI,CACF,OAAO,iBAAiB,SAAUF,GAAyB,CAAE,QAAS,GAAM,EAC5E,OAAO,iBAAiB,oBAAqB,IAAM,CACjDA,GAAA,EACIpB,IAAY,WAAWoB,GAAyB,GAAG,CACzD,EAAG,CAAE,QAAS,GAAM,EACpB,OAAO,iBAAiB,WAAYA,GAAyB,CAAE,QAAS,GAAM,EAC9E,SAAS,iBAAiB,mBAAoB,IAAM,CAC9C,SAAS,kBAAoB,WAAWA,GAAA,CAC9C,CAAC,EACG,OAAO,iBACT,OAAO,eAAe,iBAAiB,SAAUA,GAAyB,CAAE,QAAS,GAAM,EAC3F,OAAO,eAAe,iBAAiB,SAAUA,GAAyB,CAAE,QAAS,GAAM,EAE/F,MAAQ,CAER,CACF,CChLO,MAAMG,GACX,OAAO,OAAO,YAAe,WACzB,OAAO,aACP,KAAK,MAAM,SAAS,EAAE,EAAI,KAAK,SAAS,SAAS,EAAE,EAAE,MAAM,EAAG,EAAE,EAItE,IAAIC,GAAwB,KAAK,MAAM,KAAK,MAAQ,GAAI,EAAI,KAAK,MAAM,KAAK,SAAW,GAAM,EAEtF,SAASC,IAAwB,CACtC,MAAO,EAAED,EACX,CAIA,MAAME,OAA2B,IAS1B,SAASC,GAAkBC,EAAaC,EAAS,GAAe,CACrE,MAAM,EAAI,OAAOD,CAAE,EACbE,EAAM,OAAO,SAAS,CAAC,EAAI,KAAK,MAAM,CAAC,EAAI,EAGjD,GAAI,EADO,OAAO,cAAcA,CAAG,GAAKA,EAAM,GACrC,CACP,MAAMjC,EAAM,OAAO+B,CAAE,EAOrB,GALIF,GAAqB,KAAO,KAAKA,GAAqB,QACrDA,GAAqB,IAAI7B,CAAG,IAC/B6B,GAAqB,IAAI7B,CAAG,EAC5BT,EAAI,KAAK,gCAAgC,OAAOwC,CAAE,KAAMA,CAAE,GAExDC,EACF,MAAM,IAAI,MAAM,sBAAsBD,CAAE,EAAE,EAE5C,MAAO,EACT,CACA,OAAOE,CACT,CC9CO,MAAMC,EAAY,CACvB,KAAM,OACN,OAAQ,SACR,cAAe,gBACf,cAAe,gBACf,gBAAiB,iBACnB,EAKaC,EAAiB,CAC5B,KAAM,OACN,UAAW,YACX,WAAY,aACZ,MAAO,OACT,EAKaC,GAAa,MAEbC,GAAmB,KAEnBC,GAAuB,EACvBC,GAAmB,CAAC,IAAM,IAAM,GAAK,EAGrCC,GAAQ,CACnB,KAAM,GACN,aAAc,GACd,WAAY,IACZ,MAAO,IACP,WAAY,IACZ,SAAU,IACV,iBAAkB,IAClB,gBAAiB,IACjB,aAAc,IACd,kBAAmB,GACrB,EAGaC,GAAkB,EAElBC,GAAmB,OAGnBC,EAAM,CACjB,mBAAoB,qBACpB,KAAM,OACN,WAAY,aACZ,mBAAoB,qBACpB,SAAU,WACV,UAAW,YACX,WAAY,aACZ,SAAU,WACV,aAAc,eACd,YAAa,cACb,WAAY,aACZ,UAAW,YACX,sBAAuB,wBACvB,cAAe,gBACf,sBAAuB,wBACvB,UAAW,YACX,cAAe,gBACf,MAAO,QACP,aAAc,eACd,KAAM,OACN,SAAU,WACV,gBAAiB,kBACjB,eAAgB,iBAChB,aAAc,eACd,OAAQ,SACR,YAAa,cACb,cAAe,gBACf,YAAa,cACb,cAAe,gBACf,YAAa,cACb,qBAAsB,uBACtB,sBAAuB,wBACvB,iBAAkB,mBAClB,qBAAsB,uBACtB,mBAAoB,qBACpB,cAAe,gBACf,aAAc,eACd,mBAAoB,qBACpB,aAAc,eACd,gBAAiB,kBACjB,kBAAmB,oBACnB,qBAAsB,uBACtB,sBAAuB,wBACvB,qBAAsB,uBACtB,8BAA+B,gCAC/B,yBAA0B,2BAC1B,OAAQ,SACR,aAAc,eACd,eAAgB,iBAChB,cAAe,gBACf,gBAAiB,kBACjB,YAAa,cACb,aAAc,eACd,YAAa,cACb,aAAc,eACd,cAAe,gBACf,gBAAiB,kBACjB,eAAgB,iBAChB,gBAAiB,kBACjB,MAAO,QACP,OAAQ,SACR,QAAS,UACT,cAAe,gBACf,aAAc,eACd,aAAc,eACd,sBAAuB,wBACvB,cAAe,gBACf,yBAA0B,2BAC1B,aAAc,eACd,aAAc,eACd,UAAW,WACb,EAKaC,GAAiB,CAAC,GAAI,IAAK,IAAK,KAAM,IAAK,EAU3CC,GAAiB,iBACjBC,GAAa,uCC+C1B,SAASC,IAAgC,CACvC,MAAO,CACL,SAAUb,EAAU,KACpB,qBAAsB,GAEtB,QAAS,CACP,OAAQ,KACR,WAAY,KACZ,OAAQ,KACR,QAAS,IAGX,MAAO,CACL,eAAgB,IAGlB,OAAQ,CACN,UAAW,EACX,SAAU,EACV,UAAW,GACX,aAAc,GACd,oBAAqB,EACrB,iBAAkB,EAClB,iBAAkB,IAGpB,SAAU,CACR,MAAOC,EAAe,KACtB,cAAe,EACf,KAAM,GACN,eAAgB,EAChB,iBAAkB,EAClB,uBAAwB,KACxB,0BAA2B,EAC3B,iBAAkB,IAGpB,QAAS,CACP,aAAc,GACd,UAAW,EACX,MAAO,EACP,KAAM,KACN,eAAgB,GAChB,aAAc,KACd,aAAc,GACd,WAAY,GACZ,aAAc,KACd,YAAa,IACb,iBAAkB,IAClB,SAAU,MAGZ,MAAO,CACL,aAAc,EACd,cAAe,EACf,YAAa,EACb,eAAgB,GAChB,qBAAsB,GACtB,UAAW,EACX,YAAa,EACb,eAAgB,GAChB,aAAc,EACd,cAAe,EACf,WAAY,OACZ,SAAU,CAAC,EAAG,EAAG,EAAG,EAAG,CAAC,EACxB,YAAa,EACb,YAAa,EACb,QAAS,IACT,eAAgB,GAGlB,KAAM,CACJ,YAAa,EACb,eAAgB,EAChB,oBAAqB,GACrB,cAAe,EACf,eAAgB,GAChB,mBAAoB,EACpB,gBAAiB,EACjB,YAAa,MAGf,QAAS,CACP,KAAM,KACN,cAAe,OACf,QAAS,OACT,YAAa,GACb,aAAc,GACd,SAAU,KACV,eAAgB,GAChB,WAAY,GACZ,aAAc,GACd,wBAAyB,GACzB,oBAAqB,KACrB,cAAe,EACf,WAAY,GACZ,UAAW,CAAC,KAAM,KAAM,KAAM,IAAI,EAClC,qBAAsB,IACtB,2BAA4B,GAAI,EAGlC,MAAO,CACL,iBAAkB,KAClB,oBAAqB,GACrB,WAAY,GACZ,WAAY,IAGd,SAAU,CACR,MAAO,GACP,kBAAmB,GACnB,WAAY,EACZ,UAAW,GACX,iBAAkB,IAGpB,MAAO,CACL,gBAAiB,KACjB,mBAAoB,KACpB,gBAAiB,CAAE,KAAM,MACzB,gBAAiB,CAAE,KAAM,KAAK,EAGhC,QAAS,CACP,iBAAkB,EAClB,gBAAiB,GACjB,YAAa,GACb,cAAe,GACf,YAAa,KACb,YAAa,MAGf,SAAU,CACR,QAAS,GACT,WAAY,GACZ,YAAa,GACb,WAAY,EACZ,gBAAiB,GACjB,iBAAkB,OAClB,gBAAiB,QAGnB,GAAI,CACF,YAAa,KACb,SAAU,KACV,iBAAkB,GAClB,gBAAiB,EACnB,CAEJ,CAIA,IAAIa,GAAoBD,GAAA,EASjB,SAASE,EAAsBC,EAAiB,CACrD,MAAMC,EAAOD,EAAK,MAAM,GAAG,EAC3B,IAAIE,EAAmBJ,GACvB,UAAWhD,KAAOmD,EAAM,CACtB,GAAIC,GAAW,MAAQ,OAAOA,GAAY,SAAU,OACpDA,EAAWA,EAAoCpD,CAAG,CACpD,CACA,OAAOoD,CACT,CAMO,SAASC,EAASH,EAAcI,EAAsB,CAC3D,MAAMH,EAAOD,EAAK,MAAM,GAAG,EAC3B,IAAIE,EAAmCJ,GAEvC,QAASO,EAAI,EAAGA,EAAIJ,EAAK,OAAS,EAAGI,IAAK,CACxC,MAAMvD,EAAMmD,EAAKI,CAAC,GACdH,EAAQpD,CAAG,GAAK,MAAQ,OAAOoD,EAAQpD,CAAG,GAAM,YAClDoD,EAAQpD,CAAG,EAAI,IAEjBoD,EAAUA,EAAQpD,CAAG,CACvB,CAEA,MAAMwD,EAAUL,EAAKA,EAAK,OAAS,CAAC,EAEpC,GADiBC,EAAQI,CAAO,IACfF,EAAO,OAExBF,EAAQI,CAAO,EAAIF,EAGnB,IAAIG,EAAY,GAChB,UAAWzD,KAAOmD,EAChBM,EAAYA,EAAY,GAAGA,CAAS,IAAIzD,CAAG,GAAKA,EAChDC,EAAI,KAAK,SAASwD,CAAS,GAAIH,EAAOJ,CAAI,CAE9C,CAKO,SAASQ,GAAcC,EAAwC,CACpE,SAAW,CAACT,EAAMI,CAAK,IAAK,OAAO,QAAQK,CAAO,EAChDN,EAASH,EAAMI,CAAK,CAExB,CAKO,SAASM,IAAgC,CAC9C,OAAOZ,EACT,CC5TA,IAAIa,GAA6B,KAC7BC,GAA6B,KAC7BC,GAA6B,KAC7BC,GAA6B,KAC7BC,EAAkC,KAClCC,GAAgC,KAChCC,GAAmC,KACnCC,GAAoC,KACpCC,GAAyC,KACzCC,GAA4B,GAC5BC,GAA8B,KAC9BC,GAAkC,KAClCC,GAAuC,KACvCC,GAAoC,KACpCC,GAAkC,KAClCC,GAA2B,KAC3BC,GAAsC,KACtCC,GAA8B,KAC9BC,GAAoC,KACpCC,GAAoC,KAEpCC,GAA0C,KAIvC,SAASC,IAAqC,CAAE,OAAOjB,CAAY,CAGnE,SAASkB,IAAgC,CAAE,OAAOrB,EAAW,CAC7D,SAASsB,IAAgC,CAAE,OAAOrB,EAAO,CACzD,SAASsB,IAAgC,CAAE,OAAOrB,EAAO,CACzD,SAASsB,IAAiC,CAAE,OAAOf,EAAQ,CAC3D,SAASgB,IAAqC,CAAE,OAAOf,EAAS,CAChE,SAASgB,IAAmC,CAAE,OAAOtB,EAAQ,CAC7D,SAASuB,IAAsC,CAAE,OAAOtB,EAAW,CACnE,SAASuB,IAAuC,CAAE,OAAOtB,EAAY,CACrE,SAASuB,IAA4C,CAAE,OAAOtB,EAAc,CAC5E,SAASuB,IAA+B,CAAE,OAAOtB,EAAS,CAC1D,SAASuB,IAA0C,CAAE,OAAOpB,EAAe,CAC3E,SAASqB,IAAqC,CAAE,OAAOnB,EAAU,CAEjE,SAASoB,IAAyC,CAAE,OAAOlB,EAAc,CACzE,SAASmB,IAAiC,CAAE,OAAOlB,EAAQ,CAC3D,SAASmB,IAAuC,CAAE,OAAOlB,EAAkB,CAC3E,SAASmB,IAAuC,CAAE,OAAOlB,EAAc,CACvE,SAASmB,IAAwB,CAAE,OAAOlC,IAAe,IAAM,CAG/D,SAASmC,IAAkE,CAChF,OAAKrB,KACHA,GAAmB,IAAI,KAAK,MAAM,CAAC,EACnCC,GAAe,IAAI,KAAK,KAAK,CAAC,GAEzB,CAAE,SAAUD,GAAkB,KAAMC,EAAA,CAC7C,CAQA,eAAsBqB,IAA2B,CAE/C,GAAIpC,EAAY,CACd,GAAI,OAAO,KAAS,KAAe,MAAM,SAAS,QAAU,UAC1D,GAAI,CAAE,MAAM,KAAK,OAAS,MAAQ,CAAoB,CAExD,MACF,CAGA,GAAIgB,GAAmB,OAAOA,GAE9BA,GAAoBqB,GAAA,EAEpB,GAAI,CACF,MAAMrB,EACR,SACEA,GAAoB,IACtB,CACF,CAEA,eAAeqB,IAA8B,CAC3C,GAAI,OAAO,KAAS,KAAe,CAAC,MAAM,QACxC,MAAM,IAAI,MAAM,oBAAoB,EAMtC,GAHI,KAAK,QAAQ,QAAU,WACzB,MAAM,KAAK,QAETrC,EAAY,OAGhBJ,GAAY,IAAI,KAAK,MACrBC,GAAY,IAAI,KAAK,MACrBC,GAAQ,IAAI,KAAK,KAAK,CAAC,EACvBC,GAAQ,IAAI,KAAK,KAAK,CAAC,EAEvBH,GAAU,QAAQE,GAAO,CAAC,EAC1BF,GAAU,QAAQG,GAAO,CAAC,EAG1BD,GAAM,QAAQD,GAAW,EAAG,CAAC,EAC7BE,GAAM,QAAQF,GAAW,EAAG,CAAC,EAG7BG,EAAa,IAAI,KAAK,KAAK,CAAC,EAG5BK,GAAU1B,GAAe,IAAI2D,GAC3B,IAAI,KAAK,OAAO,CAAE,KAAM,UAAW,UAAWA,EAAG,EAAG,EAAK,KAAM,EAAG,GAIpEhC,GAAS,IAAI,KAAK,KAAK,CAAC,EACxBC,GAAU,IAAI,KAAK,cAAc,CAAC,EAGlCN,GAAS,IAAI,KAAK,OAAO,CAAE,MAAO,EAAK,SAAU,GAAK,EACtDA,GAAO,IAAI,MAAQ,EAEnB,GAAI,CACF,MAAMA,GAAO,UACf,OAASsC,EAAW,CAElB,MAAC3C,GAAWC,GAAWC,GAAOC,GAAOC,EAAYM,GAAQC,GAASN,EAAM,EAAE,QAAQ,GAAK,CACrF,GAAI,CAAM,KAAK,SAAW,MAAQ,CAAQ,CAC5C,CAAC,EACDL,GAAYC,GAAYC,GAAQC,GAAQC,EAAaM,GAASC,GAAU,KACxEN,GAAS,KACTI,GAAU,GACJkC,CACR,CAGArC,GAAY,IAAI,KAAK,OAAO,GAAI,WAAY,GAAG,EAC/CC,GAAa,IAAI,KAAK,OAAO,IAAO,UAAW,GAAG,EAClDC,GAAe,IAAI,KAAK,UAAU,CAAC,EAGnCM,GAAW,IAAI,KAAK,OAAO,IAAK,UAAW,GAAG,EAC9CC,GAAU,IAAI,KAAK,UAAU,EAAE,EAC/BC,GAAe,IAAI,KAAK,OAAO,IAAO,UAAW,GAAG,EACpDC,GAAS,IAAI,KAAK,KAAK,CAAC,EAMxBN,GAAQ,QAAQD,EAAM,EAGtBA,GAAO,QAAQV,EAAS,EAGxBY,GAAgB,IAAI,KAAK,OAAO,IAAO,SAAS,EAChDX,GAAU,QAAQW,EAAa,EAE/B,IAAIgC,EAAiBhC,GACrB,UAAWiC,KAAMpC,GACfmC,EAAK,QAAQC,CAAE,EACfD,EAAOC,EAITD,EAAK,QAAQpC,GAAa,CAAC,EAC3BoC,EAAK,QAAQvC,EAAM,EACnBA,GAAO,QAAQC,EAAS,EACxBA,GAAU,QAAQC,EAAU,EAC5BA,GAAW,QAAQC,GAAa,CAAC,EACjCA,GAAa,QAAQJ,CAAU,EAG/BwC,EAAK,QAAQ9B,EAAQ,EACrBA,GAAS,QAAQC,EAAO,EACxBA,GAAQ,QAAQC,EAAY,EAC5BA,GAAa,QAAQC,EAAM,EAC3BA,GAAO,QAAQb,CAAU,EAGzBS,GAAW,IAAI,KAAK,SAAS,MAAO,IAAI,EACxCA,GAAS,UAAY,GACrBT,EAAW,QAAQS,EAAQ,EAC3BT,EAAW,gBAGXZ,EAAS,iBAAkBqB,EAAQ,EAInC,GAAI,CACF,MAAMiC,EAAc,SAAS,eAAe,gBAAgB,EACxDA,GACFA,EAAY,OAAO,MAAM7G,GAAKP,EAAI,MAAM,mCAAoCO,CAAC,CAAC,EAIhF,MAAM8G,EAAU,SAAS,eAAe,YAAY,EAChDA,GACFA,EAAQ,OAAO,KAAK,IAAMA,EAAQ,OAAO,EAAE,MAAM9G,GAAKP,EAAI,MAAM,8BAA+BO,CAAC,CAAC,CAErG,OAASA,EAAG,CACVP,EAAI,MAAM,qCAAsCO,CAAC,CACnD,CAEAP,EAAI,KAAK,mCAAmC,EAC5CU,EAAI,KAAK,aAAa,CACxB,CAuBAA,EAAI,GAAG,oBAAqB,IAAIT,IAAoB,CAClD,MAAMqH,EAAM,OAAOrH,EAAK,CAAC,CAAC,EAC1B,GAAI,CAAC,OAAO,SAASqH,CAAG,EAAG,OAC3B,MAAMC,EAAU,KAAK,IAAI,EAAG,KAAK,IAAI,EAAGD,CAAG,CAAC,EAC5CxD,EAAS,qBAAsByD,CAAO,EAClC7C,GACFA,EAAW,KAAK,OAAO6C,EAAS,EAAG,EAErC7G,EAAI,KAAK,uBAAwB6G,CAAO,EAExC7G,EAAI,KAAK,qBAAsB,KAAK,MAAM6G,EAAU,GAAG,CAAC,EAExD7G,EAAI,KAAK,2BAA4B6G,CAAO,CAC9C,IAGA7G,EAAI,GAAG,8BAA+B,IAAM,CAC1C,MAAM4G,EAAM5D,EAAiB,oBAAoB,GAAK,EAKtDhD,EAAI,KAAK,qBAAsB,KAAK,MAAM4G,EAAM,GAAG,CAAC,CACtD,IAGA5G,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMuH,EAAavH,EAAK,CAAC,EACnBwH,EAAaxH,EAAK,CAAC,EACzB,GAAI,CAACuH,EAAY,OAEjB,KAAM,CAAE,SAAAE,EAAU,KAAAC,CAAA,EAASd,GAAA,EACrBe,EAAM7B,GAAA,EACZ,GAAK6B,EAEL,IAAI,CACFD,EAAK,YACP,MAAQ,CAAiB,CACzBA,EAAK,QAAQC,CAAG,EAEhBJ,EAAW,QAAQE,CAAQ,EAE3B,GAAI,CACFA,EAAS,YACX,MAAQ,CAAiB,CAErBD,IAAe,GACjBC,EAAS,QAAQC,EAAM,EAAG,CAAC,EAC3BD,EAAS,QAAQC,EAAM,EAAG,CAAC,GAClBF,IAAe,GACxBC,EAAS,QAAQC,EAAM,EAAG,CAAC,EAC3BD,EAAS,QAAQC,EAAM,EAAG,CAAC,GAClBF,IAAe,EACxBC,EAAS,QAAQC,EAAM,EAAG,CAAC,EAE3BD,EAAS,QAAQC,EAAMF,EAAY,CAAC,EAGtCzH,EAAI,MAAM,uCAAuCyH,CAAU,EAAE,EAC/D,IAGA/G,EAAI,GAAG,kBAAmB,SAAY,CACpC,GAAI,CACF,MAAMoG,GAAA,EACN9G,EAAI,KAAK,wCAAwC,CACnD,OAAS,EAAG,CACVA,EAAI,KAAK,6BAA8B,CAAC,CAC1C,CACF,ICjXO,SAAS6H,GAAgBC,EAAeC,EAA2B,GAAqC,CAC7G,GAAI,CAACD,GAAQ,OAAOA,GAAS,SAAU,MAAO,GAC9C,MAAME,EAAMF,EACZ,GAAI,CAACE,EAAI,KAAM,MAAO,GACtB,UAAWC,KAASF,EAClB,GAAIC,EAAIC,CAAK,IAAM,QAAaD,EAAIC,CAAK,IAAM,KAC7C,OAAAjI,EAAI,KAAK,qCAAqCiI,CAAK,gBAAiBD,EAAI,IAAI,EACrE,GAGX,MAAO,EACT,CAKO,MAAME,GAA+B,CAC1C9E,EAAI,KAAMA,EAAI,MAAOA,EAAI,OACzBA,EAAI,UAAWA,EAAI,OAAQA,EAAI,SAC/BA,EAAI,OAAQA,EAAI,YAAaA,EAAI,aACjCA,EAAI,gBAAiBA,EAAI,cAAeA,EAAI,eAC5CA,EAAI,aAAcA,EAAI,MACtBA,EAAI,YAAaA,EAAI,aACrBA,EAAI,aAAcA,EAAI,aAAcA,EAAI,cACxCA,EAAI,aAAcA,EAAI,yBACtBA,EAAI,UAAWA,EAAI,YAAaA,EAAI,KACpCA,EAAI,gBAAiBA,EAAI,QAC3B,EAKM+E,OAAgB,IAMf,SAASC,GAAgBC,EAAcC,EAA+B,CACvEH,GAAU,IAAIE,CAAI,GACpBrI,EAAI,KAAK,uCAAuCqI,CAAI,EAAE,EAExDF,GAAU,IAAIE,EAAMC,CAAO,CAC7B,CAKO,SAASC,EAAiBC,EAAgD,CAC/E,SAAW,CAACH,EAAMC,CAAO,IAAK,OAAO,QAAQE,CAAQ,EACnDJ,GAAgBC,EAAMC,CAAO,CAEjC,CAeA,eAAsBG,GAAWX,EAAeY,EAAqC,CAEnF,GAAI,CAACb,GAAgBC,EAAM,EAAE,EAAG,OAEhC,MAAME,EAAMF,EACNa,EAAUX,EAAI,KAGdM,EAAUH,GAAU,IAAIQ,CAAO,EACrC,GAAIL,EACF,GAAI,CACF,MAAMA,EAAQN,EAAKU,CAAI,CACzB,OAASnI,EAAG,CACVP,EAAI,MAAM,kBAAkB2I,CAAO,IAAKpI,CAAC,CAC3C,CAIF,MAAMqI,EAAWlF,EAAgC,kBAAkB,EACnE,GAAI,CAACkF,EAAU,OAGf,MAAMC,EAAsBnF,EAA2B,2BAA2B,EAC9EmF,EAAoB,OAAS,GAAKX,GAAmB,SAASS,CAAO,GACvEE,EAAoB,QAAQC,GAAK,CAE/B,GAAIA,EAAE,MAAQA,IAAMJ,EAClB,GAAI,CAAEI,EAAE,KAAKhB,CAAI,CAAG,MAAQ,CAA+B,CAE/D,CAAC,EAICY,GAAQA,IAASE,GAAYA,EAAS,MACpCD,EAAQ,WAAW,UAAU,IAC/B3I,EAAI,MAAM,oDAAoD2I,CAAO,EAAE,EACvEC,EAAS,KAAKd,CAAI,EAGxB,CAQO,SAASiB,EAAeL,EAA+B,CAC5D,GAAI,CAACA,GAAM,KAAM,MAAO,GAExB,MAAMM,EADiBtF,EAAyC,wBAAwB,EAC5D,QAAUoF,EAAE,KAAOJ,EAAK,IAAI,EACxD,MAAO,CAAC,EAAEM,GAAQA,EAAK,KACzB,CAQO,SAASC,IAAqB,CACnCvI,EAAI,GAAG,eAAgB,CAACoH,EAAeY,IAAkB,CACvDD,GAAWX,EAAMY,CAAsB,EAAE,MAAMnI,GAC7CP,EAAI,MAAM,+BAAgCO,CAAC,EAE/C,CAAC,EAEDP,EAAI,KAAK,uCAAuC,CAClD,CCvIA,MAAMkJ,GAAgE,CACpE,cAAe,KACf,gBAAiB,KACjB,cAAe,KACf,aAAc,KACd,iBAAkB,KAClB,gBAAiB,KACjB,iBAAkB,KAClB,cAAe,KACf,gBAAiB,KACjB,iBAAkB,KAClB,qBAAsB,IACxB,EAKO,SAASC,EACdC,EACAhJ,EACAiJ,EACAC,EACM,CACNC,EAAkBH,CAAI,EACtBF,GAAQE,CAAI,EAAIE,GAAM,SAClB,YAAYlJ,EAAIiJ,CAAO,EACvB,WAAWjJ,EAAIiJ,CAAO,CAC5B,CAKO,SAASE,EAAkBH,EAAuB,CACvD,MAAM5G,EAAK0G,GAAQE,CAAI,EACnB5G,GAAM,OACR,aAAaA,CAAE,EACf,cAAcA,CAAE,EAChB0G,GAAQE,CAAI,EAAI,KAEpB,CAKO,SAASI,IAA8B,CAC5C,UAAWJ,KAAQ,OAAO,KAAKF,EAAO,EACpCK,EAAkBH,CAAiB,CAEvC,CAKO,SAASK,GAAgBL,EAAuD,CACrF,OAAOF,GAAQE,CAAI,GAAK,IAC1B,CC5DA,IAAIM,GAAiC,KACjCC,GAA6B,KAGjC,MAAMC,GAAmB,CAAC,YAAa,OAAQ,YAAY,EAGrDC,GAAmB1H,GAIlB,SAAS2H,GAAkBC,EAAsB,CACtDL,GAAkBK,EAClBL,GAAgB,UAAYM,EAC9B,CAEO,SAASC,GAAcF,EAAsB,CAClDJ,GAAcI,EACdJ,GAAY,UAAYO,EAC1B,CAWO,SAASC,EAAkBC,EAAwBC,EAAkC,CAC1F,GAAI,CAACD,GAAW,CAACA,EAAQ,QAAS,OAElC,MAAME,EAAMF,EAAQ,QAGpB,GAAIE,EAAI,WAAW,OAAO,GAAKA,IAAQ,cAAgBA,IAAQ,iBACxDF,EAAQ,YAAc,KAAK,gCAAgCE,CAAG,EAAE,EAErEF,EAAQ,UAAY7H,GAAkB6H,EAAQ,WAAa,CAAC,GAGtCE,IAAQ,cAAgBA,IAAQ,cAAgBA,IAAQ,aAC1D,CAACF,EAAQ,WAAW,CACtCpK,EAAI,MAAM,oBAAoBsK,CAAG,sBAAuBF,CAAO,EAC/D,MACF,CAGEE,EAAI,WAAW,OAAO,EACpBZ,GACFA,GAAgB,YAAYU,EAAsB,EAAE,EAEpDpK,EAAI,KAAK,wDAAwDsK,CAAG,EAAE,EAGpEX,GACFA,GAAY,YAAYS,EAAsB,EAAE,EAEhDpK,EAAI,KAAK,oDAAoDsK,CAAG,EAAE,CAGxE,CAOO,SAASC,GAAkBC,EAAkBC,EAAY,GAAe,CAC7E,MAAMC,EAAY,OAAOF,GAAY,EAAE,EAAE,QAAQ,iBAAkB,GAAG,EACtE,OAAQC,EAAY,WAAa,YAAcC,EAAY,IAAMb,EACnE,CAKO,SAASc,GAAoBH,EAAkBC,EAA0B,CACzED,GACLL,EAAkB,CAChB,QAAS,eACT,SAAAK,EACA,UAAAC,EACA,WAAYZ,EAAA,CACb,CACH,CAKA,eAAsBe,GAAiBJ,EAAkBC,EAA0C,CAEjG,GADI,CAACD,GACD,EAAE,UAAU,SAAW,UAAU,QAAQ,cAAe,OAAO,KACnE,GAAI,CACF,MAAMpJ,EAAO,MAAM,UAAU,QAAQ,eAC/ByJ,EAAWN,GAAkBC,EAAUC,CAAS,EAEtD,OAAO,MADY,MAAMrJ,EAAK,cAAcyJ,CAAQ,GAC5B,SAC1B,OAASC,EAAK,CACZ,OAAA9K,EAAI,MAAM,kCAAmC8K,CAAG,EACzC,IACT,CACF,CAIO,SAASC,IAAmC,CACjDnB,GAAiB,QAASpH,GAAO,CAC/B,GAAI,CAAE2H,EAAkB,CAAE,QAAS,aAAc,GAAA3H,CAAA,CAAI,CAAG,MAAQ,CAAa,CAC/E,CAAC,CACH,CAIA,SAASwH,GAA4B,EAAuC,CAC1E,MAAMlC,EAAO,EAAE,KACf,GAAI,GAACA,GAAQ,CAACA,EAAK,MAEnB,OAAQA,EAAK,MACX,IAAK,eACH9H,EAAI,MAAM,2BAA2B8H,EAAK,QAAQ,UAAUA,EAAK,SAAS,GAAG,EAC7E,MAEF,IAAK,kBACH9H,EAAI,MAAM,0BAA0B8H,EAAK,QAAQ,UAAUA,EAAK,SAAS,GAAG,EAC5EpH,EAAI,KAAK,kBAAmBoH,EAAK,SAAUA,EAAK,UAAWA,EAAK,WAAa,EAAK,EAClF,MAEF,IAAK,qBACHpH,EAAI,KAAK,qBAAsBoH,CAAI,EACnC,MAEF,IAAK,mBACH9H,EAAI,KAAK,0BAA0B8H,EAAK,QAAQ,UAAWA,EAA4C,KAAK,IAAKA,EAAK,KAAK,EAC3H,MAEF,IAAK,kBACH9H,EAAI,MAAM,yBAAyB8H,EAAK,QAAQ,IAAKA,EAAK,KAAK,EAC/DpH,EAAI,KAAK,kBAAmBoH,CAAI,EAChC,MAEF,IAAK,aACH9H,EAAI,MAAM,wBAAwB8H,EAAK,KAAK,KAAKA,EAAK,QAAQ,GAAG,EACjEpH,EAAI,KAAK,aAAcoH,EAAK,MAAOA,EAAK,QAAQ,EAChD,MAEF,IAAK,mBAAoB,CACvB,MAAM2C,EAAY,CAAC,CAAC3C,EAAK,UACzB9H,EAAI,KAAK,4BAA4B8H,EAAK,QAAQ,KAAK2C,EAAY,UAAY,SAAS,GAAG,EAEtFA,GACH/J,EAAI,KAAK,wBAAyBoH,CAAI,EAExC,KACF,CAEA,IAAK,sBACH9H,EAAI,MAAM,uBAAuB,EACjC,MAEF,IAAK,wBACHA,EAAI,MAAM,4BAA4B8H,EAAK,QAAQ,EAAE,EACrD,MAEF,QACE9H,EAAI,MAAM,kCAAkC8H,EAAK,IAAI,EAAE,EAE7D,CAEA,SAASoC,GAAwB,EAAuB,CACtD,MAAMpC,EAAO,EAAE,KACVA,IAEDA,EAAK,OAAS,OAChBpH,EAAI,KAAK,oBAAqBoH,EAAK,EAAE,EAC5BA,EAAK,OAAS,gBACvB9H,EAAI,KAAK,sBAAuB8H,EAAK,KAAK,EAE9C,CAOO,SAASkD,GAAgBC,EAA0BC,EAA0C,CAClG,GAAI,CAACD,EAAM,OAAO,KAClB,GAAI,CACF,GAAI,SAAUA,GAAQ,OAAOA,EAAK,MAAS,UAAYA,EAAK,KAAM,OAAOA,EACzE,MAAM7B,EAAQ8B,GAAgB,OAAOA,CAAY,EAAE,OAAU,OAAOA,CAAY,EAAE,OAAS,QAC3F,OAAO,IAAI,KAAK,CAACD,CAAI,EAAG7B,EAAM,CAAE,KAAM6B,EAAK,MAAQ,GAAI,CACzD,MAAQ,CACN,OAAOA,CACT,CACF,CAKAvK,EAAI,GAAG,uBAAwB,IAAIT,IAAoB,CACrD,MAAMmK,EAAUnK,EAAK,CAAC,EAClBmK,GAAWA,EAAQ,SACrBD,EAAkBC,CAAO,CAE7B,ICtMA,IAAIpB,EAA4B,KAGzB,SAASmC,IAA+B,CAAE,OAAOnC,CAAM,CAI9D,SAASoC,GAAmBC,EAAsB,CAChD,MAAO,GAAGlI,EAAgB,IAAIkI,CAAI,EACpC,CAEA,SAASC,GAAqBC,EAA8BC,EAAsC,CAChG,MAAMC,EAAY/H,EAA4B,mBAAmB,EAC3DgI,EAAO,OAAOH,CAAa,EACjC,GAAI,OAAO,UAAUG,CAAI,GAAKA,GAAQ,GAAKA,GAAQxI,GAAiB,CAClE,MAAMyI,EAAWF,EAAUC,CAAI,EAC/B,GAAI,CAACC,GAAYA,IAAaH,EAAQ,OAAOE,CAC/C,CACA,QAAS1H,EAAI,EAAGA,GAAKd,GAAiBc,IACpC,GAAI,CAACyH,EAAUzH,CAAC,EAAG,OAAOA,EAE5B,OAAO,IACT,CAEA,SAAS4H,GAAeJ,EAAgBH,EAAoB,CAC1D,GAAI,CAACG,EAAQ,OACb,MAAMK,EAAI,OAAOR,CAAI,EACrB,GAAI,CAAC,OAAO,UAAUQ,CAAC,GAAKA,EAAI,GAAKA,EAAI3I,GAAiB,OAC1D,MAAMuI,EAAY/H,EAA4B,mBAAmB,EACjE+H,EAAUI,CAAC,EAAIL,EACf1H,EAAS,oBAAqB2H,CAAS,EAC3B/H,EAA8B,0BAA0B,EAChE,IAAI8H,EAAQK,CAAC,CACnB,CAEA,SAASC,GAAgBN,EAAsB,CAC7C,GAAI,CAACA,EAAQ,OACb,MAAMO,EAAMrI,EAA8B,0BAA0B,EAC9D2H,EAAOU,EAAI,IAAIP,CAAM,EAC3B,GAAIH,EAAM,CACR,MAAMI,EAAY/H,EAA4B,mBAAmB,EAC7D+H,EAAUJ,CAAI,IAAMG,IAAQC,EAAUJ,CAAI,EAAI,KACpD,CACAU,EAAI,OAAOP,CAAM,CACnB,CAQA,eAAsBQ,GAAYC,EAA6B,KAAuB,CACpF,GAAI,OAAO,KAAS,IAClB,MAAAjM,EAAI,MAAM,uCAAuC,EAC3C,IAAI,MAAM,mBAAmB,EAIrC,GAAIgJ,EAAM,CACR,GAAI,CAAEA,EAAK,SAAW,MAAQ,CAAa,CAC3CA,EAAO,IACT,CAGA,MAAMkD,EAAoC,CACxC,MAAO,EACP,OAAQ,CACN,WAAY,GACZ,aAAc,eACd,aAAc,aACd,qBAAsB,EACxB,EAIIC,EAAoB,OAA8C,2BAEpEA,GAAoB,OAAOA,GAAqB,WAC9CA,EAAiB,OAAMD,EAAS,KAAOC,EAAiB,MACxDA,EAAiB,OAAMD,EAAS,KAAOC,EAAiB,MACxDA,EAAiB,OAAMD,EAAS,KAAOC,EAAiB,MACxD,OAAOA,EAAiB,QAAW,YAAWD,EAAS,OAASC,EAAiB,QACjFA,EAAiB,MAAKD,EAAS,IAAMC,EAAiB,MAG5DnD,EAAO,IAAI,KAAKiD,GAAe,OAAWC,CAAQ,EAClDE,GAAA,EAGA,MAAM5J,EAAK,MAAM,IAAI,QAAgB,CAAC6J,EAASC,IAAW,CACxD,MAAMC,EAAU/J,GAAe,CAAEwG,EAAM,IAAI,OAAQuD,CAAM,EAAGvD,EAAM,IAAI,QAASwD,CAAO,EAAGH,EAAQ7J,CAAE,CAAG,EAChGgK,EAAW1B,GAAiB,CAAE9B,EAAM,IAAI,OAAQuD,CAAM,EAAGvD,EAAM,IAAI,QAASwD,CAAO,EAAGF,EAAOxB,CAAG,CAAG,EACzG9B,EAAM,GAAG,OAAQuD,CAAM,EACvBvD,EAAM,GAAG,QAASwD,CAAO,CAC3B,CAAC,EAED,OAAA1I,EAAS,eAAgBtB,CAAE,EAC3BxC,EAAI,KAAK,yBAA0BwC,CAAE,EACrC9B,EAAI,KAAK,qBAAsB8B,CAAE,EAC1BA,CACT,CAIA,SAASiK,IAA8B,CACrC,OAAO,OAAO,KAAK,MAAM,IAAS,KAAK,SAAW,GAAM,CAAC,CAC3D,CAMA,eAAsBC,GAA+BC,EAAc,GAAqB,CACtF,QAAS3I,EAAI,EAAGA,EAAI2I,EAAa3I,IAAK,CACpC,MAAM4I,EAAOH,GAAA,EACb,GAAI,CACF,aAAMT,GAAYY,CAAI,EACfA,CACT,OAAS9B,EAAK,CACZ,GAAIA,GAAO,OAAOA,GAAQ,UAAaA,EAAgC,OAAS,WAC9E,SAEF,MAAMA,CACR,CACF,CACA,MAAM,IAAI,MAAM,0BAA0B,CAC5C,CAIA,SAASsB,IAAwB,CAC1BpD,IAELA,EAAK,GAAG,QAAU8B,GAAiB,CACjC9K,EAAI,MAAM,kBAAmB8K,CAAG,EAChC,MAAM+B,EAAUnJ,EAAiB,iBAAiB,EAC5CkF,EAAWlF,EAAgC,kBAAkB,EAEnE,GAAImJ,IAAY,QAAU,CAACjE,EAAU,CACnC,GAAIkC,GAAO,OAAOA,GAAQ,UAAaA,EAAgC,OAAS,WAC9E,OAEFpK,EAAI,KAAK,gBAAiBoK,CAAG,CAC/B,CACF,CAAC,EAED9B,EAAK,GAAG,eAAgB,IAAM,CAC5BhJ,EAAI,KAAK,6CAA6C,CACxD,CAAC,EAEDgJ,EAAK,GAAG,aAAeN,GAAyB,CAG9C,GADiBA,EAAK,UACR,OAAStF,EAAI,WAAY,CAErC1C,EAAI,KAAK,4BAA6BgI,CAAI,EAC1C,MACF,CAGA,GADgBhF,EAAiB,iBAAiB,IAClC,OAAQ,CACtB,GAAI,CAAEgF,EAAK,OAAS,MAAQ,CAAa,CACzC,MACF,CACAoE,GAA6BpE,CAAI,CACnC,CAAC,EACH,CAIA,SAASoE,GAA6BpE,EAA4B,CAChE,MAAM8C,EAAS9C,EAAK,KACdqE,EAAiBrJ,EAAyC,wBAAwB,EAClFsJ,EAAyBtJ,EAAsC,gCAAgC,EAG/FuJ,EAAqBD,EAAuB,IAAIxB,CAAM,EAC5D,GAAIyB,GAAsBA,IAAuBvE,EAAM,CACrDsE,EAAuB,IAAIxB,EAAQ9C,CAAI,EACvC,GAAI,CACEuE,EAAmB,MACrBA,EAAmB,KAAK,CAAE,KAAM7J,EAAI,sBAAuB,CAE/D,MAAQ,CAAa,CACrB,GAAI,CAAE6J,EAAmB,OAAS,MAAQ,CAAa,CACzD,CAGA,MAAMC,EAAWH,EAAe,OAAOjE,GAAKA,EAAE,KAAO0C,CAAM,EAI3D,GAHA1H,EAAS,yBAA0BoJ,CAAQ,EAGvCA,EAAS,QAAUhK,GAAiB,CACtC,MAAMiK,EAAmB,IAAM,CAC7B,GAAI,CACFzE,EAAK,KAAK,CACR,KAAMtF,EAAI,aACV,QAAS,uCACV,CACH,MAAQ,CAAa,CACrB,WAAW,IAAM,CAAE,GAAI,CAAEsF,EAAK,OAAS,MAAQ,CAAa,CAAE,EAAG,GAAG,CACtE,EACIA,EAAK,KAAMyE,EAAA,EACVzE,EAAK,GAAG,OAAQyE,CAAgB,EACrC,MACF,CAIA,MAAM5B,EADmB7H,EAA8B,0BAA0B,EAC1C,IAAI8H,CAAM,GAAK,KAChDH,EAAOC,GAAqBC,EAAeC,CAAM,EACvD,GAAI,CAACH,EAAM,CACT,GAAI,CACF3C,EAAK,KAAK,CACR,KAAMtF,EAAI,aACV,QAAS,uCACV,CACH,MAAQ,CAAa,CACrB,GAAI,CAAEsF,EAAK,OAAS,MAAQ,CAAa,CACzC,MACF,CACAkD,GAAeJ,EAAQH,CAAI,EAC3B,MAAM+B,EAAahC,GAAmBC,CAAI,EAGpCgC,EAAa3J,EAAiC,oBAAoB,EACxE2J,EAAW7B,CAAM,EAAI4B,EAGrBJ,EAAuB,IAAIxB,EAAQ9C,CAAI,EAEvC,MAAM4E,EAAU,CACd,GAAI9B,EACJ,KAAAH,EACA,MAAO+B,EACP,KAAM,QACN,OAAQ,aACR,KAAA1E,EACA,KAAM,GACN,aAAc,GACd,UAAW2C,EACX,cAAe,KAAK,MACpB,qBAAsB,IACtB,cAAe,MAGXkC,EAAe7J,EAAyC,wBAAwB,EACtF6J,EAAa,KAAKD,CAA6C,EAC/DxJ,EAAS,yBAA0ByJ,CAAY,EAE/C7E,EAAK,GAAG,OAAQ,IAAM,CACpB4E,EAAQ,OAAS,YACjBA,EAAQ,cAAgB,KAAK,MAG7B,GAAI,CACF5E,EAAK,KAAK,CACR,KAAMtF,EAAI,QACV,YAAa,GACb,MAAOgK,CAAA,CACR,CACH,MAAQ,CAAa,CAErB1M,EAAI,KAAK,gBAAiB,GAAG0M,CAAU,SAAS,EAGhD1M,EAAI,KAAK,yBAA0BgI,CAAI,EAGvC8E,GAAA,EACA9M,EAAI,KAAK,2BAA2B,EACpCV,EAAI,KAAK,UAAUoN,CAAU,qBAAqB5B,CAAM,GAAG,CAC7D,CAAC,EAED9C,EAAK,GAAG,OAASZ,GAAkB,CACjC,GAAI,CAAEpH,EAAI,KAAK,eAAgBoH,EAAMY,CAAI,CAAG,OACrCnI,EAAG,CAAEP,EAAI,MAAM,6BAA8BO,CAAC,CAAG,CAC1D,CAAC,EAEDmI,EAAK,GAAG,QAAS,IAAM,CAIrB,GAHA1I,EAAI,KAAK,6BAA6BwL,CAAM,EAAE,EAG1CwB,EAAuB,IAAIxB,CAAM,IAAM9C,EAAM,OAEjDsE,EAAuB,OAAOxB,CAAM,EACpCM,GAAgBN,CAAM,EAEtB,MAAMiC,EAAQ/J,EAAyC,wBAAwB,EAC/EI,EAAS,yBAA0B2J,EAAM,UAAY3E,EAAE,KAAO0C,CAAM,CAAC,EAErE9K,EAAI,KAAK,4BAA6B8K,CAAM,EAC5CgC,GAAA,EAEuB9J,EAAkB,sBAAsB,GAE7DhD,EAAI,KAAK,gBAAiB,GAAG0M,CAAU,WAAW,EAEpDpN,EAAI,KAAK,UAAUoN,CAAU,eAAe,CAC9C,CAAC,EAED1E,EAAK,GAAG,QAAUoC,GAAiB,CAGjC,GAFA9K,EAAI,MAAM,2BAA4B8K,CAAG,EAErCkC,EAAuB,IAAIxB,CAAM,IAAM9C,EAAM,CAC/C,GAAI,CAAEA,EAAK,OAAS,MAAQ,CAAa,CACzC,MACF,CAEAsE,EAAuB,OAAOxB,CAAM,EACpCM,GAAgBN,CAAM,EAEtB,MAAMiC,EAAQ/J,EAAyC,wBAAwB,EAC/EI,EAAS,yBAA0B2J,EAAM,UAAY3E,EAAE,KAAO0C,CAAM,CAAC,EAErE9K,EAAI,KAAK,4BAA6B8K,CAAM,EAC5CgC,GAAA,EAEuB9J,EAAkB,sBAAsB,GAE7DhD,EAAI,KAAK,gBAAiB,GAAG0M,CAAU,QAAQ,EAEjD,GAAI,CAAE1E,EAAK,OAAS,MAAQ,CAAa,CAC3C,CAAC,CACH,CAOO,SAASgF,GAAYC,EAAgBC,EAAe,EAAS,CAClE,MAAMhF,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAYA,EAAS,KAAM,CAC7B5I,EAAI,KAAK,mCAAmC,EAC5C,MACF,CAEA,GAAI,CAAC2N,EAAQ,CACXjN,EAAI,KAAK,gBAAiB,IAAI,MAAM,YAAY,CAAC,EACjD,MACF,CAKA,GAHAoD,EAAS,uBAAwB6J,CAAM,EAGnC,CAAC3E,EAAM,CACT,GAAI4E,EAAe,EAAG,CACpBlN,EAAI,KAAK,gBAAiB,IAAI,MAAM,qBAAqB,CAAC,EAC1D,MACF,CACAsL,GAAY,IAAI,EACb,KAAK,IAAM0B,GAAYC,EAAQC,EAAe,CAAC,CAAC,EAChD,MAAOrN,GAAM,CACZP,EAAI,MAAM,6BAA8BO,CAAC,EACzCG,EAAI,KAAK,gBAAiB,IAAI,MAAM,qBAAqB,CAAC,CAC5D,CAAC,EACH,MACF,CAEA,GAAI,CAACsI,EAAK,KAAM,CACV4E,EAAe,GACjB,WAAW,IAAMF,GAAYC,EAAQC,EAAe,CAAC,EAAG,GAAG,EAE3DlN,EAAI,KAAK,gBAAiB,IAAI,MAAM,gBAAgB,CAAC,EAEvD,MACF,CAEAoD,EAAS,uBAAwB,EAAI,EAErC,IAAI4E,EACJ,GAAI,CACF,MAAMmF,EAAcnK,EAAiB,mBAAmB,EACxDgF,EAAOM,EAAK,QAAQ2E,EAAQ,CAC1B,SAAU,GACV,SAAU,CAAE,MAAO,QAAQE,CAAW,GAAG,CAC1C,CACH,OAAStN,EAAG,CACVP,EAAI,MAAM,6BAA8BO,CAAC,EACzCuD,EAAS,uBAAwB,EAAK,EACtCpD,EAAI,KAAK,gBAAiB,IAAI,MAAM,gBAAgB,CAAC,EACrD,MACF,CAGA,MAAMoN,EAAY,WAAW,IAAM,CACjC,GAAI,GAACpF,GAAQA,EAAK,MAAQhF,EAAgC,kBAAkB,GAC5E,IAAI,CAAEgF,EAAK,OAAS,MAAQ,CAAa,CACzC5E,EAAS,uBAAwB,EAAK,EACtCpD,EAAI,KAAK,gBAAiB,IAAI,MAAM,kBAAkB,CAAC,EACzD,EAAG,GAAK,EAERgI,EAAK,GAAG,OAAQ,IAAM,CACpB,aAAaoF,CAAS,EACtB9N,EAAI,KAAK,4BAA6B2N,CAAM,EAE5C7J,EAAS,mBAAoB4E,CAAI,EACjC5E,EAAS,uBAAwB,EAAK,EACtCA,EAAS,iBAAkB6J,CAAM,EAGhCjF,EAA4C,cAAgB,GAE7DA,EAAK,GAAG,OAASZ,GAAkB,CACjCpH,EAAI,KAAK,eAAgBoH,EAAMY,CAAI,CACrC,CAAC,EAEDA,EAAK,GAAG,QAAS,IAAM,CAKrB,GAJA1I,EAAI,KAAK,+BAA+B,EACxC8D,EAAS,mBAAoB,IAAI,EACjCA,EAAS,uBAAwB,EAAK,EAEjC4E,EAA4C,cAAe,CAC9D5E,EAAS,kCAAmC,EAAK,EACjD,MACF,CACC4E,EAA4C,cAAgB,GAEvChF,EAAkB,iCAAiC,GAEvEhD,EAAI,KAAK,gBAAiB,IAAI,MAAM,mBAAmB,CAAC,EAE1DoD,EAAS,kCAAmC,EAAK,CACnD,CAAC,EAED4E,EAAK,GAAG,QAAUoC,GAAiB,CACjC9K,EAAI,MAAM,+BAAgC8K,CAAG,EAC7ChH,EAAS,mBAAoB,IAAI,EACjCA,EAAS,uBAAwB,EAAK,EAEjC,CAAA4E,EAA4C,gBAChDA,EAA4C,cAAgB,GAE7DhI,EAAI,KAAK,gBAAiB,IAAI,MAAM,uBAAuB,CAAC,EAC9D,CAAC,EAGDA,EAAI,KAAK,sBAAuB,CAAE,QAAS,cAAe,GAAI,YAAa,SAAU,IAAM,EAC3FA,EAAI,KAAK,sBAAuB,CAAE,QAAS,cAAe,GAAI,OAAQ,SAAU,IAAM,EAEtFA,EAAI,KAAK,yBAA0BgI,CAAI,EACvChI,EAAI,KAAK,0BAA0B,CACrC,CAAC,CACH,CAOO,SAASqN,IAAqB,CACnC/N,EAAI,MAAM,6CAA6C,EAEvD8D,EAAS,kCAAmC,EAAI,EAGhDiH,GAAA,EACAvB,GAAA,EAGA9I,EAAI,KAAK,uBAAuB,EAGhC,MAAMkI,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,EACF,GAAI,CAAEA,EAAS,OAAS,MAAQ,CAAa,CAG/C,GAAII,EAAM,CACR,GAAI,CAAEA,EAAK,SAAW,MAAQ,CAAa,CAC3CA,EAAO,IACT,CAEuBtF,EAAyC,wBAAwB,EACzE,QAAQoF,GAAK,CAC1B,GAAI,CACF,MAAMJ,EAAOI,EAAE,KACXJ,KAAW,OACjB,MAAQ,CAAa,CACvB,CAAC,EAG2BhF,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAC/B,GAAI,CAAEA,EAAE,OAAS,MAAQ,CAAa,CACxC,CAAC,EAGD,MAAMkE,EAAyBtJ,EAAsC,gCAAgC,EAC/FsK,EAAmBtK,EAA8B,0BAA0B,EACjFsJ,EAAuB,QACvBgB,EAAiB,QACjB,MAAMvC,EAAY/H,EAA4B,mBAAmB,EACjE,QAASM,EAAI,EAAGA,GAAKd,GAAiBc,IAAKyH,EAAUzH,CAAC,EAAI,KAG1D,MAAMiK,EAAoBvK,EAAgC,4BAA4B,EAChFwK,EAAuBxK,EAAgC,+BAA+B,EACtFyK,EAAsBzK,EAAgC,8BAA8B,EACtFuK,KAAqC,QACrCC,KAA2C,QAC3CC,KAAyC,QAG7CzN,EAAI,KAAK,iBAAiB,EAG1ByD,GAAc,CAEZ,eAAgB,KAChB,wBAAyB,OACzB,mBAAoB,KACpB,yBAA0B,GAC1B,qBAAsB,GACtB,uBAAwB,GACxB,8BAA+B,KAC/B,qBAAsB,GACtB,kCAAmC,GAEnC,yBAA0B,KAC1B,4BAA6B,GAE7B,iBAAkB,GAClB,6BAA8B,GAC9B,0BAA2B,GAE3B,gBAAiB,KACjB,iBAAkB,OAClB,yBAA0B,EAC1B,0BAA2B,EAE3B,wBAAyB,KAEzB,uBAAwB,KACxB,eAAgB,KAEhB,mBAAoB,EACpB,sBAAuB,EAEvB,kBAAmB,EACnB,4BAA6B,KAE7B,SAAYxB,EAAU,KACvB,EAGDjC,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,uBAAwBiC,EAAU,IAAI,EAE/C3C,EAAI,MAAM,iDAAiD,CAC7D,CAOO,SAASoO,EAAUpG,EAAcqG,EAAa,GAAa,CACzC3K,EAAyC,wBAAwB,EACzE,QAAQoF,GAAK,CAC1B,GAAI,CACF,GAAIA,EAAE,SAAW,aAAeA,EAAE,KAAM,CACtC,MAAMJ,EAAOI,EAAE,KACXJ,EAAK,OACH,CAAC2F,GAAcvF,EAAE,eAAiB,KACpCJ,EAAK,KAAKV,CAAG,CAGnB,CACF,OAASzH,EAAG,CACVP,EAAI,KAAK,oCAAoC8I,EAAE,OAASA,EAAE,EAAE,IAAKvI,CAAC,CACpE,CACF,CAAC,CACH,CAKO,SAAS+N,GAAgBC,EAAuBvG,EAAcqG,EAAa,GAAa,CACtE3K,EAAyC,wBAAwB,EACzE,QAAQoF,GAAK,CAC1B,GAAI,CACF,GAAIA,EAAE,SAAW,aAAeA,EAAE,KAAM,CACtC,MAAMJ,EAAOI,EAAE,KACf,GAAIJ,EAAK,KAAM,CACb,GAAI6F,GAAiBzF,EAAE,KAAOyF,EAAe,QACzC,CAACF,GAAcvF,EAAE,eAAiB,KACpCJ,EAAK,KAAKV,CAAG,CAEjB,CACF,CACF,OAASzH,EAAG,CACVP,EAAI,KAAK,0CAA0C8I,EAAE,OAASA,EAAE,EAAE,IAAKvI,CAAC,CAC1E,CACF,CAAC,CACH,CAKO,SAASiN,IAA4B,CAC1C,MAAMgB,EAAO9K,EAAwB,cAAc,EAC7CqJ,EAAiBrJ,EAAyC,wBAAwB,EAElF+K,EAAO,CACX,CAAE,GAAID,EAAM,MAAO,OAAQ,OAAQ,YAAa,OAAQ,IACxD,GAAGzB,EACA,KAAK,CAAC2B,EAAGC,IAAOD,EAAE,UAAwBC,EAAE,SAAoB,EAChE,IAAI7F,IAAM,CACT,GAAIA,EAAE,GACN,MAAOA,EAAE,MACT,OAAQA,EAAE,OACV,OAAQ,GACR,KAAMA,EAAE,MACR,GAGAd,EAAM,CAAE,KAAM5E,EAAI,mBAAoB,KAAAqL,CAAA,EAC5CL,EAAUpG,CAAG,EACbtH,EAAI,KAAK,sBAAuB+N,CAAI,CACtC,CAkCA/N,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CACnD,MAAM+H,EAAM/H,EAAK,CAAC,EACd+H,KAAeA,CAAG,CACxB,IAEAtH,EAAI,GAAG,4BAA6B,IAAIT,IAAoB,CAC1D,MAAMsO,EAAgBtO,EAAK,CAAC,EACtB+H,EAAM/H,EAAK,CAAC,EACd+H,GAAKsG,GAAgBC,EAAevG,CAAG,CAC7C,IAGAtH,EAAI,GAAG,2BAA4B,IAAIT,IAAoB,CACzD,MAAMuL,EAASvL,EAAK,CAAC,EAKrB,GAJI,CAACuL,GAGY9H,EAAgC,kBAAkB,EACrD,OAGd,MAAMoF,EADiBpF,EAAyC,wBAAwB,EAC/D,KAAKkL,GAAKA,EAAE,KAAOpD,CAAM,EAClD,GAAI1C,EAAG,CACLA,EAAE,KAAO,CAACA,EAAE,KACZ,MAAMJ,EAAOI,EAAE,KACXJ,GAAQA,EAAK,KACfA,EAAK,KAAK,CAAE,KAAMI,EAAE,KAAO1F,EAAI,eAAiBA,EAAI,gBAAiB,EAErEpD,EAAI,KAAK,2BAA2BwL,CAAM,wBAAwB,EAEpEgC,GAAA,EACA9M,EAAI,KAAK,gBAAiB,GAAGoI,EAAE,KAAK,OAAOA,EAAE,KAAO,MAAQ,KAAK,EAAE,CACrE,CACF,IAGC,OAA8C,eAAkB0C,GAAmB,CAClF9K,EAAI,KAAK,0BAA2B8K,CAAM,CAC5C,EAEA9K,EAAI,GAAG,uBAAwB,IAAIT,IAAoB,CACrD,MAAMwO,EAAOxO,EAAK,CAAC,EACf,MAAM,QAAQwO,CAAI,IACpB3K,EAAS,8BAA+B2K,CAAI,EAC5C/N,EAAI,KAAK,6BAA8B+N,CAAI,EAE/C,IAIA,SAASI,GAAc/G,EAAqC,CACtDA,EAAK,OACPhE,EAAS,wBAAyB,OAAOgE,EAAK,KAAK,CAAC,EAEtDpH,EAAI,KAAK,2BAA2B,CACtC,CAEA,SAASoO,GAAkBhH,EAAqC,CAC9D,MAAME,EAAMF,EAAK,QAAU,OAAOA,EAAK,OAAO,EAAI,aAElDhE,EAAS,kCAAmC,EAAI,EAEhD,MAAM8E,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,EAAU,CACZ,GAAI,CAAEA,EAAS,OAAS,MAAQ,CAAa,CAC7C9E,EAAS,mBAAoB,IAAI,CACnC,CACAA,EAAS,uBAAwB,EAAK,EACtCpD,EAAI,KAAK,2BAA2B,EACpCA,EAAI,KAAK,uBAAwBsH,CAAG,CACtC,CAEA,SAAS+G,GAA0BjH,EAAqC,CACtE,MAAM2G,EAAO,MAAM,QAAQ3G,EAAK,IAAI,EAAIA,EAAK,KAAyC,GACtFhE,EAAS,8BAA+B2K,CAAI,EAE5C,MAAMD,EAAO9K,EAAwB,cAAc,EAGnD,GAFiBA,EAAgC,kBAAkB,GAEnD8K,EAAM,CAEpB,GAAI,CADsBC,EAAK,QAAU3F,GAAKA,EAAE,KAAO0F,CAAI,EACnC,CACtBxO,EAAI,KAAK,2DAA2D,EACpE8D,EAAS,kCAAmC,EAAI,EAChDpD,EAAI,KAAK,6BAA6B,EACtC,MACF,CACA,MAAMsO,EAAKP,EAAK,QAAU3F,GAAKA,EAAE,KAAO0F,CAAI,EACxCQ,GAAMA,EAAG,OACXlL,EAAS,wBAAyB,OAAOkL,EAAG,KAAK,CAAC,CAEtD,CAEAtO,EAAI,KAAK,6BAA8B+N,CAAI,CAC7C,CAEA,SAASQ,IAAkC,CACzCjP,EAAI,KAAK,gEAAgE,CAE3E,CAEA,SAASkP,GAAepH,EAAqC,CACvDA,EAAK,SACPpH,EAAI,KAAK,gBAAiB,OAAOoH,EAAK,OAAO,CAAC,CAElD,CAEA,SAASqH,IAA4B,CACnCrL,EAAS,qBAAsB,EAAI,EACnCpD,EAAI,KAAK,gBAAiB,uBAAuB,EACjDA,EAAI,KAAK,oBAAqB,EAAI,EAClCA,EAAI,KAAK,2BAA2B,CACtC,CAEA,SAAS0O,IAA6B,CACpCtL,EAAS,qBAAsB,EAAK,EACpCpD,EAAI,KAAK,gBAAiB,uBAAuB,EACjDA,EAAI,KAAK,2BAA2B,CACtC,CAEA,SAAS2O,IAA2B,CAClCvL,EAAS,uBAAwB,EAAI,EACrCpD,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,2BAA2B,EACpCV,EAAI,KAAK,wBAAwB,CACnC,CAIO,SAASsP,IAAyB,CACvC/G,EAAiB,CACf,CAACnF,EAAI,OAAO,EAAGyL,GACf,CAACzL,EAAI,YAAY,EAAG0L,GACpB,CAAC1L,EAAI,aAAa,EAAGiM,GACrB,CAACjM,EAAI,kBAAkB,EAAG2L,GAC1B,CAAC3L,EAAI,qBAAqB,EAAG6L,GAC7B,CAAC7L,EAAI,SAAS,EAAG8L,GACjB,CAAC9L,EAAI,cAAc,EAAG+L,GACtB,CAAC/L,EAAI,eAAe,EAAGgM,EAAA,CACxB,EAEDpP,EAAI,KAAK,qCAAqC,CAChD,CC/wBO,SAASuP,IAAsB,CACpC,GAAI,CAAC5J,KAAiB,OAEtB,MAAM6J,EAAY9L,EAAiB,iBAAiB,EAC9C+L,EAAc/L,EAAiB,mBAAmB,EAClDgM,EAAiBhM,EAAiB,sBAAsB,EACxDiM,EAAejM,EAAiB,oBAAoB,EACpDkM,EAAgBlM,EAAiB,qBAAqB,EACtDmM,EAAcnM,EAAiB,mBAAmB,EAClDoM,EAAcpM,EAAiB,mBAAmB,EAClDqM,EAAWrM,EAAmB,gBAAgB,EAC9CsM,EAAiBtM,EAAiB,sBAAsB,EACxDmK,EAAcnK,EAAiB,mBAAmB,EAClDuM,EAAiBvM,EAAkB,sBAAsB,EACzDwM,EAAuBxM,EAAiB,4BAA4B,EACpEyM,EAAUzM,EAAiB,eAAe,EAG1C0M,EAAYhK,GAAA,EACdgK,GAAWA,EAAU,KAAK,OAAOZ,EAAW,EAAG,EAGnD,MAAMa,EAAMpK,GAAA,EACZ,GAAIoK,EAAK,CACP,IAAIC,EAAgB,GAChBD,EAAI,QAAUZ,IAChBY,EAAI,MAAQZ,EACZa,EAAgB,IAEdD,EAAI,WAAaX,IACnBW,EAAI,SAAWX,EACfY,EAAgB,IAEdA,GACFD,EAAI,WAAW,MAAM9P,IAAKP,EAAI,KAAK,8BAA+BO,EAAC,CAAC,CAExE,CAGA,MAAMgQ,EAAMrK,GAAA,EACZ,GAAIqK,EAAK,CACP,MAAMC,EAAQ,GAAK,KAAK,IAAI,GAAIb,EAAe,GAAG,EAClDY,EAAI,UAAU,OAAOC,EAAO,EAAG,CACjC,CACA,MAAMC,EAAMtK,GAAA,EACZ,GAAIsK,EAAK,CACP,MAAMC,EAAQ,IAAQ,KAAK,IAAI,IAAMd,EAAgB,GAAG,EACxDa,EAAI,UAAU,OAAOC,EAAO,EAAG,CACjC,CAGA,MAAMC,EAAQtK,GAAA,EACVsK,GAASZ,GACXY,EAAM,QAAQ,CAACC,EAAM5M,KAAM,CACrB4M,EAAK,KAAK,QAAUb,EAAS/L,EAAC,GAChC4M,EAAK,KAAK,OAAOb,EAAS/L,EAAC,EAAG,EAAG,CAErC,CAAC,EAIH,IAAI6M,EAAe,EACnB,MAAMC,EAAM9K,GAAA,EACR8K,IACFA,EAAI,IAAI,OAAO,EAAG,EAAG,EACrBA,EAAI,MAAM,OAAOjB,EAAc,GAAK,EAAG,EACnCA,EAAc,IAChBgB,EAAe,GAAM,GAAMhB,IAK/B,MAAMjI,EAAM7B,GAAA,EACR6B,GAAKA,EAAI,KAAK,OAAOoI,EAAiBa,EAAc,EAAG,EAG3D,MAAME,EAAelD,IAAgB,GAAMoC,GAAkBC,IAAyB,EAChFc,EAAOxK,GAAA,EACTwK,GACFA,EAAK,UAAU,OAAOD,EAAeZ,EAAU,IAAO,EAAG,EAE3D,MAAMc,EAAMxK,GAAA,EACRwK,GAAKA,EAAI,KAAK,OAAOnB,EAAa,EAAG,CAC3C,CAIO,SAASoB,EAAeC,EAAeC,EAAaC,EAAY,GAAa,CAClF,MAAMC,EAAI,OAAOF,CAAG,EACpB,GAAK,OAAO,SAASE,CAAC,EAEtB,QAAQH,EAAA,CACN,IAAK,MACHrN,EAAS,kBAAmBwN,EAAI,GAAG,EACnC,MACF,IAAK,QACHxN,EAAS,oBAAqBwN,CAAC,EAC/B,MACF,IAAK,WACHxN,EAAS,uBAAwBwN,CAAC,EAClC,MACF,IAAK,SACHxN,EAAS,qBAAsBwN,CAAC,EAChC,MACF,IAAK,UACHxN,EAAS,sBAAuBwN,CAAC,EACjC,MAGCD,GAAW9B,GAAA,EAClB,CAEO,SAASgC,IAAoB,CAClCL,EAAe,MAAO,EAAG,EAAI,EAC7BA,EAAe,QAAS,EAAK,EAAI,EACjCA,EAAe,WAAY,GAAK,EAAI,EACpCA,EAAe,SAAU,EAAG,EAAI,EAChCA,EAAe,UAAW,EAAG,EAAI,EACjC3B,GAAA,CACF,CAIO,SAASiC,GAAMC,EAAaL,EAAmB,CACpD,MAAMM,EAAU,OAAOD,CAAG,EACpBE,EAAU,OAAOP,CAAG,EAEpBrB,EAAWrM,EAAmB,gBAAgB,EAChDqM,IACFA,EAAS2B,CAAO,EAAIC,EACpB7N,EAAS,iBAAkB,CAAC,GAAGiM,CAAQ,CAAC,GAG1C,MAAMY,EAAQtK,GAAA,EACVsK,IAAQe,CAAO,GACjBf,EAAMe,CAAO,EAAE,KAAK,OAAOC,EAAS,EAAG,EAIzC,MAAMC,EAAQ,SAAS,eAAe,UAAUF,CAAO,EAAE,EACrDE,MAAa,UAAYD,EAAU,EAAI,IAAIA,CAAO,GAAK,OAAOA,CAAO,GACzE,MAAME,EAAQ,SAAS,iBAAiB,UAAU,EAClD,GAAIA,EAAMH,CAAO,EAAG,CAClB,MAAMI,EAASD,EAAMH,CAAO,EAAE,cAAc,YAAY,EACpDI,GAAU,WAAWA,EAAO,KAAK,IAAMH,IAASG,EAAO,MAAQ,OAAOH,CAAO,EACnF,CACF,CAEO,SAASI,IAAgB,CAC9B,MAAMpB,EAAQtK,GAAA,EACR2L,EAAQrB,EAAQA,EAAM,OAAS,EACrC7M,EAAS,iBAAkB,MAAMkO,CAAK,EAAE,KAAK,CAAC,CAAC,EAC/ClO,EAAS,uBAAwB,CAAG,EACpC6M,GAAO,QAAQC,GAAQA,EAAK,KAAK,OAAO,EAAG,EAAG,CAAC,EAC/CrB,GAAA,CACF,CAIO,SAAS0C,GAAUC,EAAqB,CAC7C,MAAMC,EAAK,OAAOD,CAAK,EACjBE,EAAS,KAAK,IAAI,GAAID,EAAK,EAAE,EACnCrO,EAAS,uBAAwBsO,CAAM,EACvC7C,GAAA,CACF,CAIO,SAAS8C,GAAejB,EAAmB,CAChDtN,EAAS,oBAAqBsN,EAAM,GAAG,EACvC7B,GAAA,CACF,CAEO,SAAS+C,IAAyB,CACvCD,GAAe,GAAG,CACpB,CAIO,SAASE,GAAenB,EAAmB,CAChDtN,EAAS,oBAAqBsN,EAAM,GAAG,EACvC7B,GAAA,CACF,CAEO,SAASiD,IAAyB,CACvCD,GAAe,CAAC,CAClB,CAIO,SAASE,GAAcrB,EAAmB,CAC/C,MAAMsB,EAAO,OAAOtB,CAAG,EACvBtN,EAAS,gBAAiB4O,CAAI,EAE9B,MAAMC,EAAMpM,GAAA,EACRoM,GAAKA,EAAI,UAAU,OAAOD,EAAM,EAAG,EAEvC,MAAM7E,EAAcnK,EAAiB,mBAAmB,EAClDuM,EAAiBvM,EAAkB,sBAAsB,EACzDwM,EAAuBxM,EAAiB,4BAA4B,EACpEkP,EAAY/E,IAAgB,GAAK,CAACoC,EAClC4C,EAAQ5C,GAAkBC,IAAyB,EAEnDc,EAAOxK,GAAA,EACTwK,GACFA,EAAK,UAAU,OAAQ4B,GAAaC,EAASH,EAAO,IAAO,EAAG,EAGhE,MAAMI,EAAKxM,GAAA,EACPwM,IAAOF,GAAaC,IACtBC,EAAG,UAAU,OAAOJ,EAAM,EAAG,CAEjC,CAQA,SAASK,GAA2BpK,EAAiB5E,EAAqB,CACxE,MAAM6E,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAKgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAauF,EAAS,MAAA5E,EAAO,EAL1EqK,EAAU,CAAE,KAAMzF,EAAS,MAAA5E,CAAA,CAAO,CAQtC,CAEA,SAASiP,GAA6BC,EAAclP,EAAqB,CACvE,MAAM6E,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAGgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAa,KAAM,KAAA6P,EAAM,MAAAlP,EAAO,EAJ7EqK,EAAU,CAAE,KAAMhL,EAAI,UAAW,KAAA6P,EAAM,MAAAlP,EAAO,CAOlD,CAKArD,EAAI,GAAG,uBAAwB,IAAIT,IAAoB,CACrD,MAAMoI,EAAOpI,EAAK,CAAC,EACbkR,EAAQlR,EAAK,CAAC,EACd8D,EAAQ,OAAO9D,EAAK,CAAC,CAAC,EACtBiT,EAAY,CAAC,CAACjT,EAAK,CAAC,EAE1B,GAAK,OAAO,SAAS8D,CAAK,EAE1B,OAAQsE,EAAA,CACN,IAAK,SAGH,GAFA6I,EAAeC,EAAOpN,CAAK,EAEvB,CAACmP,EAAW,CAKd,MAAMvK,EAJyC,CAC7C,IAAKvF,EAAI,OAAQ,MAAOA,EAAI,aAAc,SAAUA,EAAI,gBACxD,OAAQA,EAAI,cAAe,QAASA,EAAI,gBAEX+N,CAAK,EAChCxI,GAASoK,GAA2BpK,EAAS5E,CAAK,CACxD,CACA,MACF,IAAK,SACCoN,IAAU,QACZkB,GAAetO,CAAK,EACfmP,GAAWH,GAA2B3P,EAAI,aAAcW,CAAK,GAEpE,MACF,IAAK,QACCoN,IAAU,QACZoB,GAAexO,CAAK,EACfmP,GAAWH,GAA2B3P,EAAI,MAAOW,CAAK,GAE7D,MACF,IAAK,SACCoN,IAAU,SAASsB,GAAc1O,CAAK,EAC1C,MACF,QACE/D,EAAI,KAAK,iCAAkCqI,CAAI,EAErD,IAGA3H,EAAI,GAAG,oBAAqB,IAAIT,IAAoB,CAClD,MAAMmR,EAAM,OAAOnR,EAAK,CAAC,CAAC,EACpBiT,EAAY,CAAC,CAACjT,EAAK,CAAC,EACrB,OAAO,SAASmR,CAAG,IACxBa,GAAUb,CAAG,EACR8B,GAAWH,GAA2B3P,EAAI,OAAQgO,CAAG,EAC5D,IAGA1Q,EAAI,GAAG,gBAAiB,IAAIT,IAAoB,CAC9C,MAAMgT,EAAO,OAAOhT,EAAK,CAAC,CAAC,EACrBmR,EAAM,OAAOnR,EAAK,CAAC,CAAC,EACpBiT,EAAY,CAAC,CAACjT,EAAK,CAAC,EACtB,CAAC,OAAO,SAASgT,CAAI,GAAK,CAAC,OAAO,SAAS7B,CAAG,IAClDI,GAAMyB,EAAM7B,CAAG,EACV8B,GACHF,GAA6BC,EAAM7B,CAAG,EAE1C,IAGA1Q,EAAI,GAAG,sBAAuB,IAAM,CAClC,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EASgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,GATlDmO,GAAA,EACAnD,EAAU,CAAE,KAAMhL,EAAI,OAAQ,MAAO,EAAG,EACxCgL,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAO,EAAK,EAChDgL,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,MAAO,GAAK,EACnDgL,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAO,EAAG,EAC/CgL,EAAU,CAAE,KAAMhL,EAAI,eAAgB,MAAO,EAAG,EAOpD,IAEA1C,EAAI,GAAG,kBAAmB,IAAM,CAC9B,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAKgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,iBAAkB,GAL9C2O,GAAA,EACA3D,EAAU,CAAE,KAAMhL,EAAI,SAAU,EAOpC,IAEA1C,EAAI,GAAG,sBAAuB,IAAM,CAClC,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAIgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAaA,EAAI,aAAc,MAAO,IAAK,GALxFkP,GAAA,EACAlE,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAO,IAAK,EAOpD,IAEA1C,EAAI,GAAG,qBAAsB,IAAM,CACjC,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAIgBlF,EAAkB,oBAAoB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAaA,EAAI,MAAO,MAAO,EAAG,GAL/EoP,GAAA,EACApE,EAAU,CAAE,KAAMhL,EAAI,MAAO,MAAO,EAAG,EAO3C,IAGA1C,EAAI,GAAG,eAAgB,IAAM,CAC3BV,EAAI,KAAK,mDAAmD,EAC5DuP,GAAA,CACF,IAKA7O,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMyI,EAAOzI,EAAK,CAAC,EAKnB,GAJI,GAACyI,GAAM,MAGMhF,EAAgC,kBAAkB,GAGnE,GAAI,CACF,MAAMyP,EAAezP,EAAiB,oBAAoB,EAC1DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,OAAQ,MAAO+P,EAAc,EAEnD,MAAM3D,EAAY9L,EAAiB,iBAAiB,EACpDgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,OAAQ,MAAOoM,EAAY,IAAK,EAEtD,MAAMC,EAAc/L,EAAiB,mBAAmB,EACxDgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,aAAc,MAAOqM,EAAa,EAExD,MAAMC,EAAiBhM,EAAiB,sBAAsB,EAC9DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,gBAAiB,MAAOsM,EAAgB,EAE9D,MAAMC,EAAejM,EAAiB,oBAAoB,EAC1DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,cAAe,MAAOuM,EAAc,EAE1D,MAAMC,EAAgBlM,EAAiB,qBAAqB,EAC5DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,eAAgB,MAAOwM,EAAe,EAE5D,MAAMG,EAAWrM,EAAmB,gBAAgB,EAChDqM,GACFA,EAAS,QAAQ,CAACqB,EAAKpN,IAAM,CAC3B0E,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,KAAMY,EAAG,MAAOoN,EAAK,CACxD,CAAC,EAGH,MAAMpB,EAAiBtM,EAAiB,sBAAsB,EAC9DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,OAAQ,MAAO,KAAK,MAAM,GAAK,KAAK,MAAM,KAAK,IAAI4M,EAAgB,IAAI,CAAC,CAAC,EAAG,EAElG,MAAMH,EAAcnM,EAAiB,mBAAmB,EACxDgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,aAAc,MAAOyM,EAAc,IAAK,EAE9D,MAAMC,EAAcpM,EAAiB,mBAAmB,EACxDgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,MAAO,MAAO0M,EAAc,IAAK,EAEvD9P,EAAI,MAAM,sDAAsD,CAClE,OAASO,EAAG,CACVP,EAAI,KAAK,mCAAoCO,CAAC,CAChD,CACF,IAIA,SAAS6S,GAAatL,EAAqC,CACzD,GAAIA,EAAK,QAAU,QAAaA,EAAK,QAAU,KAAM,OACrD,MAAMR,EAAM,OAAOQ,EAAK,KAAK,EAC7BpH,EAAI,KAAK,mBAAoB4G,CAAG,EAChC5G,EAAI,KAAK,gBAAiB,WAAW,KAAK,MAAM4G,EAAM,GAAG,CAAC,GAAG,CAC/D,CAEA,SAAS+L,GAAkBvL,EAAqC,CAC1DA,EAAK,OAAS,QAAaA,EAAK,QAAU,QAC9C0J,GAAM,OAAO1J,EAAK,IAAI,EAAG,OAAOA,EAAK,KAAK,CAAC,CAC7C,CAEA,SAASwL,GAAgBxL,EAAqC,CACxDA,EAAK,QAAU,QACnBmK,GAAU,OAAOnK,EAAK,KAAK,CAAC,CAC9B,CAEA,SAASyL,IAAyB,CAChCxB,GAAA,CACF,CAEA,SAASyB,GAAgB1L,EAAqC,CACxDA,EAAK,QAAU,QACnBoJ,EAAe,MAAO,OAAOpJ,EAAK,KAAK,CAAC,CAC1C,CAEA,SAAS2L,GAAoB3L,EAAqC,CAChE,GAAI,CAACA,EAAK,MAAO,OACjB,MAAMO,EAAO,OAAOP,EAAK,KAAK,EAC9B,OAAQO,EAAA,CACN,IAAK,OACHvE,EAAS,oBAAqB,GAAG,EACjCA,EAAS,uBAAwB,GAAI,EACrC,MACF,IAAK,OACHA,EAAS,oBAAqB,GAAG,EACjCA,EAAS,uBAAwB,EAAG,EACpC,MACF,IAAK,QACHA,EAAS,oBAAqB,CAAG,EACjCA,EAAS,uBAAwB,EAAG,EACpC,MACF,QACE,OAEJA,EAAS,mBAAoBuE,CAAI,EACjCkH,GAAA,EACA7O,EAAI,KAAK,gBAAiB,WAAW2H,CAAI,EAAE,CAC7C,CAEA,SAASqL,GAAqB5L,EAAqC,CAC7DA,EAAK,QAAU,QACnBoJ,EAAe,QAAS,OAAOpJ,EAAK,KAAK,CAAC,CAC5C,CAEA,SAAS6L,GAAwB7L,EAAqC,CAChEA,EAAK,QAAU,QACnBoJ,EAAe,WAAY,OAAOpJ,EAAK,KAAK,CAAC,CAC/C,CAEA,SAAS8L,GAAsB9L,EAAqC,CAC9DA,EAAK,QAAU,QACnBoJ,EAAe,SAAU,OAAOpJ,EAAK,KAAK,CAAC,CAC7C,CAEA,SAAS+L,GAAuB/L,EAAqC,CAC/DA,EAAK,QAAU,QACnBoJ,EAAe,UAAW,OAAOpJ,EAAK,KAAK,CAAC,CAC9C,CAEA,SAASgM,GAAqBhM,EAAqC,CAC7DA,EAAK,QAAU,QACnBuK,GAAe,OAAOvK,EAAK,KAAK,CAAC,CACnC,CAEA,SAASiM,GAAejM,EAAqC,CACvDA,EAAK,QAAU,QACnByK,GAAe,OAAOzK,EAAK,KAAK,CAAC,CACnC,CAIA,SAASkM,GAAqBC,EAAgCvL,EAA4B,CAExF,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,oDAAoD0I,GAAM,IAAI,EAAE,EACzE,MACF,CAEAqJ,GAAA,EACA3D,EAAU,CAAE,KAAMhL,EAAI,SAAU,EAClC,CAEA,SAAS8Q,GAAyBD,EAAgCvL,EAA4B,CAE5F,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,wDAAwD0I,GAAM,IAAI,EAAE,EAC7E,MACF,CAEA6I,GAAA,EAEAnD,EAAU,CAAE,KAAMhL,EAAI,OAAQ,MAAO,EAAG,EACxCgL,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAO,EAAK,EAChDgL,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,MAAO,GAAK,EACnDgL,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAO,EAAG,EAC/CgL,EAAU,CAAE,KAAMhL,EAAI,eAAgB,MAAO,EAAG,EAClD,CAIO,SAAS+Q,IAA4B,CAC1C,MAAMC,EAAehU,GACnBA,EAEFmI,EAAiB,CACf,CAACnF,EAAI,MAAM,EAAGgR,EAAYhB,EAAY,EACtC,CAAChQ,EAAI,SAAS,EAAGgR,EAAYf,EAAiB,EAC9C,CAACjQ,EAAI,MAAM,EAAGgR,EAAYd,EAAe,EACzC,CAAClQ,EAAI,QAAQ,EAAGgR,EAAYb,EAAmE,EAC/F,CAACnQ,EAAI,MAAM,EAAGgR,EAAYZ,EAAe,EACzC,CAACpQ,EAAI,WAAW,EAAGgR,EAAYX,EAAmB,EAClD,CAACrQ,EAAI,YAAY,EAAGgR,EAAYV,EAAoB,EACpD,CAACtQ,EAAI,eAAe,EAAGgR,EAAYT,EAAuB,EAC1D,CAACvQ,EAAI,aAAa,EAAGgR,EAAYR,EAAqB,EACtD,CAACxQ,EAAI,cAAc,EAAGgR,EAAYP,EAAsB,EACxD,CAACzQ,EAAI,YAAY,EAAGgR,EAAYN,EAAoB,EACpD,CAAC1Q,EAAI,KAAK,EAAGgR,EAAYL,EAAc,EACvC,CAAC3Q,EAAI,gBAAgB,EAAG4Q,GACxB,CAAC5Q,EAAI,oBAAoB,EAAG8Q,EAAA,CAC7B,EAEDlU,EAAI,KAAK,wCAAwC,CACnD,CCzjBO,SAASqU,GAAeC,EAAoB,CAIjD,GAHAxQ,EAAS,oBAAqBwQ,CAAI,EAG9B,CADO3O,GAAA,EACF,OAET,MAAM4O,EAAK1O,GAAA,EACL2O,EAAK1O,GAAA,EACL2O,EAAQ7O,GAAA,EACR8O,EAAUpO,GAAA,EACV6J,EAAUzM,EAAiB,eAAe,EAC1CiR,EAAO,IAGTD,IAAUA,EAA6C,UAAU,MAAQ,KAG7E,GAAI,CAAEH,EAAG,YAAc,MAAQ,CAAiB,CAChD,GAAI,CAAEC,EAAG,YAAc,MAAQ,CAAiB,CAGhDD,EAAG,KAAK,MAAQ,EAChBC,EAAG,KAAK,MAAQ,EAEZF,IAAS,GAEXC,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBF,EAAG,KAAK,OAAO,EAAGI,CAAI,EACtBH,EAAG,KAAK,OAAO,EAAGG,CAAI,GACbL,IAAS,IAElBC,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBF,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBF,EAAG,KAAK,OAAO,EAAGI,CAAI,GACbL,IAAS,GAElBE,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBD,EAAG,KAAK,OAAO,EAAGG,CAAI,GACbL,IAAS,GAEdI,IAAUA,EAA6C,UAAU,MAAQvE,GAC7EoE,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBF,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EAEtBF,EAAG,KAAK,MAAQ,GAChBC,EAAG,KAAK,MAAQ,KAGhBD,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBF,EAAG,KAAK,OAAO,EAAGI,CAAI,EACtBH,EAAG,KAAK,OAAO,EAAGG,CAAI,GAGxBpF,GAAA,EACA7O,EAAI,KAAK,wBAAyB4T,CAAI,CACxC,CAOO,SAASM,GAAmBC,EAAwB,CAGzD,GAFA/Q,EAAS,uBAAwB+Q,CAAO,EAEpCA,EAAS,CACXhO,GAAA,EACA,MAAM4K,EAAM/N,EAAiB,4BAA4B,EACzCoR,GAAZrD,IAAQ,GAAuB,EACXA,CADY,CAEtC,MAEE4C,GAAe3Q,EAAiB,mBAAmB,CAAC,EAItD,MAAMqR,EAAerR,EAAiB,UAAU,GAC5CqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,gBACzEjC,EAAI,KAAK,wBAAwB,CAErC,CAQO,SAASoU,GAAmBrD,EAAmB,CACpD3N,EAAS,6BAA8B2N,CAAG,EAE1C,MAAM/J,EAAWhB,GAAA,EACXsO,EAAQrO,GAAA,EAId,GAHI,CAACe,GAAY,CAACsN,GAGd,CADetR,EAAkB,sBAAsB,EAC1C,OAEjB,MAAM6Q,EAAK1O,GAAA,EACL2O,EAAK1O,GAAA,EACL2O,EAAQ7O,GAAA,EACR8O,EAAUpO,GAAA,EACV6J,EAAUzM,EAAiB,eAAe,EAC1CuR,EAAalP,GAAA,EAEnB,GAAI,CACFiP,EAAM,aACNA,EAAM,QAAQC,CAAU,EACxBvN,EAAS,aAGL+J,IAAQ,GAEV/J,EAAS,QAAQsN,EAAO,EAAG,CAAC,EAC5BtN,EAAS,QAAQsN,EAAO,EAAG,CAAC,GACnBvD,IAAQ,GAEjB/J,EAAS,QAAQsN,EAAO,EAAG,CAAC,EAC5BtN,EAAS,QAAQsN,EAAO,EAAG,CAAC,GACnBvD,IAAQ,EAEjB/J,EAAS,QAAQsN,EAAO,EAAG,CAAC,EAG5BtN,EAAS,QAAQsN,EAAOvD,EAAK,CAAC,EAI5BiD,IACDA,EAA6C,UAAU,MACtDjD,IAAQ,EAAItB,EAAU,KAI1B,GAAI,CAAEoE,EAAG,YAAc,MAAQ,CAAQ,CACvC,GAAI,CAAEC,EAAG,YAAc,MAAQ,CAAQ,CACvCD,EAAG,QAAQE,EAAO,EAAG,CAAC,EACtBD,EAAG,QAAQC,EAAO,EAAG,CAAC,EACtBF,EAAG,KAAK,OAAO,EAAG,EAAG,EACrBC,EAAG,KAAK,OAAO,EAAG,EAAG,EAErB,MAAMU,EAAQ,CACZ,iBAAkB,kBAAmB,kBACrC,YAAa,YAAa,aAC1B,mBAAoB,qBAEtBlV,EAAI,KAAK,2BAA2BkV,EAAMzD,CAAG,CAAC,EAAE,CAClD,OAASlR,EAAG,CACVP,EAAI,KAAK,uCAAwCO,CAAC,CACpD,CAEAG,EAAI,KAAK,wBAAyB+Q,CAAG,CACvC,CAKA,eAAsB0D,GAAWb,EAA6B,CACvD3O,MAAiB,MAAMmB,GAAA,EAC5BuN,GAAeC,CAAI,CACrB,CAIA5T,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMqU,EAAO,OAAOrU,EAAK,CAAC,CAAC,EACvB,OAAO,SAASqU,CAAI,MAAcA,CAAI,CAC5C,IAEA5T,EAAI,GAAG,yBAA0B,IAAIT,IAAoB,CACvD,MAAM4U,EAAU,CAAC,CAAC5U,EAAK,CAAC,EACxB2U,GAAmBC,CAAO,CAC5B,IAEAnU,EAAI,GAAG,8BAA+B,IAAIT,IAAoB,CAC5D,MAAMwR,EAAM,OAAOxR,EAAK,CAAC,CAAC,EACtB,OAAO,SAASwR,CAAG,GAAKA,GAAO,GAAKA,GAAO,GAAGqD,GAAmBrD,CAAG,CAC1E,klCCjMO,SAAS2D,IAA0B,CAExC,GADqB1R,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,OAE/Be,EAAgC,kBAAkB,GAOjEI,EAAS,mBAAoB,CAAC,EAC9BA,EAAS,sBAAuB,CAAC,EACjCpD,EAAI,KAAK,qBAAqB,EAC9BA,EAAI,KAAK,gBAAiB,kBAAkB,EAC5C2U,GAAA,IARAjH,EAAU,CAAE,KAAMhL,EAAI,sBAAuB,EAC7C1C,EAAI,KAAK,gBAAiB,kBAAkB,EAShD,CAIA,SAAS2U,IAAkB,CACzB,MAAMzM,EAAWlF,EAAgC,kBAAkB,EACnE,GAAI,CAACkF,GAAY,CAACA,EAAS,KAAM,OAEjClI,EAAI,KAAK,qBAAqB,EAC9B,MAAM4U,EAAK,KAAK,MAChBxR,EAAS,uBAAwBwR,CAAE,EACnC1M,EAAS,KAAK,CAAE,KAAMxF,EAAI,cAAe,GAAAkS,EAAI,CAC/C,CAQO,SAASC,GAA2BC,EAAQ,IAAY,CAE7D,GADiB9R,EAAgC,kBAAkB,EACrD,OAEd,MAAM+R,EAAc/R,EAA+C,kBAAkB,EACjF+R,gBAA0BA,CAAW,EAEzC,MAAMC,EAAQ,WAAW,IAAM,CAC7B5R,EAAS,mBAAoB,IAAI,EACtBJ,EAAgC,kBAAkB,IAE3D0K,EAAU,CAAE,KAAMhL,EAAI,sBAAuB,EAC7CpD,EAAI,MAAM,oDAAoDwV,CAAK,KAAK,EAE5E,EAAGA,CAAK,EAER1R,EAAS,mBAAoB4R,CAAK,CACpC,CAgDA,SAASC,GAAgB1B,EAAgCvL,EAA4B,CAEnF,GAAI,CACF,GAAIA,GAAQA,EAAK,KAAM,CAErB,MAAMI,EADiBpF,EAAyC,wBAAwB,EAC/D,QAAUkL,EAAE,KAAOlG,EAAK,IAAI,EACjDI,IAAGA,EAAE,cAAgB,KAAK,MAChC,CACF,MAAQ,CAAe,CAGnBJ,GAAQA,EAAK,MACfA,EAAK,KAAK,CAAE,KAAMtF,EAAI,cAAe,CAEzC,CAEA,SAASwS,IAA2B,CAClC9R,EAAS,0BAA2B,KAAK,KAAK,CAChD,CAEA,SAAS+R,GAAkB/N,EAA+BY,EAA4B,CAChF,OAAOZ,EAAK,WAAc,UAC1BY,GAAQA,EAAK,MACfA,EAAK,KAAK,CAAE,KAAMtF,EAAI,aAAc,UAAW0E,EAAK,UAAW,CAEnE,CAEA,SAASgO,GAAkBhO,EAAqC,CAC9D,GAAI,OAAOA,EAAK,WAAc,SAAU,OACxC,MAAMiO,EAAK,KAAK,MAAQjO,EAAK,UACvBkO,EAAiBtS,EAAmB,qBAAqB,EAC/DsS,EAAe,KAAKD,CAAE,EAClBC,EAAe,OAAS,IAAIA,EAAe,QAC/ClS,EAAS,qBAAsB,KAAK,IAAI,GAAGkS,CAAc,CAAC,EAC1DtV,EAAI,KAAK,sBAAuBqV,CAAE,CACpC,CAEA,SAASE,GAAmBnO,EAAqC,CAE/D,GADqBpE,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,OAGhD,GAAImF,EAAK,OAAS,OAAOA,EAAK,OAAU,UAAYA,EAAK,MAAQ,EAAG,CAClE,MAAMoO,EAAU,KAAK,MAAQpO,EAAK,MAClC,GAAIoO,EAAU,IAAK,CACjB,MAAMC,EAAcrO,EAAK,gBAA4B,EACrD,GAAIqO,EAAa,EAAG,CAClBnW,EAAI,MAAM,6BAA6BkW,CAAO,cAAcC,EAAa,CAAC,gBAAgB,EAC1F,WAAW,IAAMd,GAAA,EAAa,GAAG,EACjC,MACF,CACArV,EAAI,KAAK,2CAA2CkW,CAAO,kCAAkC,CAC/F,CACF,CAGA,IAAIE,EAAuB,EACC1S,EAAkB,0BAA0B,IAGtE0S,EADsB1S,EAAiB,oBAAoB,EACnB,EAAK,KAG/CI,EAAS,sBAAuBsS,CAAoB,EACpD1V,EAAI,KAAK,qBAAqB,EAG9BA,EAAI,KAAK,gBAAiBoH,EAAK,KAAgBA,EAAK,UAAsBsO,CAAoB,CAChG,CAEA,SAASC,IAAkC,CACzC3V,EAAI,KAAK,gBAAiB,0BAA0B,EACpDoD,EAAS,mBAAoB,CAAC,EAC9BpD,EAAI,KAAK,qBAAqB,EAC9B,WAAW,IAAM2U,GAAA,EAAa,KAAK,SAAW,GAAG,CACnD,CAEA,SAASiB,GAAkBxO,EAA+BY,EAA4B,CACnEhF,EAAgC,kBAAkB,GAG/DgF,GAAQA,EAAK,MACfhI,EAAI,KAAK,oBAAsB6V,GAAqB,CAClD,MAAMxB,EAAerR,EAAiB,UAAU,EAC1C8S,EAAYzB,IAAiBpS,EAAU,eAC3BoS,IAAiBpS,EAAU,eAC3BoS,IAAiBpS,EAAU,gBAE7C+F,EAAK,KAAK,CACR,KAAMtF,EAAI,cACV,KAAMmT,EACN,UAAAC,EACA,MAAQ1O,EAAK,IAAiB,EAC/B,CACH,CAAC,CAEL,CAIO,SAAS2O,IAAiB,CAC/BlO,EAAiB,CACf,CAACnF,EAAI,SAAS,EAAGuS,GACjB,CAACvS,EAAI,aAAa,EAAGwS,GACrB,CAACxS,EAAI,YAAY,EAAGyS,GACpB,CAACzS,EAAI,YAAY,EAAG0S,GACpB,CAAC1S,EAAI,aAAa,EAAG6S,GACrB,CAAC7S,EAAI,qBAAqB,EAAGiT,GAC7B,CAACjT,EAAI,aAAa,EAAGkT,EAAA,CACtB,EAGD5V,EAAI,GAAG,cAAe,IAAIT,IAAoB,CAC5C,MAAMmR,EAAM,OAAOnR,EAAK,CAAC,CAAC,EACrB,OAAO,SAASmR,CAAG,GAExBsF,GAAA,+BAAAC,EAAA,UAAgC,KAAKC,GAAOA,EAAI,WAAWxF,EAAM,GAAI,CAAC,CACxE,IAEA1Q,EAAI,GAAG,kBAAmB,IAAM,CAC9B0U,GAAA,CACF,IAEA1U,EAAI,GAAG,qBAAsB,IAAM,CACjC,MAAMmW,EAAU,SAAS,eAAe,qBAAqB,EACzDA,GAASA,EAAQ,UAAU,OAAO,MAAM,CAC9C,IAEAnW,EAAI,GAAG,uBAAwB,IAAM,CACnC,MAAMoW,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAC5DsT,EAAQF,EAAcC,EACtBE,EAAK,SAAS,eAAe,mBAAmB,EAClDA,IAAIA,EAAG,UAAY,GAAGD,GAAS,EAAI,IAAM,EAAE,IAAIA,EAAQ,KAAM,QAAQ,CAAC,CAAC,KAC7E,IAGAtW,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CACnD,MAAMuC,EAAKvC,EAAK,CAAC,EACX2I,EAAWlF,EAAgC,kBAAkB,EACnE,GAAI,GAACkF,GAAY,CAACA,EAAS,OAE3B,GAAIpG,IAAO,YACT,GAAI,CAAEoG,EAAS,KAAK,CAAE,KAAMxF,EAAI,UAAW,CAAG,MAAQ,CAAa,SAC1DZ,IAAO,OAChB,GAAI,CAAEoG,EAAS,KAAK,CAAE,KAAMxF,EAAI,aAAc,UAAW,KAAK,MAAO,CAAG,MAAQ,CAAa,EAEjG,IAEApD,EAAI,KAAK,4BAA4B,CACvC,CC/PA,MAAMiO,OAAwB,IAC9B,IAAIiJ,GAAoB,EACpBC,GAAgB,EAChBC,GAAsD,GAI1D,SAASC,IAA2B,CAClC9N,EAAkB,eAAe,EACjC4N,GAAgB,KAAK,MACrBrT,EAAS,qCAAsCJ,EAAiB,wBAAwB,CAAC,EAEzFyF,EAAgB,gBAAiB,IAAM,CACrC,MAAMmO,EAAgB,KAAK,MAAQH,GAC7BI,EAAgB7T,EAAiB,wBAAwB,EACzD8T,EAAe9T,EAAiB,oCAAoC,GACzD6T,IAAkBC,GAAiBF,EAAgBxU,IAErDwU,EAAgBxU,MAC7ByG,EAAkB,eAAe,EACjC7I,EAAI,KAAK,0BAA0B,GAErCoD,EAAS,qCAAsCyT,CAAa,CAC9D,EAAG,IAAM,CAAE,SAAU,GAAM,CAC7B,CAIA,SAASE,GAAkB3P,EAAqC,CAE1DpE,EAAkB,4BAA4B,IAChD1D,EAAI,MAAM,sDAAsD,EAChE8D,EAAS,6BAA8B,EAAK,GAE9CyF,EAAkB,iBAAiB,EACnCzF,EAAS,sBAAuB,CAAC,EAEjC,MAAM4T,EAAc5P,EAAK,UACnB6P,EAAejU,EAAiB,yBAAyB,EAG3DgU,GAAeA,EAAcC,IAC/B3X,EAAI,MAAM,+BAA+B0X,CAAW,WAAWC,CAAY,GAAG,EAC9E7T,EAAS,0BAA2B4T,CAAW,GAIjD,MAAME,EAAclU,EAAyC,cAAc,EACrEmU,EAAenU,EAAsB,sBAAsB,EAC3DoU,EAAsBF,GAAe9P,EAAK,QAAU,QAAaA,EAAK,QAAU8P,EAAY,MAC5FG,EAAqBH,GAAe9P,EAAK,MAAQA,EAAK,OAAS8P,EAAY,KAejF,GAZmBA,GAAe9P,EAAK,QAAU,QAAaA,EAAK,QAAU8P,EAAY,QAEvF5X,EAAI,KAAK,mDAAmD8H,EAAK,KAAK,gBAAgB8P,EAAa,KAAK,2BAA2B,EACnI9T,EAAS,6BAA8B,EAAK,EAC5CyF,EAAkB,iBAAiB,EAEnCzF,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7BA,EAAS,yBAA0B,EAAE,EACrCA,EAAS,gBAAiB,CAAC,GAGzB+T,IAAiBC,GAAuBC,GAAqB,CAC/D/X,EAAI,MAAM,2DAA4D8H,EAAK,IAAI,EAC/EpH,EAAI,KAAK,gBAAiB,cAAc,EAGxCA,EAAI,KAAK,uBAAuB,EAE5BoH,EAAK,QAAU,QACjBhE,EAAS,6BAA8BgE,EAAK,KAAe,EAE7DpH,EAAI,KAAK,oBAAoB,EAE7BoD,EAAS,4BAA6B,EAAI,EAC1CpD,EAAI,KAAK,wBAAyBoH,EAAK,MAAiBA,EAAK,IAAc,EAE3EpH,EAAI,KAAK,iBAAkB,EAAK,EAChC,MACF,CAGAA,EAAI,KAAK,uBAAuB,EAGhC,MAAMsX,EAA2BJ,GAAe9P,EAAK,QAAU,QAAaA,EAAK,QAAU8P,EAAY,MACjGK,EAA0BL,GAAe9P,EAAK,MAAQA,EAAK,OAAS8P,EAAY,KAGtF,GAFqBlU,EAAkB,sBAAsB,IAExCsU,GAA4BC,GAE/C,GAAIP,EAAcC,EAChB3X,EAAI,MAAM,sFAAsF,EAChG8D,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7BA,EAAS,yBAA0B,EAAE,MAEhC,CACL9D,EAAI,MAAM,+DAA+D,EACzEU,EAAI,KAAK,iBAAkB,GAAM,iBAAiBoH,EAAK,IAAI,EAAE,EAE7DhE,EAAS,2BAA4BgE,EAAK,MAAkB,EAAE,EAC9DhE,EAAS,4BAA6BgE,EAAK,KAAe,EAC1DhE,EAAS,6BAA8B,EAAI,EAC3CA,EAAS,4BAA6B,EAAI,EAEtCgE,EAAK,QAAU,SACjBhE,EAAS,6BAA8BgE,EAAK,KAAe,EAC3DpH,EAAI,KAAK,oBAAoB,GAI/ByI,EAAgB,kBAAmB,IAAM,CACvC,GAAIzF,EAAkB,4BAA4B,EAAG,CACnD1D,EAAI,KAAK,qDAAqD,EAC9D8D,EAAS,6BAA8B,EAAK,EAC5CpD,EAAI,KAAK,iBAAkB,EAAK,EAChCoD,EAAS,4BAA6B,EAAK,EAE3C,MAAM8E,EAAWlF,EAAgC,kBAAkB,EAC/DkF,GAAYA,EAAS,MACvBA,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,KAAM0E,EAAK,KAAM,MAAOA,EAAK,MAAO,CAExF,CACF,EAAG,GAAK,EAER,MACF,CAIFhE,EAAS,4BAA6B,EAAK,EAC3CA,EAAS,6BAA8B,EAAK,EAG5CA,EAAS,2BAA4BgE,EAAK,MAAkB,EAAE,EAC9DhE,EAAS,4BAA6BgE,EAAK,KAAe,EAG1D,MAAMoQ,EAAOxU,EAAkC,eAAe,EACxD6T,EAAgB7T,EAAiB,wBAAwB,EACzDyU,EAAmBzU,EAA6B,2BAA2B,GAC7DwU,EAAK,OAASpQ,EAAK,MACpCqQ,IAAqB,QAAaA,IAAqBrQ,EAAK,QAC9ByP,EAAgB,GAG/CvX,EAAI,MAAM,yCAAyCuX,CAAa,0BAA0B,EAC1F7W,EAAI,KAAK,iBAAkB,GAAM,YAAYoH,EAAK,IAAI,EAAE,IAExDpH,EAAI,KAAK,+BAAgC,cAAc,EACnDoH,EAAK,QAAU,SACjBhE,EAAS,6BAA8BgE,EAAK,KAAe,EAC3DpH,EAAI,KAAK,oBAAoB,GAG/BoD,EAAS,gBAAiB,CACxB,GAAGoU,EACH,KAAMpQ,EAAK,MAAQ,GACnB,MAAOA,EAAK,OAASpE,EAAiB,4BAA4B,EAClE,KAAMoE,EAAK,MAAQ,EACnB,KAAMA,EAAK,MAAQ,GACnB,UAAWA,EAAK,WAAapE,EAAiB,yBAAyB,EACxE,EAGoBA,EAAiB,UAAU,IAC3Bf,EAAU,kBAC7B3C,EAAI,MAAM,8DAA8D,EACxEU,EAAI,KAAK,mBAAmB,GAG9BA,EAAI,KAAK,iBAAkB,GAAM,SAASoH,EAAK,IAAI,EAAE,GAIvDqB,EAAgB,kBAAmB,IAAM,CACvC,MAAMiP,EAAgB1U,EAAiB,gBAAgB,EACjD2U,EAAK3U,EAAiB,wBAAwB,EACpD,GAAI0U,IAAkBxV,EAAe,MAAQyV,IAAO,EAAG,CACrDrY,EAAI,KAAK,oDAAoD,EAC7DU,EAAI,KAAK,gBAAiB,uBAAuB,EAEjD,MAAMkI,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAYA,EAAS,KAAM,CAC7B,MAAM0P,EAAS,KAAK,SAAW,IAAO,IACtC,WAAW,IAAM,CACX1P,EAAS,MAAQ,CAAClF,EAAsB,uBAAuB,GACjEhD,EAAI,KAAK,0BAA0B,CAEvC,EAAG4X,CAAM,CACX,CACF,CACF,EAAG,IAAK,CACV,CAEA,SAASC,GAAgBzQ,EAAqC,CAC5D,MAAM4P,EAAc5P,EAAK,UACnB0Q,EAAW9U,EAAiB,yBAAyB,EAE3D,GAAI,CAACgU,GAAeA,EAAcc,EAAU,CAC1CxY,EAAI,KAAK,gDAAgDwY,CAAQ,eAAed,CAAW,EAAE,EAC7F,MACF,CAUA,GARqBA,EAAcc,IAEjC1U,EAAS,0BAA2B4T,CAAW,EAC/CvN,EAAkB,CAAE,QAAS,aAAc,UAAW,GAAO,EAC7DzJ,EAAI,KAAK,+BAAgC,mBAAmB,GAI1DgD,EAAkB,2BAA2B,EAAG,CAClD6F,EAAkB,iBAAiB,EACnCA,EAAkB,eAAe,EAGT7F,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,EAE1D,MACF,CAEAyB,EAAkB,iBAAiB,EACnCA,EAAkB,eAAe,EAGjC,MAAM2O,EAAOxU,EAAkC,eAAe,EACxD6T,EAAgB7T,EAAiB,wBAAwB,EACzD+U,EAAqBP,EAAK,OAASpQ,EAAK,MAAQoQ,EAAK,QAAWpQ,EAAK,MAErE4Q,EAAehV,EAAkC,uBAAuB,EA0C9E,GAzCIgV,EAAa,MAAQA,EAAa,OAAS5Q,EAAK,MAClD6C,GAAoB+N,EAAa,KAAM,EAAK,EAE9CA,EAAa,KAAO5Q,EAAK,KAErB2Q,GAAsBlB,EAAgB,GAExCvX,EAAI,MAAM,4CAA4CuX,CAAa,IAAIzP,EAAK,KAAK,SAAS,EAE1FqC,EAAkB,CAChB,QAAS,aACT,SAAUrC,EAAK,KACf,UAAW,GACX,UAAWvF,GAAkBmV,CAAW,EACxC,KAAM7U,GACN,aAAc,GACf,EAEDiB,EAAS,gBAAiBgE,CAAI,EAC9BhE,EAAS,iBAAkBlB,EAAe,SAAS,IAGnDuH,EAAkB,CAChB,QAAS,aACT,SAAUrC,EAAK,KACf,UAAW,GACX,UAAWvF,GAAkBmV,CAAW,EACxC,KAAM7U,EAAA,CACP,EAEDiB,EAAS,yBAA0B,CAAC,EACpCA,EAAS,gBAAiBgE,CAAI,EAC9BhE,EAAS,iBAAkBlB,EAAe,SAAS,EAEnDqL,GAAkB,QAClBiJ,GAAoB,GAGtBG,GAAA,EAGID,GAAoB,OAAS,EAAG,CAClC,MAAMuB,EAAcvB,GAAoB,OAAO,CAAC,EAChDpX,EAAI,MAAM,0BAA0B2Y,EAAY,MAAM,eAAe,EACrE,UAAWC,KAAWD,EACpBE,GAAgBD,CAAO,CAE3B,CAGwBlV,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,EAE1DpH,EAAI,KAAK,iBAAkB,GAAM,YAAY,CAC/C,CAEA,SAASoY,GAAiBhR,EAAqC,CAC7D,MAAM4P,EAAc5P,EAAK,UACnB0Q,EAAW9U,EAAiB,yBAAyB,EAE3D,GAAI,CAACgU,GAAeA,EAAcc,EAAU,OACxCd,EAAcc,GAAU1U,EAAS,0BAA2B4T,CAAW,EAE3EnO,EAAkB,iBAAiB,EACnCzF,EAAS,4BAA6B,EAAK,EAE3CqG,EAAkB,CAChB,QAAS,aACT,SAAUrC,EAAK,KACf,UAAW,GACX,UAAWvF,GAAkBmV,CAAW,EACxC,KAAM7U,EAAA,CACP,EAED,MAAM6V,EAAehV,EAAkC,uBAAuB,EAC9EgV,EAAa,KAAO5Q,EAAK,KAEzBoP,GAAqBpP,EAAK,YAAyB,EACnDhE,EAAS,gBAAiBgE,CAAI,EAC9BhE,EAAS,iBAAkBlB,EAAe,SAAS,EAEnDyU,GAAA,EAEwB3T,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,CAC5D,CAEA,SAAS+Q,GAAgB/Q,EAAqC,CAC5D,MAAM4P,EAAc5P,EAAK,UACzB,GAAI,CAAC4P,EAAa,OAGlB,GAAIhU,EAAkB,2BAA2B,EAAG,CAClD,MAAM8U,EAAW9U,EAAiB,yBAAyB,EACvDgU,EAAcc,GAAU1U,EAAS,0BAA2B4T,CAAW,EAC3E,MACF,CAIA,GADsBhU,EAAiB,gBAAgB,IACjCd,EAAe,MAAQ,CAACqL,GAAkB,IAAIyJ,CAAW,EAAG,CAChFN,GAAoB,KAAKtP,CAAI,EACzBsP,GAAoB,OAAS,KAAKA,GAAoB,QAC1D,MACF,CAEA,MAAMoB,EAAW9U,EAAiB,yBAAyB,EAY3D,GATIgU,EAAcc,IAChB1U,EAAS,0BAA2B4T,CAAW,EAC/CvN,EAAkB,CAAE,QAAS,aAAc,UAAW,GAAO,EAC7DzJ,EAAI,KAAK,+BAAgC,gBAAgB,EACzDuN,GAAkB,QAClBiJ,GAAoB,EACpBpT,EAAS,yBAA0B,CAAC,GAGlC4T,EAAcc,EAAU,OAEvBvK,GAAkB,IAAIyJ,CAAW,IACpCzJ,GAAkB,IAAIyJ,EAAa,IAAI,GAAK,EAC5CR,GAAoB,GAGtB,MAAM6B,EAAgB9K,GAAkB,IAAIyJ,CAAW,EACjDsB,EAAY,IAAI,WAAWlR,EAAK,KAAoB,EAC1DiR,EAAc,IAAIjR,EAAK,MAAiBkR,CAAS,EAEjD,MAAMd,EAAOxU,EAAkC,eAAe,EACxDgV,EAAehV,EAAkC,uBAAuB,EAC9E,IAAI6T,EAAgB7T,EAAiB,wBAAwB,EAG7D,GAAI,CAACwU,GAAQA,EAAK,QAAU,QAAaA,EAAK,QAAU,GACtD,GAAIpQ,EAAK,QAAU,QAAa,OAAOA,EAAK,KAAK,EAAI,EAAG,CACtD,MAAMmR,EAAgB,CACpB,KAAMnR,EAAK,MAAQoQ,GAAM,MAAQ,GACjC,MAAOpQ,EAAK,MACZ,UAAW4P,EACX,KAAM5P,EAAK,MAAQ,EACnB,KAAMA,EAAK,MAAQ,IAErBhE,EAAS,gBAAiBmV,CAAa,EACvCnV,EAAS,iBAAkBlB,EAAe,SAAS,EAEnD,MAAMsW,EAASD,EAAc,MAAmB,GAC5CC,IACFR,EAAa,KAAOQ,EACpB/O,EAAkB,CAChB,QAAS,aACT,SAAU+O,EACV,UAAW,GACX,UAAW3W,GAAkBmV,CAAW,EACxC,KAAM7U,EAAA,CACP,GAEH7C,EAAI,MAAM,0CAA0CkZ,CAAK,KAAKD,EAAc,KAAK,UAAU,CAC7F,SAAW,CAACf,GAAQA,EAAK,QAAU,OAEjC,OAKJ,KAAOa,EAAc,IAAI7B,EAAiB,GAAG,CAC3C,MAAMiC,EAAQJ,EAAc,IAAI7B,EAAiB,EAG3CkC,EAAkB1V,EAA2B,2BAA2B,EAC9E,IAAI2V,EAA+B,KAenC,GAdID,EAAgB,OAAS,IAC3BC,EAAY,IAAI,WAAWF,CAAK,GAGlChP,EAAkB,CAChB,QAAS,aACT,MAAOgP,aAAiB,YAAcA,EAASA,EAAqB,OACpE,MAAOjC,GACP,UAAW,GACX,SAAUwB,EAAa,MAAQ,GAC/B,UAAWnW,GAAkBmV,CAAW,EACzC,EAGG2B,GAAaD,EAAgB,OAAS,EAAG,CAC3C,MAAME,EAAW,CACf,KAAMlW,EAAI,WACV,MAAOiW,EACP,MAAOnC,GACP,UAAWQ,CAAA,EAEb0B,EAAgB,QAAQtQ,GAAK,CAC3B,GAAIA,EAAE,KAAM,GAAI,CAAEA,EAAE,KAAKwQ,CAAQ,CAAG,MAAQ,CAAa,CAC3D,CAAC,CACH,CAEAP,EAAc,OAAO7B,EAAiB,EACtCA,KACAK,GACF,CAEAzT,EAAS,yBAA0ByT,CAAa,EAChDJ,GAAgB,KAAK,MAGrB,MAAMH,EAASkB,EAAK,OAAoB,EACxC,GAAIlB,EAAQ,EAAG,CACb,MAAMuC,EAAU,KAAK,IAAI,IAAK,KAAK,MAAOhC,EAAgBP,EAAS,GAAG,CAAC,EACvEtW,EAAI,KAAK,4BAA6B6Y,EAASvC,CAAK,CACtD,CAGA,GAAIA,EAAQ,GAAKO,GAAiBP,GAAStT,EAAiB,gBAAgB,IAAMd,EAAe,WAAY,CAC3GkB,EAAS,iBAAkBlB,EAAe,UAAU,EACpDkB,EAAS,sBAAuB,CAAC,EAGjC,MAAM8E,EAAWlF,EAAgC,kBAAkB,EAC7D8V,EAAkBtB,EAAK,MACzBtP,GAAYA,EAAS,MAAQ4Q,IAAoB,QACnD5Q,EAAS,KAAK,CAAE,KAAMxF,EAAI,YAAa,MAAOoW,EAAiB,EAIjErP,EAAkB,CAChB,QAAS,WACT,SAAW+N,EAAK,MAAmB,GACnC,UAAW,GACX,UAAW3V,GAAkBmV,CAAW,EACxC,UAAWQ,EAAK,KACjB,EAED3O,EAAkB,eAAe,CACnC,CACF,CAEA,SAASkQ,GAAc3R,EAAqC,CAC1D,GAAIpE,EAAkB,2BAA2B,EAAG,OAG5BA,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,EAE1D9H,EAAI,MAAM,uCAAuC8H,EAAK,IAAI,EAAE,CAC9D,CAEA,SAAS4R,IAAuB,CAC9B1Z,EAAI,MAAM,8DAA8D,EACxEU,EAAI,KAAK,gBAAiB,wBAAwB,EAElD6I,EAAkB,kBAAkB,EACpCJ,EAAgB,mBAAoB,IAAM,CAExC,GADsBzF,EAAiB,wBAAwB,IACzC,EAAG,CACvB1D,EAAI,MAAM,mDAAmD,EAC7DU,EAAI,KAAK,gBAAiB,4BAA4B,EAGtD,MAAMiZ,EAAmBjW,EAAgC,wBAAwB,EAC7EiW,IACFA,EAAiB,QACjB7V,EAAS,yBAA0B,IAAI,GAIzC,MAAM8E,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAYA,EAAS,KAAM,CAC7B,MAAMgR,EAAkBlW,EAAiB,0BAA0B,GAAK,GAClEyU,EAAmBzU,EAA6B,2BAA2B,EAC3EmW,EAAoBnW,EAAiB,4BAA4B,EACjEoW,EAAgB3B,IAAqB,OAAYA,EAAmB0B,EACpEE,EAAWrW,EAAoB,gBAAgB,GAAK,GAG1D,GAAIoW,EAAgB,GAAKA,GAAiBC,EAAS,OAAQ,CACzD/Z,EAAI,KAAK,wDAAyD8Z,CAAa,EAC/EpZ,EAAI,KAAK,iBAAkB,EAAK,EAChC,MACF,CAGA,MAAMkX,EAAclU,EAAyC,cAAc,EAC3E,GAAIkU,GAAeA,EAAY,QAAUkC,EAAe,CACtD9Z,EAAI,MAAM,oEAAoE,EAC9EU,EAAI,KAAK,gBAAiB,iBAAiB,EAC3C,MACF,CAEAV,EAAI,MAAM,6CAA6C4Z,CAAe,WAAWE,CAAa,EAAE,EAChGlR,EAAS,KAAK,CACZ,KAAMxF,EAAI,sBACV,UAAW,EACX,SAAUwW,EACV,MAAOE,CAAA,CACR,CACH,CACF,CACF,EAAG,GAAK,CACV,CAOA,eAAsBE,GAAcC,EAAYC,EAAmC,KAAqB,CACtG,IAAIC,EACJ,MAAMC,EAA2B1W,EAAiB,2BAA2B,EAW7E,GATIwW,IAAsB,MACxBC,EAAYD,EACRC,EAAYC,GAA0BtW,EAAS,4BAA6BqW,CAAS,IAEzFA,EAAYC,EAA2B,EACvCtW,EAAS,4BAA6BqW,CAAS,GAGzBzW,EAAwB,iCAAiC,IACzDyW,EAAW,OACnCrW,EAAS,kCAAmCqW,CAAS,EAErD,MAAME,EAAQxX,GACRmU,EAAQ,KAAK,KAAKiD,EAAK,KAAOI,CAAK,EACnCR,EAAoBnW,EAAiB,4BAA4B,EACjE4W,EAAS,CACb,KAAMlX,EAAI,WACV,KAAM6W,EAAK,KACX,KAAMA,EAAK,KACX,MAAAjD,EACA,KAAMiD,EAAK,KACX,MAAOJ,EACP,UAAAM,CAAA,EAIII,EADiB7W,EAAyC,wBAAwB,EACnD,OAAOoF,GAC1CA,EAAE,SAAW,aAAgBA,EAAE,MAAyB,MAAQA,EAAE,eAAiB,IAGrF,GAAIyR,EAAc,SAAW,EAAG,OAGhCA,EAAc,QAAQzR,GAAK,CACzB,GAAI,CAAGA,EAAE,KAAwB,KAAKwR,CAAM,CAAG,MAAQ,CAAa,CACtE,CAAC,EAGD,QAAStW,EAAI,EAAGA,EAAIgT,EAAOhT,IAAK,CAC9B,GAAIN,EAAwB,iCAAiC,IAAMyW,EAAW,OAE9E,MAAMK,EAAQxW,EAAIqW,EACZI,EAAM,KAAK,IAAID,EAAQH,EAAOJ,EAAK,IAAI,EACvCS,EAAW,MAAMT,EAAK,MAAMO,EAAOC,CAAG,EAAE,cACxCtB,EAAQ,IAAI,WAAWuB,CAAQ,EAC/BpB,EAAW,CAAE,KAAMlW,EAAI,WAAY,MAAA+V,EAAO,MAAOnV,EAAG,UAAAmW,EAAW,MAAAnD,EAAO,KAAMiD,EAAK,MAEvF,UAAWnR,KAAKyR,EAAe,CAC7B,MAAM7R,EAAOI,EAAE,KACf,GAAIJ,GAAM,KAAM,CAEd,KAAOA,EAAK,aAAeA,EAAK,YAAY,eAAiB,IAAM,OACjE,MAAM,IAAI,QAAQiS,GAAK,WAAWA,EAAG1X,GAAM,YAAY,CAAC,EACpD,EAACyF,EAAK,OAAV,CAEF,GAAI,CAAEA,EAAK,KAAK4Q,CAAQ,CAAG,MAAQ,CAAa,CAClD,CACF,CAEItV,EAAI,KAAO,GAAG,MAAM,IAAI,QAAQ2W,GAAK,WAAWA,EAAG1X,GAAM,IAAI,CAAC,CACpE,CAGA,MAAM2X,EAAS,CAAE,KAAMxX,EAAI,SAAU,KAAM6W,EAAK,KAAM,KAAMA,EAAK,KAAM,UAAAE,CAAA,EACvEI,EAAc,QAAQzR,GAAK,CACzB,MAAMJ,EAAOI,EAAE,KACf,GAAIJ,GAAM,KAAM,GAAI,CAAEA,EAAK,KAAKkS,CAAM,CAAG,MAAQ,CAAa,CAChE,CAAC,EAED9W,EAAS,kCAAmC,IAAI,CAClD,CAKA,eAAsB+W,GACpBnS,EACAuR,EACAa,EAAkB,EAClBX,EAA2B,KACZ,CACf,GAAI,CAACzR,GAAQ,CAACA,EAAK,KAAM,CACvB1I,EAAI,MAAM,kCAAkC,EAC5C,MACF,CAEA,MAAM+a,EAAqBZ,GAAazW,EAAiB,2BAA2B,EAC9E2W,EAAQxX,GACRmU,EAAQ,KAAK,KAAKiD,EAAK,KAAOI,CAAK,EACnCR,EAAoBnW,EAAiB,4BAA4B,EAGjEiF,EADWmS,EAAkB,EACR1X,EAAI,YAAcA,EAAI,WAC3C4X,EAAW,SAAUf,EAAOA,EAAK,KAAO,QAE9C,GAAI,CACFvR,EAAK,KAAK,CACR,KAAMC,EACN,KAAMqS,EACN,KAAMf,EAAK,KACX,MAAAjD,EACA,KAAMiD,EAAK,KACX,WAAYa,EACZ,UAAWC,EACX,MAAOlB,CAAA,CACR,CACH,OAAStZ,EAAG,CACVP,EAAI,MAAM,4BAA4B2I,CAAO,IAAKpI,CAAC,EACnD,MACF,CAEA,MAAM,IAAI,QAAQoa,GAAK,WAAWA,EAAG,GAAG,CAAC,EAEzC,GAAI,CACF,QAAS3W,EAAI8W,EAAiB9W,EAAIgT,EAAOhT,IAAK,CAE5C,GADIN,EAAiB,2BAA2B,IAAMqX,GAClD,CAACrS,EAAK,KAAM,OAGhB,MAAMuS,EAAY,KAAK,MACvB,KAAOvS,EAAK,aAAeA,EAAK,YAAY,eAAiB,GAAK,MAC5D,OAAK,MAAQuS,EAAY,MAC7B,MAAM,IAAI,QAAQN,GAAK,WAAWA,EAAG1X,GAAM,YAAY,CAAC,EAG1D,MAAMuX,EAAQxW,EAAIqW,EACZI,EAAM,KAAK,IAAID,EAAQH,EAAOJ,EAAK,IAAI,EACvCS,EAAW,MAAMT,EAAK,MAAMO,EAAOC,CAAG,EAAE,cACxCtB,EAAQ,IAAI,WAAWuB,CAAQ,EAErChS,EAAK,KAAK,CACR,KAAMtF,EAAI,WACV,MAAA+V,EACA,MAAOnV,EACP,UAAW+W,EACX,MAAA/D,EACA,KAAMgE,CAAA,CACP,EAEGhX,EAAI,KAAO,GAAG,MAAM,IAAI,QAAQ2W,GAAK,WAAWA,EAAG1X,GAAM,IAAI,CAAC,CACpE,CAEIyF,EAAK,OACPA,EAAK,KAAK,CAAE,KAAMtF,EAAI,SAAU,KAAM4X,EAAU,KAAMf,EAAK,KAAM,UAAWc,CAAA,CAAoB,EAChG/a,EAAI,MAAM,+BAAgCgb,CAAQ,EAEtD,OAASza,EAAG,CACVP,EAAI,MAAM,4BAA6BO,CAAC,CAC1C,CACF,CAIO,SAAS2a,IAAqB,CACnC3S,EAAiB,CACf,CAACnF,EAAI,YAAY,EAAGqU,GACpB,CAACrU,EAAI,UAAU,EAAGmV,GAClB,CAACnV,EAAI,WAAW,EAAG0V,GACnB,CAAC1V,EAAI,UAAU,EAAGyV,GAClB,CAACzV,EAAI,QAAQ,EAAGqW,GAChB,CAACrW,EAAI,SAAS,EAAGsW,EAAA,CAClB,EAED1Z,EAAI,KAAK,gCAAgC,CAC3C,CCtsBA,IAAImb,GAAwD,KAmB5D,MAAMC,OAAuB,IAE7B,SAASC,GAAsB7P,EAAgB8P,EAAS,GAAU,CAChE,MAAMC,EAAOH,GAAiB,IAAI5P,CAAM,EACnC+P,IACLA,EAAK,OAAS,GACVA,EAAK,SACP,aAAaA,EAAK,MAAM,EACxBA,EAAK,OAAS,MAEhBH,GAAiB,OAAO5P,CAAM,EAC1B8P,GAAQtb,EAAI,MAAM,0BAA0BwL,EAAO,MAAM,EAAE,CAAC,KAAK8P,CAAM,EAAE,EAC/E,CAEA,SAASE,GACP9S,EACAY,EAOM,CACN,GAAI,CAACZ,GAAQ,CAACA,EAAK,KAAM,OACzB,MAAM8C,EAAS9C,EAAK,KAEpB2S,GAAsB7P,EAAQ,SAAS,EAEvC,MAAM9I,EAAMH,GAAkB+G,EAAK,SAAS,EAC5C,GAAI,CAAC5G,EAAK,CACR1C,EAAI,KAAK,uDAAuDwL,EAAO,MAAM,EAAE,CAAC,EAAE,EAClF,MACF,CAEA,MAAM+P,EAAwB,CAC5B,OAAA/P,EACA,KAAA9C,EACA,SAAUY,EAAK,SACf,UAAW5G,EACX,UAAW,GACX,UAAW,KAAK,IAAI,EAAuB,CAAM,EACjD,SAAU,KAAK,IAAI,GAAI4G,EAAK,mBAAqB,GAAK,CAAC,EACvD,SAAU,GACV,cAAe,KACf,aAAc,KAAK,MACnB,OAAQ,GACR,OAAQ,MAGV8R,GAAiB,IAAI5P,EAAQ+P,CAAI,EACjCE,GAAwBF,EAAM,CAAC,CACjC,CAEA,SAASE,GAAwBF,EAAuBlS,EAAuB,CACzE,CAACkS,GAAQ,CAACA,EAAK,SACfA,EAAK,QAAQ,aAAaA,EAAK,MAAM,EACzCA,EAAK,OAAS,WAAW,IAAMG,GAAmBH,CAAI,EAAG,KAAK,IAAI,EAAGlS,EAAU,CAAC,CAAC,EACnF,CAEA,SAASqS,GAAmBH,EAA6B,CACvD,GAAI,CAACA,GAAQ,CAACA,EAAK,OAAQ,OAE3B,MAAM7S,EAAO6S,EAAK,KAClB,GAAI,CAAC7S,GAAQ,CAACA,EAAK,KAAM,CACvB2S,GAAsBE,EAAK,OAAQ,aAAa,EAChD,MACF,CAGA,MAAM/C,EAAW9U,EAAiB,yBAAyB,EAC3D,GAAI6X,EAAK,WAAaA,EAAK,UAAY/C,EAAU,CAC/C6C,GAAsBE,EAAK,OAAQ,kBAAkB,EACrD,MACF,CAEA,GAAI,CAACA,EAAK,UAAYA,EAAK,WAAaA,EAAK,SAAU,CACrDF,GAAsBE,EAAK,OAAQ,UAAU,EAC7C,MACF,CAGA,GAAIA,EAAK,SAAU,CACjB,MAAMI,EAAU,KAAK,MAAQJ,EAAK,aAC9BI,EAAU,KAAQJ,EAAK,gBAAkB,OAC3Cvb,EAAI,KAAK,wBAAwB2b,CAAO,iBAAiBJ,EAAK,aAAa,WAAWA,EAAK,OAAO,MAAM,EAAE,CAAC,EAAE,EAC7GA,EAAK,SAAW,GAChBA,EAAK,UAAYA,EAAK,cACtBA,EAAK,cAAgB,MAEvBE,GAAwBF,EAAMtY,GAAM,YAAY,EAChD,MACF,CAGA,MAAM2Y,EAASlT,EAAK,YAAcA,EAAK,YAAY,eAAiB,EAGpE,IAFqBA,EAAK,YAAcA,EAAK,YAAY,OAAS,GAE/C,KAAOkT,EAAS,IAAM,KAAM,CAC7CH,GAAwBF,EAAMtY,GAAM,YAAY,EAChD,MACF,CAEA,MAAMwO,EAAM8J,EAAK,UACjBA,EAAK,YACLA,EAAK,SAAW,GAChBA,EAAK,cAAgB9J,EACrB8J,EAAK,aAAe,KAAK,MAEzBpR,EAAkB,CAChB,QAAS,YACT,SAAUoR,EAAK,SACf,MAAO9J,EACP,UAAW8J,EAAK,UAChB,UAAWA,EAAK,UAChB,UAAW,GAAGA,EAAK,MAAM,WAC1B,CACH,CAEA,SAASM,GAA0BrQ,EAAgB2O,EAAmB2B,EAA0B,CAC9F,MAAMP,EAAOH,GAAiB,IAAI5P,CAAM,EACxC,GAAI,GAAC+P,GAAQ,CAACA,EAAK,SAGfO,IAAe,UAGnB,IAAI3B,GAAaoB,EAAK,WAAapB,IAAcoB,EAAK,UAAW,CAC/DF,GAAsB7P,EAAQ,kBAAkB,EAChD,MACF,CAEA+P,EAAK,SAAW,GAChBA,EAAK,cAAgB,KACrBA,EAAK,aAAe,KAAK,MACzBE,GAAwBF,EAAM,CAAC,EACjC,CAQO,SAASQ,GAAeC,EAAwB,CACrD,MAAMhT,EAAOmC,GAAA,EACb,GAAI,CAACnC,EAAM,OAGX,MAAM2Q,EAAmBjW,EAAgC,wBAAwB,EAC7EiW,IACF3Z,EAAI,MAAM,8DAA8D,EACxE2Z,EAAiB,QACjB7V,EAAS,yBAA0B,IAAI,GAIrCqX,KAAmB,aAAaA,EAAe,EAAGA,GAAkB,MAExE,MAAM3M,EAAO9K,EAAwB,cAAc,EAC7CgF,EAAOM,EAAK,QAAQgT,EAAU,CAClC,SAAU,CAAE,KAAM5Y,EAAI,WAAY,MAAOoL,CAAA,CAAK,CAC/C,EAGD2M,GAAkB,WAAW,IAAM,CACjC,GAAI,CAACzS,EAAK,KAAM,CACd1I,EAAI,KAAK,yBAAyB,EAClCU,EAAI,KAAK,gBAAiB,eAAe,EACzCgI,EAAK,QACL5E,EAAS,yBAA0B,IAAI,EAGvC,MAAM8E,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAYA,EAAS,KAAM,CAC7B,MAAMsP,EAAOxU,EAAkC,eAAe,EACxD6T,EAAgB7T,EAAiB,wBAAwB,EACzDmW,EAAoBnW,EAAiB,4BAA4B,EAEvEkF,EAAS,KAAK,CACZ,KAAMxF,EAAI,sBACV,UAAWmU,GAAiB,EAC5B,SAAUW,GAAM,MAAQ,GACxB,MAAO2B,CAAA,CACR,CACH,CACF,CACF,EAvBqB,GAuBN,EAEfnR,EAAK,GAAG,OAAQ,IAAM,CAChByS,KAAmB,aAAaA,EAAe,EAAGA,GAAkB,MACxErX,EAAS,yBAA0B4E,CAAI,EACvC1I,EAAI,KAAK,qCAAqC,EAC9CU,EAAI,KAAK,gBAAiB,WAAW,EAErCgI,EAAK,GAAG,OAASZ,GAAkB,CACjCpH,EAAI,KAAK,eAAgBoH,EAAMY,CAAI,CACrC,CAAC,EAGDA,EAAK,KAAK,CAAE,KAAMtF,EAAI,qBAAsB,CAC9C,CAAC,EAEDsF,EAAK,GAAG,QAAUoC,GAAiB,CACjC9K,EAAI,KAAK,4BAA6B8K,CAAG,EACrCqQ,KAAmB,aAAaA,EAAe,EAAGA,GAAkB,KAC1E,CAAC,EAEDzS,EAAK,GAAG,QAAS,IAAM,CACrB5E,EAAS,yBAA0B,IAAI,EACvCpD,EAAI,KAAK,gBAAiB,aAAa,EAEvC,MAAMwX,EAAOxU,EAAkC,eAAe,EACxD6T,EAAgB7T,EAAiB,wBAAwB,EACzDsT,EAASkB,GAAM,OAAoB,EAEzC,GAAIX,EAAgBP,EAAO,CACzB,MAAMpO,EAAWlF,EAAgC,kBAAkB,EAC/DkF,GAAYA,EAAS,MACvBlI,EAAI,KAAK,0BAA0B,CAEvC,CACF,CAAC,CACH,CAOO,SAASub,GAAsBvT,EAA4B,CAChEA,EAAK,GAAG,OAAQ,IAAM,CACpB1I,EAAI,MAAM,8CAA+C0I,EAAK,IAAI,EAElE,MAAMG,EAAsBnF,EAA2B,2BAA2B,EAC7EmF,EAAoB,KAAKC,GAAKA,EAAE,OAASJ,EAAK,IAAI,IACrDG,EAAoB,KAAKH,CAAI,EAC7B5E,EAAS,4BAA6B+E,CAAmB,EAE7D,CAAC,EAEDH,EAAK,GAAG,OAASZ,GAAkB,CACjC,MAAME,EAAMF,EAERE,EAAI,OAAS5E,EAAI,qBACnB1C,EAAI,KAAK,2BAA4BgI,EAAMV,CAAG,EACrCA,EAAI,OAAS5E,EAAI,uBAC1B1C,EAAI,KAAK,uBAAwBgI,EAAMV,CAAG,CAE9C,CAAC,EAEDU,EAAK,GAAG,QAAS,IAAM,CACrB2S,GAAsB3S,EAAK,KAAM,yBAAyB,EAC1D,MAAMG,EAAsBnF,EAA2B,2BAA2B,EAClFI,EACE,4BACA+E,EAAoB,OAAOC,GAAKA,EAAE,OAASJ,EAAK,IAAI,EAExD,CAAC,CACH,CAkEA,SAASwT,GAAuBpU,EAAqC,CACnE,MAAMkU,EAAWlU,EAAK,SAChB0G,EAAO9K,EAAwB,cAAc,EAEnD,GAAIsY,GAAYA,IAAaxN,EAC3BuN,GAAeC,CAAQ,UACdA,IAAaxN,EACtBxO,EAAI,KAAK,oDAAoD,UACpDgc,IAAa,KAAM,CAE5Bhc,EAAI,MAAM,qCAAqC,EAC/C,MAAM2Z,EAAmBjW,EAAgC,wBAAwB,EAC7EiW,IACFA,EAAiB,QACjB7V,EAAS,yBAA0B,IAAI,GAEzCpD,EAAI,KAAK,0BAA0B,CACrC,CACF,CAIO,SAASyb,IAAkB,CAChC5T,EAAiB,CACf,CAACnF,EAAI,kBAAkB,EAAG8Y,EAAA,CAC3B,EAGDxb,EAAI,GAAG,6BAA8B,IAAIT,IAAoB,CAC3D,MAAMyI,EAAOzI,EAAK,CAAC,EACfyI,MAA4BA,CAAI,CACtC,IAGAhI,EAAI,GAAG,4BAA6B,IAAIT,IAAoB,CAC1D,MAAMyI,EAAOzI,EAAK,CAAC,EACb+H,EAAM/H,EAAK,CAAC,EAClB,GAAI,CAACyI,GAAQ,CAACA,EAAK,KAAM,OAEzB,MAAM0T,EAAUpU,EAAI,KAAO,OAAOA,EAAI,IAAI,EAAI,GACxCqU,EAAWrU,EAAI,QAAU,OAAY,OAAOA,EAAI,KAAK,EAAI,OAEzDsU,EAAkB5Y,EAAsB,uBAAuB,EAC/DmU,EAAenU,EAAsB,sBAAsB,EAC3DwU,EAAOxU,EAAkC,eAAe,EACxD6Y,EAAW7Y,EAAyC,cAAc,EAClEmW,EAAoBnW,EAAiB,4BAA4B,EAGjE8Y,EAAiBF,IAAoB,CAACF,GAAYlE,GAAQA,EAAK,OAASkE,GAExEK,EAAiB5E,IACpBwE,IAAa,QAAaE,GAAU,QAAUF,GAC9CD,GAAWG,GAAU,OAASH,GAC9B,CAACA,GAAYG,GAAU,QAAqB1C,GAG/C,GAAI2C,EAAgB,CAClBxc,EAAI,MAAM,mCAAmC0I,EAAK,IAAI,KAAKwP,GAAM,IAAI,EAAE,EACvE,MAAM+B,EAAOjP,GAAgBsR,EAAkBpE,GAAM,MAAmB,OAAO,EAC3E+B,GAAMY,GAAYnS,EAAMuR,EAAM,CAAC,EAAE,MAAM1Z,GAAKP,EAAI,MAAM,kCAAmCO,CAAC,CAAC,CACjG,SAAWkc,EAAgB,CACzBzc,EAAI,MAAM,qCAAqC0I,EAAK,IAAI,KAAK6T,GAAU,IAAI,EAAE,EAC7E,MAAMtC,EAAOjP,GAAgB6M,EAAe0E,GAAU,MAAmB,OAAO,EAC5EtC,GAAMY,GAAYnS,EAAMuR,EAAM,CAAC,EAAE,MAAM1Z,GAAKP,EAAI,MAAM,kCAAmCO,CAAC,CAAC,CACjG,SAAW2X,GAAM,KAAM,CAErB,MAAMX,EAAgB7T,EAAiB,wBAAwB,EACzDgZ,EAAYxE,EAAK,MAAmBkE,EAC1Cpc,EAAI,MAAM,wCAAwC0c,CAAQ,KAAKnF,CAAa,IAAIW,EAAK,OAAS,GAAG,GAAG,EAEpGxP,EAAK,KAAK,CACR,GAAGwP,EACH,KAAM9U,EAAI,WACV,KAAMsZ,EACN,UAAWxE,EAAK,WAAaxU,EAAiB,yBAAyB,EACxE,EAGG6T,EAAgB,GAClBiE,GAAuB9S,EAAM,CAC3B,SAAUgU,EACV,UAAWxE,EAAK,WAAuBxU,EAAiB,yBAAyB,EAEjF,kBAAmB6T,CAErB,CAAC,CAEL,MACEvX,EAAI,MAAM,mCAAoCoc,GAAW,SAAS,EAClE1T,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,QAAS,6BAA8B,CAE5E,IAGA1C,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtD,MAAMyI,EAAOzI,EAAK,CAAC,EACb+H,EAAM/H,EAAK,CAAC,EAClB,GAAI,CAACyI,GAAQ,CAACA,EAAK,KAAM,OAEzB,MAAMsS,EAAYhT,EAAI,UAAYA,EAAI,MAAmB,GACnD2U,EAAY,OAAO3U,EAAI,SAAS,GAAK,EACrCmS,EAAYnS,EAAI,WAAuBtE,EAAiB,yBAAyB,EAEvF1D,EAAI,MAAM,yBAAyB0I,EAAK,IAAI,oBAAoBiU,CAAS,OAAO3B,CAAQ,EAAE,EAE1F7Q,EAAkB,CAChB,QAAS,YACT,SAAU6Q,EACV,MAAO2B,EACP,UAAW,GACX,UAAAxC,EACA,UAAW,GAAGzR,EAAK,IAAI,YACxB,CACH,IAGAhI,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD,MAAM6H,EAAO7H,EAAK,CAAC,EACnB,GAAI,CAAC6H,EAAM,OAEX,MAAMqR,EAAQrR,EAAK,MACb8U,EAAQ9U,EAAK,MACb0C,EAAW1C,EAAK,SAChB+U,EAAY/U,EAAK,WAAuB,GACxCqS,EAAYrS,EAAK,UAGjBgV,EAASD,EAAU,YAAY,GAAG,EAClCrR,EAASsR,EAAS,EAAID,EAAU,MAAM,EAAGC,CAAM,EAAID,EACnDE,EAAMD,EAAS,EAAID,EAAU,MAAMC,EAAS,CAAC,EAAI,GAEvD,GAAI,CAACtR,GAAU,CAAC2N,EAAO,OAGvB,MAAMX,EAAW9U,EAAiB,yBAAyB,EAC3D,GAAIyW,GAAaA,EAAY3B,EAAU,CACrCxY,EAAI,KAAK,kDAAkDma,CAAS,aAAa3B,CAAQ,GAAG,EAC5F,MACF,CAGA,MAAMwE,EADsBtZ,EAA2B,2BAA2B,EAChD,KAAKoF,GAAKA,EAAE,OAAS0C,CAAM,EAC7D,GAAIwR,GAASA,EAAM,KAAM,CACvB,MAAM9E,EAAOxU,EAAkC,eAAe,EAC9D,GAAI,CACFsZ,EAAM,KAAK,CACT,KAAM5Z,EAAI,WACV,MAAA+V,EACA,MAAAyD,EACA,UAAAzC,EACA,MAAOjC,GAAM,MACb,KAAOA,GAAM,MAAmB1N,CAAA,CACjC,CACH,OAASjK,EAAG,CACVP,EAAI,KAAK,yBAAyBwL,CAAM,WAAYjL,CAAC,CACvD,CACF,CAGAsb,GAA0BrQ,EAAQ2O,EAAW4C,CAAG,CAClD,IAEA/c,EAAI,KAAK,6BAA6B,CACxC,CC5fA,MAAMkO,OAA2B,IACjC,IAAI+O,GAAyB,EAC7B,MAAMC,GAA2B,IAO1B,SAASC,GAAgB9T,EAAU,IAAW,CACnDE,EAAkB,sBAAsB,EACxCJ,EAAgB,uBAAwB,IAAM,CAC5CiU,GAAA,CACF,EAAG/T,CAAO,CACZ,CAKA,eAAe+T,IAAkC,CAC/C,MAAMrD,EAAWrW,EAAyC,gBAAgB,EAC1E,GAAIqW,EAAS,QAAU,EAAG,OAE1B,MAAMF,EAAoBnW,EAAiB,4BAA4B,EACjE2Z,EAAa3Z,EAAiB,qBAAqB,EACnD4Z,EAAY5Z,EAAkB,oBAAoB,EAElD6Z,EAAiBlb,GAAA,EACvByB,EAAS,oBAAqByZ,CAAc,EAG5C,IAAIC,EAAU,GACd,GAAIH,IAAe,EACjBG,EAAU3D,UACDyD,GAAavD,EAAS,OAAS,EACxC,GACEyD,EAAU,KAAK,MAAM,KAAK,SAAWzD,EAAS,MAAM,QAC7CyD,IAAY3D,QACZyD,GAAavD,EAAS,SAAW,EAC1CyD,EAAU,GAEVA,EAAU3D,EAAoB,EAC1B2D,GAAWzD,EAAS,SAClBsD,IAAe,EAAGG,EAAU,EAC3BA,EAAU,KAMnB,GAFA1Z,EAAS,yBAA0B0Z,CAAO,EAEtCA,EAAU,GAAKA,GAAWzD,EAAS,OAAQ,CAC7CjW,EAAS,uBAAwB,EAAK,EACtCA,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7B,MACF,CAEA,MAAM2Z,EAAO1D,EAASyD,CAAO,EAC7B,GAAI,CAACC,EAAM,CACT3Z,EAAS,uBAAwB,EAAK,EACtC,MACF,CAGA,GAAI2Z,EAAK,OAAS,UAAW,CAC3B3Z,EAAS,uBAAwB,EAAK,EACtCA,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7B,MACF,CAEA,MAAMmW,EAAOwD,EAAK,KAClB,GAAI,CAACxD,EAAM,OAEXja,EAAI,MAAM,0BAA2Bia,EAAK,KAAM,WAAYsD,CAAc,EAC1EzZ,EAAS,uBAAwB,EAAI,EAErC,MAAMkT,EAAQ,KAAK,KAAKiD,EAAK,KAAOpX,EAAU,EAC9CiB,EAAS,uBAAwBmW,CAAI,EACrCnW,EAAS,eAAgB,CACvB,KAAMmW,EAAK,KACX,MAAOuD,EACP,KAAMvD,EAAK,KACX,MAAAjD,EACA,KAAMiD,EAAK,KACX,UAAWsD,CAAA,CACZ,EAGD,MAAMG,GAAmBzD,EAAMuD,EAASD,CAAc,EAElD7Z,EAAiB,mBAAmB,IAAM6Z,GAC5CzZ,EAAS,uBAAwB,EAAK,CAE1C,CAIA,eAAe4Z,GAAmBzD,EAAY2C,EAAezC,EAAkC,CAC7F,MAAME,EAAQxX,GACRmU,EAAQ,KAAK,KAAKiD,EAAK,KAAOI,CAAK,EACnCC,EAAS,CACb,KAAMlX,EAAI,cACV,KAAM6W,EAAK,KACX,KAAMA,EAAK,KACX,MAAAjD,EACA,KAAMiD,EAAK,KACX,MAAA2C,EACA,UAAAzC,CAAA,EAIIwD,EADiBja,EAAyC,wBAAwB,EACzD,OAAOoF,GACpCA,EAAE,SAAW,aAAgBA,EAAE,MAAyB,MAAQA,EAAE,eAAiB,IAGrF,GAAI6U,EAAQ,SAAW,EAAG,OAE1B,MAAMC,EAAuBD,EAAQ,OAAO7U,GAAK,CAC/C,MAAM+U,EAAmB/U,EAAE,iBAC3B,MAAO,CAAC+U,GAAoB,CAACA,EAAiB,IAAIjB,CAAK,CACzD,CAAC,EAGDe,EAAQ,QAAQ7U,GAAK,CACnB,MAAMJ,EAAOI,EAAE,KACTgV,EAAcF,EAAqB,SAAS9U,CAAC,EAC/CJ,EAAK,MACPA,EAAK,KAAK,CAAE,GAAG4R,EAAQ,QAAS,CAACwD,EAAa,CAElD,CAAC,EAGD,QAAS9Z,EAAI,EAAGA,EAAIgT,EAAOhT,IAAK,CAC9B,GAAIN,EAAiB,mBAAmB,IAAMyW,EAAW,OAGzD,IAAI4D,EAAY,GAChB,KAAOA,GAAW,CAChBA,EAAY,GACZ,UAAWjV,KAAK6U,EAAS,CACvB,MAAMjV,EAAOI,EAAE,KACf,GAAIJ,EAAK,MAAQA,EAAK,aAAeA,EAAK,YAAY,eAAiB,IAAM,KAAM,CACjFqV,EAAY,GACZ,KACF,CACF,CACIA,SAAiB,IAAI,WAAa,WAAWpD,EAAG1X,GAAM,YAAY,CAAC,CACzE,CAEA,MAAMuX,EAAQxW,EAAIqW,EACZI,EAAM,KAAK,IAAID,EAAQH,EAAOJ,EAAK,IAAI,EACvCS,EAAW,MAAMT,EAAK,MAAMO,EAAOC,CAAG,EAAE,cACxCtB,EAAQ,IAAI,WAAWuB,CAAQ,EAC/BpB,EAAW,CAAE,KAAMlW,EAAI,cAAe,MAAA+V,EAAO,MAAOnV,EAAG,UAAAmW,CAAA,EAE7DyD,EAAqB,QAAQ9U,GAAK,CAChC,MAAMJ,EAAOI,EAAE,KACXJ,EAAK,MAAMA,EAAK,KAAK4Q,CAAQ,CACnC,CAAC,CACH,CAEA,GAAI5V,EAAiB,mBAAmB,IAAMyW,EAAW,CACvD,MAAMS,EAAS,CAAE,KAAMxX,EAAI,YAAa,KAAM6W,EAAK,KAAM,MAAA2C,EAAO,UAAAzC,CAAA,EAChEwD,EAAQ,QAAQ7U,GAAK,CACnB,MAAMJ,EAAOI,EAAE,KACXJ,EAAK,MAAMA,EAAK,KAAKkS,CAAM,CACjC,CAAC,EACD5a,EAAI,MAAM,gCAAiC4c,CAAK,CAClD,CACF,CAKA,eAAsBoB,GACpBtV,EACAuR,EACA2C,EACAzC,EACe,CACf,GAAI,CAACzR,GAAQ,CAACA,EAAK,MAAQ,CAACuR,EAAM,OAClC,MAAMI,EAAQxX,GACRmU,EAAQ,KAAK,KAAKiD,EAAK,KAAOI,CAAK,EACnCW,EAAW,SAAUf,EAAOA,EAAK,KAAO,QAE9CvR,EAAK,KAAK,CACR,KAAMtF,EAAI,cACV,KAAM4X,EACN,KAAMf,EAAK,KACX,MAAAjD,EACA,KAAMiD,EAAK,KACX,MAAA2C,EACA,UAAAzC,EACA,QAAS,GACV,EAED,QAASnW,EAAI,EAAGA,EAAIgT,EAAOhT,IAAK,CAC9B,GAAI,CAAC0E,EAAK,KAAM,OAChB,KAAOA,EAAK,MAAQA,EAAK,aAAeA,EAAK,YAAY,eAAiB,IAAM,MAC9E,MAAM,IAAI,QAAQiS,GAAK,WAAWA,EAAG1X,GAAM,YAAY,CAAC,EAE1D,GAAI,CAACyF,EAAK,KAAM,OAChB,MAAM8R,EAAQxW,EAAIqW,EACZK,EAAW,MAAMT,EAAK,MAAMO,EAAO,KAAK,IAAIA,EAAQH,EAAOJ,EAAK,IAAI,CAAC,EAAE,cAC7EvR,EAAK,KAAK,CAAE,KAAMtF,EAAI,cAAe,MAAO,IAAI,WAAWsX,CAAQ,EAAG,MAAO1W,EAAG,UAAAmW,EAAW,CAC7F,CAEIzR,EAAK,MACPA,EAAK,KAAK,CAAE,KAAMtF,EAAI,YAAa,KAAM4X,EAAU,MAAA4B,EAAO,UAAAzC,EAAW,CAEzE,CAIA,SAAS8D,GAAmBnW,EAAqC,CAC/D,MAAMpF,EAAMoF,EAAK,UACjB,GAAI,CAACpF,EAAK,CACR1C,EAAI,KAAK,sDAAsD,EAC/D,MACF,CAMA,GAJAuJ,EAAkB,iBAAiB,EACnC0T,GAAyBva,EAGrBoF,EAAK,QAAS,CAChB9H,EAAI,MAAM,8BAA8B0C,CAAG,EAAE,EACxBgB,EAA2C,sBAAsB,EACzE,IAAIhB,EAAK,CACpB,QAAS,GACT,SAAU,EACV,MAAQoF,EAAK,OAAoB,EACjC,KAAOA,EAAK,MAAmB,GAC/B,MAAQA,EAAK,OAAoB,EACjC,KAAOA,EAAK,MAAmB,EAC/B,KAAOA,EAAK,MAAmB,GAC/B,kBAAmB,EACnB,UAAW,GACZ,EACD,GAAI,CAAEoG,GAAqB,OAAOxL,CAAG,CAAG,MAAQ,CAAe,CAC/D,MACF,CAGAoB,EAAS,6BAA8B,EAAK,EAE5C9D,EAAI,MAAM,oBAAoB8H,EAAK,IAAI,YAAYA,EAAK,KAAK,YAAYA,EAAK,KAAK,GAAG,EAGjEpE,EAA2C,sBAAsB,EACzE,IAAIhB,EAAK,CACpB,QAAS,GACT,SAAU,EACV,MAAQoF,EAAK,OAAoB,EACjC,KAAOA,EAAK,MAAmB,GAC/B,MAAQA,EAAK,OAAoB,EACjC,KAAOA,EAAK,MAAmB,EAC/B,KAAOA,EAAK,MAAmB,GAC/B,kBAAmB,EACnB,UAAW,GACZ,EAEDhE,EAAS,eAAgB,CACvB,KAAMgE,EAAK,KACX,MAAOA,EAAK,MACZ,KAAMA,EAAK,KACX,MAAOA,EAAK,MACZ,KAAMA,EAAK,KACX,UAAWpF,CAAA,CACZ,EACDoB,EAAS,gBAAiB,CAAC,EAI3BqG,EAAkB,CAAE,QAAS,aAAc,UAAW,GAAM,EAE5DA,EAAkB,CAChB,QAAS,aACT,SAAUrC,EAAK,KACf,UAAW,GACX,UAAWvF,GAAkBG,CAAG,EAChC,KAAMG,EAAA,CACP,EAGD,GAAI,CAAEqb,GAA0Bxb,CAAG,CAAG,MAAQ,CAAoB,CAG1CgB,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,EAG1DyB,EAAkB,iBAAiB,EACnCJ,EAAgB,kBAAmB,IAAM,CAMvC,GALAnJ,EAAI,KAAK,4DAA4D,EACrEU,EAAI,KAAK,iBAAkB,EAAK,EAChCoD,EAAS,6BAA8B,EAAK,EAEtBJ,EAAiB,gBAAgB,IACjCd,EAAe,UAAW,CAC9C,MAAMsV,EAAOxU,EAAkC,eAAe,EACxD6T,EAAgB7T,EAAiB,wBAAwB,EACzDsT,EAASkB,GAAM,OAAoB,EACzC,GAAIlB,EAAQ,EAAG,CACb,MAAMmH,EAAM,KAAK,MAAO5G,EAAgBP,EAAS,GAAG,EACpDtW,EAAI,KAAK,mBAAoByd,CAAG,CAClC,CACF,CACF,EAAG,GAAK,CACV,CAEA,SAASD,GAA0B/D,EAAyB,CAE1D,MAAMiE,EADe1a,EAA2C,sBAAsB,EACzD,IAAIyW,CAAS,EAC1C,GAAI,CAACiE,GAAWA,EAAQ,QAAS,OAEjC,MAAMrF,EAAgB7K,GAAqB,IAAIiM,CAAS,EACxD,GAAI,CAACpB,EAAe,OAEpB,IAAIsF,EAAeD,EAAQ,mBAAqB,EAEhD,KAAOrF,EAAc,IAAIsF,CAAY,GAAG,CACtC,MAAMlF,EAAQJ,EAAc,IAAIsF,CAAY,EAGtCC,EAAa,IAAI,WAAWnF,CAAK,EACjC6B,EAAWoD,EAAQ,KAGzB,GAAI,CAACpD,EAAU,MAGf,MAAM5B,EAAkB1V,EAA2B,2BAA2B,EAC9E,GAAI0V,EAAgB,OAAS,EAAG,CAC9B,MAAMC,EAAY,IAAI,WAAWF,CAAK,EAChCoF,EAAW,CAAE,KAAMnb,EAAI,cAAe,MAAOiW,EAAW,MAAOgF,EAAc,UAAAlE,CAAA,EACnFf,EAAgB,QAAQtQ,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKyV,CAAQ,CAAG,CAAC,CAChE,CAEApU,EAAkB,CAChB,QAAS,aACT,MAAOmU,EAAW,OAClB,MAAOD,EACP,UAAW,GACX,SAAUrD,EACV,UAAWzY,GAAkB4X,CAAS,EACvC,EAEDpB,EAAc,OAAOsF,CAAY,EACjCA,GACF,CAEAD,EAAQ,kBAAoBC,EAC5BD,EAAQ,SAAWC,EACnBva,EAAS,gBAAiBsa,EAAQ,QAAQ,EAG1C,MAAMxG,EAAclU,EAAyC,cAAc,EACvEkU,GAAgBA,EAAY,MAAmB,IACjDrO,EAAkB,iBAAiB,EACnCJ,EAAgB,kBAAmB,IAAM,CACvC,MAAMiP,EAAgB1U,EAAiB,gBAAgB,GACnD0U,IAAkBxV,EAAe,OAASwV,IAAkBxV,EAAe,OAC7ElC,EAAI,KAAK,iBAAkB,EAAK,CAEpC,EAAG,IAAK,GAIV,MAAM8d,EAAgBJ,EAAQ,OAAS,EACjCK,EAAWL,EAAQ,MAAQ,EAC7BI,EAAgB,GAAKJ,EAAQ,UAAYI,IACtCJ,EAAQ,YACXpe,EAAI,MAAM,kCAAkCoe,EAAQ,QAAQ,IAAII,CAAa,kBAAkB,EAC/FJ,EAAQ,UAAY,GACpBjU,EAAkB,CAChB,QAAS,WACT,SAAUiU,EAAQ,KAClB,UAAW,GACX,UAAAjE,EACA,UAAWsE,CAAA,CACZ,EACDvQ,GAAqB,OAAOiM,CAAS,GAG3C,CAEA,SAASuE,GAAmB5W,EAAqC,CAE/D,IAAIpF,EAAMoF,EAAK,UAIf,GAHI,CAACpF,GAAOua,KAA2B,IACrCva,EAAMua,IAEJ,CAACva,EAAK,OAGV,MAAM0b,EADe1a,EAA2C,sBAAsB,EACzD,IAAIhB,CAAG,EAGpC,GAAI0b,GAAS,SAAWA,GAAS,UAAW,OAGvClQ,GAAqB,IAAIxL,CAAG,GAC/BwL,GAAqB,IAAIxL,EAAK,IAAI,GAAK,EAEzC,MAAMqW,EAAgB7K,GAAqB,IAAIxL,CAAG,EAOlD,GAJAqW,EAAc,IAAIjR,EAAK,MAAiB,IAAI,WAAWA,EAAK,KAAmB,CAAC,EAI5E,CAACsW,EAAS,CACRrF,EAAc,KAAOmE,KACvBld,EAAI,KAAK,+DAA+D0C,CAAG,cAAc,EACzFwL,GAAqB,OAAOxL,CAAG,GAEjC,MACF,CAGAwb,GAA0Bxb,CAAG,CAC/B,CAEA,SAASic,GAAiB7W,EAAqC,CAC7D,MAAMpF,EAAMoF,EAAK,UACjB,GAAI,CAACpF,EAAK,OAGV,MAAM0b,EADe1a,EAA2C,sBAAsB,EACzD,IAAIhB,CAAG,EACpC,GAAI,CAAC0b,GAAWA,EAAQ,QAAS,OAG5BA,EAAQ,YACXA,EAAQ,UAAY,GAGpBjU,EAAkB,CAChB,QAAS,WACT,SAAUiU,EAAQ,KAClB,UAAW,GACX,UAAW7b,GAAkBG,CAAG,EAChC,UAAW0b,EAAQ,KACpB,GAIHlQ,GAAqB,OAAOxL,CAAG,EAE/B1C,EAAI,MAAM,kBAAkBoe,EAAQ,IAAI,KAAKA,EAAQ,QAAQ,IAAIA,EAAQ,KAAK,UAAU,EAGxF,MAAMxV,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAYA,EAAS,MAAQd,EAAK,QAAU,OAAW,CACzD,MAAM8W,EAAUlb,EAAsB,iBAAiB,EAClDkb,EAAQ,IAAI9W,EAAK,KAAe,IACnC8W,EAAQ,IAAI9W,EAAK,KAAe,EAChCc,EAAS,KAAK,CAAE,KAAMxF,EAAI,YAAa,MAAO0E,EAAK,MAAO,EAE9D,CAGwBpE,EAA2B,2BAA2B,EAC9D,QAAQoF,GAAK,CAAMA,EAAE,MAAMA,EAAE,KAAKhB,CAAI,CAAG,CAAC,EAE1DpH,EAAI,KAAK,wBAAyBoH,EAAK,KAAe,CACxD,CAEA,SAAS+W,GAAiB/W,EAA+BY,EAA4B,CAEnF,GADiBhF,EAAgC,kBAAkB,EACrD,OAGd,MAAMoF,EADiBpF,EAAyC,wBAAwB,EAC/D,QAAUkL,EAAE,KAAOlG,EAAK,IAAI,EACrD,GAAII,GAAKhB,EAAK,QAAU,OAAW,CACjC,MAAM+V,EAAmB/U,EAAE,iBACvB+U,IACFA,EAAiB,IAAI,OAAO/V,EAAK,KAAK,CAAC,EACvC9H,EAAI,MAAM,uBAAuB8H,EAAK,KAAK,uBAAuBgB,EAAE,KAAK,EAAE,EAE/E,CACF,CAEA,SAASgW,GAAoBhX,EAAqC,CAChE,MAAM8U,EAAQ9U,EAAK,MACnB9H,EAAI,MAAM,gDAAiD4c,CAAK,EAE5D9U,EAAK,QAAU,QACjBhE,EAAS,6BAA8B8Y,CAAK,EAG9Clc,EAAI,KAAK,yBAA0Bkc,EAAO9U,EAAK,KAAgBA,CAAI,CACrE,CAIO,SAASiX,IAAoB,CAClCxW,EAAiB,CACf,CAACnF,EAAI,aAAa,EAAG6a,GACrB,CAAC7a,EAAI,aAAa,EAAGsb,GACrB,CAACtb,EAAI,WAAW,EAAGub,GACnB,CAACvb,EAAI,WAAW,EAAGyb,GACnB,CAACzb,EAAI,cAAc,EAAG0b,EAAA,CACvB,EAGDpe,EAAI,GAAG,8BAA+B,SAAUT,IAAoB,CAClE,MAAMuK,EAAWvK,EAAK,CAAC,EACjBka,EAAYla,EAAK,CAAC,EAExBD,EAAI,MAAM,iCAAiCwK,CAAQ,UAAU2P,CAAS,GAAG,EAEzE,MAAMF,EAAO,MAAMrP,GAAiBJ,EAAU,EAAI,EAClD,GAAI,CAACyP,EAAM,CACTja,EAAI,MAAM,mDAAoDwK,CAAQ,EACtE,MACF,CAGA1G,EAAS,uBAAwBmW,CAAI,EAGrC,MAAMmE,EADe1a,EAA2C,sBAAsB,EACzD,IAAIyW,CAAS,EACpCvC,EAAclU,EAAyC,cAAc,EAE3EI,EAAS,eAAgBsa,GAAWxG,CAAW,EAE/C,MAAMoH,EAAkBZ,GAAS,OAAUxG,GAAa,OAAqB,GAC7E9T,EAAS,yBAA0Bkb,CAAc,EAGjD,MAAMC,EAAoBvb,EAAkB,4BAA4B,EAClEyU,EAAmBzU,EAA6B,2BAA2B,EAC7Eub,GAAqB9G,IAAqB6G,IAC5Chf,EAAI,MAAM,0DAA0D,EACpE8D,EAAS,6BAA8B,EAAK,EAC5CpD,EAAI,KAAK,iBAAkB,EAAK,EAChCA,EAAI,KAAK,yBAA0Bse,EAAgBxU,EAAU,EAAE,EAEnE,IAGA9J,EAAI,GAAG,yBAA0B,IAAIT,IAAoB,CACvD,MAAM2c,EAAQ3c,EAAK,CAAC,EACpBD,EAAI,MAAM,sCAAsC4c,CAAK,EAAE,CAGzD,IAEA5c,EAAI,KAAK,+BAA+B,CAC1C,CCliBO,SAASkf,GAAoBC,EAA4B,KAAY,CAE1E,GADgBzb,EAAkB,kBAAkB,EACvC,CACX1D,EAAI,MAAM,8CAA8C,EACxD,MACF,CAEA,MAAMmW,EAAazS,EAAiB,qBAAqB,EACzD,GAAIyS,GAAcpT,GAAsB,CACtC/C,EAAI,MAAM,2BAA2B+C,EAAoB,wBAAwB,EACjFwG,EAAkB,eAAe,EACjCzF,EAAS,iBAAkBlB,EAAe,IAAI,EAC9CkB,EAAS,mBAAoB,EAAK,EAClCA,EAAS,sBAAuB,CAAC,EACjCpD,EAAI,KAAK,iBAAkB,EAAK,EAChC,MACF,CAGA,MAAMiZ,EAAmBjW,EAAgC,wBAAwB,EAC3EkF,EAAWlF,EAAgC,kBAAkB,EAC7D0b,EAAczF,GAAoBA,EAAiB,KAAQA,EAAmB/Q,EAEpF,GAAI,CAACwW,GAAc,CAACA,EAAW,KAAM,CACnCpf,EAAI,KAAK,+CAA+C,EACxD,MACF,CAEA,MAAMkY,EAAOxU,EAAkC,eAAe,EACxDkW,EAAkBlW,EAAiB,0BAA0B,EAC7DyU,EAAmBzU,EAA6B,2BAA2B,EAC3EmW,EAAoBnW,EAAiB,4BAA4B,EACjE6T,EAAgB7T,EAAiB,wBAAwB,EACzD8U,EAAW9U,EAAiB,yBAAyB,EACrD2b,EAAqB3b,EAAiB,2BAA2B,EAEjEsX,EAAY9C,GAAM,MAAmB0B,GAAmB,GACxDgD,EAAQzE,IAAqB,OAAYA,EAAmB0B,EAC5DyF,EAAa9G,GAAY6G,EAE/B,IAAIE,EAAaJ,EACbI,IAAe,OACjBA,EAAahI,GAAiB,GAIhC,MAAMiI,EAAYxc,GAAiB,KAAK,IAAImT,EAAYnT,GAAiB,OAAS,CAAC,CAAC,EACpFc,EAAS,sBAAuBqS,EAAa,CAAC,EAC9CrS,EAAS,mBAAoB,EAAI,EAEjC,MAAM2b,EAAcL,IAAezF,EAAmB,QAAU,OAChE3Z,EAAI,MAAM,sBAAsBmW,EAAa,CAAC,IAAIpT,EAAoB,SAAS0c,CAAW,KAAKzE,CAAQ,YAAYuE,CAAU,cAAcC,CAAS,KAAK,EAEzJ,WAAW,IAAM,CAIf,GAHA1b,EAAS,mBAAoB,EAAK,EAG9B,CAACsb,EAAW,KAAM,CACpBpf,EAAI,KAAK,6CAA6C,EACtD,MACF,CAIA,MAAM0f,EADahc,EAAkC,eAAe,GACpC,MAAmBA,EAAiB,0BAA0B,GAAK,GACnG,GAAIgc,GAAc1E,GAAY0E,IAAe1E,EAAU,CACrDhb,EAAI,MAAM,kEAAkE,EAC5E8D,EAAS,sBAAuB,CAAC,EACjC,MACF,CAEAsb,EAAW,KAAK,CACd,KAAMhc,EAAI,sBACV,UAAWmc,EACX,SAAAvE,EACA,MAAA4B,EACA,UAAW0C,CAAA,CACZ,CACH,EAAGE,CAAS,CACd,CAIA,eAAeG,GAAyB7X,EAA+BY,EAAqC,CAI1G,GAFiBhF,EAAgC,kBAAkB,GAE/D,CAACgF,GAAQ,CAACA,EAAK,KAAM,OAIzB,GADqBhF,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9C,GAAI,CAAE+F,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,QAAS,0BAA2B,CAAG,MAAQ,CAAa,CACnG,MACF,CAEA,MAAMgZ,EAAUtU,EAAK,KAAO,OAAOA,EAAK,IAAI,EAAI,GAC1CuU,EAAWvU,EAAK,QAAU,OAAY,OAAOA,EAAK,KAAK,EAAI,OAG3DmD,EAAO2U,GAAiBxD,EAASC,CAAQ,EAC/C,GAAI,CAACpR,EAAM,CACT,GAAI,CAAEvC,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,QAAS,6BAA8B,CAAG,MAAQ,CAAa,CACtG,MACF,CAEA,MAAMV,EAAMmd,GAAA,EACN3U,EAAe4U,GAAoB7U,EAAMmR,CAAO,EAChD2D,EAAa/U,GAAgBC,EAAMC,CAAY,EACjD6U,GAAY,MAAMlF,GAAYnS,EAAMqX,EAAY,EAAGrd,CAAG,CAC5D,CAEA,eAAesd,GAA0BlY,EAA+BY,EAAqC,CAI3G,GAFiBhF,EAAgC,kBAAkB,GAE/D,CAACgF,GAAQ,CAACA,EAAK,KAAM,OAGzB,IAAIuX,EAAa,EACjB,GAAInY,EAAK,YAAc,OAAW,CAChC,MAAMoY,EAAI,OAAOpY,EAAK,SAAS,EAC3B,OAAO,SAASoY,CAAC,GAAKA,EAAI,IAAGD,EAAa,KAAK,MAAMC,CAAC,EAC5D,CAEA,MAAM9D,EAAUtU,EAAK,UAAYA,EAAK,KAAO,OAAOA,EAAK,UAAYA,EAAK,IAAI,EAAI,GAC5EuU,EAAWvU,EAAK,QAAU,OAAY,OAAOA,EAAK,KAAK,EAAI,OAE3DmD,EAAO2U,GAAiBxD,EAASC,CAAQ,EAC/C,GAAI,CAACpR,EAAM,CACT,GAAI,CAAEvC,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,QAAS,2CAA4C,CAAG,MAAQ,CAAa,CACpH,MACF,CAGA,MAAM4T,EAAQ,KAAK,KAAK/L,EAAK,KAAOpI,EAAU,EAC9C,GAAI,CAAC,OAAO,SAASmU,CAAK,GAAKA,GAAS,EAAG,CACzC,GAAI,CAAEtO,EAAK,KAAK,CAAE,KAAMtF,EAAI,UAAW,QAAS,oBAAqB,CAAG,MAAQ,CAAa,CAC7F,MACF,CACI6c,GAAcjJ,IAAOiJ,EAAa,KAAK,IAAI,EAAGjJ,EAAQ,CAAC,GAE3D,MAAMtU,EAAMmd,GAAA,EACN3U,EAAe4U,GAAoB7U,EAAMmR,CAAO,EAChD2D,EAAa/U,GAAgBC,EAAMC,CAAY,EACjD6U,GAAY,MAAMlF,GAAYnS,EAAMqX,EAAYE,EAAYvd,CAAG,CACrE,CAIA,SAASkd,GAAiBxD,EAAiBC,EAA2C,CACpF,MAAMC,EAAkB5Y,EAAsB,uBAAuB,EAC/DwU,EAAOxU,EAAkC,eAAe,EACxDmU,EAAenU,EAAsB,sBAAsB,EAC3D6Y,EAAW7Y,EAAyC,cAAc,EAExE,IAAIuH,EAAoB,KAExB,GAAIqR,EAAiB,CACnB,MAAM6D,EAAe9D,IAAa,QAAanE,GAAQ,OAAOA,EAAK,KAAK,IAAMmE,EACxE+D,EAAchE,GAAWlE,GAAQA,EAAK,OAASkE,GAEjD+D,GAAgBC,GADL,CAAChE,GAAWC,IAAa,UACGpR,EAAOqR,EACpD,CAEA,GAAI,CAACrR,GAAQ4M,GAAgB0E,EAAU,CACrC,MAAM8D,EAAmBhE,IAAa,QAAa,OAAOE,EAAS,KAAK,IAAMF,EACxEiE,EAAkBlE,GAAWG,EAAS,OAASH,GACjDiE,GAAoBC,KAAiBrV,EAAO4M,EAClD,CAEA,OAAK5M,IAAMA,EAAOqR,GAAmBzE,GAC9B5M,CACT,CAEA,SAAS4U,IAA+B,CACtC,MAAM3H,EAAOxU,EAAkC,eAAe,EAC9D,IAAI0W,EAA2B1W,EAAiB,2BAA2B,EACvEhB,EAAOwV,GAAM,WAAwBkC,EACzC,OAAI,CAAC1X,GAAOA,EAAM,KAChBA,EAAML,GAAA,EACNyB,EAAS,4BAA6BpB,CAAG,GAEpCA,CACT,CAEA,SAASod,GAAoB7U,EAAYmR,EAAyB,CAChE,MAAME,EAAkB5Y,EAAsB,uBAAuB,EAC/DwU,EAAOxU,EAAkC,eAAe,EACxDmU,EAAenU,EAAsB,sBAAsB,EAC3D6Y,EAAW7Y,EAAyC,cAAc,EAExE,OAAIuH,IAASqR,GAAmBpE,GAAM,KAAaA,EAAK,KACpDjN,IAAS4M,GAAgB0E,GAAU,KAAaA,EAAS,KACtDH,GAAYlE,GAAM,MAAoBqE,GAAU,MAAmB,OAC5E,CAIO,SAASgE,IAAqB,CACnChY,EAAiB,CACf,CAACnF,EAAI,oBAAoB,EAAGuc,GAC5B,CAACvc,EAAI,qBAAqB,EAAG4c,EAAA,CAC9B,EAGDtf,EAAI,GAAG,2BAA4B,IAAM,CACvCwe,GAAA,CACF,CAAC,EAEDlf,EAAI,KAAK,gCAAgC,CAC3C,CC3NA,IAAIwgB,GAAyC,KAMtC,MAAMC,GAAiB,CAC5B,WAAY,KACZ,cAAe,KACf,wBAAyB,IACzB,2BAA4B,IAC5B,YAAa,EAEb,eAAeC,EAAsB,CACnC,GAAI,CACF,MAAO,CAAC,EAAEA,GAAOF,IAAiBA,GAAc,MAAQE,EAC1D,MAAQ,CACN,MAAO,EACT,CACF,EAEA,gBAAgBA,EAAmB,CACjC,MAAM,EAAI,KAAK,oBAAoB,IAAIA,CAAG,EAC1C,GAAI,EACF,GAAI,CAAE,aAAa,CAAC,CAAG,MAAQ,CAAQ,CAEzC,KAAK,oBAAoB,OAAOA,CAAG,CACrC,EAEA,WAAWA,EAAoBpF,EAAS,GAAU,CAChD,GAAKoF,EACL,MAAK,gBAAgBA,CAAG,EACxB,KAAK,uBAAuB,OAAOA,CAAG,EAEtC,GAAI,CACF,IAAI,gBAAgBA,CAAG,EACvB1gB,EAAI,MAAM,sBAAsB0gB,CAAG,GAAGpF,EAAS,KAAKA,CAAM,IAAM,EAAE,EAAE,CACtE,OAAS/a,EAAG,CACVP,EAAI,MAAM,0CAA2CO,CAAC,CACxD,CAEI,KAAK,aAAemgB,IAAK,KAAK,WAAa,MAC3C,KAAK,gBAAkBA,IAAK,KAAK,cAAgB,MACvD,EAKA,OAAOzV,EAA2B,CAChC,OAAKA,GAED,KAAK,eACP,KAAK,WAAW,KAAK,cAAe,qBAAqB,EAG3D,KAAK,cAAgB,IAAI,gBAAgBA,CAAI,EAC7CjL,EAAI,MAAM,uBAAuB,KAAK,aAAa,EAAE,EAC9C,KAAK,eARM,IASpB,EAKA,SAAgB,CACd,GAAI,CAAC,KAAK,cAAe,OAEzB,MAAM2gB,EAAU,KAAK,cACfC,EAAU,KAAK,WAErB,KAAK,WAAaD,EAClB,KAAK,cAAgB,KAEjBC,GAAWA,IAAYD,GACzB,KAAK,WAAWC,CAAO,EAGzB5gB,EAAI,MAAM,+BAA+B,KAAK,UAAU,EAAE,CAC5D,EAKA,WAAW0gB,EAAoBG,EAA+B,CAC5D,GAAI,CAACH,EAAK,OAEV,MAAMI,EAAQD,GAAS,QAAU,GAC3BxX,EAAW,OAAOwX,GAAS,SAAY,UAAYA,EAAQ,SAAW,EACxEA,EAAQ,QACR5d,GAAM,gBAEV,GAAI,KAAK,oBAAoB,IAAIyd,CAAG,EAAG,OAEvC,GAAI,CAACI,GAAS,KAAK,eAAeJ,CAAG,EAAG,CACtC,KAAK,uBAAuB,IAAIA,CAAG,EACnC1gB,EAAI,MAAM,mDAAmD0gB,CAAG,EAAE,EAClE,MACF,CAGA,GAAI,KAAK,oBAAoB,MAAQ,KAAK,YAAa,CACrD,MAAMK,EAAS,KAAK,oBAAoB,OAAO,OAAO,MAClD,KAAK,eAAeA,CAAM,GAC5B,KAAK,uBAAuB,IAAIA,CAAM,EACtC,KAAK,oBAAoB,OAAOA,CAAM,GAEtC,KAAK,WAAWA,EAAQ,gBAAgB,CAE5C,CAEA,GAAI1X,IAAY,EAAG,CACjB,KAAK,WAAWqX,EAAK,SAAS,EAC9B,MACF,CAEA,MAAMM,EAAI,WAAW,IAAM,CACzB,KAAK,WAAWN,EAAK,WAAW,CAClC,EAAGrX,CAAO,EACV,KAAK,oBAAoB,IAAIqX,EAAKM,CAAC,EACnChhB,EAAI,MAAM,uCAAuCqJ,CAAO,QAAQqX,CAAG,EAAE,CACvE,EAKA,cAAcpF,EAAS,GAAU,CAC/B,GAAI,CAAC,KAAK,uBAAuB,KAAM,OAEvC,MAAM2F,EAAO,MAAM,KAAK,KAAK,sBAAsB,EACnD,IAAIC,EAAU,EAEd,UAAWR,KAAOO,EACX,KAAK,eAAeP,CAAG,IAC1B,KAAK,uBAAuB,OAAOA,CAAG,EACtC,KAAK,WAAWA,EAAK,CAAE,MAAO,GAAM,EACpCQ,KAIAA,GAASlhB,EAAI,MAAM,+BAA+BkhB,CAAO,GAAG5F,EAAS,KAAKA,CAAM,IAAM,EAAE,EAAE,CAChG,EAKA,OAAOuF,EAA+B,CAChC,KAAK,eACP,KAAK,WAAW,KAAK,cAAe,CAAE,MAAO,GAAM,QAAS,EAAG,EAE7D,KAAK,YACP,KAAK,WAAW,KAAK,WAAYA,CAAO,CAE5C,EAKA,aAAavF,EAAS,QAAe,CACnC,UAAWoF,KAAO,MAAM,KAAK,KAAK,oBAAoB,MAAM,EAC1D,KAAK,WAAWA,EAAKpF,CAAM,EAE7B,UAAWoF,KAAO,MAAM,KAAK,KAAK,sBAAsB,EACtD,KAAK,WAAWA,EAAKpF,CAAM,EAEzB,KAAK,YAAY,KAAK,WAAW,KAAK,WAAYA,CAAM,EACxD,KAAK,eAAe,KAAK,WAAW,KAAK,cAAeA,CAAM,EAElE,KAAK,oBAAoB,QACzB,KAAK,uBAAuB,QAC5B,KAAK,WAAa,KAClB,KAAK,cAAgB,IACvB,EAGA,IAAI,WAA2B,CAC7B,OAAO,KAAK,UACd,CACF,ECjLA,IAAIkF,GAAyC,KAEtC,SAASW,GAA2C,CACzD,OAAOX,EACT,CAIO,SAASY,EAAeC,EAAwB,CACrD,OAAOA,IAAU1e,EAAU,MAAQ0e,IAAU1e,EAAU,MACzD,CAIA,MAAM2e,GAAmB,CAAC,MAAO,MAAO,OAAQ,KAAK,EAE9C,SAASC,GAAatW,EAA0BuW,EAAoD,CACzG,GAAI,CAACvW,EAAM,MAAO,GAIlB,GADIA,EAAK,MAAQA,EAAK,KAAK,WAAW,QAAQ,GAC1CuW,IACE,OAAOA,EAAS,MAAS,UAAYA,EAAS,KAAK,WAAW,QAAQ,GACtE,OAAOA,EAAS,MAAS,UAAYA,EAAS,KAAK,WAAW,QAAQ,GAAG,MAAO,GAKtF,MAAMC,GADYD,GAAU,MAAoBvW,EAAc,MAAQ,IACjD,MAAM,GAAG,EAAE,OAAO,eAAiB,GACxD,OAAOqW,GAAiB,SAASG,CAAG,CACtC,CASO,SAASC,GAAcpN,EAAoB,CAChDtU,EAAI,MAAM,+BAA+BsU,CAAI,EAAE,EAE/C,IAAIqN,EACJ,OAAQrN,EAAA,CACN,IAAK,QACHqN,EAAchf,EAAU,cACxB,MACF,IAAK,UACHgf,EAAchf,EAAU,gBACxB,MACF,IAAK,SACL,IAAK,QACHgf,EAAchf,EAAU,cACxB,MACF,QACEgf,EAAchf,EAAU,KAG5B,MAAMoS,EAAerR,EAAiB,UAAU,EAC1Cke,EAAWR,EAAerM,CAAY,EAAIpS,EAAU,OAASgf,EAG7DE,EAAavN,IAAS,UAAYqN,EAAcC,EACtD9d,EAAS,WAAY+d,CAAU,EAC/BnhB,EAAI,KAAK,uBAAwBmhB,CAAU,EAE3CnhB,EAAI,KAAK,oBAAoB,CAC/B,CAaA,SAASohB,GAAoBC,EAAwB,CACnD,MAAMC,EAAO,SAAS,KACtBA,EAAK,UAAU,OAAO,aAAc,eAAgB,YAAY,EAEhE,MAAMC,EAAezB,GACflE,EAAkB5Y,EAAsB,uBAAuB,EAC/DwU,EAAOxU,EAAkC,eAAe,EAIxDwe,EACJd,EAAeW,CAAQ,GACvBE,GACA,CAAC,CAACA,EAAa,KACfV,GAAajF,EAAiBpE,CAAI,EAG9BiK,EACJJ,IAAapf,EAAU,eACvBof,IAAapf,EAAU,iBACvBuf,EAIEC,GAAaH,EAAK,UAAU,IAAI,YAAY,EAG5CD,IAAapf,EAAU,iBAAiBqf,EAAK,UAAU,IAAI,cAAc,EAEzED,IAAapf,EAAU,eAAeqf,EAAK,UAAU,IAAI,YAAY,EAGzE,MAAMI,EAAc,SAAS,eAAe,0BAA0B,EAClEA,IACFA,EAAY,MAAM,QAAU,IAC5BA,EAAY,MAAM,cAAgB,OAClCA,EAAY,MAAM,QAAU,QAI9B,MAAMC,EAAe,SAAS,cAAc,gBAAgB,EAU5D,GATIA,IACFA,EAAa,MAAM,QAAUF,EAAc,OAAS,OAChDA,IACFE,EAAa,MAAM,WAAa,UAChCA,EAAa,MAAM,cAAgB,SAKnCJ,EAAc,CAChB,MAAMK,EAAiBP,IAAapf,EAAU,eAAkBuf,EAChED,EAAa,MAAM,QAAUK,EAAgB,QAAU,MACzD,CAGIP,IAAapf,EAAU,iBAAmByf,IAC5CA,EAAY,MAAM,QAAU,QAC5BA,EAAY,MAAM,QAAU,IAC5BA,EAAY,MAAM,cAAgB,OAEtC,CAIO,SAASG,IAAkB,CAChC/B,GAAgB,SAAS,eAAe,YAAY,EAC/CA,IACHxgB,EAAI,KAAK,uCAAuC,EAIlDU,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtD6hB,GAAoB7hB,EAAK,CAAC,CAAW,CACvC,IAGAS,EAAI,GAAG,4BAA6B,IAAIT,IAAoB,CAC1D,MAAMqH,EAAM,OAAOrH,EAAK,CAAC,CAAC,EAC1B,GAAI,GAACugB,IAAiB,CAAC,OAAO,SAASlZ,CAAG,GAG1C,GAAIkb,KACFhC,GAAc,OAAS,EACvBA,GAAc,MAAQ,OAEtB,IAAI,CAAEA,GAAc,OAASlZ,CAAK,OAAS/G,EAAG,CAC5CP,EAAI,MAAM,6BAA8BO,CAAC,CAC3C,CAEJ,IAEAP,EAAI,KAAK,qBAAqB,CAChC,CC7JA,IAAIyiB,GAAmB,KACnBC,EAA0C,KAC1CC,EAAoB,EACpBC,GAAuB,EACvBC,GAAgB,GAChBC,EACAC,GAA2B,GAIxB,SAASP,IAA4C,CAC1D,OAAOE,CACT,CAEO,SAASM,GAAsBC,EAA+B,CACnEP,EAAsBO,CACxB,CAEO,SAASC,IAA6B,CAC3C,MAAO,EAAEP,CACX,CAEO,SAASQ,IAAuB,CACrC,OAAOR,CACT,CAEO,SAASS,GAAmBC,EAAgC,CACjEP,EAAmBO,CACrB,CAEO,SAASC,IAAyC,CACvD,OAAOR,CACT,CAIO,SAASS,GAAQ1X,EAAmB,CACzC,GAAI,MAAMA,CAAC,EAAG,MAAO,OACrB,MAAM2X,EAAI,KAAK,MAAM3X,EAAI,EAAE,EACrB4X,EAAM,KAAK,MAAM5X,EAAI,EAAE,EAC7B,MAAO,GAAG2X,CAAC,IAAIC,EAAM,GAAK,IAAM,EAAE,GAAGA,CAAG,EAC1C,CAIO,SAASC,GAA2B,CACzC,MAAM3O,EAAerR,EAAiB,UAAU,EAC1CigB,EAAWjgB,EAAiB,iBAAiB,GAAK,EAExD,GAAI0d,EAAerM,CAAY,EAAG,OAAO4O,EAGzC,GAAI5O,IAAiBpS,EAAU,gBAAiB,CAC9C,IAAIihB,EAAQ,EACZ,OAAAljB,EAAI,KAAK,uBAAyBmjB,GAAgB,CAAED,EAAQC,CAAK,CAAC,EAC3DD,CACT,CAEA,MAAM3B,EAAed,EAAA,EACf2C,EAAYpB,GAAuB,OAAO,SAASA,EAAoB,QAAQ,EACjFA,EAAoB,SACnBT,GAAgB,OAAO,SAASA,EAAa,QAAQ,EAAIA,EAAa,SAAW,EAEtF,IAAI4B,EAAM,EACV,MAAME,EAAYrgB,EAAiB,kBAAkB,GAAK,EACpDoT,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAGlE,OADuB,OAAOqgB,GAAc,UAAY,OAAO,SAASA,CAAS,GAAKA,EAAY,GAC5E,OAAO,KAAS,KAAe,MAAM,IACzDF,EAAO,KAAK,MAAQE,EAAajN,EAAcC,EACtCkL,GAAc,KAAOA,EAAa,YAAc,IACzD4B,EAAM5B,EAAa,aAGjB,MAAM4B,CAAG,IAAGA,EAAM,GAClBA,EAAM,IAAGA,EAAM,GACfC,EAAW,GAAKD,EAAMC,IAAUD,EAAMC,GAEnCD,CACT,CAIO,SAASG,GAAgBC,EAAwB,CACtDvjB,EAAI,KAAK,uBAAwBujB,CAAO,CAC1C,CAIO,SAASC,IAAuB,CACrC,GAAIzB,GACF,GAAI,CACFA,GAAY,QAAU,KACtBA,GAAY,OACZA,GAAY,aACZA,GAAY,SACd,OAAS,EAAG,CACVziB,EAAI,KAAK,uCAAwC,CAAC,CACpD,SACEyiB,GAAc,IAChB,CAEJ,CAIO,SAAS0B,GAAqB,CACnC,MAAMlC,EAAed,EAAA,EAGjBc,IACFA,EAAa,QACbA,EAAa,gBAAgB,KAAK,EAClCA,EAAa,QAGf,GAAI,CAAExB,GAAe,QAAU,MAAQ,CAAa,CACpD,GAAI,CAAEA,GAAe,cAAc,cAAc,CAAG,MAAQ,CAAa,CAGzE/f,EAAI,KAAK,mBAAmB,EAG5B6I,EAAkB,sBAAsB,EACxCA,EAAkB,eAAe,EAEjCzF,EAAS,WAAYnB,EAAU,IAAI,EACnCjC,EAAI,KAAK,uBAAwBiC,EAAU,IAAI,EAC/CqhB,GAAgB,EAAK,EAGrBtjB,EAAI,KAAK,sBAAuB,CAAE,QAAS,aAAc,GAAI,aAAc,EAG3EwjB,GAAA,EAGApgB,EAAS,mBAAoB,EAAE,EAG/BA,EAAS,mBAAoB,CAAC,EAC9BA,EAAS,kBAAmB,CAAC,CAC/B,CAIA,eAAsBsgB,EAAKC,EAA+B,CACxD,GAAIxB,GAAe,CACjB7iB,EAAI,KAAK,sCAAsC,EAC/C8iB,EAAmBuB,EACnB,MACF,CACAxB,GAAgB,GAEhB,MAAMyB,EAAe,WAAW,IAAM,CAChCzB,KACF7iB,EAAI,KAAK,8CAA8C,EACvD6iB,GAAgB,GAEpB,EAAG,GAAI,EAEP,GAAI,CACF,MAAM0B,GAAcF,CAAM,CAC5B,SACE,aAAaC,CAAY,EACzB,WAAW,IAAM,CAAEzB,GAAgB,EAAO,EAAG,EAAE,CACjD,CACF,CAEA,eAAe0B,GAAcF,EAA+B,CAI1D,GAHAvB,EAAmB,OAEEpf,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9C3C,EAAI,KAAK,mDAAmD,EAC5D,MACF,CAEA,GAAI,OAAO,KAAS,KAAe,CAAC,MAAM,QAAS,CACjDA,EAAI,MAAM,4BAA4B,EACtCU,EAAI,KAAK,gBAAiB,uBAAuB,EACjD,MACF,CAEA,GAAI,KAAK,QAAQ,QAAU,UACzB,GAAI,CAAE,MAAM,KAAK,QAAQ,QAAU,OAASH,EAAG,CAAEP,EAAI,KAAK,iBAAkBO,CAAC,CAAG,CAGlF,MAAM0hB,EAAed,EAAA,EAIrB,GAAI,CAHmB,CAAC,CAAEc,GAAc,KAAK,WAAW,OAAO,GAGxC,CAFC,CAAC,CAACS,EAEe,CACvC1iB,EAAI,KAAK,kCAAkC,EAC3C,MACF,CAEA,GAAI,CACF,MAAM8G,GAAA,CACR,OAASvG,EAAG,CACVP,EAAI,MAAM,4BAA6BO,CAAC,EACxCG,EAAI,KAAK,gBAAiB,mBAAmB,EAC7C,MACF,CAGA,IAAI8jB,EAAa,OAAOH,CAAM,GAC1B,CAAC,OAAO,SAASG,CAAU,GAAKA,EAAa,KAAGA,EAAa,GACjE,MAAMV,EAAYpB,GAAuB,OAAO,SAASA,EAAoB,QAAQ,EACjFA,EAAoB,SACnBT,GAAgB,OAAO,SAASA,EAAa,QAAQ,EAAIA,EAAa,SAAW,EAOtF,GANI6B,EAAW,IACTU,EAAaV,IAAUU,EAAaV,GACpCU,IAAeV,IAAUU,EAAa,KAAK,IAAI,EAAGV,EAAW,IAAK,IAIpEpB,EAAqB,CACvBwB,GAAA,EACAzB,GAAc,IAAI,KAAK,aAAaC,CAAmB,EAEvD,MAAMzS,EAAiBvM,EAAkB,sBAAsB,EACzDwM,EAAuBxM,EAAiB,4BAA4B,EAE1E,GAAIuM,EACFvP,EAAI,KAAK,yBAA0B+hB,GAAavS,CAAoB,EACpElQ,EAAI,MAAM,6CAA6CkQ,CAAoB,GAAG,MACzE,CACL,MAAMjL,EAAUe,GAAA,EACZf,GAASwd,GAAY,QAAQxd,CAAO,EACxCjF,EAAI,MAAM,gCAAgC,CAC5C,CAEA,MAAMykB,EAAa9B,EACnBF,GAAY,QAAU,IAAM,CAC1B,GAAIgC,IAAe9B,EAAmB,OACtC,MAAMtB,EAAQ3d,EAAiB,UAAU,GACrC2d,IAAU1e,EAAU,eAAiB0e,IAAU1e,EAAU,gBAC3D+hB,GAAA,CAEJ,EAEAjC,GAAY,MAAM,KAAK,MAAO+B,CAAU,EAGpCvC,GAAc,MAChBA,EAAa,YAAcuC,EAC3BvC,EAAa,MAAQ,GACrBA,EAAa,OAAS,EACtBA,EAAa,OAAO,MAAM,IAAM,CAAa,CAAC,EAElD,CAGA,MAAMnL,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAC5DqgB,EAAY,KAAK,OAASS,GAAc1N,EAAcC,IAC5DjT,EAAS,mBAAoBigB,CAAS,EACtCjgB,EAAS,kBAAmB0gB,CAAU,EACtCxkB,EAAI,MAAM,2BAA2BwkB,CAAU,iBAAiBT,CAAS,GAAG,EAE5EC,GAAgB,EAAI,EAEpB,MAAM9L,EAAOxU,EAAkC,eAAe,EACxD4Y,EAAkB5Y,EAAsB,uBAAuB,EAC/DihB,EAAUpD,GAAajF,EAAiBpE,CAAI,EAC5C0J,EAAW+C,EAAUhiB,EAAU,cAAgBA,EAAU,cAC/DmB,EAAS,WAAY8d,CAAQ,EAC7BlhB,EAAI,KAAK,uBAAwBkhB,CAAQ,EAEzClhB,EAAI,KAAK,kBAAkB,EACvBikB,GACFjkB,EAAI,KAAK,sBAAuB,CAAE,QAAS,cAAe,GAAI,aAAc,SAAU,IAAM,EAE9FA,EAAI,KAAK,eAAe,CAC1B,CAIO,SAASkkB,GAAMC,EAA2B,CAC/C,MAAM9P,EAAerR,EAAiB,UAAU,EAChD,GAAI0d,EAAerM,CAAY,EAAG,OAElC,IAAI+P,EACA,OAAOD,GAAe,UAAY,SAASA,CAAU,GAAKA,GAAc,EAC1EC,EAAWD,EAEXC,EAAWpB,EAAA,EAGbQ,GAAA,EAEA,MAAMjC,EAAed,EAAA,EACrB,GAAIc,EAAc,CAChB,GAAI,CAAEA,EAAa,OAAS,MAAQ,CAAa,CACjD,GAAI,CAAEA,EAAa,YAAc6C,CAAU,MAAQ,CAAa,CAClE,CAEAhhB,EAAS,WAAYnB,EAAU,MAAM,EACrCmB,EAAS,kBAAmBghB,CAAQ,EACpCpkB,EAAI,KAAK,uBAAwBiC,EAAU,MAAM,EACjDqhB,GAAgB,EAAK,EACrBtjB,EAAI,KAAK,gBAAiB,MAAM,EAChCA,EAAI,KAAK,sBAAuB,CAAE,QAAS,aAAc,GAAI,aAAc,CAC7E,CAIA,SAASgkB,IAAoB,CAE3B,GADiBhhB,EAAgC,kBAAkB,EACrD,OAEd,MAAMqR,EAAerR,EAAiB,UAAU,EAC1Cue,EAAed,EAAA,EAEf4D,EAAoB,CAAC,EAAErC,GAC3B,OAAO,SAASA,EAAoB,QAAQ,GAAKA,EAAoB,SAAW,IAE5EsC,EAAmBjQ,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,cAChG,GAAI,CAACoiB,GAAqBC,GAAoB/C,GAAgBA,EAAa,WAAa,EAAG,OAE3F,MAAM6B,EAAWiB,EACbrC,EAAqB,SACpBT,EAAeA,EAAa,SAAW,EAK5C,GAHI,CAAC6B,GAAY,CAAC,OAAO,SAASA,CAAQ,GAAKA,GAAY,IACvD,CAAC7B,GACDb,EAAerM,CAAY,GAC3BA,IAAiBpS,EAAU,gBAAiB,OAEhD,MAAMsiB,EAAOvB,EAAA,EAEb,GADkBhgB,EAAkB,kBAAkB,EACvC,CACb1D,EAAI,MAAM,iDAAiD,EAC3D,MACF,CAEIilB,GAAQnB,EAAW,KACrB9jB,EAAI,MAAM,kBAAkBilB,EAAK,QAAQ,CAAC,CAAC,OAAOnB,EAAS,QAAQ,CAAC,CAAC,GAAG,EACxEK,EAAA,EACArgB,EAAS,kBAAmB,CAAC,EAC7BpD,EAAI,KAAK,eAAe,EAGxBA,EAAI,KAAK,cAAc,EAE3B,CAIO,SAASwkB,IAAmB,CACjC,MAAMtc,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACzD,GAAIkF,GAAY,CAACuc,EAAY,CAC3BzkB,EAAI,KAAK,gBAAiB,gBAAgB,EAC1C,MACF,CAEA,MAAMqU,EAAerR,EAAiB,UAAU,EAGhD,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9CjC,EAAI,KAAK,qBAAqB,EAC9B,MACF,CAEA,MAAM0kB,EAAoBrQ,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,cAC3FghB,EAAWjgB,EAAiB,iBAAiB,GAAK,EAClDmW,EAAoBnW,EAAiB,4BAA4B,EAGnE,CAACkF,GAAYa,GAAgB,eAAe,IAC9CF,EAAkB,eAAe,EACjC7I,EAAI,KAAK,gBAAiB,cAAc,GAGtC0kB,EACGxc,EAGMuc,GACTvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,cAAe,GAHzCwhB,GAAA,EACAxW,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAMM,EAAiB,iBAAiB,EAAG,GAKrEkF,EAIMuc,GACTvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,aAAc,KAAMugB,EAAU,GAJxDS,EAAKT,CAAQ,EACbvV,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAMugB,EAAU,MAAO9J,EAAmB,EACtEtE,GAAA,EAKN,CAIO,SAAS8P,IAAqB,CACnC,MAAMzc,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEzD,GAAIkF,GAAY,CAACuc,EAAY,CAC3BzkB,EAAI,KAAK,gBAAiB,gBAAgB,EAC1C,MACF,CAEA,GAAIkI,GAAYuc,EAAY,CAC1B,GAAI,CAAEvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,aAAc,KAAM,EAAG,CAAG,MAAQ,CAAa,CAC/E,GAAI,CAAEwF,EAAS,KAAK,CAAE,KAAMxF,EAAI,cAAe,CAAG,MAAQ,CAAa,CACvE1C,EAAI,KAAK,gBAAiB,aAAa,EACvC,MACF,CAGA,GADqBgD,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9CjC,EAAI,KAAK,uBAAuB,EAChCoD,EAAS,kBAAmB,CAAC,EAC7BkgB,GAAgB,EAAK,EACrB,MACF,CAEAG,EAAA,EACAzjB,EAAI,KAAK,eAAe,EAEnBkI,GAAUwF,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAM,EAAG,EACrD1C,EAAI,KAAK,gBAAiB,IAAI,CAChC,CAIO,SAAS4kB,GAAS7B,EAAmB,CAC1C,MAAM7a,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEzD,GAAIkF,GAAY,CAACuc,EAAY,CAC3BzkB,EAAI,KAAK,gBAAiB,gBAAgB,EAC1C,MACF,CAEA,GAAIkI,GAAYuc,EAAY,CAC1Bvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,kBAAmB,IAAAqgB,EAAK,EAClD,MACF,CAEA,MAAM1O,EAAerR,EAAiB,UAAU,EAChD,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9CjC,EAAI,KAAK,oBAAqB+iB,CAAG,EACjC,MACF,CAGA,IAAI8B,EADY7B,EAAA,EACOD,EACvB,MAAMxB,EAAed,EAAA,EACf2C,EAAYpB,GAAqB,WACjCT,GAAgB,SAASA,EAAa,QAAQ,EAAIA,EAAa,SAAW,GAE5EsD,EAAS,IAAGA,EAAS,GACrBzB,EAAW,GAAKyB,EAASzB,IAAUyB,EAASzB,GAEhD,MAAMjK,EAAoBnW,EAAiB,4BAA4B,EACrDqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,eAGvFyhB,EAAKmB,CAAM,EACXnX,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAMmiB,EAAQ,MAAO1L,EAAmB,EACpEtE,GAAA,IAEAzR,EAAS,kBAAmByhB,CAAM,EAClCnX,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAMmiB,EAAQ,EAE/C,CAIO,SAASC,GAAWpU,EAAmB,CAC5C,MAAM0F,EAAcpT,EAAiB,kBAAkB,GAAK,EAC5DI,EAAS,mBAAoBgT,EAAc1F,CAAG,EAC9C1Q,EAAI,KAAK,qBAAqB,EAE9B,MAAMqU,EAAerR,EAAiB,UAAU,EAChD,GAAI,CAAC0d,EAAerM,CAAY,EAC9BqP,EAAKV,GAAkB,MAClB,CACL,MAAMC,EAAWjgB,EAAiB,iBAAiB,GAAK,EACxDI,EAAS,kBAAmB6f,EAAWvS,CAAG,CAC5C,CACF,CAIO,SAASqU,IAAuB,CACrC,MAAM1Q,EAAerR,EAAiB,UAAU,EAChD,GAAI0d,EAAerM,CAAY,GAAKA,IAAiBpS,EAAU,gBAAiB,OAEhF,MAAMsf,EAAed,EAAA,EACrB,GAAI,CAACc,GAAc,IAAK,OAExB,MAAMyD,EAAahC,EAAA,EACbiC,EAAa1D,EAAa,YAC1B2D,EAAQ,KAAK,IAAID,EAAaD,CAAU,EAE9C,GAAIE,EAAQ,GAAK,CACf,GAAI3D,EAAa,QAAS,OAC1BjiB,EAAI,MAAM,uCAAuC4lB,EAAM,QAAQ,CAAC,CAAC,GAAG,EAEhEA,GAAS,KAAO3D,EAAa,SAC/BjiB,EAAI,KAAK,2DAA2D,EACpEiiB,EAAa,OAAO,MAAM,IAAM,CAAa,CAAC,GAGhDA,EAAa,YAAcyD,CAC7B,CACF,CAIA,eAAsBG,GACpB5L,EACAE,EAA2B,KAC3B2L,EAAe,GACfC,EACe,CACfnD,KACA,MAAMoD,EAAWpD,GACXqD,EAAUF,GAAapD,EAE7BjiB,EAAI,KAAK,iBAAkB,GAAM,SAASuZ,EAAK,IAAI,EAAE,EACrDkK,EAAA,EAEiBzgB,EAAiB,UAAU,IAC3Bf,EAAU,iBACzBjC,EAAI,KAAK,mBAAmB,EAG9B,GAAI,CACF,MAAMoG,GAAA,EACF,KAAK,QAAQ,QAAU,aAAa,MAAM,KAAK,QAEnD,MAAM4Z,EAAMD,GAAe,OAAOxG,CAAI,GAAK,GAC3CnW,EAAS,wBAAyBmW,CAAI,EAEtCja,EAAI,MAAM,wDAAwD,EAClEU,EAAI,KAAK,gBAAiB,yBAAyB,EAGnD,MAAMwlB,EAAc,MAAMjM,EAAK,cACzBkM,EAAc,MAAM,KAAK,QAAQ,gBAAgBD,CAAW,EAGlE,GAAIH,IAAc,QAAapD,IAAsBsD,EAAS,CACxDD,IAAapD,KACf5iB,EAAI,KAAK,0DAA0D,EACnEU,EAAI,KAAK,iBAAkB,EAAK,GAElC,MACF,CAOA,GAJIgiB,IACFA,EAAsB,MAGpBsD,IAAapD,GAAsB,CACrC5iB,EAAI,MAAM,kDAAkD,EAC5D,MACF,CAGA0iB,EAAsByD,EACtBnmB,EAAI,MAAM,uBAAuBmmB,EAAY,SAAS,QAAQ,CAAC,CAAC,aAAa,EAGzEA,EAAY,UAAY,SAASA,EAAY,QAAQ,GACvDzlB,EAAI,KAAK,qBAAsBylB,EAAY,QAAQ,EAIrD,MAAMlE,EAAed,EAAA,EACjBc,IACFA,EAAa,IAAMvB,EACnBuB,EAAa,MAAQ,IAGvB,MAAMpI,EAAoBnW,EAAiB,4BAA4B,EAKvE,GAJAI,EAAS,gBAAiB,CAAE,KAAMmW,EAAK,KAAM,KAAMA,EAAK,KAAM,MAAOJ,CAAA,CAAmB,EAExFnZ,EAAI,KAAK,oBAAoB,EAEzBuhB,EAAc,CAChB,MAAMmE,EAAe,IAAM,CAEzB,GADAnE,EAAa,oBAAoB,iBAAkBmE,CAAY,EAC3DJ,IAAapD,GAAsB,OACvC,MAAMyD,EAAM3D,EAAsBA,EAAoB,SAAWT,EAAa,SAC1EoE,GAAO,SAASA,CAAG,GACrB3lB,EAAI,KAAK,qBAAsB2lB,CAAG,EAEpC5F,GAAe,SACjB,EACAwB,EAAa,iBAAiB,iBAAkBmE,CAAY,EAC5DnE,EAAa,MACf,CAGA,MAAMrZ,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACzDhD,EAAI,KAAK,oBAAqB,EAAEkI,GAAY,CAACuc,EAAW,GAGjCzhB,EAAoB,wBAAwB,GAAK,IACrD,OAAS,GAAKyW,IAC/BzZ,EAAI,KAAK,gBAAiB,cAAc,EACxCsZ,GAAcC,EAAME,CAAS,GAG1BvR,GACHuU,GAAA,CAEJ,OAASrS,EAAc,CACrB9K,EAAI,MAAM8K,CAAG,EACbpK,EAAI,KAAK,gBAAiB,gBAAiBoK,EAAc,OAAO,EAAE,CACpE,SACMkb,IAAapD,KACfliB,EAAI,KAAK,iBAAkB,EAAK,EAChCoD,EAAS,kBAAmB,CAAC,EAC7BkgB,GAAgB,EAAK,GAGvB,MAAMpb,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACzDhD,EAAI,KAAK,oBAAqB,CAACkI,GAAYuc,CAAU,CACvD,CACF,CAIA,eAAsBmB,GACpBC,EACAR,EACe,CACf,MAAMxJ,EAAW7Y,EAAyC,cAAc,EAClEmW,EAAoBnW,EAAiB,4BAA4B,EACjE8iB,EAAcD,GAAkBhK,GAAU,OAAoB1C,EAC9DoM,EAAUF,GAAapD,EACvB8D,EAAY/iB,EAAsB,sBAAsB,EACxDgjB,EAAYnK,EAAW,CAAE,GAAGA,GAAa,KAE/C,GAAI,CAACkK,EAAW,CACdzmB,EAAI,KAAK,6CAA6C,EACtD,MACF,CAEA+iB,GAA2B,GAE3B,GAAI,CAGF,GAFA,MAAMjc,GAAA,EAEFyf,IAAkB,QAAa1M,IAAsB,IAAMA,IAAsB2M,EAAa,CAChGxmB,EAAI,KAAK,sCAAsCwmB,CAAW,gBAAgB3M,CAAiB,aAAa,EACxG,MACF,CAGI6I,IACFA,EAAsB,MAGxB1iB,EAAI,MAAM,6CAA6C,EACvDU,EAAI,KAAK,gBAAiB,cAAc,EAExC,MAAMwlB,EAAc,MAAMO,EAAU,cAC9BN,EAAc,MAAM,KAAK,QAAQ,gBAAgBD,CAAW,EAGlE,GAAIH,IAAc,QAAapD,IAAsBsD,EAAS,CAC5DjmB,EAAI,KAAK,oDAAoD,EAC7D,MACF,CACA,GAAIumB,IAAkB,QAAa1M,IAAsB,IACrDnW,EAAiB,4BAA4B,IAAM8iB,EAAa,CAClExmB,EAAI,KAAK,oDAAoD,EAC7D,MACF,CAEA,MAAM2mB,EAAaD,GAAahjB,EAAkC,eAAe,EAGjFI,EAAS,wBAAyB2iB,CAAS,EAC3C3iB,EAAS,gBAAiB6iB,CAAU,EACpCjE,EAAsByD,EACtBnmB,EAAI,MAAM,0BAA0BmmB,EAAY,SAAS,QAAQ,CAAC,CAAC,YAAY,EAE/E,MAAMxB,EAAUpD,GAAakF,EAAWE,CAAU,EAClDjF,GAAciD,EAAU,QAAU,QAAQ,EAG1C,MAAMjE,EAAMD,GAAe,OAAOgG,CAAS,GAAK,GAC1CxE,EAAed,EAAA,EACjBc,IACFA,EAAa,IAAMvB,EACnBuB,EAAa,MAAQ,IAGvB,MAAMoE,EAAMF,EAAY,SACpB,SAASE,CAAG,GACd3lB,EAAI,KAAK,qBAAsB2lB,CAAG,EAEpC5F,GAAe,UAEXwB,KAA2B,OAG/Bne,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7BA,EAAS,yBAA0B,EAAE,EACrC9D,EAAI,MAAM,sDAAsD,EAGhE8D,EAAS,4BAA6B,EAAI,EAC1CA,EAAS,6BAA8B,EAAK,EAC5CyF,EAAkB,iBAAiB,EACnCA,EAAkB,eAAe,EACjCA,EAAkB,iBAAiB,EAGnC,MAAMX,EAAWlF,EAAgC,kBAAkB,EAC/DkF,GAAU,MACZ,WAAW,IAAM,CACXA,EAAS,MAAMA,EAAS,KAAK,CAAE,KAAMxF,EAAI,cAAe,CAC9D,EAAG,GAAG,EAGR2f,GAA2B,GAG3B,MAAMjM,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAClE,GAAIkF,GAAYka,IAAqB,OAAW,CAC9C,MAAMyC,EAASzC,EAAmBhM,EAAcC,EAChD/W,EAAI,MAAM,kDAAkDulB,EAAO,QAAQ,CAAC,CAAC,GAAG,EAChFnB,EAAKmB,CAAM,EACXzC,EAAmB,MACrB,CAEF,OAASviB,EAAY,CACnBwiB,GAA2B,GAC3B/iB,EAAI,MAAM,+BAAgCO,CAAC,EAC3CG,EAAI,KAAK,gBAAiB,uBAAuB,EAEjDoD,EAAS,uBAAwB,IAAI,EACrCA,EAAS,eAAgB,IAAI,EAC7BA,EAAS,yBAA0B,EAAE,EACrCA,EAAS,4BAA6B,EAAK,EAC3CA,EAAS,6BAA8B,EAAK,EAC5CyF,EAAkB,iBAAiB,EAGnC,MAAMX,EAAWlF,EAAgC,kBAAkB,EAC7DqW,EAAWrW,EAAoB,gBAAgB,GAAK,GACpDwU,EAAOxU,EAAkC,eAAe,EACxD+N,EAAM/N,EAAiB,4BAA4B,EACnD0F,EAAQ2Q,EAAStI,CAAG,GAA8B,MAASyG,GAAM,MAAmB,GACtFtP,GAAU,MACZA,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,KAAAgG,EAAM,MAAOqI,EAAK,OAAQ,4BAA6B,CAE3G,CACF,CAIA,SAASmV,GAAc9e,EAAqC,CAC1D,MAAMub,EAAO,OAAOvb,EAAK,IAAI,GAAK,EAC5B+e,EAAgB/e,EAAK,MAG3B,GAAIib,GAA0B,CAC5BD,EAAmBO,EACnBrjB,EAAI,MAAM,mDAAmDqjB,CAAI,EAAE,EACnE,MACF,CAGA,MAAMxJ,EAAoBnW,EAAiB,4BAA4B,EACvE,GAAImjB,IAAkB,QAAaA,IAAkBhN,EAAmB,CACtE7Z,EAAI,KAAK,mCAAmC6Z,CAAiB,UAAUgN,CAAa,EAAE,EACtF/D,EAAmBO,EACnBvf,EAAS,6BAA8B+iB,CAAa,EACpDnmB,EAAI,KAAK,oBAAoB,EAG7B,MAAMmX,EAAenU,EAAsB,sBAAsB,EAC3Dsb,EAAiBtb,EAAiB,wBAAwB,EAChE,GAAImU,GAAgBmH,IAAmB6H,EAAe,CACpD7mB,EAAI,MAAM,2CAA2C6mB,CAAa,EAAE,EACpElE,IACA2D,GAAmBO,EAAelE,CAAiB,EACnD,MACF,CAGA,MAAM/Z,EAAWlF,EAAgC,kBAAkB,EAE7D0F,GADW1F,EAAyB,gBAAgB,GAAK,IACzCmjB,CAAa,GAAG,MAAQ,GAC1Cje,GAAU,MACZA,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,KAAAgG,EAAM,MAAOyd,EAAe,OAAQ,iBAAkB,EAExG,MACF,CAGA,MAAM3O,EAAOxU,EAAkC,eAAe,EACxDqW,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDojB,EAAgBhf,EAAK,MAAmBiS,EAASF,CAAiB,GAAG,MAAQ,GAC7EkN,EAAc7O,GAAM,MAAmB,GAC7C,GAAI4O,GAAgBC,GAAcD,IAAiBC,GAC7CF,IAAkB,QAAaA,IAAkBhN,EAAmB,CACtE7Z,EAAI,KAAK,wCAAwC+mB,CAAU,cAAcD,CAAY,EAAE,EACvFhE,EAAmBO,EACnB,MACF,CAGEX,GAAuBvB,EAAA,GAAmB,IAC5CiD,EAAKf,CAAI,GAETP,EAAmBO,EACnBrjB,EAAI,MAAM,sCAAsCqjB,CAAI,EAAE,EAE1D,CAEA,SAAS2D,GAAelf,EAAqC,CAC3D,MAAMub,EAAO,OAAOvb,EAAK,IAAI,GAAK,EAClC8c,GAAMvB,CAAI,CACZ,CAEA,SAAS4D,GAAkBnf,EAA+BY,EAA4B,CAGpF,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,iDAAiD0I,GAAM,IAAI,EAAE,EACtE,MACF,CAEAa,EAAkB,eAAe,EACjC,MAAMoa,EAAWjgB,EAAiB,iBAAiB,GAAK,EAClD2f,EAAO,OAAOvb,EAAK,IAAI,GAAK6b,EAC5B9J,EAAoBnW,EAAiB,4BAA4B,EAEvE0gB,EAAKf,CAAI,EACTjV,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAAigB,EAAM,MAAOxJ,EAAmB,EAC5DtE,GAAA,CACF,CAEA,SAAS2R,GAAmBjT,EAAgCvL,EAA4B,CAEtF,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,kDAAkD0I,GAAM,IAAI,EAAE,EACvE,MACF,CAEAa,EAAkB,eAAe,EACjCqb,GAAA,EACAxW,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAMM,EAAiB,iBAAiB,EAAG,EAC1E,CAEA,SAASyjB,GAAkBrf,EAA+BY,EAA4B,CAEpF,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,iDAAiD0I,GAAM,IAAI,EAAE,EACtE,MACF,CAEA,MAAM2a,EAAO,OAAOvb,EAAK,IAAI,GAAK,EAC5BiN,EAAerR,EAAiB,UAAU,EAC1CmW,EAAoBnW,EAAiB,4BAA4B,EAGvE,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9CjC,EAAI,KAAK,kBAAmB2iB,CAAI,EAChC,MACF,CAEA,GAAItO,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,cACzEyhB,EAAKf,CAAI,EACTjV,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAAigB,EAAM,MAAOxJ,EAAmB,MACvD,CACL/V,EAAS,kBAAmBuf,CAAI,EAChC,MAAMpB,EAAed,EAAA,EACrB,GAAIc,EAAc,GAAI,CAAEA,EAAa,YAAcoB,CAAM,MAAQ,CAAa,CAC9EjV,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAAigB,EAAM,CACrC,CACA9N,GAAA,CACF,CAEA,SAAS6R,GAAsBtf,EAA+BY,EAA4B,CAExF,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,sDAAsD0I,GAAM,IAAI,EAAE,EAC3E,MACF,CAEA,MAAM+a,EAAM,OAAO3b,EAAK,GAAG,GAAK,EAChCwd,GAAS7B,CAAG,CACd,CAEA,SAAS4D,GAAoBvf,EAAqC,CAChE,MAAM,EAAI,OAAOA,EAAK,IAAI,GAAK,EAC/BpH,EAAI,KAAK,gBAAiB,gBAAgB6iB,GAAQ,CAAC,CAAC,EAAE,EACtDa,EAAK,CAAC,CACR,CAIA,eAAekD,GAAiBxf,EAA8C,CAC5E,GAAI,CAACD,GAAgBC,EAAM,CAAC,eAAgB,mBAAmB,CAAC,EAAG,OAEnE,MAAMyf,EAAezf,EAAK,aACpB0f,EAAiB,OAAO1f,EAAK,iBAAiB,EAC9CiN,EAAerR,EAAiB,UAAU,EAC1CqW,EAAWrW,EAAyB,gBAAgB,GAAK,GAG/D,GAAI,CAAC6jB,GAAgBA,EAAa,SAAW,EAAG,CAC9C,GAAIxN,EAAS,SAAW,GAAKhF,IAAiBpS,EAAU,KAAM,OAC9D3C,EAAI,MAAM,4DAA4D,EACtE8D,EAAS,iBAAkB,EAAE,EAC7BA,EAAS,6BAA8B,EAAE,EACzCpD,EAAI,KAAK,oBAAoB,EAC7ByjB,EAAA,EACA,MACF,CAGA,GAAIrc,EAAK,aAAe,OAAW,CACjC,MAAMjE,EAAUH,EAAiB,qBAAqB,GAAK,EACvD,OAAOoE,EAAK,UAAU,IAAMjE,GAC9BnD,EAAI,KAAK,2BAA4B,OAAOoH,EAAK,UAAU,EAAG,EAAK,CAEvE,CACA,GAAIA,EAAK,YAAc,OAAW,CAChC,MAAMjE,EAAUH,EAAkB,oBAAoB,EAClD,CAAC,CAACoE,EAAK,YAAcjE,GACvBnD,EAAI,KAAK,uBAAwB,CAAC,CAACoH,EAAK,UAAW,EAAK,CAE5D,EAG4BiS,EAAS,SAAWwN,EAAa,QAC3DxN,EAAS,KAAK,CAAC0N,EAAIzjB,IAAMyjB,EAAG,OAAUF,EAAavjB,CAAC,GAAG,IAAe,KAEtEhE,EAAI,MAAM,gDAAgD,EAC1D8D,EAAS,iBAAkByjB,CAAyC,EACpE7mB,EAAI,KAAK,oBAAoB,GAI/B,MAAMmZ,EAAoBnW,EAAiB,4BAA4B,EACvE,GAAI8jB,IAAmB,IAAMA,IAAmB3N,EAAmB,CACjE7Z,EAAI,MAAM,qCAAqCwnB,CAAc,WAAW3N,CAAiB,kBAAkB,EAE3GsK,EAAA,EACArgB,EAAS,6BAA8B0jB,CAAc,EACrD9mB,EAAI,KAAK,oBAAoB,EAG7B,MAAM+c,GADkB/Z,EAAyB,gBAAgB,GAAK,IACzC8jB,CAAc,EAE3C,GAAI/J,GAAQA,EAAK,OAAS,UAAW,CACnC,MAAMnB,EAAkB5Y,EAAsB,uBAAuB,EAC/DgkB,EAAU,CAAC,EAAEpL,GAAmBA,EAAgB,KAAO,GACvDzE,EAAenU,EAAsB,sBAAsB,EAC3D6Y,EAAW7Y,EAAyC,cAAc,EAClEikB,EAAc,CAAC,EAAE9P,GAAgB0E,IACnCA,EAAS,QAAqBiL,GAAmBjL,EAAS,OAAoBkB,EAAK,OAGvF,GAAI,CAACiK,GAAWC,EAAa,CAC3B3nB,EAAI,MAAM,mEAAmE,EAC7E2iB,IACA,MAAM2D,GAAmBkB,EAAgB7E,CAAiB,EAC1D,MACF,CAGA,MAAMzK,EAAOxU,EAAkC,eAAe,EACxDkkB,EAAcF,GAAWxP,GAASA,EAAK,OAAoBuF,EAAK,KACtE,GAAI,CAACiK,GAAWE,EAAa,CAC3B5nB,EAAI,MAAM,4DAA6Dyd,EAAK,IAAI,EAChF/c,EAAI,KAAK,iBAAkB,GAAM,aAAa+c,EAAK,IAAI,EAAE,EAErD1I,IAAiBpS,EAAU,iBAC7BjC,EAAI,KAAK,mBAAmB,EAG9B,MAAMkI,EAAWlF,EAAgC,kBAAkB,EACnE,GAAIkF,GAAU,KAAM,CAClB,MAAM0P,EAAS,KAAK,SAAW,IAAO,IACtC,WAAW,IAAM,CACf,GAAI,CAAC1P,GAAU,KAAM,OACrB,MAAMif,EAAenkB,EAAsB,uBAAuB,GAChEA,EAAsB,sBAAsB,EAClCA,EAAiB,4BAA4B,IAC7C8jB,GAAkB,CAACK,EAC7Bjf,EAAS,KAAK,CACZ,KAAMxF,EAAI,sBACV,UAAW,EACX,SAAUqa,EAAK,KACf,MAAO+J,CAAA,CACR,EACQK,IACT7nB,EAAI,MAAM,4DAA4D,EACtEU,EAAI,KAAK,iBAAkB,EAAK,EAEpC,EAAG4X,CAAM,CACX,CACF,CACF,MAAWmF,GAAQA,EAAK,OAAS,WAC3B1I,IAAiBpS,EAAU,iBAAmB8a,EAAK,UACrDzd,EAAI,MAAM,6DAA6D,EACvEU,EAAI,KAAK,eAAgB+c,EAAK,QAASA,EAAK,YAAc,KAAM,GAAM,CAAC,EAG7E,CACF,CAIA,SAASqK,GAAwBxM,EAAS,GAAU,CAClDtb,EAAI,MAAM,wDAAwDsb,CAAM,EAAE,EAG1E,MAAMvB,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDmW,EAAoBnW,EAAiB,4BAA4B,EACjEwU,EAAOxU,EAAkC,eAAe,EACxDqkB,EAAYhO,EAASF,CAAiB,GAAG,MAAS3B,GAAM,MAAmB,GAC3E8P,EAAM,OACZ,GAAI1M,IAAW,kBAAoByM,GAAaC,EAAI,wBAA0BD,EAAW,CACvF/nB,EAAI,MAAM,+CAA+C+nB,CAAS,EAAE,EACpE,MACF,CAeA,GAdAC,EAAI,sBAAwBD,EAG5Bxe,EAAkB,eAAe,EACjCA,EAAkB,iBAAiB,EAGnCzF,EAAS,mBAAoB,EAAE,EAG/BA,EAAS,yBAA0B,CAAC,EACpCA,EAAS,gBAAiB,EAAE,EAC5BA,EAAS,wBAAyB,IAAI,EAElCwX,IAAW,iBAAkB,OAG7BoH,IACF1iB,EAAI,MAAM,2CAA2C,EACrD0iB,EAAsB,MAExBwB,GAAA,EACApgB,EAAS,4BAA6B,EAAK,EAC3Cgf,EAAmB,OAGnB,MAAM/N,EAAerR,EAAiB,UAAU,GAC5CqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,UACrHmB,EAAS,WAAYnB,EAAU,IAAI,EACnCjC,EAAI,KAAK,uBAAwBiC,EAAU,IAAI,GAIjD,MAAMic,EAAUlb,EAAsB,iBAAiB,EACnDkb,KAAiB,QAErB6B,GAAe,SAEf,MAAMwB,EAAed,EAAA,EACjBc,IACFA,EAAa,QACbA,EAAa,IAAM,GACnBA,EAAa,QAEf,GAAI,CAAExB,GAAe,cAAc,yBAAyB,CAAG,MAAQ,CAAa,CAGpF,MAAM/H,EAAehV,EAAkC,uBAAuB,EAC9E,GAAIgV,EAAa,KAAM,CACrB,MAAM6D,EAAW7Y,EAAyC,cAAc,EAC7CgV,EAAa,OAAS6D,GAAU,OAEzDpS,EAAkB,CAAE,QAAS,aAAc,UAAW,GAAO,EAC7DQ,GAAoB+N,EAAa,KAAM,EAAK,EAC5CA,EAAa,KAAO,KAExB,CACF,CAIA,eAAeuP,GAAkBhO,EAAkC,CACjEja,EAAI,MAAM,wCAAwC,EAClDU,EAAI,KAAK,iBAAkB,GAAM,iBAAiB,EAElD,GAAI,CACF,MAAMoG,GAAA,EACF,KAAK,QAAQ,QAAU,aAAa,MAAM,KAAK,QAEnD,MAAMof,EAAc,MAAMjM,EAAK,cACzBkM,EAAc,MAAM,KAAK,QAAQ,gBAAgBD,CAAW,EAE9DxD,IACFA,EAAsB,MAExBA,EAAsByD,EAEtB,MAAMjO,EAAOxU,EAAkC,eAAe,EACxDihB,EAAUpD,GAAatH,EAAM/B,CAAI,EACvCwJ,GAAciD,EAAU,QAAU,QAAQ,EAE1C7gB,EAAS,wBAAyBmW,CAAI,EAEtC,MAAMyG,EAAMD,GAAe,OAAOxG,CAAI,GAAK,GACrCgI,EAAed,EAAA,EAWrB,GAVIc,IACFA,EAAa,IAAMvB,EACnBuB,EAAa,MAAQ,IAGnBkE,EAAY,UAAY,SAASA,EAAY,QAAQ,GACvDzlB,EAAI,KAAK,qBAAsBylB,EAAY,QAAQ,EAErD1F,GAAe,UAEXwB,EAAc,CAChB,MAAMmE,EAAe,IAAM,CACzBnE,EAAa,oBAAoB,iBAAkBmE,CAAY,EAC/D,MAAMC,EAAM3D,EAAsBA,EAAoB,SAAWT,EAAa,SAC1EoE,GAAO,SAASA,CAAG,GAAG3lB,EAAI,KAAK,qBAAsB2lB,CAAG,CAC9D,EACApE,EAAa,iBAAiB,iBAAkBmE,CAAY,EAC5DnE,EAAa,MACf,CAUA,GAPAne,EAAS,iBAAkB,OAAO,EAClCA,EAAS,4BAA6B,EAAK,EAC3CyF,EAAkB,iBAAiB,EACnCA,EAAkB,eAAe,EAGhB7F,EAAgC,kBAAkB,GACnDof,IAAqB,OAAW,CAC9C,MAAMhM,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAC5D6hB,EAASzC,EAAmBhM,EAAcC,EAChD/W,EAAI,MAAM,+DAA+DulB,EAAO,QAAQ,CAAC,CAAC,GAAG,EAC7FnB,EAAKmB,CAAM,EACXzC,EAAmB,MACrB,CAEApiB,EAAI,KAAK,oBAAqB,EAAI,CACpC,OAASoK,EAAc,CACrB9K,EAAI,MAAM,0BAA2B8K,CAAG,EACxCpK,EAAI,KAAK,gBAAiB,uBAAuB,EAEjD,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC7DmW,EAAoBnW,EAAiB,4BAA4B,EAEjE0F,GADW1F,EAAyB,gBAAgB,GAAK,IACzCmW,CAAiB,GAAG,MAAQ,GAC9CjR,GAAU,MACZA,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,KAAAgG,EAAM,MAAOyQ,EAAmB,OAAQ,kBAAmB,CAE/G,SACEnZ,EAAI,KAAK,iBAAkB,EAAK,CAClC,CACF,CAIO,SAASwnB,IAAqB,CACnC3f,EAAiB,CACf,CAACnF,EAAI,IAAI,EAAGwjB,GACZ,CAACxjB,EAAI,KAAK,EAAG4jB,GACb,CAAC5jB,EAAI,YAAY,EAAG6jB,GACpB,CAAC7jB,EAAI,aAAa,EAAG8jB,GACrB,CAAC9jB,EAAI,YAAY,EAAG+jB,GACpB,CAAC/jB,EAAI,iBAAiB,EAAGgkB,GACzB,CAAChkB,EAAI,eAAe,EAAGikB,GACvB,CAACjkB,EAAI,WAAW,EAAGkkB,EAAA,CACpB,EAGD5mB,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CAC/CA,EAAK,CAAC,IAAM,cAAcwlB,GAAA,CAChC,IAGA/kB,EAAI,GAAG,yBAA0B,IAAM,CACrCyjB,EAAA,CACF,IAGAzjB,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CACnD,MAAMkoB,EAAWloB,EAAK,CAAC,EACnB,OAAOkoB,GAAa,YACtBA,EAASzE,GAAkB,CAE/B,IAGAhjB,EAAI,GAAG,iBAAkB,IAAIT,IAAoB,CAC/C,MAAMmoB,EAAW,OAAOnoB,EAAK,CAAC,CAAC,GAAK,EAC9BuW,EAAYvW,EAAK,CAAC,EAClBooB,EAAgB,OAAOpoB,EAAK,CAAC,CAAC,GAAK,EAEnC6W,EAAcpT,EAAiB,kBAAkB,GAAK,EACtD4kB,EAAkBF,EAAWC,EAAgBvR,EAEnD,GAAIN,EACEkM,GAAuBvB,EAAA,GAAmB,IAC5CiD,EAAKkE,CAAe,GAEpBxkB,EAAS,kBAAmBwkB,CAAe,EAC3CtoB,EAAI,MAAM,6DAA6D,OAEpE,CACL,GAAI8iB,IAAqB,OAAW,CAClChf,EAAS,kBAAmBwkB,CAAe,EAC3CtoB,EAAI,MAAM,0CAA0C,EACpD,MACF,CACAmkB,EAAA,EACArgB,EAAS,kBAAmBwkB,CAAe,CAC7C,CAEA,MAAMC,EAAsB7kB,EAAkB,0BAA0B,EAClE8kB,EAAgB9kB,EAAiB,oBAAoB,GAAK,EAC5D6kB,EACF7nB,EAAI,KAAK,gBAAiB,iBAAiB,KAAK,MAAM8nB,EAAgB,CAAC,CAAC,IAAI,EAE5E9nB,EAAI,KAAK,gBAAiB,qBAAqB,CAEnD,IAGAA,EAAI,GAAG,oBAAqB,IAAI+nB,IAAqB,CACnD,MAAM1T,EAAerR,EAAiB,UAAU,GAC5CqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,gBACzEyhB,EAAKV,GAAkB,CAE3B,IAGAhjB,EAAI,GAAG,0BAA2B,IAAM,CACtC,MAAMqU,EAAerR,EAAiB,UAAU,GAC5CqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,gBACzEyhB,EAAKV,GAAkB,CAE3B,IAGAhjB,EAAI,GAAG,sBAAuB,IAAM,CAClCgkB,GAAA,CACF,IAGAhkB,EAAI,GAAG,gCAAiC,IAAIT,IAAoB,CAC9D,MAAMqb,EAAUrb,EAAK,CAAC,GAAgB,GACtC6nB,GAAwBxM,CAAM,CAChC,IAGA5a,EAAI,GAAG,mBAAoB,SAAUT,IAAoB,CACvD,MAAMuK,EAAWvK,EAAK,CAAC,EACjByoB,EAAazoB,EAAK,CAAC,EAGzB,GAFkBA,EAAK,CAAC,EAET,CAEbS,EAAI,KAAK,6BAA8B8J,EAAUke,CAAU,EAC3D,MACF,CAIA,GAAI,CADahlB,EAAgC,kBAAkB,EACpD,OAEf,MAAMuW,EAAO,MAAMrP,GAAiBJ,EAAU,EAAK,EACnD,GAAI,CAACyP,EAAM,CACTja,EAAI,MAAM,uCAAwCwK,CAAQ,EAC1D9J,EAAI,KAAK,iBAAkB,EAAK,EAChC,MACF,CAEA,MAAMunB,GAAkBhO,CAAI,CAC9B,IAGAvZ,EAAI,GAAG,yBAA0B,IAAIT,IAAoB,CACvD,MAAM2c,EAAQ3c,EAAK,CAAC,EACd0oB,EAAQ1oB,EAAK,CAAC,EAEpBD,EAAI,MAAM,+CAA+C4c,CAAK,KAAK+L,CAAK,GAAG,EAC3E7kB,EAAS,4BAA6B,EAAI,EAC1CA,EAAS,6BAA8B,EAAI,EAGtBJ,EAAsB,sBAAsB,GAE/DI,EAAS,6BAA8B,EAAK,EAC5C6e,IACA2D,GAAmB1J,EAAO+F,CAAiB,GAG3C3iB,EAAI,MAAM,mDAAmD,CAEjE,IAGAU,EAAI,GAAG,6BAA8B,IAAIT,IAAoB,CAC3D,MAAMsZ,EAAUtZ,EAAK,CAAC,EACtBS,EAAI,KAAK,iBAAkB,GAAM,WAAW6Y,CAAO,GAAG,CACxD,IAGA7Y,EAAI,GAAG,0BAA2B,SAAUT,IAAoB,CAC9D,MAAM2c,EAAQ3c,EAAK,CAAC,EACd0oB,EAAQ1oB,EAAK,CAAC,EAIpB,GAFAD,EAAI,MAAM,2CAA2C4c,CAAK,EAAE,EACvClZ,EAAsB,sBAAsB,EAE/Dif,IACA,MAAM2D,GAAmB1J,EAAO+F,CAAiB,MAC5C,CACL3iB,EAAI,KAAK,uEAAuE,EAChFU,EAAI,KAAK,iBAAkB,GAAM,YAAY,EAC7ConB,GAAwB,yBAAyB,EAEjD,MAAMlf,EAAWlF,EAAgC,kBAAkB,EAC7DqW,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDqkB,EAAYY,GAAS5O,EAAS6C,CAAK,GAAG,MAAQ,GACpD,GAAIhU,GAAU,KAAM,CAClB,MAAM0P,EAAS,KAAK,SAAW,IAAO,IACtC,WAAW,IAAM,CACf,GAAI,CAAC1P,GAAU,KAAM,OACRlF,EAAsB,sBAAsB,GAEvDkF,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,KAAM2kB,EAAW,MAAAnL,EAAO,CAE5E,EAAGtE,CAAM,CACX,CACF,CACF,IAGA5X,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMyI,EAAOzI,EAAK,CAAC,EAKnB,GAJI,CAACyI,GAAM,MAGMhF,EAAgC,kBAAkB,EACrD,OAEd,MAAMqR,EAAerR,EAAiB,UAAU,EAC1CmW,EAAoBnW,EAAiB,4BAA4B,EACjEqW,EAAWrW,EAAoB,gBAAgB,GAAK,GAG1D,GAAImW,GAAqB,GAAKE,EAASF,CAAiB,GACzCE,EAASF,CAAiB,EAC9B,OAAS,UAAW,CAC3B,MAAMyC,EAAkB5Y,EAAsB,uBAAuB,EAC/DklB,EAAmBllB,EAAiB,2BAA2B,EACjE4Y,GACFzB,GAAYnS,EAAM4T,EAAiB,EAAGsM,CAAgB,EACnD,MAAOroB,GAAeP,EAAI,MAAM,4CAA6CO,CAAC,CAAC,EAIpF,MAAMsX,EAAenU,EAAsB,sBAAsB,EAC3D6Y,EAAW7Y,EAAyC,cAAc,EAClEsb,EAAiBtb,EAAiB,wBAAwB,EAChE,GAAImU,GAAgB0E,GAAYyC,GAAkB,EAAG,CACnD,MAAM6J,EAActM,EAAS,WAAwB,EACrDyB,GAAetV,EAAMmP,EAAcmH,EAAgB6J,CAAU,EAC1D,MAAOtoB,GAAeP,EAAI,MAAM,+CAAgDO,CAAC,CAAC,CACvF,CACF,CAIF,GAAI,CACF,MAAMuoB,EAASpF,EAAA,EAEf,GAAI3O,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,cAAe,CACxF,MAAM8a,EAAQ1D,EAASF,CAAiB,GAAiC,GACnEkP,EAAYtL,EAAK,MAASA,EAAK,MAA2B,MAAQ,KACxE/U,EAAK,KAAK,CACR,KAAMtF,EAAI,KACV,KAAM0lB,EACN,MAAOjP,EACP,KAAMkP,EACN,MAAOhU,EACP,UAAW,KAAK,KAAI,CACrB,CACH,MAAWA,IAAiBpS,EAAU,iBAEpC+F,EAAK,KAAK,CACR,KAAMtF,EAAI,MACV,KAAM0lB,EACN,MAAOjP,EACP,MAAO9E,EACP,UAAW,KAAK,KAAI,CACrB,EAGH/U,EAAI,MAAM,uDAAuD,CACnE,OAASO,EAAG,CACVP,EAAI,KAAK,oCAAqCO,CAAC,CACjD,CACF,IAEAP,EAAI,KAAK,+BAA+B,CAC1C,mdC15CO,SAASgpB,IAAqB,CACnC,MAAMpgB,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEnDulB,IADavlB,EAAiB,qBAAqB,GAAK,GAC/B,GAAK,EACpCwlB,GAAcD,CAAQ,EAEjBrgB,EAEMuc,GACTvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAa,cAAe,MAAO6lB,EAAU,EAFxF7a,EAAU,CAAE,KAAMhL,EAAI,YAAa,MAAO6lB,EAAU,CAIxD,CAEO,SAASC,GAAc5U,EAAc6U,EAAS,GAAY,CAC/DrlB,EAAS,sBAAuBwQ,CAAI,EACpC,MAAM8U,EAAM,SAAS,eAAe,YAAY,EAC3CA,IAELA,EAAI,UAAU,OAAO,SAAU,YAAY,EACvC9U,IAAS,GACX8U,EAAI,UAAU,IAAI,QAAQ,EACtBD,GAAQzoB,EAAI,KAAK,gBAAiB,WAAW,GACxC4T,IAAS,GAClB8U,EAAI,UAAU,IAAI,YAAY,EAC1BD,GAAQzoB,EAAI,KAAK,gBAAiB,YAAY,GAE9CyoB,GAAQzoB,EAAI,KAAK,gBAAiB,UAAU,EAEpD,CAEO,SAAS2oB,IAAsB,CACpC,MAAMzgB,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEnD4lB,EAAc,CADF5lB,EAAkB,oBAAoB,EAExD6lB,GAAWD,CAAW,EAEjB1gB,EAEMuc,GACTvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,gBAAiB,YAAa,eAAgB,MAAOkmB,EAAa,EAF5Flb,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAOkmB,EAAa,CAI5D,CAEO,SAASC,GAAW1U,EAAkBsU,EAAS,GAAY,CAChErlB,EAAS,qBAAsB+Q,CAAO,EACtC,MAAMuU,EAAM,SAAS,eAAe,aAAa,EAC7CA,GAAKA,EAAI,UAAU,OAAO,SAAUvU,CAAO,EAC3CsU,GAAQzoB,EAAI,KAAK,gBAAiBmU,EAAU,SAAW,QAAQ,CACrE,CA6BA,eAAsB2U,GAAU5M,EAA8B,CAC5D,MAAM7C,EAAWrW,EAAyB,gBAAgB,GAAK,GAC/D,GAAIkZ,EAAQ,GAAKA,GAAS7C,EAAS,OAAQ,OAE3CxQ,EAAkB,eAAe,EAGjCzF,EAAS,uBAAwB,EAAK,EAEtC,MAAM8E,EAAWlF,EAAgC,kBAAkB,EAG9DkF,GAAUlI,EAAI,KAAK,gBAAiB,MAAM,EAE/C,MAAM+oB,EAAcvG,GAAA,EAGdlE,EAAiBtb,EAAiB,wBAAwB,EAC1DmU,EAAenU,EAAsB,sBAAsB,EAEjE,GAAIkZ,IAAUoC,GAAkBnH,GAAgB,CAACjP,EAAU,CACzD5I,EAAI,MAAM,gCAAiC4c,CAAK,EAChD9Y,EAAS,6BAA8B8Y,CAAK,EAC5Clc,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BqZ,EAAS6C,CAAK,CAAC,EAGlD,MAAML,EAAW7Y,EAAyC,cAAc,EACpE6Y,GAAU,WAAa,OAAO,SAAS,OAAOA,EAAS,SAAS,CAAC,EACnEzY,EAAS,4BAA6B,OAAOyY,EAAS,SAAS,CAAC,EAEhEzY,EAAS,4BAA6BzB,IAAe,EAGvD8hB,EAAA,EAEA,MAAM1G,EAAO1D,EAAS6C,CAAK,EACrB5B,EAAWyC,GAAM,MAAM,MAAQA,GAAM,MAAQ,SAASb,CAAK,GACjExO,EAAU,CAAE,KAAMhL,EAAI,eAAgB,MAAAwZ,EAAO,KAAM5B,EAAU,KAAMyC,GAAM,MAAM,KAAM,EAErF,MAAM6I,GAAmB1J,EAAO6M,CAAW,EAC3C,MAAMrF,EAAK,CAAC,EACZhW,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAM,EAAG,MAAAwZ,EAAO,KAAM5B,EAAU,EAC5DzF,GAAA,EACA4H,GAAA,EACA,MACF,CAEArZ,EAAS,6BAA8B8Y,CAAK,EAC5Clc,EAAI,KAAK,oBAAoB,EAE7B,MAAM+c,EAAO1D,EAAS6C,CAAK,EAI3B,GAHAlc,EAAI,KAAK,yBAA0B+c,CAAI,EAGnCA,EAAK,OAAS,UAAW,CACtB7U,IACHub,EAAA,EACA/V,EAAU,CACR,KAAMhL,EAAI,aACV,QAASqa,EAAK,QACd,WAAYA,EAAK,WACjB,KAAMA,EAAK,MAAQA,EAAK,MACxB,MAAAb,EACA,SAAU,GACX,EAEwBlZ,EAAkB,yBAAyB,GAElEI,EAAS,0BAA2B,EAAK,EACzCpD,EAAI,KAAK,eAAgB+c,EAAK,QAASA,EAAK,WAAY,EAAK,EAC7D/c,EAAI,KAAK,gBAAiB,gCAAgC,IAE1DA,EAAI,KAAK,eAAgB+c,EAAK,QAASA,EAAK,WAAY,EAAK,EAC7D/c,EAAI,KAAK,gBAAiB,oBAAoB,EAC9CyI,EAAgB,gBAAiB,IAAM,CACrCzI,EAAI,KAAK,mBAAmB,CAC9B,EAAG,GAAI,IAGX,MACF,CAGAyjB,EAAA,EAEA,MAAMlK,EAAOwD,EAAK,KAClB,GAAI,CAACxD,EAAM,CACTja,EAAI,KAAK,+BAAgC4c,CAAK,EAC9C,MACF,CAEA,GAAI,CAAChU,EAAU,CACb,MAAMuR,EAAY9X,GAAA,EAClByB,EAAS,4BAA6BqW,CAAS,EAE/C/L,EAAU,CAAE,KAAMhL,EAAI,aAAc,KAAM6W,EAAK,KAAM,MAAA2C,EAAO,UAAAzC,EAAW,KAAMF,EAAK,KAAM,EACxF,MAAM4L,GAAqB5L,EAAME,EAAW,GAAOsP,CAAW,EAErC/lB,EAAkB,yBAAyB,GAElEI,EAAS,0BAA2B,EAAK,EACzCpD,EAAI,KAAK,gBAAiB,2BAA2B,IAErDA,EAAI,KAAK,gBAAiB,eAAe,EACzCyI,EAAgB,gBAAiB,IAAM,CACrCib,EAAK,CAAC,EACN,MAAMsF,EAAahmB,EAAiB,4BAA4B,EAChE0K,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAM,EAAG,MAAOsmB,EAAY,KAAMzP,EAAK,KAAM,EACzE1E,GAAA,CACF,EAAG,GAAI,EAEX,CACF,CAIO,SAASoU,IAAsB,CACpC,MAAM/gB,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEzD,GAAIkF,GAAY,CAACuc,EAAY,CAC3BzkB,EAAI,KAAK,gBAAiB,gBAAgB,EAC1C,MACF,CAEA,GAAIkI,GAAYuc,EAAY,CAC1Bvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,mBAAoB,EAC9C,MACF,CAIA,GADqBM,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9C,IAAIinB,EAAU,GAEd,GADAlpB,EAAI,KAAK,4BAA8BmpB,GAAqB,CAAED,EAAUC,CAAS,CAAC,EAC9ED,EAAS,MACf,CAEA,MAAM7P,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDmW,EAAoBnW,EAAiB,4BAA4B,EACjE2Z,EAAa3Z,EAAiB,qBAAqB,GAAK,EACxD4Z,EAAY5Z,EAAkB,oBAAoB,EAClDsb,EAAiBtb,EAAiB,wBAAwB,EAEhE,GAAIqW,EAAS,SAAW,EAAG,OAE3B,IAAI+P,EAAY,GAEhB,GAAIzM,IAAe,EACjByM,EAAYjQ,UACHyD,EACT,GAAIvD,EAAS,SAAW,EACtB+P,EAAY,UACH9K,IAAmB,IAAMA,IAAmBnF,GAAqBmF,EAAiBjF,EAAS,OACpG+P,EAAY9K,MAEZ,IACE8K,EAAY,KAAK,MAAM,KAAK,SAAW/P,EAAS,MAAM,QAC/C+P,IAAcjQ,WAGzBiQ,EAAYjQ,EAAoB,EAC5BiQ,GAAa/P,EAAS,OACxB,GAAIsD,IAAe,EACjByM,EAAY,MACP,CACL9pB,EAAI,MAAM,wDAAwD,EAClEmkB,EAAA,EACA/V,EAAU,CAAE,KAAMhL,EAAI,MAAO,KAAM,EAAG,EACtC,MACF,CAIA0mB,IAAc,IAChBN,GAAUM,CAAS,CAEvB,CAIO,SAASC,IAAsB,CACpC,MAAMnhB,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEzD,GAAIkF,GAAY,CAACuc,EAAY,CAC3BzkB,EAAI,KAAK,gBAAiB,gBAAgB,EAC1C,MACF,CAEA,GAAIkI,GAAYuc,EAAY,CAC1Bvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,mBAAoB,EAC9C,MACF,CAEA,MAAM2R,EAAerR,EAAiB,UAAU,EAC1CmW,EAAoBnW,EAAiB,4BAA4B,EAGvE,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9C,IAAIinB,EAAU,GAEd,GADAlpB,EAAI,KAAK,4BAA8BmpB,GAAqB,CAAED,EAAUC,CAAS,CAAC,EAC9ED,EAAS,OAET/P,EAAoB,EAAG2P,GAAU3P,EAAoB,CAAC,KAC3C,CAAC,EAChB,MACF,CAIA,GADY6J,EAAA,EACF,EAAG,CACXU,EAAK,CAAC,EACNhW,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAM,EAAG,MAAOyW,EAAmB,EAC/D,MACF,CAEIA,EAAoB,EAAG2P,GAAU3P,EAAoB,CAAC,KAC3C,CAAC,CAClB,CAIA,SAASmQ,GAAiBliB,EAAqC,CAC7DohB,GAAc,OAAOphB,EAAK,KAAK,GAAK,CAAC,CACvC,CAEA,SAASmiB,GAAkBniB,EAAqC,CAC9DyhB,GAAW,CAAC,CAACzhB,EAAK,KAAK,CACzB,CAEA,SAASoiB,GAAqBpiB,EAAqC,CAEjE,MAAMqiB,EAAW,MAAM,QAAQriB,EAAK,IAAI,EAAIA,EAAK,KAC9C,MAAM,QAAQA,EAAK,QAAQ,EAAIA,EAAK,SAAW,KAClD,GAAI,CAACqiB,EAAU,CACbrmB,EAAS,iBAAkB,EAAE,EAC7BpD,EAAI,KAAK,oBAAoB,EAC7B,MACF,CACAoD,EAAS,iBAAkBqmB,CAAQ,EAGnC,IAAI1Y,EAAM/N,EAAiB,4BAA4B,EACnD,OAAOoE,EAAK,mBAAsB,SACpC2J,EAAM3J,EAAK,kBACF,OAAOA,EAAK,OAAU,WAC/B2J,EAAM3J,EAAK,OAGT2J,GAAO0Y,EAAS,SAAQ1Y,EAAM0Y,EAAS,OAAS,GAChD1Y,EAAM,KAAIA,EAAM,IAChBA,IAAQ,IAAM0Y,EAAS,OAAS,IAAG1Y,EAAM,GAC7C3N,EAAS,6BAA8B2N,CAAG,EAE1C/Q,EAAI,KAAK,oBAAoB,CAC/B,CAEA,SAAS0pB,GAAkBtiB,EAA+BY,EAA4B,CAGpF,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,yDAAyD0I,GAAM,IAAI,EAAE,EAC9E,MACF,CAEA,MAAMkU,EAAQ,OAAO9U,EAAK,KAAK,EACzBiS,EAAWrW,EAAyB,gBAAgB,GAAK,GAC/D,GAAI,CAAC,OAAO,SAASkZ,CAAK,GAAKA,EAAQ,GAAKA,GAAS7C,EAAS,OAAQ,CACpE/Z,EAAI,KAAK,mCAAmC8H,EAAK,KAAK,EAAE,EACxD,MACF,CACA0hB,GAAU5M,CAAK,CACjB,CAEA,SAASyN,GAAuBpW,EAAgCvL,EAA4B,CAE1F,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,uDAAuD0I,GAAM,IAAI,EAAE,EAC5E,MACF,CACAihB,GAAA,EACF,CAEA,SAASW,GAAuBrW,EAAgCvL,EAA4B,CAE1F,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,uDAAuD0I,GAAM,IAAI,EAAE,EAC5E,MACF,CACAqhB,GAAA,EACF,CAEA,SAASQ,GAAqBziB,EAA+BY,EAA4B,CAEvF,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,oDAAoD0I,GAAM,IAAI,EAAE,EACzE,MACF,CAEA,MAAM8hB,EAAK1iB,EAAK,YACVsJ,EAAMtJ,EAAK,MACjB,OAAQ0iB,EAAA,CACN,IAAK,cAAe,CAClB,MAAMlW,EAAO,OAAOlD,CAAG,GAAK,EAC5B8X,GAAc5U,CAAI,EAClBlG,EAAU,CAAE,KAAMhL,EAAI,YAAa,MAAOkR,EAAM,EAChD,KACF,CACA,IAAK,eAAgB,CACnB,MAAMO,EAAU,CAAC,CAACzD,EAClBmY,GAAW1U,CAAO,EAClBzG,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAOyR,EAAS,EACpD,KACF,CAEA,IAAK,KAAM,CACT,MAAM5B,EAAO,SAAS,OAAOnL,EAAK,IAAI,EAAG,EAAE,EACrCwJ,EAAI,WAAW,OAAOF,CAAG,CAAC,EAChCI,GAAMyB,EAAM3B,CAAC,EACblD,EAAU,CAAE,KAAMhL,EAAI,UAAW,KAAA6P,EAAM,MAAO3B,EAAG,EACjD,KACF,CACA,KAAKlO,EAAI,OAAQ,CACf,MAAMkO,EAAI,WAAW,OAAOF,CAAG,CAAC,EAChCa,GAAUX,CAAC,EACXlD,EAAU,CAAE,KAAMhL,EAAI,OAAQ,MAAOkO,EAAG,EACxC,KACF,CACA,IAAK,SAAU,CACb,MAAMA,EAAI,OAAOF,CAAG,EACpBiB,GAAef,CAAC,EAChBlD,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAOkO,EAAG,EAC9C,KACF,CACA,KAAKlO,EAAI,MAAO,CACd,MAAMkO,EAAI,OAAOF,CAAG,EACpBmB,GAAejB,CAAC,EAChBlD,EAAU,CAAE,KAAMhL,EAAI,MAAO,MAAOkO,EAAG,EACvC,KACF,CACA,KAAKlO,EAAI,OAAQ,CACf8N,EAAe,MAAO,OAAOE,CAAG,CAAC,EACjChD,EAAU,CAAE,KAAMhL,EAAI,OAAQ,MAAOgO,EAAK,EAC1C,KACF,CACA,KAAKhO,EAAI,YAAa,CAEpBU,EAAS,mBAAoB,OAAOsN,CAAG,CAAC,EACxChD,EAAU,CAAE,KAAMhL,EAAI,YAAa,MAAOgO,EAAK,EAC/C,KACF,CACA,KAAKhO,EAAI,aAAc,CACrB8N,EAAe,QAAS,OAAOE,CAAG,CAAC,EACnChD,EAAU,CAAE,KAAMhL,EAAI,aAAc,MAAOgO,EAAK,EAChD,KACF,CACA,KAAKhO,EAAI,gBAAiB,CACxB8N,EAAe,WAAY,OAAOE,CAAG,CAAC,EACtChD,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,MAAOgO,EAAK,EACnD,KACF,CACA,KAAKhO,EAAI,cAAe,CACtB8N,EAAe,SAAU,OAAOE,CAAG,CAAC,EACpChD,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAOgO,EAAK,EACjD,KACF,CACA,KAAKhO,EAAI,eAAgB,CACvB8N,EAAe,UAAW,OAAOE,CAAG,CAAC,EACrChD,EAAU,CAAE,KAAMhL,EAAI,eAAgB,MAAOgO,EAAK,EAClD,KACF,EAEJ,CAIA,eAAeqZ,IAA+B,CAE5C,GADiB/mB,EAAgC,kBAAkB,EACrD,CACZhD,EAAI,KAAK,gBAAiB,mBAAmB,EAC7C,MACF,CAEA,GAAI,CACFA,EAAI,KAAK,iBAAkB,GAAM,eAAe,EAChDA,EAAI,KAAK,mBAAoB,CAAC,EAE9B,MAAMuK,EAAa,MAAM,IAAI,QAAQ,CAACoB,EAASC,IAAW,CACxD,MAAMoe,EAAM,IAAI,eAChBA,EAAI,KAAK,MAAOpnB,GAAgB,EAAI,EACpConB,EAAI,aAAe,OAEnBA,EAAI,WAAcvqB,GAAU,CAC1B,GAAIA,EAAM,iBAAkB,CAC1B,MAAMoZ,EAAU,KAAK,MAAOpZ,EAAM,OAASA,EAAM,MAAS,GAAG,EAC7DO,EAAI,KAAK,mBAAoB6Y,CAAO,CACtC,CACF,EAEAmR,EAAI,OAAS,IAAM,CACbA,EAAI,QAAU,KAAOA,EAAI,OAAS,IACpCre,EAAQqe,EAAI,QAAgB,EAE5Bpe,EAAO,IAAI,MAAM,cAAcoe,EAAI,MAAM,EAAE,CAAC,CAEhD,EAEAA,EAAI,QAAU,IAAMpe,EAAO,IAAI,MAAM,eAAe,CAAC,EACrDoe,EAAI,MACN,CAAC,EAEKzQ,EAAO,IAAI,KAAK,CAAChP,CAAI,EAAG3H,GAAgB,CAAE,KAAM,aAAc,EAE9DqnB,EAAyB,CAC7B,KAAM,OACN,KAAA1Q,EACA,KAAMA,EAAK,KACX,MAAO1W,EAAA,EAGHwW,EAAWrW,EAAyB,gBAAgB,GAAK,GAC/DqW,EAAS,KAAK4Q,CAAQ,EACtB7mB,EAAS,iBAAkBiW,CAAQ,EACnCrZ,EAAI,KAAK,oBAAoB,EAE7B,MAAMkqB,EAAW7Q,EAAS,IAAI0D,IAAS,CACrC,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,MAAOA,EAAK,OAASA,EAAK,KAC1B,QAASA,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,MAC/B,EACFrP,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,KAAMwnB,EAAU,EAEvDlqB,EAAI,KAAK,gBAAiB,yBAAyB,EACnDA,EAAI,KAAK,iBAAkB,EAAK,EAEhC8oB,GAAUzP,EAAS,OAAS,CAAC,CAC/B,OAASxZ,EAAY,CACnBP,EAAI,MAAM,oBAAqBO,CAAC,EAChCG,EAAI,KAAK,gBAAiB,aAAcH,EAAY,OAAO,EAAE,EAC7DG,EAAI,KAAK,iBAAkB,EAAK,CAClC,CACF,CAIA,SAASmqB,GAAoBC,EAA8B,CACzD,GAAI,CAACA,GAASA,EAAM,SAAW,EAAG,OAGlC,GADiBpnB,EAAgC,kBAAkB,EACrD,CACZhD,EAAI,KAAK,gBAAiB,uBAAuB,EACjD,MACF,CAEA,MAAMqZ,EAAWrW,EAAyB,gBAAgB,GAAK,GAC/D,IAAIqnB,EAAa,EAEjB,QAAS,EAAI,EAAG,EAAID,EAAM,OAAQ,IAAK,CACrC,MAAM7Q,EAAO6Q,EAAM,CAAC,EACpB,GAAI,CAAC7Q,EAAM,SAEX,MAAM0Q,EAAyB,CAC7B,KAAM,OACN,KAAA1Q,EACA,KAAMA,EAAK,KACX,MAAOA,EAAK,KAAK,QAAQ,YAAa,EAAE,GAE1CF,EAAS,KAAK4Q,CAAQ,EACtBI,GACF,CAEA,GAAIA,IAAe,EAAG,OAEtBjnB,EAAS,iBAAkBiW,CAAQ,EACnCrZ,EAAI,KAAK,oBAAoB,EAE7B,MAAMkqB,EAAW7Q,EAAS,IAAI0D,IAAS,CACrC,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,MAAOA,EAAK,OAASA,EAAK,KAC1B,QAASA,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,MAC/B,EACFrP,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,KAAMwnB,EAAU,EAEvDlqB,EAAI,KAAK,gBAAiB,GAAGqqB,CAAU,UAAU,EAGjD,MAAMhW,EAAerR,EAAiB,UAAU,EAC5C0d,EAAerM,CAAY,GAC7ByU,GAAUzP,EAAS,OAASgR,CAAU,CAE1C,CAIO,SAASC,IAAqB,CACnCziB,EAAiB,CACf,CAACnF,EAAI,WAAW,EAAG4mB,GACnB,CAAC5mB,EAAI,YAAY,EAAG6mB,GACpB,CAAC7mB,EAAI,eAAe,EAAG8mB,GACvB,CAAC9mB,EAAI,QAAQ,EAAG8mB,GAChB,CAAC9mB,EAAI,oBAAoB,EAAGgnB,GAC5B,CAAChnB,EAAI,kBAAkB,EAAGinB,GAC1B,CAACjnB,EAAI,kBAAkB,EAAGknB,GAC1B,CAAClnB,EAAI,eAAe,EAAGmnB,EAAA,CACxB,EAGD7pB,EAAI,GAAG,eAAgB,IAAM,CAE3B,GADiBgD,EAAgC,kBAAkB,EACrD,OAEd,MAAM2Z,EAAa3Z,EAAiB,qBAAqB,GAAK,EACxDmW,EAAoBnW,EAAiB,4BAA4B,EAEnE2Z,IAAe,GACjBrd,EAAI,MAAM,wCAAwC,EAClD,WAAW,IAAMwpB,GAAU3P,CAAiB,EAAG,GAAG,IAElD7Z,EAAI,MAAM,iCAAiC,EAC3C,WAAW,IAAM2pB,GAAA,EAAiB,GAAG,EAEzC,CAAC,EAGDjpB,EAAI,GAAG,sBAAuB,IAAMqpB,GAAA,CAAe,EACnDrpB,EAAI,GAAG,sBAAuB,IAAMipB,GAAA,CAAe,EAGnDjpB,EAAI,GAAG,4BAA6B,IAAIT,IAAoB,CAC1D,MAAMqU,EAAO,OAAOrU,EAAK,CAAC,CAAC,GAAK,EAChCipB,GAAc5U,CAAI,CACpB,IAEA5T,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtDspB,GAAW,CAAC,CAACtpB,EAAK,CAAC,CAAC,CACtB,IAGAS,EAAI,GAAG,iBAAkB,IAAI+nB,IAAqB,CAChDgC,GAAA,CACF,IAGA/pB,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD4qB,GAAoB5qB,EAAK,CAAC,CAAoB,CAChD,IAGAS,EAAI,GAAG,uBAAwB,IAAIT,IAAoB,CACrD,MAAM2c,EAAQ,OAAO3c,EAAK,CAAC,CAAC,EACxB,OAAO,SAAS2c,CAAK,GAAKA,GAAS,MAAaA,CAAK,CAC3D,IAGAlc,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAM2c,EAAQ,OAAO3c,EAAK,CAAC,CAAC,EACxB,OAAO,SAAS2c,CAAK,GAAKA,GAAS,GACrC4M,GAAU5M,CAAK,CAEnB,IAGAlc,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMyI,EAAOzI,EAAK,CAAC,EAKnB,GAJI,GAACyI,GAAM,MAGMhF,EAAgC,kBAAkB,GAGnE,GAAI,CAEF,MAAM2Z,EAAa3Z,EAAiB,qBAAqB,GAAK,EAC9DgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,YAAa,MAAOia,EAAY,EAGtD,MAAMC,EAAY5Z,EAAkB,oBAAoB,EACxDgF,EAAK,KAAK,CAAE,KAAMtF,EAAI,aAAc,MAAOka,EAAW,EAItD,MAAMsN,GADWlnB,EAAyB,gBAAgB,GAAK,IACrC,IAAI+Z,IAAS,CACrC,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,MAAOA,EAAK,OAASA,EAAK,KAC1B,QAASA,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,MAC/B,EACF/U,EAAK,KAAK,CAAE,KAAMtF,EAAI,gBAAiB,KAAMwnB,EAAU,EAEvD5qB,EAAI,MAAM,uDAAuD,CACnE,OAASO,EAAG,CACVP,EAAI,KAAK,oCAAqCO,CAAC,CACjD,CACF,IAEAP,EAAI,KAAK,wBAAwB,CACnC,CC/rBO,SAASirB,GAA2BxN,EAAiC,CAC1E,GAAI,EAAE,iBAAkB,YAAc,CAACA,EAAM,OAE7C,IAAIyN,EAAQzN,EAAK,MAAQA,EAAK,OAAS,gBACvC,MAAM0N,EAAS1N,EAAK,OAAS,UAAY,UAAY,aACrD,IAAI2N,EAAwB,GAE5B,GAAI3N,EAAK,OAAS,UAAW,CAC3B,MAAM4N,EAAyB3nB,EAAiB,yBAAyB,GAAK,GAC9E,GAAI+Z,EAAK,YAAc4N,IAA2B,GAAI,CAEpD,MAAMC,GADS5nB,EAA8D,qBAAqB,GAAK,IAChF+Z,EAAK,UAAU,EAClC6N,GAAS,SAASD,CAAsB,EAC1CH,EAAQI,EAAQ,OAAOD,CAAsB,EAE7CH,EAAQ,GAAGzN,EAAK,OAAS,UAAU,KAAK4N,EAAyB,CAAC,GAEtE,CAEA,MAAME,EAAS9N,EAA4C,UACvD8N,IACFH,EAAU,CAAC,CAAE,IAAKG,EAAiB,MAAO,UAAW,KAAM,aAAc,EAE7E,MACEH,EAAU,CAAC,CAAE,IAAK,cAAe,MAAO,UAAW,KAAM,gBAAiB,EAG5E,UAAU,aAAa,SAAW,IAAI,cAAc,CAClD,MAAAF,EACA,OAAAC,EACA,MAAO,aACP,QAAAC,CAAA,CACD,CACH,CAIO,SAASI,IAAyB,CACvC,GAAI,EAAE,iBAAkB,WAAY,OACpCxrB,EAAI,MAAM,gDAAgD,EAE1D,MAAMyrB,EAAY,IAAe,CAC/B,MAAM7iB,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACzD,MAAO,CAAC,EAAEkF,GAAY,CAACuc,EACzB,EAEA,UAAU,aAAa,iBAAiB,OAAQ,IAAM,CACpD,GAAI,CAAAsG,IACJ,GAAI,CACF,MAAM1W,EAAerR,EAAiB,UAAU,EAChD,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9CuiB,GAAA,EACA,MACF,CAC0BxhB,EAAiB,4BAA4B,GAC9C,GAAKqR,IAAiBpS,EAAU,MACvDuiB,GAAA,CAEJ,MAAQ,CACN,GAAI,CAAEA,GAAA,CAAc,MAAQ,CAAa,CAC3C,CACF,CAAC,EAED,UAAU,aAAa,iBAAiB,QAAS,IAAM,CACrD,GAAI,CAAAuG,IACJ,GAAI,CACF,MAAM1W,EAAerR,EAAiB,UAAU,EAC3C0d,EAAerM,CAAY,GAAGmQ,GAAA,CACrC,MAAQ,CACN,GAAI,CACF,MAAMsF,EAAK9mB,EAAiB,UAAU,EACjC0d,EAAeoJ,CAAE,GAAGtF,GAAA,CAC3B,MAAQ,CAAa,CACvB,CACF,CAAC,EAED,UAAU,aAAa,iBAAiB,gBAAiB,IAAM,CAC7DxkB,EAAI,KAAK,qBAAqB,CAChC,CAAC,EAED,UAAU,aAAa,iBAAiB,YAAa,IAAM,CACzDA,EAAI,KAAK,qBAAqB,CAChC,CAAC,EAED,UAAU,aAAa,iBAAiB,eAAiBgrB,GAAY,CACnEpG,GAAS,EAAEoG,EAAQ,YAAc,GAAG,CACtC,CAAC,EAED,UAAU,aAAa,iBAAiB,cAAgBA,GAAY,CAClEpG,GAASoG,EAAQ,YAAc,EAAE,CACnC,CAAC,EAED,GAAI,CACF,UAAU,aAAa,iBAAiB,OAAQ,IAAM,CACpDrG,GAAA,CACF,CAAC,CACH,OAAS9kB,EAAY,CACnBP,EAAI,MAAM,wCAA0CO,EAAY,OAAO,CACzE,CAGAG,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxDgrB,GAA2BhrB,EAAK,CAAC,CAAiB,CACpD,IAEAD,EAAI,KAAK,4BAA4B,CACvC,CC5GA,MAAM2rB,GAAiB,CACrB,mFACA,2CACF,EAEO,SAASC,GAAsBlL,EAA4B,CAChE,UAAWmL,KAAWF,GAAgB,CACpC,MAAMG,EAAQpL,EAAI,MAAMmL,CAAO,EAC/B,GAAIC,EAAO,OAAOA,EAAM,CAAC,CAC3B,CACA,OAAO,IACT,CAEO,SAASC,GAAyBrL,EAA4B,CACnE,MAAMoL,EAAQpL,EAAI,MAAM,2BAA2B,EACnD,OAAOoL,EAAQA,EAAM,CAAC,EAAI,IAC5B,CAIA,MAAME,OAAwB,IACxBC,OAAsB,IAE5B,eAAsBC,GAAiBxL,EAAqC,CAC1E,MAAMjgB,EAAM,OAAOigB,GAAO,EAAE,EAC5B,GAAI,CAACjgB,EAAK,OAAO,KAEjB,GAAIurB,GAAkB,IAAIvrB,CAAG,EAAG,OAAOurB,GAAkB,IAAIvrB,CAAG,EAChE,GAAIwrB,GAAgB,IAAIxrB,CAAG,EAAG,OAAOwrB,GAAgB,IAAIxrB,CAAG,EAE5D,MAAMqI,GAAK,SAAoC,CAC7C,GAAI,CACF,MAAMqjB,EAAY,sCAAsC,mBAAmB1rB,CAAG,CAAC,eACzE2rB,EAAW,MAAM,MAAMD,CAAS,EACtC,GAAI,CAACC,EAAS,GAAI,OAAO,KACzB,MAAMtkB,EAAO,MAAMskB,EAAS,OAE5B,OADetkB,GAAQ,OAAOA,EAAK,OAAU,SAAYA,EAAK,MAAM,OAAS,KAC7D,IAClB,OAASvH,EAAG,CACV,OAAAP,EAAI,KAAK,iCAAkCO,CAAC,EACrC,IACT,SACE0rB,GAAgB,OAAOxrB,CAAG,CAC5B,CACF,KAEAwrB,GAAgB,IAAIxrB,EAAKqI,CAAC,EAC1B,MAAMtI,EAAS,MAAMsI,EACrB,OAAItI,GAAQwrB,GAAkB,IAAIvrB,EAAKD,CAAM,EACtCA,CACT,CAIA,IAAI6rB,GAAyD,KAEtD,SAASC,GAAoB5L,EAAmB,CACrD,MAAM6L,EAAmB,SAAS,eAAe,iBAAiB,EAC5DC,EAAa,SAAS,eAAe,wBAAwB,EAC7DC,EAAU,SAAS,eAAe,kBAAkB,EAE1D,GAAI,CAACF,GAAoB,CAACC,EAAY,OAEtC,MAAME,EAAqB7X,GAA2B,CAC/C4X,IACLA,EAAQ,SAAW,CAAC5X,EACpB4X,EAAQ,MAAM,QAAU5X,EAAU,IAAM,MAC1C,EAIA,GAFIwX,iBAA+BA,EAAgB,EAE/C,CAAC3L,GAAOA,EAAI,SAAW,GAAI,CAC7B6L,EAAiB,MAAM,QAAU,OACjCC,EAAW,MAAM,QAAU,QAC3BA,EAAW,UAAY,0BACvBA,EAAW,MAAM,MAAQ,kBACzBE,EAAkB,EAAK,EACvB,MACF,CAEA,MAAMC,EAAUf,GAAsBlL,CAAG,EACnCkM,EAAab,GAAyBrL,CAAG,EAE/C,GAAI,CAACiM,GAAW,CAACC,EAAY,CAC3BL,EAAiB,MAAM,QAAU,OACjCC,EAAW,MAAM,QAAU,QAC3BA,EAAW,UAAY,uBACvBA,EAAW,MAAM,MAAQ,UACzBE,EAAkB,EAAK,EACvB,MACF,CAEAF,EAAW,MAAM,QAAU,QAC3BA,EAAW,UAAY,kBACvBA,EAAW,MAAM,MAAQ,kBACzBE,EAAkB,EAAK,EAEvBL,GAAmB,WAAW,SAAY,CACxC,GAAI,CACF,MAAMQ,EAAY,sCAAsC,mBAAmBnM,CAAG,CAAC,eACzE0L,EAAW,MAAM,MAAMS,CAAS,EACtC,GAAI,CAACT,EAAS,GAAI,MAAM,IAAI,MAAM,iBAAiB,EACnD,MAAMtkB,EAAO,MAAMskB,EAAS,OAEtBb,EAAQ,SAAS,eAAe,uBAAuB,EACvDL,EAAQ,SAAS,eAAe,uBAAuB,EACvD4B,EAAO,SAAS,eAAe,yBAAyB,EAC1DvB,IAAOA,EAAM,IAAMzjB,EAAK,eACxBojB,IAAOA,EAAM,UAAYpjB,EAAK,OAC9BglB,IAAMA,EAAK,UAAYhlB,EAAK,aAEhCykB,EAAiB,MAAM,QAAU,QACjCC,EAAW,MAAM,QAAU,OAC3BE,EAAkB,EAAI,CACxB,OAASnsB,EAAG,CACVP,EAAI,MAAM,2BAA4BO,CAAC,EACvCgsB,EAAiB,MAAM,QAAU,OACjCC,EAAW,MAAM,QAAU,QAC3BA,EAAW,UAAY,oBACvBA,EAAW,MAAM,MAAQ,UACzBE,EAAkB,EAAK,CACzB,CACF,EAAG,GAAG,CACR,CAKA,MAAMK,OAAkB,IACxB,IAAIC,GAAiD,KAQrD,eAAsBC,GAAuBL,EAAoBM,EAA8B,CAK7F,GAJI,GAACA,GAAOA,EAAI,SAAW,GAIvB,EAFWxpB,EAA+D,qBAAqB,GAAK,IACpFkpB,CAAU,IAG1B,CAAAG,GAAY,IAAIH,CAAU,EAC9B,CAAAG,GAAY,IAAIH,EAAY,EAAI,EAEhC5sB,EAAI,MAAM,qDAAqD4sB,CAAU,KAAKM,EAAI,MAAM,SAAS,EAEjG,GAAI,CACF,QAASlpB,EAAI,EAAGA,EAAIkpB,EAAI,OAAQlpB,IAAK,CAGnC,MAAMmpB,GADazpB,EAA+D,qBAAqB,GAAK,IAC7EkpB,CAAU,EACzC,GAAI,CAACO,EAAa,MAGlB,GAAI,CAAAA,EAAY,OAAOnpB,CAAC,EAExB,IAAI,CACF,MAAM2oB,EAAUO,EAAIlpB,CAAC,EACfooB,EAAW,MAAM,MACrB,sCAAsC,mBAAmB,mCAAqCO,CAAO,CAAC,gBAExG,GAAI,CAACP,EAAS,GAAI,SAClB,MAAMgB,EAAO,MAAMhB,EAAS,OAE5B,GAAIgB,GAAQA,EAAK,MAAO,CAEtB,MAAMC,EAAW3pB,EAA+D,qBAAqB,GAAK,GACrG2pB,EAAST,CAAU,IAAGS,EAAST,CAAU,EAAI,CAAE,IAAK,GAAI,OAAQ,EAAC,GACtES,EAAST,CAAU,EAAE,OAAO5oB,CAAC,EAAIopB,EAAK,MACtCtpB,EAAS,sBAAuB,CAAE,GAAGupB,EAAU,EAE/CrtB,EAAI,MAAM,iCAAiCgE,CAAC,MAAMopB,EAAK,KAAK,EAAE,EAG1DJ,iBAAuBA,EAAQ,EACnCA,GAAW,WAAW,IAAMtsB,EAAI,KAAK,oBAAoB,EAAG,GAAG,EAG9CgD,EAAgC,kBAAkB,GAEjE0K,EAAU,CACR,KAAMhL,EAAI,yBACV,WAAAwpB,EACA,OAAQ5oB,EACR,MAAOopB,EAAK,MACb,CAEL,CACF,OAAS7sB,EAAG,CACVP,EAAI,KAAK,4CAA4CktB,EAAIlpB,CAAC,CAAC,IAAKzD,CAAC,CACnE,CAGA,MAAM,IAAI,QAAQoa,GAAK,WAAWA,EAAG1X,GAAM,KAAK,CAAC,EACnD,CACF,SACE8pB,GAAY,OAAOH,CAAU,CAC/B,EACF,CC9LA,IAAIU,EAAsB,KACtBC,GAA2B,EAC3BC,GAAmB,GACnBC,GAAuD,KACvDC,GAAgC,KAG7B,SAASC,IAAwB,CACtC,OAAOL,CACT,CAIO,SAASM,GACdjB,EACAC,EAA4B,KAC5BiB,EAAW,GACXC,EAAW,EACL,CACNC,GAAoB,EACpBR,KACA,MAAM3E,EAAmB2E,GAEzB7sB,EAAI,KAAK,uBAAuB,EAChCghB,GAAc,SAAS,EAEvBhhB,EAAI,KAAK,gBAAiB,oCAAoC,EAE9D,MAAMJ,EAAU,SAAS,cAAc,gBAAgB,EACvD,GAAI,CAACA,EAAS,CACZN,EAAI,KAAK,oCAAoC,EAC7C,MACF,CAEA,IAAIguB,EAAY,SAAS,eAAe,0BAA0B,EAC7DA,IACHA,EAAY,SAAS,cAAc,KAAK,EACxCA,EAAU,GAAK,2BACfA,EAAU,MAAM,QAAU,8CAC1B1tB,EAAQ,YAAY0tB,CAAS,GAG1BV,IACHU,EAAU,UAAY,mCAGxB,MAAMC,EAAI,OACV,GAAI,CAACA,EAAE,IAAM,CAAEA,EAAE,GAA+B,OAAQ,CACtD,GAAI,CAACT,GAAkB,CACrBA,GAAmB,GACnB,MAAMzQ,EAAM,SAAS,cAAc,QAAQ,EAC3CA,EAAI,IAAM,qCACVA,EAAI,OAAS,IAAM/c,EAAI,MAAM,6BAA6B,EAC1D+c,EAAI,QAAU,IAAM,CAClB/c,EAAI,MAAM,qCAAqC,EAC/CwtB,GAAmB,GACnB9sB,EAAI,KAAK,gBAAiB,+BAA+B,CAC3D,EACA,SAAS,KAAK,YAAYqc,CAAG,CAC/B,CACAkR,EAAE,wBAA0B,IAAM,CAC/BA,EAA8B,kBAAoB,GACnDC,GAAkBvB,EAASC,EAAYiB,EAAUC,CAAQ,CAC3D,CACF,MACEI,GAAkBvB,EAASC,EAAYiB,EAAUC,CAAQ,EAIvDL,iBAA6BA,EAAc,EAC/CA,GAAiB,WAAW,IAAM,CAC5BF,KAA6B3E,GAAoB,CAAC0E,IACpDttB,EAAI,KAAK,mCAAmC,EAC5CU,EAAI,KAAK,iBAAkB,EAAK,EAChCA,EAAI,KAAK,gBAAiB,8BAA8B,EAE5D,EAAG,IAAK,EAERA,EAAI,KAAK,oBAAqB,EAAI,EAElC,MAAMytB,EAAQ,SAAS,cAAc,iBAAiB,EAClDA,GAAOA,EAAM,MAAM,YAAY,UAAW,OAAQ,WAAW,EAEjE,WAAW,IAAMC,GAAA,EAAyB,GAAG,EAC7CpuB,EAAI,MAAM,oBAAqB2sB,GAAWC,EAAY,YAAaiB,CAAQ,CAC7E,CAIA,SAASK,GACPvB,EACAC,EAA4B,KAC5BiB,EAAW,GACXC,EAAW,EACL,CAEN,GADqBpqB,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9C3C,EAAI,KAAK,oEAAoE,EAC7E,MACF,CAEA,GAAIstB,GAAgB,cAAe,CACjCttB,EAAI,MAAM,6CAA6C,EACvD,GAAI,CACE4sB,EACFU,EAAe,aAAa,CAAE,KAAMV,EAAY,SAAU,WAAY,MAAOkB,EAAU,aAAc,EAAG,EAC/FnB,GACTW,EAAe,cAAcX,CAAO,EAEjCkB,GAAUP,EAAe,aAC9B,MACF,OAAS/sB,EAAG,CACVP,EAAI,KAAK,kDAAmDO,CAAC,EAC7D,MAAMytB,EAAY,SAAS,eAAe,0BAA0B,EAChEA,MAAqB,UAAY,kCACvC,CACF,CAGA,MAAMK,EAAkC,CACtC,SAAUR,EAAW,EAAI,EACzB,SAAU,EACV,IAAK,EACL,eAAgB,EAChB,YAAa,EACb,OAAQ,OAAO,SAAS,QAGtBjB,IACFyB,EAAW,SAAW,WACtBA,EAAW,KAAOzB,GAIpB,MAAM0B,EAAqC,CACzC,MAAO,OACP,OAAQ,OACR,WAAAD,EACA,OAAQ,CACN,QAASE,GACT,cAAeC,EAAA,CACjB,EAGE7B,MAAuB,QAAUA,GAErCW,EAAiB,IAAI,GAAG,OAAO,iBAAkBgB,CAAa,CAChE,CAIA,SAASC,IAA6B,CAIpC,GAHAvuB,EAAI,MAAM,wBAAwB,EAEb0D,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9C3C,EAAI,MAAM,gDAAgD,EAC1D,MACF,CAGAuJ,EAAkB,eAAe,EACjCJ,EAAgB,gBAAiBslB,GAAiB,IAAK,CAAE,SAAU,GAAM,EAGzEllB,EAAkB,iBAAiB,EAClB7F,EAAgC,kBAAkB,GAEjEyF,EAAgB,kBAAmB,IAAM,CACvCzI,EAAI,KAAK,wBAAwB,CACnC,EAAG,IAAM,CAAE,SAAU,GAAM,EAI7BA,EAAI,KAAK,4BAA4B,CACvC,CAEA,SAAS8tB,GAA2BruB,EAA+B,CAEjE,GADqBuD,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,OAEhD,MAAM0e,EAAQlhB,EAAM,KAEhBkhB,IAAU,GAAG,YAAY,SAC3BqN,GAAuB,EAAK,EAC5BhuB,EAAI,KAAK,uBAAwB,EAAI,GAC5B2gB,IAAU,GAAG,YAAY,OAClC3gB,EAAI,KAAK,uBAAwB,EAAK,EAC7B2gB,IAAU,GAAG,YAAY,QAClCvd,EAAS,WAAYnB,EAAU,IAAI,EACnCjC,EAAI,KAAK,uBAAwBiC,EAAU,IAAI,EAC/C4G,EAAkB,eAAe,EAEhB7F,EAAgC,kBAAkB,IAEjE1D,EAAI,MAAM,wCAAwC,EAClDU,EAAI,KAAK,qBAAqB,IAM9B,CADagD,EAAgC,kBAAkB,GAClD4pB,GAAgB,gBAC/Blf,EAAU,CACR,KAAMhL,EAAI,cACV,MAAAie,EACA,KAAMiM,EAAe,iBACrB,SAAUA,EAAe,sBAAwB,GAClD,CAEL,CASA,IAAIS,GAAoB,EACpBY,GAAuB,GAE3B,SAASF,IAAwB,CAC/B,MAAM1Z,EAAerR,EAAiB,UAAU,EAChD,GAAI,GAAC4pB,GAAkBvY,IAAiBpS,EAAU,iBAAmB,CAAC2qB,EAAe,gBAErF,GAAI,CACF,MAAMsB,EAActB,EAAe,iBAC7BuB,EAAcvB,EAAe,iBAAmB,EAChDwB,EAAcxB,EAAe,sBAAwB,GACrDjM,EAAQiM,EAAe,oBAAsB,GAG/C3sB,KAAW0gB,IAAU,GAAKA,IAAU,KACjCqM,KAAgBA,GAAiB,KAAK,OACvC,KAAK,MAAQA,GAAiB,KAChCgB,GAAuB,EAAI,GAG7BhB,GAAiB,KAIfoB,IAAgBH,KAClBA,GAAuBG,EACvBf,GAAoB,GAIlBc,EAAc,GAAKd,KAAsB,IAC3CA,GAAoBc,GAGlBd,GAAoB,GACtBrtB,EAAI,KAAK,iBAAkB6iB,GAAQqL,CAAW,EAAGrL,GAAQwK,EAAiB,EAAGa,EAAab,EAAiB,CAE/G,MAAQ,CAER,CACF,CAIA,SAASW,GAAuBK,EAAqB,CACnD,MAAMC,EAAY,2BAClB,IAAInY,EAAU,SAAS,eAAemY,CAAS,EAE/C,GAAID,EAAM,CACR,GAAI,CAAClY,EAAS,CACZA,EAAU,SAAS,cAAc,KAAK,EACtCA,EAAQ,GAAKmY,EACbnY,EAAQ,MAAM,QAAU;AAAA;AAAA;AAAA;AAAA;AAAA,QAMxBA,EAAQ,QAAU,IAAM,CAClByW,GAAgB,YAClBA,EAAe,YACfoB,GAAuB,EAAK,EAEhC,EACA7X,EAAQ,UAAY;AAAA;AAAA;AAAA;AAAA;AAAA,QAMpB,MAAMvW,EAAU,SAAS,cAAc,gBAAgB,EACnDA,GAASA,EAAQ,YAAYuW,CAAO,CAC1C,CACAA,EAAQ,MAAM,QAAU,MAC1B,MAAWA,IACTA,EAAQ,MAAM,QAAU,OACxB6W,GAAiB,KAErB,CAIA,SAASU,IAA8B,CACrC,MAAMJ,EAAY,SAAS,eAAe,0BAA0B,EAC9DjZ,EAAerR,EAAiB,UAAU,EAChD,GAAI,CAACsqB,GAAajZ,IAAiBpS,EAAU,gBAAiB,OAE9D3C,EAAI,MAAM,yDAAyD,EACnE,MAAMivB,EAASjB,EAAU,cAAc,QAAQ,EAE/CA,EAAU,MAAM,QAAU,OACrBA,EAAU,aACfA,EAAU,MAAM,QAAU,QAEtBiB,IACFA,EAAO,MAAM,WAAa,SACrBA,EAAO,aACZA,EAAO,MAAM,WAAa,WAG5B,OAAO,cAAc,IAAI,MAAM,QAAQ,CAAC,CAC1C,CAIO,SAASC,IAAwB,CAEtC,GADqBxrB,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,OAchD,GAZAorB,GAAoB,EACpBjqB,EAAS,WAAYnB,EAAU,IAAI,EACnCjC,EAAI,KAAK,uBAAwBiC,EAAU,IAAI,EAE/C4G,EAAkB,eAAe,EACjCA,EAAkB,iBAAiB,EAE/BkkB,KACF,aAAaA,EAAc,EAC3BA,GAAiB,MAGfH,EAAgB,CAClB,GAAI,CACFttB,EAAI,MAAM,yCAAyC,EACnDstB,EAAe,YACX,OAAOA,EAAe,SAAY,cAA2B,SACnE,OAAS/sB,EAAY,CACnBP,EAAI,MAAM,0CAA4CO,EAAY,OAAO,CAC3E,CACA+sB,EAAiB,IACnB,CAEA,MAAMU,EAAY,SAAS,eAAe,0BAA0B,EAChEA,MAAqB,UAAY,IAErC,MAAM3mB,EAAU,SAAS,eAAe,YAAY,EAChDA,IACFA,EAAQ,QACRA,EAAQ,IAAM,GACdA,EAAQ,MAAM,QAAU,OACxBA,EAAQ,QAGV,MAAM8mB,EAAQ,SAAS,cAAc,iBAAiB,EAClDA,IACFA,EAAM,MAAM,eAAe,SAAS,EACpCA,EAAM,MAAM,QAAU,IAIxB,MAAMgB,EAAa,SAAS,eAAe,aAAa,EACpDA,GAAYA,EAAW,UAAU,OAAO,cAAc,EAC1D,MAAMC,EAAkB,SAAS,eAAe,wBAAwB,EACpEA,KAAiC,SAErC1uB,EAAI,KAAK,oBAAoB,EAC7BV,EAAI,MAAM,wBAAwB,CACpC,CAIA,SAASqvB,GAAkBvnB,EAAqC,CAC9D,MAAM6kB,EAAU7kB,EAAK,QACf8kB,EAAa9kB,EAAK,WAClB8U,EAAQ9U,EAAK,MACb+lB,EAAW/lB,EAAK,SAElB8U,IAAU,QACZ9Y,EAAS,6BAA8B8Y,CAAK,EAG9CgR,GAAiBjB,EAASC,EAAYiB,GAAY,EAAK,CACzD,CAEA,SAASyB,GAAyBrb,EAAgCvL,EAA4B,CAE5F,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,wDAAwD0I,GAAM,IAAI,EAAE,EAC7E,MACF,CAEI4kB,GAAgB,YAClBA,EAAe,YACflf,EAAU,CACR,KAAMhL,EAAI,cACV,MAAO,EACP,KAAMkqB,EAAe,oBAAsB,EAC5C,GAEL,CAEA,SAASiC,GAA0Btb,EAAgCvL,EAA4B,CAE7F,GADiB,CAAAhF,EAAgC,kBAAkB,EAGnE,IAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,yDAAyD0I,GAAM,IAAI,EAAE,EAC9E,MACF,CAEI4kB,GAAgB,aAClBA,EAAe,aACflf,EAAU,CACR,KAAMhL,EAAI,cACV,MAAO,EACP,KAAMkqB,EAAe,oBAAsB,EAC5C,GAEL,CAEA,SAASkC,GAA4B1nB,EAA+BY,EAA4B,CAE9F,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,GAAI,CAACqF,EAAeL,CAAI,EAAG,CACzB1I,EAAI,KAAK,4DAA4D0I,GAAM,IAAI,EAAE,EACjF,MACF,CAEA,MAAM+mB,EAAS3nB,EAAK,OAChBwlB,GAAgB,aAAe,OAAOmC,GAAW,UACnDnC,EAAe,YAAYmC,CAAM,CAErC,CAMA,SAASC,GAAiC5nB,EAA+BY,EAA6B,CAEpG,GADiBhF,EAAgC,kBAAkB,EACrD,OAEd,MAAMisB,EAAM7nB,EAAK,WACjB,GAAI,CAAC6nB,GAAO,CAACjnB,EAAM,OAEnB,MAAMknB,EAASlsB,EAA8D,qBAAqB,GAAK,GACnGksB,EAAOD,CAAG,GACZjnB,EAAK,KAAK,CACR,KAAMtF,EAAI,sBACV,WAAYusB,EACZ,IAAKC,EAAOD,CAAG,EAAE,KAAO,GACxB,OAAQC,EAAOD,CAAG,EAAE,QAAU,EAAC,CAChC,CAEL,CAIO,SAASE,IAAoB,CAClCtnB,EAAiB,CACf,CAACnF,EAAI,YAAY,EAAGisB,GACpB,CAACjsB,EAAI,oBAAoB,EAAGksB,GAC5B,CAAClsB,EAAI,qBAAqB,EAAGmsB,GAC7B,CAACnsB,EAAI,wBAAwB,EAAGosB,GAChC,CAACpsB,EAAI,6BAA6B,EAAGssB,EAAA,CACtC,EAGDhvB,EAAI,GAAG,qBAAsB,IAAMwuB,GAAA,EAAgB,EAEnDxuB,EAAI,GAAG,gBAAiB,IAAIT,IAAoB,CAC9C,KAAM,CAAC0sB,EAASC,EAAYiB,CAAQ,EAAI5tB,EACxC2tB,GAAiBjB,EAAmBC,EAA6BiB,CAAmB,CACtF,IAEAntB,EAAI,GAAG,uBAAwB,IAAM,CACnC,MAAMkI,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAEzD,GAAIkF,GAAYuc,EAAY,CAE1B,GAAI,CACYmI,GAAgB,qBAChB,GAAG,YAAY,QAC3B1kB,EAAS,KAAK,CAAE,KAAMxF,EAAI,sBAAuB,EAEjDwF,EAAS,KAAK,CAAE,KAAMxF,EAAI,qBAAsB,CAEpD,OAAS7C,EAAG,CACVP,EAAI,MAAM,6BAA8BO,CAAC,CAC3C,CACA,MACF,CAGA,GAAK+sB,EACL,GAAI,CACYA,EAAe,mBACf,GAAG,YAAY,SAC3BA,EAAe,aACflf,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAO,EAAG,KAAMkqB,EAAe,iBAAkB,IAEtFA,EAAe,YACflf,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAO,EAAG,KAAMkqB,EAAe,iBAAkB,EAE1F,OAAS/sB,EAAG,CACVP,EAAI,MAAM,+BAAgCO,CAAC,CAC7C,CACF,IAEAG,EAAI,GAAG,qBAAsB,IAAM,CAC7B4sB,GAAgB,YAClBA,EAAe,YACf5sB,EAAI,KAAK,wBAAwB,EAErC,IAEAA,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtD,MAAM6vB,EAAK7vB,EAAK,CAAC,EACjB,GAAI,OAAO6vB,GAAO,WAChB,GAAI,CACF,MAAMjM,EAAMyJ,GAAgB,oBAAsB,EAClDwC,EAAG,OAAOjM,GAAQ,UAAY,SAASA,CAAG,GAAKA,GAAO,EAAIA,EAAM,CAAC,CACnE,MAAQ,CACNiM,EAAG,CAAC,CACN,CAEJ,IAEApvB,EAAI,GAAG,yBAA0B,IAAM,CACrC,GAAK4sB,EACL,GAAI,CACFA,EAAe,YACf,GAAI,CAAEA,EAAe,OAAO,EAAG,EAAI,CAAG,MAAQ,CAAa,CAC3Dlf,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAO,EAAG,KAAM,EAAG,CAC1D,OAAS,EAAG,CACVpD,EAAI,MAAM,wBAAyB,CAAC,CACtC,CACF,IAEAU,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CACnD,MAAMwjB,EAAM,OAAOxjB,EAAK,CAAC,CAAC,GAAK,EAC/B,GAAKqtB,EACL,GAAI,CACF,MAAMzpB,EAAUypB,EAAe,iBACzBxJ,EAAWwJ,EAAe,cAChC,IAAI/H,EAAS1hB,EAAU4f,EACnB8B,EAAS,IAAGA,EAAS,GACrBA,EAASzB,IAAUyB,EAASzB,GAChCwJ,EAAe,OAAO/H,EAAQ,EAAI,EAClCnX,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAOkqB,EAAe,iBAAkB,KAAM/H,EAAQ,CAC7F,OAAShlB,EAAG,CACVP,EAAI,MAAM,6BAA8BO,CAAC,CAC3C,CACF,IAGAG,EAAI,GAAG,mBAAoB,IAAIT,IAAoB,CACjD,MAAMojB,EAAO,OAAOpjB,EAAK,CAAC,CAAC,EAC3B,GAAI,GAACqtB,GAAgB,QAAU,CAAC,OAAO,SAASjK,CAAI,GACpD,GAAI,CACFiK,EAAe,OAAOjK,EAAM,EAAI,EACf3f,EAAgC,kBAAkB,GAEjE0K,EAAU,CACR,KAAMhL,EAAI,cACV,MAAOkqB,EAAe,oBAAsB,EAC5C,KAAAjK,CAAA,CACD,CAEL,OAAS9iB,EAAG,CACVP,EAAI,MAAM,wBAAyBO,CAAC,CACtC,CACF,IAEAG,EAAI,GAAG,6BAA8B,IAAIT,IAAoB,CAC3D,MAAM6vB,EAAK7vB,EAAK,CAAC,EACjB,GAAI,CAACqtB,GAAgB,aAAe,OAAOwC,GAAO,WAAY,CAAEA,EAAG,EAAK,EAAG,MAAQ,CACnF,GAAI,CACF,MAAM5C,EAAMI,EAAe,eAAiB,GACtC7b,EAAM6b,EAAe,mBAC3B,GAAIJ,EAAI,OAAS,GAAKzb,EAAMyb,EAAI,OAAS,EAAG,CAC1CI,EAAe,YACfwC,EAAG,EAAI,EACP,MACF,CACF,MAAQ,CAAa,CACrBA,EAAG,EAAK,CACV,IAEApvB,EAAI,GAAG,6BAA8B,IAAIT,IAAoB,CAC3D,MAAM6vB,EAAK7vB,EAAK,CAAC,EACjB,GAAI,CAACqtB,GAAkB,OAAOwC,GAAO,WAAY,CAAEA,EAAG,EAAK,EAAG,MAAQ,CACtE,GAAI,CAEF,GADoBxC,EAAe,iBACjB,EAAG,CACnBA,EAAe,OAAO,EAAG,EAAI,EAC7Blf,EAAU,CAAE,KAAMhL,EAAI,cAAe,MAAOkqB,EAAe,iBAAkB,KAAM,EAAG,EACtFwC,EAAG,EAAI,EACP,MACF,CACA,MAAM5C,EAAMI,EAAe,iBAAmB,GACxC7b,EAAM6b,EAAe,sBAAwB,GACnD,GAAIJ,EAAI,OAAS,GAAKzb,EAAM,EAAG,CAC7B6b,EAAe,gBACfwC,EAAG,EAAI,EACP,MACF,CACF,MAAQ,CAAa,CACrBA,EAAG,EAAK,CACV,IAEApvB,EAAI,GAAG,0BAA2B,IAAM,CAEtCgW,GAAA,+BAAAqZ,EAAA,EAAkB,QAAE,KAAKnZ,GAAOA,EAAI,sBAAsB,CAC5D,IAGAlW,EAAI,GAAG,mBAAoB,IAAIT,IAAoB,CACjD,MAAMygB,EAAMzgB,EAAK,CAAC,EAClBqsB,GAAoB5L,GAAO,EAAE,CAC/B,IAGAhgB,EAAI,GAAG,2BAA4B,IAAM,CACvC,MAAMsvB,EAAQ,SAAS,eAAe,mBAAmB,EACzD,GAAI,CAACA,EAAO,OACZ,MAAMtP,EAAMsP,EAAM,MAAM,OACxB,GAAI,CAACtP,EAAK,CACRhgB,EAAI,KAAK,gBAAiB,mBAAmB,EAC7C,MACF,CAEA,MAAMisB,EAAUf,GAAsBlL,CAAG,EACnCkM,EAAab,GAAyBrL,CAAG,EAE/C,GAAI,CAACiM,GAAW,CAACC,EAAY,CAC3BlsB,EAAI,KAAK,gBAAiB,sBAAsB,EAChD,MACF,CAGA,MAAMmW,EAAU,SAAS,eAAe,qBAAqB,EACzDA,GAASA,EAAQ,UAAU,OAAO,QAAQ,EAC9CmZ,EAAM,MAAQ,GACd,MAAMC,EAAY,SAAS,eAAe,iBAAiB,EACvDA,IAAWA,EAAU,MAAM,QAAU,QACzC,MAAMC,EAAW,SAAS,eAAe,wBAAwB,EAC7DA,IAAYA,EAAS,MAAM,QAAU,GAAIA,EAAS,YAAc,wBACpE,MAAMzD,EAAU,SAAS,eAAe,kBAAkB,EACtDA,MAAiB,SAAW,IAGhC,MAAM1S,EAAWrW,EAAyB,gBAAgB,GAAK,GAIzDysB,EADe,SAAS,eAAe,uBAAuB,GACpC,WAAW,QAAUzP,EAE/CiK,EAAyB,CAC7B,KAAM,UACN,KAAMwF,EACN,MAAOA,EACP,QAASxD,GAAW,OACpB,WAAYC,GAAc,QAG5B7S,EAAS,KAAK4Q,CAAQ,EACtB7mB,EAAS,iBAAkBiW,CAAQ,EACnC,MAAMqW,EAAWrW,EAAS,OAAS,EAOnC,GANAjW,EAAS,6BAA8BssB,CAAQ,EAC/C1vB,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BiqB,CAAQ,EAIvC,CADajnB,EAAgC,kBAAkB,EACpD,CACb,MAAMknB,EAAW7Q,EAAS,IAAI0D,IAAS,CACrC,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,MAAOA,EAAK,OAASA,EAAK,KAC1B,QAASA,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,MAC/B,EACFrP,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,KAAMwnB,EAAU,EACvDxc,EAAU,CACR,KAAMhL,EAAI,aACV,QAAAupB,EACA,WAAAC,EACA,MAAOwD,EACP,SAAU,GACX,CACH,CAEAxC,GAAiBjB,EAASC,EAAY,EAAI,EAG1CV,GAAiBxL,CAAG,EAAE,KAAKwK,GAAS,CAC9BA,GAASnR,EAASqW,CAAQ,IAC5BrW,EAASqW,CAAQ,EAAE,KAAOlF,EAC1BnR,EAASqW,CAAQ,EAAE,MAAQlF,EAC3BpnB,EAAS,iBAAkB,CAAC,GAAGiW,CAAQ,CAAC,EACxCrZ,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BqZ,EAASqW,CAAQ,CAAC,EAEzD,CAAC,CACH,IAGA1vB,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD,MAAM8V,EAAK,OAAO9V,EAAK,CAAC,CAAC,EACzB,GAAI,GAACqtB,GAAgB,QAAU,CAAC,OAAO,SAASvX,CAAE,GAClD,GAAI,CACF,MAAMlS,EAAUypB,EAAe,iBAC/BA,EAAe,OAAOzpB,EAAWkS,EAAK,IAAO,EAAI,CACnD,OAASxV,EAAG,CACVP,EAAI,MAAM,yBAA0BO,CAAC,CACvC,CACF,IAGAG,EAAI,GAAG,2BAA4B,IAAM,CACvC0tB,GAAA,CACF,IAGA1tB,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD,MAAMqH,EAAM,OAAOrH,EAAK,CAAC,CAAC,EACtBqtB,GAAgB,WAAa,OAAO,SAAShmB,CAAG,GAClDgmB,EAAe,UAAUhmB,CAAG,CAEhC,IAGA5G,EAAI,GAAG,oBAAqB,IAAIT,IAAoB,CAClD,MAAM6uB,EAAc,OAAO7uB,EAAK,CAAC,CAAC,EAC5BwvB,EAAS,OAAOxvB,EAAK,CAAC,CAAC,EACvBowB,EAAYpwB,EAAK,CAAC,EAEnBqtB,IAED+C,EAEE/C,EAAe,cACjBA,EAAe,YAAYmC,CAAM,EACjCrhB,EAAU,CACR,KAAMhL,EAAI,cACV,MAAO,EACP,KAAM,EACN,SAAUqsB,CAAA,CACX,GAIH/uB,EAAI,KAAK,sBAAuBouB,CAAW,EAG/C,IAGApuB,EAAI,GAAG,8BAA+B,IAAIT,IAAoB,CAC5D,MAAM2sB,EAAa3sB,EAAK,CAAC,EACzB,GAAI,CAAC2sB,EAAY,OAEjB,IAAIM,EAAgB,GAGpB,MAAMnT,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDmW,EAAoBnW,EAAiB,4BAA4B,EACjE4sB,EAAcvW,EAASF,CAAiB,EAE9C,GAAIyT,GAAgB,aAAegD,GAAa,aAAe1D,EAC7D,GAAI,CACFM,EAAMI,EAAe,eAAiB,EACxC,MAAQ,CAAwC,CAIlD,MAAMsC,EAASlsB,EAA8D,qBAAqB,GAAK,GACnGwpB,EAAI,OAAS,IACV0C,EAAOhD,CAAU,GAEX,CAACgD,EAAOhD,CAAU,EAAE,KAAOgD,EAAOhD,CAAU,EAAE,IAAI,SAAW,KACtEgD,EAAOhD,CAAU,EAAE,IAAMM,GAFzB0C,EAAOhD,CAAU,EAAI,CAAE,IAAAM,EAAK,OAAQ,EAAC,EAIvCppB,EAAS,sBAAuB,CAAE,GAAG8rB,EAAQ,GAI/C,MAAMW,EAAgB7sB,EAA8D,qBAAqB,GAAK,GAC1G6sB,EAAc3D,CAAU,GAAG,KAAK,OAAS,GAC3CK,GAAuBL,EAAY2D,EAAc3D,CAAU,EAAE,GAAG,EAIlE,MAAMhkB,EAAWlF,EAAgC,kBAAkB,EAC/DkF,IACE,CAAC2nB,EAAc3D,CAAU,GAAK,CAAC2D,EAAc3D,CAAU,EAAE,KAAO2D,EAAc3D,CAAU,EAAE,IAAI,SAAW,IAC3GhkB,EAAS,KAAK,CAAE,KAAMxF,EAAI,8BAA+B,WAAAwpB,EAAY,EAIzElsB,EAAI,KAAK,oBAAoB,CAC/B,IAGAA,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMygB,EAAMzgB,EAAK,CAAC,EAClB,GAAI,CAACygB,EAAK,OAIV,GADiBhd,EAAgC,kBAAkB,EACrD,CACZhD,EAAI,KAAK,gBAAiB,wBAAwB,EAClD,MACF,CAEA,MAAMisB,EAAUf,GAAsBlL,CAAG,EACnCkM,EAAab,GAAyBrL,CAAG,EAC/C,GAAI,CAACiM,GAAW,CAACC,EAAY,CAC3BlsB,EAAI,KAAK,gBAAiB,oBAAoB,EAC9C,MACF,CAGAA,EAAI,KAAK,sBAAsB,EAG/B,MAAMqZ,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDinB,EAAyB,CAC7B,KAAM,UACN,KAAMjK,EACN,MAAOA,EACP,QAASiM,GAAW,OACpB,WAAYC,GAAc,QAE5B7S,EAAS,KAAK4Q,CAAQ,EACtB7mB,EAAS,iBAAkBiW,CAAQ,EACnC,MAAMqW,EAAWrW,EAAS,OAAS,EACnCjW,EAAS,6BAA8BssB,CAAQ,EAC/C1vB,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BiqB,CAAQ,EAG3C,MAAMC,EAAW7Q,EAAS,IAAI0D,IAAS,CACrC,KAAMA,EAAK,KACX,KAAMA,EAAK,KACX,MAAOA,EAAK,OAASA,EAAK,KAC1B,QAASA,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,MAC/B,EACFrP,EAAU,CAAE,KAAMhL,EAAI,gBAAiB,KAAMwnB,EAAU,EACvDxc,EAAU,CACR,KAAMhL,EAAI,aACV,QAAAupB,EACA,WAAAC,EACA,MAAOwD,EACP,SAAU,GACX,EAEDxC,GAAiBjB,EAASC,EAAY,EAAI,EAG1CV,GAAiBxL,CAAG,EAAE,KAAKwK,GAAS,CAC9BA,GAASnR,EAASqW,CAAQ,IAC5BrW,EAASqW,CAAQ,EAAE,KAAOlF,EAC1BnR,EAASqW,CAAQ,EAAE,MAAQlF,EAC3BpnB,EAAS,iBAAkB,CAAC,GAAGiW,CAAQ,CAAC,EACxCrZ,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BqZ,EAASqW,CAAQ,CAAC,EAEzD,CAAC,CACH,IAGA1vB,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMyI,EAAOzI,EAAK,CAAC,EAQnB,GAPI,CAACyI,GAAM,MAGMhF,EAAgC,kBAAkB,GAG9CA,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,OAEhD,MAAMoX,EAAWrW,EAAyB,gBAAgB,GAAK,GACzDmW,EAAoBnW,EAAiB,4BAA4B,EACjE+Z,EAAO1D,EAASF,CAAiB,EAEvC,GAAI,GAAC4D,GAAQA,EAAK,OAAS,WAE3B,GAAI,CACF,IAAI+S,EAAS,EACTC,EAAU,EAEd,GAAI,CACEnD,GAAgB,iBAAgBkD,EAASlD,EAAe,kBACxDA,GAAgB,iBAAgBmD,EAAUnD,EAAe,iBAC/D,MAAQ,CAAoB,CAE5B,MAAMO,EAAY4C,IAAY,EACxBC,EAAkBhtB,EAAiB,yBAAyB,GAAK,GACjE+rB,EAAUiB,GAAmB,EAAKA,EAAkB,EAG1DhoB,EAAK,KAAK,CACR,KAAMtF,EAAI,aACV,QAASqa,EAAK,SAAW,KACzB,WAAYA,EAAK,YAAc,KAC/B,KAAMA,EAAK,MAAQA,EAAK,MACxB,MAAO5D,EACP,SAAAgU,EACA,SAAU4B,CAAA,CACX,EAGD/mB,EAAK,KAAK,CACR,KAAMtF,EAAI,aACV,KAAMotB,EACN,MAAOC,EACP,SAAUhB,CAAA,CACX,EAEDzvB,EAAI,MAAM,qDAAqD,CACjE,OAASO,EAAG,CACVP,EAAI,KAAK,mCAAoCO,CAAC,CAChD,CACF,IAEAP,EAAI,KAAK,8BAA8B,CACzC,CCv7BO,SAAS2wB,IAA6B,CAC3C,MAAMC,EAASjD,GAAA,EACT/kB,EAAWlF,EAAgC,kBAAkB,EACnE,GAAI,GAACktB,GAAUhoB,GAAY,CAACgoB,EAAO,gBAEnC,GAAI,CACF,MAAMhC,EAAcgC,EAAO,iBACrBvP,EAAQuP,EAAO,eAAiBA,EAAO,iBAAmB,GAGhE,GAAIA,EAAO,iBAAkB,CAC3B,MAAMC,EAAOD,EAAO,mBACdvF,EAAyB3nB,EAAiB,yBAAyB,GAAK,GAE9E,GAAImtB,IAASxF,EAAwB,CACnCvnB,EAAS,0BAA2B+sB,CAAI,EAExC,MAAM9W,EAAWrW,EAAoB,gBAAgB,GAAK,GACpDmW,EAAoBnW,EAAiB,4BAA4B,EACjE4sB,EAAcvW,EAASF,CAAiB,EAE9C,GAAIyW,GAAa,WAAY,CAC3B,MAAMX,EAAMW,EAAY,WAGxB,GAAIM,EAAO,YACT,GAAI,CACF,MAAM1D,EAAM0D,EAAO,cACnB,GAAI1D,GAAK,OAAS,EAAG,CACnB,MAAM0C,EAASlsB,EAA8D,qBAAqB,GAAK,IACnG,CAACksB,EAAOD,CAAG,GAAK,CAACC,EAAOD,CAAG,EAAE,KAAK,UACpCC,EAAOD,CAAG,EAAI,CAAE,IAAAzC,EAAK,OAAQ0C,EAAOD,CAAG,GAAG,QAAU,EAAC,EACrD7rB,EAAS,sBAAuB,CAAE,GAAG8rB,EAAQ,EAEjD,CACF,MAAQ,CAAa,CAIvB,GAAIgB,EAAO,aAAc,CACvB,MAAME,EAAQF,EAAO,eACrB,GAAIE,GAAO,MAAO,CAChB,MAAMlB,EAASlsB,EAA8D,qBAAqB,GAAK,GAClGksB,EAAOD,CAAG,IAAGC,EAAOD,CAAG,EAAI,CAAE,IAAK,GAAI,OAAQ,EAAC,GAChDC,EAAOD,CAAG,EAAE,OAAOkB,CAAI,IAAMC,EAAM,QACrClB,EAAOD,CAAG,EAAE,OAAOkB,CAAI,EAAIC,EAAM,MACjChtB,EAAS,sBAAuB,CAAE,GAAG8rB,EAAQ,EAC7CxhB,EAAU,CACR,KAAMhL,EAAI,yBACV,WAAYusB,EACZ,OAAQkB,EACR,MAAOC,EAAM,MACd,EAEL,CACF,CACF,CAEApwB,EAAI,KAAK,oBAAoB,EAC7BA,EAAI,KAAK,yBAA0BqZ,EAASF,CAAiB,CAAC,CAChE,CACF,CAEAzL,EAAU,CACR,KAAMhL,EAAI,aACV,KAAMwrB,EACN,MAAAvN,EACA,SAAU3d,EAAiB,yBAAyB,GAAK,GAC1D,CACH,MAAQ,CAER,CACF,CAIA,SAASqtB,GAAkBjpB,EAAqC,CAC9D,MAAM8oB,EAASjD,GAAA,EACT5Y,EAAerR,EAAiB,UAAU,EAChD,GAAI,GAACktB,GAAU7b,IAAiBpS,EAAU,iBAAmB,CAACiuB,EAAO,gBAErE,GAAI,CACF,MAAMxI,EAAW,OAAOtgB,EAAK,IAAI,GAAK,EAChCkpB,EAAY,OAAOlpB,EAAK,KAAK,EAC7BmpB,EAAenpB,EAAK,SAGpB4oB,EAAkBhtB,EAAiB,yBAAyB,GAAK,GACvE,GAAIutB,IAAiB,QAAaA,IAAiB,IAAMA,IAAiBP,EAAiB,CACzF1wB,EAAI,MAAM,oCAAoC0wB,CAAe,OAAOO,CAAY,EAAE,EAClFntB,EAAS,0BAA2BmtB,CAAY,EAE5CL,EAAO,aAAeA,EAAO,kBAC3BA,EAAO,qBAAuBK,GAChCL,EAAO,YAAYK,CAAY,EAInCvwB,EAAI,KAAK,oBAAoB,EAC7B,MAAMqZ,EAAWrW,EAAoB,gBAAgB,GAAK,GACpDmW,EAAoBnW,EAAiB,4BAA4B,EACvEhD,EAAI,KAAK,yBAA0BqZ,EAASF,CAAiB,CAAC,CAChE,CAGA,MAAM/C,EAAcpT,EAAiB,kBAAkB,GAAK,EACtDqT,EAAiBrT,EAAiB,qBAAqB,GAAK,EAC5D4kB,EAAkBF,EAAWrR,EAAiBD,EAE9C8X,EAAcgC,EAAO,iBACrBhL,EAAQ,KAAK,IAAIgJ,EAActG,CAAe,EAQpD,GANI1C,EAAQ,GAAKgL,EAAO,SACtB5wB,EAAI,MAAM,wBAAwB4lB,EAAM,QAAQ,CAAC,CAAC,iBAAiB0C,EAAgB,QAAQ,CAAC,CAAC,GAAG,EAChGsI,EAAO,OAAOtI,EAAiB,EAAI,GAIjCsI,EAAO,gBAAkBA,EAAO,WAAaA,EAAO,WAAY,CAClE,MAAMH,EAAUG,EAAO,iBACnBI,IAAc,GAAKP,IAAY,IAAU,YACpCO,IAAc,GAAKP,IAAY,KAAU,YACpD,CACF,OAASlwB,EAAG,CACVP,EAAI,MAAM,wBAAyBO,CAAC,CACtC,CACF,CAIA,SAAS2wB,GAAmBppB,EAAqC,CAC/D,MAAM8oB,EAASjD,GAAA,EACT5Y,EAAerR,EAAiB,UAAU,EAChD,GAAI,GAACktB,GAAU7b,IAAiBpS,EAAU,iBAE1C,GAAI,CACF,MAAM0e,EAAQ,OAAOvZ,EAAK,KAAK,EACzBub,EAAO,OAAOvb,EAAK,IAAI,GAAK,EAE9BuZ,IAAU,GAAKuP,EAAO,WACpBA,EAAO,QAAQA,EAAO,OAAOvN,EAAM,EAAI,EAC3CuN,EAAO,aACEvP,IAAU,GAAKuP,EAAO,aAC/BA,EAAO,aACHA,EAAO,QAAQA,EAAO,OAAOvN,EAAM,EAAI,EAE/C,OAAS9iB,EAAG,CACVP,EAAI,MAAM,yBAA0BO,CAAC,CACvC,CACF,CAIA,SAAS4wB,GAAqBrpB,EAAqC,CACjE,MAAM8kB,EAAa9kB,EAAK,WAClB2nB,EAAS3nB,EAAK,OACdojB,EAAQpjB,EAAK,MAEnB,GAAI,CAAC8kB,GAAc6C,IAAW,QAAa,CAACvE,EAAO,OAEnD,MAAM0E,EAASlsB,EAA8D,qBAAqB,GAAK,GAClGksB,EAAOhD,CAAU,IAAGgD,EAAOhD,CAAU,EAAI,CAAE,IAAK,GAAI,OAAQ,EAAC,GAClEgD,EAAOhD,CAAU,EAAE,OAAO6C,CAAM,EAAIvE,EACpCpnB,EAAS,sBAAuB,CAAE,GAAG8rB,EAAQ,EAE7ClvB,EAAI,KAAK,oBAAoB,EAE7B,MAAMqZ,EAAWrW,EAAoB,gBAAgB,GAAK,GACpDmW,EAAoBnW,EAAiB,4BAA4B,EACjE4sB,EAAcvW,EAASF,CAAiB,EACxC6W,EAAkBhtB,EAAiB,yBAAyB,GAAK,GACnE4sB,GAAa,aAAe1D,GAAc8D,IAAoBjB,GAChE/uB,EAAI,KAAK,yBAA0B4vB,CAAW,CAElD,CASA,SAASc,GAA0BtpB,EAAqC,CACtE,MAAM8kB,EAAa9kB,EAAK,WAClBolB,EAAMplB,EAAK,IACXupB,EAASvpB,EAAK,OAEpB,GAAI,CAAC8kB,EAAY,OAEjB,MAAMgD,EAASlsB,EAA8D,qBAAqB,GAAK,GACvGksB,EAAOhD,CAAU,EAAI,CAAE,IAAKM,GAAO,GAAI,OAAQmE,GAAU,EAAC,EAC1DvtB,EAAS,sBAAuB,CAAE,GAAG8rB,EAAQ,EAC7ClvB,EAAI,KAAK,oBAAoB,EAGzBwsB,GAAOA,EAAI,OAAS,GACtBD,GAAuBL,EAAYM,CAAG,CAE1C,CAIA,SAASoE,IAA0B,CACjCtxB,EAAI,MAAM,wDAAwD,EAC7C0D,EAAiB,UAAU,IAC3Bf,EAAU,iBAC7BjC,EAAI,KAAK,mBAAmB,EAE9BA,EAAI,KAAK,uBAAuB,CAClC,CAIO,SAAS6wB,IAAwB,CACtChpB,EAAiB,CACf,CAACnF,EAAI,YAAY,EAAG2tB,GACpB,CAAC3tB,EAAI,aAAa,EAAG8tB,GACrB,CAAC9tB,EAAI,wBAAwB,EAAG+tB,GAChC,CAAC/tB,EAAI,qBAAqB,EAAGguB,GAC7B,CAAChuB,EAAI,YAAY,EAAGkuB,EAAA,CACrB,EAEDtxB,EAAI,KAAK,4BAA4B,CACvC,gJCxOA,IAAIwxB,GAA4C,KAEzC,SAASC,GAAkBtJ,EAA4B,CAC5D,GAAI,CAAE,SAAgD,oBAAqB,CACzEA,EAAA,EACA,MACF,CAEA,GAAIqJ,KAAyB,KAAM,CACjC,MAAME,EAAQF,GACdA,GAAuB,IAAM,CAAEE,EAAA,EAASvJ,EAAA,CAAY,EACpD,MACF,CAEAqJ,GAAuBrJ,EACvB,QAAQ,UAAU,KAAK,IAAM,CAC3B,MAAM2H,EAAK0B,GAEX,GADAA,GAAuB,KACnB,CAAC1B,EAAI,OACT,IAAI6B,EAAW,GACf,GAAI,CACD,SAAqE,oBAAoB,IAAM,CAC9FA,EAAW,GACX7B,EAAA,CACF,CAAC,CACH,MAAQ,CACD6B,GAAU7B,EAAA,CACjB,CACF,CAAC,CACH,CAIA,MAAM8B,GAAkB,UAClBC,GAAoB,WACpBC,GAA2C,CAC/C,IAAK,QACL,IAAK,OACL,IAAK,OACL,IAAK,SACL,IAAK,OACP,EAEO,SAASC,GAAWhuB,EAAwB,CACjD,GAAIA,GAAU,KAA6B,MAAO,GAClD,MAAMiuB,EAAM,OAAOjuB,CAAK,EACxB,OAAK6tB,GAAgB,KAAKI,CAAG,EACtBA,EAAI,QAAQH,GAAoBI,GAAOH,GAAiBG,CAAE,GAAKA,CAAE,EADjCD,CAEzC,CAEO,MAAME,GAAaH,GAInB,SAASI,GAAuBC,EAAoB,CACzD,MAAMnb,EAAK,SAAS,eAAe,aAAa,EAC3CA,IAELA,EAAG,UAAU,OAAO,SAAS,EAC7BA,EAAG,MAAM,UAAY,OACrBA,EAAG,UAAYmb,EACfnb,EAAG,gBAAgB,WAAW,EAE9BA,EAAG,MAAM,eAAe,kBAAkB,EAC1CA,EAAG,MAAM,eAAe,oBAAoB,EAE5C,WAAW,IAAM,CACf,MAAMob,EAASpb,EAAG,cAClB,GAAI,CAACob,EAAQ,OAEb,MAAMC,EAAgBrb,EAAG,YAAcob,EAAO,YACxCE,EAAe,EAAED,EAAgB,IAEvC,GAAIA,EAAgB,EAAG,CACrBrb,EAAG,UAAU,IAAI,SAAS,EAC1BA,EAAG,MAAM,YAAY,mBAAoB,GAAGsb,CAAY,IAAI,EAI5D,MAAMC,EADkB,KAAK,IAAID,CAAY,EAD/B,GAEyB,EAAI,EAC3Ctb,EAAG,MAAM,YAAY,qBAAsB,GAAGub,CAAa,GAAG,EAC9Dvb,EAAG,MAAM,UAAY,EACvB,CACF,EAAG,GAAG,EACR,CAIA,eAAsBwb,GAAoBL,EAAgC,CACxE,GAAI,CACF,GAAI,UAAU,WAAa,UAAU,UAAU,UAC7C,aAAM,UAAU,UAAU,UAAUA,CAAI,EACjC,GAGT,MAAMM,EAAK,SAAS,cAAc,UAAU,EAC5CA,EAAG,MAAQN,EACXM,EAAG,MAAM,SAAW,QACpBA,EAAG,MAAM,KAAO,UAChB,SAAS,KAAK,YAAYA,CAAE,EAC5BA,EAAG,SACH,MAAMC,EAAK,SAAS,YAAY,MAAM,EACtC,gBAAS,KAAK,YAAYD,CAAE,EACrBC,CACT,OAASpyB,EAAG,CACV,OAAAP,EAAI,KAAK,2BAA4BO,CAAC,EAC/B,EACT,CACF,CAkBA,MAAMqyB,GAAe,CAAC,gBAAiB,uBAAwB,qBAAqB,EAE7E,SAASC,IAA+B,CAC7C,GAAI,CACF,MAAMC,EAAYF,GAAa,KAAMpwB,GAAO,CAC1C,MAAMyU,EAAK,SAAS,eAAezU,CAAE,EACrC,MAAO,CAAC,EAAEyU,GAAMA,EAAG,UAAU,SAAS,QAAQ,EAChD,CAAC,EACG,SAAS,MAAM,SAAS,KAAK,UAAU,OAAO,eAAgB6b,CAAS,CAC7E,MAAQ,CAAe,CACzB,CAEO,SAASC,IAAgC,CAC9C,GAAI,CACF,MAAMC,EAAM,IAAI,iBAAiB,IAAMH,IAAwB,EAC/DD,GAAa,QAASpwB,GAAO,CAC3B,MAAMyU,EAAK,SAAS,eAAezU,CAAE,EACjCyU,GAAI+b,EAAI,QAAQ/b,EAAI,CAAE,WAAY,GAAM,gBAAiB,CAAC,OAAO,EAAG,CAC1E,CAAC,CACH,MAAQ,CAAe,CAEvB4b,GAAA,CACF,CCrJA,IAAII,GAA8C,SAC9CC,GAAiCC,GAAA,EAIrC,MAAMC,GAAkC,CACtC,aAAc,yBACd,yBAA0B,4CAC1B,gBAAiB,yBACjB,qBAAsB,kCACtB,gBAAiB,oCACjB,wBAAyB,uCACzB,SAAU,eACV,kBAAmB,gCACnB,4BAA6B,qDAC7B,6BAA8B,6CAC9B,2BAA4B,8CAC5B,4BAA6B,0DAC7B,oBAAqB,0BACrB,mBAAoB,+BACpB,aAAc,mBACd,UAAW,mBACX,WAAY,WACZ,WAAY,YACZ,wBAAyB,+BACzB,wBAAyB,+BACzB,UAAW,mBACX,6BAA8B,iDAC9B,eAAgB,qBAChB,oCAAqC,6DACrC,8BAA+B,2CAC/B,gCAAiC,yDACjC,qCAAsC,gEACtC,+BAAgC,4CAChC,gBAAiB,qBACjB,uCAAwC,oEACxC,iCAAkC,uDAClC,mBAAoB,4BACpB,mCAAoC,0CACpC,gBAAiB,yBACjB,gBAAiB,2BACjB,eAAgB,yBAChB,iCAAkC,gCAClC,4CAAuD,+EACvD,gCAAqD,0CACrD,YAAa,yBACb,gBAAiB,2BACjB,gBAAiB,gCACjB,iBAAkB,+BAClB,qBAAsB,8BACtB,GAAM,YACN,6BAA8B,qDAC9B,wBAAyB,+BACzB,QAAS,iBACT,yBAA0B,8CAC1B,0BAA2B,wCAC3B,uBAAwB,4CACxB,GAAM,aACN,oBAAqB,sCACrB,iBAAkB,gCAClB,gBAAiB,+BACjB,gBAAiB,iCACjB,SAAU,aACV,2BAA4B,uCAC5B,WAAY,eACZ,4BAA6B,gDAC7B,cAAe,kBACf,WAAY,eACZ,WAAY,eACZ,SAAU,WACV,qBAAsB,uCACtB,KAAQ,OACR,GAAM,QACN,6BAA8B,4CAC9B,0BAA2B,8CAC3B,qCAAsC,8DACtC,cAAe,sBACf,uCAAwC,+DACxC,gBAAiB,wBACjB,kBAAmB,qCACnB,QAAS,OACT,QAAS,aACT,KAAQ,OACR,GAAM,OACN,GAAM,QACN,YAAa,oBACb,mBAAoB,+BACpB,0BAA2B,wCAC3B,gBAAiB,wBACjB,4BAA6B,uDAC7B,IAAO,OACP,YAAa,aACb,IAAO,OACP,SAAU,gBACV,0BAA2B,iCAC3B,WAAY,eACZ,2BAA4B,kDAC5B,IAAO,QACP,KAAQ,WACR,aAAc,qBACd,WAAY,oBACZ,mBAAoB,6BACpB,YAAa,kBACb,aAAc,mBACd,cAAe,4BACf,UAAW,iBACX,SAAU,aACV,YAAa,eACb,YAAa,mBACb,UAAW,kBACX,aAAc,qBACd,sBAAuB,wCACvB,yBAA0B,sCAC1B,6BAA8B,qDAC9B,kBAAmB,+BACnB,qBAAsB,yCACtB,UAAW,aACX,IAAO,UACP,UAAW,eACX,YAAa,oBACb,GAAM,OACN,aAAc,aACd,wBAAyB,yCACzB,mBAAoB,sCACpB,SAAU,uCACV,2BAA4B,wCAC5B,YAAa,iBACb,uCAAwC,uCACxC,SAAU,WACV,SAAU,aACV,WAAY,aACZ,SAAU,YACV,eAAgB,oBAChB,GAAM,MACN,WAAY,qBACZ,WAAY,cACZ,YAAa,cACb,aAAc,cACd,QAAS,aACT,QAAS,YACT,cAAe,+BACf,MAAO,QACP,sBAAuB,+BACvB,yBAA0B,uCAC1B,sBAAuB,2BACvB,yBAA0B,uCAC1B,GAAM,YACN,qBAAsB,mCACtB,YAAa,gBACb,QAAS,gBACT,IAAO,UACP,wCAAyC,6DACzC,qCAAsC,6CACtC,KAAQ,UACR,KAAQ,YACR,YAAa,mBACb,eAAgB,6BAChB,QAAS,aACT,GAAM,WACN,WAAY,kBACZ,eAAgB,0BAChB,aAAc,kBACd,gBAAiB,0BACjB,WAAY,sBACZ,SAAU,eACV,SAAU,cACV,WAAY,aACZ,cAAe,0BACf,YAAa,wBACb,IAAO,SACP,KAAQ,QACR,eAAgB,mBAChB,GAAM,OACN,yBAA0B,+BAC1B,cAAe,gBACf,UAAW,eACX,gBAAiB,gBACjB,gBAAiB,4BACjB,KAAQ,SACR,cAAe,IACf,uBAAwB,IACxB,aAAc,IACd,kBAAmB,sCACnB,GAAM,OACN,YAAa,wBACb,cAAe,uBACf,mBAAoB,yBACpB,aAAc,uBACd,yBAA0B,8CAC1B,QAAS,oBACT,kBAAmB,yCACnB,WAAY,+BACZ,UAAW,gBACX,eAAgB,qBAChB,iBAAkB,oCAClB,wBAAyB,qDACzB,iCAAkC,oEAClC,IAAO,YACP,eAAgB,4BAChB,YAAa,eACb,aAAc,uBACd,4CAA6C,0DAC7C,YAAa,mBACb,eAAgB,wBAChB,kBAAmB,wBACnB,oBAAqB,2BACrB,MAAO,IACP,cAAe,uBACf,eAAgB,oBAChB,kBAAmB,+BACnB,oCAAqC,sDACrC,oBAAqB,oCACrB,uCAAwC,wDACxC,4CAA6C,6DAC7C,UAAW,gBACX,WAAY,iBACZ,aAAc,6BACd,SAAU,eACV,UAAW,gBACX,sBAAuB,+CACvB,wBAAyB,uCACzB,iBAAkB,gCAClB,iBAAkB,yBAClB,cAAe,+BACf,iBAAkB,8BAClB,qBAAsB,uBACtB,gBAAiB,eACjB,uBAAwB,2BACxB,UAAW,IACX,eAAgB,yBAChB,oBAAqB,gCACrB,QAAS,6BACT,sBAAuB,wCACvB,WAAY,iBACZ,QAAS,WACT,QAAS,iBACT,qBAAsB,kCACtB,gBAAiB,wBACjB,KAAQ,QACR,QAAS,gBACT,iBAAkB,0BAClB,eAAgB,qBAChB,kBAAmB,gCACnB,UAAW,mBACX,QAAS,OACT,WAAY,OACZ,WAAY,gBACZ,UAAW,aACX,KAAQ,WACR,kBAAmB,uBACnB,WAAY,kBACZ,UAAW,oBACX,GAAM,OACN,cAAe,oBACf,WAAY,YACZ,wBAAyB,kDACzB,SAAU,iBACV,UAAW,kBACX,sBAAuB,uCACvB,IAAO,QACP,OAAQ,SACR,KAAQ,oBACR,YAAa,aACb,UAAW,WACX,yCAA0C,+DAC1C,YAAa,aACb,GAAM,OACN,QAAS,aACT,YAAa,sBACb,QAAS,YACT,YAAa,iBACb,iBAAkB,2BAClB,QAAS,cACT,iBAAkB,8BAClB,kBAAmB,sCACnB,IAAO,QACP,QAAS,cACT,gBAAiB,0BACjB,gBAAiB,qBACjB,6BAA8B,qDAC9B,SAAU,iBACV,mBAAoB,uCACpB,GAAM,SACN,sBAAuB,wCACvB,eAAgB,4BAChB,GAAM,QACN,aAAc,qBACd,eAAgB,gBAChB,0BAA2B,sCAC3B,gBAAiB,sBACjB,4BAA6B,kCAC7B,uBAAwB,sCACxB,kBAAmB,qCACnB,wBAAyB,sCACzB,eAAgB,wBAChB,KAAQ,SACR,UAAW,cACX,gBAAiB,2BACjB,cAAe,oBACf,iBAAkB,oCAClB,KAAQ,gDACR,KAAQ,YACR,mBAAoB,qDACpB,uCAAwC,oEACxC,wBAAyB,4CACzB,iBAAkB,iCAClB,iBAAkB,iCAClB,qBAAsB,8BACtB,iBAAkB,4BAClB,oCAAqC,oDACrC,eAAgB,mCAChB,mBAAoB,yBACpB,WAAY,qBACZ,GAAM,KACN,UAAW,eACX,wCAAyC,0EACzC,uCAAwC,0EACxC,IAAO,SACT,EAMMC,GAA0C,CAC9C,CAAC,sBAAuB,CAACC,EAAI1mB,IAAS,gBAAgBA,CAAI,EAAE,EAC5D,CAAC,4CAA6C,CAAC0mB,EAAIC,EAAK3mB,IAAS,sBAAsB2mB,CAAG,kBAAkB3mB,CAAI,EAAE,EAClH,CAAC,mBAAoB,CAAC0mB,EAAIC,IAAQ,CAChC,MAAM,EAAI,OAAOA,CAAG,EACpB,OAAK,OAAO,SAAS,CAAC,EACf,IAAM,EAAI,gBAAkB,SAAS,CAAC,UADb,SAASA,CAAG,SAE9C,CAAC,EACD,CAAC,0BAA2B,CAACD,EAAIpI,IAAU,UAAUA,CAAK,eAAe,EACzE,CAAC,kBAAmB,CAACoI,EAAIlqB,IAAS,cAAcA,CAAI,EAAE,EACtD,CAAC,qBAAsB,CAACkqB,EAAIlqB,IAAS,qBAAqBA,CAAI,EAAE,EAChE,CAAC,sBAAuB,CAACkqB,EAAIlqB,IAAS,iBAAiBA,CAAI,EAAE,EAC7D,CAAC,sBAAuB,CAACkqB,EAAIlqB,IAAS,oBAAoBA,CAAI,EAAE,EAChE,CAAC,mBAAoB,CAACkqB,EAAIlqB,IAAS,GAAGA,CAAI,YAAY,EACtD,CAAC,qBAAsB,CAACkqB,EAAIlqB,IAAS,GAAGA,CAAI,eAAe,EAC3D,CAAC,kBAAmB,CAACkqB,EAAIlqB,IAAS,GAAGA,CAAI,mBAAmB,EAC5D,CAAC,uBAAwB,CAACkqB,EAAIE,IAAQ,wBAAwBA,CAAG,EAAE,EACnE,CAAC,wBAAyB,CAACF,EAAIE,IAAQ,+BAA+BA,CAAG,EAAE,EAC3E,CAAC,kCAAmC,CAACF,EAAIE,EAAKhZ,IAAU,0BAA0BgZ,CAAG,UAAUhZ,CAAK,GAAG,EACvG,CAAC,8BAA+B,CAAC8Y,EAAIE,EAAKC,IAAS,kBAAkBD,CAAG,OAAOC,CAAI,EAAE,EACrF,CAAC,+BAAgC,CAACH,EAAIvd,IAAO,gCAAgCA,CAAE,IAAI,EACnF,CAAC,oBAAqB,CAACud,EAAIhiB,IAAM,gBAAgBA,CAAC,EAAE,EACpD,CAAC,yBAA0B,CAACgiB,EAAI,IAAM,oBAAoB,CAAC,EAAE,EAC7D,CAAC,yBAA0B,CAACA,EAAI9wB,IAAO,UAAUA,CAAE,YAAY,EAC/D,CAAC,gBAAiB,CAAC8wB,EAAI,IAAM,WAAW,CAAC,EAAE,EAC3C,CAAC,gCAAiC,CAACA,EAAIlqB,IAAS,4BAA4BA,CAAI,GAAG,CACrF,EAIA,IAAIsqB,GAAyC,KACzCC,GAAgB,GACpB,MAAMC,OAAwB,IACxBC,OAAwB,IAC9B,IAAIC,GAAiC,KAErC,SAASC,GAAUloB,EAAmB,CACpC,OAAO,OAAOA,GAAK,EAAE,EAAE,QAAQ,OAAQ,GAAG,EAAE,MAC9C,CAIO,SAASmoB,GAAchC,EAAwC,CAEpE,GADIkB,KAAsB,MACtBlB,GAAQ,KAA2B,OAAOA,EAE9C,MAAMiC,EAAM,OAAOjC,CAAG,EAChBkC,EAAOD,EAAI,MAAM,MAAM,IAAI,CAAC,GAAK,GACjCE,EAAQF,EAAI,MAAM,MAAM,IAAI,CAAC,GAAK,GAClCG,EAAOH,EAAI,OACXxzB,EAAMszB,GAAUK,CAAI,EAC1B,GAAI,CAAC3zB,EAAK,OAAOwzB,EAGjB,IAAII,EAAiCjB,GAAQ3yB,CAAG,EAGhD,GAAI,CAAC4zB,EACH,SAAW,CAACC,EAAIl0B,CAAE,IAAKizB,GAAe,CACpC,MAAM7P,EAAI/iB,EAAI,MAAM6zB,CAAE,EACtB,GAAK9Q,EACL,IAAI,CACF6Q,EAAaj0B,EAAG,GAAGojB,CAAC,CACtB,MAAQ,CACN6Q,EAAa,MACf,CACA,MACF,CAIF,GAAI,CAACA,EAAY,CACVP,KACHA,GAAgB,OAAO,KAAKV,EAAO,EAAE,KAAK,CAAC1kB,EAAGC,IAAMA,EAAE,OAASD,EAAE,MAAM,GAEzE,IAAI6lB,EAAM9zB,EACV,UAAW+zB,KAAKV,GACTS,EAAI,SAASC,CAAC,IACnBD,EAAMA,EAAI,MAAMC,CAAC,EAAE,KAAKpB,GAAQoB,CAAC,CAAC,GAEpCH,EAAaE,CACf,CAEA,IAAIvT,EAAIqT,EACR,OAAIH,IAAMlT,EAAIA,EAAE,QAAQ,OAAQ,EAAE,GAC9BmT,IAAOnT,EAAIA,EAAE,QAAQ,OAAQ,EAAE,GAC5BkT,EAAOlT,EAAImT,CACpB,CAQA,SAASM,GAAwB7jB,EAAqB,CACpD,GAAI,CACF,MAAM9H,EAAI8H,GAAM,WAChB,GAAI,CAAC9H,GAAKA,EAAE,WAAa,EAAG,MAAO,GACnC,MAAMiU,EAAMjU,EAAE,QACd,OAAOiU,IAAQ,UAAYA,IAAQ,SAAWA,IAAQ,UACxD,MAAQ,CACN,MAAO,EACT,CACF,CAEA,SAAS2X,GAAuB9jB,EAAkB,CAEhD,GADI,CAACA,GAAQA,EAAK,WAAa,GAC3B6jB,GAAwB7jB,CAAI,EAAG,OAEnC,MAAMqjB,EAAMrjB,EAAK,KACjB,GAAI,CAACqjB,GAAO,CAACA,EAAI,OAAQ,OAEzB,MAAMI,EAAaL,GAAcC,CAAG,EAChCI,IAAeJ,IAEnBL,GAAkB,IAAIhjB,EAAM,CAAE,IAAAqjB,EAAK,WAAAI,EAAY,EAC/CzjB,EAAK,KAAOyjB,EACd,CAEA,SAASM,GAA2B1d,EAAmB,CACrD,GAAI,CAACA,GAAMA,EAAG,WAAa,EAAG,OAC9B,MAAM8F,EAAM9F,EAAG,QACf,GAAI8F,IAAQ,UAAYA,IAAQ,SAAWA,IAAQ,WAAY,OAE/D,MAAM6X,EAAQ,CAAC,aAAc,QAAS,cAAe,KAAK,EAC1D,UAAWlmB,KAAKkmB,EAAO,CACrB,GAAI,CAAC3d,EAAG,aAAavI,CAAC,EAAG,SACzB,MAAMulB,EAAMhd,EAAG,aAAavI,CAAC,EAC7B,GAAI,CAACulB,EAAK,SAEV,MAAMI,EAAaL,GAAcC,CAAG,EACpC,GAAII,IAAeJ,EAAK,SAExB,IAAIY,EAAQhB,GAAkB,IAAI5c,CAAE,EAC/B4d,IACHA,EAAQ,GACRhB,GAAkB,IAAI5c,EAAI4d,CAAK,GAEjCA,EAAMnmB,CAAC,EAAI,CAAE,IAAAulB,EAAK,WAAAI,CAAA,EAClBpd,EAAG,aAAavI,EAAG2lB,CAAU,CAC/B,CACF,CAEA,SAASS,GAAsB1zB,EAAkB,CAC/C,GAAI8xB,KAAsB,MACrB9xB,EAEL,CAAAuyB,GAAgB,GAChB,GAAI,CACEvyB,EAAK,WAAa,IACpBuzB,GAA2BvzB,CAAe,EACzCA,EAAiB,mBAAmB,GAAG,GAAG,QAAQ6V,GAAM0d,GAA2B1d,CAAE,CAAC,GAGzF,MAAM8d,EAAS,SAAS,iBAAiB3zB,EAAM,WAAW,SAAS,EACnE,IAAI,EACJ,KAAQ,EAAI2zB,EAAO,YACjBL,GAAuB,CAAC,CAE5B,SACEf,GAAgB,EAClB,EACF,CAEA,SAASqB,IAAwB,CAC/BrB,GAAgB,GAChB,GAAI,CACF,SAAW,CAAC/iB,EAAM4Z,CAAE,IAAKoJ,GAAkB,UACzC,GAAI,CACF,GAAI,CAACpJ,EAAI,SACL5Z,EAAK,OAAS4Z,EAAG,aAAY5Z,EAAK,KAAO4Z,EAAG,IAClD,MAAQ,CAAe,CAEzB,SAAW,CAACvT,EAAI4d,CAAK,IAAKhB,GAAkB,UAC1C,GAAI,CACF,SAAW,CAACnlB,EAAG8b,CAAE,IAAK,OAAO,QAAQqK,GAAS,EAAE,EACzCrK,GACDvT,EAAG,aAAavI,CAAC,IAAM8b,EAAG,YAAYvT,EAAG,aAAavI,EAAG8b,EAAG,GAAG,CAEvE,MAAQ,CAAe,CAEzBoJ,GAAkB,QAClBC,GAAkB,OACpB,SACEF,GAAgB,EAClB,CACF,CAEA,SAASR,IAAsC,CAC7C,GAAI,CACF,MAAM8B,EAAS,UAAU,WAAa,UAAU,UAAU,OAAU,UAAU,UAAY,CAAC,UAAU,UAAY,EAAE,EAEnH,OADc,OAAOA,EAAM,CAAC,GAAK,EAAE,EAAE,cACxB,WAAW,IAAI,EAAI,KAAO,IACzC,MAAQ,CACN,MAAO,IACT,CACF,CAEA,SAASC,GAAuBC,EAAwB,CACtDjC,GAAoBiC,IAAa,KAAO,KAAO,KAC/C,GAAI,CACF,SAAS,gBAAgB,aAAa,OAAQjC,EAAiB,CACjE,MAAQ,CAAe,CAEvB,GAAI,CAACQ,IAAiB,OAAO,iBAAqB,IAAa,CAC7DA,GAAgB,IAAI,iBAAkB0B,GAAc,CAClD,GAAI,CAAAzB,IACAT,KAAsB,KAE1B,CAAAS,GAAgB,GAChB,GAAI,CACF,UAAWnQ,KAAK4R,EACV5R,EAAE,OAAS,gBACbkR,GAAuBlR,EAAE,MAAc,EAC9BA,EAAE,OAAS,aACpBmR,GAA2BnR,EAAE,MAAiB,EACrCA,EAAE,OAAS,cACpBA,EAAE,YAAY,QAAQtD,GAAK,CACrBA,EAAE,WAAa,EAAGwU,GAAuBxU,CAAS,EAC7CA,EAAE,WAAa,GAAG4U,GAAsB5U,CAAC,CACpD,CAAC,EACDsD,EAAE,cAAc,QAAQtD,GAAK,CAC3B,GAAIA,EAAE,WAAa,EAAG0T,GAAkB,OAAO1T,CAAS,UAC/CA,EAAE,WAAa,EAAG,CACzB2T,GAAkB,OAAO3T,CAAY,EACrC,GAAI,CACF,MAAM6U,EAAS,SAAS,iBAAiB7U,EAAG,WAAW,SAAS,EAChE,IAAImV,EACJ,KAAQA,EAAKN,EAAO,YAA4BnB,GAAkB,OAAOyB,CAAE,CAC7E,MAAQ,CAAsB,CAChC,CACF,CAAC,EAGP,SACE1B,GAAgB,EAClB,EACF,CAAC,EACD,GAAI,CACFD,GAAc,QAAQ,SAAS,MAAQ,SAAS,gBAAiB,CAC/D,QAAS,GACT,UAAW,GACX,cAAe,GACf,WAAY,GACZ,gBAAiB,CAAC,aAAc,QAAS,cAAe,KAAK,EAC9D,CACH,MAAQ,CAAe,CACzB,CAEIR,KAAsB,KACxB4B,GAAsB,SAAS,MAAQ,SAAS,eAAe,EAE/DE,GAAA,CAEJ,CAEA,SAASM,GAAwBhhB,EAAoB,CACnD,GAAI,CACF,SAAS,iBAAiB,WAAW,EAAE,WAAc2C,EAAG,UAAU,OAAO,QAAQ,CAAC,EAClF,MAAMzU,EAAK8R,IAAS,KAAO,UAAYA,IAAS,KAAO,UAAY,cACnE,SAAS,eAAe9R,CAAE,GAAG,UAAU,IAAI,QAAQ,EAEnD,MAAM+yB,EAAYjhB,IAAS,KAAO,EAAIA,IAAS,KAAO,EAAI,EAC1D,SAAS,iBAA8B,gBAAgB,EAAE,QAAQkhB,GAAO,CACtEA,EAAI,MAAM,YAAY,eAAgB,OAAOD,CAAS,CAAC,CACzD,CAAC,CACH,MAAQ,CAAe,CACzB,CAEO,SAASE,GAAgBnhB,EAAoB,CAC9CA,IAAS,MAAQA,IAAS,MAAQA,IAAS,WAAUA,EAAO,UAChE2e,GAAsB3e,EACtBghB,GAAwBhhB,CAAI,EAE5B,MAAM6gB,EAAY7gB,IAAS,SAAY6e,GAAA,EAA2B7e,EAClE4gB,GAAuBC,CAAQ,CACjC,CAIO,SAASO,IAAiB,CAC/BD,GAAgB,QAAQ,EAExB,GAAI,CACF,OAAO,iBAAiB,iBAAkB,IAAM,CAC1CxC,KAAwB,UAC5BiC,GAAuB/B,IAAwB,CACjD,CAAC,CACH,MAAQ,CAAe,CAEvBnzB,EAAI,KAAK,oBAAoB,CAC/B,CCvmBO,SAAS21B,GAAapc,EAAuB,CAClD,MAAMqc,EAAa,SAAS,eAAe,oBAAoB,EAC3DA,IACDA,EAA2B,MAAM,MAAQ,GAAGrc,CAAO,IAExD,CAEO,SAASsc,GAAW9G,EAAe+G,EAAoB,CAC5D,MAAMxb,EAAS,SAAS,eAAe,aAAa,EAC9Cyb,EAAc,SAAS,eAAe,qBAAqB,EAC3DH,EAAa,SAAS,eAAe,oBAAoB,EAE3D7G,GACFzU,GAAQ,UAAU,IAAI,SAAS,EAC3Bwb,GAAOC,IAAaA,EAAY,UAAY/B,GAAc8B,CAAG,GAAK,IAClEF,IAAeA,EAAW,MAAM,QAAU,OAASA,EAAW,MAAM,QAAU,MAChFA,EAAW,MAAM,MAAQ,QAG3Btb,GAAQ,UAAU,OAAO,SAAS,EAClC,WAAW,IAAM,CACXsb,IAAYA,EAAW,MAAM,MAAQ,KAC3C,EAAG,GAAG,EAEV,CAIA,IAAII,GAAoD,KAEjD,SAASC,EAAUjuB,EAAoB,CAC5C,GAAI,CACF,MAAM,EAAI,SAAS,eAAe,OAAO,EACnCkuB,EAAQ,SAAS,eAAe,WAAW,EAC3C9D,EAA6BpqB,GAAQ,KAAQ,GAAK,OAAOA,CAAG,EAElE,GAAI,CAAC,GAAK,CAACkuB,EAAO,CAChB,QAAQ,KAAK,UAAW9D,CAAI,EAC5B,MACF,CAEA8D,EAAM,UAAYlC,GAAc5B,CAAI,GAAK,GACzC,EAAE,UAAU,IAAI,MAAM,EAElB4D,iBAA0BA,EAAW,EACzCA,GAAc,WAAW,IAAM,CAC7B,GAAI,CAAE,EAAE,UAAU,OAAO,MAAM,CAAG,MAAQ,CAAa,CACzD,EAAG,GAAI,CACT,MAAY,CACV,QAAQ,KAAK,mBAAoBhuB,CAAG,CACtC,CACF,CAIO,SAASmuB,IAAkB,CAChCn2B,EAAI,KAAK,qBAAqB,CAChC,CClCA,IAAIo2B,GAA0C,KAC9C,MAAMC,GAAiG,GAIvG,SAASC,IAAyB,CAChC,GAAIF,GAAe,OACnB,MAAMG,EAAOF,GAAa,QACrBE,GACLC,GAAYD,EAAK,KAAMA,EAAK,OAAO,CACrC,CAEO,SAASE,GAAYC,EAAS,QAAe,CAClD,MAAM7f,EAAU,SAAS,eAAe,gBAAgB,EACpDA,IACFA,EAAQ,UAAU,OAAO,MAAM,EAC/BA,EAAQ,aAAa,cAAe,MAAM,GAG5C,MAAM8f,EAASP,GACfA,GAAgB,KAEhB,GAAI,CACEO,GAAU,MAAM,QAAQA,EAAO,OAAO,GACxCA,EAAO,QAAQ,QAAQv2B,GAAM,CAAE,GAAI,CAAEA,EAAA,CAAM,MAAQ,CAAe,CAAE,CAAC,CAEzE,MAAQ,CAAe,CAEvB,GAAIu2B,GAAQ,WAAa,OAAQA,EAAO,UAA0B,OAAU,WAC1E,GAAI,CAAGA,EAAO,UAA0B,OAAS,MAAQ,CAAe,CAG1E,GAAI,OAAOA,GAAQ,SAAY,WAC7B,GAAI,CAAEA,EAAO,QAAQ,CAAE,OAAAD,EAAQ,CAAG,MAAQ,CAAe,CAG3D,WAAWJ,GAAkB,CAAC,CAChC,CAEA,SAASE,GAAYltB,EAA8B+C,EAA+C,CAChG,MAAMwK,EAAU,SAAS,eAAe,gBAAgB,EAClD+f,EAAU,SAAS,eAAe,cAAc,EAChDV,EAAQ,SAAS,eAAe,gBAAgB,EAChDW,EAAQ,SAAS,eAAe,eAAe,EAC/CC,EAAe,SAAS,eAAe,sBAAsB,EAC7DC,EAAW,SAAS,eAAe,kBAAkB,EAE3D,GAAI,CAAClgB,GAAW,CAAC+f,GAAW,CAACV,GAAS,CAACW,GAAS,CAACE,EAAU,CACzDd,EAAU,OAAO3sB,GAAS,SAAWA,EAAQA,GAAM,SAAW,IAAK,EACnE+C,EAAQ,CAAE,OAAQ,WAAY,EAC9B,WAAWiqB,GAAkB,CAAC,EAC9B,MACF,CAEA,MAAMU,EAAK,OAAO1tB,GAAS,UAAYA,EAAQA,EAAO,CAAE,QAAS,OAAOA,GAAQ,EAAE,GAC5E4hB,EAAS,OAAO5hB,GAAS,SAAY,KAAQ0tB,EAAE,OAAS,KACxDC,EAAuC,OAA5B,OAAO3tB,GAAS,SAAmBA,GAAQ,GAAa0tB,EAAE,SAAW,EAAxB,EACxDE,EAAaF,EAAE,WAAa,OAAOA,EAAE,UAAU,EAAI,KACnDG,EAAoBH,EAAE,gBAAkB,QAAaA,EAAE,gBAAkB,KAC3EA,EAAE,cACAA,EAAE,aAAe,QAAaA,EAAE,aAAe,KAAQA,EAAE,WAAa,GACtEI,EAAgB,OAAOD,GAAoB,EAAE,EAAE,OAC/CE,EAAe,CAAC,CAACD,EACjBE,EAAeN,EAAE,cAAgB,OAAa,CAAC,CAACA,EAAE,YAAc,GAChEO,EAAeP,EAAE,aACnB,OAAOA,EAAE,YAAY,EACpBK,EAAe,YAAc,UAElCT,EAAQ,YAAc5C,GAAc9I,CAAK,GAAK,GAC9CgL,EAAM,YAAclC,GAAciD,CAAO,GAAK,GAC9CJ,EAAM,YAAc7C,GAAckD,CAAU,GAAK,GAE7CJ,IACEO,GACFP,EAAa,YAAc9C,GAAcoD,CAAa,GAAK,GAC3DN,EAAa,MAAM,QAAU,IAE7BA,EAAa,MAAM,QAAU,QAIjC,MAAMU,EAAY,SAAS,cAE3B3gB,EAAQ,UAAU,IAAI,MAAM,EAC5BA,EAAQ,aAAa,cAAe,OAAO,EAE3C,MAAM4gB,EAA0B,GAC1BC,EAAK,CAACnS,EAA4Bld,EAAcC,IAA2B,CAC1Eid,IACLA,EAAO,iBAAiBld,EAAMC,CAAO,EACrCmvB,EAAQ,KAAK,IAAM,CACjB,GAAI,CAAElS,EAAO,oBAAoBld,EAAMC,CAAO,CAAG,MAAQ,CAAe,CAC1E,CAAC,EACH,EAEA8tB,GAAgB,CAAE,QAAA/pB,EAAS,UAAAmrB,EAAW,QAAAC,CAAA,EAEtC,MAAME,EAAQjB,GAAmBD,GAAYC,CAAM,EAEnDgB,EAAG7gB,EAAS,QAAUtW,GAAM,CACrB+2B,GACD/2B,EAAE,SAAWsW,GAAS8gB,EAAK,SAAS,CAC1C,CAAC,EAEDD,EAAGb,EAAO,QAAS,IAAMc,EAAK,IAAI,CAAC,EAC/BN,GAAgBP,GAClBY,EAAGZ,EAAc,QAAS,IAAMa,EAAK,WAAW,CAAC,EAEnDD,EAAGX,EAAU,QAAS,IAAM,CAC1B,GAAI,CAACO,EAAa,OAAOK,EAAK,IAAI,EAClCA,EAAK,OAAO,CACd,CAAC,EAEDD,EAAG,OAAQ,UAAYn3B,GAAM,CAC3B,MAAMq3B,EAAKr3B,EACX,GAAIq3B,EAAG,MAAQ,SAAU,CACvB,GAAI,CAACN,EAAa,OAClBM,EAAG,iBACHD,EAAK,QAAQ,EACb,MACF,CAEA,GAAIC,EAAG,MAAQ,MAAO,CACpB,MAAMC,EAAa,CACjBd,EACAM,EAAeP,EAAe,KAC9BD,CAAA,EACA,OAAQjoB,IAA8BA,IAAK,MAAQA,GAAE,eAAiB,IAAI,EAC5E,GAAIipB,EAAW,SAAW,EAAG,OAE7B,MAAMC,EAAQD,EAAW,CAAC,EACpBE,GAAOF,EAAWA,EAAW,OAAS,CAAC,EACvCG,GAAW,SAAS,cAEtBJ,EAAG,UACDI,KAAaF,GAAS,CAACjhB,EAAQ,SAASmhB,EAAQ,KAClDJ,EAAG,iBACHG,GAAK,SAGHC,KAAaD,KACfH,EAAG,iBACHE,EAAM,QAGZ,CACF,CAAC,EAED,WAAW,IAAM,CACf,GAAI,GACYP,IAAiB,aAAeF,GAAgBP,EAC1DA,EACCS,IAAiB,QAAUR,EAAWF,IAClCA,GAAQ,OACnB,MAAQ,CAAe,CACzB,EAAG,CAAC,CACN,CAIO,SAASoB,GAAW3uB,EAA+B,GAA2B,CACnF,OAAO,IAAI,QAAS+C,GAAY,CAC9BgqB,GAAa,KAAK,CAAE,KAAA/sB,EAAM,QAAA+C,CAAA,CAAS,EACnCiqB,GAAA,CACF,CAAC,CACH,CAEO,SAAS4B,IAAmB,CACjCl4B,EAAI,KAAK,sBAAsB,CACjC,CCjLO,SAASm4B,GAAUC,EAAqB,CAC7C3G,GAAkB,IAAM,CACtB,SAAS,iBAAiB,cAAc,EAAE,WAAcxa,EAAG,UAAU,OAAO,QAAQ,CAAC,EACrF,SAAS,iBAAiB,WAAW,EAAE,WAAcA,EAAG,UAAU,OAAO,QAAQ,CAAC,EAClF,MAAMohB,EAAQ,SAAS,eAAe,OAAOD,CAAK,EAAE,EAChDC,GAAOA,EAAM,UAAU,IAAI,QAAQ,EAEvC,MAAM5mB,EADO,CAAC,OAAQ,WAAY,WAAY,OAAO,EACpC,QAAQ2mB,CAAK,EAC1B3mB,GAAO,GAAG,SAAS,iBAAiB,WAAW,EAAEA,CAAG,GAAG,UAAU,IAAI,QAAQ,EAE7E2mB,IAAU,YACZ13B,EAAI,KAAK,wBAAwB,EAG/B03B,IAAU,QACZ,WAAW,IAAM,CACM10B,EAAiB,UAAU,IAC3Bf,EAAU,iBAC7BjC,EAAI,KAAK,yBAAyB,EAEpCA,EAAI,KAAK,qBAAqB,CAChC,EAAG,EAAE,CAMT,CAAC,CACH,CAIO,SAAS43B,IAAiB,CAE/B,SAAS,iBAA8B,iCAAiC,EAAE,QAAQrhB,GAAM,CACtFA,EAAG,iBAAiB,QAAS,IAAM,CACjC,GAAI,CAAEA,EAAG,MAAQ,MAAQ,CAAe,CACxC,GAAIA,EAAG,UAAU,SAAS,QAAQ,EAAG,CACnC,MAAMshB,EAAU,SAAS,cAAc,QAAQthB,EAAG,QAAQ,GAAG,YAAY,EACrEshB,KAAiB,SAAS,CAAE,IAAK,EAAG,SAAU,SAAU,CAC9D,MACEJ,GAAUlhB,EAAG,QAAQ,GAAI,CAE7B,CAAC,CACH,CAAC,EAGDvW,EAAI,GAAG,iBAAkB,IAAIT,IAAoB,CAC/C,MAAMm4B,EAAQn4B,EAAK,CAAC,EAChBm4B,MAAiBA,CAAK,CAC5B,IAEAp4B,EAAI,KAAK,oBAAoB,CAC/B,CClEA,IAAIw4B,GAA8B,KAC9BC,GAAwB,EAC5B,MAAMC,GAAyB,IAC/B,IAAIC,GAAwD,KAI5D,SAASC,IAAuB,CAC9B,OAAOl1B,EAAkB,gBAAgB,CAC3C,CAIO,SAASm1B,IAAwB,CAClCL,KACF,qBAAqBA,EAAY,EACjCA,GAAe,MAGjB,MAAMM,EAAS,SAAS,eAAe,kBAAkB,EACzD,GAAI,CAACA,EAAQ,OACb,MAAMC,EAAOD,EAAO,WAAW,IAAI,EACnC,GAAI,CAACC,EAAM,OACX,MAAMC,EAAgCD,EAEhC5zB,EAAWyzB,GAAA,EAEjB,GAAI,CAACzzB,EAAU,CACb,GAAI,EAAEszB,GAAwBC,GAAwB,CACpD14B,EAAI,KAAK,kDAAmD04B,GAAwB,QAAQ,EAC5FD,GAAwB,EACxB,MACF,CACAD,GAAe,sBAAsBK,EAAe,EACpD,MACF,CACAJ,GAAwB,EAGxB,MAAMQ,EAAiB,OAAQ9zB,EAAqC,UAAa,WAC3E+zB,EAAeD,EACf9zB,EAAoC,MAAQ,KAC7CA,EAAqC,kBAE1C,IAAIg0B,EAAe,EAGnB,MAAM74B,EAAU,SAAS,cAAc,gBAAgB,EACjD84B,EAAe94B,GAAYA,EAAwB,YAAc,GAClEA,EAAwB,YAAc,IACrC+4B,EAAM,OAAO,kBAAoB,GACnCP,EAAO,QAAUM,EAAcC,GAAOP,EAAO,SAAWM,EAAcC,KACxEP,EAAO,MAAQM,EAAcC,EAC7BP,EAAO,OAASM,EAAcC,EAC9BP,EAAO,MAAM,MAAQ,GACrBA,EAAO,MAAM,OAAS,GACtBE,EAAI,aAAa,EAAG,EAAG,EAAG,EAAG,EAAG,CAAC,EACjCA,EAAI,MAAMK,EAAKA,CAAG,GAGpB,SAASC,GAAa,CACpB,MAAMvkB,EAAerR,EAAiB,UAAU,EAChD,GAAI0d,EAAerM,CAAY,EAAG,CAAEyjB,GAAe,KAAM,MAAQ,CACjE,GAAI,CAACS,EAAgB,CAAET,GAAe,KAAM,MAAQ,CACpDA,GAAe,sBAAsBc,CAAI,EAEzC,MAAMC,EAAUp0B,EAAkE,WAG5Eq0B,EADQ,SAAS,gBAAgB,aAAa,YAAY,IACrC,QAE3BR,EAAI,yBAA2B,cAC/BA,EAAI,UAAU,EAAG,EAAGI,EAAaA,CAAW,EAG5C,IAAIK,EAAU,EACVC,EAAY,GACZA,EAAYR,IAAcQ,EAAYR,GAC1C,QAASl1B,GAAI,EAAGA,GAAI01B,EAAW11B,KAAK,CAClC,IAAIoN,GAAOmoB,EAAOv1B,EAAC,EAAI,KAAO,IAC1BoN,EAAM,IAAGA,EAAM,GACfA,EAAM,MAAKA,EAAM,KACrBqoB,GAAWroB,CACb,CACA,MAAMuoB,EAAcF,EAAUC,EAE9BP,EAAeA,EAAe,GAAMQ,EAAc,GAClD,MAAMC,EAAY,KAAK,IAAIT,EAAe,IAAK,GAAG,EAGlD,IAAIU,EAAU,EACd,MAAMC,EAAY,KAAK,MAAMZ,EAAe,EAAG,EACzCa,EAAUb,EAChB,IAAIc,EAAeD,EAAUD,EACzBE,EAAe,IAAGA,EAAe,GAErC,QAASh2B,GAAI81B,EAAW91B,GAAI+1B,EAAS/1B,KAAK,CACxC,IAAIoN,GAAOmoB,EAAOv1B,EAAC,EAAI,KAAO,IAC1BoN,EAAM,IAAGA,EAAM,GACfA,EAAM,MAAKA,EAAM,KACrByoB,GAAWzoB,CACb,CAEA,MAAM6oB,EADcJ,EAAUG,EACE,IAEhChB,EAAI,yBAA2BQ,EAAU,cAAgB,UACzDR,EAAI,WAAa,EAEjB,MAAMkB,GAAUd,EAAc,EACxBe,GAAUf,EAAc,EACxBgB,GAAQhB,EAAc,IAGtBiB,IAAc,GAAMT,EAAY,KAAQQ,GACxCE,GAAgB,GAAMV,EAAY,GACxCZ,EAAI,UAAYQ,EACZ,0BACA,kBAAkBc,GAAgB,EAAE,UACxCtB,EAAI,YACJA,EAAI,IAAIkB,GAASC,GAASE,GAAY,EAAG,EAAI,KAAK,EAAE,EACpDrB,EAAI,OAGJ,MAAMuB,IAAc,GAAMN,EAAY,KAAQG,GACxCI,GAAgB,GAAMP,EAAY,GACxCjB,EAAI,UAAYQ,EACZ,0BACA,mBAAmBgB,GAAgB,EAAE,UACzCxB,EAAI,YACJA,EAAI,IAAIkB,GAASC,GAASI,GAAY,EAAG,EAAI,KAAK,EAAE,EACpDvB,EAAI,MACN,CAEAM,EAAA,CACF,CAIO,SAASmB,IAA2B,CACzC,MAAM3B,EAAS,SAAS,eAAe,kBAAkB,EACzD,GAAI,CAACA,EAAQ,OACb,MAAM4B,EAAQ5B,EAAO,WAAW,IAAI,EACpC,GAAI,CAAC4B,EAAO,OACZ,MAAM1B,EAAgC0B,EAEhCp6B,EAAU,SAAS,cAAc,gBAAgB,EACjD84B,EAAc94B,EAAWA,EAAwB,YAAc,IAC/D+4B,EAAM,OAAO,kBAAoB,GACnCP,EAAO,QAAUM,EAAcC,GAAOP,EAAO,SAAWM,EAAcC,KACxEP,EAAO,MAAQM,EAAcC,EAC7BP,EAAO,OAASM,EAAcC,EAC9BP,EAAO,MAAM,MAAQ,GACrBA,EAAO,MAAM,OAAS,GACtBE,EAAI,aAAa,EAAG,EAAG,EAAG,EAAG,EAAG,CAAC,EACjCA,EAAI,MAAMK,EAAKA,CAAG,GAIpB,MAAMG,EADQ,SAAS,gBAAgB,aAAa,YAAY,IACrC,QAE3BR,EAAI,yBAA2B,cAC/BA,EAAI,UAAU,EAAG,EAAGI,EAAaA,CAAW,EAC5CJ,EAAI,yBAA2BQ,EAAU,cAAgB,UACzDR,EAAI,WAAa,EAEjB,MAAMkB,EAAUd,EAAc,EACxBe,EAAUf,EAAc,EACxBgB,EAAQhB,EAAc,IAGtBiB,EAAa,GAAKD,EACxBpB,EAAI,UAAYQ,EAAU,0BAA4B,2BACtDR,EAAI,YACJA,EAAI,IAAIkB,EAASC,EAASE,EAAY,EAAG,EAAI,KAAK,EAAE,EACpDrB,EAAI,OAGJ,MAAMuB,EAAa,GAAKH,EACxBpB,EAAI,UAAYQ,EAAU,0BAA4B,4BACtDR,EAAI,YACJA,EAAI,IAAIkB,EAASC,EAASI,EAAY,EAAG,EAAI,KAAK,EAAE,EACpDvB,EAAI,MACN,CAIO,SAAS2B,IAAuB,CACrCF,GAAA,EAEA,OAAO,iBAAiB,SAAU,IAAM,CAClC9B,iBAA8BA,EAAe,EACjDA,GAAkB,WAAW,IAAM,CACjC,MAAMr4B,EAAU,SAAS,cAAc,gBAAgB,EACvD,GAAI,CAACA,GAAYA,EAAwB,YAAc,GAAI,OAC3D,MAAMyU,EAAerR,EAAiB,UAAU,EAC5C0d,EAAerM,CAAY,EAC7B0lB,GAAA,EAEA5B,GAAA,CAEJ,EAAG,GAAG,CACR,CAAC,EAGDn4B,EAAI,GAAG,uBAAwB,IAAI+nB,IAAqB,CACtD,MAAM1T,EAAerR,EAAiB,UAAU,EAC5C0d,EAAerM,CAAY,EAAG0lB,GAAA,EAC7B5B,GAAA,CACP,IAGAn4B,EAAI,GAAG,wBAAyB,IAAI+nB,IAAqB,CACvD,MAAM1T,EAAerR,EAAiB,UAAU,EAC5C0d,EAAerM,CAAY,EAAG0lB,GAAA,EAC7B5B,GAAA,CACP,IAGAn4B,EAAI,GAAG,oBAAqB,IAAI+nB,IAAqB,CACnDoQ,GAAA,CACF,IAEA74B,EAAI,KAAK,0BAA0B,CACrC,CCzNA,MAAMmD,GAAmB,OAEnBy3B,GAAuD,CAC3D,EAAK,CAAE,MAAO,YACd,KAAM,CAAE,MAAO,QACf,EAAK,CAAE,MAAO,SACd,EAAK,CAAE,MAAO,SAChB,EAEA,SAASC,GAA0BvmB,EAAsB,CACvD,OAAQsmB,GAAkB,OAAOtmB,CAAI,CAAC,GAAKsmB,GAAkB,CAAG,GAAG,KACrE,CAMA,IAAIE,GAAe,EACfC,GAAoB,GAIxB,SAASC,IAA4B,CAEnC,GAAI,CADat3B,EAAgC,kBAAkB,EACpD,MAAO,OAGtB,MAAMkO,GADgBlO,EAAiB,uBAAuB,GAAK,IACvC,OAE5B,GAAI,CAACkO,GAASA,IAAU,QAAUA,IAAU,SAAWA,IAAU,MAAO,OAAOzO,GAE/E,MAAM83B,EAAQJ,GAA0B,CAAC,EACnCK,EAAQL,GAA0B,EAAE,EACpCM,EAAQN,GAA0B,CAAC,EACnCO,EAAQP,GAA0B,CAAC,EACzC,OAAIjpB,IAAUqpB,GAASrpB,IAAUspB,GAAStpB,IAAUupB,GAASvpB,IAAUwpB,EAAcj4B,GAE9EyO,CACT,CAEA,SAASypB,GAAuBzpB,EAAuB,CAErD,OADWA,GAASA,EAAM,OAAUA,EAAM,OAASzO,EAErD,CAEA,SAASm4B,GAAehmB,EAAoB,CAC1C,MAAMimB,EAAQjmB,EAAG,MAAM,GAAG,EAAE,IAAI,MAAM,EACtC,OAAIimB,EAAM,SAAW,EAAUA,EAAM,CAAC,EAAI,KAAOA,EAAM,CAAC,EAAI,GAAKA,EAAM,CAAC,EACpEA,EAAM,SAAW,EAAUA,EAAM,CAAC,EAAI,GAAKA,EAAM,CAAC,EAC/C,CACT,CAIA,SAASC,GAAoBpJ,EAAsB,CACjD,MAAMqJ,EAAU,8GACVC,EAAU,kCAEVC,EAAgB,IAAI,OACxB,IAAIF,EAAQ,MAAM,MAAMC,EAAQ,MAAM,IACtC,MAGF,IAAIl7B,EAAS,GACTo7B,EAAY,EACZ9P,EAEJ,MAAQA,EAAQ6P,EAAc,KAAKvJ,CAAI,KAAO,MAAM,CAC9CtG,EAAM,MAAQ8P,IAChBp7B,GAAUuxB,GAAWK,EAAK,MAAMwJ,EAAW9P,EAAM,KAAK,CAAC,GAGzD,MAAM+P,EAAc/P,EAAM,CAAC,EAG3B,GADA2P,EAAQ,UAAY,EAChBA,EAAQ,KAAKI,CAAW,EAAG,CAC7B,MAAMC,EAAWD,EAAY,WAAW,MAAM,EAAIA,EAAc,WAAaA,EACvEE,EAAW,MAAQ,KAAK,SAAS,SAAS,EAAE,EAAE,OAAO,EAAG,CAAC,EAE/Dv7B,GAAU;AAAA,2EAC2D0xB,GAAW4J,CAAQ,CAAC,kDAAkDC,CAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,qBAKpIA,CAAQ,2BAA2BhK,GAAW8J,CAAW,CAAC;AAAA;AAAA,QAIzE,WAAW,IAAMG,GAAuBD,EAAUD,CAAQ,EAAG,GAAG,CAClE,SAAW,2BAA2B,KAAKD,CAAW,EAAG,CACvD,MAAMI,EAAUX,GAAeO,CAAW,EAC1Cr7B,GAAU,sEAAsEy7B,CAAO,KAAKlK,GAAW8J,CAAW,CAAC,SACrH,MACEr7B,GAAUuxB,GAAW8J,CAAW,EAGlCD,EAAYD,EAAc,SAC5B,CAEA,OAAIC,EAAYxJ,EAAK,SACnB5xB,GAAUuxB,GAAWK,EAAK,MAAMwJ,CAAS,CAAC,GAGrCp7B,CACT,CAEA,eAAew7B,GAAuBE,EAAmBxb,EAA4B,CACnF,GAAI,CACF,MAAMwK,EAAQ,MAAMgB,GAAiBxL,CAAG,EACxC,GAAIwK,EAAO,CACT,MAAMjU,EAAK,SAAS,eAAeilB,CAAS,EACxCjlB,MAAO,YAAciU,EAC3B,CACF,MAAQ,CAAe,CACzB,CAIA,SAASiR,GAAkBC,EAAgBhK,EAAoB,CAC7D,MAAMiK,EAAa,SAAS,eAAe,kBAAkB,EAC7D,GAAI,CAACA,EAAY,OAEjB,MAAMC,EAAcD,EAAW,cAAc,oBAAoB,EAC7DC,IACFA,EAAY,YAAc,GAAGF,CAAM,KAAKhK,CAAI,GAEhD,CAEA,SAASmK,IAAwB,CAC/B,GAAIxB,GAAmB,OACvBD,KACA,MAAM0B,EAAQ,SAAS,eAAe,oBAAoB,EACtDA,IACFA,EAAM,YAAc1B,GAAe,EAAI,KAAO,OAAOA,EAAY,EACjE0B,EAAM,UAAU,IAAI,MAAM,EAE9B,CAEA,SAASC,IAAoB,CAC3B3B,GAAe,EACf,MAAM0B,EAAQ,SAAS,eAAe,oBAAoB,EACtDA,IACFA,EAAM,YAAc,IACpBA,EAAM,UAAU,OAAO,MAAM,EAEjC,CAIO,SAASE,IAAyB,CACvC,MAAMC,EAAS,SAAS,eAAe,aAAa,EACpD,GAAKA,IAEL5B,GAAoB,CAACA,GACrB4B,EAAO,UAAU,OAAO,OAAQ5B,EAAiB,EAE7CA,IAAmB,CACrB0B,GAAA,EACA,MAAMG,EAAW,SAAS,eAAe,eAAe,EACpDA,IAAUA,EAAS,UAAYA,EAAS,cAC5C,MAAM5M,EAAQ,SAAS,eAAe,YAAY,EAC9CA,GAAO,WAAW,IAAMA,EAAM,QAAS,GAAG,CAChD,CACF,CAIO,SAAS6M,IAAwB,CACtC,MAAM7M,EAAQ,SAAS,eAAe,YAAY,EAClD,GAAI,CAACA,EAAO,OACZ,MAAMoC,EAAOpC,EAAM,MAAM,OACzB,GAAI,CAACoC,EAAM,OAEX,MAAM0K,EAAc9B,GAAA,EACdntB,EAAcnK,EAAiB,mBAAmB,GAAK,EACvDq5B,EAAalC,GAA0BhtB,CAAW,EAClDmvB,EAAc3B,GAAuByB,CAAW,EAEtDG,GAAeD,EAAa5K,EAAM,EAAI,EAEtC,MAAM5jB,EAAO9K,EAAiB,cAAc,GAAK,GAC3Cw5B,EAAU,CACd,KAAM95B,EAAI,KACV,SAAUoL,EACV,OAAQsuB,EACR,YAAAA,EACA,WAAAC,EACA,KAAA3K,EACA,GAAI,KAAK,KAAI,EAGTxpB,EAAWlF,EAAgC,kBAAkB,EAC9DkF,EAGCA,EAAS,MAAMA,EAAS,KAAKs0B,CAAO,EAFxCx8B,EAAI,KAAK,oBAAqBw8B,CAAO,EAKvClN,EAAM,MAAQ,EAChB,CAEO,SAASiN,GAAeb,EAAgBhK,EAAc+K,EAAuB,CAClF,MAAMnP,EAAY,SAAS,eAAe,eAAe,EAEzD,GAAIA,EAAW,CACb,MAAMoP,EAAQpP,EAAU,cAAc,aAAa,EAC/CoP,KAAa,SAEjB,MAAMC,MAAU,KACVC,EAAU,GAAGD,EAAI,WAAW,WAAW,SAAS,EAAG,GAAG,CAAC,IAAIA,EAAI,aAAa,WAAW,SAAS,EAAG,GAAG,CAAC,GAEvGE,EAAQ,SAAS,cAAc,KAAK,EAG1C,GAFAA,EAAM,UAAY,cAAcJ,EAAS,OAAS,QAAQ,GAEtD,CAACA,EAAQ,CACX,MAAMK,EAAa,SAAS,cAAc,KAAK,EAC/CA,EAAW,UAAY,cACvBA,EAAW,UAAYpB,EACvBmB,EAAM,YAAYC,CAAU,CAC9B,CAEA,MAAMC,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY,WAEhB,MAAMC,EAAS,SAAS,cAAc,KAAK,EAC3CA,EAAO,UAAY,eAAeP,EAAS,OAAS,QAAQ,GAC5D,MAAMQ,EAAc,SAAS,cAAc,KAAK,EAChDA,EAAY,UAAY,YACxBA,EAAY,UAAYnC,GAAoBpJ,CAAI,EAChDsL,EAAO,YAAYC,CAAW,EAE9B,GAAI,CACED,EAAO,cAAc,mBAAmB,GAAGA,EAAO,UAAU,IAAI,aAAa,CACnF,MAAQ,CAAe,CAEvB,MAAME,EAAW,SAAS,cAAc,KAAK,EAC7CA,EAAS,UAAY,YACrBA,EAAS,UAAYN,EAEjBH,GACFM,EAAI,YAAYG,CAAQ,EACxBH,EAAI,YAAYC,CAAM,IAEtBD,EAAI,YAAYC,CAAM,EACtBD,EAAI,YAAYG,CAAQ,GAG1BL,EAAM,YAAYE,CAAG,EACrBzP,EAAU,YAAYuP,CAAK,EAC3BvP,EAAU,UAAYA,EAAU,YAClC,CAIAmO,GAAkBC,EAAQhK,CAAI,EAEzB+K,GACHZ,GAAA,CAEJ,CAIA,SAASsB,GAAkB/1B,EAA+BY,EAA4B,CACpF,MAAM8F,EAAO9K,EAAiB,cAAc,GAAK,GAC3Co6B,EAAWh2B,EAAK,UAAsB,GACtCq1B,EAASW,IAAatvB,EAEtBsuB,EAAeh1B,EAAK,aAA2BA,EAAK,QAAqB3E,GACzE65B,EAAc3B,GAAuByB,CAAW,EAChD1K,EAAQtqB,EAAK,MAAmB,GAMtC,GAJAm1B,GAAeD,EAAa5K,EAAM+K,CAAM,EAIpC,CADaz5B,EAAgC,kBAAkB,EACpD,CACb,MAAMq6B,EAAer1B,GAAM,MAASo1B,GAAuB,GAC3Dp9B,EAAI,KAAK,2BAA4Bq9B,EAAcj2B,CAAI,CACzD,CACF,CAIA,SAASk2B,IAAgC,CAEvC,SAAS,iBAAiB,QAAU,GAAM,CACxC,MAAMzY,EAAU,EAAE,QAAwB,UAAU,4BAA4B,EAChF,GAAI,CAACA,EAAQ,OACb,MAAM9B,EAAM,OAAO8B,EAAO,aAAa,WAAW,CAAC,EAC/C,OAAO,SAAS9B,CAAG,GAAG/iB,EAAI,KAAK,sBAAuB+iB,CAAG,CAC/D,CAAC,EAED,SAAS,iBAAiB,UAAY,GAAM,CAC1C,MAAM8B,EAAU,EAAE,QAAwB,UAAU,4BAA4B,EAEhF,GADI,CAACA,GACD,EAAE,MAAQ,SAAW,EAAE,MAAQ,IAAK,OACxC,EAAE,iBACF,EAAE,kBACF,MAAM9B,EAAM,OAAO8B,EAAO,aAAa,WAAW,CAAC,EAC/C,OAAO,SAAS9B,CAAG,GAAG/iB,EAAI,KAAK,sBAAuB+iB,CAAG,CAC/D,CAAC,EAGD,SAAS,iBAAiB,QAAU,GAAM,CACxC,MAAM2F,EAAO,EAAE,QAAwB,UAAU,qCAAqC,EACtF,GAAI,CAACA,EAAK,OACV,MAAM1I,EAAM0I,EAAI,aAAa,kBAAkB,EAC3C1I,GAAKhgB,EAAI,KAAK,yBAA0BggB,CAAG,CACjD,CAAC,CACH,CAIA,SAASud,GAAYC,EAAqB,CACxC,MAAMlO,EAAQ,SAAS,eAAe,YAAY,EAC9CA,IACFA,EAAM,OAASkO,EACflO,EAAM,QAEV,CAGC,OAA8C,YAAciO,GAItD,SAASE,IAAiB,CAC/B51B,EAAiB,CACf,CAACnF,EAAI,IAAI,EAAGy6B,EAAA,CACb,EAEDG,GAAA,EAGA,MAAMI,EAAU,SAAS,eAAe,eAAe,EACnDA,GAASA,EAAQ,iBAAiB,QAASvB,EAAe,EAE9D,MAAM9F,EAAW,SAAS,eAAe,gBAAgB,EACrDA,GAAUA,EAAS,iBAAiB,QAAS2F,EAAgB,EAEjE,MAAML,EAAa,SAAS,eAAe,kBAAkB,EACzDA,GAAYA,EAAW,iBAAiB,QAASK,EAAgB,EAGrE,MAAM2B,EAAY,SAAS,eAAe,YAAY,EAClDA,GACFA,EAAU,iBAAiB,UAAY99B,GAAM,CACvCA,EAAE,MAAQ,SAAW,CAACA,EAAE,WAC1BA,EAAE,iBACFs8B,GAAA,EAEJ,CAAC,EAIHn8B,EAAI,GAAG,yBAA0B,IAAI+nB,IAAqB,CACxDiU,GAAA,CACF,IAGAh8B,EAAI,GAAG,wBAAyB,IAAI+nB,IAAqB,CACnDsS,IAAmB2B,GAAA,CACzB,IAEA18B,EAAI,KAAK,oBAAoB,CAC/B,CCjXA,SAASs+B,GAAgB7sB,EAAmB,CAC1C,MAAMsI,EAAWrW,EAAyB,gBAAgB,EACrDqW,EAAStI,CAAG,IACjBsI,EAAStI,CAAG,EAAE,WAAa,CAACsI,EAAStI,CAAG,EAAE,WAGtCsI,EAAStI,CAAG,EAAE,YAAcsI,EAAStI,CAAG,EAAE,YAC5C/Q,EAAI,KAAK,6BAA8BqZ,EAAStI,CAAG,EAAE,WAAYA,CAAG,EAGtE8sB,GAAA,EACF,CAIO,SAASA,IAAyB,CACvC,MAAMC,EAAK,SAAS,eAAe,aAAa,EAChD,GAAI,CAACA,EAAI,OAET,MAAMzkB,EAAWrW,EAAyB,gBAAgB,EAE1D,GAAI,CAAC,MAAM,QAAQqW,CAAQ,EAAG,CAC5B/Z,EAAI,KAAK,iDAAiD,EAC1D8D,EAAS,iBAAkB,EAAE,EAC7B,MACF,CAGA,GADA06B,EAAG,UAAY,GACXzkB,EAAS,SAAW,EAAG,CACzBykB,EAAG,UAAY,iDACf,MACF,CAEA,MAAM3kB,EAAoBnW,EAAiB,4BAA4B,EACjE2nB,EAAyB3nB,EAAiB,yBAAyB,GAAK,GACxEkF,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACnD+6B,EAAc/6B,EAAgE,qBAAqB,GAAK,GAE9GqW,EAAS,QAAQ,CAAC0D,EAAMhM,IAAQ,CAC9B,MAAM4e,EAAa5e,IAAQoI,EACrB6kB,EAAK,SAAS,cAAc,IAAI,EACtCA,EAAG,UAAY,cAAcrO,EAAY,SAAW,EAAE,IAAI5S,EAAK,WAAa,cAAgB,EAAE,GAE9F,IAAIkhB,EAAY,GACZlhB,EAAK,aACPkhB,EAAY;AAAA,qDACmClhB,EAAK,WAAa,SAAW,EAAE,sBAAsBhM,CAAG;AAAA;AAAA;AAAA,SAMzG,MAAMmtB,EAAOnhB,EAAK,OAAS,UACvB,qgBACA,+KAEEuf,EAAcvf,EAAK,MAAQA,EAAK,OAAS,UAC/CihB,EAAG,QAAU,IAAM,CACZ91B,EACIuc,KAAqB,KAAK,CAAE,KAAM/hB,EAAI,qBAAsB,MAAOqO,EAAK,EADlE/Q,EAAI,KAAK,sBAAuB+Q,CAAG,CAEpD,EAEAitB,EAAG,UAAY;AAAA,+BACYjtB,EAAM,CAAC;AAAA,gCACNmtB,CAAI,IAAI7M,GAAWiL,CAAW,CAAC;AAAA,QACvD2B,CAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAObH,EAAG,YAAYE,CAAE,EAGjB,MAAMG,EAAMH,EAAG,cAAc,iCAAiC,EAU9D,GATIG,GACFA,EAAI,iBAAiB,QAAUt+B,GAAM,CACnCA,EAAE,iBACFA,EAAE,kBACF+9B,GAAgB7sB,CAAG,CACrB,CAAC,EAICgM,EAAK,YAAcA,EAAK,WAAY,CACtC,MAAMqhB,EAAQ,SAAS,cAAc,IAAI,EACzCA,EAAM,UAAY,eAElB,MAAMxT,EAAUmT,EAAYhhB,EAAK,UAAU,EACvC6N,GAAWA,EAAQ,IACrBA,EAAQ,IAAI,QAAQ,CAAC5oB,EAAKmuB,IAAS,CACjC,MAAMkO,EAAM,SAAS,cAAc,IAAI,EACjCC,EAAe3O,GAAaQ,IAASxF,EAC3C0T,EAAI,UAAY,kBAAkBC,EAAc,SAAW,EAAE,GAE7D,MAAMC,EAAU3T,EAAQ,QAAUA,EAAQ,OAAOuF,CAAI,EAAKvF,EAAQ,OAAOuF,CAAI,EAAI,SAASA,EAAO,CAAC,GAClGkO,EAAI,UAAY;AAAA,oCACUlO,EAAO,CAAC;AAAA,qCACPkB,GAAWkN,CAAM,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAQ7CF,EAAI,QAAWx+B,GAAM,CACnBA,EAAE,kBACE,EAAAqI,GAAY,CAACuc,KACZvc,EAGHA,EAAS,KAAK,CAAE,KAAMxF,EAAI,yBAA0B,YAAaqO,EAAK,OAAQof,EAAM,EAFpFnwB,EAAI,KAAK,mBAAoB+Q,EAAKof,EAAMR,CAAS,EAIrD,EACAyO,EAAM,YAAYC,CAAG,CACvB,CAAC,EAEDD,EAAM,UAAY,wDAEpBN,EAAG,YAAYM,CAAK,CACtB,CACF,CAAC,EAGD,MAAM5mB,EAAOxU,EAAkC,eAAe,EAC9D,GAAImW,IAAsB,GAAI,CAC5B,MAAMyW,EAAcvW,EAASF,CAAiB,EAC9C,IAAIqlB,EAAe,UACfhnB,GAAQA,EAAK,QAAU2B,GAAqB3B,EAAK,KACnDgnB,EAAehnB,EAAK,KACXoY,IACT4O,EAAe5O,EAAY,MAAQA,EAAY,OAAS,WAG1D6B,GAAuB+M,CAAY,EAEnC,MAAMC,EAAW,SAAS,eAAe,cAAc,EACnDA,IACE7O,GAAgBA,EAAmD,OACrE6O,EAAS,UAAa7O,EAAmD,OAEzE6O,EAAS,UAAa7O,GAAeA,EAAY,OAAS,UAAa,gBAAkB,SAASzW,EAAoB,CAAC,GAG7H,CACF,CAIO,SAASulB,IAAyB,CAEvC1+B,EAAI,GAAG,sBAAuB,IAAI+nB,IAAqB,CACrD8V,GAAA,CACF,IAEAv+B,EAAI,KAAK,4BAA4B,CACvC,CCtJA,MAAM46B,GAA+E,CACnF,EAAK,CAAE,MAAO,WAAY,eAAgB,iBAC1C,KAAM,CAAE,MAAO,OAAQ,eAAgB,iBACvC,EAAK,CAAE,MAAO,QAAS,eAAgB,kBACvC,EAAK,CAAE,MAAO,SAAU,eAAgB,gBAC1C,EAMO,SAASyE,GAAsB/qB,EAAyD,CAC7F,OAAOsmB,GAAkB,OAAOtmB,CAAI,CAAC,GAAKsmB,GAAkB,CAAG,CACjE,CAEO,SAAS0E,GAA6BhrB,EAAoB,CAC/D2hB,EAAUoJ,GAAsB/qB,CAAI,EAAE,cAAc,CACtD,CAIA,IAAIirB,GAAiB,GAErB,SAASC,IAAyB,CAChC,MAAMZ,EAAO,SAAS,eAAe,cAAc,EACnD,GAAI,CAACA,EAAM,OACX,MAAMj7B,EAAOi7B,EAAK,cAAc,MAAM,EACtC,GAAI,CAACj7B,EAAM,QAECD,EAAiB,oBAAoB,GAAK,KAC1C,EACVC,EAAK,aAAa,IAAK,iWAAiW,EAExXA,EAAK,aAAa,IAAK,6LAA6L,CAExN,CAEA,SAAS87B,GAAWruB,EAAmB,CACrC1Q,EAAI,KAAK,mBAAoB0Q,EAAM,GAAG,CACxC,CAEA,SAASsuB,GAAYtuB,EAAmB,CACrB1N,EAAgC,kBAAkB,IAEjEhD,EAAI,KAAK,oBAAqB,CAAE,KAAM0C,EAAI,OAAQ,MAAOgO,EAAM,IAAK,EACpE6kB,EAAU,WAAW,KAAK,MAAM7kB,CAAG,CAAC,GAAG,EAE3C,CAEA,SAASuuB,IAAmB,CAC1B,MAAMxsB,EAAezP,EAAiB,oBAAoB,GAAK,EAC/D,GAAIyP,EAAe,EACjBosB,GAAiBpsB,EACjBzS,EAAI,KAAK,mBAAoB,CAAC,EAC9Bu1B,EAAU,OAAO,EACAvyB,EAAgC,kBAAkB,GACpDhD,EAAI,KAAK,oBAAqB,CAAE,KAAM0C,EAAI,OAAQ,MAAO,EAAG,MACtE,CACL1C,EAAI,KAAK,mBAAoB6+B,IAAkB,EAAG,EAClD,MAAMK,EAASL,IAAkB,GACjCtJ,EAAU,WAAW,KAAK,MAAM2J,EAAS,GAAG,CAAC,GAAG,EAC/Bl8B,EAAgC,kBAAkB,GACpDhD,EAAI,KAAK,oBAAqB,CAAE,KAAM0C,EAAI,OAAQ,MAAOw8B,CAAA,CAAQ,CAClF,CACF,CAIO,SAASC,GAAwB,CACtC,MAAMrD,EAAQ,SAAS,eAAe,YAAY,EAC5CpK,EAAO,SAAS,eAAe,WAAW,EAChD,GAAI,CAACoK,GAAS,CAACpK,EAAM,OAKrB,GAHAoK,EAAM,UAAU,OAAO,WAAW,EAEb94B,EAAkB,sBAAsB,EAC3C,CAChB0uB,EAAK,UAAY,UACjB,MACF,CAGA,GADiB1uB,EAAgC,kBAAkB,EACrD,CACZ,MAAM8kB,EAAgB9kB,EAAiB,oBAAoB,EACrDo8B,EAActX,GAAiB,OAAO,SAASA,CAAa,EAAK,KAAK,KAAK,MAAMA,CAAa,CAAC,MAAQ,GAEvG5W,GADgBlO,EAAiB,uBAAuB,GAAK,IACvC,QAAU,OACtC0uB,EAAK,UAAY,GAAGxgB,CAAK,GAAGkuB,CAAU,GACtCtD,EAAM,UAAU,IAAI,WAAW,EAC/B,MACF,CAEA,MAAM3vB,EAAUnJ,EAAiB,iBAAiB,EAClD,GAAImJ,IAAY,OAAQ,CACtBulB,EAAK,UAAY,OACjBoK,EAAM,UAAU,IAAI,WAAW,EAC/B,MACF,CAEA,GAAI3vB,IAAY,QAAS,CACvBulB,EAAK,UAAY,QACjB,MACF,CAEAA,EAAK,UAAY,OACnB,CAIO,SAAS2N,IAAwB,CACtC,MAAMC,EAAct8B,EAAiB,qBAAqB,GAAK,GACzDu8B,EAAev8B,EAAiB,sBAAsB,GAAK,GACjE,OAAIs8B,GAAe,UAAU,KAAKA,CAAW,EAAUA,EACnDC,GAAgB,UAAU,KAAKA,CAAY,EAAUA,EAClD,QACT,CAEO,SAASC,IAA2B,CACzC,MAAMtzB,EAAOmzB,GAAA,EACI,SAAS,iBAAiB,oBAAoB,EACtD,QAAQ9oB,GAAM,CACrBA,EAAG,YAAcrK,EACjBqK,EAAG,aAAa,YAAarK,CAAI,CACnC,CAAC,CACH,CAEA,SAASuzB,IAAkC,CACzC,MAAMC,EAAsB18B,EAAyC,6BAA6B,EAClG,GAAI,MAAM,QAAQ08B,CAAmB,GAAKA,EAAoB,OAC5D,OAAOA,EAAoB,OAAOC,GAAKA,GAAKA,EAAE,SAAW,WAAW,EAAE,OAExE,MAAMtzB,EAAiBrJ,EAAyC,wBAAwB,EAClFkF,EAAWlF,EAAgC,kBAAkB,EAC7DmJ,EAAUnJ,EAAiB,iBAAiB,EAC5C48B,EAAiB58B,EAAkB,sBAAsB,EACzD68B,EAAgBxzB,EAAe,OAAOjE,GAAKA,GAAKA,EAAE,SAAW,WAAW,EAAE,OAChF,MAAI,CAACF,IAAaiE,IAAY,QAAUyzB,GAAkBC,EAAgB,GACjE,EAAIA,EAET33B,GAAYA,EAAS,KAAa,EAC/B,CACT,CAEA,eAAe43B,IAAgC,CAC7C,MAAM5zB,EAAOmzB,GAAA,EACb,GAAInzB,IAAS,SAAU,OAGvB,GADW,MAAM6lB,GAAoB7lB,CAAI,EACjC,CACN,MAAM2mB,EAAM4M,GAAA,EACZlK,EAAU,UAAU1C,CAAG,aAAa3mB,CAAI,EAAE,EAC1C,SAAS,iBAAiB,oBAAoB,EAAE,QAAQqK,GAAM,CAC5DA,EAAG,UAAU,IAAI,QAAQ,EACzB,WAAW,IAAMA,EAAG,UAAU,OAAO,QAAQ,EAAG,GAAI,CACtD,CAAC,CACH,MACEgf,EAAU,WAAW,CAEzB,CAIA,SAASwK,IAA6B,CAEpC,GADiB/8B,EAAgC,kBAAkB,EACrD,CACZuyB,EAAU,qBAAqB,EAC/B,MACF,CACAxE,GAAkB,IAAM,CACtB,MAAM5a,EAAU,SAAS,eAAe,sBAAsB,EAC1DA,IACFA,EAAQ,UAAU,IAAI,QAAQ,EAC9Bgc,GAAA,EAEJ,CAAC,CACH,CAEA,SAAS6N,IAA8B,CACrCjP,GAAkB,IAAM,CACtB,MAAM5a,EAAU,SAAS,eAAe,sBAAsB,EAC1DA,IACFA,EAAQ,UAAU,OAAO,QAAQ,EACjCgc,GAAA,EAEJ,CAAC,CACH,CAEA,SAAS8N,IAAyB,CAEhC,GADiBj9B,EAAgC,kBAAkB,EACrD,CACZuyB,EAAU,wBAAwB,EAClC,MACF,CACAxE,GAAkB,IAAM,CACtB,MAAM5a,EAAU,SAAS,eAAe,qBAAqB,EACzDA,IACFA,EAAQ,UAAU,IAAI,QAAQ,EAC9Bgc,GAAA,GAEF,MAAM7C,EAAQ,SAAS,eAAe,mBAAmB,EACrDA,GAAO,WAAW,IAAMA,EAAM,QAAS,GAAG,CAChD,CAAC,CACH,CAEA,SAAS4Q,IAA0B,CACjCnP,GAAkB,IAAM,CACtB,MAAM5a,EAAU,SAAS,eAAe,qBAAqB,EACzDA,IACFA,EAAQ,UAAU,OAAO,QAAQ,EACjCgc,GAAA,EAEJ,CAAC,CACH,CAIA,SAASgO,IAAyB,CAEhC,GADiBn9B,EAAgC,kBAAkB,EACrD,CACZuyB,EAAU,mBAAmB,EAC7B,MACF,CACA,MAAMjG,EAAQ,SAAS,eAAe,YAAY,EAClD,GAAI,CAACA,EAAO,CACVhwB,EAAI,KAAK,4BAA4B,EACrCi2B,EAAU,eAAe,EACzB,MACF,CACAjG,EAAM,OACR,CAIA,SAAS5a,IAA0B,CAEjC,GADqB1R,EAAiB,UAAU,IAC3Bf,EAAU,gBAAiB,CAC9CszB,EAAU,gCAAgC,EAC1C,MACF,CAEiBvyB,EAAgC,kBAAkB,EAKjEhD,EAAI,KAAK,gBAAgB,GAHzBu1B,EAAU,kBAAkB,EAC5Bv1B,EAAI,KAAK,oBAAqB,CAAE,KAAM0C,EAAI,sBAAuB,EAIrE,CAIA,IAAI09B,GAAe,GAEnB,eAAeC,IAAwC,CACrD,GAAI,CAAAD,GACJ,CAAAA,GAAe,GAEf,GAAI,CACF,MAAME,EAAe,SAAS,eAAe,eAAe,EAE5D,GADiB,CAAC,EAAEA,GAAgBA,EAAa,UAAU,SAAS,QAAQ,GAC9D,CACZ7I,GAAU,MAAM,EAChB,MACF,CAEA,MAAMvvB,EAAWlF,EAAgC,kBAAkB,EAC7DmJ,EAAUnJ,EAAiB,iBAAiB,EAElD,GADmB,CAAC,EAAEkF,GAAYiE,IAAY,UAEhC,MAAMorB,GAAW,CAC3B,MAAO,QACP,QAAS;AAAA,kBACT,WAAY,KACZ,cAAe,OACf,aAAc,YACf,GACO,SAAW,KAAM,OAG3Bv3B,EAAI,KAAK,oBAAoB,CAC/B,SACEogC,GAAe,EACjB,EACF,CAIA,SAASG,IAAqC,CAC5C,GAAKrgC,GACL,GAAI,CACa,MAAM,KAAK,SAAS,iBAAiB,qBAAqB,CAAC,EACnE,QAASsgC,GAAU,CACxB,MAAMC,EAAeD,EAAM,QAAQ,cAAc,EACjD,GAAI,CAACC,EAAc,OAEnB,IAAIC,EAA+B,KACnC,MAAMC,EAAO,IAAM,CACbD,IAAkB,OAAMA,EAAgBD,EAAa,MAAM,WAC/DA,EAAa,MAAM,UAAY,QACjC,EACMG,EAAS,IAAM,CACnBH,EAAa,MAAM,UAAaC,IAAkB,KAAQA,EAAgB,GAC1EA,EAAgB,IAClB,EAEAF,EAAM,iBAAiB,aAAcG,EAAM,CAAE,QAAS,GAAM,EAC5DH,EAAM,iBAAiB,WAAYI,EAAQ,CAAE,QAAS,GAAM,EAC5DJ,EAAM,iBAAiB,cAAeI,EAAQ,CAAE,QAAS,GAAM,CACjE,CAAC,CACH,OAAS,EAAG,CACVthC,EAAI,MAAM,0CAA2C,CAAC,CACxD,CACF,CAIA,SAASuhC,IAAoB,CAC3B,MAAMzvB,EAAS,SAAS,eAAe,aAAa,EACpD,GAAI,CAACA,EAAQ,CACX9R,EAAI,KAAK,6BAA6B,EACtC,MACF,CAEA8R,EAAO,iBAAiB,YAAa,IAAMhO,EAAS,mBAAoB,EAAI,CAAC,EAC7EgO,EAAO,iBAAiB,aAAc,IAAMhO,EAAS,mBAAoB,EAAI,CAAC,EAC9EgO,EAAO,iBAAiB,QAAS,IAAM,CACrC,MAAM0vB,EAAK,SAAS,eAAe,WAAW,EAC1CA,IAAIA,EAAG,UAAYje,GAAQ,WAAWzR,EAAO,KAAK,CAAC,EACzD,CAAC,EAEDA,EAAO,iBAAiB,SAAU,IAAM,CACtChO,EAAS,mBAAoB,EAAK,EAClC,MAAM,EAAI,WAAWgO,EAAO,KAAK,EAE3BlJ,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EAGzD,GAAIkF,GAAY,CAACuc,EAAY,OAG7B,GAAIvc,GAAYuc,EAAY,CAC1Bvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,aAAc,KAAM,EAAG,EACjD,MACF,CAGA,MAAM2R,EAAerR,EAAiB,UAAU,EAChD,GAAIqR,IAAiBpS,EAAU,gBAAiB,CAC9CjC,EAAI,KAAK,kBAAmB,CAAC,EAC7B,MACF,CAGIqU,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,cACzEjC,EAAI,KAAK,cAAe,CAAC,EAGzBA,EAAI,KAAK,sBAAuB,CAAC,CAErC,CAAC,EAEDoR,EAAO,iBAAiB,UAAW,IAAMhO,EAAS,mBAAoB,EAAK,CAAC,EAC5EgO,EAAO,iBAAiB,WAAY,IAAMhO,EAAS,mBAAoB,EAAK,CAAC,CAC/E,CAIA,SAAS29B,IAAyB,CAChC,MAAMn6B,EAAM5D,EAAiB,oBAAoB,GAAK,EAChDg+B,EAAU,SAAS,eAAe,eAAe,EACnDA,IAASA,EAAQ,MAAQ,OAAOp6B,EAAM,GAAG,GAC7Ck4B,GAAA,CACF,CAIO,SAASmC,IAA2B,CACzC,MAAMC,EAAM,CAACp/B,EAAYzB,EAAaX,IAAsB,CAC1D,MAAM6W,EAAK,SAAS,eAAezU,CAAE,EACjCyU,GAAIA,EAAG,iBAAiBlW,EAAKX,CAAE,CACrC,EAGAwhC,EAAI,WAAY,QAAS,IAAMzJ,GAAU,OAAO,CAAC,EACjDyJ,EAAI,iBAAkB,QAAS,IAAM,CACnC,GAAI,CACF,MAAMC,EAAM,SACN5qB,EAAK,SAAS,gBAEdsO,EADe,SAAS,cAAc,gBAAgB,GAC7BtO,EAEV,CAAC,EAAE,SAAS,mBAAqB4qB,EAAI,yBAKpD,SAAS,eAAgB,SAAS,iBAC7BA,EAAI,sBAAsBA,EAAI,uBAJnCtc,EAAO,kBAAmBA,EAAO,oBAC5BA,EAAO,yBAAyBA,EAAO,yBAKpD,MAAQ,CAAe,CACzB,CAAC,EAGD,MAAMuc,EAAY,SAAS,eAAe,YAAY,EACtD,GAAIA,EAAW,CACbA,EAAU,aAAa,OAAQ,QAAQ,EACvCA,EAAU,aAAa,WAAY,GAAG,EACtC,MAAMC,EAAa,MAAOxhC,GAAc,CACtC,GAAI,CAAEA,GAAG,mBAAoBA,GAAG,mBAAqB,MAAQ,CAAe,CAC5E,MAAMqM,EAAOmzB,GAAA,EACb,GAAI,CAACnzB,GAAQA,IAAS,SAAU,CAC9BqpB,EAAU,eAAe,EACzB,MACF,CAEA,GADW,MAAMxD,GAAoB7lB,CAAI,EACjC,CACN,MAAM2mB,EAAM4M,GAAA,EACZlK,EAAU,UAAU1C,CAAG,aAAa3mB,CAAI,EAAE,CAC5C,MACEqpB,EAAU,UAAUrpB,CAAI,EAAE,CAE9B,EACAk1B,EAAU,iBAAiB,QAASC,CAAU,EAC9CD,EAAU,iBAAiB,UAAYvhC,GAAM,CACtCA,EAAoB,MAAQ,SAAYA,EAAoB,MAAQ,KACzEwhC,EAAWxhC,CAAC,CACd,CAAC,CACH,CAGA,MAAMyhC,EAAO,SAAS,eAAe,UAAU,GAAK,SAAS,cAAc,WAAW,EAClFA,IACFA,EAAK,iBAAiB,QAAUzhC,GAAM,CACpCA,EAAE,iBACFA,EAAE,kBACFwgC,GAAA,CACF,CAAC,EACDiB,EAAK,iBAAiB,UAAYzhC,GAAM,CACjCA,EAAoB,MAAQ,SAAYA,EAAoB,MAAQ,MACzEA,EAAE,iBACFwgC,GAAA,EACF,CAAC,GAIHa,EAAI,WAAY,QAAS,IAAMlhC,EAAI,KAAK,qBAAqB,CAAC,EAC9DkhC,EAAI,WAAY,QAAS,IAAMlhC,EAAI,KAAK,oBAAoB,CAAC,EAC7DkhC,EAAI,WAAY,QAAS,IAAMlhC,EAAI,KAAK,qBAAqB,CAAC,EAC9DkhC,EAAI,eAAgB,QAAS,IAAMjC,GAAA,CAAY,EAC/CiC,EAAI,gBAAiB,QAAS,UAAkC,CAAEnC,GAAW,OAAO,KAAK,KAAK,CAAC,CAAG,CAAC,EACnGmC,EAAI,gBAAiB,SAAU,UAAkC,CAAElC,GAAY,OAAO,KAAK,KAAK,CAAC,CAAG,CAAC,EACrGkC,EAAI,WAAY,QAAS,IAAMxsB,GAAA,CAAmB,EAClDwsB,EAAI,mBAAoB,QAAS,IAAMnB,GAAA,CAAsB,EAG7DmB,EAAI,aAAc,QAAS,IAAMlhC,EAAI,KAAK,wBAAwB,CAAC,EACnEkhC,EAAI,cAAe,QAAS,IAAMlhC,EAAI,KAAK,yBAAyB,CAAC,EACrEkhC,EAAI,gBAAiB,QAAS,IAAMnB,GAAA,CAAsB,EAG1DmB,EAAI,iBAAkB,QAAS,IAAMf,GAAA,CAAkB,EACvDe,EAAI,qBAAsB,QAAS,IAAM,CAAElB,GAAA,EAAyBC,GAAA,CAAoB,CAAC,EACzFiB,EAAI,iBAAkB,QAAS,IAAM,CAAElB,GAAA,EAAyBhgC,EAAI,KAAK,eAAe,CAAG,CAAC,EAC5FkhC,EAAI,wBAAyB,QAAS,IAAMlB,GAAA,CAAuB,EAGnEkB,EAAI,oBAAqB,QAAS,UAAkC,CAAElhC,EAAI,KAAK,kBAAmB,KAAK,KAAK,CAAG,CAAC,EAChHkhC,EAAI,gBAAiB,QAAS,IAAMhB,GAAA,CAAmB,EACvDgB,EAAI,mBAAoB,QAAS,IAAMlhC,EAAI,KAAK,yBAAyB,CAAC,EAG1EkhC,EAAI,iBAAkB,QAAS,IAAM,CAAEzJ,GAAU,MAAM,EAAGz3B,EAAI,KAAK,eAAe,CAAG,CAAC,EAGtF6gC,GAAA,EAGAN,GAAA,EAGAvgC,EAAI,GAAG,wBAAyB,IAAI+nB,IAAqB,CACvDgZ,GAAA,CACF,IAGA/gC,EAAI,GAAG,6BAA8B,IAAI+nB,IAAqB,CAC5DoX,EAAA,CACF,IAGAn/B,EAAI,GAAG,uBAAwB,IAAI+nB,IAAqB,CACtDoX,EAAA,CACF,IAGAn/B,EAAI,GAAG,6BAA8B,IAAIT,IAAoB,CAC3D,MAAMuL,EAASvL,EAAK,CAAC,EACrBD,EAAI,KAAK,2BAA2BwL,CAAM,EAAE,EAC5Cq0B,EAAA,EACAK,GAAA,CACF,IAGA,SAAS,iBAAiB,QAAU3/B,GAAM,CACxBA,EAAE,QAAwB,UAAU,wBAAwB,IAE1EA,EAAE,iBACFigC,GAAA,EAEJ,CAAC,EAGD9/B,EAAI,GAAG,0BAA2B,IAAI+nB,IAAqB,CACzDyX,GAAA,CACF,IAGA,MAAM+B,EAAY,SAAS,eAAe,YAAY,EAClDA,GACFA,EAAU,iBAAiB,SAAW1hC,GAAM,CAC1CmgC,GAAA,EACAhgC,EAAI,KAAK,qBAAuBH,EAAE,OAA4B,KAAK,EAClEA,EAAE,OAA4B,MAAQ,EACzC,CAAC,EAIHG,EAAI,GAAG,cAAe,IAAIT,IAAoB,CAC5C,MAAMuK,EAAWvK,EAAK,CAAC,EACjBiiC,EAAQjiC,EAAK,CAAC,EACpBD,EAAI,MAAM,oBAAoBwK,CAAQ,IAAK03B,CAAK,EAChDjM,EAAU,aAAazrB,GAAY,SAAS,EAAE,CAChD,IAKA9J,EAAI,GAAG,iBAAkB,IAAIT,IAAoB,CAC/Cg2B,EAAUh2B,EAAK,CAAC,CAAW,CAC7B,IAGAS,EAAI,GAAG,kBAAmB,IAAIT,IAAoB,CAChD41B,GAAW51B,EAAK,CAAC,EAAcA,EAAK,CAAC,CAAuB,CAC9D,IAEAS,EAAI,GAAG,oBAAqB,IAAIT,IAAoB,CAClD01B,GAAa11B,EAAK,CAAC,CAAW,CAChC,IAGAS,EAAI,GAAG,qBAAsB,IAAIT,IAAoB,CACnD,MAAM4U,EAAU5U,EAAK,CAAC,EAChBmpB,EAAM,SAAS,eAAe,UAAU,EAC1CA,IACDA,EAA0B,SAAW,CAACvU,EACvCuU,EAAI,MAAM,QAAUvU,EAAU,IAAM,MAExC,IAGAnU,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtD,MAAMgkB,EAAUhkB,EAAK,CAAC,EAChBmpB,EAAM,SAAS,eAAe,UAAU,EAC1CA,GAAKA,EAAI,UAAU,OAAO,UAAWnF,CAAO,EAChD,MAAM2a,EAAOxV,GAAK,cAAc,MAAM,EAClCwV,GACFA,EAAK,aAAa,IAAK3a,EACnB,kCACA,eAAe,CAEvB,IAGAvjB,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD,MAAMomB,EAAMpmB,EAAK,CAAC,EACZ6R,EAAS,SAAS,eAAe,aAAa,EAC9CqwB,EAAS,SAAS,eAAe,UAAU,EAC7CrwB,IAAUA,EAAO,IAAM,OAAOuU,CAAG,GACjC8b,IAAQA,EAAO,UAAY5e,GAAQ8C,CAAG,EAC5C,IAGA3lB,EAAI,GAAG,iBAAkB,IAAI+nB,IAAqB,CAChD,MAAM3W,EAAS,SAAS,eAAe,aAAa,EAC9C0vB,EAAK,SAAS,eAAe,WAAW,EAC1C1vB,IAAUA,EAAO,MAAQ,KACzB0vB,MAAO,UAAY,OACzB,IAGA,IAAIY,EAAuD,KACvDC,EAAqB,EACzB3hC,EAAI,GAAG,iBAAkB,IAAI+nB,IAAqB,CAC5C2Z,iBAA6BA,CAAa,EAC9CC,EAAqB,EACrBD,EAAgB,YAAY,IAAM,CAChC,MAAMrtB,EAAerR,EAAiB,UAAU,EAChD,GAAI0d,EAAerM,CAAY,EAAG,CAC5BqtB,IAAiB,cAAcA,CAAa,EAAGA,EAAgB,MACnE,MACF,CACA,MAAMve,EAAMH,EAAA,EACN5R,EAAS,SAAS,eAAe,aAAa,EAC9C0vB,EAAK,SAAS,eAAe,WAAW,EACnC,SAAS,eAAe,UAAU,EAC7C,MAAMc,EAAY5+B,EAAkB,kBAAkB,EAClDoO,GAAU,CAACwwB,IACbxwB,EAAO,MAAQ,OAAO+R,CAAG,GAEvB2d,GAAM,CAACc,IAAWd,EAAG,UAAYje,GAAQM,CAAG,GAGhDwe,IACIA,GAAsB,IACxBA,EAAqB,EACrB3hC,EAAI,KAAK,oBAAoB,EAEjC,EAAG,GAAG,CACR,IAGAA,EAAI,GAAG,sBAAuB,IAAI+nB,IAAqB,CACrDvD,GAAA,CACF,IAEAxkB,EAAI,GAAG,eAAgB,IAAIT,IAAoB,CAC7C,MAAMojB,EAAOpjB,EAAK,CAAC,EAEnB,GAAI,CADayD,EAAgC,kBAAkB,EACpD,CACb0gB,EAAKf,CAAI,EACT,MAAMxJ,EAAoBnW,EAAiB,4BAA4B,EACvE0K,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAAigB,EAAM,MAAOxJ,EAAmB,EAC5DtE,GAAA,CACF,CACF,IAEA7U,EAAI,GAAG,uBAAwB,IAAIT,IAAoB,CACrD,MAAMojB,EAAOpjB,EAAK,CAAC,EACb2I,EAAWlF,EAAgC,kBAAkB,EAC7DyhB,EAAazhB,EAAkB,oBAAoB,EACzD,GAAIkF,GAAYuc,EACdvc,EAAS,KAAK,CAAE,KAAMxF,EAAI,aAAc,KAAAigB,EAAM,UACrC,CAACza,EAAU,CACpB,MAAMmM,EAAerR,EAAiB,UAAU,EAC1CmW,EAAoBnW,EAAiB,4BAA4B,EACnEqR,IAAiBpS,EAAU,eAAiBoS,IAAiBpS,EAAU,eACzEyhB,EAAKf,CAAI,EACTjV,EAAU,CAAE,KAAMhL,EAAI,KAAM,KAAAigB,EAAM,MAAOxJ,EAAmB,EAC5DtE,GAAA,GAEAzR,EAAS,kBAAmBuf,CAAI,CAEpC,CACF,IAGA3iB,EAAI,GAAG,0BAA2B,IAAI+nB,IAAqB,CACzDO,GAAA,CACF,IAEAtoB,EAAI,GAAG,2BAA4B,IAAI+nB,IAAqB,CAC1DY,GAAA,CACF,IAGA3oB,EAAI,GAAG,0BAA2B,IAAIT,IAAoB,CACxD,MAAMwd,EAAOxd,EAAK,CAAC,EACnB,GAAI,CAACwd,EAAM,OACX,MAAMyN,EAAQzN,EAAK,OAASA,EAAK,MAAQ,UACzC0U,GAAuBjH,CAAK,CAC9B,IAGAxqB,EAAI,GAAG,kBAAmB,IAAIT,IAAoB,CAChD,MAAMsiC,EAAgBtiC,EAAK,CAAC,EACtBuiC,EAAiBviC,EAAK,CAAC,EACvB2uB,EAAc3uB,EAAK,CAAC,EACpB6jB,EAAW7jB,EAAK,CAAC,EAEjB6R,EAAS,SAAS,eAAe,aAAa,EAC9C0vB,EAAK,SAAS,eAAe,WAAW,EACxCiB,EAAK,SAAS,eAAe,UAAU,EACvCH,EAAY5+B,EAAkB,kBAAkB,EAElDoO,GAAUgS,EAAW,IACvBhS,EAAO,IAAM,OAAOgS,CAAQ,EACvBwe,IAAWxwB,EAAO,MAAQ,OAAO8c,CAAW,IAE/C4S,GAAM,CAACc,IAAWd,EAAG,UAAYe,GACjCE,MAAO,UAAYD,EACzB,IAEAxiC,EAAI,KAAK,8BAA8B,CACzC,CC/rBO,SAAS0iC,GAASpuB,EAAoB,CAC3C,SAAS,iBAAiB,YAAY,EAAE,WAAc2C,EAAG,UAAU,OAAO,QAAQ,CAAC,EACnF,MAAMzU,EAAK8R,IAAS,QAAU,cAAgBA,IAAS,OAAS,aAAe,eAC/E,SAAS,eAAe9R,CAAE,GAAG,UAAU,IAAI,QAAQ,EAGnD,MAAM+yB,EAAYjhB,IAAS,QAAU,EAAIA,IAAS,OAAS,EAAI,EAC/D,SAAS,iBAA8B,iBAAiB,EAAE,QAAQkhB,GAAO,CACvEA,EAAI,MAAM,YAAY,eAAgB,OAAOD,CAAS,CAAC,CACzD,CAAC,EAED,IAAIJ,EAAW7gB,EACXA,IAAS,WACX6gB,EAAW,OAAO,WAAW,8BAA8B,EAAE,QAAU,OAAS,SAElF,SAAS,gBAAgB,aAAa,aAAcA,CAAQ,EAG5D,GAAI,CAAE,aAAa,QAAQ,mBAAoB7gB,CAAI,CAAG,MAAQ,CAAe,CAG7E,SAAS,gBAAgB,MAAM,YAAc6gB,EAC7C,MAAMwN,EAAY,SAAS,cAAc,0BAA0B,EAC/DA,GAAWA,EAAU,aAAa,UAAWxN,IAAa,OAAS,UAAY,SAAS,EAC5F,MAAMyN,EAAa,SAAS,cAAc,2BAA2B,EACjEA,GAAYA,EAAW,aAAa,UAAWzN,CAAQ,CAC7D,CAIO,SAAS0N,GAA4BvuB,EAAoB,CAClD,SAAS,iBAAiB,iCAAiC,EACnE,QAAQ/T,GAAKA,EAAE,UAAU,OAAO,QAAQ,CAAC,EAC7C,MAAM0W,EAAK,SAAS,cAAc,mCAAmC3C,CAAI,IAAI,EACzE2C,GAAIA,EAAG,UAAU,IAAI,QAAQ,CACnC,CAEA,SAAS9B,GAAWb,EAAc2C,EAAmB,CAEnD,GADiBvT,EAAgC,kBAAkB,EACrD,CACZuyB,EAAU,wBAAwB,EAClC,MACF,CAEA4M,GAA4BvuB,CAAI,EAChC5T,EAAI,KAAK,yBAA0B4T,CAAI,CACzC,CAIA,SAASwuB,GAAkBz6B,EAAc8I,EAAepN,EAAgBmP,EAAY,GAAa,CAC/FxS,EAAI,KAAK,sBAAuB2H,EAAM8I,EAAOpN,EAAOmP,CAAS,CAC/D,CAEA,SAASjB,GAAUlO,EAAgBmP,EAAY,GAAa,CAC1DxS,EAAI,KAAK,mBAAoBqD,EAAOmP,CAAS,CAC/C,CAEA,SAAS1B,GAAMyB,EAAclP,EAAgBmP,EAAY,GAAa,CACpExS,EAAI,KAAK,eAAgBuS,EAAMlP,EAAOmP,CAAS,CACjD,CAEA,SAAS3B,IAAoB,CAC3B7Q,EAAI,KAAK,oBAAoB,EAE7B,MAAMqiC,EAAmC,CACvC,gBAAiB,EACjB,sBAAuB,EACvB,yBAA0B,GAC1B,uBAAwB,EACxB,wBAAyB,GAE3B,SAAW,CAACvgC,EAAI4O,CAAG,IAAK,OAAO,QAAQ2xB,CAAQ,EAAG,CAChD,MAAM9rB,EAAK,SAAS,eAAezU,CAAE,EACjCyU,IAAIA,EAAG,MAAQ,OAAO7F,CAAG,EAC/B,CACF,CAEA,SAASW,IAAgB,CACvBrR,EAAI,KAAK,gBAAgB,EAEzB,MAAMsE,EAAS,SAAS,eAAe,eAAe,EAClDA,MAAe,MAAQ,KAC3B,QAAShB,EAAI,EAAGA,EAAI,EAAGA,IAAK,CAC1B,MAAMg/B,EAAK,SAAS,eAAe,aAAah/B,CAAC,EAAE,EAC/Cg/B,MAAO,MAAQ,IACrB,CACF,CAEA,SAASC,IAAoB,CAC3BviC,EAAI,KAAK,oBAAoB,EAC7B,MAAMuW,EAAK,SAAS,eAAe,cAAc,EAC7CA,MAAO,MAAQ,MACrB,CAEA,SAASisB,IAAmB,CAC1BxiC,EAAI,KAAK,mBAAmB,EAC5B,MAAMuW,EAAK,SAAS,eAAe,cAAc,EAC7CA,MAAO,MAAQ,IACrB,CAIO,SAASksB,GAAiB10B,EAA4C,CAC3E,MAAMuf,EAAY,SAAS,eAAe,aAAa,EAClDA,IAELA,EAAU,UAAY,GAEtBvf,EAAK,QAAS3F,GAAM,CAClB,MAAM20B,EAAM,SAAS,cAAc,KAAK,EACxCA,EAAI,UAAY,cAEhB,MAAMr0B,EAAO,SAAS,cAAc,MAAM,EAC1CA,EAAK,UAAY,SACjBA,EAAK,YAAc,OAAON,EAAE,OAAS,QAAQ,EAE7C,MAAMs6B,EAAU,SAAS,cAAc,MAAM,EAM7C,GALAA,EAAQ,MAAM,QAAU,gDACxBA,EAAQ,YAAc,IAAI,OAAOt6B,EAAE,IAAM,EAAE,EAAE,OAAO,EAAE,CAAC,IACvDM,EAAK,YAAY,SAAS,eAAe,GAAG,CAAC,EAC7CA,EAAK,YAAYg6B,CAAO,EAEpBt6B,EAAE,KAAM,CACV,MAAMu6B,EAAK,SAAS,cAAc,MAAM,EACxCA,EAAG,MAAM,QAAU,2EACnBA,EAAG,YAAc,KACjBj6B,EAAK,YAAY,SAAS,eAAe,GAAG,CAAC,EAC7CA,EAAK,YAAYi6B,CAAE,CACrB,CAEA,MAAMC,EAAcx6B,EAAE,SAAW,YAAc,SAAW,WACpD0jB,EAAa1jB,EAAE,SAAW,YAAc,YAAc,eAEtDy6B,EAAS,SAAS,cAAc,MAAM,EAO5C,GANAA,EAAO,UAAY,YAAYD,CAAW,GAC1CC,EAAO,YAAc/W,EAErBiR,EAAI,YAAYr0B,CAAI,EAEH1F,EAAgC,kBAAkB,EAEjE+5B,EAAI,YAAY8F,CAAM,MACjB,CACL,MAAMC,EAAQ,SAAS,cAAc,KAAK,EAG1C,GAFAA,EAAM,MAAM,QAAU,6CAElB,CAAC16B,EAAE,QAAUA,EAAE,SAAW,YAAa,CACzC,MAAM26B,EAAQ,SAAS,cAAc,QAAQ,EAC7CA,EAAM,UAAY,cAAc36B,EAAE,KAAO,SAAW,EAAE,GACtD26B,EAAM,QAAQ,OAAS,OAAO36B,EAAE,IAAM,EAAE,EACxC26B,EAAM,MAAM,QAAU,sDAAsD36B,EAAE,KAAO,uDAAyD,EAAE,GAChJ26B,EAAM,YAAc36B,EAAE,KAAO,SAAW,QAExC26B,EAAM,iBAAiB,QAAUljC,GAAM,CACrCA,EAAE,iBACF,MAAMiL,EAASi4B,EAAM,QAAQ,OACzBj4B,GAAQ9K,EAAI,KAAK,0BAA2B8K,CAAM,CACxD,CAAC,EAEDg4B,EAAM,YAAYC,CAAK,CACzB,CAEAD,EAAM,YAAYD,CAAM,EACxB9F,EAAI,YAAY+F,CAAK,CACvB,CAEAxV,EAAU,YAAYyP,CAAG,CAC3B,CAAC,EACH,CAIO,SAASiG,IAAqB,CACnC,MAAM9B,EAAM,CAACp/B,EAAYzB,EAAaX,IAAsB,CAC1D,MAAM6W,EAAK,SAAS,eAAezU,CAAE,EACjCyU,GAAIA,EAAG,iBAAiBlW,EAAKX,CAAE,CACrC,EAGAwhC,EAAI,cAAe,QAAS,IAAMc,GAAS,OAAO,CAAC,EACnDd,EAAI,aAAc,QAAS,IAAMc,GAAS,MAAM,CAAC,EACjDd,EAAI,eAAgB,QAAS,IAAMc,GAAS,QAAQ,CAAC,EAGrDd,EAAI,UAAW,QAAS,IAAMnM,GAAgB,IAAI,CAAC,EACnDmM,EAAI,UAAW,QAAS,IAAMnM,GAAgB,IAAI,CAAC,EACnDmM,EAAI,cAAe,QAAS,IAAMnM,GAAgB,QAAQ,CAAC,EAG3D,SAAS,iBAA8B,iCAAiC,EAAE,QAAQxe,GAAM,CACtFA,EAAG,iBAAiB,QAAS,IAAM9B,GAAW,SAAS8B,EAAG,QAAQ,GAAK,EAAE,CAAK,CAAC,CACjF,CAAC,EAGD2qB,EAAI,sBAAuB,QAAS,IAAM,CAExC,GADiBl+B,EAAgC,kBAAkB,EACrD,CACZuyB,EAAU,wBAAwB,EAClC,MACF,CACA,MAAMpyB,EAAUH,EAAkB,sBAAsB,EACxDhD,EAAI,KAAK,wBAAyB,CAACmD,CAAO,EAG1C,MAAM8/B,EAAU,SAAS,eAAe,eAAe,EACjDC,EAAW,SAAS,eAAe,eAAe,EACpDD,IAASA,EAAQ,MAAM,QAAW9/B,EAAmB,GAAT,QAC5C+/B,IAAUA,EAAS,MAAM,QAAW//B,EAAe,OAAL,IAGlD,MAAMulB,EAAM,SAAS,eAAe,qBAAqB,EACrDA,GAAKA,EAAI,UAAU,OAAO,SAAU,CAACvlB,CAAO,CAClD,CAAC,EAGD,SAAS,iBAA8B,0CAA0C,EAAE,QAAQoT,GAAM,CAC/FA,EAAG,iBAAiB,QAAS,IAAM,CACjC,MAAMxF,EAAM,SAASwF,EAAG,QAAQ,WAAa,EAAE,EAC/CvW,EAAI,KAAK,6BAA8B+Q,CAAG,EAG1C,SAAS,iBAAiB,0CAA0C,EAAE,QACpElR,GAAKA,EAAE,UAAU,OAAO,QAAQ,GAElC0W,EAAG,UAAU,IAAI,QAAQ,CAC3B,CAAC,CACH,CAAC,EAGD2qB,EAAI,gBAAiB,QAAS,UAAkC,CAAElhC,EAAI,KAAK,sBAAuB,SAAU,QAAS,KAAK,MAAO,EAAI,CAAG,CAAC,EACzIkhC,EAAI,gBAAiB,SAAU,UAAkC,CAAElhC,EAAI,KAAK,sBAAuB,SAAU,QAAS,KAAK,KAAK,CAAG,CAAC,EACpIkhC,EAAI,gBAAiB,WAAY,UAAkC,CAAElhC,EAAI,KAAK,sBAAuB,SAAU,QAAS,GAAG,EAAG,KAAK,MAAQ,KAAO,CAAC,EAGnJkhC,EAAI,mBAAoB,QAAS,IAAMrwB,GAAA,CAAa,EAC9B,CACpB,CAAE,GAAI,gBAAiB,MAAO,MAAO,SAAU,GAC/C,CAAE,GAAI,sBAAuB,MAAO,QAAS,SAAU,GACvD,CAAE,GAAI,yBAA0B,MAAO,WAAY,SAAU,IAC7D,CAAE,GAAI,uBAAwB,MAAO,SAAU,SAAU,GACzD,CAAE,GAAI,wBAAyB,MAAO,UAAW,SAAU,EAAE,EAEjD,QAAQ,CAAC,CAAE,GAAA/O,EAAI,MAAA2O,EAAO,SAAA0yB,KAAe,CACjDjC,EAAIp/B,EAAI,QAAS,UAAkC,CAAEsgC,GAAkB,SAAU3xB,EAAO,KAAK,MAAO,EAAI,CAAG,CAAC,EAC5GywB,EAAIp/B,EAAI,SAAU,UAAkC,CAAEsgC,GAAkB,SAAU3xB,EAAO,KAAK,KAAK,CAAG,CAAC,EACvGywB,EAAIp/B,EAAI,WAAY,UAAkC,CAAEsgC,GAAkB,SAAU3xB,EAAO0yB,CAAQ,EAAG,KAAK,MAAQ,OAAOA,CAAQ,CAAG,CAAC,CACxI,CAAC,EAGDjC,EAAI,eAAgB,QAAS,IAAM7vB,GAAA,CAAS,EAC5C6vB,EAAI,gBAAiB,QAAS,UAAkC,CAAE3vB,GAAU,KAAK,MAAO,EAAI,CAAG,CAAC,EAChG2vB,EAAI,gBAAiB,SAAU,UAAkC,CAAE3vB,GAAU,KAAK,KAAK,CAAG,CAAC,EAC3F2vB,EAAI,gBAAiB,WAAY,IAAM,CAAE3vB,GAAU,CAAC,EAAG,MAAMgF,EAAK,SAAS,eAAe,eAAe,EAA2BA,MAAO,MAAQ,IAAK,CAAC,EACzJ,QAASjT,EAAI,EAAGA,EAAI,EAAGA,IACrB49B,EAAI,aAAa59B,CAAC,GAAI,QAAS,UAAkC,CAAEwN,GAAMxN,EAAG,KAAK,MAAO,EAAI,CAAG,CAAC,EAChG49B,EAAI,aAAa59B,CAAC,GAAI,SAAU,UAAkC,CAAEwN,GAAMxN,EAAG,KAAK,KAAK,CAAG,CAAC,EAC3F49B,EAAI,aAAa59B,CAAC,GAAI,WAAY,IAAM,CAAEwN,GAAMxN,EAAG,CAAC,EAAG,MAAMiT,EAAK,SAAS,eAAe,aAAajT,CAAC,EAAE,EAA2BiT,MAAO,MAAQ,IAAK,CAAC,EAI5J2qB,EAAI,mBAAoB,QAAS,IAAMqB,GAAA,CAAa,EACpDrB,EAAI,eAAgB,QAAS,UAAkC,CAAEkB,GAAkB,SAAU,MAAO,KAAK,MAAO,EAAI,CAAG,CAAC,EACxHlB,EAAI,eAAgB,SAAU,UAAkC,CAAEkB,GAAkB,SAAU,MAAO,KAAK,KAAK,CAAG,CAAC,EACnHlB,EAAI,eAAgB,WAAY,IAAMqB,GAAA,CAAa,EAGnDrB,EAAI,kBAAmB,QAAS,IAAMsB,GAAA,CAAY,EAClDtB,EAAI,eAAgB,QAAS,UAAkC,CAAEkB,GAAkB,QAAS,MAAO,KAAK,MAAO,EAAI,CAAG,CAAC,EACvHlB,EAAI,eAAgB,SAAU,UAAkC,CAAEkB,GAAkB,QAAS,MAAO,KAAK,KAAK,CAAG,CAAC,EAClHlB,EAAI,eAAgB,WAAY,IAAM,CAAEkB,GAAkB,QAAS,MAAO,CAAC,EAAG,MAAM7rB,EAAK,SAAS,eAAe,cAAc,EAA2BA,MAAO,MAAQ,IAAK,CAAC,EAG/K2qB,EAAI,oBAAqB,QAAS,IAAMlhC,EAAI,KAAK,aAAc,GAAG,CAAC,EACnEkhC,EAAI,mBAAoB,QAAS,IAAMlhC,EAAI,KAAK,aAAc,EAAE,CAAC,EACjEkhC,EAAI,kBAAmB,QAAS,IAAMlhC,EAAI,KAAK,aAAc,CAAC,CAAC,EAC/DkhC,EAAI,mBAAoB,QAAS,IAAMlhC,EAAI,KAAK,aAAc,EAAE,CAAC,EACjEkhC,EAAI,gBAAiB,QAAS,IAAMlhC,EAAI,KAAK,gBAAgB,CAAC,EAC9DkhC,EAAI,gBAAiB,QAAS,IAAMlhC,EAAI,KAAK,mBAAmB,CAAC,EAGjEA,EAAI,GAAG,8BAA+B,IAAIT,IAAoB,CAC5D,MAAMwO,EAAOxO,EAAK,CAAC,EACf,MAAM,QAAQwO,CAAI,MAAoBA,CAAI,CAChD,IAGA,GAAI,CACF,OAAO,WAAW,8BAA8B,EAAE,iBAAiB,SAAU,IAAM,CAC7D,SAAS,eAAe,cAAc,GACzC,UAAU,SAAS,QAAQ,GAC1Ci0B,GAAS,QAAQ,CAErB,CAAC,CACH,MAAQ,CAAe,CAGvB,MAAMoB,EAAa,aAAa,QAAQ,kBAAkB,EAC1DpB,GAASoB,GAAc,QAAQ,EAE/B9jC,EAAI,KAAK,wBAAwB,CACnC,CCtSA,MAAMmD,GAAmB,OACnB4gC,GAAkB,EAIxB,IAAIC,GAAkB,EAClBC,GAAyB,GACzBC,GAAmC,KACnCC,GAAuC,KAIvCC,GAA4C,KAC5CC,GAAkD,KAClDC,GAAgD,KAEpD,SAASC,IAA2B,CAClC,OAAO,OAAO,WAAW,qBAAqB,EAAE,OAClD,CAEA,SAASC,IAA+B,CACtC,GAAIJ,IAAyBC,GAC3B,GAAI,CACFA,GAA4B,aAAaD,GAAuBE,IAAoC,IAAI,CAC1G,MAAQ,CAAe,CAEzBF,GAAwB,KACxBC,GAA8B,KAC9BC,GAAmC,KACnC,MAAMG,EAAK,SAAS,eAAe,qBAAqB,EAClDC,EAAK,SAAS,eAAe,sBAAsB,EACrDD,MAAO,UAAY,IACnBC,MAAO,UAAY,GACzB,CAEA,SAASC,IAA6B,CACpC,MAAMC,EAAkB,SAAS,eAAe,qBAAqB,EAC/DC,EAAmB,SAAS,eAAe,sBAAsB,EACvE,GAAI,CAACD,GAAmB,CAACC,EAAkB,OAE3C,GAAI,CAACN,KAAmB,CACtBC,GAAA,EACA,MACF,CAEA,GAAIJ,IAAyBC,GAA6B,CACxD,GAAI,CACFA,GAA4B,aAAaD,GAAuBE,IAAoC,IAAI,CAC1G,MAAQ,CAAe,CACvBF,GAAwB,KACxBC,GAA8B,KAC9BC,GAAmC,IACrC,CACAO,EAAiB,UAAY,GAC7BD,EAAgB,UAAY,GAE5B,MAAME,EAAiF,CACrF,CAAE,GAAI,qBAAsB,QAAS,IAAM,SAAS,eAAe,gBAAgB,GACnF,CAAE,GAAI,kBAAmB,QAAU7tB,GAAOA,EAAG,cAAc,0BAA0B,GACrF,CAAE,GAAI,kBAAmB,QAAUA,GAAOA,EAAG,cAAc,sBAAsB,GACjF,CAAE,GAAI,kBAAmB,QAAUA,GAAOA,EAAG,cAAc,sBAAsB,EAAwB,EAG3G,UAAW8tB,KAAQD,EAAO,CACxB,MAAME,EAAS,SAAS,eAAeD,EAAK,EAAE,EAC9C,GAAI,CAACC,GAAUA,EAAO,MAAM,UAAY,OAAQ,SAEhD,MAAMC,EAAYD,EAAO,cAAc,oBAAoB,EACvDC,IAAWL,EAAgB,UAAYK,EAAU,WAErD,MAAMC,EAAYH,EAAK,QAAQC,CAAM,EACjCE,IACFb,GAA8Ba,EAAU,cACxCZ,GAAmCY,EAAU,YAC7Cd,GAAwBc,EACxBL,EAAiB,YAAYK,CAAS,GAExC,KACF,CACF,CAIA,SAASC,EAAQ3iC,EAAgC,CAC/C,OAAO,SAAS,eAAeA,CAAE,CACnC,CAEA,SAAS4iC,IAAyB,CAChC3T,GAAkB,IAAM,CACtB,MAAM4T,EAAKF,EAAQ,eAAe,EAC9BE,GAAIA,EAAG,UAAU,IAAI,QAAQ,EACjCxS,GAAA,EACA,GAAI,CAAE,SAAS,gBAAgB,UAAU,OAAO,kBAAkB,CAAG,MAAQ,CAAe,CAC5FoR,GAAyB,EAC3B,CAAC,CACH,CAEA,SAASqB,IAAyB,CAChC7T,GAAkB,IAAM,CACtB,MAAM5a,EAAUsuB,EAAQ,eAAe,EACnCtuB,GAASA,EAAQ,UAAU,OAAO,QAAQ,EAC9Cgc,GAAA,EACA0S,GAAA,EACA,GAAI,CAAE,SAAS,gBAAgB,UAAU,OAAO,kBAAkB,CAAG,MAAQ,CAAe,CAC5F,GAAI,CACF,sBAAsB,IAAM,CAC1B,GAAI,CAAO,SAAS,gBAAgB,YAAc,MAAQ,CAAe,CAC3E,CAAC,CACH,MAAQ,CAAe,CACzB,CAAC,CACH,CAEA,SAASC,GAAkBzW,EAAqB,CAC9C0C,GAAkB,IAAM,CACtB,MAAMgU,EAAMN,EAAQ,iBAAiB,EACjCM,IAAKA,EAAI,MAAM,QAAU1W,EAAO,OAAS,QAC7C4V,GAAA,CACF,CAAC,CACH,CAEA,SAASe,GAAa94B,EAAoB,CACxC,MAAMqK,EAAKkuB,EAAQ,YAAY,EAC3BluB,IACEA,EAAG,UAAY,QAAUA,EAAwB,MAAQrK,GAAQ,SAChEqK,EAAG,YAAcrK,GAAQ,UAEhC44B,GAAkB,CAAC,CAAC54B,CAAI,CAC1B,CAEA,SAAS+4B,GAAqB5W,EAAeqD,EAAO,GAAU,CAC5D,MAAMnb,EAAKkuB,EAAQ,mBAAmB,EACjCluB,IACLA,EAAG,MAAM,QAA2B,OACpCA,EAAG,YAAcmb,GAAQ,GAC3B,CAEA,SAASwT,GAAkB7W,EAAqB,CAC9C0C,GAAkB,IAAM,CACtB,MAAMxa,EAAKkuB,EAAQ,iBAAiB,EAChCluB,IAAIA,EAAG,MAAM,QAAU8X,EAAO,OAAS,QAC3C4V,GAAA,CACF,CAAC,CACH,CAEA,SAASkB,GAAkB9W,EAAqB,CAC9C0C,GAAkB,IAAM,CACtB,MAAMxa,EAAKkuB,EAAQ,iBAAiB,EAChCluB,IAAIA,EAAG,MAAM,QAAU8X,EAAO,OAAS,QAC3C4V,GAAA,CACF,CAAC,CACH,CAEA,SAASmB,GAAiB/W,EAAqB,CAC7C0C,GAAkB,IAAM,CACtB,MAAMxa,EAAKkuB,EAAQ,oBAAoB,EACnCluB,IAAIA,EAAG,MAAM,QAAU8X,EAAO,OAAS,QAC3C4V,GAAA,CACF,CAAC,CACH,CAEA,SAASoB,GAAsBC,EAAqB,CAClD,MAAMhW,EAAQmV,EAAQ,iBAAiB,EACnCnV,IAAOA,EAAM,SAAW,CAAC,CAACgW,GAE9B,MAAMC,EAAOd,EAAQ,iBAAiB,EAClCc,IACFA,EAAK,MAAM,cAAgBD,EAAO,OAAS,OAC3CC,EAAK,MAAM,QAAUD,EAAO,MAAQ,IAExC,CAEA,SAASE,GAAuB5xB,EAA2B,CAGzD,GAFa,SAAS,iBAA8B,wCAAwC,EACvF,QAAQ0iB,GAAKA,EAAE,UAAU,OAAO,UAAU,CAAC,EAC5C1iB,GAAS,KAA4B,CACvC,MAAM2C,EAAK,SAAS,cAAc,0CAA0C3C,CAAI,IAAI,EAChF2C,GAAIA,EAAG,UAAU,IAAI,UAAU,CACrC,CAEiB,SAAS,iBAA8B,qCAAqC,EACpF,QAAQA,GAAMA,EAAG,UAAU,OAAO,QAAQ,CAAC,EAEpD,IAAI+E,EAA0B,KAM9B,GALI1H,IAAS,GAAI0H,EAAW,YACnB1H,IAAS,EAAG0H,EAAW,YACvB1H,IAAS,EAAG0H,EAAW,iBACvB1H,IAAS,IAAG0H,EAAW,kBAE5BA,EAAU,CACZ,MAAMmqB,EAAM,SAAS,eAAenqB,CAAQ,EACxCmqB,GAAKA,EAAI,UAAU,IAAI,QAAQ,CACrC,CACF,CAaA,SAASC,GAAmBC,EAAwBC,EAAsD,MAAa,CACrH,MAAMvB,EAAOI,EAAQ,eAAe,EAC/BJ,IACLA,EAAK,UAAY,GAEjBA,EAAK,UAAU,OAAO,WAAY,sBAAsB,EACpDuB,IAAW,WAAYvB,EAAK,UAAU,IAAI,UAAU,EAC/CuB,IAAW,wBAAwBvB,EAAK,UAAU,IAAI,sBAAsB,EAErFsB,EAAQ,QAAQjd,GAAO,CACrB,MAAMza,EAAI,SAAS,cAAc,QAAQ,EACzCA,EAAE,GAAKya,EAAI,GACXza,EAAE,KAAO,SAELya,EAAI,OAAS,YAAaza,EAAE,UAAY,mBACnCya,EAAI,OAAS,YAAaza,EAAE,UAAY,mBACxCya,EAAI,OAAS,YAAaza,EAAE,UAAY,gBAC1C,UAAY,iBAEfya,EAAI,KAAMza,EAAE,UAAYya,EAAI,KACvBA,EAAI,OAAMza,EAAE,YAAcya,EAAI,MAEnCA,EAAI,WAAUza,EAAE,SAAW,IAC3Bya,EAAI,SAASza,EAAE,iBAAiB,QAASya,EAAI,OAAO,EACxD2b,EAAK,YAAYp2B,CAAC,CACpB,CAAC,EACH,CAEA,MAAM43B,GAAW,sGAIjB,SAASC,IAAyB,CAChCjB,GAAA,EACAp8B,EAAgB,mBAAoB,IAAM,CACxCs9B,GAAY,EAAI,CAClB,EAAG,IAAM,CAAE,SAAU,GAAM,CAC7B,CAEA,SAASlB,IAAwB,CAC/Bh8B,EAAkB,kBAAkB,CACtC,CAEA,SAASm9B,IAAuB,CAC9B,MAAMC,EAAQxB,EAAQ,iBAAiB,EACjCyB,EAAO,SAAS,iBAAiB,SAAS,EAC3CD,IAEJA,EAAsB,MAAM,UAAY,eAAe3C,GAAkB,GAAG,KAC7E4C,EAAK,QAAQ,CAACC,EAAKp1B,IAAQ,CACzBo1B,EAAI,UAAU,OAAO,SAAUp1B,IAAQuyB,EAAe,CACxD,CAAC,EACH,CAEA,SAASyC,GAAYK,EAAS,GAAa,CACrC9C,GAAkBD,GAAkB,EAAGC,KACtCA,GAAkB,EACvB0C,GAAA,EACII,IAAW,IAAMN,GAAA,CACvB,CAEA,SAASO,IAAoB,CACvB/C,GAAkB,EAAGA,QACFD,GAAkB,EACzC2C,GAAA,EACAF,GAAA,CACF,CAIA,SAASQ,IAAiC,CACxCZ,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAM,WAAY,KAAM,UAAW,QAASa,EAAA,EACpE,CAAE,GAAI,kBAAmB,KAAM,YAAa,KAAM,YAAa,QAASC,EAAA,CAAe,EACtF,UAAU,CACf,CAIA,SAASC,GAAuB7yB,EAAoB,CAClD,MAAMzH,EAAUnJ,EAAiB,iBAAiB,EAClD,GAAImJ,IAAY,SAAWA,IAAY,OAAQ,OAC/Cq3B,GAAoB5vB,EACpB4xB,GAAuB5xB,CAAI,EAC3BgrB,GAA6BhrB,CAAI,EAEjC,MAAM8yB,EAAU,SAAS,eAAe,gBAAgB,EACpDA,IACFA,EAAQ,UAAU,OAAO,kBAAkB,EAC3CA,EAAQ,UAAU,IAAI,gBAAgB,EAE1C,CAIA,SAASH,IAAsB,CAC7BvmC,EAAI,KAAK,gBAAgB,EAEzBoD,EAAS,kBAAmB,MAAM,EAClCA,EAAS,uBAAwB,EAAK,EACtCogC,GAAoB,KAEpB0B,GAAkB,EAAK,EACvBJ,GAAkB,EAAK,EACvBM,GAAiB,EAAK,EACtBD,GAAkB,EAAI,EACtBF,GAA0B,EAC1BO,GAAuB,IAAI,EAE3B,MAAMmB,EAAalC,EAAQ,gBAAgB,EACvCkC,IACFA,EAAW,MAAM,QAAU,OAC3B9B,GAAA,GAGFa,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMe,IAAiB,EAC3F,CACE,GAAI,iBAAkB,KAAM,OAAQ,KAAM,UAC1C,QAAS,IAAM,CACTpD,KAAsB,KAAMqD,GAAkBrD,EAAiB,IACpD,YAAY,CAC7B,EACF,EACC,sBAAsB,CAC3B,CAEA,eAAeqD,GAAkBjzB,EAA6B,CAE5D,GADgB5Q,EAAiB,iBAAiB,IAClC,OAAQ,OAExB,GAAI,CACFm/B,GAA4BvuB,CAAI,EAChC5T,EAAI,KAAK,yBAA0B4T,CAAI,CACzC,OAAS/T,EAAG,CAAEP,EAAI,KAAKO,CAAC,CAAG,CAE3BslC,GAAkB,EAAK,EACvBL,GAAkB,EAAI,EAEtB,MAAMgC,EAASrC,EAAQ,YAAY,EAC/BqC,IACEA,EAAO,UAAY,QAAUA,EAA4B,MAAQ,WACzD,YAAc,UAG5BpB,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMU,IAAc,EACxF,CAAE,GAAI,oBAAqB,KAAM,UAAW,KAAM,YAAa,SAAU,GAAK,EAC7E,sBAAsB,EAEzB,GAAI,CACF,MAAMr6B,EAAO,MAAMF,GAAA,EAEnB5I,EAAS,sBAAuB8I,CAAI,EACpC84B,GAAa94B,CAAI,EACjBszB,GAAA,EACAp8B,EAAS,wBAAyB,MAAM,EACxC+7B,EAAA,EACA8F,GAAqB,EAAK,EAE1BS,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMU,IAAc,EACxF,CAAE,GAAI,oBAAqB,KAAM,OAAQ,KAAM,UAAW,QAAS,IAAMQ,GAAA,CAAqB,CAAE,EAC/F,sBAAsB,CAC3B,OAASlnC,EAAG,CACVP,EAAI,MAAM,mCAAoCO,CAAC,EAC/C01B,EAAU,cAAc,EACxBgR,GAAA,CACF,CACF,CAEA,SAASQ,IAA6B,CACpB/jC,EAAiB,iBAAiB,IAClC,SAEhBI,EAAS,uBAAwB,EAAI,EACrCwhC,GAAA,EACArP,EAAU,4BAA4B,EACtC4J,EAAA,EAEA,WAAW,IAAM,CACf,MAAMzW,EAAM,SAAS,eAAe,kBAAkB,EAClDA,IACFA,EAAI,UAAU,IAAI,YAAY,EAC9BA,EAAI,iBAAiB,eAAgB,IAAM,CACzCA,EAAI,UAAU,OAAO,YAAY,CACnC,EAAG,CAAE,KAAM,GAAM,EAErB,EAAG,GAAG,EACR,CAIA,SAAS8d,IAAuB,CAC9BxmC,EAAI,KAAK,gBAAgB,EAEzBoD,EAAS,kBAAmB,OAAO,EACnCA,EAAS,uBAAwB,EAAK,EACtCogC,GAAoB,KAEpBhE,GAAA,EAEAsF,GAAkB,EAAK,EACvBI,GAAkB,EAAK,EACvBE,GAAiB,EAAK,EACtBD,GAAkB,EAAI,EACtBF,GAA0B,EAC1BO,GAAuB,IAAI,EAC3BH,GAAsB,EAAK,EAE3B,MAAMsB,EAAalC,EAAQ,gBAAgB,EACvCkC,IACFA,EAAW,MAAM,QAAU,OAC3B9B,GAAA,GAGFa,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMe,IAAiB,EAC3F,CACE,GAAI,iBAAkB,KAAM,OAAQ,KAAM,UAC1C,QAAS,IAAM,CACTpD,KAAsB,KAAMwD,GAAmBxD,EAAiB,IACrD,YAAY,CAC7B,EACF,EACC,sBAAsB,EAEzBpgC,EAAS,wBAAyB,KAAK,EACvC+7B,EAAA,CACF,CAEA,SAAS6H,GAAmBpzB,EAAoB,CAC9C6vB,GAAwB7vB,EAExBuxB,GAAkB,EAAK,EACvBD,GAAkB,EAAI,EACtBD,GAA0B,EAE1BS,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMW,IAAe,EACzF,CAAE,GAAI,oBAAqB,KAAM,OAAQ,KAAM,UAAW,QAAS,IAAMS,GAAwBxD,EAAsB,EAAE,EACxH,sBAAsB,EAEzB,MAAMnU,EAAQmV,EAAQ,iBAAiB,EACnCnV,IACFA,EAAM,MAAQ,GACdA,EAAM,QAEV,CAEA,eAAe2X,GAAwBrzB,EAAoC,CACzE,GAAIA,GAAS,KAA4B,CACvC2hB,EAAU,aAAa,EACvB,MACF,CAGA,GADgBvyB,EAAiB,iBAAiB,IAClC,QAAS,OAEzB,MAAMssB,EAAQmV,EAAQ,iBAAiB,EAEjCv4B,GADWojB,EAAQA,EAAM,MAAQ,IAAI,OACtB,QAAQ,OAAQ,EAAE,EAEvC,GAAI,CAAC,UAAU,KAAKpjB,CAAI,EAAG,CACzBqpB,EAAU,iBAAiB,EACvBjG,KAAa,QACjB,MACF,CAEAlsB,EAAS,uBAAwB8I,CAAI,EACrCszB,GAAA,EAEAp8B,EAAS,gCAAiCwQ,CAAI,EAC9CxQ,EAAS,kCAAmCwQ,CAAI,EAEhD,GAAI,CACFuuB,GAA4BvuB,CAAI,EAChC5T,EAAI,KAAK,yBAA0B4T,CAAI,CACzC,OAAS/T,EAAG,CAAEP,EAAI,KAAK,gCAAiCO,CAAC,CAAG,CAE5DuD,EAAS,wBAAyBX,EAAgB,EAClD08B,EAAA,EAEAkG,GAAsB,EAAI,EAC1BjiC,EAAS,uBAAwB,EAAI,EACrC+7B,EAAA,EAEAuG,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMW,IAAe,EACzF,CAAE,GAAI,oBAAqB,KAAM,YAAa,KAAM,UAAW,SAAU,GAAK,EAC7E,sBAAsB,EAEzBx5B,GAAYd,CAAI,CAClB,CAIA,SAAS06B,IAAyB,CAChC,MAAMD,EAAalC,EAAQ,gBAAgB,EACvCkC,IAAYA,EAAW,MAAM,QAAU,SAE3C7B,GAAkB,EAAK,EACvBI,GAAkB,EAAK,EACvBC,GAAkB,EAAK,EACvBC,GAAiB,EAAI,EACrBH,GAAqB,GAAO,EAAE,EAC9BI,GAAsB,EAAK,EAE3BjiC,EAAS,kBAAmB,MAAM,EAClCA,EAAS,sBAAuB,EAAE,EAClCkgC,GAAkB,EAClBlgC,EAAS,uBAAwB,EAAK,EACtCogC,GAAoB,KACpBC,GAAwB,KAExBtE,EAAA,EACA6G,GAAA,EACAM,GAAA,EAEA,MAAMY,EAAe,IAAM,CACzB,GAAI,CAAElnC,EAAI,KAAK,wBAAwB,CAAG,MAAQ,CAAe,CACjE0kC,GAAA,EACAoB,GAAA,CACF,EAEA,GAAI,CAACvC,GACH,GAAI,CAAE,SAAS,gBAAgB,UAAU,IAAI,kBAAkB,CAAG,MAAQ,CAAe,CAE3F2D,EAAA,EAGA,MAAMC,EAAU1C,EAAQ,SAAS,EAC7B0C,IAASA,EAAQ,QAAU,IAAMpB,GAAY,EAAK,GACtD,MAAMqB,EAAU3C,EAAQ,SAAS,EAC7B2C,IAASA,EAAQ,QAAU,IAAMf,GAAA,GAErC,SAAS,iBAA8B,SAAS,EAAE,QAAQF,GAAO,CAC/DA,EAAI,QAAWtmC,GAAM,CACnB,MAAMwnC,EAASxnC,EAAE,OAAuB,QAAQ,SAAS,EACnDkR,EAAM,SAASs2B,GAAO,SAAS,KAAO,GAAI,EAAE,EAC9C,MAAMt2B,CAAG,IACbuyB,GAAkBvyB,EAClBi1B,GAAA,EACAF,GAAA,EACF,CACF,CAAC,EAGD,MAAMwB,EAAW7C,EAAQ,oBAAoB,EAC7C,GAAI6C,EAAU,CACZ,IAAIC,EAAS,EACbD,EAAS,aAAgBznC,GAAM,CAAE0nC,EAAU1nC,EAAiB,QAAQ,CAAC,EAAE,OAAS,EAChFynC,EAAS,WAAcznC,GAAM,CAC3B,MAAM2nC,EAAQ3nC,EAAiB,eAAe,CAAC,EAAE,QAC3C4nC,EAAOF,EAASC,EAClB,KAAK,IAAIC,CAAI,EAAI,KACfA,EAAO,EAAG1B,GAAY,EAAK,EAC1BM,GAAA,EAET,CACF,CACF,CAEO,SAASqB,IAAkB,CAEhC,GAAI,CACU,OAAO,WAAW,qBAAqB,EAC/C,iBAAiB,SAAU,IAAMzD,GAAA,CAAsB,CAC7D,MAAQ,CAAe,CAGvB,MAAM0D,EAAW,SAAS,eAAe,iBAAiB,EACtDA,GACFA,EAAS,iBAAiB,QAAU9nC,GAAM,CACxC,MAAMkd,EAAQld,EAAE,OAAuB,QAAQ,SAAS,EACxD,GAAI,CAACkd,EAAM,OACX,MAAMnJ,EAAO,SAASmJ,EAAK,QAAQ,QAAU,GAAI,EAAE,EAC/C,MAAMnJ,CAAI,GACd6yB,GAAuB7yB,CAAI,CAC7B,CAAC,EAIH,SAASg0B,EAAmB/nC,EAAgB,CAC1C,MAAMkd,EAAQld,EAAE,OAAuB,QAAQ,kBAAkB,EACjE,GAAI,CAACkd,EAAM,OAEX,MAAMnJ,EADyC,CAAE,YAAa,GAAI,YAAa,EAAG,iBAAkB,EAAG,iBAAkB,GAC7FmJ,EAAK,EAAE,EAC/BnJ,IAAS,QAAW6yB,GAAuB7yB,CAAI,CACrD,CAEA,MAAMi0B,EAAW,SAAS,eAAe,iBAAiB,EACtDA,GAAUA,EAAS,iBAAiB,QAASD,CAAkB,EACnE,MAAME,EAAqB,SAAS,eAAe,sBAAsB,EACrEA,GAAoBA,EAAmB,iBAAiB,QAASF,CAAkB,EAGvF,MAAMG,EAAY,SAAS,eAAe,iBAAiB,EACvDA,IACFA,EAAU,iBAAiB,QAAS,IAAM,CACxC,MAAMxU,EAAMwU,EAAU,OAAS,GACzBC,EAASzU,EAAI,QAAQ,OAAQ,EAAE,EAAE,MAAM,EAAG,CAAC,EAC7CA,IAAQyU,IAAQD,EAAU,MAAQC,EACxC,CAAC,EACDD,EAAU,iBAAiB,UAAYloC,GAAM,CACvCA,EAAE,MAAQ,UACdA,EAAE,iBACE4jC,KAA0B,MAC5BwD,GAAwBxD,EAAqB,EAEjD,CAAC,GAIHzjC,EAAI,GAAG,sBAAuB,IAAIT,IAAoB,CACpD,MAAMuL,EAASvL,EAAK,CAAC,EACf0oC,EAAS,SAAS,eAAe,OAAO,EAC1CA,GAAUn9B,IAAQm9B,EAAO,UAAYn9B,GACzCq0B,EAAA,CACF,IAGAn/B,EAAI,GAAG,sBAAuB,IAAI+nB,IAAqB,CACrD6c,GAAA,EACAzF,EAAA,CACF,IAGAn/B,EAAI,GAAG,4BAA6B,IAAI+nB,IAAqB,CAC3D3kB,EAAS,uBAAwB,EAAK,EACtC+7B,EAAA,EACAyF,GAAA,CACF,IAEA5kC,EAAI,GAAG,4BAA6B,IAAIT,IAAoB,CAC1D6D,EAAS,uBAAwB,EAAK,EACtC+7B,EAAA,EACA5J,EAAU,wCAAwC,EAElDmQ,GAAmB,CACjB,CAAE,GAAI,iBAAkB,KAAMG,GAAU,KAAM,YAAa,QAAS,IAAMW,IAAe,EACzF,CAAE,GAAI,oBAAqB,KAAM,OAAQ,KAAM,UAAW,QAAS,IAAMS,GAAwBxD,EAAsB,EAAE,EACxH,sBAAsB,EAEzB,MAAMnU,EAAQmV,EAAQ,iBAAiB,EACnCnV,IACFA,EAAM,SAAW,GACjBA,EAAM,SAER+V,GAAsB,EAAK,CAC7B,IAGArlC,EAAI,GAAG,sBAAuB,IAAI+nB,IAAqB,CACrD1a,GAAA,EACAu5B,GAAA,CACF,IAGA5mC,EAAI,GAAG,iBAAkB,IAAIT,IAAoB,CAC/C,MAAM6K,EAAM7K,EAAK,CAAC,EACZ+H,EAAO8C,GAAsB,SAAW,GACxC89B,EAAY99B,GAAO,OAAOA,GAAQ,SAAY,OAAOA,EAAI,MAAQ,EAAE,EAAI,GAC7E,IAAI+9B,EAAU,iBAGV7gC,IAAQ,mBAAoB6gC,EAAU,yCACjC7gC,IAAQ,oBAAqB6gC,EAAU,iBACvC7gC,IAAQ,wBAAyB6gC,EAAU,qBAC3C7gC,IAAQ,iBAAkB6gC,EAAU,YACpC7gC,IAAQ,iBAAkB6gC,EAAU,sBACpC7gC,IAAQ,sBAAuB6gC,EAAU,kBACzC7gC,IAAQ,aAAc6gC,EAAU,cAEhCD,IAAa,mBAAoBC,EAAU,iCAC3CD,IAAa,UAAWC,EAAU,qCAClCD,IAAa,eAAgBC,EAAU,uCACvCD,IAAa,gBAAkBA,IAAa,gBAAiBC,EAAU,kBACvED,IAAa,iBAAkBC,EAAU,gCACzCD,IAAa,WAAUC,EAAU,uCAErBnlC,EAAkB,sBAAsB,GAG3DuyB,EAAU4S,CAAO,EACjBnoC,EAAI,KAAK,2BAA4BoK,CAAG,GAC/B9C,IAAQ,qBAAuBA,IAAQ,wBAEhDiwB,GAAW,CACT,MAAO,YACP,QAAS,GAAG4Q,CAAO;AAAA,aACnB,WAAY,QACZ,cAAe,OAChB,EAAE,KAAKC,GAAO,CACb,GAAIA,EAAI,SAAW,KAAM,CAEvB,MAAMC,EAAWrlC,EAAiB,sBAAsB,GAAK,GAE7D,GADAwjC,GAAA,EACI6B,EAAU,CACZ,MAAM/Y,EAAQmV,EAAQ,iBAAiB,EACnCnV,IAASA,EAAM,MAAQ+Y,EAAU/Y,EAAM,QAC7C,CACF,MACEsX,GAAA,CAEJ,CAAC,EAEDrR,EAAU4S,CAAO,CAErB,IAGAnoC,EAAI,GAAG,wBAAyB,IAAIT,IAAoB,CACtD,MAAM+H,EAAM/H,EAAK,CAAC,GAAe,aACjCg4B,GAAW,CAAE,MAAO,YAAa,QAAS,OAAOjwB,CAAG,EAAG,EACvDk/B,GAAA,CACF,IAGAxmC,EAAI,GAAG,+BAAgC,IAAI+nB,IAAqB,CAC9DwN,EAAU,mBAAmB,EAC7Bv1B,EAAI,KAAK,oBAAoB,CAC/B,IAGA4mC,GAAA,EAEAtnC,EAAI,KAAK,qBAAqB,CAChC,CC7uBA,IAAIgpC,GAAiB,GACjBC,GAAe,GAEZ,SAASC,IAA8B,CAC5C,GAAI,EAAE,kBAAmB,WAAY,CACnClpC,EAAI,KAAK,mCAAmC,EAC5C,MACF,CAEA,GAAI,CAAC,OAAO,gBAAiB,CAC3BA,EAAI,KAAK,kDAAkD,EAC3D,MACF,CAEA,MAAMmpC,EAAa,SAAY,CAE7B,MAAMC,EAAQ,IAAI,IAAI,oBAAqB,OAAO,SAAS,IAAI,EAE/D,GAAI,CACF,MAAMC,EAAM,MAAM,UAAU,cAAc,SAASD,EAAO,CAAE,MAAO,KAAM,EACzEppC,EAAI,KAAK,mBAAoBqpC,EAAI,KAAK,EAGtC,UAAU,cAAc,iBAAiB,mBAAoB,IAAM,CAC7D,CAACL,IAAkBC,KACvBA,GAAe,GACf,OAAO,SAAS,SAClB,CAAC,EAGDI,EAAI,iBAAiB,cAAe,IAAM,CACxC,MAAMC,EAAYD,EAAI,WACjBC,GAELA,EAAU,iBAAiB,cAAe,SAAY,CAEpD,GAAIA,EAAU,QAAU,aAAe,UAAU,cAAc,WAC7D,GAAI,CACF,MAAM9oC,EAAS,MAAMy3B,GAAW,CAC9B,MAAO,OACP,QAAS,qCACT,WAAY,OACZ,YAAa,GACd,EAGD,GAAI,CAACz3B,GAAUA,EAAO,SAAW,KAAM,OAEvCwoC,GAAiB,GACbK,EAAI,QACNA,EAAI,QAAQ,YAAY,CAAE,KAAM,eAAgB,EAG3CJ,KACHA,GAAe,GACf,OAAO,SAAS,SAGtB,MAAQ,CAER,CAEJ,CAAC,CACH,CAAC,EAGD,YAAY,IAAM,CAChBI,EAAI,SAAS,MAAM,IAAM,CAAe,CAAC,CAC3C,EAAG,KAAU,GAAI,EAEjBA,EAAI,SAAS,MAAM,IAAM,CAAe,CAAC,CAC3C,OAASv+B,EAAK,CACZ9K,EAAI,KAAK,4BAA6B8K,CAAG,CAC3C,CACF,EAGI,SAAS,aAAe,WAC1Bq+B,EAAA,EAEA,OAAO,iBAAiB,OAAQA,EAAY,CAAE,KAAM,GAAM,CAE9D,CCxBA,SAASI,IAAiC,CAEnC,OAAO,kBACV7oC,EAAI,KAAK,gBAAiB,2BAA2B,EACrDV,EAAI,KAAK,4BAA4B,GAIjC,UAAU,SAAW,UAAU,QAAQ,eAC3CU,EAAI,KAAK,gBAAiB,yCAAyC,EACnEV,EAAI,KAAK,0BAA0B,GAIrC,MAAMwpC,EAAmB,GAErB,OAAQ,OAA8C,KAAS,KACjEA,EAAO,KAAK,kBAAkB,EAE5B,OAAQ,OAA8C,KAAS,KACjEA,EAAO,KAAK,iBAAiB,EAG3BA,EAAO,OAAS,GAClBxpC,EAAI,MAAM,8BAA+BwpC,EAAO,KAAK,IAAI,CAAC,EAC1D9oC,EAAI,KAAK,gBAAiB,wBAAwB8oC,EAAO,KAAK,IAAI,CAAC,kBAAkB,GAErFxpC,EAAI,KAAK,yCAAyC,CAEtD,CAIA,SAASypC,IAA8B,CACrC,OAAO,iBAAiB,UAAY,GAAqB,CAEvD,GAAI,EAAE,iBAAkB,OAGxB,MAAMC,EAAY,SAAS,eAAe,QAC1C,GAAIA,GAAa,CAAC,QAAS,WAAY,QAAQ,EAAE,SAASA,CAAS,EAAG,OAGtE,MAAMC,EAAe,EAAE,QAAoB,UACzC,iFAEF,IAAK,EAAE,MAAQ,KAAO,EAAE,OAAS,UAAYA,EAAa,OAE1D,MAAM50B,EAAerR,EAAiB,UAAU,EAC1C8S,EAAYzB,IAAiBpS,EAAU,eAC3BoS,IAAiBpS,EAAU,eAC3BoS,IAAiBpS,EAAU,gBAEzC,EAAE,MAAQ,KAAO,EAAE,OAAS,SAC9B,EAAE,iBACFjC,EAAI,KAAK,oBAAoB,GACpB,EAAE,MAAQ,KAAO,EAAE,MAAQ,IAC/B8V,GAAW9V,EAAI,KAAK,oBAAoB,GACpC,EAAE,MAAQ,KAAO,EAAE,MAAQ,MAChC8V,GAAW9V,EAAI,KAAK,oBAAoB,CAEhD,CAAC,EAEDV,EAAI,KAAK,qCAAqC,CAChD,CAIA,IAAI4pC,GAAqC,KAEzC,eAAeC,IAAiC,CAC9C,GAAI,CACE,aAAc,YAChBD,GAAY,MAAM,UAAU,SAAS,QAAQ,QAAQ,EACrD5pC,EAAI,MAAM,+BAA+B,EACzC4pC,GAAU,iBAAiB,UAAW,IAAM,CAC1C5pC,EAAI,MAAM,iCAAiC,EAC3C4pC,GAAY,IACd,CAAC,EAEL,OAAS9+B,EAAc,CACrB9K,EAAI,KAAK,2BAA4B8K,EAAc,IAAI,KAAMA,EAAc,OAAO,EAAE,CACtF,CACF,CAEA,SAASg/B,IAAqB,CAE5BD,GAAA,EAGA,SAAS,iBAAiB,mBAAoB,IAAM,CAC9CD,KAAc,MAAQ,SAAS,kBAAoB,WACrDC,GAAA,CAEJ,CAAC,EAED7pC,EAAI,KAAK,6BAA6B,CACxC,CAIA,OAAO,QAAU,CAACgI,EAAKwrB,EAAKuW,EAAMC,EAAKl/B,KACrC9K,EAAI,MAAM,YAAYgI,CAAG,OAAOwrB,CAAG,IAAIuW,CAAI,IAAIC,CAAG,GAAIl/B,CAAG,EAClD,IAET,OAAO,iBAAiB,qBAAuB,GAAM,CACnD9K,EAAI,MAAM,gCAAiC,EAAE,MAAM,CACrD,CAAC,EAID,SAASiqC,IAAyB,CAChC,OAAO,iBAAiB,eAAgB,IAAM,CAC5C,GAAI,CAAEl8B,GAAA,CAAgB,MAAQ,CAAa,CAC7C,CAAC,CACH,CAIA,SAASm8B,IAAkB,CACzBlqC,EAAI,KAAK,6CAA6CmC,EAAW,GAAG,EAGpEF,GAAA,EAGA,GAAI,CAAE8wB,GAAA,CAA2B,MAAQ,CAAe,CACxDoD,GAAA,EACA+B,GAAA,EACAI,GAAA,EACA5C,GAAA,EAGAxN,GAAA,EACA8C,GAAA,EACAzI,GAAA,EACAiJ,GAAA,EAIArX,GAAA,EAIAlL,GAAA,EACAqG,GAAA,EACAmH,GAAA,EACA0F,GAAA,EAGA,GAAI,CACF,MAAMguB,EAAQ,IAAI,OAChB,2DACA,CAAE,KAAM,SAAS,EAEnBlgC,GAAckgC,CAAK,EACnBA,EAAM,YAAY,CAAE,QAAS,gBAAiB,WAAYhoC,GAAa,EACvEnC,EAAI,KAAK,0BAA0B,CACrC,OAASO,EAAG,CACVP,EAAI,KAAK,2BAA4BO,CAAC,CACxC,CAEA,GAAI,CACF,MAAM6pC,EAAY,IAAI,OACpB,+DACA,CAAE,KAAM,SAAS,EAEnBtgC,GAAkBsgC,CAAS,EAC3BA,EAAU,YAAY,CAAE,QAAS,gBAAiB,WAAYjoC,GAAa,EAC3EnC,EAAI,KAAK,8BAA8B,CACzC,OAASO,EAAG,CACVP,EAAI,KAAK,+BAAgCO,CAAC,CAC5C,CAEA2a,GAAA,EACA6D,GAAA,EACAwB,GAAA,EAGAsP,GAAA,EACA0B,GAAA,EAGAoJ,GAAA,EACAwD,GAAA,EACAiB,GAAA,EACAuC,GAAA,EACA+B,GAAA,EACA0E,GAAA,EAGAc,GAAA,EAGAO,GAAA,EACAK,GAAA,EACAG,GAAA,EAGA,WAAWV,GAA0B,GAAG,EAGxC,MAAMc,EAAW,CACf,MAAOhmC,GACP,IAAA3D,EACA,UAAAoG,GACA,aAAAF,GACA,cAAA2I,GACA,eAAA8E,EAAA,EAED,OAA8C,OAASg2B,EAExDrqC,EAAI,KAAK,+CAA+C,CAC1D,CAGI,SAAS,aAAe,UAC1B,SAAS,iBAAiB,mBAAoBkqC,GAAW,CAAE,KAAM,GAAM,EAEvEA,GAAA","names":["LOG_LEVEL","_logLevel","host","log","args","EventBusImpl","event","fn","set","wrapper","e","result","key","bus","IS_IOS","IS_ANDROID","isStandaloneDisplayMode","preventIOSPinchZoom","evt","_appHeightRaf","_lastSoftKeyHeight","_platformClassesApplied","updateAppHeightNow","root","vv","isStandalone","isLandscape","validHeights","h","softKeyHeight","scr","delta","dH","scrDimH","navBottom","scheduleAppHeightUpdate","initPlatform","run","INSTANCE_ID","_globalSessionCounter","nextSessionId","_warnedBadSessionIds","validateSessionId","id","strict","sid","APP_STATE","TRANSFER_STATE","CHUNK_SIZE","WATCHDOG_TIMEOUT","MAX_RECOVERY_RETRIES","RECOVERY_BACKOFF","DELAY","MAX_GUEST_SLOTS","PEER_NAME_PREFIX","MSG","EQ_FREQUENCIES","DEMO_FILE_NAME","DEMO_TITLE","createInitialState","_state","getState","path","keys","current","setState","value","i","lastKey","eventPath","batchSetState","updates","snapshot","toneSplit","toneMerge","gainL","gainR","masterGain","reverb","rvbLowCut","rvbHighCut","rvbCrossFade","eqNodes","preamp","widener","globalLowPass","analyser","vbFilter","vbCheby","vbPostFilter","vbGain","surroundSplitter","surroundGain","_initAudioPromise","getMasterGain","getToneMerge","getGainL","getGainR","getPreamp","getWidener","getReverb","getRvbLowCut","getRvbHighCut","getRvbCrossFade","getEqNodes","getGlobalLowPass","getVbFilter","getVbPostFilter","getVbGain","getSurroundSplitter","getSurroundGain","isAudioReady","ensureSurroundNodes","initAudio","_doInitAudio","f","reverbErr","eqIn","fx","silentAudio","videoEl","vol","clamped","playerNode","channelIdx","splitter","gain","pre","validateMessage","data","requiredFields","msg","field","RELAYABLE_COMMANDS","_handlers","registerHandler","type","handler","registerHandlers","handlers","handleData","conn","msgType","hostConn","downstreamDataPeers","p","verifyOperator","peer","initProtocol","_timers","setManagedTimer","name","delayMs","opts","clearManagedTimer","clearAllManagedTimers","getManagedTimer","_transferWorker","_syncWorker","WORKER_TIMER_IDS","OPFS_INSTANCE_ID","setTransferWorker","worker","handleTransferWorkerMessage","setSyncWorker","handleSyncWorkerMessage","postWorkerCommand","payload","transfers","cmd","buildSafeOpfsName","filename","isPreload","sanitized","cleanupOPFSInWorker","readFileFromOpfs","safeName","err","stopBackgroundWorkerTimers","ensureNamedFile","blob","fallbackName","getPeer","getPeerLabelBySlot","slot","getAvailablePeerSlot","preferredSlot","peerId","peerSlots","pref","occupant","assignPeerSlot","s","releasePeerSlot","map","initNetwork","requestedId","peerOpts","customPeerServer","setupPeerEvents","resolve","reject","onOpen","onError","generateSessionCode","createHostSessionWithShortCode","maxAttempts","code","appRole","handleHostIncomingConnection","connectedPeers","activeHostConnByPeerId","existingActiveConn","filtered","sendFullAndClose","deviceName","peerLabels","peerObj","updatedPeers","broadcastDeviceList","peers","joinSession","hostId","retryAttempt","channelMode","timeoutId","leaveSession","peerSlotByPeerId","fileReorderBuffer","preloadReorderBuffer","preloadSessionState","broadcast","isDataOnly","broadcastExcept","excludePeerId","myId","list","a","b","x","handleWelcome","handleSessionFull","handleDeviceListUpdateMsg","me","handleForceCloseDuplicate","handleSysToast","handleOperatorGrant","handleOperatorRevoke","handleSessionStart","initPeerHandlers","applySettings","reverbMix","reverbDecay","reverbPreDelay","reverbLowCut","reverbHighCut","stereoWidth","virtualBass","eqValues","userPreampGain","isSurroundMode","surroundChannelIndex","subFreq","crossFade","rev","needsGenerate","rlc","lFreq","rhc","hFreq","nodes","node","compensation","wid","isWooferRole","vbpf","vbg","setReverbParam","param","val","skipApply","v","resetReverb","setEQ","idx","bandIdx","bandVal","label","bands","slider","resetEQ","count","setPreamp","valDb","db","linear","setStereoWidth","resetStereoWidth","setVirtualBass","resetVirtualBass","updateSubFreq","freq","vbf","isSubMode","isLFE","lp","_broadcastOrRequestSetting","_broadcastOrRequestSettingEQ","band","isPreview","masterVolume","handleVolume","handleEQUpdateMsg","handlePreampMsg","handleEQResetMsg","handleReverbMsg","handleReverbTypeMsg","handleReverbDecayMsg","handleReverbPreDelayMsg","handleReverbLowCutMsg","handleReverbHighCutMsg","handleStereoWidthMsg","handleVBassMsg","handleRequestEQReset","_data","handleRequestReverbReset","initEffectsHandlers","castHandler","setChannelMode","mode","gL","gR","merge","lowPass","ramp","toggleSurroundMode","enabled","setSurroundChannel","currentState","sGain","preampNode","names","setChannel","handleMainSyncBtn","syncReset","ts","requestGlobalResyncDelayed","delay","resyncTimer","timer","handleHeartbeat","handleHeartbeatAck","handlePingLatency","handlePongLatency","ms","latencyHistory","handleSyncResponse","elapsed","retryCount","oneWayLatencySeconds","handleGlobalResyncRequest","handleGetSyncTime","position","isPlaying","initSync","__vitePreload","playback","mod","overlay","localOffset","autoSyncOffset","total","el","nextExpectedChunk","lastChunkTime","_pendingEarlyChunks","startChunkWatchdog","timeSinceLast","receivedCount","lastSnapshot","handleFilePrepare","incomingSid","prevLocalSid","preloadMeta","nextFileBlob","hasPreloadedByIndex","hasPreloadedByName","preloadInProgressByIndex","preloadInProgressByName","meta","pendingFileIndex","transferState","rc","jitter","handleFileStart","localSid","isRecoverySameFile","opfsFilename","earlyChunks","pending","handleFileChunk","handleFileResume","sessionBuffer","chunkData","recoveredMeta","fname","chunk","downstreamPeers","relayCopy","chunkMsg","percent","processingIndex","handleFileEnd","handleFileWait","upstreamDataConn","pendingFileName","currentTrackIndex","recoveryIndex","playlist","broadcastFile","file","explicitSessionId","sessionId","currentTransferSessionId","CHUNK","header","eligiblePeers","start","end","chunkBuf","r","endMsg","unicastFile","startChunkIndex","effectiveSessionId","fileName","startWait","initTransfer","_relayConnTimer","opfsCatchupPumps","stopOpfsCatchupStream","reason","pump","startOpfsCatchupStream","scheduleOpfsCatchupPump","runOpfsCatchupPump","stuckMs","bufAmt","onOpfsCatchupReadComplete","requestTag","connectToRelay","targetId","handleRelayConnection","handleAssignDataSource","initRelay","reqName","reqIndex","currentFileBlob","nextMeta","isMatchCurrent","isMatchPreload","bootName","nextChunk","index","requestId","sepIdx","tag","dConn","latestPreloadSessionId","MAX_EARLY_PRELOAD_CHUNKS","schedulePreload","preloadNextTrack","repeatMode","isShuffle","currentSession","nextIdx","item","backgroundTransfer","targets","targetsWhoNeedChunks","preloadedIndexes","needsChunks","congested","unicastPreload","handlePreloadStart","drainPreloadReorderBuffer","pct","session","nextChunkPtr","chunkClone","relayMsg","totalExpected","fileSize","handlePreloadChunk","handlePreloadEnd","ackSent","handlePreloadAck","handlePlayPreloaded","initPreload","nextTrackIndex","waitingForPreload","sendRecoveryRequest","forceChunk","targetConn","currentTransferSid","currentSid","chunkToAsk","backoffMs","sourceLabel","latestName","handleRequestCurrentFile","findMatchingBlob","ensureValidSessionId","getBlobFallbackName","fileToSend","handleRequestDataRecovery","startChunk","n","matchByIndex","matchByName","matchNextByIndex","matchNextByName","initRecovery","_videoElement","BlobURLManager","url","nextUrl","prevUrl","options","force","oldest","t","urls","flushed","getVideoElement","isIdleOrPaused","state","VIDEO_EXTENSIONS","isMediaVideo","metadata","ext","setEngineMode","targetState","newState","finalState","updateBodyModeClass","appState","body","videoElement","keepVideoVisibleOnIdle","isVideoMode","ytContainer","videoWrapper","showMainVideo","initVideo","getCurrentAudioBuffer","_playerNode","_currentAudioBuffer","_currentLoadToken","_activeLoadSessionId","_isPlayLocked","_pendingPlayTime","_playPreloadedInProgress","setCurrentAudioBuffer","buf","incrementLoadToken","getLoadToken","setPendingPlayTime","time","getPendingPlayTime","fmtTime","m","sec","getTrackPosition","pausedAt","ytPos","pos","duration","startedAt","updatePlayState","playing","stopPlayerNode","stopAllMedia","play","offset","lockWatchdog","_internalPlay","safeOffset","endedToken","handleEnded","isVideo","pause","forcedTime","pausePos","hasBufferDuration","usesVideoElement","curr","togglePlay","isOperator","isActuallyPlaying","stopPlayback","skipTime","target","adjustSync","checkVideoSync","targetTime","actualTime","drift","loadAndBroadcastFile","_skipTabSync","loadToken","myLoadId","myToken","arrayBuffer","audioBuffer","onMetaLoaded","dur","loadPreloadedTrack","expectedIndex","targetIndex","localBlob","localMeta","activeMeta","handlePlayMsg","incomingIndex","expectedName","loadedName","handlePauseMsg","handleRequestPlay","handleRequestPause","handleRequestSeek","handleRequestSkipTime","handleForceSyncPlay","handleStatusSync","playlistMeta","hostTrackIndex","it","hasBlob","isPreloaded","isWrongBlob","alreadyGotIt","clearPreviousTrackState","trackName","win","finalizeGuestFile","initPlayback","callback","hostTime","oneWayLatency","compensatedTime","usePingCompensation","lastLatencyMs","_args","_sessionId","_name","currentSessionId","preloadSid","nowPos","itemName","toggleRepeat","nextMode","setRepeatMode","notify","btn","toggleShuffle","nextShuffle","setShuffle","playTrack","myLoadToken","currentIdx","playNextTrack","handled","success","nextIndex","playPrevTrack","handleRepeatMode","handleShuffleMode","handlePlaylistUpdate","incoming","handleTrackChange","handleRequestNextTrack","handleRequestPrevTrack","handleRequestSetting","st","loadDemoMedia","xhr","newTrack","metaList","handleFilesSelected","files","addedCount","initPlaylist","updateMediaSessionMetadata","title","artist","artwork","currentYouTubeSubIndex","subData","thumb","initMediaSession","isBlocked","details","VIDEO_PATTERNS","extractYouTubeVideoId","pattern","match","extractYouTubePlaylistId","_oEmbedTitleCache","_oEmbedInFlight","fetchOEmbedTitle","oEmbedUrl","response","_previewDebounce","fetchYouTubePreview","previewContainer","statusText","playBtn","setPlayBtnEnabled","videoId","playlistId","oembedUrl","chan","_isFetching","_uiTimer","fetchPlaylistSubTitles","ids","currentData","json","freshMap","_youtubePlayer","_currentYouTubeSessionId","_ytScriptLoading","_ytLoadTimeout","_ytIOSWatchdog","getYouTubePlayer","loadYouTubeVideo","autoplay","subIndex","_cachedYtDuration","container","w","initYouTubePlayer","fsBtn","refreshYouTubeDisplay","playerVars","playerOptions","onYouTubePlayerReady","onYouTubePlayerStateChange","updateYouTubeUI","showYouTubeSyncOverlay","_cachedYtPlaylistIdx","currentTime","rawDuration","playlistIdx","show","overlayId","iframe","stopYouTubeMode","chatDrawer","chatYtContainer","handleYouTubePlay","handleRequestYouTubePlay","handleRequestYouTubePause","handleRequestYouTubeSubSeek","subIdx","handleRequestYouTubePlaylistInfo","pid","subMap","initYouTube","cb","sync","input","previewEl","statusEl","titleText","newIndex","isCurrent","currentItem","currentSubMap","ytTime","ytState","currentSubIndex","broadcastYouTubeSync","player","sIdx","vData","handleYouTubeSync","hostState","hostSubIndex","handleYouTubeState","handleSubTitleUpdate","handleYouTubePlaylistInfo","titles","handleYouTubeStop","initYouTubeSync","_batchedTransitionCb","animateTransition","oldCb","executed","_ESCAPE_HTML_RE","_ESCAPE_HTML_RE_G","_ESCAPE_HTML_MAP","escapeHtml","str","ch","escapeAttr","updateTitleWithMarquee","text","parent","overflowWidth","targetOffset","totalDuration","copyTextToClipboard","ta","ok","_OVERLAY_IDS","updateOverlayOpenClass","anyActive","initOverlayOpenObserver","obs","_activeLanguageMode","_resolvedLanguage","_resolveSystemLanguage","I18N_EN","I18N_EN_REGEX","_m","cnt","src","rest","_i18nObserver","_i18nApplying","_i18nOriginalText","_i18nOriginalAttr","_i18nKeyOrder","_i18nNorm","i18nTranslate","raw","lead","trail","core","translated","re","out","k","_i18nShouldSkipTextNode","_i18nTranslateTextNode","_i18nTranslateElementAttrs","attrs","store","_i18nTranslateSubtree","walker","_i18nRestoreAll","langs","_applyResolvedLanguage","resolved","mutations","tn","_updateLanguageSelector","pillIndex","sel","setLanguageMode","initI18n","updateLoader","progressBg","showLoader","txt","loadingText","_toastTimer","showToast","msgEl","initToast","_dialogActive","_dialogQueue","drainDialogQueue","next","_openDialog","closeDialog","action","active","titleEl","okBtn","secondaryBtn","closeBtn","o","message","buttonText","secondaryTextRaw","secondaryText","hasSecondary","dismissible","defaultFocus","prevFocus","cleanup","on","done","ke","focusables","first","last","activeEl","showDialog","initDialog","switchTab","tabId","tabEl","initTabs","tabBody","_animationId","_visualizerRetryCount","MAX_VISUALIZER_RETRIES","_vizResizeTimer","getAnalyser","startVisualizer","canvas","_ctx","ctx","isToneAnalyser","bufferLength","smoothedBass","logicalSize","dpr","draw","dbData","isLight","bassSum","bassCount","bassAverage","bassPunch","highSum","highStart","highEnd","highCountVal","highPunch","centerX","centerY","scale","bassRadius","bassLightness","highRadius","highLightness","drawIdleVisualizer","_ctx2","initVisualizer","STANDARD_ROLE_MAP","getRoleLabelByChannelMode","_unreadCount","_isChatDrawerOpen","_getChatLabelBase","role0","roleL","roleR","roleS","_formatChatDisplayName","parseTimestamp","parts","parseMessageContent","ytRegex","tsRegex","combinedRegex","lastIndex","matchedText","cleanUrl","uniqueId","updateYouTubeChatTitle","seconds","elementId","updateChatPreview","sender","previewBtn","previewText","incrementUnread","badge","resetUnread","toggleChatDrawer","drawer","messages","sendChatMessage","senderLabel","senderRole","displayName","addChatMessage","chatMsg","isMine","empty","now","timeStr","group","senderNode","row","bubble","chatTextDiv","timeNode","handleChatMessage","senderId","senderPeerId","initChatEventDelegation","insertEmoji","emoji","initChat","sendBtn","chatInput","toggleExpansion","updatePlaylistUI","ul","subItemsMap","li","expandBtn","icon","exp","subUl","sli","isActiveSub","sTitle","displayTitle","artistEl","initPlaylistView","getStandardRolePreset","showPlacementToastForChannel","_preMuteVolume","updateVolumeIcon","onVolInput","onVolChange","toggleMute","newVol","updateRoleBadge","latencyTxt","getInviteCode","sessionCode","lastJoinCode","updateInviteCodeUI","getConnectedDeviceCount","lastKnownDeviceList","d","sessionStarted","peerConnected","copyInviteCode","openMediaSourcePopup","closeMediaSourcePopup","openYouTubePopup","closeYouTubePopup","openFileSelector","_logoNavBusy","handleLogoReturnToMain","setupOverlay","installAndroidRangeScrollFix","range","scrollParent","prevOverflowY","lock","unlock","initSeekBar","tc","syncVolumeSlider","vSlider","initPlayerControls","$on","doc","roleBadge","onShowCode","logo","fileInput","error","tTotal","_loopInterval","_endedCheckCounter","isSeeking","currFormatted","totalFormatted","tt","setTheme","themeMeta","schemeMeta","selectStandardChannelButton","updateAudioEffect","defaults","eq","resetStereo","resetVBass","renderDeviceList","shortId","op","statusClass","status","right","opBtn","initSettings","stdGrid","surrGrid","resetVal","savedTheme","TOTAL_OB_SLIDES","_currentObSlide","_setupOverlayEverShown","_pendingSetupRole","_pendingGuestRoleMode","_desktopSyncedDiagram","_desktopSyncedDiagramParent","_desktopSyncedDiagramNextSibling","isDesktopLayout","_restoreDesktopDiagram","hc","dc","syncDesktopLeftPanel","headerContainer","diagramContainer","areas","area","areaEl","headerSrc","diagramEl","setupEl","showSetupOverlay","ov","hideSetupOverlay","stopObAutoSlide","setupShowCodeArea","box","setupSetCode","setupShowInstruction","setupShowJoinArea","setupShowRoleArea","setupShowWelcome","setupSetGuestJoinBusy","busy","grid","setupHighlightJoinRole","spk","setupRenderActions","buttons","layout","BACK_SVG","startObAutoSlide","nextObSlide","updateObSlider","track","dots","dot","isAuto","prevObSlide","showRoleSelectionButtons","startHostFlow","startGuestFlow","handleSetupRolePreview","nextBtn","sliderArea","initSetupOverlay","proceedToHostCode","codeEl","startSessionFromHost","proceedToGuestCode","handleSetupJoinWithRole","showAndStart","btnNext","btnPrev","dotEl","viewport","startX","endX","diff","initSetup","roleGrid","handleSpeakerClick","roleArea","desktopDiagramArea","joinInput","digits","myIdEl","peerType","userMsg","res","lastCode","_swWantsReload","_swReloading","registerServiceWorker","doRegister","swUrl","reg","newWorker","checkSystemCompatibility","errors","initKeyboardShortcuts","activeTag","interactive","_wakeLock","requestWakeLock","initWakeLock","line","col","initBeforeUnload","bootstrap","syncW","transferW","debugObj"],"ignoreList":[],"sources":["../../src/core/log.ts","../../src/core/events.ts","../../src/core/platform.ts","../../src/core/session.ts","../../src/core/constants.ts","../../src/core/state.ts","../../src/audio/engine.ts","../../src/network/protocol.ts","../../src/core/timers.ts","../../src/storage/opfs.ts","../../src/network/peer.ts","../../src/audio/effects.ts","../../src/audio/channel.ts","../../src/network/sync.ts","../../src/storage/transfer.ts","../../src/network/relay.ts","../../src/storage/preload.ts","../../src/storage/recovery.ts","../../src/core/blob-manager.ts","../../src/player/video.ts","../../src/player/playback.ts","../../src/player/playlist.ts","../../src/player/media-session.ts","../../src/youtube/search.ts","../../src/youtube/player.ts","../../src/youtube/sync.ts","../../src/ui/dom.ts","../../src/ui/i18n.ts","../../src/ui/toast.ts","../../src/ui/dialog.ts","../../src/ui/tabs.ts","../../src/ui/visualizer.ts","../../src/ui/chat.ts","../../src/ui/playlist-view.ts","../../src/ui/player-controls.ts","../../src/ui/settings.ts","../../src/ui/setup.ts","../../src/sw-register.ts","../../src/app.ts"],"sourcesContent":["/**\r\n * MUSIXQUARE 2.0  Logging System\r\n * Extracted from original app.js lines 37-49\r\n */\r\n\r\nexport const LOG_LEVEL = {\r\n  DEBUG: 0,\r\n  INFO: 1,\r\n  WARN: 2,\r\n  ERROR: 3,\r\n  SILENT: 4,\r\n} as const;\r\n\r\nexport type LogLevelValue = (typeof LOG_LEVEL)[keyof typeof LOG_LEVEL];\r\n\r\nlet _logLevel: LogLevelValue = LOG_LEVEL.INFO;\r\n\r\n// Auto-enable DEBUG on localhost\r\ntry {\r\n  const host = globalThis.location?.hostname;\r\n  if (host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0') {\r\n    _logLevel = LOG_LEVEL.DEBUG;\r\n  }\r\n} catch {\r\n  // ignore (worker context, etc.)\r\n}\r\n\r\nexport function setLogLevel(level: LogLevelValue): void {\r\n  _logLevel = level;\r\n  console.info(`[Log] Level set to ${Object.keys(LOG_LEVEL).find(k => LOG_LEVEL[k as keyof typeof LOG_LEVEL] === level) ?? level}`);\r\n}\r\n\r\nexport function getLogLevel(): LogLevelValue {\r\n  return _logLevel;\r\n}\r\n\r\nexport const log = {\r\n  debug: (...args: unknown[]): void => {\r\n    if (_logLevel <= LOG_LEVEL.DEBUG) console.debug(...args);\r\n  },\r\n  info: (...args: unknown[]): void => {\r\n    if (_logLevel <= LOG_LEVEL.INFO) console.info(...args);\r\n  },\r\n  warn: (...args: unknown[]): void => {\r\n    if (_logLevel <= LOG_LEVEL.WARN) console.warn(...args);\r\n  },\r\n  error: (...args: unknown[]): void => {\r\n    if (_logLevel <= LOG_LEVEL.ERROR) console.error(...args);\r\n  },\r\n};\r\n","/**\r\n * MUSIXQUARE 2.0  EventBus (Singleton)\r\n * Type-safe inter-module communication.\r\n * Same-domain modules use direct imports; cross-domain uses this bus.\r\n */\r\n\r\nimport type { EventMap } from '../types/index.ts';\r\n\r\ntype EventKey = keyof EventMap | (string & {});\r\ntype Listener = (...args: unknown[]) => void;\r\n\r\nclass EventBusImpl {\r\n  private _listeners = new Map<string, Set<Listener>>();\r\n\r\n  /**\r\n   * Subscribe to an event. Returns an unsubscribe function.\r\n   */\r\n  on<K extends EventKey>(event: K, fn: Listener): () => void {\r\n    let set = this._listeners.get(event as string);\r\n    if (!set) {\r\n      set = new Set();\r\n      this._listeners.set(event as string, set);\r\n    }\r\n    set.add(fn);\r\n    return () => this.off(event, fn);\r\n  }\r\n\r\n  /**\r\n   * Subscribe once  auto-removes after first invocation.\r\n   */\r\n  once<K extends EventKey>(event: K, fn: Listener): () => void {\r\n    const wrapper: Listener = (...args) => {\r\n      this.off(event, wrapper);\r\n      fn(...args);\r\n    };\r\n    return this.on(event, wrapper);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe a specific listener.\r\n   */\r\n  off<K extends EventKey>(event: K, fn: Listener): void {\r\n    const set = this._listeners.get(event as string);\r\n    if (set) {\r\n      set.delete(fn);\r\n      if (set.size === 0) this._listeners.delete(event as string);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit an event with payload.\r\n   */\r\n  emit<K extends EventKey>(event: K, ...args: unknown[]): void {\r\n    const set = this._listeners.get(event as string);\r\n    if (!set) return;\r\n    for (const fn of set) {\r\n      try {\r\n        fn(...args);\r\n      } catch (e) {\r\n        console.error(`[EventBus] Error in handler for \"${event as string}\":`, e);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all listeners for a specific event, or all events if none specified.\r\n   */\r\n  clear(event?: EventKey): void {\r\n    if (event) {\r\n      this._listeners.delete(event as string);\r\n    } else {\r\n      this._listeners.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Debug: list registered events and listener counts.\r\n   */\r\n  debug(): Record<string, number> {\r\n    const result: Record<string, number> = {};\r\n    for (const [key, set] of this._listeners) {\r\n      result[key] = set.size;\r\n    }\r\n    return result;\r\n  }\r\n}\r\n\r\n/** Singleton EventBus instance */\r\nexport const bus = new EventBusImpl();\r\n","/**\r\n * MUSIXQUARE 2.0  Platform Detection & Viewport Management\r\n * Extracted from original app.js lines 54-264\r\n */\r\n\r\nimport { log } from './log.ts';\r\n\r\n//  Platform Detection \r\n\r\nexport const IS_IOS: boolean =\r\n  (/iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as unknown as Record<string, unknown>).MSStream) ||\r\n  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);\r\n\r\nexport const IS_ANDROID: boolean = /Android/i.test(navigator.userAgent);\r\n\r\nexport function isStandaloneDisplayMode(): boolean {\r\n  try {\r\n    if ((navigator as unknown as Record<string, unknown>).standalone) return true;\r\n    if (window.matchMedia?.('(display-mode: standalone)').matches) return true;\r\n  } catch {\r\n    /* ignore */\r\n  }\r\n  return false;\r\n}\r\n\r\n//  iOS Pinch-Zoom Prevention \r\n\r\nexport function preventIOSPinchZoom(): void {\r\n  if (!IS_IOS) return;\r\n  for (const evt of ['gesturestart', 'gesturechange', 'gestureend'] as const) {\r\n    document.addEventListener(evt, (e) => e.preventDefault(), { passive: false });\r\n  }\r\n}\r\n\r\n//  Viewport Height Management \r\n\r\nlet _appHeightRaf = 0;\r\nlet _lastSoftKeyHeight = 0;\r\nlet _platformClassesApplied = false;\r\n\r\nfunction updateAppHeightNow(): void {\r\n  const root = document.documentElement;\r\n\r\n  // Platform CSS hooks (one-time)\r\n  if (!_platformClassesApplied) {\r\n    try {\r\n      if (IS_IOS) root.classList.add('ios');\r\n      if (IS_ANDROID) root.classList.add('android');\r\n      if (IS_IOS && isStandaloneDisplayMode()) root.classList.add('ios-standalone');\r\n      if (isStandaloneDisplayMode()) root.classList.add('standalone');\r\n    } catch {\r\n      /* ignore */\r\n    }\r\n    _platformClassesApplied = true;\r\n  }\r\n\r\n  const vv = window.visualViewport;\r\n  const isStandalone = isStandaloneDisplayMode();\r\n\r\n  let isLandscape = false;\r\n  try {\r\n    isLandscape = !!window.matchMedia?.('(orientation: landscape)').matches;\r\n  } catch {\r\n    isLandscape = window.innerWidth > window.innerHeight;\r\n  }\r\n\r\n  // Collect all available height signals\r\n  const validHeights: number[] = [];\r\n  if (vv && Number.isFinite(vv.height) && vv.height > 0) validHeights.push(Math.round(vv.height));\r\n  if (Number.isFinite(window.innerHeight) && window.innerHeight > 0) validHeights.push(Math.round(window.innerHeight));\r\n  if (root && Number.isFinite(root.clientHeight) && root.clientHeight > 0) validHeights.push(Math.round(root.clientHeight));\r\n\r\n  let h = validHeights.length > 0 ? Math.min(...validHeights) : 0;\r\n\r\n  // Android: Detect if viewport extends behind system bar\r\n  let softKeyHeight = 0;\r\n  const scr = window.screen || ({} as Screen);\r\n\r\n  if (IS_ANDROID && isLandscape) {\r\n    // Strategy 1: outerHeight vs innerHeight\r\n    if (Number.isFinite(window.outerHeight) && window.outerHeight > 0 &&\r\n        Number.isFinite(window.innerHeight) && window.innerHeight > 0) {\r\n      const delta = Math.round(window.outerHeight - window.innerHeight);\r\n      if (delta < 0) softKeyHeight = Math.abs(delta);\r\n    }\r\n\r\n    // Strategy 2: screen.availHeight\r\n    if (softKeyHeight === 0 && scr.availHeight != null && scr.availWidth != null) {\r\n      const dH = Math.round((scr.height || 0) - (scr.availHeight || 0));\r\n      if (dH > 0 && dH < 150) softKeyHeight = dH;\r\n    }\r\n\r\n    // Strategy 3: Hardcoded 48dp fallback\r\n    if (softKeyHeight === 0) {\r\n      const scrDimH = Math.min(scr.height || Infinity, scr.width || Infinity);\r\n      if (Number.isFinite(scrDimH) && scrDimH > 100) {\r\n        if (Math.abs(h - scrDimH) < 4) softKeyHeight = 48;\r\n      }\r\n    }\r\n\r\n    // Clamp\r\n    if (softKeyHeight > 120) softKeyHeight = 48;\r\n    if (softKeyHeight < 0) softKeyHeight = 0;\r\n\r\n    // Stability\r\n    if (softKeyHeight > 0) {\r\n      _lastSoftKeyHeight = softKeyHeight;\r\n    } else if (_lastSoftKeyHeight > 0 && isLandscape) {\r\n      softKeyHeight = _lastSoftKeyHeight;\r\n    }\r\n\r\n    if (softKeyHeight > 0 && h > softKeyHeight) {\r\n      h -= softKeyHeight;\r\n      log.info(`[Viewport] Android landscape softkey compensation: ${softKeyHeight}px`);\r\n    }\r\n  } else if (!isLandscape) {\r\n    _lastSoftKeyHeight = 0;\r\n  }\r\n\r\n  // iOS standalone fix\r\n  if (IS_IOS && isStandalone && !isLandscape && window.screen &&\r\n      Number.isFinite(window.screen.height) && window.screen.height > 0) {\r\n    h = Math.max(h, Math.round(window.screen.height));\r\n  }\r\n\r\n  // Apply CSS variables\r\n  if (h > 0) {\r\n    try { root.style.setProperty('--app-height', `${h}px`); } catch { /* ignore */ }\r\n  }\r\n\r\n  const navBottom = (IS_ANDROID && isLandscape && softKeyHeight > 0) ? softKeyHeight : 0;\r\n  try { root.style.setProperty('--safe-nav-bottom', `${navBottom}px`); } catch { /* ignore */ }\r\n}\r\n\r\nfunction scheduleAppHeightUpdate(): void {\r\n  if (_appHeightRaf) return;\r\n  try {\r\n    _appHeightRaf = requestAnimationFrame(() => {\r\n      _appHeightRaf = 0;\r\n      try { updateAppHeightNow(); } catch { /* ignore */ }\r\n    });\r\n  } catch {\r\n    _appHeightRaf = 0;\r\n    try { updateAppHeightNow(); } catch { /* ignore */ }\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize platform detection and viewport height tracking.\r\n * Call once at app bootstrap.\r\n */\r\nexport function initPlatform(): void {\r\n  preventIOSPinchZoom();\r\n\r\n  const run = () => {\r\n    scheduleAppHeightUpdate();\r\n    if (IS_ANDROID) {\r\n      setTimeout(scheduleAppHeightUpdate, 500);\r\n      setTimeout(scheduleAppHeightUpdate, 1500);\r\n    }\r\n  };\r\n\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', run, { once: true });\r\n  } else {\r\n    run();\r\n  }\r\n\r\n  try {\r\n    window.addEventListener('resize', scheduleAppHeightUpdate, { passive: true });\r\n    window.addEventListener('orientationchange', () => {\r\n      scheduleAppHeightUpdate();\r\n      if (IS_ANDROID) setTimeout(scheduleAppHeightUpdate, 500);\r\n    }, { passive: true });\r\n    window.addEventListener('pageshow', scheduleAppHeightUpdate, { passive: true });\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (document.visibilityState === 'visible') scheduleAppHeightUpdate();\r\n    });\r\n    if (window.visualViewport) {\r\n      window.visualViewport.addEventListener('resize', scheduleAppHeightUpdate, { passive: true });\r\n      window.visualViewport.addEventListener('scroll', scheduleAppHeightUpdate, { passive: true });\r\n    }\r\n  } catch {\r\n    /* ignore */\r\n  }\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Session ID Management\r\n * Extracted from original app.js lines 51-54, 272-294, 1369-1372\r\n */\r\n\r\nimport { log } from './log.ts';\r\n\r\n//  Instance ID (unique per app load) \r\n\r\nexport const INSTANCE_ID: string =\r\n  typeof crypto.randomUUID === 'function'\r\n    ? crypto.randomUUID()\r\n    : Date.now().toString(36) + Math.random().toString(36).slice(2, 11);\r\n\r\n//  Session ID Generator \r\n\r\nlet _globalSessionCounter = Math.floor(Date.now() / 1000) + Math.floor(Math.random() * 100000);\r\n\r\nexport function nextSessionId(): number {\r\n  return ++_globalSessionCounter;\r\n}\r\n\r\n//  Session ID Validation \r\n\r\nconst _warnedBadSessionIds = new Set<string>();\r\n\r\n/**\r\n * Validate and normalize a session ID to a safe integer.\r\n * Returns 0 for invalid IDs (0 is the \"no-session\" sentinel).\r\n *\r\n * @param id   - The raw session ID (may be string, number, undefined)\r\n * @param strict - If true, throws on invalid ID instead of returning 0\r\n */\r\nexport function validateSessionId(id: unknown, strict = false): number {\r\n  const n = Number(id);\r\n  const sid = Number.isFinite(n) ? Math.trunc(n) : 0;\r\n\r\n  const ok = Number.isSafeInteger(sid) && sid > 0;\r\n  if (!ok) {\r\n    const key = String(id);\r\n    // Prevent unbounded growth\r\n    if (_warnedBadSessionIds.size > 200) _warnedBadSessionIds.clear();\r\n    if (!_warnedBadSessionIds.has(key)) {\r\n      _warnedBadSessionIds.add(key);\r\n      log.warn(`[Session] Invalid sessionId (${typeof id}):`, id);\r\n    }\r\n    if (strict) {\r\n      throw new Error(`Invalid sessionId: ${id}`);\r\n    }\r\n    return 0;\r\n  }\r\n  return sid;\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Constants\r\n * Extracted from original app.js lines 1172-1299\r\n */\r\n\r\n//  App State \r\nexport const APP_STATE = {\r\n  IDLE: 'IDLE',\r\n  PAUSED: 'PAUSED',\r\n  PLAYING_AUDIO: 'PLAYING_AUDIO',\r\n  PLAYING_VIDEO: 'PLAYING_VIDEO',\r\n  PLAYING_YOUTUBE: 'PLAYING_YOUTUBE',\r\n} as const;\r\n\r\nexport type AppStateValue = (typeof APP_STATE)[keyof typeof APP_STATE];\r\n\r\n//  Transfer State \r\nexport const TRANSFER_STATE = {\r\n  IDLE: 'IDLE',\r\n  RECEIVING: 'RECEIVING',\r\n  PROCESSING: 'PROCESSING',\r\n  READY: 'READY',\r\n} as const;\r\n\r\nexport type TransferStateValue = (typeof TRANSFER_STATE)[keyof typeof TRANSFER_STATE];\r\n\r\n//  File Transfer \r\nexport const CHUNK_SIZE = 16384; // 16KB per chunk\r\nexport const ENDED_CHECK_THROTTLE = 500; // ms\r\nexport const WATCHDOG_TIMEOUT = 12000; // 12s chunk watchdog\r\n\r\nexport const MAX_RECOVERY_RETRIES = 3;\r\nexport const RECOVERY_BACKOFF = [2000, 5000, 10000] as const;\r\n\r\n//  Timing Constants (ms) \r\nexport const DELAY = {\r\n  TICK: 10,               // Micro-yield for main thread breathing\r\n  BACKPRESSURE: 50,       // Backpressure polling interval\r\n  UI_REFRESH: 100,        // UI state refresh / short debounce\r\n  RETRY: 200,             // Retry / reconnection pause\r\n  TRANSITION: 300,        // UI transition / animation settling\r\n  DEBOUNCE: 500,          // Standard debounce / throttle\r\n  CONNECTION_CHECK: 500,  // Peer connection readiness check\r\n  BLOB_REVOCATION: 10000, // BlobURL revocation safety delay\r\n  JOIN_TIMEOUT: 10000,    // Max wait for peer.open\r\n  RECOVERY_COOLDOWN: 5000,// Rate-limit recovery requests\r\n} as const;\r\n\r\n//  Network \r\nexport const MAX_GUEST_SLOTS = 3;\r\nexport const MAX_DIRECT_DATA_PEERS = 2;\r\nexport const PEER_NAME_PREFIX = 'Peer';\r\n\r\n//  Message Types (P2P Protocol) \r\nexport const MSG = {\r\n  ASSIGN_DATA_SOURCE: 'assign-data-source',\r\n  CHAT: 'chat',\r\n  DATA_RELAY: 'data-relay',\r\n  DEVICE_LIST_UPDATE: 'device-list-update',\r\n  EQ_RESET: 'eq-reset',\r\n  EQ_UPDATE: 'eq-update',\r\n  FILE_CHUNK: 'file-chunk',\r\n  FILE_END: 'file-end',\r\n  FILE_PREPARE: 'file-prepare',\r\n  FILE_RESUME: 'file-resume',\r\n  FILE_START: 'file-start',\r\n  FILE_WAIT: 'file-wait',\r\n  FORCE_CLOSE_DUPLICATE: 'force-close-duplicate',\r\n  GET_SYNC_TIME: 'get-sync-time',\r\n  GLOBAL_RESYNC_REQUEST: 'global-resync-request',\r\n  HEARTBEAT: 'heartbeat',\r\n  HEARTBEAT_ACK: 'heartbeat-ack',\r\n  PAUSE: 'pause',\r\n  PING_LATENCY: 'ping-latency',\r\n  PLAY: 'play',\r\n  PLAYLIST: 'playlist',\r\n  PLAYLIST_UPDATE: 'playlist-update',\r\n  PLAY_PRELOADED: 'play-preloaded',\r\n  PONG_LATENCY: 'pong-latency',\r\n  PREAMP: 'preamp',\r\n  PRELOAD_ACK: 'preload-ack',\r\n  PRELOAD_CHUNK: 'preload-chunk',\r\n  PRELOAD_END: 'preload-end',\r\n  PRELOAD_START: 'preload-start',\r\n  REPEAT_MODE: 'repeat-mode',\r\n  REQUEST_CURRENT_FILE: 'request-current-file',\r\n  REQUEST_DATA_RECOVERY: 'request-data-recovery',\r\n  REQUEST_EQ_RESET: 'request-eq-reset',\r\n  REQUEST_REVERB_RESET: 'request-reverb-reset',\r\n  REQUEST_NEXT_TRACK: 'request-next-track',\r\n  REQUEST_PAUSE: 'request-pause',\r\n  REQUEST_PLAY: 'request-play',\r\n  REQUEST_PREV_TRACK: 'request-prev-track',\r\n  REQUEST_SEEK: 'request-seek',\r\n  REQUEST_SETTING: 'request-setting',\r\n  REQUEST_SKIP_TIME: 'request-skip-time',\r\n  REQUEST_TRACK_CHANGE: 'request-track-change',\r\n  REQUEST_YOUTUBE_PAUSE: 'request-youtube-pause',\r\n  REQUEST_YOUTUBE_PLAY: 'request-youtube-play',\r\n  REQUEST_YOUTUBE_PLAYLIST_INFO: 'request-youtube-playlist-info',\r\n  REQUEST_YOUTUBE_SUB_SEEK: 'request-youtube-sub-seek',\r\n  REVERB: 'reverb',\r\n  REVERB_DECAY: 'reverb-decay',\r\n  REVERB_HIGHCUT: 'reverb-highcut',\r\n  REVERB_LOWCUT: 'reverb-lowcut',\r\n  REVERB_PREDELAY: 'reverb-predelay',\r\n  REVERB_TYPE: 'reverb-type',\r\n  SHUFFLE_MODE: 'shuffle-mode',\r\n  STATUS_SYNC: 'status-sync',\r\n  STEREO_WIDTH: 'stereo-width',\r\n  SYNC_RESPONSE: 'sync-response',\r\n  FORCE_SYNC_PLAY: 'force-sync-play',\r\n  OPERATOR_GRANT: 'operator-grant',\r\n  OPERATOR_REVOKE: 'operator-revoke',\r\n  VBASS: 'vbass',\r\n  VOLUME: 'volume',\r\n  WELCOME: 'welcome',\r\n  SESSION_START: 'session-start',\r\n  SESSION_FULL: 'session-full',\r\n  YOUTUBE_PLAY: 'youtube-play',\r\n  YOUTUBE_PLAYLIST_INFO: 'youtube-playlist-info',\r\n  YOUTUBE_STATE: 'youtube-state',\r\n  YOUTUBE_SUB_TITLE_UPDATE: 'youtube-sub-title-update',\r\n  YOUTUBE_STOP: 'youtube-stop',\r\n  YOUTUBE_SYNC: 'youtube-sync',\r\n  SYS_TOAST: 'sys-toast',\r\n} as const;\r\n\r\nexport type MsgType = (typeof MSG)[keyof typeof MSG];\r\n\r\n//  Audio \r\nexport const EQ_FREQUENCIES = [60, 230, 910, 3600, 14000] as const;\r\nexport const DEFAULT_SUB_FREQ = 120;\r\nexport const DEFAULT_REVERB_DECAY = 5.0;\r\nexport const DEFAULT_REVERB_PREDELAY = 0.1;\r\n\r\n//  Relay \r\nexport const MAX_PEER_RELAY_QUEUE = 500;\r\nexport const MAX_EARLY_PRELOAD_CHUNKS = 128;\r\n\r\n//  Misc \r\nexport const DEMO_FILE_NAME = 'demo_track.mp3';\r\nexport const DEMO_TITLE = 'Sean Pitaro - Passport (NCS Release)';\r\n\r\n/** Video file extensions */\r\nexport const VIDEO_EXTENSIONS = ['mp4', 'mkv', 'webm', 'mov'] as const;\r\n","/**\r\n * MUSIXQUARE 2.0  Central State Store\r\n * Extracted from original app.js global variables.\r\n *\r\n * Single Source of Truth for app-wide reactive state.\r\n * Uses dot-separated paths and emits bus events on change.\r\n */\r\n\r\nimport { bus } from './events.ts';\r\nimport { APP_STATE, TRANSFER_STATE } from './constants.ts';\r\nimport type { AppStateValue, TransferStateValue } from './constants.ts';\r\nimport type { FileMeta, PlaylistItem, PreloadSessionEntry, DeviceInfo, DataConnection } from '../types/index.ts';\r\n\r\n//  State Tree \r\n\r\nexport interface StateTree {\r\n  // App\r\n  appState: AppStateValue;\r\n  isStateTransitioning: boolean;\r\n\r\n  // Session\r\n  session: {\r\n    peerId: string | null;\r\n    inviteCode: string | null;\r\n    hostId: string | null;\r\n    started: boolean;\r\n  };\r\n\r\n  // Setup\r\n  setup: {\r\n    sessionStarted: boolean;\r\n  };\r\n\r\n  // Player (playback state  code uses `player.*` paths throughout)\r\n  player: {\r\n    startedAt: number;\r\n    pausedAt: number;\r\n    isSeeking: boolean;\r\n    isPlayLocked: boolean;\r\n    activeLoadSessionId: number;\r\n    currentLoadToken: number;\r\n    isFirstTrackLoad: boolean;\r\n  };\r\n\r\n  // Transfer\r\n  transfer: {\r\n    state: TransferStateValue;\r\n    receivedCount: number;\r\n    meta: Partial<FileMeta>;\r\n    localSessionId: number;\r\n    currentSessionId: number;\r\n    activeBroadcastSession: number | null;\r\n    lastReceivedCountSnapshot: number;\r\n    skipIncomingFile: boolean;\r\n  };\r\n\r\n  // Preload\r\n  preload: {\r\n    isPreloading: boolean;\r\n    sessionId: number;\r\n    count: number;\r\n    meta: Partial<FileMeta> | null;\r\n    nextTrackIndex: number;\r\n    nextFileBlob: Blob | null;\r\n    skipIncoming: boolean;\r\n    waitingFor: boolean;\r\n    usedForIndex: number | null;\r\n    ackSent: Set<number>;\r\n    sessionState: Map<number, PreloadSessionEntry>;\r\n    watchdog: ReturnType<typeof setTimeout> | null;\r\n  };\r\n\r\n  // Audio\r\n  audio: {\r\n    masterVolume: number;\r\n    preMuteVolume: number;\r\n    channelMode: number;\r\n    isSurroundMode: boolean;\r\n    surroundChannelIndex: number;\r\n    reverbMix: number;\r\n    reverbDecay: number;\r\n    reverbPreDelay: number;\r\n    reverbLowCut: number;\r\n    reverbHighCut: number;\r\n    reverbType: string;\r\n    eqValues: number[];\r\n    stereoWidth: number;\r\n    virtualBass: number;\r\n    subFreq: number;\r\n    userPreampGain: number;\r\n  };\r\n\r\n  // Sync\r\n  sync: {\r\n    localOffset: number;\r\n    autoSyncOffset: number;\r\n    usePingCompensation: boolean;\r\n    lastLatencyMs: number;\r\n    latencyHistory: number[];\r\n    lastHeartbeatAckAt: number;\r\n    syncRequestTime: number;\r\n    resyncTimer: ReturnType<typeof setTimeout> | null;\r\n  };\r\n\r\n  // Network\r\n  network: {\r\n    myId: string | null;\r\n    myDeviceLabel: string;\r\n    appRole: 'host' | 'guest' | 'idle';\r\n    sessionCode: string;\r\n    lastJoinCode: string;\r\n    hostConn: DataConnection | null;\r\n    connectedPeers: Array<{\r\n      id: string;\r\n      slot: number;\r\n      label: string;\r\n      conn: DataConnection | null;\r\n      isOp: boolean;\r\n      preloadedIndexes: Set<number>;\r\n      status: string;\r\n    }>;\r\n    isOperator: boolean;\r\n    isConnecting: boolean;\r\n    isIntentionalDisconnect: boolean;\r\n    lastKnownDeviceList: DeviceInfo[] | null;\r\n    deviceCounter: number;\r\n    peerLabels: Record<string, string>;\r\n    peerSlots: (string | null)[];\r\n    peerSlotByPeerId: Map<string, number>;\r\n    activeHostConnByPeerId: Map<string, DataConnection>;\r\n  };\r\n\r\n  // Relay\r\n  relay: {\r\n    upstreamDataConn: DataConnection | null;\r\n    downstreamDataPeers: string[];\r\n    chunkQueue: unknown[];\r\n    isRelaying: boolean;\r\n  };\r\n\r\n  // Playlist\r\n  playlist: {\r\n    items: PlaylistItem[];\r\n    currentTrackIndex: number;\r\n    repeatMode: number;\r\n    isShuffle: boolean;\r\n    isFirstTrackLoad: boolean;\r\n  };\r\n\r\n  // Files\r\n  files: {\r\n    currentFileBlob: Blob | null;\r\n    currentAudioBuffer: AudioBuffer | null;\r\n    currentFileOpfs: { name: string | null };\r\n    preloadFileOpfs: { name: string | null };\r\n  };\r\n\r\n  // YouTube\r\n  youtube: {\r\n    currentSessionId: number;\r\n    currentSubIndex: number;\r\n    subItemsMap: Record<string, { ids: string[]; titles: string[] }>;\r\n    scriptLoading: boolean;\r\n    loadTimeout: ReturnType<typeof setTimeout> | null;\r\n    iosWatchdog: number | null;\r\n  };\r\n\r\n  // Recovery\r\n  recovery: {\r\n    pending: boolean;\r\n    inProgress: Record<string, boolean>;\r\n    lastRequest: Record<string, number>;\r\n    retryCount: number;\r\n    pendingFileName: string;\r\n    pendingFileIndex: number | undefined;\r\n    pendingPlayTime: number | undefined;\r\n  };\r\n\r\n  // UI\r\n  ui: {\r\n    animationId: number | null;\r\n    uiLoopId: number | null;\r\n    isChatDrawerOpen: boolean;\r\n    unreadChatCount: number;\r\n  };\r\n}\r\n\r\n//  Initial State \r\n\r\nfunction createInitialState(): StateTree {\r\n  return {\r\n    appState: APP_STATE.IDLE,\r\n    isStateTransitioning: false,\r\n\r\n    session: {\r\n      peerId: null,\r\n      inviteCode: null,\r\n      hostId: null,\r\n      started: false,\r\n    },\r\n\r\n    setup: {\r\n      sessionStarted: false,\r\n    },\r\n\r\n    player: {\r\n      startedAt: 0,\r\n      pausedAt: 0,\r\n      isSeeking: false,\r\n      isPlayLocked: false,\r\n      activeLoadSessionId: 0,\r\n      currentLoadToken: 0,\r\n      isFirstTrackLoad: true,\r\n    },\r\n\r\n    transfer: {\r\n      state: TRANSFER_STATE.IDLE,\r\n      receivedCount: 0,\r\n      meta: {},\r\n      localSessionId: 0,\r\n      currentSessionId: 0,\r\n      activeBroadcastSession: null,\r\n      lastReceivedCountSnapshot: 0,\r\n      skipIncomingFile: false,\r\n    },\r\n\r\n    preload: {\r\n      isPreloading: false,\r\n      sessionId: 0,\r\n      count: 0,\r\n      meta: null,\r\n      nextTrackIndex: -1,\r\n      nextFileBlob: null,\r\n      skipIncoming: false,\r\n      waitingFor: false,\r\n      usedForIndex: null,\r\n      ackSent: new Set(),\r\n      sessionState: new Map(),\r\n      watchdog: null,\r\n    },\r\n\r\n    audio: {\r\n      masterVolume: 1.0,\r\n      preMuteVolume: 1.0,\r\n      channelMode: 0,\r\n      isSurroundMode: false,\r\n      surroundChannelIndex: -1,\r\n      reverbMix: 0,\r\n      reverbDecay: 5.0,\r\n      reverbPreDelay: 0.1,\r\n      reverbLowCut: 0,\r\n      reverbHighCut: 0,\r\n      reverbType: 'hall',\r\n      eqValues: [0, 0, 0, 0, 0],\r\n      stereoWidth: 1.0,\r\n      virtualBass: 0,\r\n      subFreq: 120,\r\n      userPreampGain: 1.0,\r\n    },\r\n\r\n    sync: {\r\n      localOffset: 0,\r\n      autoSyncOffset: 0,\r\n      usePingCompensation: true,\r\n      lastLatencyMs: 0,\r\n      latencyHistory: [],\r\n      lastHeartbeatAckAt: 0,\r\n      syncRequestTime: 0,\r\n      resyncTimer: null,\r\n    },\r\n\r\n    network: {\r\n      myId: null,\r\n      myDeviceLabel: 'HOST',\r\n      appRole: 'idle',\r\n      sessionCode: '',\r\n      lastJoinCode: '',\r\n      hostConn: null,\r\n      connectedPeers: [],\r\n      isOperator: false,\r\n      isConnecting: false,\r\n      isIntentionalDisconnect: false,\r\n      lastKnownDeviceList: null,\r\n      deviceCounter: 0,\r\n      peerLabels: {},\r\n      peerSlots: [null, null, null, null], // index 0 unused, 1-3 for guests\r\n      peerSlotByPeerId: new Map(),\r\n      activeHostConnByPeerId: new Map(),\r\n    },\r\n\r\n    relay: {\r\n      upstreamDataConn: null,\r\n      downstreamDataPeers: [],\r\n      chunkQueue: [],\r\n      isRelaying: false,\r\n    },\r\n\r\n    playlist: {\r\n      items: [],\r\n      currentTrackIndex: -1,\r\n      repeatMode: 0,\r\n      isShuffle: false,\r\n      isFirstTrackLoad: true,\r\n    },\r\n\r\n    files: {\r\n      currentFileBlob: null,\r\n      currentAudioBuffer: null,\r\n      currentFileOpfs: { name: null },\r\n      preloadFileOpfs: { name: null },\r\n    },\r\n\r\n    youtube: {\r\n      currentSessionId: 0,\r\n      currentSubIndex: -1,\r\n      subItemsMap: {},\r\n      scriptLoading: false,\r\n      loadTimeout: null,\r\n      iosWatchdog: null,\r\n    },\r\n\r\n    recovery: {\r\n      pending: false,\r\n      inProgress: {},\r\n      lastRequest: {},\r\n      retryCount: 0,\r\n      pendingFileName: '',\r\n      pendingFileIndex: undefined,\r\n      pendingPlayTime: undefined,\r\n    },\r\n\r\n    ui: {\r\n      animationId: null,\r\n      uiLoopId: null,\r\n      isChatDrawerOpen: false,\r\n      unreadChatCount: 0,\r\n    },\r\n  };\r\n}\r\n\r\n//  State Instance \r\n\r\nlet _state: StateTree = createInitialState();\r\n\r\n//  Accessors \r\n\r\n/**\r\n * Get a state value by dot-separated path.\r\n * @example getState('audio.masterVolume') // 1.0\r\n * @example getState('playlist.items')     // PlaylistItem[]\r\n */\r\nexport function getState<T = unknown>(path: string): T {\r\n  const keys = path.split('.');\r\n  let current: unknown = _state;\r\n  for (const key of keys) {\r\n    if (current == null || typeof current !== 'object') return undefined as T;\r\n    current = (current as Record<string, unknown>)[key];\r\n  }\r\n  return current as T;\r\n}\r\n\r\n/**\r\n * Set a state value by dot-separated path.\r\n * Emits `state:<path>` events for each parent path.\r\n */\r\nexport function setState(path: string, value: unknown): void {\r\n  const keys = path.split('.');\r\n  let current: Record<string, unknown> = _state as unknown as Record<string, unknown>;\r\n\r\n  for (let i = 0; i < keys.length - 1; i++) {\r\n    const key = keys[i];\r\n    if (current[key] == null || typeof current[key] !== 'object') {\r\n      current[key] = {};\r\n    }\r\n    current = current[key] as Record<string, unknown>;\r\n  }\r\n\r\n  const lastKey = keys[keys.length - 1];\r\n  const oldValue = current[lastKey];\r\n  if (oldValue === value) return;\r\n\r\n  current[lastKey] = value;\r\n\r\n  // Emit events for the changed path and all parent paths\r\n  let eventPath = '';\r\n  for (const key of keys) {\r\n    eventPath = eventPath ? `${eventPath}.${key}` : key;\r\n    bus.emit(`state:${eventPath}`, value, path);\r\n  }\r\n}\r\n\r\n/**\r\n * Batch multiple state updates, emitting events only once per path.\r\n */\r\nexport function batchSetState(updates: Record<string, unknown>): void {\r\n  for (const [path, value] of Object.entries(updates)) {\r\n    setState(path, value);\r\n  }\r\n}\r\n\r\n/**\r\n * Get a readonly snapshot of the entire state tree (for debugging).\r\n */\r\nexport function snapshot(): Readonly<StateTree> {\r\n  return _state;\r\n}\r\n\r\n/**\r\n * Reset state to initial values.\r\n */\r\nexport function resetState(): void {\r\n  _state = createInitialState();\r\n}\r\n\r\n/**\r\n * Direct access to the state tree (use sparingly  prefer getState/setState).\r\n */\r\nexport function getRawState(): StateTree {\r\n  return _state;\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Audio Engine (Tone.js)\r\n * Extracted from original app.js lines 476-2112\r\n *\r\n * Manages the entire Tone.js audio graph:\r\n *   Player  Widener  Preamp  Split  Channel Routing  Merge\r\n *      GlobalLowPass  EQ(5-band)  Reverb(wet/dry)  MasterGain  Analyser  Destination\r\n *     + Virtual Bass parallel chain\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { EQ_FREQUENCIES } from '../core/constants.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\n\r\n//  Tone.js global declaration \r\ndeclare const Tone: {\r\n  start(): Promise<void>;\r\n  now(): number;\r\n  context: AudioContext & { state: string };\r\n  Split: new (channels?: number) => ToneNode;\r\n  Merge: new (channels?: number) => ToneNode;\r\n  Gain: new (gain?: number) => ToneGainNode;\r\n  Filter: new (freq?: number | Record<string, unknown>, type?: string, rolloff?: number) => ToneFilterNode;\r\n  Reverb: new (options?: Record<string, unknown>) => ToneReverbNode;\r\n  CrossFade: new (fade?: number) => ToneCrossFadeNode;\r\n  StereoWidener: new (width?: number) => ToneWidenerNode;\r\n  Chebyshev: new (order?: number) => ToneNode;\r\n  Analyser: new (type?: string, size?: number) => ToneAnalyserNode;\r\n  BufferSource: new (buffer?: unknown) => ToneBufferSourceNode;\r\n  Buffer: new (url?: string | ArrayBuffer) => { duration: number };\r\n};\r\n\r\n//  Tone.js node type stubs \r\ninterface ToneNode {\r\n  connect(dest: ToneNode, outputNum?: number, inputNum?: number): ToneNode;\r\n  disconnect(dest?: ToneNode): void;\r\n  dispose(): void;\r\n  toDestination(): ToneNode;\r\n}\r\n\r\ninterface ToneParam {\r\n  value: number;\r\n  rampTo(value: number, time: number): void;\r\n}\r\n\r\ninterface ToneGainNode extends ToneNode {\r\n  gain: ToneParam;\r\n}\r\n\r\ninterface ToneFilterNode extends ToneNode {\r\n  frequency: ToneParam;\r\n  gain: ToneParam;\r\n  Q: ToneParam;\r\n  type: string;\r\n}\r\n\r\ninterface ToneReverbNode extends ToneNode {\r\n  decay: number;\r\n  preDelay: number;\r\n  wet: ToneParam;\r\n  generate(): Promise<void>;\r\n}\r\n\r\ninterface ToneCrossFadeNode extends ToneNode {\r\n  fade: ToneParam;\r\n  a: ToneNode;\r\n  b: ToneNode;\r\n}\r\n\r\ninterface ToneWidenerNode extends ToneNode {\r\n  width: ToneParam;\r\n  wet: ToneParam;\r\n}\r\n\r\ninterface ToneAnalyserNode extends ToneNode {\r\n  smoothing: number;\r\n  getValue(): Float32Array;\r\n}\r\n\r\ninterface ToneBufferSourceNode extends ToneNode {\r\n  buffer: unknown;\r\n  start(time?: number, offset?: number): void;\r\n  stop(time?: number): void;\r\n  onended: (() => void) | null;\r\n  playbackRate: ToneParam;\r\n}\r\n\r\n//  Module-scoped audio nodes \r\nlet toneSplit: ToneNode | null = null;\r\nlet toneMerge: ToneNode | null = null;\r\nlet gainL: ToneGainNode | null = null;\r\nlet gainR: ToneGainNode | null = null;\r\nlet masterGain: ToneGainNode | null = null;\r\nlet reverb: ToneReverbNode | null = null;\r\nlet rvbLowCut: ToneFilterNode | null = null;\r\nlet rvbHighCut: ToneFilterNode | null = null;\r\nlet rvbCrossFade: ToneCrossFadeNode | null = null;\r\nlet eqNodes: ToneFilterNode[] = [];\r\nlet preamp: ToneGainNode | null = null;\r\nlet widener: ToneWidenerNode | null = null;\r\nlet globalLowPass: ToneFilterNode | null = null;\r\nlet analyser: ToneAnalyserNode | null = null;\r\nlet vbFilter: ToneFilterNode | null = null;\r\nlet vbCheby: ToneNode | null = null;\r\nlet vbPostFilter: ToneFilterNode | null = null;\r\nlet vbGain: ToneGainNode | null = null;\r\nlet surroundSplitter: ToneNode | null = null;\r\nlet surroundGain: ToneGainNode | null = null;\r\n\r\nlet _initAudioPromise: Promise<void> | null = null;\r\n\r\n//  Public Getters \r\n\r\nexport function getMasterGain(): ToneGainNode | null { return masterGain; }\r\nexport function getAnalyser(): ToneAnalyserNode | null { return analyser; }\r\nexport function getToneSplit(): ToneNode | null { return toneSplit; }\r\nexport function getToneMerge(): ToneNode | null { return toneMerge; }\r\nexport function getGainL(): ToneGainNode | null { return gainL; }\r\nexport function getGainR(): ToneGainNode | null { return gainR; }\r\nexport function getPreamp(): ToneGainNode | null { return preamp; }\r\nexport function getWidener(): ToneWidenerNode | null { return widener; }\r\nexport function getReverb(): ToneReverbNode | null { return reverb; }\r\nexport function getRvbLowCut(): ToneFilterNode | null { return rvbLowCut; }\r\nexport function getRvbHighCut(): ToneFilterNode | null { return rvbHighCut; }\r\nexport function getRvbCrossFade(): ToneCrossFadeNode | null { return rvbCrossFade; }\r\nexport function getEqNodes(): ToneFilterNode[] { return eqNodes; }\r\nexport function getGlobalLowPass(): ToneFilterNode | null { return globalLowPass; }\r\nexport function getVbFilter(): ToneFilterNode | null { return vbFilter; }\r\nexport function getVbCheby(): ToneNode | null { return vbCheby; }\r\nexport function getVbPostFilter(): ToneFilterNode | null { return vbPostFilter; }\r\nexport function getVbGain(): ToneGainNode | null { return vbGain; }\r\nexport function getSurroundSplitter(): ToneNode | null { return surroundSplitter; }\r\nexport function getSurroundGain(): ToneGainNode | null { return surroundGain; }\r\nexport function isAudioReady(): boolean { return masterGain !== null; }\r\n\r\n// For surround mode setup\r\nexport function ensureSurroundNodes(): { splitter: ToneNode; gain: ToneGainNode } {\r\n  if (!surroundSplitter) {\r\n    surroundSplitter = new Tone.Split(8);\r\n    surroundGain = new Tone.Gain(1);\r\n  }\r\n  return { splitter: surroundSplitter, gain: surroundGain! };\r\n}\r\n\r\n//  Initialization \r\n\r\n/**\r\n * Initialize the full Tone.js audio graph.\r\n * Safe to call multiple times (idempotent).\r\n */\r\nexport async function initAudio(): Promise<void> {\r\n  // Fast-path: already initialized\r\n  if (masterGain) {\r\n    if (typeof Tone !== 'undefined' && Tone?.context?.state !== 'running') {\r\n      try { await Tone.start(); } catch { /* best-effort */ }\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Prevent concurrent initializations\r\n  if (_initAudioPromise) return _initAudioPromise;\r\n\r\n  _initAudioPromise = _doInitAudio();\r\n\r\n  try {\r\n    await _initAudioPromise;\r\n  } finally {\r\n    _initAudioPromise = null;\r\n  }\r\n}\r\n\r\nasync function _doInitAudio(): Promise<void> {\r\n  if (typeof Tone === 'undefined' || !Tone?.context) {\r\n    throw new Error('Tone.js not loaded');\r\n  }\r\n\r\n  if (Tone.context.state !== 'running') {\r\n    await Tone.start();\r\n  }\r\n  if (masterGain) return; // Another call may have finished while awaiting\r\n\r\n  //  Channel & Stereo Processing \r\n  toneSplit = new Tone.Split();\r\n  toneMerge = new Tone.Merge();\r\n  gainL = new Tone.Gain(1);\r\n  gainR = new Tone.Gain(1);\r\n\r\n  toneSplit.connect(gainL, 0);  // L -> gainL\r\n  toneSplit.connect(gainR, 1);  // R -> gainR\r\n\r\n  // Default Routing: Stereo (L0, R1 of merge)\r\n  gainL.connect(toneMerge, 0, 0);\r\n  gainR.connect(toneMerge, 0, 1);\r\n\r\n  //  Effects Chain \r\n  masterGain = new Tone.Gain(1);\r\n\r\n  // EQ (5-Band Peaking Filters)\r\n  eqNodes = EQ_FREQUENCIES.map(f =>\r\n    new Tone.Filter({ type: 'peaking', frequency: f, Q: 1.0, gain: 0 }) as ToneFilterNode\r\n  );\r\n\r\n  // Preamplifier + Stereo Widener\r\n  preamp = new Tone.Gain(1);\r\n  widener = new Tone.StereoWidener(1);\r\n\r\n  // Reverb\r\n  reverb = new Tone.Reverb({ decay: 5.0, preDelay: 0.1 }) as ToneReverbNode;\r\n  reverb.wet.value = 1; // 100% Wet for parallel routing\r\n\r\n  try {\r\n    await reverb.generate();\r\n  } catch (reverbErr) {\r\n    // Clean up partially created nodes before rethrowing\r\n    [toneSplit, toneMerge, gainL, gainR, masterGain, preamp, widener, reverb].forEach(n => {\r\n      try { if (n) n.dispose(); } catch { /* */ }\r\n    });\r\n    toneSplit = toneMerge = gainL = gainR = masterGain = preamp = widener = null;\r\n    reverb = null;\r\n    eqNodes = [];\r\n    throw reverbErr;\r\n  }\r\n\r\n  // Damping filters\r\n  rvbLowCut = new Tone.Filter(20, 'highpass', -12) as ToneFilterNode;\r\n  rvbHighCut = new Tone.Filter(20000, 'lowpass', -12) as ToneFilterNode;\r\n  rvbCrossFade = new Tone.CrossFade(0) as ToneCrossFadeNode; // Initially Dry\r\n\r\n  //  Virtual Bass Chain \r\n  vbFilter = new Tone.Filter(120, 'lowpass', -12) as ToneFilterNode;\r\n  vbCheby = new Tone.Chebyshev(50);\r\n  vbPostFilter = new Tone.Filter(20000, 'lowpass', -12) as ToneFilterNode;\r\n  vbGain = new Tone.Gain(0);\r\n\r\n  //  Connections \r\n  // Player  Widener  Preamp  Split  (Channel Logic)  Merge  EQ  Reverb  Master\r\n\r\n  // 1. Pre-Processing\r\n  widener.connect(preamp);\r\n\r\n  // 2. Channel Splitting\r\n  preamp.connect(toneSplit);\r\n\r\n  // 3. Post-Processing: Merge  GlobalLowPass  EQ  Reverb  Master\r\n  globalLowPass = new Tone.Filter(20000, 'lowpass') as ToneFilterNode;\r\n  toneMerge.connect(globalLowPass);\r\n\r\n  let eqIn: ToneNode = globalLowPass;\r\n  for (const fx of eqNodes) {\r\n    eqIn.connect(fx);\r\n    eqIn = fx;\r\n  }\r\n\r\n  // Wet/Dry Routing with Damping\r\n  eqIn.connect(rvbCrossFade.a);              // Dry path\r\n  eqIn.connect(reverb);                       // Wet path\r\n  reverb.connect(rvbLowCut);\r\n  rvbLowCut.connect(rvbHighCut);\r\n  rvbHighCut.connect(rvbCrossFade.b);\r\n  rvbCrossFade.connect(masterGain);            // Output\r\n\r\n  // Virtual Bass (parallel tap after EQ)\r\n  eqIn.connect(vbFilter);\r\n  vbFilter.connect(vbCheby);\r\n  vbCheby.connect(vbPostFilter);\r\n  vbPostFilter.connect(vbGain);\r\n  vbGain.connect(masterGain);\r\n\r\n  // Visualizer\r\n  analyser = new Tone.Analyser('fft', 2048) as ToneAnalyserNode;\r\n  analyser.smoothing = 0.3;\r\n  masterGain.connect(analyser);\r\n  masterGain.toDestination();\r\n\r\n  // Store analyser reference in state for visualizer access\r\n  setState('audio.analyser', analyser);\r\n\r\n  // iOS Silent Mode Bypass: Play the hidden <audio> element to unlock\r\n  // programmatic playback on iOS (must happen during user gesture)\r\n  try {\r\n    const silentAudio = document.getElementById('silent-trigger') as HTMLAudioElement | null;\r\n    if (silentAudio) {\r\n      silentAudio.play().catch(e => log.debug('[Audio] Silent Audio play failed', e));\r\n    }\r\n\r\n    // Also briefly play/pause the main video element to unlock it for later use\r\n    const videoEl = document.getElementById('main-video') as HTMLVideoElement | null;\r\n    if (videoEl) {\r\n      videoEl.play().then(() => videoEl.pause()).catch(e => log.debug('[Audio] Video unlock failed', e));\r\n    }\r\n  } catch (e) {\r\n    log.debug('[Audio] iOS unlock attempt failed:', e);\r\n  }\r\n\r\n  log.info('[Audio] Tone.js graph initialized');\r\n  bus.emit('audio:ready');\r\n}\r\n\r\n//  Utility \r\n\r\n/** Get Tone.now() safely */\r\nexport function toneNow(): number {\r\n  try {\r\n    return typeof Tone !== 'undefined' ? Tone.now() : 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\n/** Start Tone context (user gesture required) */\r\nexport async function ensureToneStarted(): Promise<void> {\r\n  if (typeof Tone !== 'undefined' && Tone?.context?.state === 'suspended') {\r\n    await Tone.start();\r\n  }\r\n}\r\n\r\n//  Bus Event Handlers \r\n\r\n/** Set master volume (0-1) */\r\nbus.on('audio:set-volume', ((...args: unknown[]) => {\r\n  const vol = Number(args[0]);\r\n  if (!Number.isFinite(vol)) return;\r\n  const clamped = Math.max(0, Math.min(1, vol));\r\n  setState('audio.masterVolume', clamped);\r\n  if (masterGain) {\r\n    masterGain.gain.rampTo(clamped, 0.1);\r\n  }\r\n  bus.emit('audio:volume-changed', clamped);\r\n  // Also sync YouTube player volume when in YouTube mode\r\n  bus.emit('youtube:set-volume', Math.round(clamped * 100));\r\n  // Sync video element volume (native video playback)\r\n  bus.emit('player:sync-video-volume', clamped);\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Apply volume to YouTube player */\r\nbus.on('audio:apply-youtube-volume', (() => {\r\n  const vol = getState<number>('audio.masterVolume') ?? 1;\r\n  // YouTube player volume is 0-100\r\n  const w = window as unknown as Record<string, unknown>;\r\n  const mxqr = w.__MXQR as Record<string, unknown> | undefined;\r\n  // Try to get the YouTube player directly via bus\r\n  bus.emit('youtube:set-volume', Math.round(vol * 100));\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Connect player node to surround routing */\r\nbus.on('audio:connect-surround', ((...args: unknown[]) => {\r\n  const playerNode = args[0] as ToneNode | null;\r\n  const channelIdx = args[1] as number;\r\n  if (!playerNode) return;\r\n\r\n  const { splitter, gain } = ensureSurroundNodes();\r\n  const pre = getPreamp();\r\n  if (!pre) return;\r\n\r\n  try {\r\n    gain.disconnect();\r\n  } catch { /* expected */ }\r\n  gain.connect(pre);\r\n\r\n  playerNode.connect(splitter);\r\n\r\n  try {\r\n    splitter.disconnect();\r\n  } catch { /* expected */ }\r\n\r\n  if (channelIdx === 6) {\r\n    splitter.connect(gain, 6, 0);\r\n    splitter.connect(gain, 4, 0);\r\n  } else if (channelIdx === 7) {\r\n    splitter.connect(gain, 7, 0);\r\n    splitter.connect(gain, 5, 0);\r\n  } else if (channelIdx === 3) {\r\n    splitter.connect(gain, 3, 0);\r\n  } else {\r\n    splitter.connect(gain, channelIdx, 0);\r\n  }\r\n\r\n  log.debug(`[Audio] Surround connected: channel ${channelIdx}`);\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Activate audio engine (triggered from setup UI on user interaction) */\r\nbus.on('audio:activate', (async () => {\r\n  try {\r\n    await initAudio();\r\n    log.info('[Audio] Activated via user interaction');\r\n  } catch (e) {\r\n    log.warn('[Audio] Activation failed:', e);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n// Re-export Tone types for downstream consumers\r\nexport type {\r\n  ToneNode,\r\n  ToneParam,\r\n  ToneGainNode,\r\n  ToneFilterNode,\r\n  ToneReverbNode,\r\n  ToneCrossFadeNode,\r\n  ToneWidenerNode,\r\n  ToneAnalyserNode,\r\n  ToneBufferSourceNode,\r\n};\r\n","/**\r\n * MUSIXQUARE 2.0  Message Protocol & Dispatch\r\n * Extracted from original app.js lines 8935-9027, 9175-9223\r\n *\r\n * Manages: Message validation, handler registry, dispatch (handleData),\r\n * relay command routing (upstream/downstream), RELAYABLE_COMMANDS list.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState } from '../core/state.ts';\r\nimport { MSG } from '../core/constants.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Message Validation \r\n\r\n/**\r\n * Validate message structure  must be an object with a `type` field.\r\n * Optionally checks for required fields.\r\n */\r\nexport function validateMessage(data: unknown, requiredFields: string[] = []): data is Record<string, unknown> {\r\n  if (!data || typeof data !== 'object') return false;\r\n  const msg = data as Record<string, unknown>;\r\n  if (!msg.type) return false;\r\n  for (const field of requiredFields) {\r\n    if (msg[field] === undefined || msg[field] === null) {\r\n      log.warn(`[Network] Missing required field '${field}' in message:`, msg.type);\r\n      return false;\r\n    }\r\n  }\r\n  return true;\r\n}\r\n\r\n//  Relayable Commands \r\n\r\n/** Commands that should be automatically relayed through the chain */\r\nexport const RELAYABLE_COMMANDS: string[] = [\r\n  MSG.PLAY, MSG.PAUSE, MSG.VOLUME,\r\n  MSG.EQ_UPDATE, MSG.PREAMP, MSG.EQ_RESET,\r\n  MSG.REVERB, MSG.REVERB_TYPE, MSG.REVERB_DECAY,\r\n  MSG.REVERB_PREDELAY, MSG.REVERB_LOWCUT, MSG.REVERB_HIGHCUT,\r\n  MSG.STEREO_WIDTH, MSG.VBASS,\r\n  MSG.REPEAT_MODE, MSG.SHUFFLE_MODE,\r\n  MSG.YOUTUBE_PLAY, MSG.YOUTUBE_SYNC, MSG.YOUTUBE_STATE,\r\n  MSG.YOUTUBE_STOP, MSG.YOUTUBE_SUB_TITLE_UPDATE,\r\n  MSG.SYS_TOAST, MSG.STATUS_SYNC, MSG.CHAT,\r\n  MSG.PLAYLIST_UPDATE, MSG.PLAYLIST,\r\n];\r\n\r\n//  Handler Registry \r\n\r\ntype MessageHandler = (data: Record<string, unknown>, conn: DataConnection) => void | Promise<void>;\r\nconst _handlers = new Map<string, MessageHandler>();\r\n\r\n/**\r\n * Register a handler for a specific message type.\r\n * Can be called from any module during initialization.\r\n */\r\nexport function registerHandler(type: string, handler: MessageHandler): void {\r\n  if (_handlers.has(type)) {\r\n    log.warn(`[Protocol] Overwriting handler for: ${type}`);\r\n  }\r\n  _handlers.set(type, handler);\r\n}\r\n\r\n/**\r\n * Register multiple handlers at once.\r\n */\r\nexport function registerHandlers(handlers: Record<string, MessageHandler>): void {\r\n  for (const [type, handler] of Object.entries(handlers)) {\r\n    registerHandler(type, handler);\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a handler is registered for a given message type.\r\n */\r\nexport function hasHandler(type: string): boolean {\r\n  return _handlers.has(type);\r\n}\r\n\r\n//  Message Dispatch \r\n\r\n/**\r\n * Main message dispatcher. Validates, dispatches to registered handler,\r\n * then handles relay routing (downstream/upstream).\r\n */\r\nexport async function handleData(data: unknown, conn: DataConnection): Promise<void> {\r\n  // Generic validation\r\n  if (!validateMessage(data, [])) return;\r\n\r\n  const msg = data as Record<string, unknown>;\r\n  const msgType = msg.type as string;\r\n\r\n  // Dispatch to registered handler\r\n  const handler = _handlers.get(msgType);\r\n  if (handler) {\r\n    try {\r\n      await handler(msg, conn);\r\n    } catch (e) {\r\n      log.error(`Error handling ${msgType}:`, e);\r\n    }\r\n  }\r\n\r\n  // Relay Architecture (only applies to guests with a host connection)\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) return;\r\n\r\n  // 1. RELAY DOWNSTREAM (Control commands from Upstream  Downstream)\r\n  const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  if (downstreamDataPeers.length > 0 && RELAYABLE_COMMANDS.includes(msgType)) {\r\n    downstreamDataPeers.forEach(p => {\r\n      // Prevent infinite loop: do not relay back to sender\r\n      if (p.open && p !== conn) {\r\n        try { p.send(data); } catch { /* peer might have closed */ }\r\n      }\r\n    });\r\n  }\r\n\r\n  // 2. RELAY UPSTREAM (Operator requests from Downstream  Upstream)\r\n  if (conn && conn !== hostConn && hostConn.open) {\r\n    if (msgType.startsWith('request-')) {\r\n      log.debug(`[Relay] Forwarding request downstream->upstream: ${msgType}`);\r\n      hostConn.send(data);\r\n    }\r\n  }\r\n}\r\n\r\n//  Operator Verification \r\n\r\n/**\r\n * Check whether the peer behind `conn` has been granted Operator privileges.\r\n * Called by Host-side `request-*` handlers before executing commands.\r\n */\r\nexport function verifyOperator(conn: DataConnection): boolean {\r\n  if (!conn?.peer) return false;\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const peer = connectedPeers.find(p => p.id === conn.peer);\r\n  return !!(peer && peer.isOp);\r\n}\r\n\r\n//  Initialize Protocol \r\n\r\n/**\r\n * Wire up the EventBus  handleData bridge.\r\n * Call once at app bootstrap after all handlers are registered.\r\n */\r\nexport function initProtocol(): void {\r\n  bus.on('network:data', (data: unknown, conn: unknown) => {\r\n    handleData(data, conn as DataConnection).catch(e =>\r\n      log.error('[Protocol] handleData error:', e)\r\n    );\r\n  });\r\n\r\n  log.info('[Protocol] Message router initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Managed Timers Registry\r\n * Extracted from original app.js lines 737-764\r\n *\r\n * Centralized timer management to prevent orphaned intervals/timeouts.\r\n */\r\n\r\ntype TimerName =\r\n  | 'chunkWatchdog'\r\n  | 'prepareWatchdog'\r\n  | 'autoPlayTimer'\r\n  | 'syncDebounce'\r\n  | 'relayWaitTimeout'\r\n  | 'preloadWatchdog'\r\n  | 'heartbeatMonitor'\r\n  | 'youtubeUILoop'\r\n  | 'youtubeSyncLoop'\r\n  | 'obAutoSlideTimer'\r\n  | 'preloadScheduleTimer';\r\n\r\nconst _timers: Record<string, ReturnType<typeof setTimeout> | null> = {\r\n  chunkWatchdog: null,\r\n  prepareWatchdog: null,\r\n  autoPlayTimer: null,\r\n  syncDebounce: null,\r\n  relayWaitTimeout: null,\r\n  preloadWatchdog: null,\r\n  heartbeatMonitor: null,\r\n  youtubeUILoop: null,\r\n  youtubeSyncLoop: null,\r\n  obAutoSlideTimer: null,\r\n  preloadScheduleTimer: null,\r\n};\r\n\r\n/**\r\n * Set a managed timer. Automatically clears the previous timer for that name.\r\n */\r\nexport function setManagedTimer(\r\n  name: TimerName,\r\n  fn: () => void,\r\n  delayMs: number,\r\n  opts?: { interval?: boolean },\r\n): void {\r\n  clearManagedTimer(name);\r\n  _timers[name] = opts?.interval\r\n    ? setInterval(fn, delayMs)\r\n    : setTimeout(fn, delayMs);\r\n}\r\n\r\n/**\r\n * Clear a specific managed timer.\r\n */\r\nexport function clearManagedTimer(name: TimerName): void {\r\n  const id = _timers[name];\r\n  if (id != null) {\r\n    clearTimeout(id);\r\n    clearInterval(id);\r\n    _timers[name] = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Clear all managed timers.\r\n */\r\nexport function clearAllManagedTimers(): void {\r\n  for (const name of Object.keys(_timers)) {\r\n    clearManagedTimer(name as TimerName);\r\n  }\r\n}\r\n\r\n/**\r\n * Get the raw timer ID (for external checks).\r\n */\r\nexport function getManagedTimer(name: TimerName): ReturnType<typeof setTimeout> | null {\r\n  return _timers[name] ?? null;\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  OPFS Worker Wrapper\r\n * Extracted from original app.js lines 304-340, 1376-1712\r\n *\r\n * Manages: transfer.worker communication, OPFS commands routing,\r\n * session ID validation for worker commands, cleanup helpers.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { INSTANCE_ID, validateSessionId } from '../core/session.ts';\r\nimport type { WorkerCommand, WorkerResponse } from '../types/index.ts';\r\n\r\n//  Worker References \r\nlet _transferWorker: Worker | null = null;\r\nlet _syncWorker: Worker | null = null;\r\n\r\n//  Worker Timer IDs \r\nconst WORKER_TIMER_IDS = ['heartbeat', 'ping', 'video-sync'];\r\n\r\n//  OPFS Instance ID (same as core session) \r\nconst OPFS_INSTANCE_ID = INSTANCE_ID;\r\n\r\n//  Worker Initialization \r\n\r\nexport function setTransferWorker(worker: Worker): void {\r\n  _transferWorker = worker;\r\n  _transferWorker.onmessage = handleTransferWorkerMessage;\r\n}\r\n\r\nexport function setSyncWorker(worker: Worker): void {\r\n  _syncWorker = worker;\r\n  _syncWorker.onmessage = handleSyncWorkerMessage;\r\n}\r\n\r\nexport function getTransferWorker(): Worker | null { return _transferWorker; }\r\nexport function getSyncWorker(): Worker | null { return _syncWorker; }\r\n\r\n//  Command Dispatch \r\n\r\n/**\r\n * Send a command to the appropriate worker.\r\n * OPFS commands go to transferWorker; timer commands go to syncWorker.\r\n */\r\nexport function postWorkerCommand(payload: WorkerCommand, transfers?: Transferable[]): void {\r\n  if (!payload || !payload.command) return;\r\n\r\n  const cmd = payload.command;\r\n\r\n  // OPFS commands require filename + valid numeric sessionId\r\n  if (cmd.startsWith('OPFS_') && cmd !== 'OPFS_RESET' && cmd !== 'OPFS_CLEANUP') {\r\n    if (!payload.filename) log.warn(`[Worker] Missing filename in ${cmd}`);\r\n\r\n    payload.sessionId = validateSessionId(payload.sessionId ?? 0);\r\n\r\n    // For critical write-path operations, never send with sid=0\r\n    const isCriticalOp = (cmd === 'OPFS_START' || cmd === 'OPFS_WRITE' || cmd === 'OPFS_END');\r\n    if (isCriticalOp && !payload.sessionId) {\r\n      log.error(`[Worker] Blocked ${cmd}: invalid sessionId`, payload);\r\n      return;\r\n    }\r\n  }\r\n\r\n  if (cmd.startsWith('OPFS_')) {\r\n    if (_transferWorker) {\r\n      _transferWorker.postMessage(payload, transfers || []);\r\n    } else {\r\n      log.warn(`[Worker] TransferWorker not ready. Dropping command: ${cmd}`);\r\n    }\r\n  } else {\r\n    if (_syncWorker) {\r\n      _syncWorker.postMessage(payload, transfers || []);\r\n    } else {\r\n      log.warn(`[Worker] SyncWorker not ready. Dropping command: ${cmd}`);\r\n    }\r\n  }\r\n}\r\n\r\n//  OPFS Helpers \r\n\r\n/**\r\n * Build the OPFS entry name used by transfer.worker.js.\r\n */\r\nexport function buildSafeOpfsName(filename: string, isPreload = false): string {\r\n  const sanitized = String(filename || '').replace(/[^a-z0-9._-]/gi, '_');\r\n  return (isPreload ? 'preload_' : 'current_') + sanitized + '_' + OPFS_INSTANCE_ID;\r\n}\r\n\r\n/**\r\n * Cleanup OPFS file in worker.\r\n */\r\nexport function cleanupOPFSInWorker(filename: string, isPreload: boolean): void {\r\n  if (!filename) return;\r\n  postWorkerCommand({\r\n    command: 'OPFS_CLEANUP',\r\n    filename,\r\n    isPreload,\r\n    instanceId: OPFS_INSTANCE_ID,\r\n  });\r\n}\r\n\r\n/**\r\n * Read a finalized file from OPFS.\r\n */\r\nexport async function readFileFromOpfs(filename: string, isPreload: boolean): Promise<File | null> {\r\n  if (!filename) return null;\r\n  if (!(navigator.storage && navigator.storage.getDirectory)) return null;\r\n  try {\r\n    const root = await navigator.storage.getDirectory();\r\n    const safeName = buildSafeOpfsName(filename, isPreload);\r\n    const fileHandle = await root.getFileHandle(safeName);\r\n    return await fileHandle.getFile();\r\n  } catch (err) {\r\n    log.error('[OPFS] readFileFromOpfs failed:', err);\r\n    return null;\r\n  }\r\n}\r\n\r\n//  Stop Background Worker Timers \r\n\r\nexport function stopBackgroundWorkerTimers(): void {\r\n  WORKER_TIMER_IDS.forEach((id) => {\r\n    try { postWorkerCommand({ command: 'STOP_TIMER', id }); } catch { /* noop */ }\r\n  });\r\n}\r\n\r\n//  Worker Message Handlers \r\n\r\nfunction handleTransferWorkerMessage(e: MessageEvent<WorkerResponse>): void {\r\n  const data = e.data;\r\n  if (!data || !data.type) return;\r\n\r\n  switch (data.type) {\r\n    case 'OPFS_STARTED':\r\n      log.debug(`[OPFS] Session started: ${data.filename} (SID: ${data.sessionId})`);\r\n      break;\r\n\r\n    case 'OPFS_FILE_READY':\r\n      log.debug(`[OPFS] File finalized: ${data.filename} (SID: ${data.sessionId})`);\r\n      bus.emit('opfs:file-ready', data.filename, data.sessionId, data.isPreload || false);\r\n      break;\r\n\r\n    case 'OPFS_READ_COMPLETE':\r\n      bus.emit('opfs:read-complete', data);\r\n      break;\r\n\r\n    case 'OPFS_WRITE_ERROR':\r\n      log.warn(`[OPFS] Write error for ${data.filename} chunk ${(data as unknown as Record<string, unknown>).chunk}:`, data.error);\r\n      break;\r\n\r\n    case 'OPFS_READ_ERROR':\r\n      log.error(`[OPFS] Read error for ${data.filename}:`, data.error);\r\n      bus.emit('opfs:read-error', data);\r\n      break;\r\n\r\n    case 'OPFS_ERROR':\r\n      log.error(`[OPFS] Worker error: ${data.error} (${data.filename})`);\r\n      bus.emit('opfs:error', data.error, data.filename);\r\n      break;\r\n\r\n    case 'SESSION_MISMATCH': {\r\n      const isPreload = !!data.isPreload;\r\n      log.warn(`[OPFS] Session Mismatch: ${data.filename} (${isPreload ? 'preload' : 'current'})`);\r\n      // Preload mismatches are non-fatal\r\n      if (!isPreload) {\r\n        bus.emit('opfs:session-mismatch', data);\r\n      }\r\n      break;\r\n    }\r\n\r\n    case 'OPFS_RESET_COMPLETE':\r\n      log.debug('[OPFS] Reset complete');\r\n      break;\r\n\r\n    case 'OPFS_CLEANUP_COMPLETE':\r\n      log.debug(`[OPFS] Cleanup complete: ${data.filename}`);\r\n      break;\r\n\r\n    default:\r\n      log.debug(`[OPFS] Unknown worker message: ${data.type}`);\r\n  }\r\n}\r\n\r\nfunction handleSyncWorkerMessage(e: MessageEvent): void {\r\n  const data = e.data;\r\n  if (!data) return;\r\n\r\n  if (data.type === 'TICK') {\r\n    bus.emit('worker:timer-tick', data.id);\r\n  } else if (data.type === 'WORKER_ERROR') {\r\n    log.warn('[SyncWorker] Error:', data.error);\r\n  }\r\n}\r\n\r\n//  Ensure Named File \r\n\r\n/**\r\n * Ensure a blob has a name property (wraps in File if needed).\r\n */\r\nexport function ensureNamedFile(blob: Blob | File | null, fallbackName: string): File | Blob | null {\r\n  if (!blob) return null;\r\n  try {\r\n    if ('name' in blob && typeof blob.name === 'string' && blob.name) return blob;\r\n    const name = (fallbackName && String(fallbackName).trim()) ? String(fallbackName).trim() : 'Track';\r\n    return new File([blob], name, { type: blob.type || '' });\r\n  } catch {\r\n    return blob;\r\n  }\r\n}\r\n\r\n//  Bus Event Handlers \r\n\r\n/** Forward sync commands from bus to the sync worker */\r\nbus.on('worker:sync-command', ((...args: unknown[]) => {\r\n  const payload = args[0] as WorkerCommand;\r\n  if (payload && payload.command) {\r\n    postWorkerCommand(payload);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n","/**\r\n * MUSIXQUARE 2.0  PeerJS Initialization & Connection Management\r\n * Extracted from original app.js lines 6097-6794\r\n *\r\n * Manages: PeerJS instance, session creation/joining, peer slot allocation,\r\n * host incoming connections, guest outbound connection, leave/cleanup.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState, batchSetState } from '../core/state.ts';\r\nimport { MSG, MAX_GUEST_SLOTS, PEER_NAME_PREFIX, APP_STATE } from '../core/constants.ts';\r\nimport { clearAllManagedTimers } from '../core/timers.ts';\r\nimport { registerHandlers } from './protocol.ts';\r\nimport { stopBackgroundWorkerTimers } from '../storage/opfs.ts';\r\nimport type { DataConnection, PeerInstance } from '../types/index.ts';\r\n\r\n//  PeerJS global declaration \r\ndeclare const Peer: new (id?: string, opts?: Record<string, unknown>) => PeerInstance;\r\n\r\n//  Module-scoped state \r\nlet peer: PeerInstance | null = null;\r\n\r\n//  Public Getters \r\nexport function getPeer(): PeerInstance | null { return peer; }\r\n\r\n//  Peer Slot Management \r\n\r\nfunction getPeerLabelBySlot(slot: number): string {\r\n  return `${PEER_NAME_PREFIX} ${slot}`;\r\n}\r\n\r\nfunction getAvailablePeerSlot(preferredSlot: number | null, peerId: string | null): number | null {\r\n  const peerSlots = getState<(string | null)[]>('network.peerSlots');\r\n  const pref = Number(preferredSlot);\r\n  if (Number.isInteger(pref) && pref >= 1 && pref <= MAX_GUEST_SLOTS) {\r\n    const occupant = peerSlots[pref];\r\n    if (!occupant || occupant === peerId) return pref;\r\n  }\r\n  for (let i = 1; i <= MAX_GUEST_SLOTS; i++) {\r\n    if (!peerSlots[i]) return i;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction assignPeerSlot(peerId: string, slot: number): void {\r\n  if (!peerId) return;\r\n  const s = Number(slot);\r\n  if (!Number.isInteger(s) || s < 1 || s > MAX_GUEST_SLOTS) return;\r\n  const peerSlots = getState<(string | null)[]>('network.peerSlots');\r\n  peerSlots[s] = peerId;\r\n  setState('network.peerSlots', peerSlots);\r\n  const map = getState<Map<string, number>>('network.peerSlotByPeerId');\r\n  map.set(peerId, s);\r\n}\r\n\r\nfunction releasePeerSlot(peerId: string): void {\r\n  if (!peerId) return;\r\n  const map = getState<Map<string, number>>('network.peerSlotByPeerId');\r\n  const slot = map.get(peerId);\r\n  if (slot) {\r\n    const peerSlots = getState<(string | null)[]>('network.peerSlots');\r\n    if (peerSlots[slot] === peerId) peerSlots[slot] = null;\r\n  }\r\n  map.delete(peerId);\r\n}\r\n\r\n//  Network Initialization \r\n\r\n/**\r\n * Initialize PeerJS with optional requested ID.\r\n * Returns the assigned peer ID.\r\n */\r\nexport async function initNetwork(requestedId: string | null = null): Promise<string> {\r\n  if (typeof Peer === 'undefined') {\r\n    log.error('[Network] PeerJS not found on window.');\r\n    throw new Error('PEERJS_NOT_LOADED');\r\n  }\r\n\r\n  // Clean up existing peer instance\r\n  if (peer) {\r\n    try { peer.destroy(); } catch { /* noop */ }\r\n    peer = null;\r\n  }\r\n\r\n  // Local-only ICE: no STUN/TURN (forces same LAN / same Wi-Fi)\r\n  const peerOpts: Record<string, unknown> = {\r\n    debug: 2,\r\n    config: {\r\n      iceServers: [],\r\n      sdpSemantics: 'unified-plan',\r\n      bundlePolicy: 'max-bundle',\r\n      iceCandidatePoolSize: 0,\r\n    },\r\n  };\r\n\r\n  // Allow custom PeerJS signaling server injection\r\n  const customPeerServer = (window as unknown as Record<string, unknown>).__MUSIXQUARE_PEER_SERVER__ as\r\n    Record<string, unknown> | undefined;\r\n  if (customPeerServer && typeof customPeerServer === 'object') {\r\n    if (customPeerServer.host) peerOpts.host = customPeerServer.host;\r\n    if (customPeerServer.port) peerOpts.port = customPeerServer.port;\r\n    if (customPeerServer.path) peerOpts.path = customPeerServer.path;\r\n    if (typeof customPeerServer.secure === 'boolean') peerOpts.secure = customPeerServer.secure;\r\n    if (customPeerServer.key) peerOpts.key = customPeerServer.key;\r\n  }\r\n\r\n  peer = new Peer(requestedId || undefined, peerOpts);\r\n  setupPeerEvents();\r\n\r\n  // Wait for open (or fail fast on error)\r\n  const id = await new Promise<string>((resolve, reject) => {\r\n    const onOpen = (id: string) => { peer!.off('open', onOpen); peer!.off('error', onError); resolve(id); };\r\n    const onError = (err: unknown) => { peer!.off('open', onOpen); peer!.off('error', onError); reject(err); };\r\n    peer!.on('open', onOpen);\r\n    peer!.on('error', onError);\r\n  });\r\n\r\n  setState('network.myId', id);\r\n  log.info('[Network] Peer opened:', id);\r\n  bus.emit('network:peer-ready', id);\r\n  return id;\r\n}\r\n\r\n//  Session Code \r\n\r\nfunction generateSessionCode(): string {\r\n  return String(Math.floor(100000 + Math.random() * 900000));\r\n}\r\n\r\n/**\r\n * Create a host session with a short 6-digit code.\r\n * Retries up to maxAttempts if ID is taken.\r\n */\r\nexport async function createHostSessionWithShortCode(maxAttempts = 12): Promise<string> {\r\n  for (let i = 0; i < maxAttempts; i++) {\r\n    const code = generateSessionCode();\r\n    try {\r\n      await initNetwork(code);\r\n      return code;\r\n    } catch (err) {\r\n      if (err && typeof err === 'object' && (err as Record<string, unknown>).type === 'id-taken') {\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error('SESSION_CODE_UNAVAILABLE');\r\n}\r\n\r\n//  PeerJS Event Setup \r\n\r\nfunction setupPeerEvents(): void {\r\n  if (!peer) return;\r\n\r\n  peer.on('error', (err: unknown) => {\r\n    log.error('[PeerJS] Error:', err);\r\n    const appRole = getState<string>('network.appRole');\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n\r\n    if (appRole === 'host' && !hostConn) {\r\n      if (err && typeof err === 'object' && (err as Record<string, unknown>).type === 'id-taken') {\r\n        return; // Handled by retry loop\r\n      }\r\n      bus.emit('network:error', err);\r\n    }\r\n  });\r\n\r\n  peer.on('disconnected', () => {\r\n    log.warn('[PeerJS] Disconnected from signaling server');\r\n  });\r\n\r\n  peer.on('connection', (conn: DataConnection) => {\r\n    // Check if this is a relay connection from a downstream peer\r\n    const connMeta = conn.metadata as Record<string, unknown> | undefined;\r\n    if (connMeta?.type === MSG.DATA_RELAY) {\r\n      // Route to relay handler via bus (any peer can be a relay node)\r\n      bus.emit('relay:incoming-connection', conn);\r\n      return;\r\n    }\r\n\r\n    const appRole = getState<string>('network.appRole');\r\n    if (appRole !== 'host') {\r\n      try { conn.close(); } catch { /* noop */ }\r\n      return;\r\n    }\r\n    handleHostIncomingConnection(conn);\r\n  });\r\n}\r\n\r\n//  Host: Incoming Connection \r\n\r\nfunction handleHostIncomingConnection(conn: DataConnection): void {\r\n  const peerId = conn.peer;\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const activeHostConnByPeerId = getState<Map<string, DataConnection>>('network.activeHostConnByPeerId');\r\n\r\n  // Duplicate connection handling\r\n  const existingActiveConn = activeHostConnByPeerId.get(peerId);\r\n  if (existingActiveConn && existingActiveConn !== conn) {\r\n    activeHostConnByPeerId.set(peerId, conn);\r\n    try {\r\n      if (existingActiveConn.open) {\r\n        existingActiveConn.send({ type: MSG.FORCE_CLOSE_DUPLICATE });\r\n      }\r\n    } catch { /* noop */ }\r\n    try { existingActiveConn.close(); } catch { /* noop */ }\r\n  }\r\n\r\n  // Remove lingering peer object with same id\r\n  const filtered = connectedPeers.filter(p => p.id !== peerId);\r\n  setState('network.connectedPeers', filtered);\r\n\r\n  // Enforce max guests\r\n  if (filtered.length >= MAX_GUEST_SLOTS) {\r\n    const sendFullAndClose = () => {\r\n      try {\r\n        conn.send({\r\n          type: MSG.SESSION_FULL,\r\n          message: '     (  3) .',\r\n        });\r\n      } catch { /* noop */ }\r\n      setTimeout(() => { try { conn.close(); } catch { /* noop */ } }, 500);\r\n    };\r\n    if (conn.open) sendFullAndClose();\r\n    else conn.on('open', sendFullAndClose);\r\n    return;\r\n  }\r\n\r\n  // Allocate slot\r\n  const peerSlotByPeerId = getState<Map<string, number>>('network.peerSlotByPeerId');\r\n  const preferredSlot = peerSlotByPeerId.get(peerId) || null;\r\n  const slot = getAvailablePeerSlot(preferredSlot, peerId);\r\n  if (!slot) {\r\n    try {\r\n      conn.send({\r\n        type: MSG.SESSION_FULL,\r\n        message: '     (  3) .',\r\n      });\r\n    } catch { /* noop */ }\r\n    try { conn.close(); } catch { /* noop */ }\r\n    return;\r\n  }\r\n  assignPeerSlot(peerId, slot);\r\n  const deviceName = getPeerLabelBySlot(slot);\r\n\r\n  // Track label\r\n  const peerLabels = getState<Record<string, string>>('network.peerLabels');\r\n  peerLabels[peerId] = deviceName;\r\n\r\n  // New connection becomes active\r\n  activeHostConnByPeerId.set(peerId, conn);\r\n\r\n  const peerObj = {\r\n    id: peerId,\r\n    slot,\r\n    label: deviceName,\r\n    role: 'guest' as const,\r\n    status: 'connecting' as string,\r\n    conn,\r\n    isOp: false,\r\n    isDataTarget: true,\r\n    joinOrder: slot,\r\n    lastHeartbeat: Date.now(),\r\n    preloadedIndexes: new Set<number>(),\r\n    currentFileId: null as string | null,\r\n  };\r\n\r\n  const updatedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  updatedPeers.push(peerObj as unknown as Record<string, unknown>);\r\n  setState('network.connectedPeers', updatedPeers);\r\n\r\n  conn.on('open', () => {\r\n    peerObj.status = 'connected';\r\n    peerObj.lastHeartbeat = Date.now();\r\n\r\n    // Welcome message with host-assigned label\r\n    try {\r\n      conn.send({\r\n        type: MSG.WELCOME,\r\n        lockChannel: false,\r\n        label: deviceName,\r\n      });\r\n    } catch { /* noop */ }\r\n\r\n    bus.emit('ui:show-toast', `${deviceName} `);\r\n\r\n    // Emit event for other modules to send late-join bootstrap data\r\n    bus.emit('network:peer-connected', conn);\r\n\r\n    // Broadcast updated device list to all peers\r\n    broadcastDeviceList();\r\n    bus.emit('network:role-badge-update');\r\n    log.info(`[Host] ${deviceName} connected (peer: ${peerId})`);\r\n  });\r\n\r\n  conn.on('data', (data: unknown) => {\r\n    try { bus.emit('network:data', data, conn); }\r\n    catch (e) { log.error('[Host] Error in handleData', e); }\r\n  });\r\n\r\n  conn.on('close', () => {\r\n    log.info(`[Host] Connection closed: ${peerId}`);\r\n\r\n    // Ignore stale close events from replaced duplicate connections\r\n    if (activeHostConnByPeerId.get(peerId) !== conn) return;\r\n\r\n    activeHostConnByPeerId.delete(peerId);\r\n    releasePeerSlot(peerId);\r\n\r\n    const peers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n    setState('network.connectedPeers', peers.filter(p => p.id !== peerId));\r\n\r\n    bus.emit('network:peer-disconnected', peerId);\r\n    broadcastDeviceList();\r\n\r\n    const sessionStarted = getState<boolean>('setup.sessionStarted');\r\n    if (sessionStarted) {\r\n      bus.emit('ui:show-toast', `${deviceName}  `);\r\n    }\r\n    log.info(`[Host] ${deviceName} disconnected`);\r\n  });\r\n\r\n  conn.on('error', (err: unknown) => {\r\n    log.error('[Host] Connection error:', err);\r\n\r\n    if (activeHostConnByPeerId.get(peerId) !== conn) {\r\n      try { conn.close(); } catch { /* noop */ }\r\n      return;\r\n    }\r\n\r\n    activeHostConnByPeerId.delete(peerId);\r\n    releasePeerSlot(peerId);\r\n\r\n    const peers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n    setState('network.connectedPeers', peers.filter(p => p.id !== peerId));\r\n\r\n    bus.emit('network:peer-disconnected', peerId);\r\n    broadcastDeviceList();\r\n\r\n    const sessionStarted = getState<boolean>('setup.sessionStarted');\r\n    if (sessionStarted) {\r\n      bus.emit('ui:show-toast', `${deviceName}  `);\r\n    }\r\n    try { conn.close(); } catch { /* noop */ }\r\n  });\r\n}\r\n\r\n//  Guest: Join Session \r\n\r\n/**\r\n * Connect to a host session as a guest.\r\n */\r\nexport function joinSession(hostId: string, retryAttempt = 0): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn && hostConn.open) {\r\n    log.warn('[Join] Already connected to host.');\r\n    return;\r\n  }\r\n\r\n  if (!hostId) {\r\n    bus.emit('network:error', new Error('NO_HOST_ID'));\r\n    return;\r\n  }\r\n\r\n  setState('network.lastJoinCode', hostId);\r\n\r\n  // Ensure peer exists and is open\r\n  if (!peer) {\r\n    if (retryAttempt > 3) {\r\n      bus.emit('network:error', new Error('NETWORK_INIT_FAILED'));\r\n      return;\r\n    }\r\n    initNetwork(null)\r\n      .then(() => joinSession(hostId, retryAttempt + 1))\r\n      .catch((e) => {\r\n        log.error('[Join] Failed to init peer', e);\r\n        bus.emit('network:error', new Error('NETWORK_INIT_FAILED'));\r\n      });\r\n    return;\r\n  }\r\n\r\n  if (!peer.open) {\r\n    if (retryAttempt < 10) {\r\n      setTimeout(() => joinSession(hostId, retryAttempt + 1), 300);\r\n    } else {\r\n      bus.emit('network:error', new Error('PEER_NOT_READY'));\r\n    }\r\n    return;\r\n  }\r\n\r\n  setState('network.isConnecting', true);\r\n\r\n  let conn: DataConnection;\r\n  try {\r\n    const channelMode = getState<number>('audio.channelMode');\r\n    conn = peer.connect(hostId, {\r\n      reliable: true,\r\n      metadata: { label: `mode-${channelMode}` },\r\n    });\r\n  } catch (e) {\r\n    log.error('[Join] peer.connect failed', e);\r\n    setState('network.isConnecting', false);\r\n    bus.emit('network:error', new Error('CONNECT_FAILED'));\r\n    return;\r\n  }\r\n\r\n  // Timeout if host is unreachable\r\n  const timeoutId = setTimeout(() => {\r\n    if (!conn || conn.open || getState<DataConnection | null>('network.hostConn')) return;\r\n    try { conn.close(); } catch { /* noop */ }\r\n    setState('network.isConnecting', false);\r\n    bus.emit('network:error', new Error('HOST_UNREACHABLE'));\r\n  }, 10000);\r\n\r\n  conn.on('open', () => {\r\n    clearTimeout(timeoutId);\r\n    log.info('[Join] Connected to host:', hostId);\r\n\r\n    setState('network.hostConn', conn);\r\n    setState('network.isConnecting', false);\r\n    setState('session.hostId', hostId);\r\n\r\n    // Deduplicate error/close handlers\r\n    (conn as unknown as Record<string, unknown>)._errorHandled = false;\r\n\r\n    conn.on('data', (data: unknown) => {\r\n      bus.emit('network:data', data, conn);\r\n    });\r\n\r\n    conn.on('close', () => {\r\n      log.warn('[Join] Host connection closed');\r\n      setState('network.hostConn', null);\r\n      setState('network.isConnecting', false);\r\n\r\n      if ((conn as unknown as Record<string, unknown>)._errorHandled) {\r\n        setState('network.isIntentionalDisconnect', false);\r\n        return;\r\n      }\r\n      (conn as unknown as Record<string, unknown>)._errorHandled = true;\r\n\r\n      const isIntentional = getState<boolean>('network.isIntentionalDisconnect');\r\n      if (!isIntentional) {\r\n        bus.emit('network:error', new Error('HOST_DISCONNECTED'));\r\n      }\r\n      setState('network.isIntentionalDisconnect', false);\r\n    });\r\n\r\n    conn.on('error', (err: unknown) => {\r\n      log.error('[Join] Host connection error', err);\r\n      setState('network.hostConn', null);\r\n      setState('network.isConnecting', false);\r\n\r\n      if ((conn as unknown as Record<string, unknown>)._errorHandled) return;\r\n      (conn as unknown as Record<string, unknown>)._errorHandled = true;\r\n\r\n      bus.emit('network:error', new Error('HOST_CONNECTION_ERROR'));\r\n    });\r\n\r\n    // Start heartbeat & ping timers for guest\r\n    bus.emit('worker:sync-command', { command: 'START_TIMER', id: 'heartbeat', interval: 1000 });\r\n    bus.emit('worker:sync-command', { command: 'START_TIMER', id: 'ping', interval: 2000 });\r\n\r\n    bus.emit('network:peer-connected', conn);\r\n    bus.emit('setup:guest-join-success');\r\n  });\r\n}\r\n\r\n//  Leave / Cleanup \r\n\r\n/**\r\n * Leave the current session and clean up all network state.\r\n */\r\nexport function leaveSession(): void {\r\n  log.debug('[Network] Leaving session  full cleanup...');\r\n\r\n  setState('network.isIntentionalDisconnect', true);\r\n\r\n  //  1. Stop all background timers \r\n  stopBackgroundWorkerTimers();\r\n  clearAllManagedTimers();\r\n\r\n  //  2. Stop media playback \r\n  bus.emit('player:stop-all-media');\r\n\r\n  //  3. Close network connections \r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    try { hostConn.close(); } catch { /* noop */ }\r\n  }\r\n\r\n  if (peer) {\r\n    try { peer.destroy(); } catch { /* noop */ }\r\n    peer = null;\r\n  }\r\n\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  connectedPeers.forEach(p => {\r\n    try {\r\n      const conn = p.conn as DataConnection | null;\r\n      if (conn) conn.close();\r\n    } catch { /* noop */ }\r\n  });\r\n\r\n  // Close downstream relay connections\r\n  const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamDataPeers.forEach(p => {\r\n    try { p.close(); } catch { /* noop */ }\r\n  });\r\n\r\n  //  4. Clear peer slots and maps \r\n  const activeHostConnByPeerId = getState<Map<string, DataConnection>>('network.activeHostConnByPeerId');\r\n  const peerSlotByPeerId = getState<Map<string, number>>('network.peerSlotByPeerId');\r\n  activeHostConnByPeerId.clear();\r\n  peerSlotByPeerId.clear();\r\n  const peerSlots = getState<(string | null)[]>('network.peerSlots');\r\n  for (let i = 1; i <= MAX_GUEST_SLOTS; i++) peerSlots[i] = null;\r\n\r\n  //  5. Clear transfer state \r\n  const fileReorderBuffer = getState<Map<unknown, unknown>>('transfer.fileReorderBuffer');\r\n  const preloadReorderBuffer = getState<Map<unknown, unknown>>('transfer.preloadReorderBuffer');\r\n  const preloadSessionState = getState<Map<unknown, unknown>>('transfer.preloadSessionState');\r\n  if (fileReorderBuffer) fileReorderBuffer.clear();\r\n  if (preloadReorderBuffer) preloadReorderBuffer.clear();\r\n  if (preloadSessionState) preloadSessionState.clear();\r\n\r\n  //  6. Revoke blob URLs \r\n  bus.emit('blob:revoke-all');\r\n\r\n  //  7. Reset all state \r\n  batchSetState({\r\n    // Network\r\n    'network.myId': null,\r\n    'network.myDeviceLabel': 'HOST',\r\n    'network.hostConn': null,\r\n    'network.connectedPeers': [],\r\n    'network.isOperator': false,\r\n    'network.isConnecting': false,\r\n    'network.lastKnownDeviceList': null,\r\n    'network.peerLabels': {},\r\n    'network.isIntentionalDisconnect': false,\r\n    // Relay\r\n    'relay.upstreamDataConn': null,\r\n    'relay.downstreamDataPeers': [],\r\n    // Playlist\r\n    'playlist.items': [],\r\n    'playlist.currentTrackIndex': -1,\r\n    'playlist.nextTrackIndex': -1,\r\n    // Transfer\r\n    'transfer.meta': null,\r\n    'transfer.state': 'IDLE',\r\n    'transfer.receivedCount': 0,\r\n    'transfer.localSessionId': 0,\r\n    // Files\r\n    'files.currentFileBlob': null,\r\n    // Preload\r\n    'preload.nextFileBlob': null,\r\n    'preload.meta': null,\r\n    // Sync\r\n    'sync.localOffset': 0,\r\n    'sync.autoSyncOffset': 0,\r\n    // Player\r\n    'player.pausedAt': 0,\r\n    'player.currentAudioBuffer': null,\r\n    // App state\r\n    'appState': APP_STATE.IDLE,\r\n  });\r\n\r\n  //  8. Reset UI \r\n  bus.emit('ui:update-playlist');\r\n  bus.emit('player:state-changed', APP_STATE.IDLE);\r\n\r\n  log.debug('[Network] Session left  full cleanup complete.');\r\n}\r\n\r\n//  Broadcast Utilities \r\n\r\n/**\r\n * Broadcast a message to all connected peers.\r\n */\r\nexport function broadcast(msg: unknown, isDataOnly = false): void {\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  connectedPeers.forEach(p => {\r\n    try {\r\n      if (p.status === 'connected' && p.conn) {\r\n        const conn = p.conn as DataConnection;\r\n        if (conn.open) {\r\n          if (!isDataOnly || p.isDataTarget !== false) {\r\n            conn.send(msg);\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      log.warn(`[broadcast] Send failed for peer ${p.label || p.id}:`, e);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Broadcast to all peers except one (used for chat relays).\r\n */\r\nexport function broadcastExcept(excludePeerId: string, msg: unknown, isDataOnly = false): void {\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  connectedPeers.forEach(p => {\r\n    try {\r\n      if (p.status === 'connected' && p.conn) {\r\n        const conn = p.conn as DataConnection;\r\n        if (conn.open) {\r\n          if (excludePeerId && p.id === excludePeerId) return;\r\n          if (!isDataOnly || p.isDataTarget !== false) {\r\n            conn.send(msg);\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      log.warn(`[broadcastExcept] Send failed for peer ${p.label || p.id}:`, e);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Build and broadcast device list to all peers.\r\n */\r\nexport function broadcastDeviceList(): void {\r\n  const myId = getState<string | null>('network.myId');\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n\r\n  const list = [\r\n    { id: myId, label: 'HOST', status: 'connected', isHost: true },\r\n    ...connectedPeers\r\n      .sort((a, b) => (a.joinOrder as number) - (b.joinOrder as number))\r\n      .map(p => ({\r\n        id: p.id,\r\n        label: p.label,\r\n        status: p.status,\r\n        isHost: false,\r\n        isOp: p.isOp,\r\n      })),\r\n  ];\r\n\r\n  const msg = { type: MSG.DEVICE_LIST_UPDATE, list };\r\n  broadcast(msg);\r\n  bus.emit('network:device-list', list);\r\n}\r\n\r\n/**\r\n * Send a message to the host (guest-only helper).\r\n */\r\nexport function sendToHost(msg: unknown): boolean {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn || !hostConn.open) return false;\r\n  try {\r\n    hostConn.send(msg);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Send pause state to a single connection.\r\n */\r\nexport function sendPauseState(conn: DataConnection, time: number): void {\r\n  try {\r\n    if (!conn || !conn.open) return;\r\n    conn.send({\r\n      type: MSG.PAUSE,\r\n      time,\r\n      index: getState<number>('playlist.currentTrackIndex'),\r\n      state: getState<string>('appState'),\r\n      timestamp: Date.now(),\r\n    });\r\n  } catch { /* noop */ }\r\n}\r\n\r\n//  Bus Event Handlers \r\n\r\nbus.on('network:broadcast', ((...args: unknown[]) => {\r\n  const msg = args[0];\r\n  if (msg) broadcast(msg);\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('network:broadcast-except', ((...args: unknown[]) => {\r\n  const excludePeerId = args[0] as string;\r\n  const msg = args[1];\r\n  if (msg) broadcastExcept(excludePeerId, msg);\r\n}) as (...args: unknown[]) => void);\r\n\r\n// Host: Toggle operator permission on a peer\r\nbus.on('network:toggle-operator', ((...args: unknown[]) => {\r\n  const peerId = args[0] as string;\r\n  if (!peerId) return;\r\n\r\n  // Only Host can toggle operator\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const p = connectedPeers.find(x => x.id === peerId);\r\n  if (p) {\r\n    p.isOp = !p.isOp;\r\n    const conn = p.conn as DataConnection;\r\n    if (conn && conn.open) {\r\n      conn.send({ type: p.isOp ? MSG.OPERATOR_GRANT : MSG.OPERATOR_REVOKE });\r\n    } else {\r\n      log.warn(`[OP] Cannot notify peer ${peerId}  connection not open`);\r\n    }\r\n    broadcastDeviceList();\r\n    bus.emit('ui:show-toast', `${p.label}  ${p.isOp ? '' : ''}`);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n// Expose toggleOperator globally for device-list UI buttons\r\n(window as unknown as Record<string, unknown>).toggleOperator = (peerId: string) => {\r\n  bus.emit('network:toggle-operator', peerId);\r\n};\r\n\r\nbus.on('network:device-list', ((...args: unknown[]) => {\r\n  const list = args[0] as Array<Record<string, unknown>>;\r\n  if (Array.isArray(list)) {\r\n    setState('network.lastKnownDeviceList', list);\r\n    bus.emit('network:device-list-update', list);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n//  Guest Protocol Handlers \r\n\r\nfunction handleWelcome(data: Record<string, unknown>): void {\r\n  if (data.label) {\r\n    setState('network.myDeviceLabel', String(data.label));\r\n  }\r\n  bus.emit('network:role-badge-update');\r\n}\r\n\r\nfunction handleSessionFull(data: Record<string, unknown>): void {\r\n  const msg = data.message ? String(data.message) : '  ';\r\n\r\n  setState('network.isIntentionalDisconnect', true);\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    try { hostConn.close(); } catch { /* noop */ }\r\n    setState('network.hostConn', null);\r\n  }\r\n  setState('network.isConnecting', false);\r\n  bus.emit('network:role-badge-update');\r\n  bus.emit('network:session-full', msg);\r\n}\r\n\r\nfunction handleDeviceListUpdateMsg(data: Record<string, unknown>): void {\r\n  const list = Array.isArray(data.list) ? data.list as Array<Record<string, unknown>> : [];\r\n  setState('network.lastKnownDeviceList', list);\r\n\r\n  const myId = getState<string | null>('network.myId');\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n\r\n  if (hostConn && myId) {\r\n    const amIStillConnected = list.find(p => p && p.id === myId);\r\n    if (!amIStillConnected) {\r\n      log.warn('[Guest] Removed from Host device list. Leaving session...');\r\n      setState('network.isIntentionalDisconnect', true);\r\n      bus.emit('network:kicked-from-session');\r\n      return;\r\n    }\r\n    const me = list.find(p => p && p.id === myId);\r\n    if (me && me.label) {\r\n      setState('network.myDeviceLabel', String(me.label));\r\n    }\r\n  }\r\n\r\n  bus.emit('network:device-list-update', list);\r\n}\r\n\r\nfunction handleForceCloseDuplicate(): void {\r\n  log.warn('[Guest] Received force-close-duplicate  connection will close');\r\n  // No action needed; the connection close event handles cleanup\r\n}\r\n\r\nfunction handleSysToast(data: Record<string, unknown>): void {\r\n  if (data.message) {\r\n    bus.emit('ui:show-toast', String(data.message));\r\n  }\r\n}\r\n\r\nfunction handleOperatorGrant(): void {\r\n  setState('network.isOperator', true);\r\n  bus.emit('ui:show-toast', 'Operator  .');\r\n  bus.emit('ui:play-btn-state', true);\r\n  bus.emit('network:role-badge-update');\r\n}\r\n\r\nfunction handleOperatorRevoke(): void {\r\n  setState('network.isOperator', false);\r\n  bus.emit('ui:show-toast', 'Operator  .');\r\n  bus.emit('network:role-badge-update');\r\n}\r\n\r\nfunction handleSessionStart(): void {\r\n  setState('setup.sessionStarted', true);\r\n  bus.emit('setup:hide-overlay');\r\n  bus.emit('network:role-badge-update');\r\n  log.info('[Peer] Session started');\r\n}\r\n\r\n//  Init Peer Protocol Handlers \r\n\r\nexport function initPeerHandlers(): void {\r\n  registerHandlers({\r\n    [MSG.WELCOME]: handleWelcome,\r\n    [MSG.SESSION_FULL]: handleSessionFull,\r\n    [MSG.SESSION_START]: handleSessionStart as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.DEVICE_LIST_UPDATE]: handleDeviceListUpdateMsg,\r\n    [MSG.FORCE_CLOSE_DUPLICATE]: handleForceCloseDuplicate as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.SYS_TOAST]: handleSysToast,\r\n    [MSG.OPERATOR_GRANT]: handleOperatorGrant as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.OPERATOR_REVOKE]: handleOperatorRevoke as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n  });\r\n\r\n  log.info('[Peer] Protocol handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Audio Effects\r\n * Extracted from original app.js lines 5342-5640\r\n *\r\n * Manages: Reverb (wet/dry + damping), 5-band EQ, Virtual Bass,\r\n * Stereo Width, Preamp gain compensation.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG } from '../core/constants.ts';\r\nimport { registerHandlers, verifyOperator } from '../network/protocol.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\nimport {\r\n  getMasterGain,\r\n  getReverb,\r\n  getRvbLowCut,\r\n  getRvbHighCut,\r\n  getRvbCrossFade,\r\n  getEqNodes,\r\n  getPreamp,\r\n  getWidener,\r\n  getGlobalLowPass,\r\n  getVbFilter,\r\n  getVbPostFilter,\r\n  getVbGain,\r\n} from './engine.ts';\r\n\r\n//  Apply All Settings \r\n\r\n/**\r\n * Synchronize all audio effect parameters to the Tone.js nodes.\r\n * Call after any setting change.\r\n */\r\nexport function applySettings(): void {\r\n  if (!getMasterGain()) return;\r\n\r\n  const reverbMix = getState<number>('audio.reverbMix');\r\n  const reverbDecay = getState<number>('audio.reverbDecay');\r\n  const reverbPreDelay = getState<number>('audio.reverbPreDelay');\r\n  const reverbLowCut = getState<number>('audio.reverbLowCut');\r\n  const reverbHighCut = getState<number>('audio.reverbHighCut');\r\n  const stereoWidth = getState<number>('audio.stereoWidth');\r\n  const virtualBass = getState<number>('audio.virtualBass');\r\n  const eqValues = getState<number[]>('audio.eqValues');\r\n  const userPreampGain = getState<number>('audio.userPreampGain');\r\n  const channelMode = getState<number>('audio.channelMode');\r\n  const isSurroundMode = getState<boolean>('audio.isSurroundMode');\r\n  const surroundChannelIndex = getState<number>('audio.surroundChannelIndex');\r\n  const subFreq = getState<number>('audio.subFreq');\r\n\r\n  // Reverb Mix (CrossFade)\r\n  const crossFade = getRvbCrossFade();\r\n  if (crossFade) crossFade.fade.rampTo(reverbMix, 0.1);\r\n\r\n  // Reverb Engine Sync\r\n  const rev = getReverb();\r\n  if (rev) {\r\n    let needsGenerate = false;\r\n    if (rev.decay !== reverbDecay) {\r\n      rev.decay = reverbDecay;\r\n      needsGenerate = true;\r\n    }\r\n    if (rev.preDelay !== reverbPreDelay) {\r\n      rev.preDelay = reverbPreDelay;\r\n      needsGenerate = true;\r\n    }\r\n    if (needsGenerate) {\r\n      rev.generate().catch(e => log.warn('[Reverb] generate() failed:', e));\r\n    }\r\n  }\r\n\r\n  // Reverb damping filters\r\n  const rlc = getRvbLowCut();\r\n  if (rlc) {\r\n    const lFreq = 20 * Math.pow(50, reverbLowCut / 100);\r\n    rlc.frequency.rampTo(lFreq, 0.1);\r\n  }\r\n  const rhc = getRvbHighCut();\r\n  if (rhc) {\r\n    const hFreq = 20000 * Math.pow(0.05, reverbHighCut / 100);\r\n    rhc.frequency.rampTo(hFreq, 0.1);\r\n  }\r\n\r\n  // EQ Sync\r\n  const nodes = getEqNodes();\r\n  if (nodes && eqValues) {\r\n    nodes.forEach((node, i) => {\r\n      if (node.gain.value !== eqValues[i]) {\r\n        node.gain.rampTo(eqValues[i], 0.1);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Stereo Width & Gain Compensation\r\n  let compensation = 1.0;\r\n  const wid = getWidener();\r\n  if (wid) {\r\n    wid.wet.rampTo(1, 0.1);\r\n    wid.width.rampTo(stereoWidth * 0.5, 0.1);\r\n    if (stereoWidth < 1.0) {\r\n      compensation = 0.6 + 0.4 * stereoWidth;\r\n    }\r\n  }\r\n\r\n  // Preamp\r\n  const pre = getPreamp();\r\n  if (pre) pre.gain.rampTo(userPreampGain * compensation, 0.1);\r\n\r\n  // Virtual Bass\r\n  const isWooferRole = channelMode === 2 || (isSurroundMode && surroundChannelIndex === 3);\r\n  const vbpf = getVbPostFilter();\r\n  if (vbpf) {\r\n    vbpf.frequency.rampTo(isWooferRole ? subFreq : 20000, 0.1);\r\n  }\r\n  const vbg = getVbGain();\r\n  if (vbg) vbg.gain.rampTo(virtualBass, 0.1);\r\n}\r\n\r\n//  Reverb Controls \r\n\r\nexport function setReverbParam(param: string, val: number, skipApply = false): void {\r\n  const v = Number(val);\r\n  if (!Number.isFinite(v)) return;\r\n\r\n  switch (param) {\r\n    case 'mix':\r\n      setState('audio.reverbMix', v / 100);\r\n      break;\r\n    case 'decay':\r\n      setState('audio.reverbDecay', v);\r\n      break;\r\n    case 'predelay':\r\n      setState('audio.reverbPreDelay', v);\r\n      break;\r\n    case 'lowcut':\r\n      setState('audio.reverbLowCut', v);\r\n      break;\r\n    case 'highcut':\r\n      setState('audio.reverbHighCut', v);\r\n      break;\r\n  }\r\n\r\n  if (!skipApply) applySettings();\r\n}\r\n\r\nexport function resetReverb(): void {\r\n  setReverbParam('mix', 0, true);\r\n  setReverbParam('decay', 5.0, true);\r\n  setReverbParam('predelay', 0.1, true);\r\n  setReverbParam('lowcut', 0, true);\r\n  setReverbParam('highcut', 0, true);\r\n  applySettings();\r\n}\r\n\r\n//  EQ Controls \r\n\r\nexport function setEQ(idx: number, val: number): void {\r\n  const bandIdx = Number(idx);\r\n  const bandVal = Number(val);\r\n\r\n  const eqValues = getState<number[]>('audio.eqValues');\r\n  if (eqValues) {\r\n    eqValues[bandIdx] = bandVal;\r\n    setState('audio.eqValues', [...eqValues]);\r\n  }\r\n\r\n  const nodes = getEqNodes();\r\n  if (nodes?.[bandIdx]) {\r\n    nodes[bandIdx].gain.rampTo(bandVal, 0.1);\r\n  }\r\n\r\n  // Update DOM label + slider (for sync from network)\r\n  const label = document.getElementById(`eq-val-${bandIdx}`);\r\n  if (label) label.innerText = bandVal > 0 ? `+${bandVal}` : String(bandVal);\r\n  const bands = document.querySelectorAll('.eq-band');\r\n  if (bands[bandIdx]) {\r\n    const slider = bands[bandIdx].querySelector('.eq-slider') as HTMLInputElement | null;\r\n    if (slider && parseFloat(slider.value) !== bandVal) slider.value = String(bandVal);\r\n  }\r\n}\r\n\r\nexport function resetEQ(): void {\r\n  const nodes = getEqNodes();\r\n  const count = nodes ? nodes.length : 5;\r\n  setState('audio.eqValues', Array(count).fill(0));\r\n  setState('audio.userPreampGain', 1.0);\r\n  nodes?.forEach(node => node.gain.rampTo(0, 0.1));\r\n  applySettings();\r\n}\r\n\r\n//  Preamp \r\n\r\nexport function setPreamp(valDb: number): void {\r\n  const db = Number(valDb);\r\n  const linear = Math.pow(10, db / 20);\r\n  setState('audio.userPreampGain', linear);\r\n  applySettings();\r\n}\r\n\r\n//  Stereo Width \r\n\r\nexport function setStereoWidth(val: number): void {\r\n  setState('audio.stereoWidth', val / 100);\r\n  applySettings();\r\n}\r\n\r\nexport function resetStereoWidth(): void {\r\n  setStereoWidth(100);\r\n}\r\n\r\n//  Virtual Bass \r\n\r\nexport function setVirtualBass(val: number): void {\r\n  setState('audio.virtualBass', val / 100);\r\n  applySettings();\r\n}\r\n\r\nexport function resetVirtualBass(): void {\r\n  setVirtualBass(0);\r\n}\r\n\r\n//  Subwoofer Cutoff \r\n\r\nexport function updateSubFreq(val: number): void {\r\n  const freq = Number(val);\r\n  setState('audio.subFreq', freq);\r\n\r\n  const vbf = getVbFilter();\r\n  if (vbf) vbf.frequency.rampTo(freq, 0.1);\r\n\r\n  const channelMode = getState<number>('audio.channelMode');\r\n  const isSurroundMode = getState<boolean>('audio.isSurroundMode');\r\n  const surroundChannelIndex = getState<number>('audio.surroundChannelIndex');\r\n  const isSubMode = channelMode === 2 && !isSurroundMode;\r\n  const isLFE = isSurroundMode && surroundChannelIndex === 3;\r\n\r\n  const vbpf = getVbPostFilter();\r\n  if (vbpf) {\r\n    vbpf.frequency.rampTo((isSubMode || isLFE) ? freq : 20000, 0.1);\r\n  }\r\n\r\n  const lp = getGlobalLowPass();\r\n  if (lp && (isSubMode || isLFE)) {\r\n    lp.frequency.rampTo(freq, 0.1);\r\n  }\r\n}\r\n\r\n//  Network Broadcast Helpers \r\n\r\n/**\r\n * Broadcast an audio setting change (Host) or send REQUEST_SETTING (OP Guest).\r\n * Called only on 'change' event (slider release), not during 'input' (dragging).\r\n */\r\nfunction _broadcastOrRequestSetting(msgType: string, value: number): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    // Host: broadcast to all peers\r\n    broadcast({ type: msgType, value });\r\n  } else {\r\n    // Guest (OP): request Host to apply + broadcast\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SETTING, settingType: msgType, value });\r\n    }\r\n  }\r\n}\r\n\r\nfunction _broadcastOrRequestSettingEQ(band: number, value: number): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    broadcast({ type: MSG.EQ_UPDATE, band, value });\r\n  } else {\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SETTING, settingType: 'eq', band, value });\r\n    }\r\n  }\r\n}\r\n\r\n//  Bus Event Handlers \r\n\r\n/** Central audio effect dispatcher from settings UI */\r\nbus.on('audio:update-effect', ((...args: unknown[]) => {\r\n  const type = args[0] as string;\r\n  const param = args[1] as string;\r\n  const value = Number(args[2]);\r\n  const isPreview = !!args[3]; // true = dragging (input), false = released (change)\r\n\r\n  if (!Number.isFinite(value)) return;\r\n\r\n  switch (type) {\r\n    case 'reverb':\r\n      setReverbParam(param, value);\r\n      // Broadcast on release only (not while dragging)\r\n      if (!isPreview) {\r\n        const REVERB_MSG_MAP: Record<string, string> = {\r\n          mix: MSG.REVERB, decay: MSG.REVERB_DECAY, predelay: MSG.REVERB_PREDELAY,\r\n          lowcut: MSG.REVERB_LOWCUT, highcut: MSG.REVERB_HIGHCUT,\r\n        };\r\n        const msgType = REVERB_MSG_MAP[param];\r\n        if (msgType) _broadcastOrRequestSetting(msgType, value);\r\n      }\r\n      break;\r\n    case 'stereo':\r\n      if (param === 'mix') {\r\n        setStereoWidth(value);\r\n        if (!isPreview) _broadcastOrRequestSetting(MSG.STEREO_WIDTH, value);\r\n      }\r\n      break;\r\n    case 'vbass':\r\n      if (param === 'mix') {\r\n        setVirtualBass(value);\r\n        if (!isPreview) _broadcastOrRequestSetting(MSG.VBASS, value);\r\n      }\r\n      break;\r\n    case 'cutoff':\r\n      if (param === 'value') updateSubFreq(value);\r\n      break;\r\n    default:\r\n      log.warn('[Effects] Unknown effect type:', type);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Set preamp gain from dB value */\r\nbus.on('audio:set-preamp', ((...args: unknown[]) => {\r\n  const val = Number(args[0]);\r\n  const isPreview = !!args[1];\r\n  if (!Number.isFinite(val)) return;\r\n  setPreamp(val);\r\n  if (!isPreview) _broadcastOrRequestSetting(MSG.PREAMP, val);\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Set EQ band */\r\nbus.on('audio:set-eq', ((...args: unknown[]) => {\r\n  const band = Number(args[0]);\r\n  const val = Number(args[1]);\r\n  const isPreview = !!args[2];\r\n  if (!Number.isFinite(band) || !Number.isFinite(val)) return;\r\n  setEQ(band, val);\r\n  if (!isPreview) {\r\n    _broadcastOrRequestSettingEQ(band, val);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Reset handlers  with OP/Host routing */\r\nbus.on('audio:reset-reverb', (() => {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    // Host: reset locally + broadcast\r\n    resetReverb();\r\n    broadcast({ type: MSG.REVERB, value: 0 });\r\n    broadcast({ type: MSG.REVERB_DECAY, value: 5.0 });\r\n    broadcast({ type: MSG.REVERB_PREDELAY, value: 0.1 });\r\n    broadcast({ type: MSG.REVERB_LOWCUT, value: 0 });\r\n    broadcast({ type: MSG.REVERB_HIGHCUT, value: 0 });\r\n  } else {\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_REVERB_RESET });\r\n    }\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('audio:reset-eq', (() => {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    // Host: reset locally + broadcast\r\n    resetEQ();\r\n    broadcast({ type: MSG.EQ_RESET });\r\n  } else {\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_EQ_RESET });\r\n    }\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('audio:reset-stereo', (() => {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    resetStereoWidth();\r\n    broadcast({ type: MSG.STEREO_WIDTH, value: 100 });\r\n  } else {\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SETTING, settingType: MSG.STEREO_WIDTH, value: 100 });\r\n    }\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('audio:reset-vbass', (() => {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    resetVirtualBass();\r\n    broadcast({ type: MSG.VBASS, value: 0 });\r\n  } else {\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SETTING, settingType: MSG.VBASS, value: 0 });\r\n    }\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n/** Sync state defaults to Tone.js nodes after audio graph init */\r\nbus.on('audio:ready', (() => {\r\n  log.info('[Effects] Audio ready  applying default settings');\r\n  applySettings();\r\n}) as (...args: unknown[]) => void);\r\n\r\n/**\r\n * Host: Send all current audio settings to a newly connected peer (late-join bootstrap).\r\n */\r\nbus.on('network:peer-connected', ((...args: unknown[]) => {\r\n  const conn = args[0] as DataConnection | null;\r\n  if (!conn?.open) return;\r\n\r\n  // Only Host bootstraps guests\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  try {\r\n    const masterVolume = getState<number>('audio.masterVolume');\r\n    conn.send({ type: MSG.VOLUME, value: masterVolume });\r\n\r\n    const reverbMix = getState<number>('audio.reverbMix');\r\n    conn.send({ type: MSG.REVERB, value: reverbMix * 100 });\r\n\r\n    const reverbDecay = getState<number>('audio.reverbDecay');\r\n    conn.send({ type: MSG.REVERB_DECAY, value: reverbDecay });\r\n\r\n    const reverbPreDelay = getState<number>('audio.reverbPreDelay');\r\n    conn.send({ type: MSG.REVERB_PREDELAY, value: reverbPreDelay });\r\n\r\n    const reverbLowCut = getState<number>('audio.reverbLowCut');\r\n    conn.send({ type: MSG.REVERB_LOWCUT, value: reverbLowCut });\r\n\r\n    const reverbHighCut = getState<number>('audio.reverbHighCut');\r\n    conn.send({ type: MSG.REVERB_HIGHCUT, value: reverbHighCut });\r\n\r\n    const eqValues = getState<number[]>('audio.eqValues');\r\n    if (eqValues) {\r\n      eqValues.forEach((val, i) => {\r\n        conn.send({ type: MSG.EQ_UPDATE, band: i, value: val });\r\n      });\r\n    }\r\n\r\n    const userPreampGain = getState<number>('audio.userPreampGain');\r\n    conn.send({ type: MSG.PREAMP, value: Math.round(20 * Math.log10(Math.max(userPreampGain, 1e-6))) });\r\n\r\n    const stereoWidth = getState<number>('audio.stereoWidth');\r\n    conn.send({ type: MSG.STEREO_WIDTH, value: stereoWidth * 100 });\r\n\r\n    const virtualBass = getState<number>('audio.virtualBass');\r\n    conn.send({ type: MSG.VBASS, value: virtualBass * 100 });\r\n\r\n    log.debug('[Effects] Bootstrap: sent audio settings to new peer');\r\n  } catch (e) {\r\n    log.warn('[Effects] Bootstrap send failed:', e);\r\n  }\r\n}) as (...args: unknown[]) => void);\r\n\r\n//  Network Protocol Handlers (HostGuest effect sync) \r\n\r\nfunction handleVolume(data: Record<string, unknown>): void {\r\n  if (data.value === undefined || data.value === null) return;\r\n  const vol = Number(data.value);\r\n  bus.emit('audio:set-volume', vol);\r\n  bus.emit('ui:show-toast', `Volume: ${Math.round(vol * 100)}%`);\r\n}\r\n\r\nfunction handleEQUpdateMsg(data: Record<string, unknown>): void {\r\n  if (data.band === undefined || data.value === undefined) return;\r\n  setEQ(Number(data.band), Number(data.value));\r\n}\r\n\r\nfunction handlePreampMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setPreamp(Number(data.value));\r\n}\r\n\r\nfunction handleEQResetMsg(): void {\r\n  resetEQ();\r\n}\r\n\r\nfunction handleReverbMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setReverbParam('mix', Number(data.value));\r\n}\r\n\r\nfunction handleReverbTypeMsg(data: Record<string, unknown>): void {\r\n  if (!data.value) return;\r\n  const type = String(data.value);\r\n  switch (type) {\r\n    case 'room':\r\n      setState('audio.reverbDecay', 1.5);\r\n      setState('audio.reverbPreDelay', 0.05);\r\n      break;\r\n    case 'hall':\r\n      setState('audio.reverbDecay', 3.5);\r\n      setState('audio.reverbPreDelay', 0.1);\r\n      break;\r\n    case 'space':\r\n      setState('audio.reverbDecay', 7.0);\r\n      setState('audio.reverbPreDelay', 0.2);\r\n      break;\r\n    default:\r\n      return;\r\n  }\r\n  setState('audio.reverbType', type);\r\n  applySettings();\r\n  bus.emit('ui:show-toast', ` : ${type}`);\r\n}\r\n\r\nfunction handleReverbDecayMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setReverbParam('decay', Number(data.value));\r\n}\r\n\r\nfunction handleReverbPreDelayMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setReverbParam('predelay', Number(data.value));\r\n}\r\n\r\nfunction handleReverbLowCutMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setReverbParam('lowcut', Number(data.value));\r\n}\r\n\r\nfunction handleReverbHighCutMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setReverbParam('highcut', Number(data.value));\r\n}\r\n\r\nfunction handleStereoWidthMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setStereoWidth(Number(data.value));\r\n}\r\n\r\nfunction handleVBassMsg(data: Record<string, unknown>): void {\r\n  if (data.value === undefined) return;\r\n  setVirtualBass(Number(data.value));\r\n}\r\n\r\n//  Operator Request Handlers (Host-side) \r\n\r\nfunction handleRequestEQReset(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Only Host\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Effects] Rejected request-eq-reset from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  resetEQ();\r\n  broadcast({ type: MSG.EQ_RESET });\r\n}\r\n\r\nfunction handleRequestReverbReset(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Effects] Rejected request-reverb-reset from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  resetReverb();\r\n  // Broadcast each reverb param reset individually so guests sync\r\n  broadcast({ type: MSG.REVERB, value: 0 });\r\n  broadcast({ type: MSG.REVERB_DECAY, value: 5.0 });\r\n  broadcast({ type: MSG.REVERB_PREDELAY, value: 0.1 });\r\n  broadcast({ type: MSG.REVERB_LOWCUT, value: 0 });\r\n  broadcast({ type: MSG.REVERB_HIGHCUT, value: 0 });\r\n}\r\n\r\n//  Init Effects Protocol Handlers \r\n\r\nexport function initEffectsHandlers(): void {\r\n  const castHandler = (fn: (d: Record<string, unknown>) => void) =>\r\n    fn as unknown as (d: Record<string, unknown>, c: DataConnection) => void;\r\n\r\n  registerHandlers({\r\n    [MSG.VOLUME]: castHandler(handleVolume),\r\n    [MSG.EQ_UPDATE]: castHandler(handleEQUpdateMsg),\r\n    [MSG.PREAMP]: castHandler(handlePreampMsg),\r\n    [MSG.EQ_RESET]: castHandler(handleEQResetMsg as unknown as (d: Record<string, unknown>) => void),\r\n    [MSG.REVERB]: castHandler(handleReverbMsg),\r\n    [MSG.REVERB_TYPE]: castHandler(handleReverbTypeMsg),\r\n    [MSG.REVERB_DECAY]: castHandler(handleReverbDecayMsg),\r\n    [MSG.REVERB_PREDELAY]: castHandler(handleReverbPreDelayMsg),\r\n    [MSG.REVERB_LOWCUT]: castHandler(handleReverbLowCutMsg),\r\n    [MSG.REVERB_HIGHCUT]: castHandler(handleReverbHighCutMsg),\r\n    [MSG.STEREO_WIDTH]: castHandler(handleStereoWidthMsg),\r\n    [MSG.VBASS]: castHandler(handleVBassMsg),\r\n    [MSG.REQUEST_EQ_RESET]: handleRequestEQReset,\r\n    [MSG.REQUEST_REVERB_RESET]: handleRequestReverbReset,\r\n  });\r\n\r\n  log.info('[Effects] Protocol handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Channel Mode Routing\r\n * Extracted from original app.js lines 5127-5320\r\n *\r\n * Manages channel routing (Stereo/Left/Right/Sub) and 7.1 Surround mode.\r\n * Direct imports from engine.ts (same domain).\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { APP_STATE } from '../core/constants.ts';\r\nimport {\r\n  getMasterGain,\r\n  getToneSplit,\r\n  getToneMerge,\r\n  getGainL,\r\n  getGainR,\r\n  getPreamp,\r\n  getGlobalLowPass,\r\n  ensureSurroundNodes,\r\n  getSurroundSplitter,\r\n  getSurroundGain,\r\n  initAudio,\r\n} from './engine.ts';\r\nimport { applySettings } from './effects.ts';\r\nimport type { ToneGainNode, ToneNode } from './engine.ts';\r\n\r\n//  Channel Mode \r\n\r\n/**\r\n * Set the audio channel routing mode.\r\n * @param mode  0=Stereo, -1=Left, 1=Right, 2=Sub\r\n */\r\nexport function setChannelMode(mode: number): void {\r\n  setState('audio.channelMode', mode);\r\n\r\n  const mg = getMasterGain();\r\n  if (!mg) return;\r\n\r\n  const gL = getGainL()!;\r\n  const gR = getGainR()!;\r\n  const merge = getToneMerge()!;\r\n  const lowPass = getGlobalLowPass();\r\n  const subFreq = getState<number>('audio.subFreq');\r\n  const ramp = 0.05;\r\n\r\n  // Reset LowPass to full range\r\n  if (lowPass) (lowPass as { frequency: { value: number } }).frequency.value = 20000;\r\n\r\n  // Reset routing\r\n  try { gL.disconnect(); } catch { /* expected */ }\r\n  try { gR.disconnect(); } catch { /* expected */ }\r\n\r\n  // Reset gains\r\n  gL.gain.value = 1;\r\n  gR.gain.value = 1;\r\n\r\n  if (mode === 0) {\r\n    // Stereo: L0, R1\r\n    gL.connect(merge, 0, 0);\r\n    gR.connect(merge, 0, 1);\r\n    gL.gain.rampTo(1, ramp);\r\n    gR.gain.rampTo(1, ramp);\r\n  } else if (mode === -1) {\r\n    // Left (Dual Mono): Lboth\r\n    gL.connect(merge, 0, 0);\r\n    gL.connect(merge, 0, 1);\r\n    gL.gain.rampTo(1, ramp);\r\n  } else if (mode === 1) {\r\n    // Right (Dual Mono): Rboth\r\n    gR.connect(merge, 0, 0);\r\n    gR.connect(merge, 0, 1);\r\n    gR.gain.rampTo(1, ramp);\r\n  } else if (mode === 2) {\r\n    // Sub: L+R summed to both, with lowpass\r\n    if (lowPass) (lowPass as { frequency: { value: number } }).frequency.value = subFreq;\r\n    gL.connect(merge, 0, 0);\r\n    gL.connect(merge, 0, 1);\r\n    gR.connect(merge, 0, 0);\r\n    gR.connect(merge, 0, 1);\r\n    // Instant gain drop to prevent +6dB spike\r\n    gL.gain.value = 0.5;\r\n    gR.gain.value = 0.5;\r\n  } else {\r\n    // Fallback: stereo\r\n    gL.connect(merge, 0, 0);\r\n    gR.connect(merge, 0, 1);\r\n    gL.gain.rampTo(1, ramp);\r\n    gR.gain.rampTo(1, ramp);\r\n  }\r\n\r\n  applySettings();\r\n  bus.emit('audio:channel-changed', mode);\r\n}\r\n\r\n//  7.1 Surround Mode \r\n\r\n/**\r\n * Toggle 7.1 surround mode on/off.\r\n */\r\nexport function toggleSurroundMode(enabled: boolean): void {\r\n  setState('audio.isSurroundMode', enabled);\r\n\r\n  if (enabled) {\r\n    ensureSurroundNodes();\r\n    const idx = getState<number>('audio.surroundChannelIndex');\r\n    if (idx === -1) setSurroundChannel(2); // Default to Center\r\n    else setSurroundChannel(idx);\r\n  } else {\r\n    // Restore standard channel mode\r\n    setChannelMode(getState<number>('audio.channelMode'));\r\n  }\r\n\r\n  // Instant refresh: restart playback at current position if currently playing\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n    bus.emit('audio:surround-toggled');\r\n  }\r\n}\r\n\r\n/**\r\n * Set 7.1 surround channel index (0-7).\r\n *\r\n * 5.1 Layout: L(0), R(1), C(2), LFE(3), SL(4), SR(5)\r\n * 7.1 Layout: L(0), R(1), C(2), LFE(3), SL(4), SR(5), BL(6), BR(7)\r\n */\r\nexport function setSurroundChannel(idx: number): void {\r\n  setState('audio.surroundChannelIndex', idx);\r\n\r\n  const splitter = getSurroundSplitter();\r\n  const sGain = getSurroundGain();\r\n  if (!splitter || !sGain) return;\r\n\r\n  const isSurround = getState<boolean>('audio.isSurroundMode');\r\n  if (!isSurround) return;\r\n\r\n  const gL = getGainL()!;\r\n  const gR = getGainR()!;\r\n  const merge = getToneMerge()!;\r\n  const lowPass = getGlobalLowPass();\r\n  const subFreq = getState<number>('audio.subFreq');\r\n  const preampNode = getPreamp()!;\r\n\r\n  try {\r\n    sGain.disconnect();\r\n    sGain.connect(preampNode);\r\n    splitter.disconnect();\r\n\r\n    // 5.1/7.1 compatibility routing\r\n    if (idx === 6) {\r\n      // Rear Left: fallback to Side Left for 5.1\r\n      splitter.connect(sGain, 6, 0);\r\n      splitter.connect(sGain, 4, 0);\r\n    } else if (idx === 7) {\r\n      // Rear Right: fallback to Side Right for 5.1\r\n      splitter.connect(sGain, 7, 0);\r\n      splitter.connect(sGain, 5, 0);\r\n    } else if (idx === 3) {\r\n      // LFE (Sub) - Direct\r\n      splitter.connect(sGain, 3, 0);\r\n    } else {\r\n      // Standard 1:1 mapping\r\n      splitter.connect(sGain, idx, 0);\r\n    }\r\n\r\n    // LowPass for LFE channel\r\n    if (lowPass) {\r\n      (lowPass as { frequency: { value: number } }).frequency.value =\r\n        idx === 3 ? subFreq : 20000;\r\n    }\r\n\r\n    // Force output to Dual Mono\r\n    try { gL.disconnect(); } catch { /* */ }\r\n    try { gR.disconnect(); } catch { /* */ }\r\n    gL.connect(merge, 0, 0);\r\n    gR.connect(merge, 0, 1);\r\n    gL.gain.rampTo(1, 0.1);\r\n    gR.gain.rampTo(1, 0.1);\r\n\r\n    const names = [\r\n      'Front Left (L)', 'Front Right (R)', 'Center (Dialog)',\r\n      'LFE (Sub)', 'Side Left', 'Side Right',\r\n      'Rear Left (Back)', 'Rear Right (Back)',\r\n    ];\r\n    log.info(`[Surround] Channel set: ${names[idx]}`);\r\n  } catch (e) {\r\n    log.warn('[Surround] setSurroundChannel error:', e);\r\n  }\r\n\r\n  bus.emit('audio:channel-changed', idx);\r\n}\r\n\r\n/**\r\n * Set channel mode with audio init (called from UI).\r\n */\r\nexport async function setChannel(mode: number): Promise<void> {\r\n  if (!getMasterGain()) await initAudio();\r\n  setChannelMode(mode);\r\n}\r\n\r\n//  Bus Event Handlers \r\n\r\nbus.on('audio:set-channel-mode', ((...args: unknown[]) => {\r\n  const mode = Number(args[0]);\r\n  if (Number.isFinite(mode)) setChannel(mode);\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('audio:toggle-surround', ((...args: unknown[]) => {\r\n  const enabled = !!args[0];\r\n  toggleSurroundMode(enabled);\r\n}) as (...args: unknown[]) => void);\r\n\r\nbus.on('audio:set-surround-channel', ((...args: unknown[]) => {\r\n  const idx = Number(args[0]);\r\n  if (Number.isFinite(idx) && idx >= 0 && idx <= 7) setSurroundChannel(idx);\r\n}) as (...args: unknown[]) => void);\r\n","/**\r\n * MUSIXQUARE 2.0  Sync & Latency Management\r\n * Extracted from original app.js lines 6034-6092, 7617-7647, 8415-8449, 9298-9364\r\n *\r\n * Manages: Heartbeat, ping/pong latency, auto-sync, manual sync (nudge),\r\n * sync response handling, global resync.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, APP_STATE } from '../core/constants.ts';\r\nimport { clearManagedTimer, setManagedTimer } from '../core/timers.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\nimport { registerHandlers } from './protocol.ts';\r\nimport { broadcast, sendToHost } from './peer.ts';\r\n\r\n//  Sync Button Logic \r\n\r\n/**\r\n * Handle the main sync button press.\r\n * Host: broadcasts global resync. Guest: resets offset and requests sync time.\r\n */\r\nexport function handleMainSyncBtn(): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    // Host: Broadcast resync request to all guests\r\n    broadcast({ type: MSG.GLOBAL_RESYNC_REQUEST });\r\n    bus.emit('ui:show-toast', '   ...');\r\n  } else {\r\n    // Guest: Perform auto-sync\r\n    setState('sync.localOffset', 0);\r\n    setState('sync.autoSyncOffset', 0);\r\n    bus.emit('sync:display-update');\r\n    bus.emit('ui:show-toast', '    ...');\r\n    syncReset();\r\n  }\r\n}\r\n\r\n//  Guest: Sync Reset \r\n\r\nfunction syncReset(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn || !hostConn.open) return;\r\n\r\n  bus.emit('sync:display-update');\r\n  const ts = Date.now();\r\n  setState('sync.syncRequestTime', ts);\r\n  hostConn.send({ type: MSG.GET_SYNC_TIME, ts });\r\n}\r\n\r\n//  Delayed Global Resync (Host-only) \r\n\r\n/**\r\n * Request a global resync after a short delay.\r\n * Ensures host-side playback state change has settled across the network.\r\n */\r\nexport function requestGlobalResyncDelayed(delay = 1000): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Host only\r\n\r\n  const resyncTimer = getState<ReturnType<typeof setTimeout> | null>('sync.resyncTimer');\r\n  if (resyncTimer) clearTimeout(resyncTimer);\r\n\r\n  const timer = setTimeout(() => {\r\n    setState('sync.resyncTimer', null);\r\n    const hc = getState<DataConnection | null>('network.hostConn');\r\n    if (!hc) {\r\n      broadcast({ type: MSG.GLOBAL_RESYNC_REQUEST });\r\n      log.debug(`[Sync] Automatic global resync requested (delay: ${delay}ms)`);\r\n    }\r\n  }, delay);\r\n\r\n  setState('sync.resyncTimer', timer);\r\n}\r\n\r\n//  Manual Sync (Nudge) \r\n\r\n/**\r\n * Nudge the sync offset by a given number of milliseconds.\r\n */\r\nexport function nudgeSync(ms: number): void {\r\n  const localOffset = getState<number>('sync.localOffset');\r\n  setState('sync.localOffset', localOffset + (ms / 1000));\r\n  bus.emit('sync:display-update');\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('sync:youtube-nudge', ms);\r\n    return;\r\n  }\r\n\r\n  // Debounce hard sync application\r\n  clearManagedTimer('syncDebounce');\r\n  setManagedTimer('syncDebounce', () => {\r\n    const state = getState<string>('appState');\r\n    if (state !== APP_STATE.IDLE && state !== APP_STATE.PAUSED) {\r\n      bus.emit('sync:nudge-apply', ms);\r\n    }\r\n  }, 450);\r\n}\r\n\r\n/**\r\n * Get the total sync offset (localOffset + autoSyncOffset) in milliseconds.\r\n */\r\nexport function getTotalSyncOffsetMs(): number {\r\n  const localOffset = getState<number>('sync.localOffset');\r\n  const autoSyncOffset = getState<number>('sync.autoSyncOffset');\r\n  return Math.round((localOffset + autoSyncOffset) * 1000);\r\n}\r\n\r\n//  Auto Sync \r\n\r\nexport function handleAutoSync(): void {\r\n  setState('sync.localOffset', 0);\r\n  setState('sync.autoSyncOffset', 0);\r\n  bus.emit('sync:display-update');\r\n  handleMainSyncBtn();\r\n}\r\n\r\n//  Protocol Handlers \r\n\r\nfunction handleHeartbeat(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  // Update liveness timestamp\r\n  try {\r\n    if (conn && conn.peer) {\r\n      const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n      const p = connectedPeers.find(x => x.id === conn.peer);\r\n      if (p) p.lastHeartbeat = Date.now();\r\n    }\r\n  } catch { /* ignore */ }\r\n\r\n  // Reply to the sender\r\n  if (conn && conn.open) {\r\n    conn.send({ type: MSG.HEARTBEAT_ACK });\r\n  }\r\n}\r\n\r\nfunction handleHeartbeatAck(): void {\r\n  setState('sync.lastHeartbeatAckAt', Date.now());\r\n}\r\n\r\nfunction handlePingLatency(data: Record<string, unknown>, conn: DataConnection): void {\r\n  if (typeof data.timestamp !== 'number') return;\r\n  if (conn && conn.open) {\r\n    conn.send({ type: MSG.PONG_LATENCY, timestamp: data.timestamp });\r\n  }\r\n}\r\n\r\nfunction handlePongLatency(data: Record<string, unknown>): void {\r\n  if (typeof data.timestamp !== 'number') return;\r\n  const ms = Date.now() - data.timestamp;\r\n  const latencyHistory = getState<number[]>('sync.latencyHistory');\r\n  latencyHistory.push(ms);\r\n  if (latencyHistory.length > 10) latencyHistory.shift();\r\n  setState('sync.lastLatencyMs', Math.min(...latencyHistory));\r\n  bus.emit('sync:latency-update', ms);\r\n}\r\n\r\nfunction handleSyncResponse(data: Record<string, unknown>): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  // Host-busy detection\r\n  if (data.reqTs && typeof data.reqTs === 'number' && data.reqTs > 0) {\r\n    const elapsed = Date.now() - data.reqTs;\r\n    if (elapsed > 150) {\r\n      const retryCount = (data._syncBusyRetry as number || 0);\r\n      if (retryCount < 3) {\r\n        log.debug(`[AutoSync] Host was busy (${elapsed}ms). Retry ${retryCount + 1}/3 in 300ms...`);\r\n        setTimeout(() => syncReset(), 300);\r\n        return;\r\n      }\r\n      log.warn(`[AutoSync] Host busy retries exhausted (${elapsed}ms). Proceeding with stale data.`);\r\n    }\r\n  }\r\n\r\n  // Latency compensation\r\n  let oneWayLatencySeconds = 0;\r\n  const usePingCompensation = getState<boolean>('sync.usePingCompensation');\r\n  if (usePingCompensation) {\r\n    const lastLatencyMs = getState<number>('sync.lastLatencyMs');\r\n    oneWayLatencySeconds = (lastLatencyMs / 2) / 1000;\r\n  }\r\n\r\n  setState('sync.autoSyncOffset', oneWayLatencySeconds);\r\n  bus.emit('sync:display-update');\r\n\r\n  // Emit sync-response event for player module to handle timing\r\n  bus.emit('sync:response', data.time as number, data.isPlaying as boolean, oneWayLatencySeconds);\r\n}\r\n\r\nfunction handleGlobalResyncRequest(): void {\r\n  bus.emit('ui:show-toast', 'Host :    ...');\r\n  setState('sync.localOffset', 0);\r\n  bus.emit('sync:display-update');\r\n  setTimeout(() => syncReset(), Math.random() * 500);\r\n}\r\n\r\nfunction handleGetSyncTime(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Guest ignores\r\n\r\n  if (conn && conn.open) {\r\n    bus.emit('sync:get-position', (position: number) => {\r\n      const currentState = getState<string>('appState');\r\n      const isPlaying = currentState === APP_STATE.PLAYING_AUDIO ||\r\n                        currentState === APP_STATE.PLAYING_VIDEO ||\r\n                        currentState === APP_STATE.PLAYING_YOUTUBE;\r\n\r\n      conn.send({\r\n        type: MSG.SYNC_RESPONSE,\r\n        time: position,\r\n        isPlaying,\r\n        reqTs: (data.ts as number) || 0,\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n//  Register Handlers \r\n\r\nexport function initSync(): void {\r\n  registerHandlers({\r\n    [MSG.HEARTBEAT]: handleHeartbeat,\r\n    [MSG.HEARTBEAT_ACK]: handleHeartbeatAck as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.PING_LATENCY]: handlePingLatency,\r\n    [MSG.PONG_LATENCY]: handlePongLatency as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.SYNC_RESPONSE]: handleSyncResponse as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.GLOBAL_RESYNC_REQUEST]: handleGlobalResyncRequest as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.GET_SYNC_TIME]: handleGetSyncTime,\r\n  });\r\n\r\n  // Bus event handlers for UI-triggered sync actions\r\n  bus.on('sync:nudge', ((...args: unknown[]) => {\r\n    const val = Number(args[0]);\r\n    if (!Number.isFinite(val)) return;\r\n    // Dynamic import to avoid circular dependency\r\n    import('../player/playback.ts').then(mod => mod.adjustSync(val / 1000));\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('sync:auto-sync', (() => {\r\n    handleMainSyncBtn();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('sync:close-manual', (() => {\r\n    const overlay = document.getElementById('manual-sync-overlay');\r\n    if (overlay) overlay.classList.remove('show');\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('sync:display-update', (() => {\r\n    const localOffset = getState<number>('sync.localOffset') || 0;\r\n    const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n    const total = localOffset + autoSyncOffset;\r\n    const el = document.getElementById('manual-sync-value');\r\n    if (el) el.innerText = `${total >= 0 ? '+' : ''}${(total * 1000).toFixed(0)}ms`;\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Worker tick handlers: Guest sends heartbeat/ping to host\r\n  bus.on('worker:timer-tick', ((...args: unknown[]) => {\r\n    const id = args[0] as string;\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn || !hostConn.open) return;\r\n\r\n    if (id === 'heartbeat') {\r\n      try { hostConn.send({ type: MSG.HEARTBEAT }); } catch { /* noop */ }\r\n    } else if (id === 'ping') {\r\n      try { hostConn.send({ type: MSG.PING_LATENCY, timestamp: Date.now() }); } catch { /* noop */ }\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Sync] Handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  File Transfer (Chunk Receive & Send)\r\n * Extracted from original app.js lines 6887-7615, 9847-10093\r\n *\r\n * Manages: File receive (prepare/start/chunk/end/wait/resume),\r\n * file send (broadcastFile, unicastFile), chunk watchdog,\r\n * reorder buffer, relay forwarding during transfer.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, CHUNK_SIZE, DELAY, TRANSFER_STATE, WATCHDOG_TIMEOUT, APP_STATE } from '../core/constants.ts';\r\nimport { validateSessionId, nextSessionId } from '../core/session.ts';\r\nimport { setManagedTimer, clearManagedTimer } from '../core/timers.ts';\r\nimport { postWorkerCommand, cleanupOPFSInWorker } from './opfs.ts';\r\nimport { registerHandlers } from '../network/protocol.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Module State \r\nconst fileReorderBuffer = new Map<number, Map<number, Uint8Array>>();\r\nlet nextExpectedChunk = 0;\r\nlet lastChunkTime = 0;\r\nlet _pendingEarlyChunks: Array<Record<string, unknown>> = [];\r\n\r\n//  Chunk Watchdog \r\n\r\nfunction startChunkWatchdog(): void {\r\n  clearManagedTimer('chunkWatchdog');\r\n  lastChunkTime = Date.now();\r\n  setState('transfer.lastReceivedCountSnapshot', getState<number>('transfer.receivedCount'));\r\n\r\n  setManagedTimer('chunkWatchdog', () => {\r\n    const timeSinceLast = Date.now() - lastChunkTime;\r\n    const receivedCount = getState<number>('transfer.receivedCount');\r\n    const lastSnapshot = getState<number>('transfer.lastReceivedCountSnapshot');\r\n    const isStuck = (receivedCount === lastSnapshot) && timeSinceLast > WATCHDOG_TIMEOUT;\r\n\r\n    if (isStuck || timeSinceLast > WATCHDOG_TIMEOUT) {\r\n      clearManagedTimer('chunkWatchdog');\r\n      bus.emit('storage:request-recovery');\r\n    }\r\n    setState('transfer.lastReceivedCountSnapshot', receivedCount);\r\n  }, 1000, { interval: true });\r\n}\r\n\r\n//  File Receive Handlers \r\n\r\nfunction handleFilePrepare(data: Record<string, unknown>): void {\r\n  // Always clear stuck preload waiting state on new file-prepare\r\n  if (getState<boolean>('transfer.waitingForPreload')) {\r\n    log.debug('[file-prepare] Clearing stale waitingForPreload flag');\r\n    setState('transfer.waitingForPreload', false);\r\n  }\r\n  clearManagedTimer('preloadWatchdog');\r\n  setState('recovery.retryCount', 0);\r\n\r\n  const incomingSid = data.sessionId as number;\r\n  const prevLocalSid = getState<number>('transfer.localSessionId');\r\n\r\n  // Update session if newer\r\n  if (incomingSid && incomingSid > prevLocalSid) {\r\n    log.debug(`[file-prepare] New session: ${incomingSid} (prev: ${prevLocalSid})`);\r\n    setState('transfer.localSessionId', incomingSid);\r\n  }\r\n\r\n  // Check for preloaded match\r\n  const preloadMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n  const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n  const hasPreloadedByIndex = preloadMeta && data.index !== undefined && data.index === preloadMeta.index;\r\n  const hasPreloadedByName = preloadMeta && data.name && data.name === preloadMeta.name;\r\n\r\n  // Preload INDEX MISMATCH: Don't use stale preload from a different track\r\n  const isMismatch = preloadMeta && data.index !== undefined && data.index !== preloadMeta.index;\r\n  if (isMismatch) {\r\n    log.warn(`[file-prepare] Preload index mismatch! Request: ${data.index}, Preloaded: ${preloadMeta!.index}. Clearing stale preload.`);\r\n    setState('transfer.waitingForPreload', false);\r\n    clearManagedTimer('preloadWatchdog');\r\n    // Clear stale preload state\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n    setState('preload.nextTrackIndex', -1);\r\n    setState('preload.count', 0);\r\n  }\r\n\r\n  if (nextFileBlob && (hasPreloadedByIndex || hasPreloadedByName)) {\r\n    log.debug('[Guest] Using preloaded track instead of re-downloading:', data.name);\r\n    bus.emit('ui:show-toast', '  !');\r\n\r\n    // Stop old media right before loading preloaded track (minimizes audio gap)\r\n    bus.emit('player:stop-all-media');\r\n\r\n    if (data.index !== undefined) {\r\n      setState('playlist.currentTrackIndex', data.index as number);\r\n    }\r\n    bus.emit('ui:update-playlist');\r\n\r\n    setState('transfer.skipIncomingFile', true);\r\n    bus.emit('storage:use-preloaded', data.index as number, data.name as string);\r\n\r\n    bus.emit('ui:show-loader', false);\r\n    return;\r\n  }\r\n\r\n  // Not using preloaded track  stop current media\r\n  bus.emit('player:stop-all-media');\r\n\r\n  // Check if preload is IN PROGRESS for this track\r\n  const preloadInProgressByIndex = preloadMeta && data.index !== undefined && data.index === preloadMeta.index;\r\n  const preloadInProgressByName = preloadMeta && data.name && data.name === preloadMeta.name;\r\n  const isPreloading = getState<boolean>('preload.isPreloading');\r\n\r\n  if (isPreloading && (preloadInProgressByIndex || preloadInProgressByName)) {\r\n    // Resolve Deadlock: If Host started new Main Session (SID increased), prioritize it\r\n    if (incomingSid > prevLocalSid) {\r\n      log.debug('[file-prepare] Preload in progress but Host started Main Session. Prioritizing Main.');\r\n      setState('preload.nextFileBlob', null);\r\n      setState('preload.meta', null);\r\n      setState('preload.nextTrackIndex', -1);\r\n      // Continue to normal flow below\r\n    } else {\r\n      log.debug('[file-prepare] Preload in progress for this track, waiting...');\r\n      bus.emit('ui:show-loader', true, `   : ${data.name}`);\r\n\r\n      setState('recovery.pendingFileName', data.name as string || '');\r\n      setState('recovery.pendingFileIndex', data.index as number);\r\n      setState('transfer.waitingForPreload', true);\r\n      setState('transfer.skipIncomingFile', true);\r\n\r\n      if (data.index !== undefined) {\r\n        setState('playlist.currentTrackIndex', data.index as number);\r\n        bus.emit('ui:update-playlist');\r\n      }\r\n\r\n      // Preload Watchdog: If preloading fails to complete, recover after 10s\r\n      setManagedTimer('preloadWatchdog', () => {\r\n        if (getState<boolean>('transfer.waitingForPreload')) {\r\n          log.warn('[Guest] Preload wait timed out. Force recovering...');\r\n          setState('transfer.waitingForPreload', false);\r\n          bus.emit('ui:show-loader', false);\r\n          setState('transfer.skipIncomingFile', false);\r\n\r\n          const hostConn = getState<DataConnection | null>('network.hostConn');\r\n          if (hostConn && hostConn.open) {\r\n            hostConn.send({ type: MSG.REQUEST_CURRENT_FILE, name: data.name, index: data.index });\r\n          }\r\n        }\r\n      }, 10000);\r\n\r\n      return; // Don't start new download\r\n    }\r\n  }\r\n\r\n  // Normal flow: No preload available, prepare for download\r\n  setState('transfer.skipIncomingFile', false);\r\n  setState('transfer.waitingForPreload', false);\r\n\r\n  // Store pending file info\r\n  setState('recovery.pendingFileName', data.name as string || '');\r\n  setState('recovery.pendingFileIndex', data.index as number);\r\n\r\n  // Check if same file (resume scenario)  BEFORE updating meta\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const receivedCount = getState<number>('transfer.receivedCount');\r\n  const pendingFileIndex = getState<number | undefined>('recovery.pendingFileIndex');\r\n  const isSameFile = (meta.name === data.name) ||\r\n    (pendingFileIndex !== undefined && pendingFileIndex === data.index);\r\n  const isResuming = isSameFile && receivedCount > 0;\r\n\r\n  if (isResuming) {\r\n    log.debug(`[file-prepare] Same file in progress (${receivedCount} chunks), skipping reset`);\r\n    bus.emit('ui:show-loader', true, `  : ${data.name}`);\r\n  } else {\r\n    bus.emit('storage:clear-previous-track', 'file-prepare');\r\n    if (data.index !== undefined) {\r\n      setState('playlist.currentTrackIndex', data.index as number);\r\n      bus.emit('ui:update-playlist');\r\n    }\r\n    // Update meta\r\n    setState('transfer.meta', {\r\n      ...meta,\r\n      name: data.name || '',\r\n      index: data.index ?? getState<number>('playlist.currentTrackIndex'),\r\n      size: data.size || 0,\r\n      mime: data.mime || '',\r\n      sessionId: data.sessionId || getState<number>('transfer.localSessionId'),\r\n    });\r\n\r\n    // Stop YouTube mode for incoming local file\r\n    const currentState = getState<string>('appState');\r\n    if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n      log.debug('[file-prepare] Stopping YouTube mode for incoming local file');\r\n      bus.emit('youtube:stop-mode');\r\n    }\r\n\r\n    bus.emit('ui:show-loader', true, ` : ${data.name}`);\r\n  }\r\n\r\n  // Prepare watchdog with jitter recovery\r\n  setManagedTimer('prepareWatchdog', () => {\r\n    const transferState = getState<string>('transfer.state');\r\n    const rc = getState<number>('transfer.receivedCount');\r\n    if (transferState === TRANSFER_STATE.IDLE || rc === 0) {\r\n      log.warn('[Prepare Watchdog] Timeout waiting for data start!');\r\n      bus.emit('ui:show-toast', '  ... Host  ');\r\n\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      if (hostConn && hostConn.open) {\r\n        const jitter = Math.random() * 1000 + 200;\r\n        setTimeout(() => {\r\n          if (hostConn.open && !getState<Blob | null>('files.currentFileBlob')) {\r\n            bus.emit('storage:request-recovery');\r\n          }\r\n        }, jitter);\r\n      }\r\n    }\r\n  }, 15000);\r\n}\r\n\r\nfunction handleFileStart(data: Record<string, unknown>): void {\r\n  const incomingSid = data.sessionId as number;\r\n  const localSid = getState<number>('transfer.localSessionId');\r\n\r\n  if (!incomingSid || incomingSid < localSid) {\r\n    log.warn(`[file-start] Stale session ignored. Current: ${localSid}, Received: ${incomingSid}`);\r\n    return;\r\n  }\r\n\r\n  const isNewSession = incomingSid > localSid;\r\n  if (isNewSession) {\r\n    setState('transfer.localSessionId', incomingSid);\r\n    postWorkerCommand({ command: 'OPFS_RESET', isPreload: false });\r\n    bus.emit('storage:clear-previous-track', 'new-session-start');\r\n  }\r\n\r\n  // Skip if using preloaded file\r\n  if (getState<boolean>('transfer.skipIncomingFile')) {\r\n    clearManagedTimer('prepareWatchdog');\r\n    clearManagedTimer('chunkWatchdog');\r\n\r\n    // Relay header downstream\r\n    const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n\r\n    return;\r\n  }\r\n\r\n  clearManagedTimer('prepareWatchdog');\r\n  clearManagedTimer('chunkWatchdog');\r\n\r\n  // Check if same file (recovery)\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const receivedCount = getState<number>('transfer.receivedCount');\r\n  const isRecoverySameFile = meta.name === data.name && meta.total === (data.total as number);\r\n\r\n  const opfsFilename = getState<{ name: string | null }>('files.currentFileOpfs');\r\n  if (opfsFilename.name && opfsFilename.name !== data.name) {\r\n    cleanupOPFSInWorker(opfsFilename.name, false);\r\n  }\r\n  opfsFilename.name = data.name as string;\r\n\r\n  if (isRecoverySameFile && receivedCount > 0) {\r\n    // Recovery mode: keep existing chunks\r\n    log.debug(`[file-start] Same file detected! Keeping ${receivedCount}/${data.total} chunks`);\r\n\r\n    postWorkerCommand({\r\n      command: 'OPFS_START',\r\n      filename: data.name as string,\r\n      isPreload: false,\r\n      sessionId: validateSessionId(incomingSid),\r\n      size: CHUNK_SIZE,\r\n      keepExisting: true,\r\n    });\r\n\r\n    setState('transfer.meta', data);\r\n    setState('transfer.state', TRANSFER_STATE.RECEIVING);\r\n  } else {\r\n    // New file: initialize fresh\r\n    postWorkerCommand({\r\n      command: 'OPFS_START',\r\n      filename: data.name as string,\r\n      isPreload: false,\r\n      sessionId: validateSessionId(incomingSid),\r\n      size: CHUNK_SIZE,\r\n    });\r\n\r\n    setState('transfer.receivedCount', 0);\r\n    setState('transfer.meta', data);\r\n    setState('transfer.state', TRANSFER_STATE.RECEIVING);\r\n\r\n    fileReorderBuffer.clear();\r\n    nextExpectedChunk = 0;\r\n  }\r\n\r\n  startChunkWatchdog();\r\n\r\n  // Replay any early chunks that arrived before FILE_START\r\n  if (_pendingEarlyChunks.length > 0) {\r\n    const earlyChunks = _pendingEarlyChunks.splice(0);\r\n    log.debug(`[file-start] Replaying ${earlyChunks.length} early chunks`);\r\n    for (const pending of earlyChunks) {\r\n      handleFileChunk(pending);\r\n    }\r\n  }\r\n\r\n  // Relay header downstream\r\n  const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n\r\n  bus.emit('ui:show-loader', true, ` ... 0%`);\r\n}\r\n\r\nfunction handleFileResume(data: Record<string, unknown>): void {\r\n  const incomingSid = data.sessionId as number;\r\n  const localSid = getState<number>('transfer.localSessionId');\r\n\r\n  if (!incomingSid || incomingSid < localSid) return;\r\n  if (incomingSid > localSid) setState('transfer.localSessionId', incomingSid);\r\n\r\n  clearManagedTimer('prepareWatchdog');\r\n  setState('transfer.skipIncomingFile', false);\r\n\r\n  postWorkerCommand({\r\n    command: 'OPFS_START',\r\n    filename: data.name as string,\r\n    isPreload: false,\r\n    sessionId: validateSessionId(incomingSid),\r\n    size: CHUNK_SIZE,\r\n  });\r\n\r\n  const opfsFilename = getState<{ name: string | null }>('files.currentFileOpfs');\r\n  opfsFilename.name = data.name as string;\r\n\r\n  nextExpectedChunk = (data.startChunk as number) || 0;\r\n  setState('transfer.meta', data);\r\n  setState('transfer.state', TRANSFER_STATE.RECEIVING);\r\n\r\n  startChunkWatchdog();\r\n\r\n  const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n}\r\n\r\nfunction handleFileChunk(data: Record<string, unknown>): void {\r\n  const incomingSid = data.sessionId as number;\r\n  if (!incomingSid) return;\r\n\r\n  // Skip if using preloaded file\r\n  if (getState<boolean>('transfer.skipIncomingFile')) {\r\n    const localSid = getState<number>('transfer.localSessionId');\r\n    if (incomingSid > localSid) setState('transfer.localSessionId', incomingSid);\r\n    return;\r\n  }\r\n\r\n  // Buffer early chunks that arrive before FILE_START sets up the session\r\n  const transferState = getState<string>('transfer.state');\r\n  if (transferState === TRANSFER_STATE.IDLE && !fileReorderBuffer.has(incomingSid)) {\r\n    _pendingEarlyChunks.push(data);\r\n    if (_pendingEarlyChunks.length > 200) _pendingEarlyChunks.shift(); // overflow protection\r\n    return;\r\n  }\r\n\r\n  const localSid = getState<number>('transfer.localSessionId');\r\n\r\n  // Reset worker on new session detection\r\n  if (incomingSid > localSid) {\r\n    setState('transfer.localSessionId', incomingSid);\r\n    postWorkerCommand({ command: 'OPFS_RESET', isPreload: false });\r\n    bus.emit('storage:clear-previous-track', 'session-change');\r\n    fileReorderBuffer.clear();\r\n    nextExpectedChunk = 0;\r\n    setState('transfer.receivedCount', 0);\r\n  }\r\n\r\n  if (incomingSid < localSid) return;\r\n\r\n  if (!fileReorderBuffer.has(incomingSid)) {\r\n    fileReorderBuffer.set(incomingSid, new Map());\r\n    nextExpectedChunk = 0;\r\n  }\r\n\r\n  const sessionBuffer = fileReorderBuffer.get(incomingSid)!;\r\n  const chunkData = new Uint8Array(data.chunk as ArrayBuffer);\r\n  sessionBuffer.set(data.index as number, chunkData);\r\n\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const opfsFilename = getState<{ name: string | null }>('files.currentFileOpfs');\r\n  let receivedCount = getState<number>('transfer.receivedCount');\r\n\r\n  // Meta-recovery: if we missed FILE_START, extract meta from chunk data\r\n  if (!meta || meta.total === undefined || meta.total === 0) {\r\n    if (data.total !== undefined && Number(data.total) > 0) {\r\n      const recoveredMeta = {\r\n        name: data.name || meta?.name || '',\r\n        total: data.total,\r\n        sessionId: incomingSid,\r\n        size: data.size || 0,\r\n        mime: data.mime || '',\r\n      };\r\n      setState('transfer.meta', recoveredMeta);\r\n      setState('transfer.state', TRANSFER_STATE.RECEIVING);\r\n\r\n      const fname = (recoveredMeta.name as string) || '';\r\n      if (fname) {\r\n        opfsFilename.name = fname;\r\n        postWorkerCommand({\r\n          command: 'OPFS_START',\r\n          filename: fname,\r\n          isPreload: false,\r\n          sessionId: validateSessionId(incomingSid),\r\n          size: CHUNK_SIZE,\r\n        });\r\n      }\r\n      log.debug(`[FileChunk] Recovered meta from chunk: ${fname} (${recoveredMeta.total} chunks)`);\r\n    } else if (!meta || meta.total === undefined) {\r\n      // Orphan chunk with no meta  can't process\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Process all contiguous chunks in order\r\n  while (sessionBuffer.has(nextExpectedChunk)) {\r\n    const chunk = sessionBuffer.get(nextExpectedChunk)!;\r\n\r\n    // Prepare relay copy before transfer to worker\r\n    const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    let relayCopy: Uint8Array | null = null;\r\n    if (downstreamPeers.length > 0) {\r\n      relayCopy = new Uint8Array(chunk);\r\n    }\r\n\r\n    postWorkerCommand({\r\n      command: 'OPFS_WRITE',\r\n      chunk: chunk instanceof ArrayBuffer ? chunk : (chunk as Uint8Array).buffer as ArrayBuffer,\r\n      index: nextExpectedChunk,\r\n      isPreload: false,\r\n      filename: opfsFilename.name || '',\r\n      sessionId: validateSessionId(incomingSid),\r\n    });\r\n\r\n    // Relay to downstream\r\n    if (relayCopy && downstreamPeers.length > 0) {\r\n      const chunkMsg = {\r\n        type: MSG.FILE_CHUNK,\r\n        chunk: relayCopy,\r\n        index: nextExpectedChunk,\r\n        sessionId: incomingSid,\r\n      };\r\n      downstreamPeers.forEach(p => {\r\n        if (p.open) try { p.send(chunkMsg); } catch { /* noop */ }\r\n      });\r\n    }\r\n\r\n    sessionBuffer.delete(nextExpectedChunk);\r\n    nextExpectedChunk++;\r\n    receivedCount++;\r\n  }\r\n\r\n  setState('transfer.receivedCount', receivedCount);\r\n  lastChunkTime = Date.now();\r\n\r\n  // Progress update\r\n  const total = (meta.total as number) || 0;\r\n  if (total > 0) {\r\n    const percent = Math.min(100, Math.floor((receivedCount / total) * 100));\r\n    bus.emit('storage:transfer-progress', percent, total);\r\n  }\r\n\r\n  // File complete check\r\n  if (total > 0 && receivedCount >= total && getState<string>('transfer.state') !== TRANSFER_STATE.PROCESSING) {\r\n    setState('transfer.state', TRANSFER_STATE.PROCESSING);\r\n    setState('recovery.retryCount', 0);\r\n\r\n    // Notify Host that we have this file\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const processingIndex = meta.index as number;\r\n    if (hostConn && hostConn.open && processingIndex !== undefined) {\r\n      hostConn.send({ type: MSG.PRELOAD_ACK, index: processingIndex });\r\n    }\r\n\r\n    // Finalize in OPFS\r\n    postWorkerCommand({\r\n      command: 'OPFS_END',\r\n      filename: (meta.name as string) || '',\r\n      isPreload: false,\r\n      sessionId: validateSessionId(incomingSid),\r\n      totalSize: meta.size as number,\r\n    });\r\n\r\n    clearManagedTimer('chunkWatchdog');\r\n  }\r\n}\r\n\r\nfunction handleFileEnd(data: Record<string, unknown>): void {\r\n  if (getState<boolean>('transfer.skipIncomingFile')) return;\r\n\r\n  // Relay to downstream\r\n  const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n\r\n  log.debug(`[file-end] Received end signal for: ${data.name}`);\r\n}\r\n\r\nfunction handleFileWait(): void {\r\n  log.debug('[Guest] Relay has no data yet, waiting for forwarded data...');\r\n  bus.emit('ui:show-toast', '  ...  ');\r\n\r\n  clearManagedTimer('relayWaitTimeout');\r\n  setManagedTimer('relayWaitTimeout', () => {\r\n    const receivedCount = getState<number>('transfer.receivedCount');\r\n    if (receivedCount === 0) {\r\n      log.debug('[Guest] Relay wait timeout - falling back to Host');\r\n      bus.emit('ui:show-toast', '  . Host  ...');\r\n\r\n      // Disconnect from relay upstream\r\n      const upstreamDataConn = getState<DataConnection | null>('relay.upstreamDataConn');\r\n      if (upstreamDataConn) {\r\n        upstreamDataConn.close();\r\n        setState('relay.upstreamDataConn', null);\r\n      }\r\n\r\n      // Request file from Host\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      if (hostConn && hostConn.open) {\r\n        const pendingFileName = getState<string>('recovery.pendingFileName') || '';\r\n        const pendingFileIndex = getState<number | undefined>('recovery.pendingFileIndex');\r\n        const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n        const recoveryIndex = pendingFileIndex !== undefined ? pendingFileIndex : currentTrackIndex;\r\n        const playlist = getState<unknown[]>('playlist.items') || [];\r\n\r\n        // Validation: Don't send recovery with invalid index\r\n        if (recoveryIndex < 0 || recoveryIndex >= playlist.length) {\r\n          log.warn('[file-wait timeout] Invalid index, skipping recovery:', recoveryIndex);\r\n          bus.emit('ui:show-loader', false);\r\n          return;\r\n        }\r\n\r\n        // Check if preload is in progress for this track\r\n        const preloadMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n        if (preloadMeta && preloadMeta.index === recoveryIndex) {\r\n          log.debug('[file-wait timeout] Preload in progress for this track, waiting...');\r\n          bus.emit('ui:show-toast', '   ...');\r\n          return;\r\n        }\r\n\r\n        log.debug(`[file-wait timeout] Requesting from Host: ${pendingFileName} index: ${recoveryIndex}`);\r\n        hostConn.send({\r\n          type: MSG.REQUEST_DATA_RECOVERY,\r\n          nextChunk: 0,\r\n          fileName: pendingFileName,\r\n          index: recoveryIndex,\r\n        });\r\n      }\r\n    }\r\n  }, 10000);\r\n}\r\n\r\n//  File Send (Host) \r\n\r\n/**\r\n * Broadcast a file to all connected peers (host-only).\r\n */\r\nexport async function broadcastFile(file: File, explicitSessionId: number | null = null): Promise<void> {\r\n  let sessionId: number;\r\n  const currentTransferSessionId = getState<number>('transfer.currentSessionId');\r\n\r\n  if (explicitSessionId !== null) {\r\n    sessionId = explicitSessionId;\r\n    if (sessionId > currentTransferSessionId) setState('transfer.currentSessionId', sessionId);\r\n  } else {\r\n    sessionId = currentTransferSessionId + 1;\r\n    setState('transfer.currentSessionId', sessionId);\r\n  }\r\n\r\n  const activeBroadcast = getState<number | null>('transfer.activeBroadcastSession');\r\n  if (activeBroadcast === sessionId) return;\r\n  setState('transfer.activeBroadcastSession', sessionId);\r\n\r\n  const CHUNK = CHUNK_SIZE;\r\n  const total = Math.ceil(file.size / CHUNK);\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const header = {\r\n    type: MSG.FILE_START,\r\n    name: file.name,\r\n    mime: file.type,\r\n    total,\r\n    size: file.size,\r\n    index: currentTrackIndex,\r\n    sessionId,\r\n  };\r\n\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const eligiblePeers = connectedPeers.filter(p =>\r\n    p.status === 'connected' && (p.conn as DataConnection)?.open && p.isDataTarget !== false\r\n  );\r\n\r\n  if (eligiblePeers.length === 0) return;\r\n\r\n  // Send header\r\n  eligiblePeers.forEach(p => {\r\n    try { (p.conn as DataConnection).send(header); } catch { /* noop */ }\r\n  });\r\n\r\n  // Send chunks\r\n  for (let i = 0; i < total; i++) {\r\n    if (getState<number | null>('transfer.activeBroadcastSession') !== sessionId) return;\r\n\r\n    const start = i * CHUNK;\r\n    const end = Math.min(start + CHUNK, file.size);\r\n    const chunkBuf = await file.slice(start, end).arrayBuffer();\r\n    const chunk = new Uint8Array(chunkBuf);\r\n    const chunkMsg = { type: MSG.FILE_CHUNK, chunk, index: i, sessionId, total, name: file.name };\r\n\r\n    for (const p of eligiblePeers) {\r\n      const conn = p.conn as DataConnection;\r\n      if (conn?.open) {\r\n        // Backpressure check\r\n        while (conn.dataChannel && conn.dataChannel.bufferedAmount > 512 * 1024) {\r\n          await new Promise(r => setTimeout(r, DELAY.BACKPRESSURE));\r\n          if (!conn.open) break;\r\n        }\r\n        try { conn.send(chunkMsg); } catch { /* noop */ }\r\n      }\r\n    }\r\n\r\n    if (i % 50 === 0) await new Promise(r => setTimeout(r, DELAY.TICK));\r\n  }\r\n\r\n  // Send end message\r\n  const endMsg = { type: MSG.FILE_END, name: file.name, mime: file.type, sessionId };\r\n  eligiblePeers.forEach(p => {\r\n    const conn = p.conn as DataConnection;\r\n    if (conn?.open) try { conn.send(endMsg); } catch { /* noop */ }\r\n  });\r\n\r\n  setState('transfer.activeBroadcastSession', null);\r\n}\r\n\r\n/**\r\n * Unicast a file to a single connection (for late-join/recovery).\r\n */\r\nexport async function unicastFile(\r\n  conn: DataConnection,\r\n  file: File | Blob,\r\n  startChunkIndex = 0,\r\n  sessionId: number | null = null\r\n): Promise<void> {\r\n  if (!conn || !conn.open) {\r\n    log.error('[Unicast] Connection is not open');\r\n    return;\r\n  }\r\n\r\n  const effectiveSessionId = sessionId ?? getState<number>('transfer.currentSessionId');\r\n  const CHUNK = CHUNK_SIZE;\r\n  const total = Math.ceil(file.size / CHUNK);\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n  const isResume = startChunkIndex > 0;\r\n  const msgType = isResume ? MSG.FILE_RESUME : MSG.FILE_START;\r\n  const fileName = 'name' in file ? file.name : 'Track';\r\n\r\n  try {\r\n    conn.send({\r\n      type: msgType,\r\n      name: fileName,\r\n      mime: file.type,\r\n      total,\r\n      size: file.size,\r\n      startChunk: startChunkIndex,\r\n      sessionId: effectiveSessionId,\r\n      index: currentTrackIndex,\r\n    });\r\n  } catch (e) {\r\n    log.error(`[Unicast] Failed to send ${msgType}:`, e);\r\n    return;\r\n  }\r\n\r\n  await new Promise(r => setTimeout(r, 100));\r\n\r\n  try {\r\n    for (let i = startChunkIndex; i < total; i++) {\r\n      if (getState<number>('transfer.currentSessionId') !== effectiveSessionId) return;\r\n      if (!conn.open) return;\r\n\r\n      // Backpressure\r\n      const startWait = Date.now();\r\n      while (conn.dataChannel && conn.dataChannel.bufferedAmount > 64 * 1024) {\r\n        if (Date.now() - startWait > 30000) break;\r\n        await new Promise(r => setTimeout(r, DELAY.BACKPRESSURE));\r\n      }\r\n\r\n      const start = i * CHUNK;\r\n      const end = Math.min(start + CHUNK, file.size);\r\n      const chunkBuf = await file.slice(start, end).arrayBuffer();\r\n      const chunk = new Uint8Array(chunkBuf);\r\n\r\n      conn.send({\r\n        type: MSG.FILE_CHUNK,\r\n        chunk,\r\n        index: i,\r\n        sessionId: effectiveSessionId,\r\n        total,\r\n        name: fileName,\r\n      });\r\n\r\n      if (i % 50 === 0) await new Promise(r => setTimeout(r, DELAY.TICK));\r\n    }\r\n\r\n    if (conn.open) {\r\n      conn.send({ type: MSG.FILE_END, name: fileName, mime: file.type, sessionId: effectiveSessionId });\r\n      log.debug('[Unicast] Transfer complete:', fileName);\r\n    }\r\n  } catch (e) {\r\n    log.error('[Unicast] Transfer error:', e);\r\n  }\r\n}\r\n\r\n//  Register Handlers \r\n\r\nexport function initTransfer(): void {\r\n  registerHandlers({\r\n    [MSG.FILE_PREPARE]: handleFilePrepare as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.FILE_START]: handleFileStart as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.FILE_RESUME]: handleFileResume as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.FILE_CHUNK]: handleFileChunk as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.FILE_END]: handleFileEnd as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.FILE_WAIT]: handleFileWait as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n  });\r\n\r\n  log.info('[Transfer] Handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Relay Chain Management\r\n * Extracted from original app.js lines 9225-9555\r\n *\r\n * Manages: Upstream relay connection, downstream data peers,\r\n * relay file serving, preload relay, OPFS catch-up streaming.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, CHUNK_SIZE, DELAY } from '../core/constants.ts';\r\nimport { validateSessionId } from '../core/session.ts';\r\nimport type { DataConnection, PeerInstance } from '../types/index.ts';\r\nimport { registerHandlers } from './protocol.ts';\r\nimport { getPeer } from './peer.ts';\r\nimport { unicastFile } from '../storage/transfer.ts';\r\nimport { ensureNamedFile, postWorkerCommand } from '../storage/opfs.ts';\r\n\r\n//  Module State \r\nlet _relayConnTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n//  OPFS Catch-up Pump \r\n\r\ninterface OpfsCatchupPump {\r\n  peerId: string;\r\n  conn: DataConnection;\r\n  filename: string;\r\n  sessionId: number;\r\n  isPreload: boolean;\r\n  nextIndex: number;\r\n  endIndex: number;\r\n  awaiting: boolean;\r\n  awaitingIndex: number | null;\r\n  lastActivity: number;\r\n  active: boolean;\r\n  _timer: ReturnType<typeof setTimeout> | null;\r\n}\r\n\r\nconst opfsCatchupPumps = new Map<string, OpfsCatchupPump>();\r\n\r\nfunction stopOpfsCatchupStream(peerId: string, reason = ''): void {\r\n  const pump = opfsCatchupPumps.get(peerId);\r\n  if (!pump) return;\r\n  pump.active = false;\r\n  if (pump._timer) {\r\n    clearTimeout(pump._timer);\r\n    pump._timer = null;\r\n  }\r\n  opfsCatchupPumps.delete(peerId);\r\n  if (reason) log.debug(`[OPFS Catchup] Stop ...${peerId.slice(-4)}: ${reason}`);\r\n}\r\n\r\nfunction startOpfsCatchupStream(\r\n  conn: DataConnection,\r\n  opts: {\r\n    filename: string;\r\n    sessionId: number;\r\n    startIndex?: number;\r\n    endIndexExclusive?: number;\r\n    isPreload?: boolean;\r\n  },\r\n): void {\r\n  if (!conn || !conn.peer) return;\r\n  const peerId = conn.peer;\r\n\r\n  stopOpfsCatchupStream(peerId, 'restart');\r\n\r\n  const sid = validateSessionId(opts.sessionId);\r\n  if (!sid) {\r\n    log.warn(`[OPFS Catchup] Invalid sessionId, abort for peer ...${peerId.slice(-4)}`);\r\n    return;\r\n  }\r\n\r\n  const pump: OpfsCatchupPump = {\r\n    peerId,\r\n    conn,\r\n    filename: opts.filename,\r\n    sessionId: sid,\r\n    isPreload: !!opts.isPreload,\r\n    nextIndex: Math.max(0, (opts.startIndex || 0) | 0),\r\n    endIndex: Math.max(0, (opts.endIndexExclusive || 0) | 0),\r\n    awaiting: false,\r\n    awaitingIndex: null,\r\n    lastActivity: Date.now(),\r\n    active: true,\r\n    _timer: null,\r\n  };\r\n\r\n  opfsCatchupPumps.set(peerId, pump);\r\n  scheduleOpfsCatchupPump(pump, 0);\r\n}\r\n\r\nfunction scheduleOpfsCatchupPump(pump: OpfsCatchupPump, delayMs: number): void {\r\n  if (!pump || !pump.active) return;\r\n  if (pump._timer) clearTimeout(pump._timer);\r\n  pump._timer = setTimeout(() => runOpfsCatchupPump(pump), Math.max(0, delayMs | 0));\r\n}\r\n\r\nfunction runOpfsCatchupPump(pump: OpfsCatchupPump): void {\r\n  if (!pump || !pump.active) return;\r\n\r\n  const conn = pump.conn;\r\n  if (!conn || !conn.open) {\r\n    stopOpfsCatchupStream(pump.peerId, 'peer closed');\r\n    return;\r\n  }\r\n\r\n  // Session guard: stop if app advanced to newer session\r\n  const localSid = getState<number>('transfer.localSessionId');\r\n  if (pump.sessionId && pump.sessionId < localSid) {\r\n    stopOpfsCatchupStream(pump.peerId, 'session advanced');\r\n    return;\r\n  }\r\n\r\n  if (!pump.filename || pump.nextIndex >= pump.endIndex) {\r\n    stopOpfsCatchupStream(pump.peerId, 'complete');\r\n    return;\r\n  }\r\n\r\n  // Wait for previous OPFS_READ response (sequential pump)\r\n  if (pump.awaiting) {\r\n    const stuckMs = Date.now() - pump.lastActivity;\r\n    if (stuckMs > 6000 && pump.awaitingIndex !== null) {\r\n      log.warn(`[OPFS Catchup] Stuck ${stuckMs}ms, retry idx=${pump.awaitingIndex} for ...${pump.peerId.slice(-4)}`);\r\n      pump.awaiting = false;\r\n      pump.nextIndex = pump.awaitingIndex; // rewind to retry\r\n      pump.awaitingIndex = null;\r\n    }\r\n    scheduleOpfsCatchupPump(pump, DELAY.BACKPRESSURE);\r\n    return;\r\n  }\r\n\r\n  // Back-pressure: don't read faster than RTC can send\r\n  const bufAmt = conn.dataChannel ? conn.dataChannel.bufferedAmount : 0;\r\n  const peerQueueLen = conn._relayQueue ? conn._relayQueue.length : 0;\r\n\r\n  if (peerQueueLen > 120 || bufAmt > 256 * 1024) {\r\n    scheduleOpfsCatchupPump(pump, DELAY.BACKPRESSURE);\r\n    return;\r\n  }\r\n\r\n  const idx = pump.nextIndex;\r\n  pump.nextIndex++;\r\n  pump.awaiting = true;\r\n  pump.awaitingIndex = idx;\r\n  pump.lastActivity = Date.now();\r\n\r\n  postWorkerCommand({\r\n    command: 'OPFS_READ',\r\n    filename: pump.filename,\r\n    index: idx,\r\n    isPreload: pump.isPreload,\r\n    sessionId: pump.sessionId,\r\n    requestId: `${pump.peerId}|catchup`,\r\n  });\r\n}\r\n\r\nfunction onOpfsCatchupReadComplete(peerId: string, sessionId: number, requestTag: string): void {\r\n  const pump = opfsCatchupPumps.get(peerId);\r\n  if (!pump || !pump.active) return;\r\n\r\n  // Only advance pump when this response is from catchup-tag\r\n  if (requestTag !== 'catchup') return;\r\n\r\n  // Session guard\r\n  if (sessionId && pump.sessionId && sessionId !== pump.sessionId) {\r\n    stopOpfsCatchupStream(peerId, 'session mismatch');\r\n    return;\r\n  }\r\n\r\n  pump.awaiting = false;\r\n  pump.awaitingIndex = null;\r\n  pump.lastActivity = Date.now();\r\n  scheduleOpfsCatchupPump(pump, 0);\r\n}\r\n\r\n//  Upstream Relay Connection \r\n\r\n/**\r\n * Connect to a relay peer (upstream data source).\r\n * This is called when the host assigns a data relay target.\r\n */\r\nexport function connectToRelay(targetId: string): void {\r\n  const peer = getPeer();\r\n  if (!peer) return;\r\n\r\n  // Close existing relay connection\r\n  const upstreamDataConn = getState<DataConnection | null>('relay.upstreamDataConn');\r\n  if (upstreamDataConn) {\r\n    log.debug(`[Relay] Closing existing relay connection for new assignment`);\r\n    upstreamDataConn.close();\r\n    setState('relay.upstreamDataConn', null);\r\n  }\r\n\r\n  // Cancel previous relay connection timeout\r\n  if (_relayConnTimer) { clearTimeout(_relayConnTimer); _relayConnTimer = null; }\r\n\r\n  const myId = getState<string | null>('network.myId');\r\n  const conn = peer.connect(targetId, {\r\n    metadata: { type: MSG.DATA_RELAY, label: myId },\r\n  });\r\n\r\n  const FAIL_TIMEOUT = 10000;\r\n  _relayConnTimer = setTimeout(() => {\r\n    if (!conn.open) {\r\n      log.warn('[Relay] Connect Timeout');\r\n      bus.emit('ui:show-toast', 'Relay  ');\r\n      conn.close();\r\n      setState('relay.upstreamDataConn', null);\r\n\r\n      // Fallback: request recovery from host\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      if (hostConn && hostConn.open) {\r\n        const meta = getState<Record<string, unknown>>('transfer.meta');\r\n        const receivedCount = getState<number>('transfer.receivedCount');\r\n        const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n        hostConn.send({\r\n          type: MSG.REQUEST_DATA_RECOVERY,\r\n          nextChunk: receivedCount || 0,\r\n          fileName: meta?.name || '',\r\n          index: currentTrackIndex,\r\n        });\r\n      }\r\n    }\r\n  }, FAIL_TIMEOUT);\r\n\r\n  conn.on('open', () => {\r\n    if (_relayConnTimer) { clearTimeout(_relayConnTimer); _relayConnTimer = null; }\r\n    setState('relay.upstreamDataConn', conn);\r\n    log.info('[Relay] Connected to upstream relay');\r\n    bus.emit('ui:show-toast', 'Relay ');\r\n\r\n    conn.on('data', (data: unknown) => {\r\n      bus.emit('network:data', data, conn);\r\n    });\r\n\r\n    // Request current file from relay\r\n    conn.send({ type: MSG.REQUEST_CURRENT_FILE });\r\n  });\r\n\r\n  conn.on('error', (err: unknown) => {\r\n    log.warn('[Relay] Connection error:', err);\r\n    if (_relayConnTimer) { clearTimeout(_relayConnTimer); _relayConnTimer = null; }\r\n  });\r\n\r\n  conn.on('close', () => {\r\n    setState('relay.upstreamDataConn', null);\r\n    bus.emit('ui:show-toast', 'Relay  ');\r\n\r\n    const meta = getState<Record<string, unknown>>('transfer.meta');\r\n    const receivedCount = getState<number>('transfer.receivedCount');\r\n    const total = (meta?.total as number) || 0;\r\n\r\n    if (receivedCount < total) {\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      if (hostConn && hostConn.open) {\r\n        bus.emit('storage:request-recovery');\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n//  Downstream Relay (Serving) \r\n\r\n/**\r\n * Handle an incoming relay connection (downstream peer connecting to us).\r\n */\r\nexport function handleRelayConnection(conn: DataConnection): void {\r\n  conn.on('open', () => {\r\n    log.debug('[Relay] Accepted downstream connection from', conn.peer);\r\n\r\n    const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    if (!downstreamDataPeers.find(p => p.peer === conn.peer)) {\r\n      downstreamDataPeers.push(conn);\r\n      setState('relay.downstreamDataPeers', downstreamDataPeers);\r\n    }\r\n  });\r\n\r\n  conn.on('data', (data: unknown) => {\r\n    const msg = data as Record<string, unknown>;\r\n\r\n    if (msg.type === MSG.REQUEST_CURRENT_FILE) {\r\n      bus.emit('relay:serve-current-file', conn, msg);\r\n    } else if (msg.type === MSG.REQUEST_DATA_RECOVERY) {\r\n      bus.emit('relay:serve-recovery', conn, msg);\r\n    }\r\n  });\r\n\r\n  conn.on('close', () => {\r\n    stopOpfsCatchupStream(conn.peer, 'downstream disconnected');\r\n    const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    setState(\r\n      'relay.downstreamDataPeers',\r\n      downstreamDataPeers.filter(p => p.peer !== conn.peer)\r\n    );\r\n  });\r\n}\r\n\r\n//  Preload Relay \r\n\r\n/**\r\n * Relay a preloaded file from local cache to downstream peers.\r\n */\r\nexport async function relayPreloadFromCache(\r\n  blob: Blob,\r\n  index: number,\r\n  sessionId: number,\r\n  fileName: string\r\n): Promise<void> {\r\n  if (!blob) {\r\n    log.warn('[Relay] Cannot relay null blob for index:', index);\r\n    return;\r\n  }\r\n\r\n  const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  if (downstreamDataPeers.length === 0) return;\r\n\r\n  const CHUNK = CHUNK_SIZE;\r\n  const total = Math.ceil(blob.size / CHUNK);\r\n\r\n  log.debug(`[Preload Relay] Relaying ${fileName} (${total} chunks) to ${downstreamDataPeers.length} peers`);\r\n\r\n  // Send PRELOAD_START\r\n  const startMsg = {\r\n    type: MSG.PRELOAD_START,\r\n    name: fileName,\r\n    index,\r\n    sessionId,\r\n    total,\r\n    size: blob.size,\r\n  };\r\n  downstreamDataPeers.forEach(p => {\r\n    if (p.open) p.send(startMsg);\r\n  });\r\n\r\n  // Send chunks\r\n  for (let i = 0; i < total; i++) {\r\n    const activeDownstream = downstreamDataPeers.filter(p => p.open);\r\n    if (activeDownstream.length === 0) break;\r\n\r\n    const start = i * CHUNK;\r\n    const end = Math.min(start + CHUNK, blob.size);\r\n    const chunk = new Uint8Array(await blob.slice(start, end).arrayBuffer());\r\n\r\n    const chunkMsg = { type: MSG.PRELOAD_CHUNK, chunk, index: i, sessionId };\r\n    activeDownstream.forEach(p => p.send(chunkMsg));\r\n\r\n    // Backpressure: yield every 10 chunks\r\n    if (i % 10 === 0) await new Promise(r => setTimeout(r, 40));\r\n  }\r\n\r\n  // Send PRELOAD_END\r\n  const endMsg = { type: MSG.PRELOAD_END, name: fileName, index, sessionId };\r\n  downstreamDataPeers.forEach(p => {\r\n    if (p.open) p.send(endMsg);\r\n  });\r\n\r\n  log.debug(`[Preload Relay] Finished relaying index ${index}`);\r\n}\r\n\r\n//  Protocol Handlers \r\n\r\nfunction handleAssignDataSource(data: Record<string, unknown>): void {\r\n  const targetId = data.targetId as string | null;\r\n  const myId = getState<string | null>('network.myId');\r\n\r\n  if (targetId && targetId !== myId) {\r\n    connectToRelay(targetId);\r\n  } else if (targetId === myId) {\r\n    log.warn('[Relay] Ignored self-assignment request from Host.');\r\n  } else if (targetId === null) {\r\n    // Fallback to Host Direct\r\n    log.debug('[Relay] Fallback to Host requested.');\r\n    const upstreamDataConn = getState<DataConnection | null>('relay.upstreamDataConn');\r\n    if (upstreamDataConn) {\r\n      upstreamDataConn.close();\r\n      setState('relay.upstreamDataConn', null);\r\n    }\r\n    bus.emit('storage:request-recovery');\r\n  }\r\n}\r\n\r\n//  Initialize Relay \r\n\r\nexport function initRelay(): void {\r\n  registerHandlers({\r\n    [MSG.ASSIGN_DATA_SOURCE]: handleAssignDataSource as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n  });\r\n\r\n  // Accept incoming relay connections routed from peer.ts\r\n  bus.on('relay:incoming-connection', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection;\r\n    if (conn) handleRelayConnection(conn);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Relay: serve current file to downstream peer\r\n  bus.on('relay:serve-current-file', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection;\r\n    const msg = args[1] as Record<string, unknown>;\r\n    if (!conn || !conn.open) return;\r\n\r\n    const reqName = msg.name ? String(msg.name) : '';\r\n    const reqIndex = msg.index !== undefined ? Number(msg.index) : undefined;\r\n\r\n    const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n    const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n    const meta = getState<Record<string, unknown>>('transfer.meta');\r\n    const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n    // Try to match current file\r\n    const isMatchCurrent = currentFileBlob && (!reqName || (meta && meta.name === reqName));\r\n    // Try to match preloaded file\r\n    const isMatchPreload = nextFileBlob && (\r\n      (reqIndex !== undefined && nextMeta?.index === reqIndex) ||\r\n      (reqName && nextMeta?.name === reqName) ||\r\n      (!reqName && (nextMeta?.index as number) === currentTrackIndex)\r\n    );\r\n\r\n    if (isMatchCurrent) {\r\n      log.debug(`[Relay] Serving current file to ${conn.peer}: ${meta?.name}`);\r\n      const file = ensureNamedFile(currentFileBlob, (meta?.name as string) || 'Track');\r\n      if (file) unicastFile(conn, file, 0).catch(e => log.error('[Relay] unicast current failed:', e));\r\n    } else if (isMatchPreload) {\r\n      log.debug(`[Relay] Serving preloaded file to ${conn.peer}: ${nextMeta?.name}`);\r\n      const file = ensureNamedFile(nextFileBlob, (nextMeta?.name as string) || 'Track');\r\n      if (file) unicastFile(conn, file, 0).catch(e => log.error('[Relay] unicast preload failed:', e));\r\n    } else if (meta?.name) {\r\n      // Mid-download relay: send header + trigger OPFS catch-up\r\n      const receivedCount = getState<number>('transfer.receivedCount');\r\n      const bootName = (meta.name as string) || reqName;\r\n      log.debug(`[Relay] Bootstrapping downstream for ${bootName} (${receivedCount}/${meta.total || '?'})`);\r\n\r\n      conn.send({\r\n        ...meta,\r\n        type: MSG.FILE_START,\r\n        name: bootName,\r\n        sessionId: meta.sessionId || getState<number>('transfer.localSessionId'),\r\n      });\r\n\r\n      // OPFS catch-up: sequential pump with back-pressure\r\n      if (receivedCount > 0) {\r\n        startOpfsCatchupStream(conn, {\r\n          filename: bootName,\r\n          sessionId: meta.sessionId as number || getState<number>('transfer.localSessionId'),\r\n          startIndex: 0,\r\n          endIndexExclusive: receivedCount,\r\n          isPreload: false,\r\n        });\r\n      }\r\n    } else {\r\n      log.debug('[Relay] No matching data yet for', reqName || 'current');\r\n      conn.send({ type: MSG.FILE_WAIT, message: 'Relay source not ready yet' });\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Relay: serve recovery chunk to downstream peer\r\n  bus.on('relay:serve-recovery', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection;\r\n    const msg = args[1] as Record<string, unknown>;\r\n    if (!conn || !conn.open) return;\r\n\r\n    const fileName = (msg.fileName || msg.name) as string || '';\r\n    const nextChunk = Number(msg.nextChunk) || 0;\r\n    const sessionId = msg.sessionId as number || getState<number>('transfer.localSessionId');\r\n\r\n    log.debug(`[Relay Recovery] Peer ${conn.peer} requested chunk ${nextChunk} of ${fileName}`);\r\n\r\n    postWorkerCommand({\r\n      command: 'OPFS_READ',\r\n      filename: fileName,\r\n      index: nextChunk,\r\n      isPreload: false,\r\n      sessionId,\r\n      requestId: `${conn.peer}|recovery`,\r\n    });\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Handle OPFS read-complete: forward read chunks to downstream peers + advance pump\r\n  bus.on('opfs:read-complete', ((...args: unknown[]) => {\r\n    const data = args[0] as Record<string, unknown>;\r\n    if (!data) return;\r\n\r\n    const chunk = data.chunk as Uint8Array;\r\n    const index = data.index as number;\r\n    const filename = data.filename as string;\r\n    const requestId = data.requestId as string || '';\r\n    const sessionId = data.sessionId as number;\r\n\r\n    // Parse requestId format: \"<peerId>|<tag>\"\r\n    const sepIdx = requestId.lastIndexOf('|');\r\n    const peerId = sepIdx > 0 ? requestId.slice(0, sepIdx) : requestId;\r\n    const tag = sepIdx > 0 ? requestId.slice(sepIdx + 1) : '';\r\n\r\n    if (!peerId || !chunk) return;\r\n\r\n    // Session guard: discard stale chunks\r\n    const localSid = getState<number>('transfer.localSessionId');\r\n    if (sessionId && sessionId < localSid) {\r\n      log.warn(`[OPFS_READ] Stale session chunk discarded (got ${sessionId}, current ${localSid})`);\r\n      return;\r\n    }\r\n\r\n    const downstreamDataPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    const dConn = downstreamDataPeers.find(p => p.peer === peerId);\r\n    if (dConn && dConn.open) {\r\n      const meta = getState<Record<string, unknown>>('transfer.meta');\r\n      try {\r\n        dConn.send({\r\n          type: MSG.FILE_CHUNK,\r\n          chunk,\r\n          index,\r\n          sessionId,\r\n          total: meta?.total,\r\n          name: (meta?.name as string) || filename,\r\n        });\r\n      } catch (e) {\r\n        log.warn(`[Relay] Send chunk to ${peerId} failed:`, e);\r\n      }\r\n    }\r\n\r\n    // Advance the catch-up pump (sequential: wait for response before next read)\r\n    onOpfsCatchupReadComplete(peerId, sessionId, tag);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Relay] Handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Preload System\r\n * Extracted from original app.js lines 4064-4270, 7549-8143 (preload handlers)\r\n *\r\n * Manages: Host-side preload scheduling, background transfer to peers,\r\n * Guest-side preload receive (start/chunk/end), preload-ack, play-preloaded.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, CHUNK_SIZE, DELAY, TRANSFER_STATE } from '../core/constants.ts';\r\nimport { nextSessionId, validateSessionId } from '../core/session.ts';\r\nimport { setManagedTimer, clearManagedTimer } from '../core/timers.ts';\r\nimport { postWorkerCommand, readFileFromOpfs } from './opfs.ts';\r\nimport { registerHandlers } from '../network/protocol.ts';\r\nimport type { DataConnection, PreloadSessionEntry } from '../types/index.ts';\r\n\r\n//  Reorder Buffer \r\n// sessionId  Map(chunkIndex  Uint8Array)\r\nconst preloadReorderBuffer = new Map<number, Map<number, Uint8Array>>();\r\nlet latestPreloadSessionId = 0;\r\nconst MAX_EARLY_PRELOAD_CHUNKS = 128;\r\n\r\n//  Host: Schedule Preload \r\n\r\n/**\r\n * Schedule next track preload after a delay (host-only).\r\n */\r\nexport function schedulePreload(delayMs = 500): void {\r\n  clearManagedTimer('preloadScheduleTimer');\r\n  setManagedTimer('preloadScheduleTimer', () => {\r\n    preloadNextTrack();\r\n  }, delayMs);\r\n}\r\n\r\n/**\r\n * Preload the next track in the playlist (host-only).\r\n */\r\nasync function preloadNextTrack(): Promise<void> {\r\n  const playlist = getState<Array<Record<string, unknown>>>('playlist.items');\r\n  if (playlist.length <= 1) return;\r\n\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const repeatMode = getState<number>('playlist.repeatMode');\r\n  const isShuffle = getState<boolean>('playlist.isShuffle');\r\n\r\n  const currentSession = nextSessionId();\r\n  setState('preload.sessionId', currentSession);\r\n\r\n  // Determine next index\r\n  let nextIdx = -1;\r\n  if (repeatMode === 2) {\r\n    nextIdx = currentTrackIndex; // Repeat One\r\n  } else if (isShuffle && playlist.length > 1) {\r\n    do {\r\n      nextIdx = Math.floor(Math.random() * playlist.length);\r\n    } while (nextIdx === currentTrackIndex);\r\n  } else if (isShuffle && playlist.length === 1) {\r\n    nextIdx = 0;\r\n  } else {\r\n    nextIdx = currentTrackIndex + 1;\r\n    if (nextIdx >= playlist.length) {\r\n      if (repeatMode === 1) nextIdx = 0;\r\n      else nextIdx = -1;\r\n    }\r\n  }\r\n\r\n  setState('preload.nextTrackIndex', nextIdx);\r\n\r\n  if (nextIdx < 0 || nextIdx >= playlist.length) {\r\n    setState('preload.isPreloading', false);\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n    return;\r\n  }\r\n\r\n  const item = playlist[nextIdx];\r\n  if (!item) {\r\n    setState('preload.isPreloading', false);\r\n    return;\r\n  }\r\n\r\n  // Skip YouTube items\r\n  if (item.type === 'youtube') {\r\n    setState('preload.isPreloading', false);\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n    return;\r\n  }\r\n\r\n  const file = item.file as File;\r\n  if (!file) return;\r\n\r\n  log.debug('[Preload] Starting for:', file.name, 'session:', currentSession);\r\n  setState('preload.isPreloading', true);\r\n\r\n  const total = Math.ceil(file.size / CHUNK_SIZE);\r\n  setState('preload.nextFileBlob', file);\r\n  setState('preload.meta', {\r\n    name: file.name,\r\n    index: nextIdx,\r\n    mime: file.type,\r\n    total,\r\n    size: file.size,\r\n    sessionId: currentSession,\r\n  });\r\n\r\n  // Broadcast preload to connected peers\r\n  await backgroundTransfer(file, nextIdx, currentSession);\r\n\r\n  if (getState<number>('preload.sessionId') === currentSession) {\r\n    setState('preload.isPreloading', false);\r\n  }\r\n}\r\n\r\n//  Host: Background Transfer \r\n\r\nasync function backgroundTransfer(file: File, index: number, sessionId: number): Promise<void> {\r\n  const CHUNK = CHUNK_SIZE;\r\n  const total = Math.ceil(file.size / CHUNK);\r\n  const header = {\r\n    type: MSG.PRELOAD_START,\r\n    name: file.name,\r\n    mime: file.type,\r\n    total,\r\n    size: file.size,\r\n    index,\r\n    sessionId,\r\n  };\r\n\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const targets = connectedPeers.filter(p =>\r\n    p.status === 'connected' && (p.conn as DataConnection)?.open && p.isDataTarget !== false\r\n  );\r\n\r\n  if (targets.length === 0) return;\r\n\r\n  const targetsWhoNeedChunks = targets.filter(p => {\r\n    const preloadedIndexes = p.preloadedIndexes as Set<number> | undefined;\r\n    return !preloadedIndexes || !preloadedIndexes.has(index);\r\n  });\r\n\r\n  // Send header per-peer\r\n  targets.forEach(p => {\r\n    const conn = p.conn as DataConnection;\r\n    const needsChunks = targetsWhoNeedChunks.includes(p);\r\n    if (conn.open) {\r\n      conn.send({ ...header, skipped: !needsChunks });\r\n    }\r\n  });\r\n\r\n  // Send chunks\r\n  for (let i = 0; i < total; i++) {\r\n    if (getState<number>('preload.sessionId') !== sessionId) return;\r\n\r\n    // Backpressure\r\n    let congested = true;\r\n    while (congested) {\r\n      congested = false;\r\n      for (const p of targets) {\r\n        const conn = p.conn as DataConnection;\r\n        if (conn.open && conn.dataChannel && conn.dataChannel.bufferedAmount > 256 * 1024) {\r\n          congested = true;\r\n          break;\r\n        }\r\n      }\r\n      if (congested) await new Promise(r => setTimeout(r, DELAY.BACKPRESSURE));\r\n    }\r\n\r\n    const start = i * CHUNK;\r\n    const end = Math.min(start + CHUNK, file.size);\r\n    const chunkBuf = await file.slice(start, end).arrayBuffer();\r\n    const chunk = new Uint8Array(chunkBuf);\r\n    const chunkMsg = { type: MSG.PRELOAD_CHUNK, chunk, index: i, sessionId };\r\n\r\n    targetsWhoNeedChunks.forEach(p => {\r\n      const conn = p.conn as DataConnection;\r\n      if (conn.open) conn.send(chunkMsg);\r\n    });\r\n  }\r\n\r\n  if (getState<number>('preload.sessionId') === sessionId) {\r\n    const endMsg = { type: MSG.PRELOAD_END, name: file.name, index, sessionId };\r\n    targets.forEach(p => {\r\n      const conn = p.conn as DataConnection;\r\n      if (conn.open) conn.send(endMsg);\r\n    });\r\n    log.debug('[Preload] Complete for index:', index);\r\n  }\r\n}\r\n\r\n/**\r\n * Unicast preload data to a single peer (for late-joining guests).\r\n */\r\nexport async function unicastPreload(\r\n  conn: DataConnection,\r\n  file: File | Blob,\r\n  index: number,\r\n  sessionId: number\r\n): Promise<void> {\r\n  if (!conn || !conn.open || !file) return;\r\n  const CHUNK = CHUNK_SIZE;\r\n  const total = Math.ceil(file.size / CHUNK);\r\n  const fileName = 'name' in file ? file.name : 'Track';\r\n\r\n  conn.send({\r\n    type: MSG.PRELOAD_START,\r\n    name: fileName,\r\n    mime: file.type,\r\n    total,\r\n    size: file.size,\r\n    index,\r\n    sessionId,\r\n    skipped: false,\r\n  });\r\n\r\n  for (let i = 0; i < total; i++) {\r\n    if (!conn.open) return;\r\n    while (conn.open && conn.dataChannel && conn.dataChannel.bufferedAmount > 256 * 1024) {\r\n      await new Promise(r => setTimeout(r, DELAY.BACKPRESSURE));\r\n    }\r\n    if (!conn.open) return;\r\n    const start = i * CHUNK;\r\n    const chunkBuf = await file.slice(start, Math.min(start + CHUNK, file.size)).arrayBuffer();\r\n    conn.send({ type: MSG.PRELOAD_CHUNK, chunk: new Uint8Array(chunkBuf), index: i, sessionId });\r\n  }\r\n\r\n  if (conn.open) {\r\n    conn.send({ type: MSG.PRELOAD_END, name: fileName, index, sessionId });\r\n  }\r\n}\r\n\r\n//  Guest: Preload Receive Handlers \r\n\r\nfunction handlePreloadStart(data: Record<string, unknown>): void {\r\n  const sid = data.sessionId as number;\r\n  if (!sid) {\r\n    log.warn('[Preload] Start message missing sessionId. Ignoring.');\r\n    return;\r\n  }\r\n\r\n  clearManagedTimer('prepareWatchdog');\r\n  latestPreloadSessionId = sid;\r\n\r\n  // Skip if this preload was already marked as skipped by host\r\n  if (data.skipped) {\r\n    log.debug(`[Preload] Skipping session ${sid}`);\r\n    const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n    sessionState.set(sid, {\r\n      skipped: true,\r\n      progress: 0,\r\n      total: (data.total as number) || 0,\r\n      name: (data.name as string) || '',\r\n      index: (data.index as number) || 0,\r\n      size: (data.size as number) || 0,\r\n      mime: (data.mime as string) || '',\r\n      nextExpectedChunk: 0,\r\n      finalized: false,\r\n    });\r\n    try { preloadReorderBuffer.delete(sid); } catch { /* ignore */ }\r\n    return;\r\n  }\r\n\r\n  // Clear any stuck waiting state from previous preload\r\n  setState('transfer.waitingForPreload', false);\r\n\r\n  log.debug(`[Preload] Start: ${data.name} (index: ${data.index}, total: ${data.total})`);\r\n\r\n  // Initialize session state\r\n  const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n  sessionState.set(sid, {\r\n    skipped: false,\r\n    progress: 0,\r\n    total: (data.total as number) || 0,\r\n    name: (data.name as string) || '',\r\n    index: (data.index as number) || 0,\r\n    size: (data.size as number) || 0,\r\n    mime: (data.mime as string) || '',\r\n    nextExpectedChunk: 0,\r\n    finalized: false,\r\n  });\r\n\r\n  setState('preload.meta', {\r\n    name: data.name,\r\n    index: data.index,\r\n    mime: data.mime,\r\n    total: data.total,\r\n    size: data.size,\r\n    sessionId: sid,\r\n  });\r\n  setState('preload.count', 0);\r\n\r\n  // OPFS: Start preload slot\r\n  // Reset preload slot before starting (clear stale locks)\r\n  postWorkerCommand({ command: 'OPFS_RESET', isPreload: true });\r\n\r\n  postWorkerCommand({\r\n    command: 'OPFS_START',\r\n    filename: data.name as string,\r\n    isPreload: true,\r\n    sessionId: validateSessionId(sid),\r\n    size: CHUNK_SIZE,\r\n  });\r\n\r\n  // Drain any chunks that arrived before PRELOAD_START (unordered delivery)\r\n  try { drainPreloadReorderBuffer(sid); } catch { /* best-effort */ }\r\n\r\n  // Relay downstream\r\n  const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n\r\n  // Watchdog: unconditionally clear preload loader after 30s\r\n  clearManagedTimer('preloadWatchdog');\r\n  setManagedTimer('preloadWatchdog', () => {\r\n    log.warn('[Preload] Watchdog: forcing preload loader reset after 30s');\r\n    bus.emit('ui:show-loader', false);\r\n    setState('transfer.waitingForPreload', false);\r\n    // If main transfer is still in progress, restore its loader\r\n    const transferState = getState<string>('transfer.state');\r\n    if (transferState === TRANSFER_STATE.RECEIVING) {\r\n      const meta = getState<Record<string, unknown>>('transfer.meta');\r\n      const receivedCount = getState<number>('transfer.receivedCount');\r\n      const total = (meta?.total as number) || 0;\r\n      if (total > 0) {\r\n        const pct = Math.round((receivedCount / total) * 100);\r\n        bus.emit('ui:update-loader', pct);\r\n      }\r\n    }\r\n  }, 30000);\r\n}\r\n\r\nfunction drainPreloadReorderBuffer(sessionId: number): void {\r\n  const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n  const session = sessionState.get(sessionId);\r\n  if (!session || session.skipped) return;\r\n\r\n  const sessionBuffer = preloadReorderBuffer.get(sessionId);\r\n  if (!sessionBuffer) return;\r\n\r\n  let nextChunkPtr = session.nextExpectedChunk || 0;\r\n\r\n  while (sessionBuffer.has(nextChunkPtr)) {\r\n    const chunk = sessionBuffer.get(nextChunkPtr)!;\r\n\r\n    // Clone chunk to prevent detachment issues (one for relay, one for worker)\r\n    const chunkClone = new Uint8Array(chunk);\r\n    const fileName = session.name;\r\n\r\n    // If we still don't know the filename, keep buffering\r\n    if (!fileName) break;\r\n\r\n    // Relay downstream\r\n    const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n    if (downstreamPeers.length > 0) {\r\n      const relayCopy = new Uint8Array(chunk);\r\n      const relayMsg = { type: MSG.PRELOAD_CHUNK, chunk: relayCopy, index: nextChunkPtr, sessionId };\r\n      downstreamPeers.forEach(p => { if (p.open) p.send(relayMsg); });\r\n    }\r\n\r\n    postWorkerCommand({\r\n      command: 'OPFS_WRITE',\r\n      chunk: chunkClone.buffer as ArrayBuffer,\r\n      index: nextChunkPtr,\r\n      isPreload: true,\r\n      filename: fileName,\r\n      sessionId: validateSessionId(sessionId),\r\n    });\r\n\r\n    sessionBuffer.delete(nextChunkPtr);\r\n    nextChunkPtr++;\r\n  }\r\n\r\n  session.nextExpectedChunk = nextChunkPtr;\r\n  session.progress = nextChunkPtr;\r\n  setState('preload.count', session.progress);\r\n\r\n  // Tick watchdog on progress\r\n  const preloadMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n  if (preloadMeta && (preloadMeta.total as number) > 0) {\r\n    clearManagedTimer('preloadWatchdog');\r\n    setManagedTimer('preloadWatchdog', () => {\r\n      const transferState = getState<string>('transfer.state');\r\n      if (transferState === TRANSFER_STATE.READY || transferState === TRANSFER_STATE.IDLE) {\r\n        bus.emit('ui:show-loader', false);\r\n      }\r\n    }, 15000);\r\n  }\r\n\r\n  // Finalize if all chunks received (in-chunk finalization)\r\n  const totalExpected = session.total || 0;\r\n  const fileSize = session.size || 0;\r\n  if (totalExpected > 0 && session.progress >= totalExpected) {\r\n    if (!session.finalized) {\r\n      log.debug(`[Preload] All chunks received (${session.progress}/${totalExpected}). Finalizing...`);\r\n      session.finalized = true;\r\n      postWorkerCommand({\r\n        command: 'OPFS_END',\r\n        filename: session.name,\r\n        isPreload: true,\r\n        sessionId: sessionId,\r\n        totalSize: fileSize,\r\n      });\r\n      preloadReorderBuffer.delete(sessionId); // Prevent memory leak\r\n    }\r\n  }\r\n}\r\n\r\nfunction handlePreloadChunk(data: Record<string, unknown>): void {\r\n  // Require explicit sessionId  fallback to latestPreloadSessionId\r\n  let sid = data.sessionId as number;\r\n  if (!sid && latestPreloadSessionId !== 0) {\r\n    sid = latestPreloadSessionId;\r\n  }\r\n  if (!sid) return;\r\n\r\n  const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n  const session = sessionState.get(sid);\r\n\r\n  // If session state is marked skipped/finalized, ignore\r\n  if (session?.skipped || session?.finalized) return;\r\n\r\n  // Buffer the chunk in the reorder map\r\n  if (!preloadReorderBuffer.has(sid)) {\r\n    preloadReorderBuffer.set(sid, new Map());\r\n  }\r\n  const sessionBuffer = preloadReorderBuffer.get(sid)!;\r\n\r\n  // Clone data before storing to avoid detached ArrayBuffer issues\r\n  sessionBuffer.set(data.index as number, new Uint8Array(data.chunk as Uint8Array));\r\n\r\n  // If PRELOAD_START hasn't been processed yet (unordered delivery),\r\n  // keep buffering until sessionState exists so we have a reliable filename/total.\r\n  if (!session) {\r\n    if (sessionBuffer.size > MAX_EARLY_PRELOAD_CHUNKS) {\r\n      log.warn(`[Preload] Too many early chunks without session state (SID: ${sid}). Dropping.`);\r\n      preloadReorderBuffer.delete(sid);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Drain the reorder buffer sequentially\r\n  drainPreloadReorderBuffer(sid);\r\n}\r\n\r\nfunction handlePreloadEnd(data: Record<string, unknown>): void {\r\n  const sid = data.sessionId as number;\r\n  if (!sid) return;\r\n\r\n  const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n  const session = sessionState.get(sid);\r\n  if (!session || session.skipped) return;\r\n\r\n  // Only finalize if not already finalized by in-chunk detection\r\n  if (!session.finalized) {\r\n    session.finalized = true;\r\n\r\n    // Finalize OPFS\r\n    postWorkerCommand({\r\n      command: 'OPFS_END',\r\n      filename: session.name,\r\n      isPreload: true,\r\n      sessionId: validateSessionId(sid),\r\n      totalSize: session.size,\r\n    });\r\n  }\r\n\r\n  // Cleanup reorder buffer\r\n  preloadReorderBuffer.delete(sid);\r\n\r\n  log.debug(`[Preload] End: ${session.name} (${session.progress}/${session.total} chunks)`);\r\n\r\n  // Notify host\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn && hostConn.open && data.index !== undefined) {\r\n    const ackSent = getState<Set<number>>('preload.ackSent');\r\n    if (!ackSent.has(data.index as number)) {\r\n      ackSent.add(data.index as number);\r\n      hostConn.send({ type: MSG.PRELOAD_ACK, index: data.index });\r\n    }\r\n  }\r\n\r\n  // Relay downstream\r\n  const downstreamPeers = getState<DataConnection[]>('relay.downstreamDataPeers');\r\n  downstreamPeers.forEach(p => { if (p.open) p.send(data); });\r\n\r\n  bus.emit('storage:preload-ready', data.index as number);\r\n}\r\n\r\nfunction handlePreloadAck(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Guest ignores\r\n\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const p = connectedPeers.find(x => x.id === conn.peer);\r\n  if (p && data.index !== undefined) {\r\n    const preloadedIndexes = p.preloadedIndexes as Set<number>;\r\n    if (preloadedIndexes) {\r\n      preloadedIndexes.add(Number(data.index));\r\n      log.debug(`[Host] Marked index ${data.index} as CACHED for peer ${p.label}`);\r\n    }\r\n  }\r\n}\r\n\r\nfunction handlePlayPreloaded(data: Record<string, unknown>): void {\r\n  const index = data.index as number;\r\n  log.debug('[Guest] Command: Play Preloaded Track, index:', index);\r\n\r\n  if (data.index !== undefined) {\r\n    setState('playlist.currentTrackIndex', index);\r\n  }\r\n\r\n  bus.emit('storage:play-preloaded', index, data.name as string, data);\r\n}\r\n\r\n//  Register Handlers \r\n\r\nexport function initPreload(): void {\r\n  registerHandlers({\r\n    [MSG.PRELOAD_START]: handlePreloadStart as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.PRELOAD_CHUNK]: handlePreloadChunk as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.PRELOAD_END]: handlePreloadEnd as (d: Record<string, unknown>, c: DataConnection) => void,\r\n    [MSG.PRELOAD_ACK]: handlePreloadAck,\r\n    [MSG.PLAY_PRELOADED]: handlePlayPreloaded as (d: Record<string, unknown>, c: DataConnection) => void,\r\n  });\r\n\r\n  // Handle preload file ready from OPFS (bridged from opfs:file-ready via playback.ts)\r\n  bus.on('storage:preload-file-ready', (async (...args: unknown[]) => {\r\n    const filename = args[0] as string;\r\n    const sessionId = args[1] as number;\r\n\r\n    log.debug(`[Preload] OPFS preload ready: ${filename} (SID: ${sessionId})`);\r\n\r\n    const file = await readFileFromOpfs(filename, true);\r\n    if (!file) {\r\n      log.error('[Preload] Failed to read preload file from OPFS:', filename);\r\n      return;\r\n    }\r\n\r\n    // Store as preload blob\r\n    setState('preload.nextFileBlob', file);\r\n\r\n    const sessionState = getState<Map<number, PreloadSessionEntry>>('preload.sessionState');\r\n    const session = sessionState.get(sessionId);\r\n    const preloadMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n\r\n    setState('preload.meta', session || preloadMeta);\r\n\r\n    const nextTrackIndex = (session?.index ?? (preloadMeta?.index as number)) ?? -1;\r\n    setState('preload.nextTrackIndex', nextTrackIndex);\r\n\r\n    // If guest was waiting for this preloaded file, trigger playback\r\n    const waitingForPreload = getState<boolean>('transfer.waitingForPreload');\r\n    const pendingFileIndex = getState<number | undefined>('recovery.pendingFileIndex');\r\n    if (waitingForPreload && pendingFileIndex === nextTrackIndex) {\r\n      log.debug('[Preload] Guest was waiting for this track. Playing now.');\r\n      setState('transfer.waitingForPreload', false);\r\n      bus.emit('ui:show-loader', false);\r\n      bus.emit('storage:play-preloaded', nextTrackIndex, filename, {});\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Handle preload-ready notification (emitted after PRELOAD_END)\r\n  bus.on('storage:preload-ready', ((...args: unknown[]) => {\r\n    const index = args[0] as number;\r\n    log.debug(`[Preload] Preload ready for index: ${index}`);\r\n    // This signals the preload chain is complete.\r\n    // The actual file finalization is handled by opfs:file-ready  storage:preload-file-ready\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Preload] Handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  File Recovery\r\n * Extracted from original app.js lines 9072-9173, 9778-9845\r\n *\r\n * Manages: Recovery request with progressive backoff,\r\n * host-side file serving (handleRequestCurrentFile, handleRequestDataRecovery).\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, CHUNK_SIZE, MAX_RECOVERY_RETRIES, RECOVERY_BACKOFF, APP_STATE, TRANSFER_STATE } from '../core/constants.ts';\r\nimport { nextSessionId } from '../core/session.ts';\r\nimport { clearManagedTimer } from '../core/timers.ts';\r\nimport { ensureNamedFile } from './opfs.ts';\r\nimport { unicastFile } from './transfer.ts';\r\nimport { registerHandlers } from '../network/protocol.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Guest: Send Recovery Request \r\n\r\n/**\r\n * Send a recovery request with progressive backoff.\r\n * Targets relay or host depending on what's available.\r\n */\r\nexport function sendRecoveryRequest(forceChunk: number | null = null): void {\r\n  const pending = getState<boolean>('recovery.pending');\r\n  if (pending) {\r\n    log.debug('[Recovery] Request already pending, skipping');\r\n    return;\r\n  }\r\n\r\n  const retryCount = getState<number>('recovery.retryCount');\r\n  if (retryCount >= MAX_RECOVERY_RETRIES) {\r\n    log.error(`[Recovery] Max retries (${MAX_RECOVERY_RETRIES}) exceeded. Giving up.`);\r\n    clearManagedTimer('chunkWatchdog');\r\n    setState('transfer.state', TRANSFER_STATE.IDLE);\r\n    setState('recovery.pending', false);\r\n    setState('recovery.retryCount', 0);\r\n    bus.emit('ui:show-loader', false);\r\n    return;\r\n  }\r\n\r\n  // Find best connection\r\n  const upstreamDataConn = getState<DataConnection | null>('relay.upstreamDataConn');\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const targetConn = (upstreamDataConn && upstreamDataConn.open) ? upstreamDataConn : hostConn;\r\n\r\n  if (!targetConn || !targetConn.open) {\r\n    log.warn('[Recovery] No healthy connection for recovery');\r\n    return;\r\n  }\r\n\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const pendingFileName = getState<string>('recovery.pendingFileName');\r\n  const pendingFileIndex = getState<number | undefined>('recovery.pendingFileIndex');\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const receivedCount = getState<number>('transfer.receivedCount');\r\n  const localSid = getState<number>('transfer.localSessionId');\r\n  const currentTransferSid = getState<number>('transfer.currentSessionId');\r\n\r\n  const fileName = (meta?.name as string) || pendingFileName || '';\r\n  const index = pendingFileIndex !== undefined ? pendingFileIndex : currentTrackIndex;\r\n  const currentSid = localSid || currentTransferSid;\r\n\r\n  let chunkToAsk = forceChunk;\r\n  if (chunkToAsk === null) {\r\n    chunkToAsk = receivedCount || 0;\r\n  }\r\n\r\n  // Progressive backoff\r\n  const backoffMs = RECOVERY_BACKOFF[Math.min(retryCount, RECOVERY_BACKOFF.length - 1)];\r\n  setState('recovery.retryCount', retryCount + 1);\r\n  setState('recovery.pending', true);\r\n\r\n  const sourceLabel = targetConn === upstreamDataConn ? 'Relay' : 'Host';\r\n  log.debug(`[Recovery] Attempt ${retryCount + 1}/${MAX_RECOVERY_RETRIES} from ${sourceLabel}: ${fileName} (Chunk: ${chunkToAsk}, backoff: ${backoffMs}ms)`);\r\n\r\n  setTimeout(() => {\r\n    setState('recovery.pending', false);\r\n\r\n    // Re-check connection after backoff\r\n    if (!targetConn.open) {\r\n      log.warn('[Recovery] Connection closed during backoff');\r\n      return;\r\n    }\r\n\r\n    // Check if track changed during backoff\r\n    const latestMeta = getState<Record<string, unknown>>('transfer.meta');\r\n    const latestName = (latestMeta?.name as string) || getState<string>('recovery.pendingFileName') || '';\r\n    if (latestName && fileName && latestName !== fileName) {\r\n      log.debug('[Recovery] Track changed during backoff, aborting stale recovery');\r\n      setState('recovery.retryCount', 0);\r\n      return;\r\n    }\r\n\r\n    targetConn.send({\r\n      type: MSG.REQUEST_DATA_RECOVERY,\r\n      nextChunk: chunkToAsk,\r\n      fileName,\r\n      index,\r\n      sessionId: currentSid,\r\n    });\r\n  }, backoffMs);\r\n}\r\n\r\n//  Host: Handle File Requests \r\n\r\nasync function handleRequestCurrentFile(data: Record<string, unknown>, conn: DataConnection): Promise<void> {\r\n  // Only Host serves files directly\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Guest ignores\r\n  if (!conn || !conn.open) return;\r\n\r\n  // If Host is in YouTube mode, no local file to serve\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    try { conn.send({ type: MSG.FILE_WAIT, message: 'Host is playing YouTube' }); } catch { /* noop */ }\r\n    return;\r\n  }\r\n\r\n  const reqName = data.name ? String(data.name) : '';\r\n  const reqIndex = data.index !== undefined ? Number(data.index) : undefined;\r\n\r\n  // Find matching blob\r\n  const blob = findMatchingBlob(reqName, reqIndex);\r\n  if (!blob) {\r\n    try { conn.send({ type: MSG.FILE_WAIT, message: 'Host file is not ready yet' }); } catch { /* noop */ }\r\n    return;\r\n  }\r\n\r\n  const sid = ensureValidSessionId();\r\n  const fallbackName = getBlobFallbackName(blob, reqName);\r\n  const fileToSend = ensureNamedFile(blob, fallbackName);\r\n  if (fileToSend) await unicastFile(conn, fileToSend, 0, sid);\r\n}\r\n\r\nasync function handleRequestDataRecovery(data: Record<string, unknown>, conn: DataConnection): Promise<void> {\r\n  // Only Host serves recovery directly\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n  if (!conn || !conn.open) return;\r\n\r\n  // Normalize start chunk\r\n  let startChunk = 0;\r\n  if (data.nextChunk !== undefined) {\r\n    const n = Number(data.nextChunk);\r\n    if (Number.isFinite(n) && n > 0) startChunk = Math.floor(n);\r\n  }\r\n\r\n  const reqName = data.fileName || data.name ? String(data.fileName || data.name) : '';\r\n  const reqIndex = data.index !== undefined ? Number(data.index) : undefined;\r\n\r\n  const blob = findMatchingBlob(reqName, reqIndex);\r\n  if (!blob) {\r\n    try { conn.send({ type: MSG.FILE_WAIT, message: 'Host has no cached file for recovery yet' }); } catch { /* noop */ }\r\n    return;\r\n  }\r\n\r\n  // Clamp chunk index\r\n  const total = Math.ceil(blob.size / CHUNK_SIZE);\r\n  if (!Number.isFinite(total) || total <= 0) {\r\n    try { conn.send({ type: MSG.FILE_WAIT, message: 'Invalid file size' }); } catch { /* noop */ }\r\n    return;\r\n  }\r\n  if (startChunk >= total) startChunk = Math.max(0, total - 1);\r\n\r\n  const sid = ensureValidSessionId();\r\n  const fallbackName = getBlobFallbackName(blob, reqName);\r\n  const fileToSend = ensureNamedFile(blob, fallbackName);\r\n  if (fileToSend) await unicastFile(conn, fileToSend, startChunk, sid);\r\n}\r\n\r\n//  Helpers \r\n\r\nfunction findMatchingBlob(reqName: string, reqIndex: number | undefined): Blob | null {\r\n  const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n  const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n\r\n  let blob: Blob | null = null;\r\n\r\n  if (currentFileBlob) {\r\n    const matchByIndex = reqIndex !== undefined && meta && Number(meta.index) === reqIndex;\r\n    const matchByName = reqName && meta && meta.name === reqName;\r\n    const noHint = !reqName && reqIndex === undefined;\r\n    if (matchByIndex || matchByName || noHint) blob = currentFileBlob;\r\n  }\r\n\r\n  if (!blob && nextFileBlob && nextMeta) {\r\n    const matchNextByIndex = reqIndex !== undefined && Number(nextMeta.index) === reqIndex;\r\n    const matchNextByName = reqName && nextMeta.name === reqName;\r\n    if (matchNextByIndex || matchNextByName) blob = nextFileBlob;\r\n  }\r\n\r\n  if (!blob) blob = currentFileBlob || nextFileBlob;\r\n  return blob;\r\n}\r\n\r\nfunction ensureValidSessionId(): number {\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  let currentTransferSessionId = getState<number>('transfer.currentSessionId');\r\n  let sid = (meta?.sessionId as number) || currentTransferSessionId;\r\n  if (!sid || sid < 1) {\r\n    sid = nextSessionId();\r\n    setState('transfer.currentSessionId', sid);\r\n  }\r\n  return sid;\r\n}\r\n\r\nfunction getBlobFallbackName(blob: Blob, reqName: string): string {\r\n  const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n  const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n\r\n  if (blob === currentFileBlob && meta?.name) return meta.name as string;\r\n  if (blob === nextFileBlob && nextMeta?.name) return nextMeta.name as string;\r\n  return reqName || (meta?.name as string) || (nextMeta?.name as string) || 'Track';\r\n}\r\n\r\n//  Register Handlers \r\n\r\nexport function initRecovery(): void {\r\n  registerHandlers({\r\n    [MSG.REQUEST_CURRENT_FILE]: handleRequestCurrentFile,\r\n    [MSG.REQUEST_DATA_RECOVERY]: handleRequestDataRecovery,\r\n  });\r\n\r\n  // Listen for recovery events from other modules\r\n  bus.on('storage:request-recovery', () => {\r\n    sendRecoveryRequest();\r\n  });\r\n\r\n  log.info('[Recovery] Handlers registered');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Blob URL Manager\r\n * Extracted from original app.js lines 792-995\r\n *\r\n * Centralized Blob URL lifecycle management to prevent memory leaks.\r\n * Supports deferred revocation for URLs still attached to <video>.\r\n */\r\n\r\nimport { DELAY } from './constants.ts';\r\nimport { log } from './log.ts';\r\n\r\ninterface RevokeOptions {\r\n  delayMs?: number;\r\n  force?: boolean;\r\n}\r\n\r\n/** Reference to the main video element (set by UI layer) */\r\nlet _videoElement: HTMLVideoElement | null = null;\r\n\r\nexport function setVideoElement(el: HTMLVideoElement | null): void {\r\n  _videoElement = el;\r\n}\r\n\r\nexport const BlobURLManager = {\r\n  _activeURL: null as string | null,\r\n  _preparingURL: null as string | null,\r\n  _pendingRevocations: new Map<string, ReturnType<typeof setTimeout>>(),\r\n  _deferredUntilDetached: new Set<string>(),\r\n  MAX_PENDING: 5,\r\n\r\n  _isUrlAttached(url: string): boolean {\r\n    try {\r\n      return !!(url && _videoElement && _videoElement.src === url);\r\n    } catch {\r\n      return false;\r\n    }\r\n  },\r\n\r\n  _clearScheduled(url: string): void {\r\n    const t = this._pendingRevocations.get(url);\r\n    if (t) {\r\n      try { clearTimeout(t); } catch { /* */ }\r\n    }\r\n    this._pendingRevocations.delete(url);\r\n  },\r\n\r\n  _revokeNow(url: string | null, reason = ''): void {\r\n    if (!url) return;\r\n    this._clearScheduled(url);\r\n    this._deferredUntilDetached.delete(url);\r\n\r\n    try {\r\n      URL.revokeObjectURL(url);\r\n      log.debug(`[BlobURL] Revoked: ${url}${reason ? ` (${reason})` : ''}`);\r\n    } catch (e) {\r\n      log.debug('[BlobURL] Revoke failed (non-critical):', e);\r\n    }\r\n\r\n    if (this._activeURL === url) this._activeURL = null;\r\n    if (this._preparingURL === url) this._preparingURL = null;\r\n  },\r\n\r\n  /**\r\n   * Create a new Blob URL in 'Preparing' state.\r\n   */\r\n  create(blob: Blob): string | null {\r\n    if (!blob) return null;\r\n\r\n    if (this._preparingURL) {\r\n      this._revokeNow(this._preparingURL, 'abandoned-preparing');\r\n    }\r\n\r\n    this._preparingURL = URL.createObjectURL(blob);\r\n    log.debug(`[BlobURL] Prepared: ${this._preparingURL}`);\r\n    return this._preparingURL;\r\n  },\r\n\r\n  /**\r\n   * Confirm the prepared URL as the active one.\r\n   */\r\n  confirm(): void {\r\n    if (!this._preparingURL) return;\r\n\r\n    const nextUrl = this._preparingURL;\r\n    const prevUrl = this._activeURL;\r\n\r\n    this._activeURL = nextUrl;\r\n    this._preparingURL = null;\r\n\r\n    if (prevUrl && prevUrl !== nextUrl) {\r\n      this.safeRevoke(prevUrl);\r\n    }\r\n\r\n    log.debug(`[BlobURL] Confirmed Active: ${this._activeURL}`);\r\n  },\r\n\r\n  /**\r\n   * Schedule a URL for revocation after a safety delay.\r\n   */\r\n  safeRevoke(url: string | null, options?: RevokeOptions): void {\r\n    if (!url) return;\r\n\r\n    const force = options?.force === true;\r\n    const delayMs = (typeof options?.delayMs === 'number' && options.delayMs >= 0)\r\n      ? options.delayMs\r\n      : DELAY.BLOB_REVOCATION;\r\n\r\n    if (this._pendingRevocations.has(url)) return;\r\n\r\n    if (!force && this._isUrlAttached(url)) {\r\n      this._deferredUntilDetached.add(url);\r\n      log.debug(`[BlobURL] Deferred revocation (still attached): ${url}`);\r\n      return;\r\n    }\r\n\r\n    // Queue overflow protection\r\n    if (this._pendingRevocations.size >= this.MAX_PENDING) {\r\n      const oldest = this._pendingRevocations.keys().next().value!;\r\n      if (this._isUrlAttached(oldest)) {\r\n        this._deferredUntilDetached.add(oldest);\r\n        this._pendingRevocations.delete(oldest);\r\n      } else {\r\n        this._revokeNow(oldest, 'queue-overflow');\r\n      }\r\n    }\r\n\r\n    if (delayMs === 0) {\r\n      this._revokeNow(url, 'delay=0');\r\n      return;\r\n    }\r\n\r\n    const t = setTimeout(() => {\r\n      this._revokeNow(url, 'scheduled');\r\n    }, delayMs);\r\n    this._pendingRevocations.set(url, t);\r\n    log.debug(`[BlobURL] Scheduled for revocation (${delayMs}ms): ${url}`);\r\n  },\r\n\r\n  /**\r\n   * Flush deferred URLs that are no longer attached to <video>.\r\n   */\r\n  flushDeferred(reason = ''): void {\r\n    if (!this._deferredUntilDetached.size) return;\r\n\r\n    const urls = Array.from(this._deferredUntilDetached);\r\n    let flushed = 0;\r\n\r\n    for (const url of urls) {\r\n      if (!this._isUrlAttached(url)) {\r\n        this._deferredUntilDetached.delete(url);\r\n        this.safeRevoke(url, { force: true });\r\n        flushed++;\r\n      }\r\n    }\r\n\r\n    if (flushed) log.debug(`[BlobURL] Flushed deferred: ${flushed}${reason ? ` (${reason})` : ''}`);\r\n  },\r\n\r\n  /**\r\n   * Revoke the currently active/preparing URL (deferred if attached).\r\n   */\r\n  revoke(options?: RevokeOptions): void {\r\n    if (this._preparingURL) {\r\n      this.safeRevoke(this._preparingURL, { force: true, delayMs: 0 });\r\n    }\r\n    if (this._activeURL) {\r\n      this.safeRevoke(this._activeURL, options);\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Force revoke everything. Use ONLY after detaching media sources.\r\n   */\r\n  revokeAllNow(reason = 'force'): void {\r\n    for (const url of Array.from(this._pendingRevocations.keys())) {\r\n      this._revokeNow(url, reason);\r\n    }\r\n    for (const url of Array.from(this._deferredUntilDetached)) {\r\n      this._revokeNow(url, reason);\r\n    }\r\n    if (this._activeURL) this._revokeNow(this._activeURL, reason);\r\n    if (this._preparingURL) this._revokeNow(this._preparingURL, reason);\r\n\r\n    this._pendingRevocations.clear();\r\n    this._deferredUntilDetached.clear();\r\n    this._activeURL = null;\r\n    this._preparingURL = null;\r\n  },\r\n\r\n  /** Get the currently active URL (read-only) */\r\n  get activeURL(): string | null {\r\n    return this._activeURL;\r\n  },\r\n};\r\n","/**\r\n * MUSIXQUARE 2.0  Video Element & State Helpers\r\n * Extracted from original app.js lines 502-504, 601-615, 1344, 4895-4926\r\n *\r\n * Manages: videoElement reference, media type detection, idle/paused helper,\r\n * engine mode switching.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { APP_STATE } from '../core/constants.ts';\r\nimport { getCurrentAudioBuffer } from './playback.ts';\r\n\r\n//  Video Element \r\n\r\nlet _videoElement: HTMLVideoElement | null = null;\r\n\r\nexport function getVideoElement(): HTMLVideoElement | null {\r\n  return _videoElement;\r\n}\r\n\r\n//  State Helpers \r\n\r\nexport function isIdleOrPaused(state: string): boolean {\r\n  return state === APP_STATE.IDLE || state === APP_STATE.PAUSED;\r\n}\r\n\r\n//  Media Type Detection \r\n\r\nconst VIDEO_EXTENSIONS = ['mp4', 'mkv', 'webm', 'mov'];\r\n\r\nexport function isMediaVideo(blob: Blob | File | null, metadata?: Record<string, unknown> | null): boolean {\r\n  if (!blob) return false;\r\n\r\n  // 1. Check MIME type\r\n  if (blob.type && blob.type.startsWith('video/')) return true;\r\n  if (metadata) {\r\n    if (typeof metadata.mime === 'string' && metadata.mime.startsWith('video/')) return true;\r\n    if (typeof metadata.type === 'string' && metadata.type.startsWith('video/')) return true;\r\n  }\r\n\r\n  // 2. Check extension\r\n  const fileName = (metadata?.name as string) || (blob as File).name || '';\r\n  const ext = fileName.split('.').pop()?.toLowerCase() || '';\r\n  return VIDEO_EXTENSIONS.includes(ext);\r\n}\r\n\r\n//  Engine Mode \r\n\r\n/**\r\n * Handle UI and state transitions between Audio, Video, and YouTube modes.\r\n * Sets state to target mode, but if currently idle/paused, stays in PAUSED\r\n * to prevent \"ghost playback\" UI.\r\n */\r\nexport function setEngineMode(mode: string): void {\r\n  log.debug(`[Engine] Switching mode to: ${mode}`);\r\n\r\n  let targetState: string;\r\n  switch (mode) {\r\n    case 'video':\r\n      targetState = APP_STATE.PLAYING_VIDEO;\r\n      break;\r\n    case 'youtube':\r\n      targetState = APP_STATE.PLAYING_YOUTUBE;\r\n      break;\r\n    case 'buffer':\r\n    case 'audio':\r\n      targetState = APP_STATE.PLAYING_AUDIO;\r\n      break;\r\n    default:\r\n      targetState = APP_STATE.IDLE;\r\n  }\r\n\r\n  const currentState = getState<string>('appState');\r\n  const newState = isIdleOrPaused(currentState) ? APP_STATE.PAUSED : targetState;\r\n\r\n  // For YouTube, always set the target state so body class is applied\r\n  const finalState = mode === 'youtube' ? targetState : newState;\r\n  setState('appState', finalState);\r\n  bus.emit('player:state-changed', finalState);\r\n\r\n  bus.emit('ui:update-playlist');\r\n}\r\n\r\n//  Body Mode Class \r\n\r\n/**\r\n * Update UI classes and elements based on state.\r\n * Faithfully ported from original app.js `updateUIForState()`.\r\n *\r\n * Key insight: `mode-video` is the master CSS toggle for the video-wrapper\r\n * (used by BOTH local video AND YouTube). `mode-youtube` is additionally set\r\n * for YouTube-specific UI (e.g. settings lock overlay). When a local video\r\n * is paused, we keep `mode-video` so the frozen frame stays visible.\r\n */\r\nfunction updateBodyModeClass(appState: string): void {\r\n  const body = document.body;\r\n  body.classList.remove('mode-video', 'mode-youtube', 'mode-audio');\r\n\r\n  const videoElement = _videoElement;\r\n  const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n\r\n  // UX: When a local *video* is paused we still want to keep the paused frame\r\n  // visible (instead of collapsing back to the visualizer).\r\n  const keepVideoVisibleOnIdle = (\r\n    isIdleOrPaused(appState) &&\r\n    videoElement &&\r\n    !!videoElement.src &&\r\n    isMediaVideo(currentFileBlob, meta)\r\n  );\r\n\r\n  const isVideoMode = (\r\n    appState === APP_STATE.PLAYING_VIDEO ||\r\n    appState === APP_STATE.PLAYING_YOUTUBE ||\r\n    keepVideoVisibleOnIdle\r\n  );\r\n\r\n  // mode-video is the master toggle for .video-wrapper visibility (CSS)\r\n  if (isVideoMode) body.classList.add('mode-video');\r\n\r\n  // mode-youtube is additional for YouTube-specific UI (settings lock)\r\n  if (appState === APP_STATE.PLAYING_YOUTUBE) body.classList.add('mode-youtube');\r\n\r\n  if (appState === APP_STATE.PLAYING_AUDIO) body.classList.add('mode-audio');\r\n\r\n  //  YouTube container visibility (default: hidden) \r\n  const ytContainer = document.getElementById('youtube-player-container');\r\n  if (ytContainer) {\r\n    ytContainer.style.opacity = '0';\r\n    ytContainer.style.pointerEvents = 'none';\r\n    ytContainer.style.display = 'none';\r\n  }\r\n\r\n  //  Video wrapper: explicit inline style (backup for CSS) \r\n  const videoWrapper = document.querySelector('.video-wrapper') as HTMLElement | null;\r\n  if (videoWrapper) {\r\n    videoWrapper.style.display = isVideoMode ? 'flex' : 'none';\r\n    if (isVideoMode) {\r\n      videoWrapper.style.visibility = 'visible';\r\n      videoWrapper.style.pointerEvents = 'auto';\r\n    }\r\n  }\r\n\r\n  //  Main video element: only show for local video (not YouTube) \r\n  if (videoElement) {\r\n    const showMainVideo = (appState === APP_STATE.PLAYING_VIDEO) || keepVideoVisibleOnIdle;\r\n    videoElement.style.display = showMainVideo ? 'block' : 'none';\r\n  }\r\n\r\n  //  YouTube container: show for YouTube mode \r\n  if (appState === APP_STATE.PLAYING_YOUTUBE && ytContainer) {\r\n    ytContainer.style.display = 'block';\r\n    ytContainer.style.opacity = '1';\r\n    ytContainer.style.pointerEvents = 'auto';\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initVideo(): void {\r\n  _videoElement = document.getElementById('main-video') as HTMLVideoElement | null;\r\n  if (!_videoElement) {\r\n    log.warn('[Video] #main-video element not found');\r\n  }\r\n\r\n  // Sync body mode class with app state changes\r\n  bus.on('player:state-changed', ((...args: unknown[]) => {\r\n    updateBodyModeClass(args[0] as string);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Sync video element volume with master volume\r\n  bus.on('player:sync-video-volume', ((...args: unknown[]) => {\r\n    const vol = Number(args[0]);\r\n    if (!_videoElement || !Number.isFinite(vol)) return;\r\n\r\n    // [Double Audio Fix] Mute video when playing via audio buffer decode mode\r\n    if (getCurrentAudioBuffer()) {\r\n      _videoElement.volume = 0;\r\n      _videoElement.muted = true;\r\n    } else {\r\n      try { _videoElement.volume = vol; } catch (e) {\r\n        log.debug('[Video] Volume set failed:', e);\r\n      }\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Video] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Playback Engine\r\n * Extracted from original app.js lines 4401-5056, 4544-4700, 10470-10607\r\n *\r\n * Manages: play/pause/stop/seek, Tone.js BufferSource lifecycle,\r\n * video sync, track position calculation, file loading/decoding.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, APP_STATE } from '../core/constants.ts';\r\nimport { nextSessionId } from '../core/session.ts';\r\nimport { clearManagedTimer, getManagedTimer } from '../core/timers.ts';\r\nimport { BlobURLManager } from '../core/blob-manager.ts';\r\nimport { initAudio, getWidener } from '../audio/engine.ts';\r\nimport { getVideoElement, isIdleOrPaused, isMediaVideo, setEngineMode } from './video.ts';\r\nimport { postWorkerCommand, cleanupOPFSInWorker, readFileFromOpfs } from '../storage/opfs.ts';\r\nimport { broadcastFile, unicastFile } from '../storage/transfer.ts';\r\nimport { schedulePreload, unicastPreload } from '../storage/preload.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport { requestGlobalResyncDelayed } from '../network/sync.ts';\r\nimport { registerHandlers, validateMessage, verifyOperator } from '../network/protocol.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\ndeclare const Tone: any;\r\n/* eslint-enable @typescript-eslint/no-explicit-any */\r\n\r\n//  Module-local State \r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nlet _playerNode: any = null;\r\nlet _currentAudioBuffer: AudioBuffer | null = null;\r\nlet _currentLoadToken = 0;\r\nlet _activeLoadSessionId = 0;\r\nlet _isPlayLocked = false;\r\nlet _pendingPlayTime: number | undefined;\r\nlet _playPreloadedInProgress = false;\r\n\r\n//  Getters \r\n\r\nexport function getCurrentAudioBuffer(): AudioBuffer | null {\r\n  return _currentAudioBuffer;\r\n}\r\n\r\nexport function setCurrentAudioBuffer(buf: AudioBuffer | null): void {\r\n  _currentAudioBuffer = buf;\r\n}\r\n\r\nexport function incrementLoadToken(): number {\r\n  return ++_currentLoadToken;\r\n}\r\n\r\nexport function getLoadToken(): number {\r\n  return _currentLoadToken;\r\n}\r\n\r\nexport function setPendingPlayTime(time: number | undefined): void {\r\n  _pendingPlayTime = time;\r\n}\r\n\r\nexport function getPendingPlayTime(): number | undefined {\r\n  return _pendingPlayTime;\r\n}\r\n\r\n//  Format Helpers \r\n\r\nexport function fmtTime(s: number): string {\r\n  if (isNaN(s)) return '0:00';\r\n  const m = Math.floor(s / 60);\r\n  const sec = Math.floor(s % 60);\r\n  return `${m}:${sec < 10 ? '0' : ''}${sec}`;\r\n}\r\n\r\n//  Track Position \r\n\r\nexport function getTrackPosition(): number {\r\n  const currentState = getState<string>('appState');\r\n  const pausedAt = getState<number>('player.pausedAt') || 0;\r\n\r\n  if (isIdleOrPaused(currentState)) return pausedAt;\r\n\r\n  // YouTube mode: delegated via synchronous callback\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    let ytPos = 0;\r\n    bus.emit('youtube:get-position', (pos: number) => { ytPos = pos; });\r\n    return ytPos;\r\n  }\r\n\r\n  const videoElement = getVideoElement();\r\n  const duration = (_currentAudioBuffer && Number.isFinite(_currentAudioBuffer.duration))\r\n    ? _currentAudioBuffer.duration\r\n    : (videoElement && Number.isFinite(videoElement.duration) ? videoElement.duration : 0);\r\n\r\n  let pos = 0;\r\n  const startedAt = getState<number>('player.startedAt') || 0;\r\n  const localOffset = getState<number>('sync.localOffset') || 0;\r\n  const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n\r\n  const startedAtValid = typeof startedAt === 'number' && Number.isFinite(startedAt) && startedAt > 0;\r\n  if (startedAtValid && typeof Tone !== 'undefined' && Tone?.now) {\r\n    pos = (Tone.now() - startedAt) + localOffset + autoSyncOffset;\r\n  } else if (videoElement?.src && videoElement.readyState >= 1) {\r\n    pos = videoElement.currentTime;\r\n  }\r\n\r\n  if (isNaN(pos)) pos = 0;\r\n  if (pos < 0) pos = 0;\r\n  if (duration > 0 && pos > duration) pos = duration;\r\n\r\n  return pos;\r\n}\r\n\r\n//  Play State UI \r\n\r\nexport function updatePlayState(playing: boolean): void {\r\n  bus.emit('ui:update-play-state', playing);\r\n}\r\n\r\n//  Stop Player Node \r\n\r\nexport function stopPlayerNode(): void {\r\n  if (_playerNode) {\r\n    try {\r\n      _playerNode.onended = null;\r\n      _playerNode.stop();\r\n      _playerNode.disconnect();\r\n      _playerNode.dispose();\r\n    } catch (e) {\r\n      log.warn('Error stopping/disposing playerNode:', e);\r\n    } finally {\r\n      _playerNode = null;\r\n    }\r\n  }\r\n}\r\n\r\n//  Stop All Media \r\n\r\nexport function stopAllMedia(): void {\r\n  const videoElement = getVideoElement();\r\n\r\n  // 1. Stop video\r\n  if (videoElement) {\r\n    videoElement.pause();\r\n    videoElement.removeAttribute('src');\r\n    videoElement.load();\r\n  }\r\n\r\n  try { BlobURLManager.revoke(); } catch { /* noop */ }\r\n  try { BlobURLManager.flushDeferred('stopAllMedia'); } catch { /* noop */ }\r\n\r\n  // 2. Stop YouTube\r\n  bus.emit('youtube:stop-mode');\r\n\r\n  // 3. Clear pending triggers\r\n  clearManagedTimer('preloadScheduleTimer');\r\n  clearManagedTimer('autoPlayTimer');\r\n\r\n  setState('appState', APP_STATE.IDLE);\r\n  bus.emit('player:state-changed', APP_STATE.IDLE);\r\n  updatePlayState(false);\r\n\r\n  // Stop background sync timers\r\n  bus.emit('worker:sync-command', { command: 'STOP_TIMER', id: 'video-sync' });\r\n\r\n  // Stop player node\r\n  stopPlayerNode();\r\n\r\n  // Clear relay queues\r\n  setState('relay.chunkQueue', []);\r\n\r\n  // Reset master clock\r\n  setState('player.startedAt', 0);\r\n  setState('player.pausedAt', 0);\r\n}\r\n\r\n//  Play \r\n\r\nexport async function play(offset: number): Promise<void> {\r\n  if (_isPlayLocked) {\r\n    log.warn('[Play] Blocked: queuing play request');\r\n    _pendingPlayTime = offset;\r\n    return;\r\n  }\r\n  _isPlayLocked = true;\r\n\r\n  const lockWatchdog = setTimeout(() => {\r\n    if (_isPlayLocked) {\r\n      log.warn('[Play] Lock Timeout: Forcing unlock after 5s');\r\n      _isPlayLocked = false;\r\n    }\r\n  }, 5000);\r\n\r\n  try {\r\n    await _internalPlay(offset);\r\n  } finally {\r\n    clearTimeout(lockWatchdog);\r\n    setTimeout(() => { _isPlayLocked = false; }, 10);\r\n  }\r\n}\r\n\r\nasync function _internalPlay(offset: number): Promise<void> {\r\n  _pendingPlayTime = undefined;\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    log.warn('[Audio] Blocked play() call while in YouTube mode');\r\n    return;\r\n  }\r\n\r\n  if (typeof Tone === 'undefined' || !Tone?.context) {\r\n    log.error('[Audio] Tone.js not loaded');\r\n    bus.emit('ui:show-toast', '    .');\r\n    return;\r\n  }\r\n\r\n  if (Tone.context.state !== 'running') {\r\n    try { await Tone.context.resume(); } catch (e) { log.warn('Resume failed:', e); }\r\n  }\r\n\r\n  const videoElement = getVideoElement();\r\n  const hasVideoSource = !!(videoElement?.src?.startsWith('blob:'));\r\n  const hasBufferSource = !!_currentAudioBuffer;\r\n\r\n  if (!hasVideoSource && !hasBufferSource) {\r\n    log.warn('[Play] No media source available');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await initAudio();\r\n  } catch (e) {\r\n    log.error('[Audio] initAudio failed:', e);\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  // Sanitize offset\r\n  let safeOffset = Number(offset);\r\n  if (!Number.isFinite(safeOffset) || safeOffset < 0) safeOffset = 0;\r\n  const duration = (_currentAudioBuffer && Number.isFinite(_currentAudioBuffer.duration))\r\n    ? _currentAudioBuffer.duration\r\n    : (videoElement && Number.isFinite(videoElement.duration) ? videoElement.duration : 0);\r\n  if (duration > 0) {\r\n    if (safeOffset > duration) safeOffset = duration;\r\n    if (safeOffset === duration) safeOffset = Math.max(0, duration - 0.001);\r\n  }\r\n\r\n  // Buffer Mode playback\r\n  if (_currentAudioBuffer) {\r\n    stopPlayerNode();\r\n    _playerNode = new Tone.BufferSource(_currentAudioBuffer);\r\n\r\n    const isSurroundMode = getState<boolean>('audio.isSurroundMode');\r\n    const surroundChannelIndex = getState<number>('audio.surroundChannelIndex');\r\n\r\n    if (isSurroundMode) {\r\n      bus.emit('audio:connect-surround', _playerNode, surroundChannelIndex);\r\n      log.debug(`[BufferMode] Playing in 7.1 Surround (Ch: ${surroundChannelIndex})`);\r\n    } else {\r\n      const widener = getWidener();\r\n      if (widener) _playerNode.connect(widener);\r\n      log.debug('[BufferMode] Playing in Stereo');\r\n    }\r\n\r\n    const endedToken = _currentLoadToken;\r\n    _playerNode.onended = () => {\r\n      if (endedToken !== _currentLoadToken) return;\r\n      const state = getState<string>('appState');\r\n      if (state === APP_STATE.PLAYING_AUDIO || state === APP_STATE.PLAYING_VIDEO) {\r\n        handleEnded();\r\n      }\r\n    };\r\n\r\n    _playerNode.start(Tone.now(), safeOffset);\r\n\r\n    // Sync visuals (muted video)\r\n    if (videoElement?.src) {\r\n      videoElement.currentTime = safeOffset;\r\n      videoElement.muted = true;\r\n      videoElement.volume = 0;\r\n      videoElement.play().catch(() => { /* noop */ });\r\n    }\r\n  }\r\n\r\n  // Update timing\r\n  const localOffset = getState<number>('sync.localOffset') || 0;\r\n  const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n  const startedAt = Tone.now() - (safeOffset - (localOffset + autoSyncOffset));\r\n  setState('player.startedAt', startedAt);\r\n  setState('player.pausedAt', safeOffset);\r\n  log.debug(`[BufferMode] Started at ${safeOffset}s (startedAt: ${startedAt})`);\r\n\r\n  updatePlayState(true);\r\n\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n  const isVideo = isMediaVideo(currentFileBlob, meta);\r\n  const newState = isVideo ? APP_STATE.PLAYING_VIDEO : APP_STATE.PLAYING_AUDIO;\r\n  setState('appState', newState);\r\n  bus.emit('player:state-changed', newState);\r\n\r\n  bus.emit('visualizer:start');\r\n  if (isVideo) {\r\n    bus.emit('worker:sync-command', { command: 'START_TIMER', id: 'video-sync', interval: 2000 });\r\n  }\r\n  bus.emit('ui:loop-start');\r\n}\r\n\r\n//  Pause \r\n\r\nexport function pause(forcedTime?: number): void {\r\n  const currentState = getState<string>('appState');\r\n  if (isIdleOrPaused(currentState)) return;\r\n\r\n  let pausePos: number;\r\n  if (typeof forcedTime === 'number' && isFinite(forcedTime) && forcedTime >= 0) {\r\n    pausePos = forcedTime;\r\n  } else {\r\n    pausePos = getTrackPosition();\r\n  }\r\n\r\n  stopPlayerNode();\r\n\r\n  const videoElement = getVideoElement();\r\n  if (videoElement) {\r\n    try { videoElement.pause(); } catch { /* noop */ }\r\n    try { videoElement.currentTime = pausePos; } catch { /* noop */ }\r\n  }\r\n\r\n  setState('appState', APP_STATE.PAUSED);\r\n  setState('player.pausedAt', pausePos);\r\n  bus.emit('player:state-changed', APP_STATE.PAUSED);\r\n  updatePlayState(false);\r\n  bus.emit('ui:show-toast', '');\r\n  bus.emit('worker:sync-command', { command: 'STOP_TIMER', id: 'video-sync' });\r\n}\r\n\r\n//  Handle Track Ended \r\n\r\nfunction handleEnded(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Guests don't handle track-end\r\n\r\n  const currentState = getState<string>('appState');\r\n  const videoElement = getVideoElement();\r\n\r\n  const hasBufferDuration = !!(_currentAudioBuffer &&\r\n    Number.isFinite(_currentAudioBuffer.duration) && _currentAudioBuffer.duration > 0.5);\r\n\r\n  const usesVideoElement = currentState === APP_STATE.PLAYING_VIDEO || currentState === APP_STATE.PLAYING_AUDIO;\r\n  if (!hasBufferDuration && usesVideoElement && videoElement && videoElement.readyState < 1) return;\r\n\r\n  const duration = hasBufferDuration\r\n    ? _currentAudioBuffer!.duration\r\n    : (videoElement ? videoElement.duration : 0);\r\n\r\n  if (!duration || !Number.isFinite(duration) || duration <= 0.5) return;\r\n  if (!videoElement) return;\r\n  if (isIdleOrPaused(currentState)) return;\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  const curr = getTrackPosition();\r\n  const isSeeking = getState<boolean>('player.isSeeking');\r\n  if (isSeeking) {\r\n    log.debug('[handleEnded] Ignoring end signal while seeking');\r\n    return;\r\n  }\r\n\r\n  if (curr >= duration - 0.2) {\r\n    log.debug(`Track ended at ${curr.toFixed(2)}s / ${duration.toFixed(2)}s`);\r\n    stopAllMedia();\r\n    setState('player.pausedAt', 0);\r\n    bus.emit('ui:seek-reset');\r\n\r\n    // Auto-advance via playlist module\r\n    bus.emit('player:ended');\r\n  }\r\n}\r\n\r\n//  Toggle Play \r\n\r\nexport function togglePlay(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n  if (hostConn && !isOperator) {\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  const currentState = getState<string>('appState');\r\n\r\n  // YouTube mode\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:toggle-play');\r\n    return;\r\n  }\r\n\r\n  const isActuallyPlaying = currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO;\r\n  const pausedAt = getState<number>('player.pausedAt') || 0;\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n  // Cancel pending auto-play (with user feedback)\r\n  if (!hostConn && getManagedTimer('autoPlayTimer')) {\r\n    clearManagedTimer('autoPlayTimer');\r\n    bus.emit('ui:show-toast', '  ');\r\n  }\r\n\r\n  if (isActuallyPlaying) {\r\n    if (!hostConn) {\r\n      pause();\r\n      broadcast({ type: MSG.PAUSE, time: getState<number>('player.pausedAt') });\r\n    } else if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_PAUSE });\r\n    }\r\n  } else {\r\n    if (!hostConn) {\r\n      play(pausedAt);\r\n      broadcast({ type: MSG.PLAY, time: pausedAt, index: currentTrackIndex });\r\n      requestGlobalResyncDelayed();\r\n    } else if (isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_PLAY, time: pausedAt });\r\n    }\r\n  }\r\n}\r\n\r\n//  Stop Playback \r\n\r\nexport function stopPlayback(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n\r\n  if (hostConn && !isOperator) {\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  if (hostConn && isOperator) {\r\n    try { hostConn.send({ type: MSG.REQUEST_SEEK, time: 0 }); } catch { /* noop */ }\r\n    try { hostConn.send({ type: MSG.REQUEST_PAUSE }); } catch { /* noop */ }\r\n    bus.emit('ui:show-toast', '  ');\r\n    return;\r\n  }\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:stop-playback');\r\n    setState('player.pausedAt', 0);\r\n    updatePlayState(false);\r\n    return;\r\n  }\r\n\r\n  stopAllMedia();\r\n  bus.emit('ui:seek-reset');\r\n\r\n  if (!hostConn) broadcast({ type: MSG.PAUSE, time: 0 });\r\n  bus.emit('ui:show-toast', '');\r\n}\r\n\r\n//  Skip Time \r\n\r\nexport function skipTime(sec: number): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n\r\n  if (hostConn && !isOperator) {\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  if (hostConn && isOperator) {\r\n    hostConn.send({ type: MSG.REQUEST_SKIP_TIME, sec });\r\n    return;\r\n  }\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:skip-time', sec);\r\n    return;\r\n  }\r\n\r\n  const current = getTrackPosition();\r\n  let target = current + sec;\r\n  const videoElement = getVideoElement();\r\n  const duration = (_currentAudioBuffer?.duration)\r\n    ?? (videoElement && isFinite(videoElement.duration) ? videoElement.duration : 0);\r\n\r\n  if (target < 0) target = 0;\r\n  if (duration > 0 && target > duration) target = duration;\r\n\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const isPlaying = currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO;\r\n\r\n  if (isPlaying) {\r\n    play(target);\r\n    broadcast({ type: MSG.PLAY, time: target, index: currentTrackIndex });\r\n    requestGlobalResyncDelayed();\r\n  } else {\r\n    setState('player.pausedAt', target);\r\n    broadcast({ type: MSG.PAUSE, time: target });\r\n  }\r\n}\r\n\r\n//  Adjust Sync \r\n\r\nexport function adjustSync(val: number): void {\r\n  const localOffset = getState<number>('sync.localOffset') || 0;\r\n  setState('sync.localOffset', localOffset + val);\r\n  bus.emit('sync:display-update');\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (!isIdleOrPaused(currentState)) {\r\n    play(getTrackPosition());\r\n  } else {\r\n    const pausedAt = getState<number>('player.pausedAt') || 0;\r\n    setState('player.pausedAt', pausedAt + val);\r\n  }\r\n}\r\n\r\n//  Check Video Sync \r\n\r\nexport function checkVideoSync(): void {\r\n  const currentState = getState<string>('appState');\r\n  if (isIdleOrPaused(currentState) || currentState === APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  const videoElement = getVideoElement();\r\n  if (!videoElement?.src) return;\r\n\r\n  const targetTime = getTrackPosition();\r\n  const actualTime = videoElement.currentTime;\r\n  const drift = Math.abs(actualTime - targetTime);\r\n\r\n  if (drift > 0.3) {\r\n    if (videoElement.seeking) return;\r\n    log.debug(`[SyncCheck] Correcting video drift: ${drift.toFixed(3)}s`);\r\n\r\n    if (drift >= 1.9 && videoElement.paused) {\r\n      log.warn('[SyncCheck] Video appears frozen. Attempting kickstart...');\r\n      videoElement.play().catch(() => { /* noop */ });\r\n    }\r\n\r\n    videoElement.currentTime = targetTime;\r\n  }\r\n}\r\n\r\n//  Load And Broadcast File (Host) \r\n\r\nexport async function loadAndBroadcastFile(\r\n  file: File,\r\n  sessionId: number | null = null,\r\n  _skipTabSync = false,\r\n  loadToken?: number,\r\n): Promise<void> {\r\n  _activeLoadSessionId++;\r\n  const myLoadId = _activeLoadSessionId;\r\n  const myToken = loadToken ?? _currentLoadToken;\r\n\r\n  bus.emit('ui:show-loader', true, ` : ${file.name}`);\r\n  stopAllMedia();\r\n\r\n  const appState = getState<string>('appState');\r\n  if (appState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:stop-mode');\r\n  }\r\n\r\n  try {\r\n    await initAudio();\r\n    if (Tone.context.state === 'suspended') await Tone.start();\r\n\r\n    const url = BlobURLManager.create(file) || '';\r\n    setState('files.currentFileBlob', file);\r\n\r\n    log.debug('[BufferMode] Decoding audio for high-precision sync...');\r\n    bus.emit('ui:show-toast', ' :   ');\r\n\r\n    // Decode audio\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);\r\n\r\n    // Re-verify after async decode\r\n    if (loadToken !== undefined && _currentLoadToken !== myToken) {\r\n      if (myLoadId === _activeLoadSessionId) {\r\n        log.warn('[Load] Token mismatch after decode. Aborting stale load.');\r\n        bus.emit('ui:show-loader', false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Dispose old buffer\r\n    if (_currentAudioBuffer) {\r\n      _currentAudioBuffer = null;\r\n    }\r\n\r\n    if (myLoadId !== _activeLoadSessionId) {\r\n      log.debug('[Load] Stale loading session detected. Aborting.');\r\n      return;\r\n    }\r\n\r\n    // Load into state\r\n    _currentAudioBuffer = audioBuffer;\r\n    log.debug(`[BufferMode] Loaded ${audioBuffer.duration.toFixed(2)}s into RAM.`);\r\n\r\n    // Emit duration immediately from decoded buffer (primary source)\r\n    if (audioBuffer.duration && isFinite(audioBuffer.duration)) {\r\n      bus.emit('ui:duration-update', audioBuffer.duration);\r\n    }\r\n\r\n    // Visual sync\r\n    const videoElement = getVideoElement();\r\n    if (videoElement) {\r\n      videoElement.src = url;\r\n      videoElement.muted = true;\r\n    }\r\n\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n    setState('transfer.meta', { name: file.name, type: file.type, index: currentTrackIndex });\r\n\r\n    bus.emit('ui:update-playlist');\r\n\r\n    if (videoElement) {\r\n      const onMetaLoaded = () => {\r\n        videoElement.removeEventListener('loadedmetadata', onMetaLoaded);\r\n        if (myLoadId !== _activeLoadSessionId) return;\r\n        const dur = _currentAudioBuffer ? _currentAudioBuffer.duration : videoElement.duration;\r\n        if (dur && isFinite(dur)) {\r\n          bus.emit('ui:duration-update', dur);\r\n        }\r\n        BlobURLManager.confirm();\r\n      };\r\n      videoElement.addEventListener('loadedmetadata', onMetaLoaded);\r\n      videoElement.load();\r\n    }\r\n\r\n    // Enable play button\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    bus.emit('ui:play-btn-state', !(hostConn && !isOperator));\r\n\r\n    // Broadcast file to peers\r\n    const connectedPeers = getState<unknown[]>('network.connectedPeers') || [];\r\n    if (connectedPeers.length > 0 && sessionId) {\r\n      bus.emit('ui:show-toast', '  ');\r\n      broadcastFile(file, sessionId);\r\n    }\r\n\r\n    if (!hostConn) {\r\n      schedulePreload();\r\n    }\r\n  } catch (err: unknown) {\r\n    log.error(err);\r\n    bus.emit('ui:show-toast', `Load Failed: ${(err as Error).message}`);\r\n  } finally {\r\n    if (myLoadId === _activeLoadSessionId) {\r\n      bus.emit('ui:show-loader', false);\r\n      setState('player.pausedAt', 0);\r\n      updatePlayState(false);\r\n    }\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    bus.emit('ui:play-btn-state', !hostConn || isOperator);\r\n  }\r\n}\r\n\r\n//  Load Preloaded Track \r\n\r\nexport async function loadPreloadedTrack(\r\n  expectedIndex?: number,\r\n  loadToken?: number,\r\n): Promise<void> {\r\n  const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const targetIndex = expectedIndex ?? (nextMeta?.index as number) ?? currentTrackIndex;\r\n  const myToken = loadToken ?? _currentLoadToken;\r\n  const localBlob = getState<Blob | null>('preload.nextFileBlob');\r\n  const localMeta = nextMeta ? { ...nextMeta } : null;\r\n\r\n  if (!localBlob) {\r\n    log.warn('[Preload] No preloaded blob found in cache!');\r\n    return;\r\n  }\r\n\r\n  _playPreloadedInProgress = true;\r\n\r\n  try {\r\n    await initAudio();\r\n\r\n    if (expectedIndex !== undefined && currentTrackIndex !== -1 && currentTrackIndex !== targetIndex) {\r\n      log.warn(`[Preload] Index mismatch! Expected ${targetIndex}, current is ${currentTrackIndex}. Aborting.`);\r\n      return;\r\n    }\r\n\r\n    // Dispose old buffer\r\n    if (_currentAudioBuffer) {\r\n      _currentAudioBuffer = null;\r\n    }\r\n\r\n    log.debug('[Preload] Decoding audio for Buffer Mode...');\r\n    bus.emit('ui:show-toast', '  ...');\r\n\r\n    const arrayBuffer = await localBlob.arrayBuffer();\r\n    const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);\r\n\r\n    // Re-verify after async decode\r\n    if (loadToken !== undefined && _currentLoadToken !== myToken) {\r\n      log.warn('[Preload] Token mismatch after decode. Discarding.');\r\n      return;\r\n    }\r\n    if (expectedIndex !== undefined && currentTrackIndex !== -1 &&\r\n        getState<number>('playlist.currentTrackIndex') !== targetIndex) {\r\n      log.warn('[Preload] Track changed during decode. Discarding.');\r\n      return;\r\n    }\r\n\r\n    const activeMeta = localMeta || getState<Record<string, unknown>>('transfer.meta');\r\n\r\n    // Update global state\r\n    setState('files.currentFileBlob', localBlob);\r\n    setState('transfer.meta', activeMeta);\r\n    _currentAudioBuffer = audioBuffer;\r\n    log.debug(`[BufferMode] Preloaded ${audioBuffer.duration.toFixed(2)}s decoded.`);\r\n\r\n    const isVideo = isMediaVideo(localBlob, activeMeta);\r\n    setEngineMode(isVideo ? 'video' : 'buffer');\r\n\r\n    // Visual sync\r\n    const url = BlobURLManager.create(localBlob) || '';\r\n    const videoElement = getVideoElement();\r\n    if (videoElement) {\r\n      videoElement.src = url;\r\n      videoElement.muted = true;\r\n    }\r\n\r\n    const dur = audioBuffer.duration;\r\n    if (isFinite(dur)) {\r\n      bus.emit('ui:duration-update', dur);\r\n    }\r\n    BlobURLManager.confirm();\r\n\r\n    if (videoElement) videoElement.load();\r\n\r\n    // Clear preload state\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n    setState('preload.nextTrackIndex', -1);\r\n    log.debug('[Preload] Safe clear: nextFileBlob moved to current.');\r\n\r\n    // Reset transfer guards\r\n    setState('transfer.skipIncomingFile', true);\r\n    setState('transfer.waitingForPreload', false);\r\n    clearManagedTimer('prepareWatchdog');\r\n    clearManagedTimer('chunkWatchdog');\r\n    clearManagedTimer('preloadWatchdog');\r\n\r\n    // Request sync from host after settle\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn?.open) {\r\n      setTimeout(() => {\r\n        if (hostConn.open) hostConn.send({ type: MSG.GET_SYNC_TIME });\r\n      }, 500);\r\n    }\r\n\r\n    _playPreloadedInProgress = false;\r\n\r\n    // Consume pending play time\r\n    const localOffset = getState<number>('sync.localOffset') || 0;\r\n    const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n    if (hostConn && _pendingPlayTime !== undefined) {\r\n      const target = _pendingPlayTime + localOffset + autoSyncOffset;\r\n      log.debug(`[Preload] Found pending play time, starting at ${target.toFixed(2)}s`);\r\n      play(target);\r\n      _pendingPlayTime = undefined;\r\n    }\r\n\r\n  } catch (e: unknown) {\r\n    _playPreloadedInProgress = false;\r\n    log.error('[Preload] Activation failed:', e);\r\n    bus.emit('ui:show-toast', '   -  ');\r\n\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n    setState('preload.nextTrackIndex', -1);\r\n    setState('transfer.skipIncomingFile', false);\r\n    setState('transfer.waitingForPreload', false);\r\n    clearManagedTimer('preloadWatchdog');\r\n\r\n    // Request recovery from host\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const playlist = getState<unknown[]>('playlist.items') || [];\r\n    const meta = getState<Record<string, unknown>>('transfer.meta');\r\n    const idx = getState<number>('playlist.currentTrackIndex');\r\n    const name = (playlist[idx] as Record<string, string>)?.name || (meta?.name as string) || '';\r\n    if (hostConn?.open) {\r\n      hostConn.send({ type: MSG.REQUEST_CURRENT_FILE, name, index: idx, reason: 'preload_activation_failed' });\r\n    }\r\n  }\r\n}\r\n\r\n//  Network Message Handlers \r\n\r\nfunction handlePlayMsg(data: Record<string, unknown>): void {\r\n  const time = Number(data.time) || 0;\r\n  const incomingIndex = data.index as number | undefined;\r\n\r\n  // Guard: If loadPreloadedTrack is in progress, queue the play time\r\n  if (_playPreloadedInProgress) {\r\n    _pendingPlayTime = time;\r\n    log.debug(`[Guest] Preload in progress, queuing play time: ${time}`);\r\n    return;\r\n  }\r\n\r\n  // Index-mismatch recovery: Host sent PLAY for a different track\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  if (incomingIndex !== undefined && incomingIndex !== currentTrackIndex) {\r\n    log.warn(`[Guest] Index mismatch: current=${currentTrackIndex}, play=${incomingIndex}`);\r\n    _pendingPlayTime = time;\r\n    setState('playlist.currentTrackIndex', incomingIndex);\r\n    bus.emit('ui:update-playlist');\r\n\r\n    // Check if preloaded track matches\r\n    const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n    const nextTrackIndex = getState<number>('preload.nextTrackIndex');\r\n    if (nextFileBlob && nextTrackIndex === incomingIndex) {\r\n      log.debug(`[Guest] Found preloaded track for index ${incomingIndex}`);\r\n      _currentLoadToken++;\r\n      loadPreloadedTrack(incomingIndex, _currentLoadToken);\r\n      return;\r\n    }\r\n\r\n    // No preload  request file from host\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const name = playlist[incomingIndex]?.name || '';\r\n    if (hostConn?.open) {\r\n      hostConn.send({ type: MSG.REQUEST_CURRENT_FILE, name, index: incomingIndex, reason: 'index_mismatch' });\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Stale audio guard: verify loaded file matches expected name\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  const expectedName = (data.name as string) || playlist[currentTrackIndex]?.name || '';\r\n  const loadedName = (meta?.name as string) || '';\r\n  if (expectedName && loadedName && expectedName !== loadedName) {\r\n    if (incomingIndex !== undefined && incomingIndex !== currentTrackIndex) {\r\n      log.warn(`[Guest] Stale audio detected: loaded=${loadedName}, expected=${expectedName}`);\r\n      _pendingPlayTime = time;\r\n      return;\r\n    }\r\n  }\r\n\r\n  if (_currentAudioBuffer || getVideoElement()?.src) {\r\n    play(time);\r\n  } else {\r\n    _pendingPlayTime = time;\r\n    log.debug(`[Guest] Storing pending play time: ${time}`);\r\n  }\r\n}\r\n\r\nfunction handlePauseMsg(data: Record<string, unknown>): void {\r\n  const time = Number(data.time) || 0;\r\n  pause(time);\r\n}\r\n\r\nfunction handleRequestPlay(data: Record<string, unknown>, conn: DataConnection): void {\r\n  // Host handles OP's request to play\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Only Host executes\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playback] Rejected request-play from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  clearManagedTimer('autoPlayTimer');\r\n  const pausedAt = getState<number>('player.pausedAt') || 0;\r\n  const time = Number(data.time) || pausedAt;\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n  play(time);\r\n  broadcast({ type: MSG.PLAY, time, index: currentTrackIndex });\r\n  requestGlobalResyncDelayed();\r\n}\r\n\r\nfunction handleRequestPause(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playback] Rejected request-pause from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  clearManagedTimer('autoPlayTimer');\r\n  pause();\r\n  broadcast({ type: MSG.PAUSE, time: getState<number>('player.pausedAt') });\r\n}\r\n\r\nfunction handleRequestSeek(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playback] Rejected request-seek from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  const time = Number(data.time) || 0;\r\n  const currentState = getState<string>('appState');\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n  // YouTube seek\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:seek-to', time);\r\n    return;\r\n  }\r\n\r\n  if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n    play(time);\r\n    broadcast({ type: MSG.PLAY, time, index: currentTrackIndex });\r\n  } else {\r\n    setState('player.pausedAt', time);\r\n    const videoElement = getVideoElement();\r\n    if (videoElement) try { videoElement.currentTime = time; } catch { /* noop */ }\r\n    broadcast({ type: MSG.PAUSE, time });\r\n  }\r\n  requestGlobalResyncDelayed();\r\n}\r\n\r\nfunction handleRequestSkipTime(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playback] Rejected request-skip-time from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  const sec = Number(data.sec) || 0;\r\n  skipTime(sec);\r\n}\r\n\r\nfunction handleForceSyncPlay(data: Record<string, unknown>): void {\r\n  const t = Number(data.time) || 0;\r\n  bus.emit('ui:show-toast', `Host  : ${fmtTime(t)}`);\r\n  play(t);\r\n}\r\n\r\n//  Status Sync (Late Joiner / Reconnect Full State Sync) \r\n\r\nasync function handleStatusSync(data: Record<string, unknown>): Promise<void> {\r\n  if (!validateMessage(data, ['playlistMeta', 'currentTrackIndex'])) return;\r\n\r\n  const playlistMeta = data.playlistMeta as Array<Record<string, unknown>>;\r\n  const hostTrackIndex = Number(data.currentTrackIndex);\r\n  const currentState = getState<string>('appState');\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n\r\n  // Empty playlist  clear local state\r\n  if (!playlistMeta || playlistMeta.length === 0) {\r\n    if (playlist.length === 0 && currentState === APP_STATE.IDLE) return;\r\n    log.debug('[StatusSync] Received empty playlist, clearing local state');\r\n    setState('playlist.items', []);\r\n    setState('playlist.currentTrackIndex', -1);\r\n    bus.emit('ui:update-playlist');\r\n    stopAllMedia();\r\n    return;\r\n  }\r\n\r\n  // Sync repeat/shuffle modes (silent = no toast)\r\n  if (data.repeatMode !== undefined) {\r\n    const current = getState<number>('playlist.repeatMode') || 0;\r\n    if (Number(data.repeatMode) !== current) {\r\n      bus.emit('playlist:set-repeat-mode', Number(data.repeatMode), false);\r\n    }\r\n  }\r\n  if (data.isShuffle !== undefined) {\r\n    const current = getState<boolean>('playlist.isShuffle');\r\n    if (!!data.isShuffle !== current) {\r\n      bus.emit('playlist:set-shuffle', !!data.isShuffle, false);\r\n    }\r\n  }\r\n\r\n  // Sync playlist structure if different\r\n  const isPlaylistDifferent = playlist.length !== playlistMeta.length ||\r\n    playlist.some((it, i) => it.name !== (playlistMeta[i]?.name as string));\r\n  if (isPlaylistDifferent) {\r\n    log.debug('[StatusSync] Playlist out of sync, updating...');\r\n    setState('playlist.items', playlistMeta as unknown as PlaylistItem[]);\r\n    bus.emit('ui:update-playlist');\r\n  }\r\n\r\n  // Sync track index  trigger recovery if needed\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  if (hostTrackIndex !== -1 && hostTrackIndex !== currentTrackIndex) {\r\n    log.debug(`[StatusSync] Index mismatch: Host(${hostTrackIndex}) vs Me(${currentTrackIndex}). Correcting...`);\r\n\r\n    stopAllMedia();\r\n    setState('playlist.currentTrackIndex', hostTrackIndex);\r\n    bus.emit('ui:update-playlist');\r\n\r\n    const updatedPlaylist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const item = updatedPlaylist[hostTrackIndex];\r\n\r\n    if (item && item.type !== 'youtube') {\r\n      const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n      const hasBlob = !!(currentFileBlob && currentFileBlob.size > 0);\r\n      const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n      const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n      const isPreloaded = !!(nextFileBlob && nextMeta &&\r\n        ((nextMeta.index as number) === hostTrackIndex || (nextMeta.name as string) === item.name));\r\n\r\n      // If preloaded, use immediately\r\n      if (!hasBlob && isPreloaded) {\r\n        log.debug('[StatusSync] Required track found in preload cache. Activating...');\r\n        _currentLoadToken++;\r\n        await loadPreloadedTrack(hostTrackIndex, _currentLoadToken);\r\n        return;\r\n      }\r\n\r\n      // Track missing  request recovery from host\r\n      const meta = getState<Record<string, unknown>>('transfer.meta');\r\n      const isWrongBlob = hasBlob && meta && (meta.name as string) !== item.name;\r\n      if (!hasBlob || isWrongBlob) {\r\n        log.debug('[StatusSync] Current track missing, requesting from host:', item.name);\r\n        bus.emit('ui:show-loader', true, `  : ${item.name}`);\r\n\r\n        if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n          bus.emit('youtube:stop-mode');\r\n        }\r\n\r\n        const hostConn = getState<DataConnection | null>('network.hostConn');\r\n        if (hostConn?.open) {\r\n          const jitter = Math.random() * 1000 + 200;\r\n          setTimeout(() => {\r\n            if (!hostConn?.open) return;\r\n            const alreadyGotIt = getState<Blob | null>('files.currentFileBlob') ||\r\n              getState<Blob | null>('preload.nextFileBlob');\r\n            const idx = getState<number>('playlist.currentTrackIndex');\r\n            if (idx === hostTrackIndex && !alreadyGotIt) {\r\n              hostConn.send({\r\n                type: MSG.REQUEST_DATA_RECOVERY,\r\n                nextChunk: 0,\r\n                fileName: item.name,\r\n                index: hostTrackIndex,\r\n              });\r\n            } else if (alreadyGotIt) {\r\n              log.debug('[StatusSync] Aborting recovery: file arrived during jitter');\r\n              bus.emit('ui:show-loader', false);\r\n            }\r\n          }, jitter);\r\n        }\r\n      }\r\n    } else if (item && item.type === 'youtube') {\r\n      if (currentState !== APP_STATE.PLAYING_YOUTUBE && item.videoId) {\r\n        log.debug('[StatusSync] Switching to YouTube mode for late-joiner sync');\r\n        bus.emit('youtube:load', item.videoId, item.playlistId || null, true, 0);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n//  Clear Previous Track State \r\n\r\nfunction clearPreviousTrackState(reason = ''): void {\r\n  log.debug(`[State Clear] Clearing previous track state. Reason: ${reason}`);\r\n\r\n  // Edge Case: skip redundant clears for same track\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  const trackName = playlist[currentTrackIndex]?.name || (meta?.name as string) || '';\r\n  const win = window as unknown as Record<string, unknown>;\r\n  if (reason === 'redundant-sync' && trackName && win._lastClearedTrackName === trackName) {\r\n    log.debug(`[State Clear] Skipping redundant clear for: ${trackName}`);\r\n    return;\r\n  }\r\n  win._lastClearedTrackName = trackName;\r\n\r\n  // Stop timers\r\n  clearManagedTimer('chunkWatchdog');\r\n  clearManagedTimer('prepareWatchdog');\r\n\r\n  // Clear relay queues\r\n  setState('relay.chunkQueue', []);\r\n\r\n  // Reset transfer state\r\n  setState('transfer.receivedCount', 0);\r\n  setState('transfer.meta', {});\r\n  setState('files.currentFileBlob', null);\r\n\r\n  if (reason === 'redundant-sync') return;\r\n\r\n  // CRITICAL: Clear audio buffer to prevent previous track from replaying\r\n  if (_currentAudioBuffer) {\r\n    log.debug('[State Clear] Clearing currentAudioBuffer');\r\n    _currentAudioBuffer = null;\r\n  }\r\n  stopPlayerNode();\r\n  setState('transfer.skipIncomingFile', false);\r\n  _pendingPlayTime = undefined;\r\n\r\n  // Reset state to IDLE\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO || currentState === APP_STATE.PAUSED) {\r\n    setState('appState', APP_STATE.IDLE);\r\n    bus.emit('player:state-changed', APP_STATE.IDLE);\r\n  }\r\n\r\n  // Clear preload ack tracking\r\n  const ackSent = getState<Set<number>>('preload.ackSent');\r\n  if (ackSent) ackSent.clear();\r\n\r\n  BlobURLManager.revoke();\r\n\r\n  const videoElement = getVideoElement();\r\n  if (videoElement) {\r\n    videoElement.pause();\r\n    videoElement.src = '';\r\n    videoElement.load();\r\n  }\r\n  try { BlobURLManager.flushDeferred('clearPreviousTrackState'); } catch { /* noop */ }\r\n\r\n  // Physically delete OLD current file from OPFS\r\n  const opfsFilename = getState<{ name: string | null }>('files.currentFileOpfs');\r\n  if (opfsFilename.name) {\r\n    const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n    const isActuallyChanging = opfsFilename.name !== nextMeta?.name;\r\n    if (isActuallyChanging) {\r\n      postWorkerCommand({ command: 'OPFS_RESET', isPreload: false });\r\n      cleanupOPFSInWorker(opfsFilename.name, false);\r\n      opfsFilename.name = null;\r\n    }\r\n  }\r\n}\r\n\r\n//  Finalize Guest File (after OPFS download) \r\n\r\nasync function finalizeGuestFile(file: File | Blob): Promise<void> {\r\n  log.debug('[Guest] Finalizing with Buffer Mode...');\r\n  bus.emit('ui:show-loader', true, '   ...');\r\n\r\n  try {\r\n    await initAudio();\r\n    if (Tone.context.state === 'suspended') await Tone.start();\r\n\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);\r\n\r\n    if (_currentAudioBuffer) {\r\n      _currentAudioBuffer = null;\r\n    }\r\n    _currentAudioBuffer = audioBuffer;\r\n\r\n    const meta = getState<Record<string, unknown>>('transfer.meta');\r\n    const isVideo = isMediaVideo(file, meta);\r\n    setEngineMode(isVideo ? 'video' : 'buffer');\r\n\r\n    setState('files.currentFileBlob', file);\r\n\r\n    const url = BlobURLManager.create(file) || '';\r\n    const videoElement = getVideoElement();\r\n    if (videoElement) {\r\n      videoElement.src = url;\r\n      videoElement.muted = true;\r\n    }\r\n\r\n    if (audioBuffer.duration && isFinite(audioBuffer.duration)) {\r\n      bus.emit('ui:duration-update', audioBuffer.duration);\r\n    }\r\n    BlobURLManager.confirm();\r\n\r\n    if (videoElement) {\r\n      const onMetaLoaded = () => {\r\n        videoElement.removeEventListener('loadedmetadata', onMetaLoaded);\r\n        const dur = _currentAudioBuffer ? _currentAudioBuffer.duration : videoElement.duration;\r\n        if (dur && isFinite(dur)) bus.emit('ui:duration-update', dur);\r\n      };\r\n      videoElement.addEventListener('loadedmetadata', onMetaLoaded);\r\n      videoElement.load();\r\n    }\r\n\r\n    // Reset guards\r\n    setState('transfer.state', 'READY');\r\n    setState('transfer.skipIncomingFile', false);\r\n    clearManagedTimer('prepareWatchdog');\r\n    clearManagedTimer('chunkWatchdog');\r\n\r\n    // Consume pending play time\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn && _pendingPlayTime !== undefined) {\r\n      const localOffset = getState<number>('sync.localOffset') || 0;\r\n      const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n      const target = _pendingPlayTime + localOffset + autoSyncOffset;\r\n      log.debug(`[Guest] Found pending play time after download, starting at ${target.toFixed(2)}s`);\r\n      play(target);\r\n      _pendingPlayTime = undefined;\r\n    }\r\n\r\n    bus.emit('ui:play-btn-state', true);\r\n  } catch (err: unknown) {\r\n    log.error('[Guest] Decoding failed', err);\r\n    bus.emit('ui:show-toast', '  !  .');\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const name = playlist[currentTrackIndex]?.name || '';\r\n    if (hostConn?.open) {\r\n      hostConn.send({ type: MSG.REQUEST_CURRENT_FILE, name, index: currentTrackIndex, reason: 'decoding_failed' });\r\n    }\r\n  } finally {\r\n    bus.emit('ui:show-loader', false);\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initPlayback(): void {\r\n  registerHandlers({\r\n    [MSG.PLAY]: handlePlayMsg,\r\n    [MSG.PAUSE]: handlePauseMsg,\r\n    [MSG.REQUEST_PLAY]: handleRequestPlay,\r\n    [MSG.REQUEST_PAUSE]: handleRequestPause,\r\n    [MSG.REQUEST_SEEK]: handleRequestSeek,\r\n    [MSG.REQUEST_SKIP_TIME]: handleRequestSkipTime,\r\n    [MSG.FORCE_SYNC_PLAY]: handleForceSyncPlay,\r\n    [MSG.STATUS_SYNC]: handleStatusSync,\r\n  });\r\n\r\n  // Video sync timer tick\r\n  bus.on('worker:timer-tick', ((...args: unknown[]) => {\r\n    if (args[0] === 'video-sync') checkVideoSync();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Stop all media (called from youtube player before loading)\r\n  bus.on('player:stop-all-media', (() => {\r\n    stopAllMedia();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Sync: provide current track position via callback pattern\r\n  bus.on('sync:get-position', ((...args: unknown[]) => {\r\n    const callback = args[0] as ((pos: number) => void) | undefined;\r\n    if (typeof callback === 'function') {\r\n      callback(getTrackPosition());\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Sync: handle sync response from host (apply time + play/pause)\r\n  bus.on('sync:response', ((...args: unknown[]) => {\r\n    const hostTime = Number(args[0]) || 0;\r\n    const isPlaying = args[1] as boolean;\r\n    const oneWayLatency = Number(args[2]) || 0;\r\n\r\n    const localOffset = getState<number>('sync.localOffset') || 0;\r\n    const compensatedTime = hostTime + oneWayLatency + localOffset;\r\n\r\n    if (isPlaying) {\r\n      if (_currentAudioBuffer || getVideoElement()?.src) {\r\n        play(compensatedTime);\r\n      } else {\r\n        setState('player.pausedAt', compensatedTime);\r\n        log.debug('[Sync] Host playing but no audio data yet, storing position');\r\n      }\r\n    } else {\r\n      if (_pendingPlayTime !== undefined) {\r\n        setState('player.pausedAt', compensatedTime);\r\n        log.debug('[Sync] Host paused, keeping pending play');\r\n        return;\r\n      }\r\n      stopAllMedia();\r\n      setState('player.pausedAt', compensatedTime);\r\n    }\r\n\r\n    const usePingCompensation = getState<boolean>('sync.usePingCompensation');\r\n    const lastLatencyMs = getState<number>('sync.lastLatencyMs') || 0;\r\n    if (usePingCompensation) {\r\n      bus.emit('ui:show-toast', `   , +${Math.round(lastLatencyMs / 2)}ms`);\r\n    } else {\r\n      bus.emit('ui:show-toast', '   ( )');\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Sync: apply nudge offset by re-seeking\r\n  bus.on('sync:nudge-apply', ((..._args: unknown[]) => {\r\n    const currentState = getState<string>('appState');\r\n    if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n      play(getTrackPosition());\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Surround mode toggled during playback: restart at current position\r\n  bus.on('audio:surround-toggled', (() => {\r\n    const currentState = getState<string>('appState');\r\n    if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n      play(getTrackPosition());\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Safety polling: periodically check if track ended (called from UI loop)\r\n  bus.on('player:check-ended', (() => {\r\n    handleEnded();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Clear previous track state (called from transfer module during track switch)\r\n  bus.on('storage:clear-previous-track', ((...args: unknown[]) => {\r\n    const reason = (args[0] as string) || '';\r\n    clearPreviousTrackState(reason);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // OPFS file ready: finalize guest download processing\r\n  bus.on('opfs:file-ready', (async (...args: unknown[]) => {\r\n    const filename = args[0] as string;\r\n    const _sessionId = args[1] as number;\r\n    const isPreload = args[2] as boolean;\r\n\r\n    if (isPreload) {\r\n      // Preload files are handled by preload module via storage:preload-file-ready\r\n      bus.emit('storage:preload-file-ready', filename, _sessionId);\r\n      return;\r\n    }\r\n\r\n    // Only guest processes OPFS files (Host loads directly)\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) return;\r\n\r\n    const file = await readFileFromOpfs(filename, false);\r\n    if (!file) {\r\n      log.error('[Playback] Failed to read OPFS file:', filename);\r\n      bus.emit('ui:show-loader', false);\r\n      return;\r\n    }\r\n\r\n    await finalizeGuestFile(file);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Use preloaded track (skip download, decode from preload cache)\r\n  bus.on('storage:use-preloaded', ((...args: unknown[]) => {\r\n    const index = args[0] as number;\r\n    const _name = args[1] as string;\r\n\r\n    log.debug(`[Playback] Using preloaded track for index: ${index} (${_name})`);\r\n    setState('transfer.skipIncomingFile', true);\r\n    setState('transfer.waitingForPreload', true);\r\n\r\n    // Try to activate immediately if blob is already available\r\n    const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n    if (nextFileBlob) {\r\n      setState('transfer.waitingForPreload', false);\r\n      _currentLoadToken++;\r\n      loadPreloadedTrack(index, _currentLoadToken);\r\n    } else {\r\n      // Blob not ready yet  set watchdog, will be triggered by opfs:file-ready preload path\r\n      log.debug('[Playback] Preload blob not ready yet, waiting...');\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Transfer progress (update loader UI)\r\n  bus.on('storage:transfer-progress', ((...args: unknown[]) => {\r\n    const percent = args[0] as number;\r\n    bus.emit('ui:show-loader', true, ` ... ${percent}%`);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Preloaded file activated from OPFS (for play-preloaded flow)\r\n  bus.on('storage:play-preloaded', (async (...args: unknown[]) => {\r\n    const index = args[0] as number;\r\n    const _name = args[1] as string;\r\n\r\n    log.debug(`[Playback] Play preloaded track, index: ${index}`);\r\n    const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n    if (nextFileBlob) {\r\n      _currentLoadToken++;\r\n      await loadPreloadedTrack(index, _currentLoadToken);\r\n    } else {\r\n      log.warn('[Playback] No preloaded blob for play-preloaded, requesting from host');\r\n      bus.emit('ui:show-loader', true, '  ...');\r\n      clearPreviousTrackState('play-preloaded fallback');\r\n\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n      const trackName = _name || playlist[index]?.name || '';\r\n      if (hostConn?.open) {\r\n        const jitter = Math.random() * 1000 + 200;\r\n        setTimeout(() => {\r\n          if (!hostConn?.open) return;\r\n          const blob = getState<Blob | null>('preload.nextFileBlob');\r\n          if (!blob) {\r\n            hostConn.send({ type: MSG.REQUEST_CURRENT_FILE, name: trackName, index });\r\n          }\r\n        }, jitter);\r\n      }\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Host: Send playback state + current file to newly connected peer (late-join bootstrap)\r\n  bus.on('network:peer-connected', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection | null;\r\n    if (!conn?.open) return;\r\n\r\n    // Only Host bootstraps guests\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) return;\r\n\r\n    const currentState = getState<string>('appState');\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n    const playlist = getState<unknown[]>('playlist.items') || [];\r\n\r\n    // Send current file to late-joining guest (if local file is loaded)\r\n    if (currentTrackIndex >= 0 && playlist[currentTrackIndex]) {\r\n      const item = playlist[currentTrackIndex] as Record<string, unknown>;\r\n      if (item.type !== 'youtube') {\r\n        const currentFileBlob = getState<Blob | null>('files.currentFileBlob');\r\n        const currentSessionId = getState<number>('transfer.currentSessionId');\r\n        if (currentFileBlob) {\r\n          unicastFile(conn, currentFileBlob, 0, currentSessionId)\r\n            .catch((e: unknown) => log.error('[Host] unicastFile for late joiner failed', e));\r\n        }\r\n\r\n        // Also send preloaded next track\r\n        const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n        const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n        const nextTrackIndex = getState<number>('preload.nextTrackIndex');\r\n        if (nextFileBlob && nextMeta && nextTrackIndex >= 0) {\r\n          const preloadSid = (nextMeta.sessionId as number) || 0;\r\n          unicastPreload(conn, nextFileBlob, nextTrackIndex, preloadSid)\r\n            .catch((e: unknown) => log.error('[Host] unicastPreload for late joiner failed', e));\r\n        }\r\n      }\r\n    }\r\n\r\n    // Send playback state (time-sync for late joiners)\r\n    try {\r\n      const nowPos = getTrackPosition();\r\n\r\n      if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n        const item = (playlist[currentTrackIndex] as Record<string, unknown>) || {};\r\n        const itemName = (item.name || (item.file as File | undefined)?.name || null) as string | null;\r\n        conn.send({\r\n          type: MSG.PLAY,\r\n          time: nowPos,\r\n          index: currentTrackIndex,\r\n          name: itemName,\r\n          state: currentState,\r\n          timestamp: Date.now(),\r\n        });\r\n      } else if (currentState !== APP_STATE.PLAYING_YOUTUBE) {\r\n        // IDLE or PAUSED: Send pause to sync position\r\n        conn.send({\r\n          type: MSG.PAUSE,\r\n          time: nowPos,\r\n          index: currentTrackIndex,\r\n          state: currentState,\r\n          timestamp: Date.now(),\r\n        });\r\n      }\r\n      // YouTube state is handled by youtube/player.ts bootstrap\r\n      log.debug('[Playback] Bootstrap: sent playback state to new peer');\r\n    } catch (e) {\r\n      log.warn('[Playback] Bootstrap send failed:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Playback] Engine initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Playlist Management\r\n * Extracted from original app.js lines 3456-4062, 4272-4397\r\n *\r\n * Manages: playlist array, repeat/shuffle modes, playTrack,\r\n * playNextTrack, playPrevTrack, clearPreloadState.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, APP_STATE, DEMO_FILE_NAME, DEMO_TITLE } from '../core/constants.ts';\r\nimport { nextSessionId } from '../core/session.ts';\r\nimport { clearManagedTimer, setManagedTimer } from '../core/timers.ts';\r\nimport {\r\n  play, stopAllMedia, loadAndBroadcastFile, loadPreloadedTrack,\r\n  getTrackPosition, updatePlayState, incrementLoadToken,\r\n} from './playback.ts';\r\nimport { isIdleOrPaused } from './video.ts';\r\nimport { schedulePreload } from '../storage/preload.ts';\r\nimport {\r\n  setEQ, setPreamp, setStereoWidth, setVirtualBass, setReverbParam,\r\n} from '../audio/effects.ts';\r\nimport { postWorkerCommand } from '../storage/opfs.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport { requestGlobalResyncDelayed } from '../network/sync.ts';\r\nimport { registerHandlers, verifyOperator } from '../network/protocol.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n//  Repeat / Shuffle \r\n\r\nexport function toggleRepeat(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n  const repeatMode = getState<number>('playlist.repeatMode') || 0;\r\n  const nextMode = (repeatMode + 1) % 3;\r\n  setRepeatMode(nextMode);\r\n\r\n  if (!hostConn) {\r\n    broadcast({ type: MSG.REPEAT_MODE, value: nextMode });\r\n  } else if (isOperator) {\r\n    hostConn.send({ type: MSG.REQUEST_SETTING, settingType: 'repeat-mode', value: nextMode });\r\n  }\r\n}\r\n\r\nexport function setRepeatMode(mode: number, notify = true): void {\r\n  setState('playlist.repeatMode', mode);\r\n  const btn = document.getElementById('btn-repeat');\r\n  if (!btn) return;\r\n\r\n  btn.classList.remove('active', 'active-one');\r\n  if (mode === 1) {\r\n    btn.classList.add('active');\r\n    if (notify) bus.emit('ui:show-toast', ' : ');\r\n  } else if (mode === 2) {\r\n    btn.classList.add('active-one');\r\n    if (notify) bus.emit('ui:show-toast', ' :  ');\r\n  } else {\r\n    if (notify) bus.emit('ui:show-toast', ' : ');\r\n  }\r\n}\r\n\r\nexport function toggleShuffle(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n  const isShuffle = getState<boolean>('playlist.isShuffle');\r\n  const nextShuffle = !isShuffle;\r\n  setShuffle(nextShuffle);\r\n\r\n  if (!hostConn) {\r\n    broadcast({ type: MSG.SHUFFLE_MODE, value: nextShuffle });\r\n  } else if (isOperator) {\r\n    hostConn.send({ type: MSG.REQUEST_SETTING, settingType: 'shuffle-mode', value: nextShuffle });\r\n  }\r\n}\r\n\r\nexport function setShuffle(enabled: boolean, notify = true): void {\r\n  setState('playlist.isShuffle', enabled);\r\n  const btn = document.getElementById('btn-shuffle');\r\n  if (btn) btn.classList.toggle('active', enabled);\r\n  if (notify) bus.emit('ui:show-toast', enabled ? ': ' : ': ');\r\n}\r\n\r\n//  Clear Preload State \r\n\r\nexport function clearPreloadState(): void {\r\n  const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const isNextTrackActive = nextMeta && (Number(nextMeta.index) === currentTrackIndex);\r\n\r\n  setState('preload.nextTrackIndex', -1);\r\n  if (!isNextTrackActive) {\r\n    setState('preload.nextFileBlob', null);\r\n    setState('preload.meta', null);\r\n  }\r\n  setState('preload.isPreloading', false);\r\n\r\n  // Guest side\r\n  setState('preload.count', 0);\r\n  if (!isNextTrackActive) {\r\n    setState('preload.guestMeta', null);\r\n  }\r\n  setState('preload.skipIncoming', false);\r\n  setState('preload.opfsName', null);\r\n\r\n  postWorkerCommand({ command: 'OPFS_RESET', isPreload: true });\r\n}\r\n\r\n//  Play Track \r\n\r\nexport async function playTrack(index: number): Promise<void> {\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  if (index < 0 || index >= playlist.length) return;\r\n\r\n  clearManagedTimer('autoPlayTimer');\r\n\r\n  // Cancel in-flight preload\r\n  setState('preload.isPreloading', false);\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n\r\n  // Auto-switch to Play tab (Host only)\r\n  if (!hostConn) bus.emit('ui:switch-tab', 'play');\r\n\r\n  const myLoadToken = incrementLoadToken();\r\n\r\n  // Check if preloaded\r\n  const nextTrackIndex = getState<number>('preload.nextTrackIndex');\r\n  const nextFileBlob = getState<Blob | null>('preload.nextFileBlob');\r\n\r\n  if (index === nextTrackIndex && nextFileBlob && !hostConn) {\r\n    log.debug('[Host] Using Preloaded Track:', index);\r\n    setState('playlist.currentTrackIndex', index);\r\n    bus.emit('ui:update-playlist');\r\n    bus.emit('player:metadata-update', playlist[index]);\r\n\r\n    // Advance session ID for recovery\r\n    const nextMeta = getState<Record<string, unknown> | null>('preload.meta');\r\n    if (nextMeta?.sessionId && Number.isFinite(Number(nextMeta.sessionId))) {\r\n      setState('transfer.currentSessionId', Number(nextMeta.sessionId));\r\n    } else {\r\n      setState('transfer.currentSessionId', nextSessionId());\r\n    }\r\n\r\n    stopAllMedia();\r\n\r\n    const item = playlist[index];\r\n    const fileName = item?.file?.name || item?.name || `Track ${index}`;\r\n    broadcast({ type: MSG.PLAY_PRELOADED, index, name: fileName, mime: item?.file?.type });\r\n\r\n    await loadPreloadedTrack(index, myLoadToken);\r\n    await play(0);\r\n    broadcast({ type: MSG.PLAY, time: 0, index, name: fileName });\r\n    requestGlobalResyncDelayed();\r\n    schedulePreload();\r\n    return;\r\n  }\r\n\r\n  setState('playlist.currentTrackIndex', index);\r\n  bus.emit('ui:update-playlist');\r\n\r\n  const item = playlist[index];\r\n  bus.emit('player:metadata-update', item);\r\n\r\n  // YouTube\r\n  if (item.type === 'youtube') {\r\n    if (!hostConn) {\r\n      stopAllMedia();\r\n      broadcast({\r\n        type: MSG.YOUTUBE_PLAY,\r\n        videoId: item.videoId,\r\n        playlistId: item.playlistId,\r\n        name: item.name || item.title,\r\n        index,\r\n        autoplay: false,\r\n      });\r\n\r\n      const isFirstTrackLoad = getState<boolean>('player.isFirstTrackLoad');\r\n      if (isFirstTrackLoad) {\r\n        setState('player.isFirstTrackLoad', false);\r\n        bus.emit('youtube:load', item.videoId, item.playlistId, false);\r\n        bus.emit('ui:show-toast', 'YouTube !    .');\r\n      } else {\r\n        bus.emit('youtube:load', item.videoId, item.playlistId, false);\r\n        bus.emit('ui:show-toast', '3  YouTube ...');\r\n        setManagedTimer('autoPlayTimer', () => {\r\n          bus.emit('youtube:auto-play');\r\n        }, 3000);\r\n      }\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Local file playback\r\n  stopAllMedia();\r\n\r\n  const file = item.file;\r\n  if (!file) {\r\n    log.warn('[Playlist] No file for track', index);\r\n    return;\r\n  }\r\n\r\n  if (!hostConn) {\r\n    const sessionId = nextSessionId();\r\n    setState('transfer.currentSessionId', sessionId);\r\n\r\n    broadcast({ type: MSG.FILE_PREPARE, name: file.name, index, sessionId, mime: file.type });\r\n    await loadAndBroadcastFile(file, sessionId, false, myLoadToken);\r\n\r\n    const isFirstTrackLoad = getState<boolean>('player.isFirstTrackLoad');\r\n    if (isFirstTrackLoad) {\r\n      setState('player.isFirstTrackLoad', false);\r\n      bus.emit('ui:show-toast', ' !    .');\r\n    } else {\r\n      bus.emit('ui:show-toast', '3   ...');\r\n      setManagedTimer('autoPlayTimer', () => {\r\n        play(0);\r\n        const currentIdx = getState<number>('playlist.currentTrackIndex');\r\n        broadcast({ type: MSG.PLAY, time: 0, index: currentIdx, name: file.name });\r\n        requestGlobalResyncDelayed();\r\n      }, 3000);\r\n    }\r\n  }\r\n}\r\n\r\n//  Play Next Track \r\n\r\nexport function playNextTrack(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n\r\n  if (hostConn && !isOperator) {\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  if (hostConn && isOperator) {\r\n    hostConn.send({ type: MSG.REQUEST_NEXT_TRACK });\r\n    return;\r\n  }\r\n\r\n  // Host: YouTube internal navigation\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    let handled = false;\r\n    bus.emit('youtube:try-next-internal', (success: boolean) => { handled = success; });\r\n    if (handled) return;\r\n  }\r\n\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const repeatMode = getState<number>('playlist.repeatMode') || 0;\r\n  const isShuffle = getState<boolean>('playlist.isShuffle');\r\n  const nextTrackIndex = getState<number>('preload.nextTrackIndex');\r\n\r\n  if (playlist.length === 0) return;\r\n\r\n  let nextIndex = -1;\r\n\r\n  if (repeatMode === 2) {\r\n    nextIndex = currentTrackIndex;\r\n  } else if (isShuffle) {\r\n    if (playlist.length === 1) {\r\n      nextIndex = 0;\r\n    } else if (nextTrackIndex !== -1 && nextTrackIndex !== currentTrackIndex && nextTrackIndex < playlist.length) {\r\n      nextIndex = nextTrackIndex;\r\n    } else {\r\n      do {\r\n        nextIndex = Math.floor(Math.random() * playlist.length);\r\n      } while (nextIndex === currentTrackIndex);\r\n    }\r\n  } else {\r\n    nextIndex = currentTrackIndex + 1;\r\n    if (nextIndex >= playlist.length) {\r\n      if (repeatMode === 1) {\r\n        nextIndex = 0;\r\n      } else {\r\n        log.debug('[Host] End of playlist reached (Repeat OFF). Stopping.');\r\n        stopAllMedia();\r\n        broadcast({ type: MSG.PAUSE, time: 0 });\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (nextIndex !== -1) {\r\n    playTrack(nextIndex);\r\n  }\r\n}\r\n\r\n//  Play Previous Track \r\n\r\nexport function playPrevTrack(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n\r\n  if (hostConn && !isOperator) {\r\n    bus.emit('ui:show-toast', '   ');\r\n    return;\r\n  }\r\n\r\n  if (hostConn && isOperator) {\r\n    hostConn.send({ type: MSG.REQUEST_PREV_TRACK });\r\n    return;\r\n  }\r\n\r\n  const currentState = getState<string>('appState');\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n  // YouTube mode\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    let handled = false;\r\n    bus.emit('youtube:try-prev-internal', (success: boolean) => { handled = success; });\r\n    if (handled) return;\r\n\r\n    if (currentTrackIndex > 0) playTrack(currentTrackIndex - 1);\r\n    else playTrack(0);\r\n    return;\r\n  }\r\n\r\n  // Local mode: restart if > 3s, else previous track\r\n  const pos = getTrackPosition();\r\n  if (pos > 3) {\r\n    play(0);\r\n    broadcast({ type: MSG.PLAY, time: 0, index: currentTrackIndex });\r\n    return;\r\n  }\r\n\r\n  if (currentTrackIndex > 0) playTrack(currentTrackIndex - 1);\r\n  else playTrack(0);\r\n}\r\n\r\n//  Network Handlers \r\n\r\nfunction handleRepeatMode(data: Record<string, unknown>): void {\r\n  setRepeatMode(Number(data.value) || 0);\r\n}\r\n\r\nfunction handleShuffleMode(data: Record<string, unknown>): void {\r\n  setShuffle(!!data.value);\r\n}\r\n\r\nfunction handlePlaylistUpdate(data: Record<string, unknown>): void {\r\n  // Backward-compat: legacy may send `playlist` instead of `list`\r\n  const incoming = Array.isArray(data.list) ? data.list :\r\n    (Array.isArray(data.playlist) ? data.playlist : null);\r\n  if (!incoming) {\r\n    setState('playlist.items', []);\r\n    bus.emit('ui:update-playlist');\r\n    return;\r\n  }\r\n  setState('playlist.items', incoming);\r\n\r\n  // Sync current track index from host (late-join bootstrap)\r\n  let idx = getState<number>('playlist.currentTrackIndex');\r\n  if (typeof data.currentTrackIndex === 'number') {\r\n    idx = data.currentTrackIndex;\r\n  } else if (typeof data.index === 'number') {\r\n    idx = data.index;\r\n  }\r\n  // Clamp to valid range\r\n  if (idx >= incoming.length) idx = incoming.length - 1;\r\n  if (idx < -1) idx = -1;\r\n  if (idx === -1 && incoming.length > 0) idx = 0;\r\n  setState('playlist.currentTrackIndex', idx);\r\n\r\n  bus.emit('ui:update-playlist');\r\n}\r\n\r\nfunction handleTrackChange(data: Record<string, unknown>, conn: DataConnection): void {\r\n  // Host handles OP request\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playlist] Rejected request-track-change from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  const index = Number(data.index);\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  if (!Number.isFinite(index) || index < 0 || index >= playlist.length) {\r\n    log.warn(`[Playlist] Invalid track index: ${data.index}`);\r\n    return;\r\n  }\r\n  playTrack(index);\r\n}\r\n\r\nfunction handleRequestNextTrack(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playlist] Rejected request-next-track from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n  playNextTrack();\r\n}\r\n\r\nfunction handleRequestPrevTrack(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playlist] Rejected request-prev-track from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n  playPrevTrack();\r\n}\r\n\r\nfunction handleRequestSetting(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[Playlist] Rejected request-setting from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  const st = data.settingType as string;\r\n  const val = data.value;\r\n  switch (st) {\r\n    case 'repeat-mode': {\r\n      const mode = Number(val) || 0;\r\n      setRepeatMode(mode);\r\n      broadcast({ type: MSG.REPEAT_MODE, value: mode });\r\n      break;\r\n    }\r\n    case 'shuffle-mode': {\r\n      const enabled = !!val;\r\n      setShuffle(enabled);\r\n      broadcast({ type: MSG.SHUFFLE_MODE, value: enabled });\r\n      break;\r\n    }\r\n    //  Audio Effect Settings (OP  Host apply + broadcast) \r\n    case 'eq': {\r\n      const band = parseInt(String(data.band), 10);\r\n      const v = parseFloat(String(val));\r\n      setEQ(band, v);\r\n      broadcast({ type: MSG.EQ_UPDATE, band, value: v });\r\n      break;\r\n    }\r\n    case MSG.PREAMP: {\r\n      const v = parseFloat(String(val));\r\n      setPreamp(v);\r\n      broadcast({ type: MSG.PREAMP, value: v });\r\n      break;\r\n    }\r\n    case 'stereo': {\r\n      const v = Number(val);\r\n      setStereoWidth(v);\r\n      broadcast({ type: MSG.STEREO_WIDTH, value: v });\r\n      break;\r\n    }\r\n    case MSG.VBASS: {\r\n      const v = Number(val);\r\n      setVirtualBass(v);\r\n      broadcast({ type: MSG.VBASS, value: v });\r\n      break;\r\n    }\r\n    case MSG.REVERB: {\r\n      setReverbParam('mix', Number(val));\r\n      broadcast({ type: MSG.REVERB, value: val });\r\n      break;\r\n    }\r\n    case MSG.REVERB_TYPE: {\r\n      // Reverb type preset handled via protocol handler, just broadcast\r\n      setState('audio.reverbType', String(val));\r\n      broadcast({ type: MSG.REVERB_TYPE, value: val });\r\n      break;\r\n    }\r\n    case MSG.REVERB_DECAY: {\r\n      setReverbParam('decay', Number(val));\r\n      broadcast({ type: MSG.REVERB_DECAY, value: val });\r\n      break;\r\n    }\r\n    case MSG.REVERB_PREDELAY: {\r\n      setReverbParam('predelay', Number(val));\r\n      broadcast({ type: MSG.REVERB_PREDELAY, value: val });\r\n      break;\r\n    }\r\n    case MSG.REVERB_LOWCUT: {\r\n      setReverbParam('lowcut', Number(val));\r\n      broadcast({ type: MSG.REVERB_LOWCUT, value: val });\r\n      break;\r\n    }\r\n    case MSG.REVERB_HIGHCUT: {\r\n      setReverbParam('highcut', Number(val));\r\n      broadcast({ type: MSG.REVERB_HIGHCUT, value: val });\r\n      break;\r\n    }\r\n  }\r\n}\r\n\r\n//  Load Demo Media \r\n\r\nasync function loadDemoMedia(): Promise<void> {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    bus.emit('ui:show-toast', 'Host   .');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    bus.emit('ui:show-loader', true, '   ...');\r\n    bus.emit('ui:update-loader', 0);\r\n\r\n    const blob: Blob = await new Promise((resolve, reject) => {\r\n      const xhr = new XMLHttpRequest();\r\n      xhr.open('GET', DEMO_FILE_NAME, true);\r\n      xhr.responseType = 'blob';\r\n\r\n      xhr.onprogress = (event) => {\r\n        if (event.lengthComputable) {\r\n          const percent = Math.round((event.loaded / event.total) * 100);\r\n          bus.emit('ui:update-loader', percent);\r\n        }\r\n      };\r\n\r\n      xhr.onload = () => {\r\n        if (xhr.status >= 200 && xhr.status < 300) {\r\n          resolve(xhr.response as Blob);\r\n        } else {\r\n          reject(new Error(`HTTP Error ${xhr.status}`));\r\n        }\r\n      };\r\n\r\n      xhr.onerror = () => reject(new Error('Network Error'));\r\n      xhr.send();\r\n    });\r\n\r\n    const file = new File([blob], DEMO_FILE_NAME, { type: 'audio/mpeg' });\r\n\r\n    const newTrack: PlaylistItem = {\r\n      type: 'file',\r\n      file,\r\n      name: file.name,\r\n      title: DEMO_TITLE,\r\n    };\r\n\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    playlist.push(newTrack);\r\n    setState('playlist.items', playlist);\r\n    bus.emit('ui:update-playlist');\r\n\r\n    const metaList = playlist.map(item => ({\r\n      type: item.type,\r\n      name: item.name,\r\n      title: item.title || item.name,\r\n      videoId: item.videoId || null,\r\n      playlistId: item.playlistId || null,\r\n    }));\r\n    broadcast({ type: MSG.PLAYLIST_UPDATE, list: metaList });\r\n\r\n    bus.emit('ui:show-toast', '   .  .');\r\n    bus.emit('ui:show-loader', false);\r\n\r\n    playTrack(playlist.length - 1);\r\n  } catch (e: unknown) {\r\n    log.error('Demo load failed:', e);\r\n    bus.emit('ui:show-toast', `  : ${(e as Error).message}`);\r\n    bus.emit('ui:show-loader', false);\r\n  }\r\n}\r\n\r\n//  Handle Files Selected \r\n\r\nfunction handleFilesSelected(files: FileList | null): void {\r\n  if (!files || files.length === 0) return;\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    bus.emit('ui:show-toast', 'Host    .');\r\n    return;\r\n  }\r\n\r\n  const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n  let addedCount = 0;\r\n\r\n  for (let i = 0; i < files.length; i++) {\r\n    const file = files[i];\r\n    if (!file) continue;\r\n\r\n    const newTrack: PlaylistItem = {\r\n      type: 'file',\r\n      file,\r\n      name: file.name,\r\n      title: file.name.replace(/\\.[^/.]+$/, ''),\r\n    };\r\n    playlist.push(newTrack);\r\n    addedCount++;\r\n  }\r\n\r\n  if (addedCount === 0) return;\r\n\r\n  setState('playlist.items', playlist);\r\n  bus.emit('ui:update-playlist');\r\n\r\n  const metaList = playlist.map(item => ({\r\n    type: item.type,\r\n    name: item.name,\r\n    title: item.title || item.name,\r\n    videoId: item.videoId || null,\r\n    playlistId: item.playlistId || null,\r\n  }));\r\n  broadcast({ type: MSG.PLAYLIST_UPDATE, list: metaList });\r\n\r\n  bus.emit('ui:show-toast', `${addedCount}  `);\r\n\r\n  // Auto-play first added file if nothing is playing\r\n  const currentState = getState<string>('appState');\r\n  if (isIdleOrPaused(currentState)) {\r\n    playTrack(playlist.length - addedCount);\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initPlaylist(): void {\r\n  registerHandlers({\r\n    [MSG.REPEAT_MODE]: handleRepeatMode,\r\n    [MSG.SHUFFLE_MODE]: handleShuffleMode,\r\n    [MSG.PLAYLIST_UPDATE]: handlePlaylistUpdate,\r\n    [MSG.PLAYLIST]: handlePlaylistUpdate, // Backward-compat alias\r\n    [MSG.REQUEST_TRACK_CHANGE]: handleTrackChange,\r\n    [MSG.REQUEST_NEXT_TRACK]: handleRequestNextTrack,\r\n    [MSG.REQUEST_PREV_TRACK]: handleRequestPrevTrack,\r\n    [MSG.REQUEST_SETTING]: handleRequestSetting,\r\n  });\r\n\r\n  // Handle track ended auto-advance\r\n  bus.on('player:ended', () => {\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) return; // Only Host handles\r\n\r\n    const repeatMode = getState<number>('playlist.repeatMode') || 0;\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n\r\n    if (repeatMode === 2) {\r\n      log.debug('Repeat One: Replaying current track...');\r\n      setTimeout(() => playTrack(currentTrackIndex), 300);\r\n    } else {\r\n      log.debug('Auto-advancing to next track...');\r\n      setTimeout(() => playNextTrack(), 500);\r\n    }\r\n  });\r\n\r\n  // Handle MediaSession navigation requests\r\n  bus.on('playlist:prev-track', () => playPrevTrack());\r\n  bus.on('playlist:next-track', () => playNextTrack());\r\n\r\n  // Silent mode setters (for handleStatusSync  no toast, no broadcast)\r\n  bus.on('playlist:set-repeat-mode', ((...args: unknown[]) => {\r\n    const mode = Number(args[0]) || 0;\r\n    setRepeatMode(mode);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('playlist:set-shuffle', ((...args: unknown[]) => {\r\n    setShuffle(!!args[0]);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Demo media loading\r\n  bus.on('app:load-demo', ((..._args: unknown[]) => {\r\n    loadDemoMedia();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // File selection\r\n  bus.on('app:files-selected', ((...args: unknown[]) => {\r\n    handleFilesSelected(args[0] as FileList | null);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Play specific track from playlist view click\r\n  bus.on('playlist:play-track', ((...args: unknown[]) => {\r\n    const index = Number(args[0]);\r\n    if (Number.isFinite(index) && index >= 0) playTrack(index);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Play preloaded track (from storage/preload after successful preload)\r\n  bus.on('storage:play-preloaded', ((...args: unknown[]) => {\r\n    const index = Number(args[0]);\r\n    if (Number.isFinite(index) && index >= 0) {\r\n      playTrack(index);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Host: Send playlist state to newly connected peer (late-join bootstrap)\r\n  bus.on('network:peer-connected', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection | null;\r\n    if (!conn?.open) return;\r\n\r\n    // Only Host bootstraps guests\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) return;\r\n\r\n    try {\r\n      // Repeat mode\r\n      const repeatMode = getState<number>('playlist.repeatMode') || 0;\r\n      conn.send({ type: MSG.REPEAT_MODE, value: repeatMode });\r\n\r\n      // Shuffle mode\r\n      const isShuffle = getState<boolean>('playlist.isShuffle');\r\n      conn.send({ type: MSG.SHUFFLE_MODE, value: isShuffle });\r\n\r\n      // Full playlist metadata\r\n      const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n      const metaList = playlist.map(item => ({\r\n        type: item.type,\r\n        name: item.name,\r\n        title: item.title || item.name,\r\n        videoId: item.videoId || null,\r\n        playlistId: item.playlistId || null,\r\n      }));\r\n      conn.send({ type: MSG.PLAYLIST_UPDATE, list: metaList });\r\n\r\n      log.debug('[Playlist] Bootstrap: sent playlist state to new peer');\r\n    } catch (e) {\r\n      log.warn('[Playlist] Bootstrap send failed:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Playlist] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Media Session API\r\n * Extracted from original app.js lines 3710-3825\r\n *\r\n * Manages: System media controls (lock screen, notification area),\r\n * track metadata display.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState } from '../core/state.ts';\r\nimport { APP_STATE } from '../core/constants.ts';\r\nimport { togglePlay, stopPlayback, skipTime } from './playback.ts';\r\nimport { isIdleOrPaused } from './video.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n//  Metadata Update \r\n\r\nexport function updateMediaSessionMetadata(item: PlaylistItem | null): void {\r\n  if (!('mediaSession' in navigator) || !item) return;\r\n\r\n  let title = item.name || item.title || 'Unknown Track';\r\n  const artist = item.type === 'youtube' ? 'YouTube' : 'MUSIXQUARE';\r\n  let artwork: MediaImage[] = [];\r\n\r\n  if (item.type === 'youtube') {\r\n    const currentYouTubeSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n    if (item.playlistId && currentYouTubeSubIndex !== -1) {\r\n      const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n      const subData = subMap[item.playlistId];\r\n      if (subData?.titles?.[currentYouTubeSubIndex]) {\r\n        title = subData.titles[currentYouTubeSubIndex];\r\n      } else {\r\n        title = `${item.title || 'Playlist'} (${currentYouTubeSubIndex + 1})`;\r\n      }\r\n    }\r\n\r\n    const thumb = (item as unknown as Record<string, unknown>).thumbnail;\r\n    if (thumb) {\r\n      artwork = [{ src: thumb as string, sizes: '480x360', type: 'image/jpeg' }];\r\n    }\r\n  } else {\r\n    artwork = [{ src: 'favicon.svg', sizes: '512x512', type: 'image/svg+xml' }];\r\n  }\r\n\r\n  navigator.mediaSession.metadata = new MediaMetadata({\r\n    title,\r\n    artist,\r\n    album: 'MUSIXQUARE',\r\n    artwork,\r\n  });\r\n}\r\n\r\n//  Init \r\n\r\nexport function initMediaSession(): void {\r\n  if (!('mediaSession' in navigator)) return;\r\n  log.debug('[MediaSession] Initializing action handlers...');\r\n\r\n  const isBlocked = (): boolean => {\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    return !!(hostConn && !isOperator);\r\n  };\r\n\r\n  navigator.mediaSession.setActionHandler('play', () => {\r\n    if (isBlocked()) return;\r\n    try {\r\n      const currentState = getState<string>('appState');\r\n      if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n        togglePlay();\r\n        return;\r\n      }\r\n      const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n      if (currentTrackIndex >= 0 && currentState !== APP_STATE.IDLE) {\r\n        togglePlay();\r\n      }\r\n    } catch {\r\n      try { togglePlay(); } catch { /* noop */ }\r\n    }\r\n  });\r\n\r\n  navigator.mediaSession.setActionHandler('pause', () => {\r\n    if (isBlocked()) return;\r\n    try {\r\n      const currentState = getState<string>('appState');\r\n      if (!isIdleOrPaused(currentState)) togglePlay();\r\n    } catch {\r\n      try {\r\n        const st = getState<string>('appState');\r\n        if (!isIdleOrPaused(st)) togglePlay();\r\n      } catch { /* noop */ }\r\n    }\r\n  });\r\n\r\n  navigator.mediaSession.setActionHandler('previoustrack', () => {\r\n    bus.emit('playlist:prev-track');\r\n  });\r\n\r\n  navigator.mediaSession.setActionHandler('nexttrack', () => {\r\n    bus.emit('playlist:next-track');\r\n  });\r\n\r\n  navigator.mediaSession.setActionHandler('seekbackward', (details) => {\r\n    skipTime(-(details.seekOffset || 10));\r\n  });\r\n\r\n  navigator.mediaSession.setActionHandler('seekforward', (details) => {\r\n    skipTime(details.seekOffset || 10);\r\n  });\r\n\r\n  try {\r\n    navigator.mediaSession.setActionHandler('stop', () => {\r\n      stopPlayback();\r\n    });\r\n  } catch (e: unknown) {\r\n    log.debug('[MediaSession] Handler setup skipped:', (e as Error).message);\r\n  }\r\n\r\n  // Listen for metadata update events from playlist module\r\n  bus.on('player:metadata-update', ((...args: unknown[]) => {\r\n    updateMediaSessionMetadata(args[0] as PlaylistItem);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[MediaSession] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  YouTube Search & URL Extraction\r\n * Extracted from original app.js lines 11232-11248, 11853-11926\r\n *\r\n * Manages: Video/Playlist ID extraction, oEmbed preview fetch,\r\n * oEmbed title cache.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, DELAY } from '../core/constants.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  URL Extraction \r\n\r\nconst VIDEO_PATTERNS = [\r\n  /(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/|youtube\\.com\\/embed\\/)([a-zA-Z0-9_-]{11})/,\r\n  /youtube\\.com\\/shorts\\/([a-zA-Z0-9_-]{11})/,\r\n];\r\n\r\nexport function extractYouTubeVideoId(url: string): string | null {\r\n  for (const pattern of VIDEO_PATTERNS) {\r\n    const match = url.match(pattern);\r\n    if (match) return match[1];\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function extractYouTubePlaylistId(url: string): string | null {\r\n  const match = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);\r\n  return match ? match[1] : null;\r\n}\r\n\r\n//  oEmbed Title Cache \r\n\r\nconst _oEmbedTitleCache = new Map<string, string>();\r\nconst _oEmbedInFlight = new Map<string, Promise<string | null>>();\r\n\r\nexport async function fetchOEmbedTitle(url: string): Promise<string | null> {\r\n  const key = String(url || '');\r\n  if (!key) return null;\r\n\r\n  if (_oEmbedTitleCache.has(key)) return _oEmbedTitleCache.get(key)!;\r\n  if (_oEmbedInFlight.has(key)) return _oEmbedInFlight.get(key)!;\r\n\r\n  const p = (async (): Promise<string | null> => {\r\n    try {\r\n      const oEmbedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(key)}&format=json`;\r\n      const response = await fetch(oEmbedUrl);\r\n      if (!response.ok) return null;\r\n      const data = await response.json();\r\n      const title = (data && typeof data.title === 'string') ? data.title.trim() : '';\r\n      return title || null;\r\n    } catch (e) {\r\n      log.warn('[YouTube oEmbed] Fetch failed:', e);\r\n      return null;\r\n    } finally {\r\n      _oEmbedInFlight.delete(key);\r\n    }\r\n  })();\r\n\r\n  _oEmbedInFlight.set(key, p);\r\n  const result = await p;\r\n  if (result) _oEmbedTitleCache.set(key, result);\r\n  return result;\r\n}\r\n\r\n//  oEmbed Preview Fetch (UI-bound) \r\n\r\nlet _previewDebounce: ReturnType<typeof setTimeout> | null = null;\r\n\r\nexport function fetchYouTubePreview(url: string): void {\r\n  const previewContainer = document.getElementById('youtube-preview');\r\n  const statusText = document.getElementById('youtube-preview-status');\r\n  const playBtn = document.getElementById('youtube-play-btn') as HTMLButtonElement | null;\r\n\r\n  if (!previewContainer || !statusText) return;\r\n\r\n  const setPlayBtnEnabled = (enabled: boolean): void => {\r\n    if (!playBtn) return;\r\n    playBtn.disabled = !enabled;\r\n    playBtn.style.opacity = enabled ? '1' : '0.5';\r\n  };\r\n\r\n  if (_previewDebounce) clearTimeout(_previewDebounce);\r\n\r\n  if (!url || url.trim() === '') {\r\n    previewContainer.style.display = 'none';\r\n    statusText.style.display = 'block';\r\n    statusText.innerText = '    ';\r\n    statusText.style.color = 'var(--text-sub)';\r\n    setPlayBtnEnabled(false);\r\n    return;\r\n  }\r\n\r\n  const videoId = extractYouTubeVideoId(url);\r\n  const playlistId = extractYouTubePlaylistId(url);\r\n\r\n  if (!videoId && !playlistId) {\r\n    previewContainer.style.display = 'none';\r\n    statusText.style.display = 'block';\r\n    statusText.innerText = ' YouTube  ';\r\n    statusText.style.color = '#ef4444';\r\n    setPlayBtnEnabled(false);\r\n    return;\r\n  }\r\n\r\n  statusText.style.display = 'block';\r\n  statusText.innerText = '   ...';\r\n  statusText.style.color = 'var(--text-sub)';\r\n  setPlayBtnEnabled(false);\r\n\r\n  _previewDebounce = setTimeout(async () => {\r\n    try {\r\n      const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;\r\n      const response = await fetch(oembedUrl);\r\n      if (!response.ok) throw new Error('Video not found');\r\n      const data = await response.json();\r\n\r\n      const thumb = document.getElementById('youtube-preview-thumb') as HTMLImageElement | null;\r\n      const title = document.getElementById('youtube-preview-title');\r\n      const chan = document.getElementById('youtube-preview-channel');\r\n      if (thumb) thumb.src = data.thumbnail_url;\r\n      if (title) title.innerText = data.title;\r\n      if (chan) chan.innerText = data.author_name;\r\n\r\n      previewContainer.style.display = 'block';\r\n      statusText.style.display = 'none';\r\n      setPlayBtnEnabled(true);\r\n    } catch (e) {\r\n      log.error('[YouTube Preview] Error:', e);\r\n      previewContainer.style.display = 'none';\r\n      statusText.style.display = 'block';\r\n      statusText.innerText = '    ';\r\n      statusText.style.color = '#ef4444';\r\n      setPlayBtnEnabled(false);\r\n    }\r\n  }, 500);\r\n}\r\n\r\n//  Background Playlist Sub-Title Fetcher \r\n\r\n/** Dedup flag per playlistId to avoid parallel fetches */\r\nconst _isFetching = new Map<string, boolean>();\r\nlet _uiTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n/**\r\n * Background oEmbed fetcher for YouTube playlist sub-item titles.\r\n * Sequentially fetches titles with 200ms delay between requests.\r\n * Updates state, UI, and broadcasts to peers as titles arrive.\r\n * Ported from original app.js fetchPlaylistSubTitles().\r\n */\r\nexport async function fetchPlaylistSubTitles(playlistId: string, ids: string[]): Promise<void> {\r\n  if (!ids || ids.length === 0) return;\r\n\r\n  const subMap = getState<Record<string, { ids: string[]; titles: string[]; }>>('youtube.subItemsMap') || {};\r\n  const data = subMap[playlistId];\r\n  if (!data) return;\r\n\r\n  if (_isFetching.get(playlistId)) return; // Dedupe\r\n  _isFetching.set(playlistId, true);\r\n\r\n  log.debug(`[YouTube Feed] Starting title fetch for playlist: ${playlistId} (${ids.length} items)`);\r\n\r\n  try {\r\n    for (let i = 0; i < ids.length; i++) {\r\n      // Re-read state in case it was updated externally\r\n      const currentMap = getState<Record<string, { ids: string[]; titles: string[]; }>>('youtube.subItemsMap') || {};\r\n      const currentData = currentMap[playlistId];\r\n      if (!currentData) break;\r\n\r\n      // Skip if already has title\r\n      if (currentData.titles[i]) continue;\r\n\r\n      try {\r\n        const videoId = ids[i];\r\n        const response = await fetch(\r\n          `https://www.youtube.com/oembed?url=${encodeURIComponent('https://www.youtube.com/watch?v=' + videoId)}&format=json`\r\n        );\r\n        if (!response.ok) continue;\r\n        const json = await response.json();\r\n\r\n        if (json && json.title) {\r\n          // Update state\r\n          const freshMap = getState<Record<string, { ids: string[]; titles: string[]; }>>('youtube.subItemsMap') || {};\r\n          if (!freshMap[playlistId]) freshMap[playlistId] = { ids: [], titles: [] };\r\n          freshMap[playlistId].titles[i] = json.title;\r\n          setState('youtube.subItemsMap', { ...freshMap });\r\n\r\n          log.debug(`[YouTube Feed] Fetched Title [${i}]: ${json.title}`);\r\n\r\n          // Debounced UI update to avoid rebuilding DOM per-title\r\n          if (_uiTimer) clearTimeout(_uiTimer);\r\n          _uiTimer = setTimeout(() => bus.emit('ui:update-playlist'), 200);\r\n\r\n          // Only Host broadcasts to peers\r\n          const hostConn = getState<DataConnection | null>('network.hostConn');\r\n          if (!hostConn) {\r\n            broadcast({\r\n              type: MSG.YOUTUBE_SUB_TITLE_UPDATE,\r\n              playlistId,\r\n              subIdx: i,\r\n              title: json.title,\r\n            });\r\n          }\r\n        }\r\n      } catch (e) {\r\n        log.warn(`[YouTube Feed] Failed to fetch title for ${ids[i]}:`, e);\r\n      }\r\n\r\n      // 200ms delay between requests to avoid rate limiting\r\n      await new Promise(r => setTimeout(r, DELAY.RETRY));\r\n    }\r\n  } finally {\r\n    _isFetching.delete(playlistId);\r\n  }\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  YouTube Player\r\n * Extracted from original app.js lines 11313-11788\r\n *\r\n * Manages: YouTube IFrame API, player lifecycle, state changes,\r\n * UI loop, stopYouTubeMode.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, APP_STATE } from '../core/constants.ts';\r\nimport { clearManagedTimer, setManagedTimer } from '../core/timers.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport { registerHandlers, verifyOperator } from '../network/protocol.ts';\r\nimport { IS_IOS } from '../core/platform.ts';\r\nimport { fmtTime } from '../player/playback.ts';\r\nimport { isIdleOrPaused, setEngineMode } from '../player/video.ts';\r\nimport { fetchYouTubePreview, extractYouTubeVideoId, extractYouTubePlaylistId, fetchOEmbedTitle, fetchPlaylistSubTitles } from './search.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n/* eslint-disable @typescript-eslint/no-explicit-any */\r\ndeclare const YT: any;\r\n/* eslint-enable @typescript-eslint/no-explicit-any */\r\n\r\n//  Module State \r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nlet _youtubePlayer: any = null;\r\nlet _currentYouTubeSessionId = 0;\r\nlet _ytScriptLoading = false;\r\nlet _ytLoadTimeout: ReturnType<typeof setTimeout> | null = null;\r\nlet _ytIOSWatchdog: number | null = null;\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport function getYouTubePlayer(): any {\r\n  return _youtubePlayer;\r\n}\r\n\r\n//  Load YouTube Video \r\n\r\nexport function loadYouTubeVideo(\r\n  videoId: string | null,\r\n  playlistId: string | null = null,\r\n  autoplay = true,\r\n  subIndex = 0,\r\n): void {\r\n  _cachedYtDuration = 0; // Reset duration cache for new video\r\n  _currentYouTubeSessionId++;\r\n  const currentSessionId = _currentYouTubeSessionId;\r\n\r\n  bus.emit('player:stop-all-media');\r\n  setEngineMode('youtube');\r\n\r\n  bus.emit('ui:show-toast', 'YouTube   -    ');\r\n\r\n  const wrapper = document.querySelector('.video-wrapper');\r\n  if (!wrapper) {\r\n    log.warn('[YouTube] .video-wrapper not found');\r\n    return;\r\n  }\r\n\r\n  let container = document.getElementById('youtube-player-container');\r\n  if (!container) {\r\n    container = document.createElement('div');\r\n    container.id = 'youtube-player-container';\r\n    container.style.cssText = 'width:100%; height:100%; position:relative;';\r\n    wrapper.appendChild(container);\r\n  }\r\n\r\n  if (!_youtubePlayer) {\r\n    container.innerHTML = '<div id=\"youtube-player\"></div>';\r\n  }\r\n\r\n  const w = window as unknown as Record<string, unknown>;\r\n  if (!w.YT || !(w.YT as Record<string, unknown>).Player) {\r\n    if (!_ytScriptLoading) {\r\n      _ytScriptLoading = true;\r\n      const tag = document.createElement('script');\r\n      tag.src = 'https://www.youtube.com/iframe_api';\r\n      tag.onload = () => log.debug('[YouTube] API script loaded');\r\n      tag.onerror = () => {\r\n        log.error('[YouTube] Failed to load API script');\r\n        _ytScriptLoading = false;\r\n        bus.emit('ui:show-toast', 'YouTube API  .   !');\r\n      };\r\n      document.head.appendChild(tag);\r\n    }\r\n    w.onYouTubeIframeAPIReady = () => {\r\n      (w as Record<string, boolean>).isYouTubeAPIReady = true;\r\n      initYouTubePlayer(videoId, playlistId, autoplay, subIndex);\r\n    };\r\n  } else {\r\n    initYouTubePlayer(videoId, playlistId, autoplay, subIndex);\r\n  }\r\n\r\n  // Safety timeout\r\n  if (_ytLoadTimeout) clearTimeout(_ytLoadTimeout);\r\n  _ytLoadTimeout = setTimeout(() => {\r\n    if (_currentYouTubeSessionId === currentSessionId && !_youtubePlayer) {\r\n      log.warn('[YouTube] Load timeout triggered.');\r\n      bus.emit('ui:show-loader', false);\r\n      bus.emit('ui:show-toast', 'YouTube   .  .');\r\n    }\r\n  }, 15000);\r\n\r\n  bus.emit('ui:play-btn-state', true);\r\n\r\n  const fsBtn = document.querySelector('.fullscreen-btn') as HTMLElement | null;\r\n  if (fsBtn) fsBtn.style.setProperty('display', 'none', 'important');\r\n\r\n  setTimeout(() => refreshYouTubeDisplay(), 500);\r\n  log.debug('[YouTube] Loaded:', videoId || playlistId, 'autoplay:', autoplay);\r\n}\r\n\r\n//  Init YouTube Player (IFrame) \r\n\r\nfunction initYouTubePlayer(\r\n  videoId: string | null,\r\n  playlistId: string | null = null,\r\n  autoplay = true,\r\n  subIndex = 0,\r\n): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState !== APP_STATE.PLAYING_YOUTUBE) {\r\n    log.warn('[YouTube] initYouTubePlayer aborted - not in PLAYING_YOUTUBE state');\r\n    return;\r\n  }\r\n\r\n  if (_youtubePlayer?.loadVideoById) {\r\n    log.debug('[YouTube] Re-using existing player instance');\r\n    try {\r\n      if (playlistId) {\r\n        _youtubePlayer.loadPlaylist({ list: playlistId, listType: 'playlist', index: subIndex, startSeconds: 0 });\r\n      } else if (videoId) {\r\n        _youtubePlayer.loadVideoById(videoId);\r\n      }\r\n      if (!autoplay) _youtubePlayer.pauseVideo();\r\n      return;\r\n    } catch (e) {\r\n      log.warn('[YouTube] Failed to reuse player, recreating...', e);\r\n      const container = document.getElementById('youtube-player-container');\r\n      if (container) container.innerHTML = '<div id=\"youtube-player\"></div>';\r\n    }\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const playerVars: Record<string, any> = {\r\n    autoplay: autoplay ? 1 : 0,\r\n    controls: 1,\r\n    rel: 0,\r\n    modestbranding: 1,\r\n    playsinline: 1,\r\n    origin: window.location.origin,\r\n  };\r\n\r\n  if (playlistId) {\r\n    playerVars.listType = 'playlist';\r\n    playerVars.list = playlistId;\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const playerOptions: Record<string, any> = {\r\n    width: '100%',\r\n    height: '100%',\r\n    playerVars,\r\n    events: {\r\n      onReady: onYouTubePlayerReady,\r\n      onStateChange: onYouTubePlayerStateChange,\r\n    },\r\n  };\r\n\r\n  if (videoId) playerOptions.videoId = videoId;\r\n\r\n  _youtubePlayer = new YT.Player('youtube-player', playerOptions);\r\n}\r\n\r\n//  Player Events \r\n\r\nfunction onYouTubePlayerReady(): void {\r\n  log.debug('[YouTube] Player ready');\r\n\r\n  const currentState = getState<string>('appState');\r\n  if (currentState !== APP_STATE.PLAYING_YOUTUBE) {\r\n    log.debug('[YouTube] onPlayerReady skipped - mode changed');\r\n    return;\r\n  }\r\n\r\n  // Start UI update loop\r\n  clearManagedTimer('youtubeUILoop');\r\n  setManagedTimer('youtubeUILoop', updateYouTubeUI, 500, { interval: true });\r\n\r\n  // Only Host runs sync loop\r\n  clearManagedTimer('youtubeSyncLoop');\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    setManagedTimer('youtubeSyncLoop', () => {\r\n      bus.emit('youtube:broadcast-sync');\r\n    }, 3000, { interval: true });\r\n  }\r\n\r\n  // Apply volume\r\n  bus.emit('audio:apply-youtube-volume');\r\n}\r\n\r\nfunction onYouTubePlayerStateChange(event: { data: number }): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState !== APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  const state = event.data;\r\n\r\n  if (state === YT.PlayerState.PLAYING) {\r\n    showYouTubeSyncOverlay(false);\r\n    bus.emit('ui:update-play-state', true);\r\n  } else if (state === YT.PlayerState.PAUSED) {\r\n    bus.emit('ui:update-play-state', false);\r\n  } else if (state === YT.PlayerState.ENDED) {\r\n    setState('appState', APP_STATE.IDLE);\r\n    bus.emit('player:state-changed', APP_STATE.IDLE);\r\n    clearManagedTimer('youtubeUILoop');\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) {\r\n      log.debug('[YouTube] Ended, playing next track...');\r\n      bus.emit('playlist:next-track');\r\n    }\r\n  }\r\n\r\n  // Host broadcasts state to guests\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn && _youtubePlayer?.getCurrentTime) {\r\n    broadcast({\r\n      type: MSG.YOUTUBE_STATE,\r\n      state,\r\n      time: _youtubePlayer.getCurrentTime(),\r\n      subIndex: _youtubePlayer.getPlaylistIndex?.() ?? -1,\r\n    });\r\n  }\r\n}\r\n\r\n//  YouTube UI Update Loop \r\n\r\n/**\r\n * Duration cache  locks after first valid read.\r\n * Reset only on explicit video change (load, stop, playlist index change).\r\n * Prevents YouTube API's getDuration() float jitter from flickering the UI.\r\n */\r\nlet _cachedYtDuration = 0;\r\nlet _cachedYtPlaylistIdx = -1;\r\n\r\nfunction updateYouTubeUI(): void {\r\n  const currentState = getState<string>('appState');\r\n  if (!_youtubePlayer || currentState !== APP_STATE.PLAYING_YOUTUBE || !_youtubePlayer.getCurrentTime) return;\r\n\r\n  try {\r\n    const currentTime = _youtubePlayer.getCurrentTime();\r\n    const rawDuration = _youtubePlayer.getDuration?.() || 0;\r\n    const playlistIdx = _youtubePlayer.getPlaylistIndex?.() ?? -1;\r\n    const state = _youtubePlayer.getPlayerState?.() ?? -1;\r\n\r\n    // iOS watchdog\r\n    if (IS_IOS && (state === 5 || state === -1)) {\r\n      if (!_ytIOSWatchdog) _ytIOSWatchdog = Date.now();\r\n      if (Date.now() - _ytIOSWatchdog > 3000) {\r\n        showYouTubeSyncOverlay(true);\r\n      }\r\n    } else {\r\n      _ytIOSWatchdog = null;\r\n    }\r\n\r\n    // Reset cache when playlist sub-index changes (= different video)\r\n    if (playlistIdx !== _cachedYtPlaylistIdx) {\r\n      _cachedYtPlaylistIdx = playlistIdx;\r\n      _cachedYtDuration = 0;\r\n    }\r\n\r\n    // Lock duration on first valid read  stays locked until video changes\r\n    if (rawDuration > 0 && _cachedYtDuration === 0) {\r\n      _cachedYtDuration = rawDuration;\r\n    }\r\n\r\n    if (_cachedYtDuration > 0) {\r\n      bus.emit('ui:time-update', fmtTime(currentTime), fmtTime(_cachedYtDuration), currentTime, _cachedYtDuration);\r\n    }\r\n  } catch {\r\n    // Player not ready\r\n  }\r\n}\r\n\r\n//  iOS Sync Overlay \r\n\r\nfunction showYouTubeSyncOverlay(show: boolean): void {\r\n  const overlayId = 'youtube-ios-sync-overlay';\r\n  let overlay = document.getElementById(overlayId);\r\n\r\n  if (show) {\r\n    if (!overlay) {\r\n      overlay = document.createElement('div');\r\n      overlay.id = overlayId;\r\n      overlay.style.cssText = `\r\n        position:absolute;top:0;left:0;width:100%;height:100%;\r\n        background:rgba(0,0,0,0.6);display:flex;align-items:center;\r\n        justify-content:center;z-index:100;cursor:pointer;\r\n        backdrop-filter:blur(4px);animation:fadeIn 0.3s ease-out;\r\n      `;\r\n      overlay.onclick = () => {\r\n        if (_youtubePlayer?.playVideo) {\r\n          _youtubePlayer.playVideo();\r\n          showYouTubeSyncOverlay(false);\r\n        }\r\n      };\r\n      overlay.innerHTML = `\r\n        <div style=\"background:var(--primary);color:white;padding:12px 24px;border-radius:100px;font-weight:bold;font-size:14px;box-shadow:0 4px 15px rgba(0,0,0,0.3);display:flex;align-items:center;gap:8px;\">\r\n          <svg viewBox=\"0 0 24 24\" width=\"20\" height=\"20\" fill=\"white\"><path d=\"M8 5v14l11-7z\"/></svg>\r\n          TAP TO SYNC VIDEO\r\n        </div>\r\n      `;\r\n      const wrapper = document.querySelector('.video-wrapper');\r\n      if (wrapper) wrapper.appendChild(overlay);\r\n    }\r\n    overlay.style.display = 'flex';\r\n  } else if (overlay) {\r\n    overlay.style.display = 'none';\r\n    _ytIOSWatchdog = null;\r\n  }\r\n}\r\n\r\n//  Refresh Display Hack \r\n\r\nfunction refreshYouTubeDisplay(): void {\r\n  const container = document.getElementById('youtube-player-container');\r\n  const currentState = getState<string>('appState');\r\n  if (!container || currentState !== APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  log.debug('[YouTube] Refreshing display to prevent black screen...');\r\n  const iframe = container.querySelector('iframe');\r\n\r\n  container.style.display = 'none';\r\n  void container.offsetHeight; // Force reflow\r\n  container.style.display = 'block';\r\n\r\n  if (iframe) {\r\n    iframe.style.visibility = 'hidden';\r\n    void iframe.offsetHeight;\r\n    iframe.style.visibility = 'visible';\r\n  }\r\n\r\n  window.dispatchEvent(new Event('resize'));\r\n}\r\n\r\n//  Stop YouTube Mode \r\n\r\nexport function stopYouTubeMode(): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState !== APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  _cachedYtDuration = 0; // Reset duration cache\r\n  setState('appState', APP_STATE.IDLE);\r\n  bus.emit('player:state-changed', APP_STATE.IDLE);\r\n\r\n  clearManagedTimer('youtubeUILoop');\r\n  clearManagedTimer('youtubeSyncLoop');\r\n\r\n  if (_ytLoadTimeout) {\r\n    clearTimeout(_ytLoadTimeout);\r\n    _ytLoadTimeout = null;\r\n  }\r\n\r\n  if (_youtubePlayer) {\r\n    try {\r\n      log.debug('[YouTube] Destroying player instance...');\r\n      _youtubePlayer.stopVideo();\r\n      if (typeof _youtubePlayer.destroy === 'function') _youtubePlayer.destroy();\r\n    } catch (e: unknown) {\r\n      log.debug('[YouTube] Cleanup error (non-critical):', (e as Error).message);\r\n    }\r\n    _youtubePlayer = null;\r\n  }\r\n\r\n  const container = document.getElementById('youtube-player-container');\r\n  if (container) container.innerHTML = '';\r\n\r\n  const videoEl = document.getElementById('main-video') as HTMLVideoElement | null;\r\n  if (videoEl) {\r\n    videoEl.pause();\r\n    videoEl.src = '';\r\n    videoEl.style.display = 'none';\r\n    videoEl.load();\r\n  }\r\n\r\n  const fsBtn = document.querySelector('.fullscreen-btn') as HTMLElement | null;\r\n  if (fsBtn) {\r\n    fsBtn.style.removeProperty('display');\r\n    fsBtn.style.display = '';\r\n  }\r\n\r\n  // Remove YouTube container from chat drawer\r\n  const chatDrawer = document.getElementById('chat-drawer');\r\n  if (chatDrawer) chatDrawer.classList.remove('with-youtube');\r\n  const chatYtContainer = document.getElementById('chat-youtube-container');\r\n  if (chatYtContainer) chatYtContainer.remove();\r\n\r\n  bus.emit('ui:update-playlist');\r\n  log.debug('[YouTube] Mode stopped');\r\n}\r\n\r\n//  Network Handlers \r\n\r\nfunction handleYouTubePlay(data: Record<string, unknown>): void {\r\n  const videoId = data.videoId as string | null;\r\n  const playlistId = data.playlistId as string | null;\r\n  const index = data.index as number | undefined;\r\n  const autoplay = data.autoplay as boolean | undefined;\r\n\r\n  if (index !== undefined) {\r\n    setState('playlist.currentTrackIndex', index);\r\n  }\r\n\r\n  loadYouTubeVideo(videoId, playlistId, autoplay ?? false);\r\n}\r\n\r\nfunction handleRequestYouTubePlay(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Only Host\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[YouTube] Rejected request-youtube-play from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  if (_youtubePlayer?.playVideo) {\r\n    _youtubePlayer.playVideo();\r\n    broadcast({\r\n      type: MSG.YOUTUBE_STATE,\r\n      state: 1,\r\n      time: _youtubePlayer.getCurrentTime?.() || 0,\r\n    });\r\n  }\r\n}\r\n\r\nfunction handleRequestYouTubePause(_data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[YouTube] Rejected request-youtube-pause from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  if (_youtubePlayer?.pauseVideo) {\r\n    _youtubePlayer.pauseVideo();\r\n    broadcast({\r\n      type: MSG.YOUTUBE_STATE,\r\n      state: 2,\r\n      time: _youtubePlayer.getCurrentTime?.() || 0,\r\n    });\r\n  }\r\n}\r\n\r\nfunction handleRequestYouTubeSubSeek(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return;\r\n\r\n  if (!verifyOperator(conn)) {\r\n    log.warn(`[YouTube] Rejected request-youtube-sub-seek from non-OP: ${conn?.peer}`);\r\n    return;\r\n  }\r\n\r\n  const subIdx = data.subIdx as number;\r\n  if (_youtubePlayer?.playVideoAt && typeof subIdx === 'number') {\r\n    _youtubePlayer.playVideoAt(subIdx);\r\n  }\r\n}\r\n\r\n/**\r\n * Host responds to Guest's request for YouTube playlist sub-item data.\r\n * Sends cached IDs and titles from subItemsMap.\r\n */\r\nfunction handleRequestYouTubePlaylistInfo(data: Record<string, unknown>, conn?: DataConnection): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) return; // Only Host handles this\r\n\r\n  const pid = data.playlistId as string;\r\n  if (!pid || !conn) return;\r\n\r\n  const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n  if (subMap[pid]) {\r\n    conn.send({\r\n      type: MSG.YOUTUBE_PLAYLIST_INFO,\r\n      playlistId: pid,\r\n      ids: subMap[pid].ids || [],\r\n      titles: subMap[pid].titles || [],\r\n    });\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initYouTube(): void {\r\n  registerHandlers({\r\n    [MSG.YOUTUBE_PLAY]: handleYouTubePlay,\r\n    [MSG.REQUEST_YOUTUBE_PLAY]: handleRequestYouTubePlay,\r\n    [MSG.REQUEST_YOUTUBE_PAUSE]: handleRequestYouTubePause,\r\n    [MSG.REQUEST_YOUTUBE_SUB_SEEK]: handleRequestYouTubeSubSeek,\r\n    [MSG.REQUEST_YOUTUBE_PLAYLIST_INFO]: handleRequestYouTubePlaylistInfo,\r\n  });\r\n\r\n  // Bus event handlers from other modules\r\n  bus.on('youtube:stop-mode', (() => stopYouTubeMode()) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:load', ((...args: unknown[]) => {\r\n    const [videoId, playlistId, autoplay] = args;\r\n    loadYouTubeVideo(videoId as string, playlistId as string | null, autoplay as boolean);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:toggle-play', (() => {\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n\r\n    if (hostConn && isOperator) {\r\n      // OP requests\r\n      try {\r\n        const state = _youtubePlayer?.getPlayerState?.();\r\n        if (state === YT.PlayerState.PLAYING) {\r\n          hostConn.send({ type: MSG.REQUEST_YOUTUBE_PAUSE });\r\n        } else {\r\n          hostConn.send({ type: MSG.REQUEST_YOUTUBE_PLAY });\r\n        }\r\n      } catch (e) {\r\n        log.error('[YouTube] OP toggle error:', e);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Host direct\r\n    if (!_youtubePlayer) return;\r\n    try {\r\n      const state = _youtubePlayer.getPlayerState();\r\n      if (state === YT.PlayerState.PLAYING) {\r\n        _youtubePlayer.pauseVideo();\r\n        broadcast({ type: MSG.YOUTUBE_STATE, state: 2, time: _youtubePlayer.getCurrentTime() });\r\n      } else {\r\n        _youtubePlayer.playVideo();\r\n        broadcast({ type: MSG.YOUTUBE_STATE, state: 1, time: _youtubePlayer.getCurrentTime() });\r\n      }\r\n    } catch (e) {\r\n      log.error('[YouTube] Toggle play error:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:auto-play', (() => {\r\n    if (_youtubePlayer?.playVideo) {\r\n      _youtubePlayer.playVideo();\r\n      bus.emit('youtube:broadcast-sync');\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:get-position', ((...args: unknown[]) => {\r\n    const cb = args[0] as (pos: number) => void;\r\n    if (typeof cb === 'function') {\r\n      try {\r\n        const pos = _youtubePlayer?.getCurrentTime?.() ?? 0;\r\n        cb(typeof pos === 'number' && isFinite(pos) && pos >= 0 ? pos : 0);\r\n      } catch {\r\n        cb(0);\r\n      }\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:stop-playback', (() => {\r\n    if (!_youtubePlayer) return;\r\n    try {\r\n      _youtubePlayer.stopVideo();\r\n      try { _youtubePlayer.seekTo(0, true); } catch { /* noop */ }\r\n      broadcast({ type: MSG.YOUTUBE_STATE, state: 2, time: 0 });\r\n    } catch (e) {\r\n      log.error('[YouTube] Stop error:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:skip-time', ((...args: unknown[]) => {\r\n    const sec = Number(args[0]) || 0;\r\n    if (!_youtubePlayer) return;\r\n    try {\r\n      const current = _youtubePlayer.getCurrentTime();\r\n      const duration = _youtubePlayer.getDuration();\r\n      let target = current + sec;\r\n      if (target < 0) target = 0;\r\n      if (target > duration) target = duration;\r\n      _youtubePlayer.seekTo(target, true);\r\n      broadcast({ type: MSG.YOUTUBE_STATE, state: _youtubePlayer.getPlayerState(), time: target });\r\n    } catch (e) {\r\n      log.error('[YouTube] Skip time error:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube seek from seek bar\r\n  bus.on('youtube:seek-to', ((...args: unknown[]) => {\r\n    const time = Number(args[0]);\r\n    if (!_youtubePlayer?.seekTo || !Number.isFinite(time)) return;\r\n    try {\r\n      _youtubePlayer.seekTo(time, true);\r\n      const hostConn = getState<DataConnection | null>('network.hostConn');\r\n      if (!hostConn) {\r\n        broadcast({\r\n          type: MSG.YOUTUBE_STATE,\r\n          state: _youtubePlayer.getPlayerState?.() ?? 1,\r\n          time,\r\n        });\r\n      }\r\n    } catch (e) {\r\n      log.error('[YouTube] Seek error:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:try-next-internal', ((...args: unknown[]) => {\r\n    const cb = args[0] as (success: boolean) => void;\r\n    if (!_youtubePlayer?.getPlaylist || typeof cb !== 'function') { cb(false); return; }\r\n    try {\r\n      const ids = _youtubePlayer.getPlaylist() || [];\r\n      const idx = _youtubePlayer.getPlaylistIndex();\r\n      if (ids.length > 0 && idx < ids.length - 1) {\r\n        _youtubePlayer.nextVideo();\r\n        cb(true);\r\n        return;\r\n      }\r\n    } catch { /* noop */ }\r\n    cb(false);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:try-prev-internal', ((...args: unknown[]) => {\r\n    const cb = args[0] as (success: boolean) => void;\r\n    if (!_youtubePlayer || typeof cb !== 'function') { cb(false); return; }\r\n    try {\r\n      const currentTime = _youtubePlayer.getCurrentTime();\r\n      if (currentTime > 3) {\r\n        _youtubePlayer.seekTo(0, true);\r\n        broadcast({ type: MSG.YOUTUBE_STATE, state: _youtubePlayer.getPlayerState(), time: 0 });\r\n        cb(true);\r\n        return;\r\n      }\r\n      const ids = _youtubePlayer.getPlaylist?.() || [];\r\n      const idx = _youtubePlayer.getPlaylistIndex?.() ?? -1;\r\n      if (ids.length > 0 && idx > 0) {\r\n        _youtubePlayer.previousVideo();\r\n        cb(true);\r\n        return;\r\n      }\r\n    } catch { /* noop */ }\r\n    cb(false);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('youtube:broadcast-sync', (() => {\r\n    // Imported dynamically to avoid circular deps\r\n    import('./sync.ts').then(mod => mod.broadcastYouTubeSync());\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube preview (from URL input)\r\n  bus.on('youtube:preview', ((...args: unknown[]) => {\r\n    const url = args[0] as string;\r\n    fetchYouTubePreview(url || '');\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube load from input field\r\n  bus.on('youtube:load-from-input', (() => {\r\n    const input = document.getElementById('youtube-url-input') as HTMLInputElement | null;\r\n    if (!input) return;\r\n    const url = input.value.trim();\r\n    if (!url) {\r\n      bus.emit('ui:show-toast', 'YouTube  ');\r\n      return;\r\n    }\r\n\r\n    const videoId = extractYouTubeVideoId(url);\r\n    const playlistId = extractYouTubePlaylistId(url);\r\n\r\n    if (!videoId && !playlistId) {\r\n      bus.emit('ui:show-toast', ' YouTube  ');\r\n      return;\r\n    }\r\n\r\n    // Close the overlay + reset preview UI\r\n    const overlay = document.getElementById('youtube-url-overlay');\r\n    if (overlay) overlay.classList.remove('active');\r\n    input.value = '';\r\n    const previewEl = document.getElementById('youtube-preview');\r\n    if (previewEl) previewEl.style.display = 'none';\r\n    const statusEl = document.getElementById('youtube-preview-status');\r\n    if (statusEl) { statusEl.style.display = ''; statusEl.textContent = '   '; }\r\n    const playBtn = document.getElementById('youtube-play-btn') as HTMLButtonElement | null;\r\n    if (playBtn) playBtn.disabled = true;\r\n\r\n    // Add YouTube entry to playlist\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n\r\n    // Get title from preview UI or use URL\r\n    const previewTitle = document.getElementById('youtube-preview-title');\r\n    const titleText = previewTitle?.innerText?.trim() || url;\r\n\r\n    const newTrack: PlaylistItem = {\r\n      type: 'youtube',\r\n      name: titleText,\r\n      title: titleText,\r\n      videoId: videoId || undefined,\r\n      playlistId: playlistId || undefined,\r\n    };\r\n\r\n    playlist.push(newTrack);\r\n    setState('playlist.items', playlist);\r\n    const newIndex = playlist.length - 1;\r\n    setState('playlist.currentTrackIndex', newIndex);\r\n    bus.emit('ui:update-playlist');\r\n    bus.emit('player:metadata-update', newTrack);\r\n\r\n    // Broadcast playlist update + YouTube command to peers\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) {\r\n      const metaList = playlist.map(item => ({\r\n        type: item.type,\r\n        name: item.name,\r\n        title: item.title || item.name,\r\n        videoId: item.videoId || null,\r\n        playlistId: item.playlistId || null,\r\n      }));\r\n      broadcast({ type: MSG.PLAYLIST_UPDATE, list: metaList });\r\n      broadcast({\r\n        type: MSG.YOUTUBE_PLAY,\r\n        videoId,\r\n        playlistId,\r\n        index: newIndex,\r\n        autoplay: true,\r\n      });\r\n    }\r\n\r\n    loadYouTubeVideo(videoId, playlistId, true);\r\n\r\n    // Fetch title in background and update\r\n    fetchOEmbedTitle(url).then(title => {\r\n      if (title && playlist[newIndex]) {\r\n        playlist[newIndex].name = title;\r\n        playlist[newIndex].title = title;\r\n        setState('playlist.items', [...playlist]);\r\n        bus.emit('ui:update-playlist');\r\n        bus.emit('player:metadata-update', playlist[newIndex]);\r\n      }\r\n    });\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Sync nudge for YouTube (adjust playback position by ms delta)\r\n  bus.on('sync:youtube-nudge', ((...args: unknown[]) => {\r\n    const ms = Number(args[0]);\r\n    if (!_youtubePlayer?.seekTo || !Number.isFinite(ms)) return;\r\n    try {\r\n      const current = _youtubePlayer.getCurrentTime();\r\n      _youtubePlayer.seekTo(current + (ms / 1000), true);\r\n    } catch (e) {\r\n      log.error('[YouTube] Nudge error:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube refresh display (from tab switch)\r\n  bus.on('youtube:refresh-display', (() => {\r\n    refreshYouTubeDisplay();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube set volume (from audio engine)\r\n  bus.on('youtube:set-volume', ((...args: unknown[]) => {\r\n    const vol = Number(args[0]);\r\n    if (_youtubePlayer?.setVolume && Number.isFinite(vol)) {\r\n      _youtubePlayer.setVolume(vol);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube sub-item seek (from playlist-view sub-item click)\r\n  bus.on('youtube:sub-seek', ((...args: unknown[]) => {\r\n    const playlistIdx = Number(args[0]);\r\n    const subIdx = Number(args[1]);\r\n    const isCurrent = args[2] as boolean;\r\n\r\n    if (!_youtubePlayer) return;\r\n\r\n    if (isCurrent) {\r\n      // Same playlist  just jump to sub-index\r\n      if (_youtubePlayer.playVideoAt) {\r\n        _youtubePlayer.playVideoAt(subIdx);\r\n        broadcast({\r\n          type: MSG.YOUTUBE_STATE,\r\n          state: 1,\r\n          time: 0,\r\n          subIndex: subIdx,\r\n        });\r\n      }\r\n    } else {\r\n      // Different playlist item  load it first, then sub-seek\r\n      bus.emit('playlist:play-track', playlistIdx);\r\n      // The sub-index will be picked up after loadYouTubeVideo\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Populate sub-items when expanding a YouTube playlist entry\r\n  bus.on('youtube:populate-sub-items', ((...args: unknown[]) => {\r\n    const playlistId = args[0] as string;\r\n    if (!playlistId) return;\r\n\r\n    let ids: string[] = [];\r\n\r\n    // 1. Try to get IDs from current player if it matches the requested playlist\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n    const currentItem = playlist[currentTrackIndex];\r\n\r\n    if (_youtubePlayer?.getPlaylist && currentItem?.playlistId === playlistId) {\r\n      try {\r\n        ids = _youtubePlayer.getPlaylist() || [];\r\n      } catch { /* YouTube player may not be ready */ }\r\n    }\r\n\r\n    // 2. Initial map setup\r\n    const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n    if (ids.length > 0) {\r\n      if (!subMap[playlistId]) {\r\n        subMap[playlistId] = { ids, titles: [] };\r\n      } else if (!subMap[playlistId].ids || subMap[playlistId].ids.length === 0) {\r\n        subMap[playlistId].ids = ids;\r\n      }\r\n      setState('youtube.subItemsMap', { ...subMap });\r\n    }\r\n\r\n    // 3. Trigger background title fetcher (All roles)\r\n    const currentSubMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n    if (currentSubMap[playlistId]?.ids?.length > 0) {\r\n      fetchPlaylistSubTitles(playlistId, currentSubMap[playlistId].ids);\r\n    }\r\n\r\n    // 4. Guest: Request info from Host if sub-item data is missing\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) {\r\n      if (!currentSubMap[playlistId] || !currentSubMap[playlistId].ids || currentSubMap[playlistId].ids.length === 0) {\r\n        hostConn.send({ type: MSG.REQUEST_YOUTUBE_PLAYLIST_INFO, playlistId });\r\n      }\r\n    }\r\n\r\n    bus.emit('ui:update-playlist');\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube load from chat message link\r\n  bus.on('youtube:load-from-chat', ((...args: unknown[]) => {\r\n    const url = args[0] as string;\r\n    if (!url) return;\r\n\r\n    // Host-only guard\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) {\r\n      bus.emit('ui:show-toast', '     .');\r\n      return;\r\n    }\r\n\r\n    const videoId = extractYouTubeVideoId(url);\r\n    const playlistId = extractYouTubePlaylistId(url);\r\n    if (!videoId && !playlistId) {\r\n      bus.emit('ui:show-toast', '  YouTube ');\r\n      return;\r\n    }\r\n\r\n    // Close chat drawer if open\r\n    bus.emit('ui:close-chat-drawer');\r\n\r\n    // Add YouTube entry to playlist\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const newTrack: PlaylistItem = {\r\n      type: 'youtube',\r\n      name: url,\r\n      title: url,\r\n      videoId: videoId || undefined,\r\n      playlistId: playlistId || undefined,\r\n    };\r\n    playlist.push(newTrack);\r\n    setState('playlist.items', playlist);\r\n    const newIndex = playlist.length - 1;\r\n    setState('playlist.currentTrackIndex', newIndex);\r\n    bus.emit('ui:update-playlist');\r\n    bus.emit('player:metadata-update', newTrack);\r\n\r\n    // hostConn is already confirmed null from guard above  we are Host\r\n    const metaList = playlist.map(item => ({\r\n      type: item.type,\r\n      name: item.name,\r\n      title: item.title || item.name,\r\n      videoId: item.videoId || null,\r\n      playlistId: item.playlistId || null,\r\n    }));\r\n    broadcast({ type: MSG.PLAYLIST_UPDATE, list: metaList });\r\n    broadcast({\r\n      type: MSG.YOUTUBE_PLAY,\r\n      videoId,\r\n      playlistId,\r\n      index: newIndex,\r\n      autoplay: true,\r\n    });\r\n\r\n    loadYouTubeVideo(videoId, playlistId, true);\r\n\r\n    // Fetch title in background\r\n    fetchOEmbedTitle(url).then(title => {\r\n      if (title && playlist[newIndex]) {\r\n        playlist[newIndex].name = title;\r\n        playlist[newIndex].title = title;\r\n        setState('playlist.items', [...playlist]);\r\n        bus.emit('ui:update-playlist');\r\n        bus.emit('player:metadata-update', playlist[newIndex]);\r\n      }\r\n    });\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Host: Send YouTube state to newly connected peer (late-join bootstrap)\r\n  bus.on('network:peer-connected', ((...args: unknown[]) => {\r\n    const conn = args[0] as DataConnection | null;\r\n    if (!conn?.open) return;\r\n\r\n    // Only Host bootstraps guests\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) return;\r\n\r\n    const currentState = getState<string>('appState');\r\n    if (currentState !== APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n    const playlist = getState<PlaylistItem[]>('playlist.items') || [];\r\n    const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n    const item = playlist[currentTrackIndex];\r\n\r\n    if (!item || item.type !== 'youtube') return;\r\n\r\n    try {\r\n      let ytTime = 0;\r\n      let ytState = 2; // paused\r\n\r\n      try {\r\n        if (_youtubePlayer?.getCurrentTime) ytTime = _youtubePlayer.getCurrentTime();\r\n        if (_youtubePlayer?.getPlayerState) ytState = _youtubePlayer.getPlayerState();\r\n      } catch { /* best-effort */ }\r\n\r\n      const autoplay = (ytState === 1);\r\n      const currentSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n      const subIdx = (currentSubIndex >= 0) ? currentSubIndex : 0;\r\n\r\n      // Send YouTube play command so guest enters YouTube mode\r\n      conn.send({\r\n        type: MSG.YOUTUBE_PLAY,\r\n        videoId: item.videoId || null,\r\n        playlistId: item.playlistId || null,\r\n        name: item.name || item.title,\r\n        index: currentTrackIndex,\r\n        autoplay,\r\n        subIndex: subIdx,\r\n      });\r\n\r\n      // Also send an immediate sync frame\r\n      conn.send({\r\n        type: MSG.YOUTUBE_SYNC,\r\n        time: ytTime,\r\n        state: ytState,\r\n        subIndex: subIdx,\r\n      });\r\n\r\n      log.debug('[YouTube] Bootstrap: sent YouTube state to new peer');\r\n    } catch (e) {\r\n      log.warn('[YouTube] Bootstrap send failed:', e);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[YouTube] Player initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  YouTube Sync\r\n * Extracted from original app.js lines 11568-11688\r\n *\r\n * Manages: YouTube state broadcasting (Host), sync reception (Guest),\r\n * sub-index tracking, drift correction.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG, APP_STATE, DELAY } from '../core/constants.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport { registerHandlers } from '../network/protocol.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\nimport { getYouTubePlayer } from './player.ts';\r\nimport { fetchPlaylistSubTitles } from './search.ts';\r\n\r\n//  Broadcast YouTube Sync (Host) \r\n\r\nexport function broadcastYouTubeSync(): void {\r\n  const player = getYouTubePlayer();\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!player || hostConn || !player.getCurrentTime) return;\r\n\r\n  try {\r\n    const currentTime = player.getCurrentTime();\r\n    const state = player.getPlayerState ? player.getPlayerState() : -1;\r\n\r\n    // Sub-index tracking for playlists\r\n    if (player.getPlaylistIndex) {\r\n      const sIdx = player.getPlaylistIndex();\r\n      const currentYouTubeSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n\r\n      if (sIdx !== currentYouTubeSubIndex) {\r\n        setState('youtube.currentSubIndex', sIdx);\r\n\r\n        const playlist = getState<unknown[]>('playlist.items') || [];\r\n        const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n        const currentItem = playlist[currentTrackIndex] as Record<string, unknown> | undefined;\r\n\r\n        if (currentItem?.playlistId) {\r\n          const pid = currentItem.playlistId as string;\r\n\r\n          // Get playlist IDs from player\r\n          if (player.getPlaylist) {\r\n            try {\r\n              const ids = player.getPlaylist();\r\n              if (ids?.length > 0) {\r\n                const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n                if (!subMap[pid] || !subMap[pid].ids?.length) {\r\n                  subMap[pid] = { ids, titles: subMap[pid]?.titles || [] };\r\n                  setState('youtube.subItemsMap', { ...subMap });\r\n                }\r\n              }\r\n            } catch { /* noop */ }\r\n          }\r\n\r\n          // Get current video title\r\n          if (player.getVideoData) {\r\n            const vData = player.getVideoData();\r\n            if (vData?.title) {\r\n              const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n              if (!subMap[pid]) subMap[pid] = { ids: [], titles: [] };\r\n              if (subMap[pid].titles[sIdx] !== vData.title) {\r\n                subMap[pid].titles[sIdx] = vData.title;\r\n                setState('youtube.subItemsMap', { ...subMap });\r\n                broadcast({\r\n                  type: MSG.YOUTUBE_SUB_TITLE_UPDATE,\r\n                  playlistId: pid,\r\n                  subIdx: sIdx,\r\n                  title: vData.title,\r\n                });\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        bus.emit('ui:update-playlist');\r\n        bus.emit('player:metadata-update', playlist[currentTrackIndex]);\r\n      }\r\n    }\r\n\r\n    broadcast({\r\n      type: MSG.YOUTUBE_SYNC,\r\n      time: currentTime,\r\n      state,\r\n      subIndex: getState<number>('youtube.currentSubIndex') ?? -1,\r\n    });\r\n  } catch {\r\n    // Player not ready\r\n  }\r\n}\r\n\r\n//  Handle YouTube Sync (Guest) \r\n\r\nfunction handleYouTubeSync(data: Record<string, unknown>): void {\r\n  const player = getYouTubePlayer();\r\n  const currentState = getState<string>('appState');\r\n  if (!player || currentState !== APP_STATE.PLAYING_YOUTUBE || !player.getCurrentTime) return;\r\n\r\n  try {\r\n    const hostTime = Number(data.time) || 0;\r\n    const hostState = Number(data.state);\r\n    const hostSubIndex = data.subIndex as number | undefined;\r\n\r\n    // Sub-index change\r\n    const currentSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n    if (hostSubIndex !== undefined && hostSubIndex !== -1 && hostSubIndex !== currentSubIndex) {\r\n      log.debug(`[YouTube Sync] Sub-index change: ${currentSubIndex} -> ${hostSubIndex}`);\r\n      setState('youtube.currentSubIndex', hostSubIndex);\r\n\r\n      if (player.playVideoAt && player.getPlaylistIndex) {\r\n        if (player.getPlaylistIndex() !== hostSubIndex) {\r\n          player.playVideoAt(hostSubIndex);\r\n        }\r\n      }\r\n\r\n      bus.emit('ui:update-playlist');\r\n      const playlist = getState<unknown[]>('playlist.items') || [];\r\n      const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n      bus.emit('player:metadata-update', playlist[currentTrackIndex]);\r\n    }\r\n\r\n    // Drift correction\r\n    const localOffset = getState<number>('sync.localOffset') || 0;\r\n    const autoSyncOffset = getState<number>('sync.autoSyncOffset') || 0;\r\n    const compensatedTime = hostTime + autoSyncOffset + localOffset;\r\n\r\n    const currentTime = player.getCurrentTime();\r\n    const drift = Math.abs(currentTime - compensatedTime);\r\n\r\n    if (drift > 2 && player.seekTo) {\r\n      log.debug(`[YouTube Sync] Drift ${drift.toFixed(1)}s, seeking to ${compensatedTime.toFixed(1)}s`);\r\n      player.seekTo(compensatedTime, true);\r\n    }\r\n\r\n    // State sync\r\n    if (player.getPlayerState && player.playVideo && player.pauseVideo) {\r\n      const ytState = player.getPlayerState();\r\n      if (hostState === 1 && ytState !== 1) player.playVideo();\r\n      else if (hostState === 2 && ytState !== 2) player.pauseVideo();\r\n    }\r\n  } catch (e) {\r\n    log.error('[YouTube Sync] Error:', e);\r\n  }\r\n}\r\n\r\n//  Handle YouTube State (HostGuest broadcast) \r\n\r\nfunction handleYouTubeState(data: Record<string, unknown>): void {\r\n  const player = getYouTubePlayer();\r\n  const currentState = getState<string>('appState');\r\n  if (!player || currentState !== APP_STATE.PLAYING_YOUTUBE) return;\r\n\r\n  try {\r\n    const state = Number(data.state);\r\n    const time = Number(data.time) || 0;\r\n\r\n    if (state === 1 && player.playVideo) {\r\n      if (player.seekTo) player.seekTo(time, true);\r\n      player.playVideo();\r\n    } else if (state === 2 && player.pauseVideo) {\r\n      player.pauseVideo();\r\n      if (player.seekTo) player.seekTo(time, true);\r\n    }\r\n  } catch (e) {\r\n    log.error('[YouTube State] Error:', e);\r\n  }\r\n}\r\n\r\n//  Handle Sub Title Update \r\n\r\nfunction handleSubTitleUpdate(data: Record<string, unknown>): void {\r\n  const playlistId = data.playlistId as string;\r\n  const subIdx = data.subIdx as number;\r\n  const title = data.title as string;\r\n\r\n  if (!playlistId || subIdx === undefined || !title) return;\r\n\r\n  const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n  if (!subMap[playlistId]) subMap[playlistId] = { ids: [], titles: [] };\r\n  subMap[playlistId].titles[subIdx] = title;\r\n  setState('youtube.subItemsMap', { ...subMap });\r\n\r\n  bus.emit('ui:update-playlist');\r\n\r\n  const playlist = getState<unknown[]>('playlist.items') || [];\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const currentItem = playlist[currentTrackIndex] as Record<string, unknown> | undefined;\r\n  const currentSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n  if (currentItem?.playlistId === playlistId && currentSubIndex === subIdx) {\r\n    bus.emit('player:metadata-update', currentItem);\r\n  }\r\n}\r\n\r\n//  Handle YouTube Playlist Info (HostGuest) \r\n\r\n/**\r\n * Guest receives playlist sub-item data from Host.\r\n * Stores IDs and titles, then triggers background title fetcher\r\n * for any missing titles.\r\n */\r\nfunction handleYouTubePlaylistInfo(data: Record<string, unknown>): void {\r\n  const playlistId = data.playlistId as string;\r\n  const ids = data.ids as string[];\r\n  const titles = data.titles as string[];\r\n\r\n  if (!playlistId) return;\r\n\r\n  const subMap = getState<Record<string, { ids: string[]; titles: string[] }>>('youtube.subItemsMap') || {};\r\n  subMap[playlistId] = { ids: ids || [], titles: titles || [] };\r\n  setState('youtube.subItemsMap', { ...subMap });\r\n  bus.emit('ui:update-playlist');\r\n\r\n  // Guest can also fetch missing titles in background\r\n  if (ids && ids.length > 0) {\r\n    fetchPlaylistSubTitles(playlistId, ids);\r\n  }\r\n}\r\n\r\n//  Handle YouTube Stop \r\n\r\nfunction handleYouTubeStop(): void {\r\n  log.debug('[Guest] Received youtube-stop, switching to local mode');\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    bus.emit('youtube:stop-mode');\r\n  }\r\n  bus.emit('player:stop-all-media');\r\n}\r\n\r\n//  Init \r\n\r\nexport function initYouTubeSync(): void {\r\n  registerHandlers({\r\n    [MSG.YOUTUBE_SYNC]: handleYouTubeSync,\r\n    [MSG.YOUTUBE_STATE]: handleYouTubeState,\r\n    [MSG.YOUTUBE_SUB_TITLE_UPDATE]: handleSubTitleUpdate,\r\n    [MSG.YOUTUBE_PLAYLIST_INFO]: handleYouTubePlaylistInfo,\r\n    [MSG.YOUTUBE_STOP]: handleYouTubeStop as unknown as (d: Record<string, unknown>, c: DataConnection) => void,\r\n  });\r\n\r\n  log.info('[YouTube Sync] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  DOM Utilities\r\n * Extracted from original app.js\r\n *\r\n * Manages: animateTransition, escapeHtml, updateTitleWithMarquee,\r\n * copyTextToClipboard, toggleFullscreen.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\n\r\n//  Batch View Transition \r\n\r\nlet _batchedTransitionCb: (() => void) | null = null;\r\n\r\nexport function animateTransition(callback: () => void): void {\r\n  if (!(document as unknown as Record<string, unknown>).startViewTransition) {\r\n    callback();\r\n    return;\r\n  }\r\n\r\n  if (_batchedTransitionCb !== null) {\r\n    const oldCb = _batchedTransitionCb;\r\n    _batchedTransitionCb = () => { oldCb(); callback(); };\r\n    return;\r\n  }\r\n\r\n  _batchedTransitionCb = callback;\r\n  Promise.resolve().then(() => {\r\n    const cb = _batchedTransitionCb;\r\n    _batchedTransitionCb = null;\r\n    if (!cb) return;\r\n    let executed = false;\r\n    try {\r\n      (document as unknown as Record<string, (...args: unknown[]) => void>).startViewTransition(() => {\r\n        executed = true;\r\n        cb();\r\n      });\r\n    } catch {\r\n      if (!executed) cb();\r\n    }\r\n  });\r\n}\r\n\r\n//  HTML Escaping \r\n\r\nconst _ESCAPE_HTML_RE = /[&<>\"']/;\r\nconst _ESCAPE_HTML_RE_G = /[&<>\"']/g;\r\nconst _ESCAPE_HTML_MAP: Record<string, string> = {\r\n  '&': '&amp;',\r\n  '<': '&lt;',\r\n  '>': '&gt;',\r\n  '\"': '&quot;',\r\n  \"'\": '&#39;',\r\n};\r\n\r\nexport function escapeHtml(value: unknown): string {\r\n  if (value === null || value === undefined) return '';\r\n  const str = String(value);\r\n  if (!_ESCAPE_HTML_RE.test(str)) return str;\r\n  return str.replace(_ESCAPE_HTML_RE_G, (ch) => _ESCAPE_HTML_MAP[ch] || ch);\r\n}\r\n\r\nexport const escapeAttr = escapeHtml;\r\n\r\n//  Marquee Title \r\n\r\nexport function updateTitleWithMarquee(text: string): void {\r\n  const el = document.getElementById('track-title');\r\n  if (!el) return;\r\n\r\n  el.classList.remove('marquee');\r\n  el.style.animation = 'none';\r\n  el.innerText = text;\r\n  el.removeAttribute('data-text');\r\n\r\n  el.style.removeProperty('--marquee-offset');\r\n  el.style.removeProperty('--marquee-duration');\r\n\r\n  setTimeout(() => {\r\n    const parent = el.parentElement;\r\n    if (!parent) return;\r\n\r\n    const overflowWidth = el.scrollWidth - parent.clientWidth;\r\n    const targetOffset = -(overflowWidth + 32);\r\n\r\n    if (overflowWidth > 0) {\r\n      el.classList.add('marquee');\r\n      el.style.setProperty('--marquee-offset', `${targetOffset}px`);\r\n\r\n      const speed = 40;\r\n      const travelDuration = (Math.abs(targetOffset) / speed);\r\n      const totalDuration = travelDuration * 2 + 4;\r\n      el.style.setProperty('--marquee-duration', `${totalDuration}s`);\r\n      el.style.animation = '';\r\n    }\r\n  }, 100);\r\n}\r\n\r\n//  Clipboard \r\n\r\nexport async function copyTextToClipboard(text: string): Promise<boolean> {\r\n  try {\r\n    if (navigator.clipboard && navigator.clipboard.writeText) {\r\n      await navigator.clipboard.writeText(text);\r\n      return true;\r\n    }\r\n    // Fallback\r\n    const ta = document.createElement('textarea');\r\n    ta.value = text;\r\n    ta.style.position = 'fixed';\r\n    ta.style.left = '-9999px';\r\n    document.body.appendChild(ta);\r\n    ta.select();\r\n    const ok = document.execCommand('copy');\r\n    document.body.removeChild(ta);\r\n    return ok;\r\n  } catch (e) {\r\n    log.warn('[Clipboard] Copy failed:', e);\r\n    return false;\r\n  }\r\n}\r\n\r\n//  Fullscreen \r\n\r\nexport function toggleFullscreen(): void {\r\n  try {\r\n    if (!document.fullscreenElement) {\r\n      document.documentElement.requestFullscreen?.();\r\n    } else {\r\n      document.exitFullscreen?.();\r\n    }\r\n  } catch (e) {\r\n    log.debug('[Fullscreen] Toggle failed:', e);\r\n  }\r\n}\r\n\r\n//  Overlay Open Class \r\n\r\nconst _OVERLAY_IDS = ['setup-overlay', 'media-source-overlay', 'youtube-url-overlay'];\r\n\r\nexport function updateOverlayOpenClass(): void {\r\n  try {\r\n    const anyActive = _OVERLAY_IDS.some((id) => {\r\n      const el = document.getElementById(id);\r\n      return !!(el && el.classList.contains('active'));\r\n    });\r\n    if (document.body) document.body.classList.toggle('overlay-open', anyActive);\r\n  } catch { /* ignore */ }\r\n}\r\n\r\nexport function initOverlayOpenObserver(): void {\r\n  try {\r\n    const obs = new MutationObserver(() => updateOverlayOpenClass());\r\n    _OVERLAY_IDS.forEach((id) => {\r\n      const el = document.getElementById(id);\r\n      if (el) obs.observe(el, { attributes: true, attributeFilter: ['class'] });\r\n    });\r\n  } catch { /* ignore */ }\r\n\r\n  updateOverlayOpenClass();\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  i18n (Internationalization)\r\n * Ported from original js/i18n.js\r\n *\r\n * Manages: Korean/English translation, DOM live-patching via MutationObserver.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\n\r\n//  Language State \r\n\r\nlet _activeLanguageMode: 'ko' | 'en' | 'system' = 'system';\r\nlet _resolvedLanguage: 'ko' | 'en' = _resolveSystemLanguage();\r\n\r\n//  Translation Dictionary \r\n\r\nconst I18N_EN: Record<string, string> = {\r\n  \",  \": \", provided by the host\",\r\n  \"    .\": \"Press the sync button to adjust the sync.\",\r\n  \"1   1 \": \"1 request  1 response\",\r\n  \"3  YouTube ...\": \"Playing YouTube in 3 seconds...\",\r\n  \"3   ...\": \"Starting playback in 3 seconds...\",\r\n  \"6     .\": \"You can connect with a 6-digit code.\",\r\n  \"6 \": \"6-digit code\",\r\n  \"6   \": \"Please enter the 6-digit code\",\r\n  \"HTTPS :   .\": \"HTTPS required: works only on a secure connection.\",\r\n  \"Host   -    \": \"Host disconnected  can't receive the file\",\r\n  \"Host :    ...\": \"Host request: reset and recalibrate sync...\",\r\n  \"Host   ( )\": \"Switched to direct Host connection (relay disconnected)\",\r\n  \"Host   .\": \"Only Host can run this.\",\r\n  \"Host   ...\": \"Requesting file from Host...\",\r\n  \"ID  ...\": \"Generating ID...\",\r\n  \"L  \": \"L channel output\",\r\n  \"OP  \": \"Grant OP\",\r\n  \"OP  \": \"Revoke OP\",\r\n  \"Operator  .\": \"Operator permission granted.\",\r\n  \"Operator  .\": \"Operator permission revoked.\",\r\n  \"R  \": \"R channel output\",\r\n  \"Relay  . Host  ...\": \"No relay response. Switching to direct Host...\",\r\n  \"URL  \": \"Please enter a URL\",\r\n  \"VPN/       .\": \"If a VPN/corporate network is on, the connection may fail.\",\r\n  \"Wi-Fi    \": \"No WiFi? Connect to the host's hotspot.\",\r\n  \"YouTube API  .   !\": \"Failed to load the YouTube API. Check your connection!\",\r\n  \"YouTube   -    \": \"Watch YouTube together  advanced audio effects are disabled.\",\r\n  \"YouTube   .  .\": \"YouTube load timed out. Please try again.\",\r\n  \"YouTube  \": \"Enter YouTube link\",\r\n  \"YouTube        .\": \"In YouTube mode, role settings and audio effects are unavailable.\",\r\n  \"YouTube     \": \"High-precision sync isn't available in YouTube mode.\",\r\n  \"YouTube  \": \"YouTube preview thumbnail\",\r\n  \"YouTube     .\": \"Enter a YouTube video or playlist link.\",\r\n  \"YouTube  \": \"Failed to open YouTube\",\r\n  \"YouTube  \": \"YouTube playback started\",\r\n  \"YouTube \": \"Watch YouTube together\",\r\n  \"YouTube !    .\": \"YouTube is ready! Press Play.\",\r\n  \"\\u201C \\u201D      (///)\": \"\\u201CJoin a session\\u201D  enter the code  choose a role (Original/Left/Right/Bass)\",\r\n  \"\\u201C \\u201D     \\u201C!\\u201D\": \"\\u201CI'll host\\u201D  check the code  \\u201CStart!\\u201D\",\r\n  \"  \": \"Virtual bass intensity\",\r\n  \" ( )\": \"Virtual bass (host-ctrl)\",\r\n  \"   \": \"Adjust virtual surround width\",\r\n  \" ( )\": \"Virtual surround (host-ctrl)\",\r\n  \"    .\": \"Set a role for each device.\",\r\n  \"\": \"Intensity\",\r\n  \" WiFi   .\": \"Check that you're on the same WiFi and try again.\",\r\n  \"    .\": \"Create a giant audio system.\",\r\n  \" \": \"Advanced audio\",\r\n  \"     .\": \"You can apply advanced effects system-wide.\",\r\n  \" :   \": \"High-precision sync: preparing audio\",\r\n  \"     .\": \"Only public links can be played together.\",\r\n  \"\": \"permission\",\r\n  \"  / \": \"Choose music/video from your device\",\r\n  \"  \": \"Place the device on the right\",\r\n  \"  \": \"Place the device on the left\",\r\n  \"  \": \"Place the device in the center\",\r\n  \" 0%\": \"Default 0%\",\r\n  \" 0,   ( )\": \"Default 0  Higher = More Distortion\",\r\n  \" 0.1s\": \"Default 0.1s\",\r\n  \" 100,  ,  \": \"Default 100  lower = mono, higher = surround\",\r\n  \" 20.0kHz\": \"Default 20.0kHz\",\r\n  \" 20Hz\": \"Default 20Hz\",\r\n  \" 5.0s\": \"Default 5.0s\",\r\n  \" :\": \"Contact:\",\r\n  \"    .\": \"You can change it later in Settings.\",\r\n  \"\": \"Stay\",\r\n  \"\": \"Width\",\r\n  \"      .\": \"Check your network and try joining again.\",\r\n  \"    .\": \"Check your network connection and the code.\",\r\n  \"  .  WiFi .\": \"Network error occurred. Make sure you're on the same WiFi.\",\r\n  \"  \": \"Network init failed\",\r\n  \"    .    .\": \"Network quality may be low. Try moving closer to the router.\",\r\n  \"  ...\": \"Finishing download...\",\r\n  \"   \": \"Will play after download completes\",\r\n  \" \": \"Next\",\r\n  \" \": \"Next track\",\r\n  \"\": \"Next\",\r\n  \"\": \"Dark\",\r\n  \"\": \"Close\",\r\n  \"  :\": \"Demo load failed:\",\r\n  \"   \": \"Test the app with demo media\",\r\n  \"   .  .\": \"Demo track loaded. Starting playback.\",\r\n  \"   ...\": \"Loading demo track...\",\r\n  \"  . Host  ...\": \"Data reception unstable. Requesting Host recovery...\",\r\n  \"\": \"Help\",\r\n  \"  \": \"Need help?\",\r\n  \"\": \"Sync\",\r\n  \" \": \"Play together\",\r\n  \"    \": \"Enter a video or playlist link\",\r\n  \" \": \"same network\",\r\n  \"     .\": \"Make sure both devices are on the same network.\",\r\n  \"\": \"Light\",\r\n  \"\": \"Low-pass\",\r\n  \"  \": \"Local network only\",\r\n  \"  \": \"Choose local file\",\r\n  \"( WiFi/)\": \"local (same WiFi/hotspot)\",\r\n  \" \": \"Load local file\",\r\n  \" :\": \"Load local file:\",\r\n  \"  .\": \" and enter it to connect.\",\r\n  \" \": \"Reverb low-cut\",\r\n  \" \": \"Reverb mix\",\r\n  \"  \": \"Reverb decay\",\r\n  \" \": \"Reverb pre-delay\",\r\n  \" \": \"Reverb high-cut\",\r\n  \"( )\": \"Reverb (host-ctrl)\",\r\n  \", ,   \": \"Reverb, EQ, virtual effects, and more\",\r\n  \"  ...  \": \"Waiting for relay... please hold on\",\r\n  \"  . Host  ...\": \"No relay response. Receiving directly from Host...\",\r\n  \"   ...\": \"Requesting file via relay...\",\r\n  \"    \": \"Paste a link to add it to the playlist\",\r\n  \"!\": \"Last step!\",\r\n  \"\": \"Message\",\r\n  \" \": \"Send message\",\r\n  \" ...\": \"Type a message...\",\r\n  \"\": \"Home\",\r\n  \"  \": \"Go to Home\",\r\n  \"  Auto Sync ...\": \"Requesting Auto Sync on all devices...\",\r\n  \"   ...\": \"Requesting resync on all devices...\",\r\n  \" \": \"All devices must be connected to the\",\r\n  \"   Wi-Fi \": \"Connect all devices to the same WiFi\",\r\n  \" \": \"Join a session\",\r\n  \"Sean Pitaro - Passport [NCS Release]\": \"Sean Pitaro - Passport [NCS Release]\",\r\n  \" \": \"No media\",\r\n  \" \": \"Play media\",\r\n  \" \": \"Play media\",\r\n  \" \": \"Add media\",\r\n  \" .\": \"Please add media.\",\r\n  \"\": \"Mix\",\r\n  \"  \": \"Change repeat mode\",\r\n  \" : \": \"Repeat: Off\",\r\n  \" : \": \"Repeat: All\",\r\n  \" :  \": \"Repeat: One\",\r\n  \" \": \"Decay time\",\r\n  \" \": \"Pre-delay\",\r\n  \"   3\": \"3 devices excluding the host\",\r\n  \":\": \"Host:\",\r\n  \"    .\": \"Only the host can add media.\",\r\n  \"     .\": \"Only the host can add YouTube links.\",\r\n  \" 3  .\": \"Hosts see three options.\",\r\n  \"  6  \": \"Enter the 6-digit code from the host\",\r\n  \"\": \"Placement\",\r\n  \"   \": \"A background task error occurred\",\r\n  \" \": \"Couldn't copy\",\r\n  \" \": \"Adjust volume\",\r\n  \"\": \"granted\",\r\n  \"  :  iOS(15.2+) .\": \"Browser update required: update to the latest iOS (15.2+).\",\r\n  \"  .   .\": \"A new version is ready. Refresh to update.\",\r\n  \"\": \"Refresh\",\r\n  \"\": \"Subwoofer\",\r\n  \" \": \"Adjust subwoofer\",\r\n  \"  \": \"Subwoofer cutoff frequency\",\r\n  \":\": \"Subwoofer:\",\r\n  \"\": \"Settings\",\r\n  \"  \": \"Settings  Help\",\r\n  \"  \": \"Couldn't create session\",\r\n  \"  \": \"Session is full\",\r\n  \" .\": \"Session has been reset.\",\r\n  \"  \": \"Change shuffle mode\",\r\n  \": \": \"Shuffle: Off\",\r\n  \": \": \"Shuffle: On\",\r\n  \"  \": \"Demo Track\",\r\n  \"() \": \"Stereo (default) output\",\r\n  \" \": \"Play through speakers\",\r\n  \"\": \"System\",\r\n  \"\": \"Start\",\r\n  \"  .\": \"No messages yet.\",\r\n  \"\": \"Info\",\r\n  \"!   .\": \"Hi! Please choose your role.\",\r\n  \"  ()\": \"Try it (Demo)\",\r\n  \" :\": \"Try the app:\",\r\n  \"  Language\": \"Language  \",\r\n  \"   \": \"Listen together, anywhere\",\r\n  \"\": \"Update\",\r\n  \"  .\": \".\",\r\n  \"     .\": \".\",\r\n  \" .\": \".\",\r\n  \"   \": \"Connect multiple devices wirelessly\",\r\n  \"\": \"Role\",\r\n  \"( )\": \"Role (output channel)\",\r\n  \"  \": \"Please select a role\",\r\n  \"   .\": \"Select a role to join.\",\r\n  \" \": \"Please select a role\",\r\n  \"     .\": \"Role is auto-assigned and can't be changed.\",\r\n  \" \": \"Connection failed\",\r\n  \" :   \": \"Connection error: file transfer failed\",\r\n  \"  \": \"Failed to prepare connection\",\r\n  \" ...\": \"Connecting...\",\r\n  \"  6 \": \"Enter 6-digit code\",\r\n  \"  .\": \"Please enter the connection code.\",\r\n  \"    .\": \"Playback is synchronized on all connected devices.\",\r\n  \"      .\": \"The selected media plays simultaneously on all connected devices.\",\r\n  \"\": \"connected\",\r\n  \"  \": \"Connection issue occurred\",\r\n  \" \": \"Disconnected\",\r\n  \" :\": \"Unstable connection:\",\r\n  \"  : WiFi       .\": \"If it won't connect: reconnect WiFi  refresh the app.\",\r\n  \" \": \"Couldn't connect\",\r\n  \"   \": \"You can connect up to\",\r\n  \"   ...\": \"Loading video info...\",\r\n  \"    \": \"Couldn't load video info\",\r\n  \".\": \".\",\r\n  \"  !\": \"Audio decode failed!\",\r\n  \"  ...\": \"Decoding audio...\",\r\n  \"   ...\": \"Loading audio into memory...\",\r\n  \"   .   .\": \"Couldn't load the audio engine. Check your network.\",\r\n  \"   \": \"Couldn't prepare the audio engine\",\r\n  \"    .   .\": \"The audio engine isn't ready yet. Check your network.\",\r\n  \"  .        .\": \"Couldn't prepare audio. Tap the screen once and try again.\",\r\n  \" \": \"Right speaker\",\r\n  \" :\": \"Right speaker:\",\r\n  \"  \": \"A perfect sound experience\",\r\n  \" \": \"Left speaker\",\r\n  \" :\": \"Left speaker:\",\r\n  \",    \": \"Play left and right channels separately, and\",\r\n  \"    .\": \"Feel powerful bass with Woofer mode.\",\r\n  \"    \": \"Error handling worker message\",\r\n  \"    !\": \"Worker error occurred!\",\r\n  \" ( )\": \"YouTube (compatibility mode)\",\r\n  \"( ):\": \"YouTube (no channel split):\",\r\n  \"  YouTube \": \"Invalid YouTube link\",\r\n  \"  \": \"Invalid time\",\r\n  \" YouTube  \": \"Not a valid YouTube link\",\r\n  \" .\": \".\",\r\n  \"   \": \"Set this device's role\",\r\n  \"    ?\": \"What should this device play?\",\r\n  \" \": \"This version works only on\",\r\n  \"    \": \"Enter this code on your other devices\",\r\n  \" \": \"How to connect\",\r\n  \" \": \"Previous\",\r\n  \" \": \"Previous track\",\r\n  \"   .\": \"Now connect your other devices.\",\r\n  \" ( )\": \"Equalizer (host-ctrl)\",\r\n  \"\": \"Pause\",\r\n  \" \": \"Spatial audio\",\r\n  \"   (OP)\": \"Auto-play canceled (OP)\",\r\n  \"  \": \"Auto-play canceled\",\r\n  \"   .\": \"Please try again in a moment.\",\r\n  \"...\": \"Just a moment...\",\r\n  \" \": \"Play\",\r\n  \"  \": \"Seek\",\r\n  \"  \": \"Ready to play\",\r\n  \"/\": \"Play/Pause\",\r\n  \"\": \"Playlist\",\r\n  \"  \": \"Select media to play\",\r\n  \"  \": \"Bass mix output\",\r\n  \" \": \"Toggle fullscreen\",\r\n  \"\": \"Stop\",\r\n  \"  \": \"Stop request sent\",\r\n  \" \": \"I'll host\",\r\n  \"  ... Host  \": \"Preparation delayed... requesting Host recovery\",\r\n  \" \": \"Center speaker\",\r\n  \" :\": \"Center speaker:\",\r\n  \"   ( )\": \"Direct sync complete (local network)\",\r\n  \"\": \"Guest\",\r\n  \":\": \"Guest:\",\r\n  \"\": \"Guests choose the\",\r\n  \" ...\": \"Joining...\",\r\n  \" \": \"Joining\",\r\n  \" .  WiFi    .\": \"Couldn't join. Make sure you're connected to the same WiFi.\",\r\n  \"  \": \"Can't join\",\r\n  \"\": \"Chat\",\r\n  \" \": \"Close chat\",\r\n  \"  \": \"Type a chat message\",\r\n  \" \": \"Open chat\",\r\n  \" \": \"Start chatting\",\r\n  \"   !\": \"Send your first message!\",\r\n  \" \": \"Home screen\",\r\n  \"  ?\": \"Return to the start screen?\",\r\n  \"   ...\": \"Starting reset and recalibration...\",\r\n  \"\": \"Reset\",\r\n  \" \": \"Invite code\",\r\n  \"    \": \"Show & copy invite code\",\r\n  \"   \": \"No invite code yet\",\r\n  \"      \": \"You can find the invite code in Settings and Help.\",\r\n  \" \": \"Invite & Share\",\r\n  \"    ...\": \"Applying optimal sync calibration...\",\r\n  \"\": \"Cancel\",\r\n  \"    :\": \"I entered the code but can't connect:\",\r\n  \"  \": \"Click to copy invite code\",\r\n  \"\": \"Theme\",\r\n  \"  ...\": \"Requesting file...\",\r\n  \"  \": \"Sending file\",\r\n  \"   \": \"Select a file or check the playlist\",\r\n  \"   \": \"Can't select a file\",\r\n  \" !    .\": \"Your file is ready! Press Play.\",\r\n  \"  -   ...\": \"Preload missing  receiving file...\",\r\n  \"   ...\": \"Waiting for preload to complete...\",\r\n  \"   -  \": \"Preload playback failed  reloading\",\r\n  \"  !\": \"Using preloaded file!\",\r\n  \"\": \"Preamp\",\r\n  \" \": \"Preamp gain\",\r\n  \" /\": \"Expand/collapse playlist\",\r\n  \" \": \"added to playlist\",\r\n  \"   \": \"Failed to load required libraries\",\r\n  \"\": \"If needed, you can change the role anytime in\",\r\n  \"\": \"High-pass\",\r\n  \"   .\": \"You will be disconnected from the current session.\",\r\n  \"     (  3) .\": \"This session has reached the device limit (3 excluding the host).\",\r\n  \"  .   .\": \"No host connection. Local reset complete.\",\r\n  \"  \": \"When the host starts playback,\",\r\n  \"   \": \"Only the host can control this\",\r\n  \"    \": \"Only the host can add files\",\r\n  \"   \": \"Can't connect to the host\",\r\n  \"  .   .\": \"The host ended the connection. Returning to Home.\",\r\n  \"  \": \"In sync with the host's settings\",\r\n  \"  .\": \"Enter the host's code.\",\r\n  \"  \": \"Add to Home Screen\",\r\n  \"\": \"OK\",\r\n  \"/\": \"OK / Refresh\",\r\n  \"   (Worker)   .\": \"Due to environment limits, background timers (Worker) aren't available.\",\r\n  \"   /(Worker)   .\": \"Due to environment limits, file save/transfer (Worker) isn't available.\",\r\n  \"\": \"revoked\",\r\n};\r\n\r\n//  Regex-based Dynamic Translations \r\n\r\ntype RegexHandler = (...args: string[]) => string;\r\n\r\nconst I18N_EN_REGEX: [RegExp, RegexHandler][] = [\r\n  [/^ :\\s*(\\d{6})$/i, (_m, code) => `Invite code: ${code}`],\r\n  [/^ \\s*(\\d+)\\s*\\|\\s* \\s*(\\d{6})$/i, (_m, cnt, code) => `Connected devices: ${cnt} | Invite code ${code}`],\r\n  [/^(\\d+) $/i, (_m, cnt) => {\r\n    const n = Number(cnt);\r\n    if (!Number.isFinite(n)) return `Added ${cnt} tracks`;\r\n    return n === 1 ? 'Added 1 track' : `Added ${n} tracks`;\r\n  }],\r\n  [/^\"(.+)\"\\s* $/i, (_m, title) => `Added \"${title}\" to playlist`],\r\n  [/^ :\\s*(.+)$/i, (_m, name) => `Preparing: ${name}`],\r\n  [/^  :\\s*(.+)$/i, (_m, name) => `Recovery pending: ${name}`],\r\n  [/^  :\\s*(.+)$/i, (_m, name) => `Syncing file: ${name}`],\r\n  [/^  :\\s*(.+)$/i, (_m, name) => `File save error: ${name}`],\r\n  [/^(.+)\\s*$/i, (_m, name) => `${name} connected`],\r\n  [/^(.+)\\s* $/i, (_m, name) => `${name} disconnected`],\r\n  [/^(.+)\\s* $/i, (_m, name) => `${name} connection error`],\r\n  [/^(.+)\\s* $/i, (_m, src) => `Resume transfer from ${src}`],\r\n  [/^(.+)\\s*  $/i, (_m, src) => `Started receiving file from ${src}`],\r\n  [/^(.+)\\s* \\s*\\((.+)\\)$/i, (_m, src, start) => `Resuming transfer from ${src} (from ${start})`],\r\n  [/^(.+)\\s* \\.\\.\\.\\s*(.*)$/i, (_m, src, rest) => `Receiving from ${src}... ${rest}`],\r\n  [/^   ,\\s*\\+?(\\d+)ms$/i, (_m, ms) => `Auto sync calibration done, +${ms}ms`],\r\n  [/^ :\\s*(.+)$/i, (_m, v) => `Reverb type: ${v}`],\r\n  [/^Host  :\\s*(.+)$/i, (_m, t) => `Host force sync: ${t}`],\r\n  [/^Relay:\\s*(.+)\\s*$/i, (_m, id) => `Relay: ${id} connected`],\r\n  [/^(.+)\\s*$/i, (_m, t) => `Seek to ${t}`],\r\n  [/^   \\.\\.\\.\\s*\\((.+)\\)$/i, (_m, name) => `Preparing next track... (${name})`],\r\n];\r\n\r\n//  Internal Helpers \r\n\r\nlet _i18nObserver: MutationObserver | null = null;\r\nlet _i18nApplying = false;\r\nconst _i18nOriginalText = new Map<Text, { raw: string; translated: string }>();\r\nconst _i18nOriginalAttr = new Map<Element, Record<string, { raw: string; translated: string }>>();\r\nlet _i18nKeyOrder: string[] | null = null;\r\n\r\nfunction _i18nNorm(s: string): string {\r\n  return String(s ?? '').replace(/\\s+/g, ' ').trim();\r\n}\r\n\r\n//  Public API \r\n\r\nexport function i18nTranslate(str: string | null | undefined): string {\r\n  if (_resolvedLanguage !== 'en') return str as string;\r\n  if (str === null || str === undefined) return str as unknown as string;\r\n\r\n  const raw = String(str);\r\n  const lead = raw.match(/^\\s*/)?.[0] ?? '';\r\n  const trail = raw.match(/\\s*$/)?.[0] ?? '';\r\n  const core = raw.trim();\r\n  const key = _i18nNorm(core);\r\n  if (!key) return raw;\r\n\r\n  // 1) Exact match\r\n  let translated: string | undefined = I18N_EN[key];\r\n\r\n  // 2) Regex rules\r\n  if (!translated) {\r\n    for (const [re, fn] of I18N_EN_REGEX) {\r\n      const m = key.match(re);\r\n      if (!m) continue;\r\n      try {\r\n        translated = fn(...m);\r\n      } catch {\r\n        translated = undefined;\r\n      }\r\n      break;\r\n    }\r\n  }\r\n\r\n  // 3) Fragment replacement fallback\r\n  if (!translated) {\r\n    if (!_i18nKeyOrder) {\r\n      _i18nKeyOrder = Object.keys(I18N_EN).sort((a, b) => b.length - a.length);\r\n    }\r\n    let out = key;\r\n    for (const k of _i18nKeyOrder) {\r\n      if (!out.includes(k)) continue;\r\n      out = out.split(k).join(I18N_EN[k]);\r\n    }\r\n    translated = out;\r\n  }\r\n\r\n  let t = translated;\r\n  if (lead) t = t.replace(/^\\s+/, '');\r\n  if (trail) t = t.replace(/\\s+$/, '');\r\n  return lead + t + trail;\r\n}\r\n\r\nexport function getResolvedLanguage(): 'ko' | 'en' {\r\n  return _resolvedLanguage;\r\n}\r\n\r\n//  DOM Translation \r\n\r\nfunction _i18nShouldSkipTextNode(node: Node): boolean {\r\n  try {\r\n    const p = node?.parentNode as Element | null;\r\n    if (!p || p.nodeType !== 1) return false;\r\n    const tag = p.tagName;\r\n    return tag === 'SCRIPT' || tag === 'STYLE' || tag === 'NOSCRIPT';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction _i18nTranslateTextNode(node: Text): void {\r\n  if (!node || node.nodeType !== 3) return;\r\n  if (_i18nShouldSkipTextNode(node)) return;\r\n\r\n  const raw = node.data;\r\n  if (!raw || !raw.trim()) return;\r\n\r\n  const translated = i18nTranslate(raw);\r\n  if (translated === raw) return;\r\n\r\n  _i18nOriginalText.set(node, { raw, translated });\r\n  node.data = translated;\r\n}\r\n\r\nfunction _i18nTranslateElementAttrs(el: Element): void {\r\n  if (!el || el.nodeType !== 1) return;\r\n  const tag = el.tagName;\r\n  if (tag === 'SCRIPT' || tag === 'STYLE' || tag === 'NOSCRIPT') return;\r\n\r\n  const attrs = ['aria-label', 'title', 'placeholder', 'alt'];\r\n  for (const a of attrs) {\r\n    if (!el.hasAttribute(a)) continue;\r\n    const raw = el.getAttribute(a);\r\n    if (!raw) continue;\r\n\r\n    const translated = i18nTranslate(raw);\r\n    if (translated === raw) continue;\r\n\r\n    let store = _i18nOriginalAttr.get(el);\r\n    if (!store) {\r\n      store = {};\r\n      _i18nOriginalAttr.set(el, store);\r\n    }\r\n    store[a] = { raw, translated };\r\n    el.setAttribute(a, translated);\r\n  }\r\n}\r\n\r\nfunction _i18nTranslateSubtree(root: Node): void {\r\n  if (_resolvedLanguage !== 'en') return;\r\n  if (!root) return;\r\n\r\n  _i18nApplying = true;\r\n  try {\r\n    if (root.nodeType === 1) {\r\n      _i18nTranslateElementAttrs(root as Element);\r\n      (root as Element).querySelectorAll?.('*')?.forEach(el => _i18nTranslateElementAttrs(el));\r\n    }\r\n\r\n    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);\r\n    let n: Text | null;\r\n    while ((n = walker.nextNode() as Text | null)) {\r\n      _i18nTranslateTextNode(n);\r\n    }\r\n  } finally {\r\n    _i18nApplying = false;\r\n  }\r\n}\r\n\r\nfunction _i18nRestoreAll(): void {\r\n  _i18nApplying = true;\r\n  try {\r\n    for (const [node, st] of _i18nOriginalText.entries()) {\r\n      try {\r\n        if (!st) continue;\r\n        if (node.data === st.translated) node.data = st.raw;\r\n      } catch { /* ignore */ }\r\n    }\r\n    for (const [el, store] of _i18nOriginalAttr.entries()) {\r\n      try {\r\n        for (const [a, st] of Object.entries(store || {})) {\r\n          if (!st) continue;\r\n          if (el.getAttribute(a) === st.translated) el.setAttribute(a, st.raw);\r\n        }\r\n      } catch { /* ignore */ }\r\n    }\r\n    _i18nOriginalText.clear();\r\n    _i18nOriginalAttr.clear();\r\n  } finally {\r\n    _i18nApplying = false;\r\n  }\r\n}\r\n\r\nfunction _resolveSystemLanguage(): 'ko' | 'en' {\r\n  try {\r\n    const langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language || ''];\r\n    const first = String(langs[0] || '').toLowerCase();\r\n    return first.startsWith('ko') ? 'ko' : 'en';\r\n  } catch {\r\n    return 'ko';\r\n  }\r\n}\r\n\r\nfunction _applyResolvedLanguage(resolved: string): void {\r\n  _resolvedLanguage = resolved === 'en' ? 'en' : 'ko';\r\n  try {\r\n    document.documentElement.setAttribute('lang', _resolvedLanguage);\r\n  } catch { /* ignore */ }\r\n\r\n  if (!_i18nObserver && typeof MutationObserver !== 'undefined') {\r\n    _i18nObserver = new MutationObserver((mutations) => {\r\n      if (_i18nApplying) return;\r\n      if (_resolvedLanguage !== 'en') return;\r\n\r\n      _i18nApplying = true;\r\n      try {\r\n        for (const m of mutations) {\r\n          if (m.type === 'characterData') {\r\n            _i18nTranslateTextNode(m.target as Text);\r\n          } else if (m.type === 'attributes') {\r\n            _i18nTranslateElementAttrs(m.target as Element);\r\n          } else if (m.type === 'childList') {\r\n            m.addedNodes?.forEach(n => {\r\n              if (n.nodeType === 3) _i18nTranslateTextNode(n as Text);\r\n              else if (n.nodeType === 1) _i18nTranslateSubtree(n);\r\n            });\r\n            m.removedNodes?.forEach(n => {\r\n              if (n.nodeType === 3) _i18nOriginalText.delete(n as Text);\r\n              else if (n.nodeType === 1) {\r\n                _i18nOriginalAttr.delete(n as Element);\r\n                try {\r\n                  const walker = document.createTreeWalker(n, NodeFilter.SHOW_TEXT);\r\n                  let tn: Text | null;\r\n                  while ((tn = walker.nextNode() as Text | null)) _i18nOriginalText.delete(tn);\r\n                } catch { /* detached node */ }\r\n              }\r\n            });\r\n          }\r\n        }\r\n      } finally {\r\n        _i18nApplying = false;\r\n      }\r\n    });\r\n    try {\r\n      _i18nObserver.observe(document.body || document.documentElement, {\r\n        subtree: true,\r\n        childList: true,\r\n        characterData: true,\r\n        attributes: true,\r\n        attributeFilter: ['aria-label', 'title', 'placeholder', 'alt'],\r\n      });\r\n    } catch { /* ignore */ }\r\n  }\r\n\r\n  if (_resolvedLanguage === 'en') {\r\n    _i18nTranslateSubtree(document.body || document.documentElement);\r\n  } else {\r\n    _i18nRestoreAll();\r\n  }\r\n}\r\n\r\nfunction _updateLanguageSelector(mode: string): void {\r\n  try {\r\n    document.querySelectorAll('.lang-opt').forEach(el => el.classList.remove('active'));\r\n    const id = mode === 'ko' ? 'lang-ko' : mode === 'en' ? 'lang-en' : 'lang-system';\r\n    document.getElementById(id)?.classList.add('active');\r\n\r\n    const pillIndex = mode === 'ko' ? 0 : mode === 'en' ? 1 : 2;\r\n    document.querySelectorAll<HTMLElement>('.lang-selector').forEach(sel => {\r\n      sel.style.setProperty('--pill-index', String(pillIndex));\r\n    });\r\n  } catch { /* ignore */ }\r\n}\r\n\r\nexport function setLanguageMode(mode: string): void {\r\n  if (mode !== 'ko' && mode !== 'en' && mode !== 'system') mode = 'system';\r\n  _activeLanguageMode = mode as 'ko' | 'en' | 'system';\r\n  _updateLanguageSelector(mode);\r\n\r\n  const resolved = (mode === 'system') ? _resolveSystemLanguage() : mode;\r\n  _applyResolvedLanguage(resolved);\r\n}\r\n\r\n//  Init \r\n\r\nexport function initI18n(): void {\r\n  setLanguageMode('system');\r\n\r\n  try {\r\n    window.addEventListener('languagechange', () => {\r\n      if (_activeLanguageMode !== 'system') return;\r\n      _applyResolvedLanguage(_resolveSystemLanguage());\r\n    });\r\n  } catch { /* ignore */ }\r\n\r\n  log.info('[i18n] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Toast & Loader\r\n * Extracted from original app.js lines 10097-10148\r\n *\r\n * Manages: Toast notifications, header loading bar.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { i18nTranslate } from './i18n.ts';\r\n\r\n//  Loader (Header Progress Bar) \r\n\r\nexport function updateLoader(percent: number): void {\r\n  const progressBg = document.getElementById('header-progress-bg');\r\n  if (progressBg) {\r\n    (progressBg as HTMLElement).style.width = `${percent}%`;\r\n  }\r\n}\r\n\r\nexport function showLoader(show: boolean, txt?: string): void {\r\n  const header = document.getElementById('main-header');\r\n  const loadingText = document.getElementById('header-loading-text');\r\n  const progressBg = document.getElementById('header-progress-bg') as HTMLElement | null;\r\n\r\n  if (show) {\r\n    header?.classList.add('loading');\r\n    if (txt && loadingText) loadingText.innerText = i18nTranslate(txt) ?? '';\r\n    if (progressBg && (progressBg.style.width === '0px' || progressBg.style.width === '')) {\r\n      progressBg.style.width = '0%';\r\n    }\r\n  } else {\r\n    header?.classList.remove('loading');\r\n    setTimeout(() => {\r\n      if (progressBg) progressBg.style.width = '0%';\r\n    }, 400);\r\n  }\r\n}\r\n\r\n//  Toast \r\n\r\nlet _toastTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\nexport function showToast(msg: unknown): void {\r\n  try {\r\n    const t = document.getElementById('toast');\r\n    const msgEl = document.getElementById('toast-msg');\r\n    const text = (msg === undefined || msg === null) ? '' : String(msg);\r\n\r\n    if (!t || !msgEl) {\r\n      console.info('[Toast]', text);\r\n      return;\r\n    }\r\n\r\n    msgEl.innerText = i18nTranslate(text) ?? '';\r\n    t.classList.add('show');\r\n\r\n    if (_toastTimer) clearTimeout(_toastTimer);\r\n    _toastTimer = setTimeout(() => {\r\n      try { t.classList.remove('show'); } catch { /* noop */ }\r\n    }, 2000);\r\n  } catch (e) {\r\n    console.info('[Toast fallback]', msg);\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initToast(): void {\r\n  log.info('[Toast] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Dialog / Modal System\r\n * Extracted from original app.js lines 10150-10336\r\n *\r\n * Manages: Promise-based modal dialogs with queue, focus trap, a11y.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { showToast } from './toast.ts';\r\nimport { i18nTranslate } from './i18n.ts';\r\n\r\n//  Types \r\n\r\nexport interface DialogOptions {\r\n  title?: string;\r\n  message?: string;\r\n  buttonText?: string;\r\n  secondaryText?: string;\r\n  cancelText?: string;\r\n  dismissible?: boolean;\r\n  defaultFocus?: 'primary' | 'secondary' | 'close';\r\n}\r\n\r\nexport interface DialogResult {\r\n  action: string;\r\n}\r\n\r\ninterface DialogActiveState {\r\n  resolve: (result: DialogResult) => void;\r\n  prevFocus: Element | null;\r\n  cleanup: (() => void)[];\r\n}\r\n\r\n//  State \r\n\r\nlet _dialogActive: DialogActiveState | null = null;\r\nconst _dialogQueue: Array<{ opts: DialogOptions | string; resolve: (result: DialogResult) => void }> = [];\r\n\r\n//  Internal \r\n\r\nfunction drainDialogQueue(): void {\r\n  if (_dialogActive) return;\r\n  const next = _dialogQueue.shift();\r\n  if (!next) return;\r\n  _openDialog(next.opts, next.resolve);\r\n}\r\n\r\nexport function closeDialog(action = 'close'): void {\r\n  const overlay = document.getElementById('dialog-overlay');\r\n  if (overlay) {\r\n    overlay.classList.remove('show');\r\n    overlay.setAttribute('aria-hidden', 'true');\r\n  }\r\n\r\n  const active = _dialogActive;\r\n  _dialogActive = null;\r\n\r\n  try {\r\n    if (active && Array.isArray(active.cleanup)) {\r\n      active.cleanup.forEach(fn => { try { fn(); } catch { /* ignore */ } });\r\n    }\r\n  } catch { /* ignore */ }\r\n\r\n  if (active?.prevFocus && typeof (active.prevFocus as HTMLElement).focus === 'function') {\r\n    try { (active.prevFocus as HTMLElement).focus(); } catch { /* ignore */ }\r\n  }\r\n\r\n  if (typeof active?.resolve === 'function') {\r\n    try { active.resolve({ action }); } catch { /* ignore */ }\r\n  }\r\n\r\n  setTimeout(drainDialogQueue, 0);\r\n}\r\n\r\nfunction _openDialog(opts: DialogOptions | string, resolve: (result: DialogResult) => void): void {\r\n  const overlay = document.getElementById('dialog-overlay');\r\n  const titleEl = document.getElementById('dialog-title');\r\n  const msgEl = document.getElementById('dialog-message');\r\n  const okBtn = document.getElementById('btn-dialog-ok') as HTMLButtonElement | null;\r\n  const secondaryBtn = document.getElementById('btn-dialog-secondary') as HTMLButtonElement | null;\r\n  const closeBtn = document.getElementById('btn-dialog-close') as HTMLButtonElement | null;\r\n\r\n  if (!overlay || !titleEl || !msgEl || !okBtn || !closeBtn) {\r\n    showToast(typeof opts === 'string' ? opts : (opts?.message || ''));\r\n    resolve({ action: 'fallback' });\r\n    setTimeout(drainDialogQueue, 0);\r\n    return;\r\n  }\r\n\r\n  const o = (typeof opts === 'object' && opts) ? opts : { message: String(opts ?? '') };\r\n  const title = (typeof opts === 'string') ? '' : (o.title || '');\r\n  const message = (typeof opts === 'string') ? String(opts ?? '') : String(o.message || '');\r\n  const buttonText = o.buttonText ? String(o.buttonText) : '';\r\n  const secondaryTextRaw = (o.secondaryText !== undefined && o.secondaryText !== null)\r\n    ? o.secondaryText\r\n    : ((o.cancelText !== undefined && o.cancelText !== null) ? o.cancelText : '');\r\n  const secondaryText = String(secondaryTextRaw ?? '').trim();\r\n  const hasSecondary = !!secondaryText;\r\n  const dismissible = (o.dismissible !== undefined) ? !!o.dismissible : true;\r\n  const defaultFocus = o.defaultFocus\r\n    ? String(o.defaultFocus)\r\n    : (hasSecondary ? 'secondary' : 'primary');\r\n\r\n  titleEl.textContent = i18nTranslate(title) ?? '';\r\n  msgEl.textContent = i18nTranslate(message) ?? '';\r\n  okBtn.textContent = i18nTranslate(buttonText) ?? '';\r\n\r\n  if (secondaryBtn) {\r\n    if (hasSecondary) {\r\n      secondaryBtn.textContent = i18nTranslate(secondaryText) ?? '';\r\n      secondaryBtn.style.display = '';\r\n    } else {\r\n      secondaryBtn.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  const prevFocus = document.activeElement;\r\n\r\n  overlay.classList.add('show');\r\n  overlay.setAttribute('aria-hidden', 'false');\r\n\r\n  const cleanup: (() => void)[] = [];\r\n  const on = (target: EventTarget | null, type: string, handler: EventListener) => {\r\n    if (!target) return;\r\n    target.addEventListener(type, handler);\r\n    cleanup.push(() => {\r\n      try { target.removeEventListener(type, handler); } catch { /* ignore */ }\r\n    });\r\n  };\r\n\r\n  _dialogActive = { resolve, prevFocus, cleanup };\r\n\r\n  const done = (action: string) => closeDialog(action);\r\n\r\n  on(overlay, 'click', (e) => {\r\n    if (!dismissible) return;\r\n    if (e.target === overlay) done('overlay');\r\n  });\r\n\r\n  on(okBtn, 'click', () => done('ok'));\r\n  if (hasSecondary && secondaryBtn) {\r\n    on(secondaryBtn, 'click', () => done('secondary'));\r\n  }\r\n  on(closeBtn, 'click', () => {\r\n    if (!dismissible) return done('ok');\r\n    done('close');\r\n  });\r\n\r\n  on(window, 'keydown', (e) => {\r\n    const ke = e as KeyboardEvent;\r\n    if (ke.key === 'Escape') {\r\n      if (!dismissible) return;\r\n      ke.preventDefault();\r\n      done('escape');\r\n      return;\r\n    }\r\n\r\n    if (ke.key === 'Tab') {\r\n      const focusables = [\r\n        closeBtn,\r\n        hasSecondary ? secondaryBtn : null,\r\n        okBtn,\r\n      ].filter((x): x is HTMLButtonElement => x != null && x.offsetParent !== null);\r\n      if (focusables.length === 0) return;\r\n\r\n      const first = focusables[0]!;\r\n      const last = focusables[focusables.length - 1]!;\r\n      const activeEl = document.activeElement;\r\n\r\n      if (ke.shiftKey) {\r\n        if (activeEl === first || !overlay.contains(activeEl)) {\r\n          ke.preventDefault();\r\n          last.focus();\r\n        }\r\n      } else {\r\n        if (activeEl === last) {\r\n          ke.preventDefault();\r\n          first.focus();\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  setTimeout(() => {\r\n    try {\r\n      const pick = (defaultFocus === 'secondary' && hasSecondary && secondaryBtn)\r\n        ? secondaryBtn\r\n        : (defaultFocus === 'close' ? closeBtn : okBtn);\r\n      (pick || okBtn)!.focus();\r\n    } catch { /* ignore */ }\r\n  }, 0);\r\n}\r\n\r\n//  Public API \r\n\r\nexport function showDialog(opts: DialogOptions | string = {}): Promise<DialogResult> {\r\n  return new Promise((resolve) => {\r\n    _dialogQueue.push({ opts, resolve });\r\n    drainDialogQueue();\r\n  });\r\n}\r\n\r\nexport function initDialog(): void {\r\n  log.info('[Dialog] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Tab Navigation\r\n * Extracted from original app.js lines 1927-1959\r\n *\r\n * Manages: Tab switching (mobile bottom nav & desktop grid).\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState } from '../core/state.ts';\r\nimport { APP_STATE } from '../core/constants.ts';\r\nimport { animateTransition } from './dom.ts';\r\n\r\n//  Chat Drawer State \r\n\r\nlet _isChatDrawerOpen = false;\r\n\r\nexport function isChatDrawerOpen(): boolean {\r\n  return _isChatDrawerOpen;\r\n}\r\n\r\nexport function setChatDrawerOpen(open: boolean): void {\r\n  _isChatDrawerOpen = open;\r\n}\r\n\r\n//  Tab Switching \r\n\r\nexport function switchTab(tabId: string): void {\r\n  animateTransition(() => {\r\n    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));\r\n    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));\r\n    const tabEl = document.getElementById(`tab-${tabId}`);\r\n    if (tabEl) tabEl.classList.add('active');\r\n    const tabs = ['play', 'playlist', 'settings', 'guide'];\r\n    const idx = tabs.indexOf(tabId);\r\n    if (idx >= 0) document.querySelectorAll('.nav-item')[idx]?.classList.add('active');\r\n\r\n    if (tabId === 'settings') {\r\n      bus.emit('ui:settings-tab-opened');\r\n    }\r\n\r\n    if (tabId === 'play') {\r\n      setTimeout(() => {\r\n        const currentState = getState<string>('appState');\r\n        if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n          bus.emit('youtube:refresh-display');\r\n        }\r\n        bus.emit('ui:visualizer-check');\r\n      }, 50);\r\n    }\r\n\r\n    if (_isChatDrawerOpen) {\r\n      bus.emit('ui:toggle-chat-drawer');\r\n    }\r\n  });\r\n}\r\n\r\n//  Init \r\n\r\nexport function initTabs(): void {\r\n  // Bottom navigation\r\n  document.querySelectorAll<HTMLElement>('.bottom-nav .nav-item[data-tab]').forEach(el => {\r\n    el.addEventListener('click', () => {\r\n      try { el.blur(); } catch { /* ignore */ }\r\n      if (el.classList.contains('active')) {\r\n        const tabBody = document.querySelector(`#tab-${el.dataset.tab} .tab-body`);\r\n        if (tabBody) tabBody.scrollTo({ top: 0, behavior: 'smooth' });\r\n      } else {\r\n        switchTab(el.dataset.tab!);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Listen for programmatic tab switch\r\n  bus.on('ui:switch-tab', ((...args: unknown[]) => {\r\n    const tabId = args[0] as string;\r\n    if (tabId) switchTab(tabId);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Tabs] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Canvas FFT Visualizer\r\n * Extracted from original app.js lines 5712-5918\r\n *\r\n * Manages: Bass/High frequency circle visualizer with light/dark theme.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState } from '../core/state.ts';\r\nimport { isIdleOrPaused } from '../player/video.ts';\r\n\r\n//  State \r\n\r\nlet _animationId: number | null = null;\r\nlet _visualizerRetryCount = 0;\r\nconst MAX_VISUALIZER_RETRIES = 120;\r\nlet _vizResizeTimer: ReturnType<typeof setTimeout> | null = null;\r\n\r\n//  Helpers \r\n\r\nfunction getAnalyser(): unknown {\r\n  return getState<unknown>('audio.analyser');\r\n}\r\n\r\n//  Start Active Visualizer \r\n\r\nexport function startVisualizer(): void {\r\n  if (_animationId) {\r\n    cancelAnimationFrame(_animationId);\r\n    _animationId = null;\r\n  }\r\n\r\n  const canvas = document.getElementById('visualizerCanvas') as HTMLCanvasElement | null;\r\n  if (!canvas) return;\r\n  const _ctx = canvas.getContext('2d');\r\n  if (!_ctx) return;\r\n  const ctx: CanvasRenderingContext2D = _ctx;\r\n\r\n  const analyser = getAnalyser() as Record<string, unknown> | null;\r\n\r\n  if (!analyser) {\r\n    if (++_visualizerRetryCount > MAX_VISUALIZER_RETRIES) {\r\n      log.warn('[Visualizer] Gave up waiting for analyser after', MAX_VISUALIZER_RETRIES, 'frames');\r\n      _visualizerRetryCount = 0;\r\n      return;\r\n    }\r\n    _animationId = requestAnimationFrame(startVisualizer);\r\n    return;\r\n  }\r\n  _visualizerRetryCount = 0;\r\n\r\n  // Check type: Tone.js analyser has .getValue(), native has .getByteFrequencyData()\r\n  const isToneAnalyser = typeof (analyser as Record<string, unknown>).getValue === 'function';\r\n  const bufferLength = isToneAnalyser\r\n    ? ((analyser as Record<string, number>).size || 1024)\r\n    : (analyser as unknown as AnalyserNode).frequencyBinCount;\r\n\r\n  let smoothedBass = 0;\r\n\r\n  // Canvas scale (High DPI)\r\n  const wrapper = document.querySelector('.vinyl-wrapper');\r\n  const logicalSize = (wrapper && (wrapper as HTMLElement).clientWidth > 10)\r\n    ? (wrapper as HTMLElement).clientWidth : 240;\r\n  const dpr = window.devicePixelRatio || 1;\r\n  if (canvas.width !== logicalSize * dpr || canvas.height !== logicalSize * dpr) {\r\n    canvas.width = logicalSize * dpr;\r\n    canvas.height = logicalSize * dpr;\r\n    canvas.style.width = '';\r\n    canvas.style.height = '';\r\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n    ctx.scale(dpr, dpr);\r\n  }\r\n\r\n  function draw(): void {\r\n    const currentState = getState<string>('appState');\r\n    if (isIdleOrPaused(currentState)) { _animationId = null; return; }\r\n    if (!isToneAnalyser) { _animationId = null; return; }\r\n    _animationId = requestAnimationFrame(draw);\r\n\r\n    const dbData = (analyser as Record<string, (...args: unknown[]) => Float32Array>).getValue() as Float32Array;\r\n\r\n    const theme = document.documentElement.getAttribute('data-theme');\r\n    const isLight = (theme === 'light');\r\n\r\n    ctx.globalCompositeOperation = 'source-over';\r\n    ctx.clearRect(0, 0, logicalSize, logicalSize);\r\n\r\n    // Bass: 0~260Hz (12 bins)\r\n    let bassSum = 0;\r\n    let bassCount = 12;\r\n    if (bassCount > bufferLength) bassCount = bufferLength;\r\n    for (let i = 0; i < bassCount; i++) {\r\n      let val = (dbData[i] + 100) * 2.5;\r\n      if (val < 0) val = 0;\r\n      if (val > 255) val = 255;\r\n      bassSum += val;\r\n    }\r\n    const bassAverage = bassSum / bassCount;\r\n\r\n    smoothedBass = smoothedBass * 0.8 + bassAverage * 0.2;\r\n    const bassPunch = Math.pow(smoothedBass / 255, 2.5);\r\n\r\n    // High: 7.5kHz~20kHz (0.7~1.0 of buffer)\r\n    let highSum = 0;\r\n    const highStart = Math.floor(bufferLength * 0.7);\r\n    const highEnd = bufferLength;\r\n    let highCountVal = highEnd - highStart;\r\n    if (highCountVal < 1) highCountVal = 1;\r\n\r\n    for (let i = highStart; i < highEnd; i++) {\r\n      let val = (dbData[i] + 100) * 2.5;\r\n      if (val < 0) val = 0;\r\n      if (val > 255) val = 255;\r\n      highSum += val;\r\n    }\r\n    const highAverage = highSum / highCountVal;\r\n    const highPunch = highAverage / 255;\r\n\r\n    ctx.globalCompositeOperation = isLight ? 'source-over' : 'lighter';\r\n    ctx.shadowBlur = 0;\r\n\r\n    const centerX = logicalSize / 2;\r\n    const centerY = logicalSize / 2;\r\n    const scale = logicalSize / 240;\r\n\r\n    // Circle 1: Bass\r\n    const bassRadius = (55 + (bassPunch * 200)) * scale;\r\n    const bassLightness = 20 + (bassPunch * 60);\r\n    ctx.fillStyle = isLight\r\n      ? 'rgba(59, 130, 246, 0.6)'\r\n      : `hsla(217, 91%, ${bassLightness + 40}%, 0.4)`;\r\n    ctx.beginPath();\r\n    ctx.arc(centerX, centerY, bassRadius, 0, 2 * Math.PI);\r\n    ctx.fill();\r\n\r\n    // Circle 2: High\r\n    const highRadius = (40 + (highPunch * 130)) * scale;\r\n    const highLightness = 40 + (highPunch * 60);\r\n    ctx.fillStyle = isLight\r\n      ? 'rgba(96, 165, 250, 0.6)'\r\n      : `hsla(217, 100%, ${highLightness + 30}%, 0.4)`;\r\n    ctx.beginPath();\r\n    ctx.arc(centerX, centerY, highRadius, 0, 2 * Math.PI);\r\n    ctx.fill();\r\n  }\r\n\r\n  draw();\r\n}\r\n\r\n//  Idle Visualizer \r\n\r\nexport function drawIdleVisualizer(): void {\r\n  const canvas = document.getElementById('visualizerCanvas') as HTMLCanvasElement | null;\r\n  if (!canvas) return;\r\n  const _ctx2 = canvas.getContext('2d');\r\n  if (!_ctx2) return;\r\n  const ctx: CanvasRenderingContext2D = _ctx2;\r\n\r\n  const wrapper = document.querySelector('.vinyl-wrapper');\r\n  const logicalSize = wrapper ? (wrapper as HTMLElement).clientWidth : 240;\r\n  const dpr = window.devicePixelRatio || 1;\r\n  if (canvas.width !== logicalSize * dpr || canvas.height !== logicalSize * dpr) {\r\n    canvas.width = logicalSize * dpr;\r\n    canvas.height = logicalSize * dpr;\r\n    canvas.style.width = '';\r\n    canvas.style.height = '';\r\n    ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n    ctx.scale(dpr, dpr);\r\n  }\r\n\r\n  const theme = document.documentElement.getAttribute('data-theme');\r\n  const isLight = (theme === 'light');\r\n\r\n  ctx.globalCompositeOperation = 'source-over';\r\n  ctx.clearRect(0, 0, logicalSize, logicalSize);\r\n  ctx.globalCompositeOperation = isLight ? 'source-over' : 'lighter';\r\n  ctx.shadowBlur = 0;\r\n\r\n  const centerX = logicalSize / 2;\r\n  const centerY = logicalSize / 2;\r\n  const scale = logicalSize / 240;\r\n\r\n  // Bass circle (static)\r\n  const bassRadius = 55 * scale;\r\n  ctx.fillStyle = isLight ? 'rgba(59, 130, 246, 0.6)' : 'hsla(217, 91%, 60%, 0.4)';\r\n  ctx.beginPath();\r\n  ctx.arc(centerX, centerY, bassRadius, 0, 2 * Math.PI);\r\n  ctx.fill();\r\n\r\n  // High circle (static)\r\n  const highRadius = 40 * scale;\r\n  ctx.fillStyle = isLight ? 'rgba(96, 165, 250, 0.6)' : 'hsla(217, 100%, 70%, 0.4)';\r\n  ctx.beginPath();\r\n  ctx.arc(centerX, centerY, highRadius, 0, 2 * Math.PI);\r\n  ctx.fill();\r\n}\r\n\r\n//  Init \r\n\r\nexport function initVisualizer(): void {\r\n  drawIdleVisualizer();\r\n\r\n  window.addEventListener('resize', () => {\r\n    if (_vizResizeTimer) clearTimeout(_vizResizeTimer);\r\n    _vizResizeTimer = setTimeout(() => {\r\n      const wrapper = document.querySelector('.vinyl-wrapper');\r\n      if (!wrapper || (wrapper as HTMLElement).clientWidth < 10) return;\r\n      const currentState = getState<string>('appState');\r\n      if (isIdleOrPaused(currentState)) {\r\n        drawIdleVisualizer();\r\n      } else {\r\n        startVisualizer();\r\n      }\r\n    }, 250);\r\n  });\r\n\r\n  // Listen for check events from tab switch\r\n  bus.on('ui:visualizer-check', ((..._args: unknown[]) => {\r\n    const currentState = getState<string>('appState');\r\n    if (isIdleOrPaused(currentState)) drawIdleVisualizer();\r\n    else startVisualizer();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Listen for playback state changes\r\n  bus.on('player:state-changed', ((..._args: unknown[]) => {\r\n    const currentState = getState<string>('appState');\r\n    if (isIdleOrPaused(currentState)) drawIdleVisualizer();\r\n    else startVisualizer();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Listen for visualizer start command from playback\r\n  bus.on('visualizer:start', ((..._args: unknown[]) => {\r\n    startVisualizer();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Visualizer] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Chat System\r\n * Extracted from original app.js lines 10624-10860\r\n *\r\n * Manages: sendChatMessage, addChatMessage, parseMessageContent,\r\n * chat drawer toggle, YouTube oEmbed title in chat.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG } from '../core/constants.ts';\r\nimport { registerHandlers } from '../network/protocol.ts';\r\nimport { escapeHtml, escapeAttr } from './dom.ts';\r\nimport { showToast } from './toast.ts';\r\nimport { fetchOEmbedTitle } from '../youtube/search.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Constants \r\n\r\nconst PEER_NAME_PREFIX = 'Peer';\r\n\r\nconst STANDARD_ROLE_MAP: Record<string, { label: string }> = {\r\n  '0': { label: 'Original' },\r\n  '-1': { label: 'Left' },\r\n  '1': { label: 'Right' },\r\n  '2': { label: 'Woofer' },\r\n};\r\n\r\nfunction getRoleLabelByChannelMode(mode: number): string {\r\n  return (STANDARD_ROLE_MAP[String(mode)] || STANDARD_ROLE_MAP['0']).label;\r\n}\r\n\r\n//  Chat State \r\n\r\nlet _lastChatSender = '';\r\nlet _lastChatText = '';\r\nlet _unreadCount = 0;\r\nlet _isChatDrawerOpen = false;\r\n\r\n//  Helpers \r\n\r\nfunction _getChatLabelBase(): string {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) return 'Host';\r\n\r\n  const myDeviceLabel = getState<string>('network.myDeviceLabel') || '';\r\n  const label = myDeviceLabel.trim();\r\n\r\n  if (!label || label === 'HOST' || label === 'Guest' || label === '') return PEER_NAME_PREFIX;\r\n\r\n  const role0 = getRoleLabelByChannelMode(0);\r\n  const roleL = getRoleLabelByChannelMode(-1);\r\n  const roleR = getRoleLabelByChannelMode(1);\r\n  const roleS = getRoleLabelByChannelMode(2);\r\n  if (label === role0 || label === roleL || label === roleR || label === roleS) return PEER_NAME_PREFIX;\r\n\r\n  return label;\r\n}\r\n\r\nfunction _formatChatDisplayName(label: string): string {\r\n  const l = (label && label.trim()) ? label.trim() : PEER_NAME_PREFIX;\r\n  return l;\r\n}\r\n\r\nfunction parseTimestamp(ts: string): number {\r\n  const parts = ts.split(':').map(Number);\r\n  if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];\r\n  if (parts.length === 2) return parts[0] * 60 + parts[1];\r\n  return 0;\r\n}\r\n\r\n//  Parse Message Content \r\n\r\nfunction parseMessageContent(text: string): string {\r\n  const ytRegex = /(https?:\\/\\/)?(www\\.)?(youtube\\.com\\/watch\\?v=|youtu\\.be\\/|youtube\\.com\\/shorts\\/)[a-zA-Z0-9_-]{11}[^\\s]*/gi;\r\n  const tsRegex = /\\b(\\d{1,2}:\\d{2}(?::\\d{2})?)\\b/g;\r\n\r\n  const combinedRegex = new RegExp(\r\n    `(${ytRegex.source})|(${tsRegex.source})`,\r\n    'gi'\r\n  );\r\n\r\n  let result = '';\r\n  let lastIndex = 0;\r\n  let match: RegExpExecArray | null;\r\n\r\n  while ((match = combinedRegex.exec(text)) !== null) {\r\n    if (match.index > lastIndex) {\r\n      result += escapeHtml(text.slice(lastIndex, match.index));\r\n    }\r\n\r\n    const matchedText = match[0];\r\n\r\n    ytRegex.lastIndex = 0;\r\n    if (ytRegex.test(matchedText)) {\r\n      const cleanUrl = matchedText.startsWith('http') ? matchedText : 'https://' + matchedText;\r\n      const uniqueId = 'yt-' + Math.random().toString(36).substr(2, 9);\r\n\r\n      result += `\r\n        <button type=\"button\" class=\"chat-youtube-btn\" data-youtube-url=\"${escapeAttr(cleanUrl)}\" aria-label=\"YouTube  \" aria-describedby=\"${uniqueId}\">\r\n          <div class=\"chat-yt-play-row\">\r\n            <svg viewBox=\"0 0 24 24\" width=\"16\" height=\"16\" fill=\"currentColor\"><path d=\"M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z\"/></svg>\r\n            YouTube\r\n          </div>\r\n          <div id=\"${uniqueId}\" class=\"chat-yt-title\">${escapeHtml(matchedText)}</div>\r\n        </button>\r\n      `;\r\n\r\n      setTimeout(() => updateYouTubeChatTitle(uniqueId, cleanUrl), 100);\r\n    } else if (/^\\d{1,2}:\\d{2}(:\\d{2})?$/.test(matchedText)) {\r\n      const seconds = parseTimestamp(matchedText);\r\n      result += `<span class=\"chat-timestamp\" role=\"button\" tabindex=\"0\" data-seek=\"${seconds}\">${escapeHtml(matchedText)}</span>`;\r\n    } else {\r\n      result += escapeHtml(matchedText);\r\n    }\r\n\r\n    lastIndex = combinedRegex.lastIndex;\r\n  }\r\n\r\n  if (lastIndex < text.length) {\r\n    result += escapeHtml(text.slice(lastIndex));\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nasync function updateYouTubeChatTitle(elementId: string, url: string): Promise<void> {\r\n  try {\r\n    const title = await fetchOEmbedTitle(url);\r\n    if (title) {\r\n      const el = document.getElementById(elementId);\r\n      if (el) el.textContent = title;\r\n    }\r\n  } catch { /* ignore */ }\r\n}\r\n\r\n//  Chat Preview \r\n\r\nfunction updateChatPreview(sender: string, text: string): void {\r\n  const previewBtn = document.getElementById('chat-preview-btn');\r\n  if (!previewBtn) return;\r\n\r\n  const previewText = previewBtn.querySelector('.chat-preview-text');\r\n  if (previewText) {\r\n    previewText.textContent = `${sender}: ${text}`;\r\n  }\r\n}\r\n\r\nfunction incrementUnread(): void {\r\n  if (_isChatDrawerOpen) return;\r\n  _unreadCount++;\r\n  const badge = document.getElementById('chat-preview-badge');\r\n  if (badge) {\r\n    badge.textContent = _unreadCount > 9 ? '9+' : String(_unreadCount);\r\n    badge.classList.add('show');\r\n  }\r\n}\r\n\r\nfunction resetUnread(): void {\r\n  _unreadCount = 0;\r\n  const badge = document.getElementById('chat-preview-badge');\r\n  if (badge) {\r\n    badge.textContent = '0';\r\n    badge.classList.remove('show');\r\n  }\r\n}\r\n\r\n//  Chat Drawer \r\n\r\nexport function toggleChatDrawer(): void {\r\n  const drawer = document.getElementById('chat-drawer');\r\n  if (!drawer) return;\r\n\r\n  _isChatDrawerOpen = !_isChatDrawerOpen;\r\n  drawer.classList.toggle('open', _isChatDrawerOpen);\r\n\r\n  if (_isChatDrawerOpen) {\r\n    resetUnread();\r\n    const messages = document.getElementById('chat-messages');\r\n    if (messages) messages.scrollTop = messages.scrollHeight;\r\n    const input = document.getElementById('chat-input') as HTMLInputElement | null;\r\n    if (input) setTimeout(() => input.focus(), 300);\r\n  }\r\n}\r\n\r\n//  Send & Receive \r\n\r\nexport function sendChatMessage(): void {\r\n  const input = document.getElementById('chat-input') as HTMLInputElement | null;\r\n  if (!input) return;\r\n  const text = input.value.trim();\r\n  if (!text) return;\r\n\r\n  const senderLabel = _getChatLabelBase();\r\n  const channelMode = getState<number>('audio.channelMode') ?? 0;\r\n  const senderRole = getRoleLabelByChannelMode(channelMode);\r\n  const displayName = _formatChatDisplayName(senderLabel);\r\n\r\n  addChatMessage(displayName, text, true);\r\n\r\n  const myId = getState<string>('network.myId') || '';\r\n  const chatMsg = {\r\n    type: MSG.CHAT,\r\n    senderId: myId,\r\n    sender: senderLabel,\r\n    senderLabel: senderLabel,\r\n    senderRole: senderRole,\r\n    text: text,\r\n    ts: Date.now(),\r\n  };\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    bus.emit('network:broadcast', chatMsg);\r\n  } else {\r\n    if (hostConn.open) hostConn.send(chatMsg);\r\n  }\r\n\r\n  input.value = '';\r\n}\r\n\r\nexport function addChatMessage(sender: string, text: string, isMine: boolean): void {\r\n  const container = document.getElementById('chat-messages');\r\n\r\n  if (container) {\r\n    const empty = container.querySelector('.chat-empty');\r\n    if (empty) empty.remove();\r\n\r\n    const now = new Date();\r\n    const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;\r\n\r\n    const group = document.createElement('div');\r\n    group.className = `chat-group ${isMine ? 'mine' : 'others'}`;\r\n\r\n    if (!isMine) {\r\n      const senderNode = document.createElement('div');\r\n      senderNode.className = 'chat-sender';\r\n      senderNode.innerText = sender;\r\n      group.appendChild(senderNode);\r\n    }\r\n\r\n    const row = document.createElement('div');\r\n    row.className = 'chat-row';\r\n\r\n    const bubble = document.createElement('div');\r\n    bubble.className = `chat-bubble ${isMine ? 'mine' : 'others'}`;\r\n    const chatTextDiv = document.createElement('div');\r\n    chatTextDiv.className = 'chat-text';\r\n    chatTextDiv.innerHTML = parseMessageContent(text);\r\n    bubble.appendChild(chatTextDiv);\r\n\r\n    try {\r\n      if (bubble.querySelector('.chat-youtube-btn')) bubble.classList.add('has-youtube');\r\n    } catch { /* ignore */ }\r\n\r\n    const timeNode = document.createElement('div');\r\n    timeNode.className = 'chat-time';\r\n    timeNode.innerText = timeStr;\r\n\r\n    if (isMine) {\r\n      row.appendChild(timeNode);\r\n      row.appendChild(bubble);\r\n    } else {\r\n      row.appendChild(bubble);\r\n      row.appendChild(timeNode);\r\n    }\r\n\r\n    group.appendChild(row);\r\n    container.appendChild(group);\r\n    container.scrollTop = container.scrollHeight;\r\n  }\r\n\r\n  _lastChatSender = sender;\r\n  _lastChatText = text;\r\n  updateChatPreview(sender, text);\r\n\r\n  if (!isMine) {\r\n    incrementUnread();\r\n  }\r\n}\r\n\r\n//  Handler for Incoming Chat \r\n\r\nfunction handleChatMessage(data: Record<string, unknown>, conn: DataConnection): void {\r\n  const myId = getState<string>('network.myId') || '';\r\n  const senderId = data.senderId as string || '';\r\n  const isMine = senderId === myId;\r\n\r\n  const senderLabel = (data.senderLabel as string) || (data.sender as string) || PEER_NAME_PREFIX;\r\n  const displayName = _formatChatDisplayName(senderLabel);\r\n  const text = (data.text as string) || '';\r\n\r\n  addChatMessage(displayName, text, isMine);\r\n\r\n  // Relay to downstream peers (Host only), excluding the sender to avoid duplicates\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    const senderPeerId = conn?.peer || (senderId as string) || '';\r\n    bus.emit('network:broadcast-except', senderPeerId, data);\r\n  }\r\n}\r\n\r\n//  Event Delegation \r\n\r\nfunction initChatEventDelegation(): void {\r\n  // Timestamp seeking\r\n  document.addEventListener('click', (e) => {\r\n    const target = (e.target as HTMLElement)?.closest?.('.chat-timestamp[data-seek]');\r\n    if (!target) return;\r\n    const sec = Number(target.getAttribute('data-seek'));\r\n    if (Number.isFinite(sec)) bus.emit('player:seek-to-time', sec);\r\n  });\r\n\r\n  document.addEventListener('keydown', (e) => {\r\n    const target = (e.target as HTMLElement)?.closest?.('.chat-timestamp[data-seek]');\r\n    if (!target) return;\r\n    if (e.key !== 'Enter' && e.key !== ' ') return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    const sec = Number(target.getAttribute('data-seek'));\r\n    if (Number.isFinite(sec)) bus.emit('player:seek-to-time', sec);\r\n  });\r\n\r\n  // YouTube button in chat\r\n  document.addEventListener('click', (e) => {\r\n    const btn = (e.target as HTMLElement)?.closest?.('.chat-youtube-btn[data-youtube-url]');\r\n    if (!btn) return;\r\n    const url = btn.getAttribute('data-youtube-url');\r\n    if (url) bus.emit('youtube:load-from-chat', url);\r\n  });\r\n}\r\n\r\n//  Emoji Insertion \r\n\r\nfunction insertEmoji(emoji: string): void {\r\n  const input = document.getElementById('chat-input') as HTMLInputElement | null;\r\n  if (input) {\r\n    input.value += emoji;\r\n    input.focus();\r\n  }\r\n}\r\n\r\n// Expose globally for emoji picker buttons in HTML\r\n(window as unknown as Record<string, unknown>).insertEmoji = insertEmoji;\r\n\r\n//  Init \r\n\r\nexport function initChat(): void {\r\n  registerHandlers({\r\n    [MSG.CHAT]: handleChatMessage,\r\n  });\r\n\r\n  initChatEventDelegation();\r\n\r\n  // Wire up UI buttons\r\n  const sendBtn = document.getElementById('btn-chat-send');\r\n  if (sendBtn) sendBtn.addEventListener('click', sendChatMessage);\r\n\r\n  const closeBtn = document.getElementById('btn-chat-close');\r\n  if (closeBtn) closeBtn.addEventListener('click', toggleChatDrawer);\r\n\r\n  const previewBtn = document.getElementById('chat-preview-btn');\r\n  if (previewBtn) previewBtn.addEventListener('click', toggleChatDrawer);\r\n\r\n  // Chat input: send on Enter\r\n  const chatInput = document.getElementById('chat-input') as HTMLInputElement | null;\r\n  if (chatInput) {\r\n    chatInput.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter' && !e.shiftKey) {\r\n        e.preventDefault();\r\n        sendChatMessage();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Bus event for toggling drawer from other modules\r\n  bus.on('ui:toggle-chat-drawer', ((..._args: unknown[]) => {\r\n    toggleChatDrawer();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Close chat drawer (used by YouTube load-from-chat)\r\n  bus.on('ui:close-chat-drawer', ((..._args: unknown[]) => {\r\n    if (_isChatDrawerOpen) toggleChatDrawer();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[Chat] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Playlist View (UI)\r\n * Extracted from original app.js lines 3569-3707\r\n *\r\n * Manages: Playlist DOM rendering, track highlighting,\r\n * sub-playlist expansion, title/artist update.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { MSG } from '../core/constants.ts';\r\nimport { escapeHtml } from './dom.ts';\r\nimport { updateTitleWithMarquee } from './dom.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n//  Expansion Toggle \r\n\r\nfunction toggleExpansion(idx: number): void {\r\n  const playlist = getState<PlaylistItem[]>('playlist.items');\r\n  if (!playlist[idx]) return;\r\n  playlist[idx].isExpanded = !playlist[idx].isExpanded;\r\n\r\n  // When expanding a YouTube playlist, trigger sub-item population\r\n  if (playlist[idx].isExpanded && playlist[idx].playlistId) {\r\n    bus.emit('youtube:populate-sub-items', playlist[idx].playlistId, idx);\r\n  }\r\n\r\n  updatePlaylistUI();\r\n}\r\n\r\n//  Playlist UI Render \r\n\r\nexport function updatePlaylistUI(): void {\r\n  const ul = document.getElementById('playlist-ui');\r\n  if (!ul) return;\r\n\r\n  const playlist = getState<PlaylistItem[]>('playlist.items');\r\n\r\n  if (!Array.isArray(playlist)) {\r\n    log.warn('[Playlist] playlist is not an array. Resetting.');\r\n    setState('playlist.items', []);\r\n    return;\r\n  }\r\n\r\n  ul.innerHTML = '';\r\n  if (playlist.length === 0) {\r\n    ul.innerHTML = '<li class=\"list-empty-state\"> .</li>';\r\n    return;\r\n  }\r\n\r\n  const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n  const currentYouTubeSubIndex = getState<number>('youtube.currentSubIndex') ?? -1;\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const isOperator = getState<boolean>('network.isOperator');\r\n  const subItemsMap = getState<Record<string, { ids?: string[]; titles?: string[] }>>('youtube.subItemsMap') || {};\r\n\r\n  playlist.forEach((item, idx) => {\r\n    const isCurrent = (idx === currentTrackIndex);\r\n    const li = document.createElement('li');\r\n    li.className = `track-item ${isCurrent ? 'active' : ''} ${item.playlistId ? 'is-playlist' : ''}`;\r\n\r\n    let expandBtn = '';\r\n    if (item.playlistId) {\r\n      expandBtn = `\r\n        <button type=\"button\" class=\"expand-toggle ${item.isExpanded ? 'active' : ''}\" data-expand-idx=\"${idx}\" aria-label=\" /\">\r\n          <svg viewBox=\"0 0 24 24\" aria-hidden=\"true\"><path d=\"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z\"/></svg>\r\n        </button>\r\n      `;\r\n    }\r\n\r\n    const icon = item.type === 'youtube'\r\n      ? '<svg class=\"type-icon\" viewBox=\"0 0 24 24\" style=\"fill:#ff0000;\"><path d=\"M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47-.13-1.33-.22-2.65-.28-1.3-.07-2.49-.1-3.59-.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z\"/></svg>'\r\n      : '<svg class=\"type-icon\" viewBox=\"0 0 24 24\"><path d=\"M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z\"/></svg>';\r\n\r\n    const displayName = item.name || item.title || 'Unknown';\r\n    li.onclick = () => {\r\n      if (!hostConn) bus.emit('playlist:play-track', idx);\r\n      else if (isOperator) hostConn.send({ type: MSG.REQUEST_TRACK_CHANGE, index: idx });\r\n    };\r\n\r\n    li.innerHTML = `\r\n      <div class=\"track-idx\">${idx + 1}</div>\r\n      <div class=\"track-name\">${icon} ${escapeHtml(displayName)}</div>\r\n      ${expandBtn}\r\n      <div class=\"playing-indicator\">\r\n        <div class=\"bar\"></div>\r\n        <div class=\"bar\"></div>\r\n        <div class=\"bar\"></div>\r\n      </div>\r\n    `;\r\n    ul.appendChild(li);\r\n\r\n    // Bind expand toggle\r\n    const exp = li.querySelector('.expand-toggle[data-expand-idx]');\r\n    if (exp) {\r\n      exp.addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        toggleExpansion(idx);\r\n      });\r\n    }\r\n\r\n    // Sub-items\r\n    if (item.playlistId && item.isExpanded) {\r\n      const subUl = document.createElement('ul');\r\n      subUl.className = 'sub-playlist';\r\n\r\n      const subData = subItemsMap[item.playlistId];\r\n      if (subData && subData.ids) {\r\n        subData.ids.forEach((sid, sIdx) => {\r\n          const sli = document.createElement('li');\r\n          const isActiveSub = (isCurrent && sIdx === currentYouTubeSubIndex);\r\n          sli.className = `sub-track-item ${isActiveSub ? 'active' : ''}`;\r\n\r\n          const sTitle = (subData.titles && subData.titles[sIdx]) ? subData.titles[sIdx] : `Video ${sIdx + 1}`;\r\n          sli.innerHTML = `\r\n            <span class=\"sub-idx\">${sIdx + 1}</span>\r\n            <span class=\"sub-name\">${escapeHtml(sTitle)}</span>\r\n            <div class=\"playing-indicator\">\r\n              <div class=\"bar\"></div>\r\n              <div class=\"bar\"></div>\r\n              <div class=\"bar\"></div>\r\n            </div>\r\n          `;\r\n\r\n          sli.onclick = (e) => {\r\n            e.stopPropagation();\r\n            if (hostConn && !isOperator) return;\r\n            if (!hostConn) {\r\n              bus.emit('youtube:sub-seek', idx, sIdx, isCurrent);\r\n            } else {\r\n              hostConn.send({ type: MSG.REQUEST_YOUTUBE_SUB_SEEK, playlistIdx: idx, subIdx: sIdx });\r\n            }\r\n          };\r\n          subUl.appendChild(sli);\r\n        });\r\n      } else {\r\n        subUl.innerHTML = '<li class=\"sub-track-item loading\">   ...</li>';\r\n      }\r\n      ul.appendChild(subUl);\r\n    }\r\n  });\r\n\r\n  // Update title/artist display\r\n  const meta = getState<Record<string, unknown>>('transfer.meta');\r\n  if (currentTrackIndex !== -1) {\r\n    const currentItem = playlist[currentTrackIndex];\r\n    let displayTitle = 'Unknown';\r\n    if (meta && meta.index === currentTrackIndex && meta.name) {\r\n      displayTitle = meta.name as string;\r\n    } else if (currentItem) {\r\n      displayTitle = currentItem.name || currentItem.title || 'Unknown';\r\n    }\r\n\r\n    updateTitleWithMarquee(displayTitle);\r\n\r\n    const artistEl = document.getElementById('track-artist');\r\n    if (artistEl) {\r\n      if (currentItem && (currentItem as unknown as Record<string, unknown>).artist) {\r\n        artistEl.innerText = (currentItem as unknown as Record<string, unknown>).artist as string;\r\n      } else {\r\n        artistEl.innerText = (currentItem && currentItem.type === 'youtube') ? 'YouTube Video' : `Track ${currentTrackIndex + 1}`;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n//  Init \r\n\r\nexport function initPlaylistView(): void {\r\n  // Listen for playlist UI update events\r\n  bus.on('ui:update-playlist', ((..._args: unknown[]) => {\r\n    updatePlaylistUI();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[PlaylistView] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Player Controls (UI)\r\n * Extracted from original app.js lines 3090-3375, 5642-5710\r\n *\r\n * Manages: Play/pause/prev/next buttons, volume slider, seek bar,\r\n * mute toggle, role badge, media source popup, YouTube popup.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { APP_STATE, MSG } from '../core/constants.ts';\r\nimport { IS_ANDROID } from '../core/platform.ts';\r\nimport { showToast } from './toast.ts';\r\nimport { showLoader, updateLoader } from './toast.ts';\r\nimport { switchTab } from './tabs.ts';\r\nimport { updateOverlayOpenClass, animateTransition, copyTextToClipboard, updateTitleWithMarquee } from './dom.ts';\r\nimport { showDialog } from './dialog.ts';\r\nimport { fmtTime, getTrackPosition, togglePlay, play, skipTime } from '../player/playback.ts';\r\nimport { playNextTrack, playPrevTrack, toggleRepeat, toggleShuffle } from '../player/playlist.ts';\r\nimport { isIdleOrPaused } from '../player/video.ts';\r\nimport { broadcast } from '../network/peer.ts';\r\nimport { requestGlobalResyncDelayed } from '../network/sync.ts';\r\nimport type { DataConnection, PlaylistItem } from '../types/index.ts';\r\n\r\n//  Constants \r\n\r\nconst STANDARD_ROLE_MAP: Record<string, { label: string; placementToast: string }> = {\r\n  '0': { label: 'Original', placementToast: '  ' },\r\n  '-1': { label: 'Left', placementToast: '  ' },\r\n  '1': { label: 'Right', placementToast: '  ' },\r\n  '2': { label: 'Woofer', placementToast: '  ' },\r\n};\r\n\r\nexport function getRoleLabelByChannelMode(mode: number): string {\r\n  return (STANDARD_ROLE_MAP[String(mode)] || STANDARD_ROLE_MAP['0']).label;\r\n}\r\n\r\nexport function getStandardRolePreset(mode: number): { label: string; placementToast: string } {\r\n  return STANDARD_ROLE_MAP[String(mode)] || STANDARD_ROLE_MAP['0'];\r\n}\r\n\r\nexport function showPlacementToastForChannel(mode: number): void {\r\n  showToast(getStandardRolePreset(mode).placementToast);\r\n}\r\n\r\n//  Volume \r\n\r\nlet _preMuteVolume = 0.5;\r\n\r\nfunction updateVolumeIcon(): void {\r\n  const icon = document.getElementById('vol-icon-btn');\r\n  if (!icon) return;\r\n  const path = icon.querySelector('path');\r\n  if (!path) return;\r\n\r\n  const vol = getState<number>('audio.masterVolume') ?? 1;\r\n  if (vol === 0) {\r\n    path.setAttribute('d', 'M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z');\r\n  } else {\r\n    path.setAttribute('d', 'M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z');\r\n  }\r\n}\r\n\r\nfunction onVolInput(val: number): void {\r\n  bus.emit('audio:set-volume', val / 100);\r\n}\r\n\r\nfunction onVolChange(val: number): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    bus.emit('network:broadcast', { type: MSG.VOLUME, value: val / 100 });\r\n    showToast(`Volume: ${Math.round(val)}%`);\r\n  }\r\n}\r\n\r\nfunction toggleMute(): void {\r\n  const masterVolume = getState<number>('audio.masterVolume') ?? 1;\r\n  if (masterVolume > 0) {\r\n    _preMuteVolume = masterVolume;\r\n    bus.emit('audio:set-volume', 0);\r\n    showToast('Muted');\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) bus.emit('network:broadcast', { type: MSG.VOLUME, value: 0 });\r\n  } else {\r\n    bus.emit('audio:set-volume', _preMuteVolume || 0.5);\r\n    const newVol = _preMuteVolume || 0.5;\r\n    showToast(`Volume: ${Math.round(newVol * 100)}%`);\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) bus.emit('network:broadcast', { type: MSG.VOLUME, value: newVol });\r\n  }\r\n}\r\n\r\n//  Role Badge \r\n\r\nexport function updateRoleBadge(): void {\r\n  const badge = document.getElementById('role-badge');\r\n  const text = document.getElementById('role-text');\r\n  if (!badge || !text) return;\r\n\r\n  badge.classList.remove('connected');\r\n\r\n  const isConnecting = getState<boolean>('network.isConnecting');\r\n  if (isConnecting) {\r\n    text.innerText = ' ...';\r\n    return;\r\n  }\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    const lastLatencyMs = getState<number>('sync.lastLatencyMs');\r\n    const latencyTxt = (lastLatencyMs && Number.isFinite(lastLatencyMs)) ? ` (${Math.round(lastLatencyMs)}ms)` : '';\r\n    const myDeviceLabel = getState<string>('network.myDeviceLabel') || '';\r\n    const label = myDeviceLabel.trim() || 'Peer';\r\n    text.innerText = `${label}${latencyTxt}`;\r\n    badge.classList.add('connected');\r\n    return;\r\n  }\r\n\r\n  const appRole = getState<string>('network.appRole');\r\n  if (appRole === 'host') {\r\n    text.innerText = 'Host';\r\n    badge.classList.add('connected');\r\n    return;\r\n  }\r\n\r\n  if (appRole === 'guest') {\r\n    text.innerText = 'Guest';\r\n    return;\r\n  }\r\n\r\n  text.innerText = 'SETUP';\r\n}\r\n\r\n//  Invite Code \r\n\r\nexport function getInviteCode(): string {\r\n  const sessionCode = getState<string>('network.sessionCode') || '';\r\n  const lastJoinCode = getState<string>('network.lastJoinCode') || '';\r\n  if (sessionCode && /^\\d{6}$/.test(sessionCode)) return sessionCode;\r\n  if (lastJoinCode && /^\\d{6}$/.test(lastJoinCode)) return lastJoinCode;\r\n  return '------';\r\n}\r\n\r\nexport function updateInviteCodeUI(): void {\r\n  const code = getInviteCode();\r\n  const elements = document.querySelectorAll('.invite-code-value');\r\n  elements.forEach(el => {\r\n    el.textContent = code;\r\n    el.setAttribute('data-code', code);\r\n  });\r\n}\r\n\r\nfunction getConnectedDeviceCount(): number {\r\n  const lastKnownDeviceList = getState<Array<Record<string, unknown>>>('network.lastKnownDeviceList');\r\n  if (Array.isArray(lastKnownDeviceList) && lastKnownDeviceList.length) {\r\n    return lastKnownDeviceList.filter(d => d && d.status === 'connected').length;\r\n  }\r\n  const connectedPeers = getState<Array<Record<string, unknown>>>('network.connectedPeers');\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  const appRole = getState<string>('network.appRole');\r\n  const sessionStarted = getState<boolean>('setup.sessionStarted');\r\n  const peerConnected = connectedPeers.filter(p => p && p.status === 'connected').length;\r\n  if (!hostConn && (appRole === 'host' || sessionStarted || peerConnected > 0)) {\r\n    return 1 + peerConnected;\r\n  }\r\n  if (hostConn && hostConn.open) return 2;\r\n  return 1;\r\n}\r\n\r\nasync function copyInviteCode(): Promise<void> {\r\n  const code = getInviteCode();\r\n  if (code === '------') return;\r\n\r\n  const ok = await copyTextToClipboard(code);\r\n  if (ok) {\r\n    const cnt = getConnectedDeviceCount();\r\n    showToast(`  ${cnt} |   ${code}`);\r\n    document.querySelectorAll('.invite-code-value').forEach(el => {\r\n      el.classList.add('copied');\r\n      setTimeout(() => el.classList.remove('copied'), 1000);\r\n    });\r\n  } else {\r\n    showToast(' ');\r\n  }\r\n}\r\n\r\n//  Media Source Popup \r\n\r\nfunction openMediaSourcePopup(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    showToast('    .');\r\n    return;\r\n  }\r\n  animateTransition(() => {\r\n    const overlay = document.getElementById('media-source-overlay');\r\n    if (overlay) {\r\n      overlay.classList.add('active');\r\n      updateOverlayOpenClass();\r\n    }\r\n  });\r\n}\r\n\r\nfunction closeMediaSourcePopup(): void {\r\n  animateTransition(() => {\r\n    const overlay = document.getElementById('media-source-overlay');\r\n    if (overlay) {\r\n      overlay.classList.remove('active');\r\n      updateOverlayOpenClass();\r\n    }\r\n  });\r\n}\r\n\r\nfunction openYouTubePopup(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    showToast('     .');\r\n    return;\r\n  }\r\n  animateTransition(() => {\r\n    const overlay = document.getElementById('youtube-url-overlay');\r\n    if (overlay) {\r\n      overlay.classList.add('active');\r\n      updateOverlayOpenClass();\r\n    }\r\n    const input = document.getElementById('youtube-url-input') as HTMLInputElement | null;\r\n    if (input) setTimeout(() => input.focus(), 100);\r\n  });\r\n}\r\n\r\nfunction closeYouTubePopup(): void {\r\n  animateTransition(() => {\r\n    const overlay = document.getElementById('youtube-url-overlay');\r\n    if (overlay) {\r\n      overlay.classList.remove('active');\r\n      updateOverlayOpenClass();\r\n    }\r\n  });\r\n}\r\n\r\n//  File Selector \r\n\r\nfunction openFileSelector(): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    showToast('Host   .');\r\n    return;\r\n  }\r\n  const input = document.getElementById('file-input') as HTMLInputElement | null;\r\n  if (!input) {\r\n    log.warn('[UI] #file-input not found');\r\n    showToast('   ');\r\n    return;\r\n  }\r\n  input.click();\r\n}\r\n\r\n//  Sync Button \r\n\r\nfunction handleMainSyncBtn(): void {\r\n  const currentState = getState<string>('appState');\r\n  if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n    showToast('YouTube     ');\r\n    return;\r\n  }\r\n\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (!hostConn) {\r\n    showToast('   ...');\r\n    bus.emit('network:broadcast', { type: MSG.GLOBAL_RESYNC_REQUEST });\r\n  } else {\r\n    bus.emit('sync:auto-sync');\r\n  }\r\n}\r\n\r\n//  Logo Return to Main \r\n\r\nlet _logoNavBusy = false;\r\n\r\nasync function handleLogoReturnToMain(): Promise<void> {\r\n  if (_logoNavBusy) return;\r\n  _logoNavBusy = true;\r\n\r\n  try {\r\n    const setupOverlay = document.getElementById('setup-overlay');\r\n    const isOnMain = !!(setupOverlay && setupOverlay.classList.contains('active'));\r\n    if (isOnMain) {\r\n      switchTab('play');\r\n      return;\r\n    }\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const appRole = getState<string>('network.appRole');\r\n    const hasSession = !!(hostConn || appRole === 'host');\r\n    if (hasSession) {\r\n      const res = await showDialog({\r\n        title: ' ',\r\n        message: '  ?\\n   .',\r\n        buttonText: '',\r\n        secondaryText: '',\r\n        defaultFocus: 'secondary',\r\n      });\r\n      if (res.action !== 'ok') return;\r\n    }\r\n\r\n    bus.emit('app:return-to-main');\r\n  } finally {\r\n    _logoNavBusy = false;\r\n  }\r\n}\r\n\r\n//  Android Range Scroll Fix \r\n\r\nfunction installAndroidRangeScrollFix(): void {\r\n  if (!IS_ANDROID) return;\r\n  try {\r\n    const ranges = Array.from(document.querySelectorAll('input[type=\"range\"]'));\r\n    ranges.forEach((range) => {\r\n      const scrollParent = range.closest('.tab-content') as HTMLElement | null;\r\n      if (!scrollParent) return;\r\n\r\n      let prevOverflowY: string | null = null;\r\n      const lock = () => {\r\n        if (prevOverflowY === null) prevOverflowY = scrollParent.style.overflowY;\r\n        scrollParent.style.overflowY = 'hidden';\r\n      };\r\n      const unlock = () => {\r\n        scrollParent.style.overflowY = (prevOverflowY !== null) ? prevOverflowY : '';\r\n        prevOverflowY = null;\r\n      };\r\n\r\n      range.addEventListener('touchstart', lock, { passive: true });\r\n      range.addEventListener('touchend', unlock, { passive: true });\r\n      range.addEventListener('touchcancel', unlock, { passive: true });\r\n    });\r\n  } catch (e) {\r\n    log.debug('[Android] Range scroll fix init failed:', e);\r\n  }\r\n}\r\n\r\n//  Seek Bar \r\n\r\nfunction initSeekBar(): void {\r\n  const slider = document.getElementById('seek-slider') as HTMLInputElement | null;\r\n  if (!slider) {\r\n    log.warn('[UI] #seek-slider not found');\r\n    return;\r\n  }\r\n\r\n  slider.addEventListener('mousedown', () => setState('player.isSeeking', true));\r\n  slider.addEventListener('touchstart', () => setState('player.isSeeking', true));\r\n  slider.addEventListener('input', () => {\r\n    const tc = document.getElementById('time-curr');\r\n    if (tc) tc.innerText = fmtTime(parseFloat(slider.value));\r\n  });\r\n\r\n  slider.addEventListener('change', () => {\r\n    setState('player.isSeeking', false);\r\n    const t = parseFloat(slider.value);\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n\r\n    // Guest (non-OP): blocked\r\n    if (hostConn && !isOperator) return;\r\n\r\n    // OP: request Host to seek\r\n    if (hostConn && isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SEEK, time: t });\r\n      return;\r\n    }\r\n\r\n    // YouTube mode: seek via YouTube API\r\n    const currentState = getState<string>('appState');\r\n    if (currentState === APP_STATE.PLAYING_YOUTUBE) {\r\n      bus.emit('youtube:seek-to', t);\r\n      return;\r\n    }\r\n\r\n    // Host: execute directly (playing or paused)\r\n    if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n      bus.emit('player:seek', t);\r\n    } else {\r\n      // Paused state: just update position\r\n      bus.emit('player:seek-to-time', t);\r\n    }\r\n  });\r\n\r\n  slider.addEventListener('mouseup', () => setState('player.isSeeking', false));\r\n  slider.addEventListener('touchend', () => setState('player.isSeeking', false));\r\n}\r\n\r\n//  Volume Sync \r\n\r\nfunction syncVolumeSlider(): void {\r\n  const vol = getState<number>('audio.masterVolume') ?? 1;\r\n  const vSlider = document.getElementById('volume-slider') as HTMLInputElement | null;\r\n  if (vSlider) vSlider.value = String(vol * 100);\r\n  updateVolumeIcon();\r\n}\r\n\r\n//  Init \r\n\r\nexport function initPlayerControls(): void {\r\n  const $on = (id: string, evt: string, fn: EventListener) => {\r\n    const el = document.getElementById(id);\r\n    if (el) el.addEventListener(evt, fn);\r\n  };\r\n\r\n  // Header\r\n  $on('btn-help', 'click', () => switchTab('guide'));\r\n  $on('btn-fullscreen', 'click', () => {\r\n    try {\r\n      const doc = document as Document & { webkitFullscreenElement?: Element; webkitExitFullscreen?: () => void };\r\n      const el = document.documentElement as HTMLElement & { webkitRequestFullscreen?: () => void };\r\n      const videoWrapper = document.querySelector('.video-wrapper') as HTMLElement & { webkitRequestFullscreen?: () => void } | null;\r\n      const target = videoWrapper || el;\r\n\r\n      const isFullscreen = !!(document.fullscreenElement || doc.webkitFullscreenElement);\r\n      if (!isFullscreen) {\r\n        if (target.requestFullscreen) target.requestFullscreen();\r\n        else if (target.webkitRequestFullscreen) target.webkitRequestFullscreen();\r\n      } else {\r\n        if (document.exitFullscreen) document.exitFullscreen();\r\n        else if (doc.webkitExitFullscreen) doc.webkitExitFullscreen();\r\n      }\r\n    } catch { /* ignore */ }\r\n  });\r\n\r\n  // Role badge\r\n  const roleBadge = document.getElementById('role-badge');\r\n  if (roleBadge) {\r\n    roleBadge.setAttribute('role', 'button');\r\n    roleBadge.setAttribute('tabindex', '0');\r\n    const onShowCode = async (e?: Event) => {\r\n      try { e?.preventDefault?.(); e?.stopPropagation?.(); } catch { /* ignore */ }\r\n      const code = getInviteCode();\r\n      if (!code || code === '------') {\r\n        showToast('   ');\r\n        return;\r\n      }\r\n      const ok = await copyTextToClipboard(code);\r\n      if (ok) {\r\n        const cnt = getConnectedDeviceCount();\r\n        showToast(`  ${cnt} |   ${code}`);\r\n      } else {\r\n        showToast(` : ${code}`);\r\n      }\r\n    };\r\n    roleBadge.addEventListener('click', onShowCode);\r\n    roleBadge.addEventListener('keydown', (e) => {\r\n      if ((e as KeyboardEvent).key !== 'Enter' && (e as KeyboardEvent).key !== ' ') return;\r\n      onShowCode(e);\r\n    });\r\n  }\r\n\r\n  // Logo\r\n  const logo = document.getElementById('app-logo') || document.querySelector('.app-logo');\r\n  if (logo) {\r\n    logo.addEventListener('click', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      handleLogoReturnToMain();\r\n    });\r\n    logo.addEventListener('keydown', (e) => {\r\n      if ((e as KeyboardEvent).key !== 'Enter' && (e as KeyboardEvent).key !== ' ') return;\r\n      e.preventDefault();\r\n      handleLogoReturnToMain();\r\n    });\r\n  }\r\n\r\n  // Player buttons\r\n  $on('btn-prev', 'click', () => bus.emit('playlist:prev-track'));\r\n  $on('play-btn', 'click', () => bus.emit('player:toggle-play'));\r\n  $on('btn-next', 'click', () => bus.emit('playlist:next-track'));\r\n  $on('vol-icon-btn', 'click', () => toggleMute());\r\n  $on('volume-slider', 'input', function (this: HTMLInputElement) { onVolInput(Number(this.value)); });\r\n  $on('volume-slider', 'change', function (this: HTMLInputElement) { onVolChange(Number(this.value)); });\r\n  $on('btn-sync', 'click', () => handleMainSyncBtn());\r\n  $on('btn-media-source', 'click', () => openMediaSourcePopup());\r\n\r\n  // Playlist tab\r\n  $on('btn-repeat', 'click', () => bus.emit('playlist:toggle-repeat'));\r\n  $on('btn-shuffle', 'click', () => bus.emit('playlist:toggle-shuffle'));\r\n  $on('btn-add-media', 'click', () => openMediaSourcePopup());\r\n\r\n  // Media source popup\r\n  $on('btn-local-file', 'click', () => openFileSelector());\r\n  $on('btn-youtube-source', 'click', () => { closeMediaSourcePopup(); openYouTubePopup(); });\r\n  $on('btn-demo-media', 'click', () => { closeMediaSourcePopup(); bus.emit('app:load-demo'); });\r\n  $on('btn-close-media-popup', 'click', () => closeMediaSourcePopup());\r\n\r\n  // YouTube popup\r\n  $on('youtube-url-input', 'input', function (this: HTMLInputElement) { bus.emit('youtube:preview', this.value); });\r\n  $on('btn-yt-cancel', 'click', () => closeYouTubePopup());\r\n  $on('youtube-play-btn', 'click', () => bus.emit('youtube:load-from-input'));\r\n\r\n  // Guide tab\r\n  $on('btn-demo-guide', 'click', () => { switchTab('play'); bus.emit('app:load-demo'); });\r\n\r\n  // Seek bar\r\n  initSeekBar();\r\n\r\n  // Android fix\r\n  installAndroidRangeScrollFix();\r\n\r\n  // Volume sync\r\n  bus.on('audio:volume-changed', ((..._args: unknown[]) => {\r\n    syncVolumeSlider();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Role badge update events\r\n  bus.on('network:role-badge-update', ((..._args: unknown[]) => {\r\n    updateRoleBadge();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Latency update  refresh role badge to show latency value\r\n  bus.on('sync:latency-update', ((..._args: unknown[]) => {\r\n    updateRoleBadge();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Peer disconnected: update UI\r\n  bus.on('network:peer-disconnected', ((...args: unknown[]) => {\r\n    const peerId = args[0] as string;\r\n    log.info(`[UI] Peer disconnected: ${peerId}`);\r\n    updateRoleBadge();\r\n    updateInviteCodeUI();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Invite code container click delegation\r\n  document.addEventListener('click', (e) => {\r\n    const target = (e.target as HTMLElement)?.closest?.('.invite-code-container');\r\n    if (target) {\r\n      e.preventDefault();\r\n      copyInviteCode();\r\n    }\r\n  });\r\n\r\n  // Invite code update events\r\n  bus.on('ui:settings-tab-opened', ((..._args: unknown[]) => {\r\n    updateInviteCodeUI();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // File input handler\r\n  const fileInput = document.getElementById('file-input') as HTMLInputElement | null;\r\n  if (fileInput) {\r\n    fileInput.addEventListener('change', (e) => {\r\n      closeMediaSourcePopup();\r\n      bus.emit('app:files-selected', (e.target as HTMLInputElement).files);\r\n      (e.target as HTMLInputElement).value = '';\r\n    });\r\n  }\r\n\r\n  // OPFS error handler (prevent silent error swallowing)\r\n  bus.on('opfs:error', ((...args: unknown[]) => {\r\n    const filename = args[0] as string;\r\n    const error = args[1] as string;\r\n    log.error(`[OPFS] Error for ${filename}:`, error);\r\n    showToast(`  : ${filename || 'unknown'}`);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  //  Bus Event Bridge \r\n\r\n  // Toast\r\n  bus.on('ui:show-toast', ((...args: unknown[]) => {\r\n    showToast(args[0] as string);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Loader\r\n  bus.on('ui:show-loader', ((...args: unknown[]) => {\r\n    showLoader(args[0] as boolean, args[1] as string | undefined);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('ui:update-loader', ((...args: unknown[]) => {\r\n    updateLoader(args[0] as number);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Play button state (enabled/disabled)\r\n  bus.on('ui:play-btn-state', ((...args: unknown[]) => {\r\n    const enabled = args[0] as boolean;\r\n    const btn = document.getElementById('play-btn');\r\n    if (btn) {\r\n      (btn as HTMLButtonElement).disabled = !enabled;\r\n      btn.style.opacity = enabled ? '1' : '0.4';\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Play/Pause visual state\r\n  bus.on('ui:update-play-state', ((...args: unknown[]) => {\r\n    const playing = args[0] as boolean;\r\n    const btn = document.getElementById('play-btn');\r\n    if (btn) btn.classList.toggle('playing', playing);\r\n    const icon = btn?.querySelector('path');\r\n    if (icon) {\r\n      icon.setAttribute('d', playing\r\n        ? 'M6 19h4V5H6v14zm8-14v14h4V5h-4z'  // pause icon\r\n        : 'M8 5v14l11-7z');                    // play icon\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Duration update\r\n  bus.on('ui:duration-update', ((...args: unknown[]) => {\r\n    const dur = args[0] as number;\r\n    const slider = document.getElementById('seek-slider') as HTMLInputElement | null;\r\n    const tTotal = document.getElementById('time-dur');\r\n    if (slider) { slider.max = String(dur); }\r\n    if (tTotal) tTotal.innerText = fmtTime(dur);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Seek reset\r\n  bus.on('ui:seek-reset', ((..._args: unknown[]) => {\r\n    const slider = document.getElementById('seek-slider') as HTMLInputElement | null;\r\n    const tc = document.getElementById('time-curr');\r\n    if (slider) { slider.value = '0'; }\r\n    if (tc) tc.innerText = '0:00';\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // UI loop (seek bar + time update during playback)\r\n  let _loopInterval: ReturnType<typeof setInterval> | null = null;\r\n  let _endedCheckCounter = 0;\r\n  bus.on('ui:loop-start', ((..._args: unknown[]) => {\r\n    if (_loopInterval) clearInterval(_loopInterval);\r\n    _endedCheckCounter = 0;\r\n    _loopInterval = setInterval(() => {\r\n      const currentState = getState<string>('appState');\r\n      if (isIdleOrPaused(currentState)) {\r\n        if (_loopInterval) { clearInterval(_loopInterval); _loopInterval = null; }\r\n        return;\r\n      }\r\n      const pos = getTrackPosition();\r\n      const slider = document.getElementById('seek-slider') as HTMLInputElement | null;\r\n      const tc = document.getElementById('time-curr');\r\n      const td = document.getElementById('time-dur');\r\n      const isSeeking = getState<boolean>('player.isSeeking');\r\n      if (slider && !isSeeking) {\r\n        slider.value = String(pos);\r\n      }\r\n      if (tc && !isSeeking) tc.innerText = fmtTime(pos);\r\n\r\n      // Safety polling: check if track ended (every ~500ms, since loop runs at 250ms)\r\n      _endedCheckCounter++;\r\n      if (_endedCheckCounter >= 2) {\r\n        _endedCheckCounter = 0;\r\n        bus.emit('player:check-ended');\r\n      }\r\n    }, 250);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Player actions\r\n  bus.on('player:toggle-play', ((..._args: unknown[]) => {\r\n    togglePlay();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('player:seek', ((...args: unknown[]) => {\r\n    const time = args[0] as number;\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (!hostConn) {\r\n      play(time);\r\n      const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n      broadcast({ type: MSG.PLAY, time, index: currentTrackIndex });\r\n      requestGlobalResyncDelayed();\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('player:seek-to-time', ((...args: unknown[]) => {\r\n    const time = args[0] as number;\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    const isOperator = getState<boolean>('network.isOperator');\r\n    if (hostConn && isOperator) {\r\n      hostConn.send({ type: MSG.REQUEST_SEEK, time });\r\n    } else if (!hostConn) {\r\n      const currentState = getState<string>('appState');\r\n      const currentTrackIndex = getState<number>('playlist.currentTrackIndex');\r\n      if (currentState === APP_STATE.PLAYING_AUDIO || currentState === APP_STATE.PLAYING_VIDEO) {\r\n        play(time);\r\n        broadcast({ type: MSG.PLAY, time, index: currentTrackIndex });\r\n        requestGlobalResyncDelayed();\r\n      } else {\r\n        setState('player.pausedAt', time);\r\n      }\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Playlist actions\r\n  bus.on('playlist:toggle-repeat', ((..._args: unknown[]) => {\r\n    toggleRepeat();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('playlist:toggle-shuffle', ((..._args: unknown[]) => {\r\n    toggleShuffle();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Metadata update (track title in player UI)\r\n  bus.on('player:metadata-update', ((...args: unknown[]) => {\r\n    const item = args[0] as PlaylistItem;\r\n    if (!item) return;\r\n    const title = item.title || item.name || 'Unknown';\r\n    updateTitleWithMarquee(title);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // YouTube time update (seek bar + time display)\r\n  bus.on('ui:time-update', ((...args: unknown[]) => {\r\n    const currFormatted = args[0] as string;\r\n    const totalFormatted = args[1] as string;\r\n    const currentTime = args[2] as number;\r\n    const duration = args[3] as number;\r\n\r\n    const slider = document.getElementById('seek-slider') as HTMLInputElement | null;\r\n    const tc = document.getElementById('time-curr');\r\n    const tt = document.getElementById('time-dur');\r\n    const isSeeking = getState<boolean>('player.isSeeking');\r\n\r\n    if (slider && duration > 0) {\r\n      slider.max = String(duration);\r\n      if (!isSeeking) slider.value = String(currentTime);\r\n    }\r\n    if (tc && !isSeeking) tc.innerText = currFormatted;\r\n    if (tt) tt.innerText = totalFormatted;\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  log.info('[PlayerControls] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Settings Panel (UI)\r\n * Extracted from original app.js\r\n *\r\n * Manages: Theme, channel mode selection, EQ/reverb/stereo/vbass sliders,\r\n * device list rendering.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState } from '../core/state.ts';\r\nimport { MSG } from '../core/constants.ts';\r\nimport { showToast } from './toast.ts';\r\nimport { setLanguageMode } from './i18n.ts';\r\nimport { getRoleLabelByChannelMode } from './player-controls.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Theme \r\n\r\nexport function setTheme(mode: string): void {\r\n  document.querySelectorAll('.theme-opt').forEach(el => el.classList.remove('active'));\r\n  const id = mode === 'light' ? 'theme-light' : mode === 'dark' ? 'theme-dark' : 'theme-system';\r\n  document.getElementById(id)?.classList.add('active');\r\n\r\n  // Sliding pill\r\n  const pillIndex = mode === 'light' ? 0 : mode === 'dark' ? 1 : 2;\r\n  document.querySelectorAll<HTMLElement>('.theme-selector').forEach(sel => {\r\n    sel.style.setProperty('--pill-index', String(pillIndex));\r\n  });\r\n\r\n  let resolved = mode;\r\n  if (mode === 'system') {\r\n    resolved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\r\n  }\r\n  document.documentElement.setAttribute('data-theme', resolved);\r\n\r\n  // Persist preference\r\n  try { localStorage.setItem('musixquare-theme', mode); } catch { /* ignore */ }\r\n\r\n  // Update meta tags for PWA/browser integration\r\n  document.documentElement.style.colorScheme = resolved;\r\n  const themeMeta = document.querySelector('meta[name=\"theme-color\"]');\r\n  if (themeMeta) themeMeta.setAttribute('content', resolved === 'dark' ? '#000000' : '#f2f2f7');\r\n  const schemeMeta = document.querySelector('meta[name=\"color-scheme\"]');\r\n  if (schemeMeta) schemeMeta.setAttribute('content', resolved);\r\n}\r\n\r\n//  Channel Mode (Standard) \r\n\r\nexport function selectStandardChannelButton(mode: number): void {\r\n  const all = document.querySelectorAll('#grid-standard .ch-opt[data-ch]');\r\n  all.forEach(e => e.classList.remove('active'));\r\n  const el = document.querySelector(`#grid-standard .ch-opt[data-ch=\"${mode}\"]`);\r\n  if (el) el.classList.add('active');\r\n}\r\n\r\nfunction setChannel(mode: number, el: Element): void {\r\n  const hostConn = getState<DataConnection | null>('network.hostConn');\r\n  if (hostConn) {\r\n    showToast('     .');\r\n    return;\r\n  }\r\n\r\n  selectStandardChannelButton(mode);\r\n  bus.emit('audio:set-channel-mode', mode);\r\n}\r\n\r\n//  Audio Effects Helpers \r\n\r\nfunction updateAudioEffect(type: string, param: string, value: unknown, isPreview = false): void {\r\n  bus.emit('audio:update-effect', type, param, value, isPreview);\r\n}\r\n\r\nfunction setPreamp(value: unknown, isPreview = false): void {\r\n  bus.emit('audio:set-preamp', value, isPreview);\r\n}\r\n\r\nfunction setEQ(band: number, value: unknown, isPreview = false): void {\r\n  bus.emit('audio:set-eq', band, value, isPreview);\r\n}\r\n\r\nfunction resetReverb(): void {\r\n  bus.emit('audio:reset-reverb');\r\n  // Reset slider UI\r\n  const defaults: Record<string, number> = {\r\n    'reverb-slider': 0,\r\n    'reverb-decay-slider': 5.0,\r\n    'reverb-predelay-slider': 0.1,\r\n    'reverb-lowcut-slider': 0,\r\n    'reverb-highcut-slider': 0,\r\n  };\r\n  for (const [id, val] of Object.entries(defaults)) {\r\n    const el = document.getElementById(id) as HTMLInputElement | null;\r\n    if (el) el.value = String(val);\r\n  }\r\n}\r\n\r\nfunction resetEQ(): void {\r\n  bus.emit('audio:reset-eq');\r\n  // Reset slider UI\r\n  const preamp = document.getElementById('preamp-slider') as HTMLInputElement | null;\r\n  if (preamp) preamp.value = '0';\r\n  for (let i = 0; i < 5; i++) {\r\n    const eq = document.getElementById(`eq-slider-${i}`) as HTMLInputElement | null;\r\n    if (eq) eq.value = '0';\r\n  }\r\n}\r\n\r\nfunction resetStereo(): void {\r\n  bus.emit('audio:reset-stereo');\r\n  const el = document.getElementById('width-slider') as HTMLInputElement | null;\r\n  if (el) el.value = '100';\r\n}\r\n\r\nfunction resetVBass(): void {\r\n  bus.emit('audio:reset-vbass');\r\n  const el = document.getElementById('vbass-slider') as HTMLInputElement | null;\r\n  if (el) el.value = '0';\r\n}\r\n\r\n//  Device List \r\n\r\nexport function renderDeviceList(list: Array<Record<string, unknown>>): void {\r\n  const container = document.getElementById('device-list');\r\n  if (!container) return;\r\n\r\n  container.innerHTML = '';\r\n\r\n  list.forEach((p) => {\r\n    const row = document.createElement('div');\r\n    row.className = 'section-row';\r\n\r\n    const name = document.createElement('span');\r\n    name.className = 'd-name';\r\n    name.textContent = String(p.label || 'Device');\r\n\r\n    const shortId = document.createElement('span');\r\n    shortId.style.cssText = 'font-size:11px; opacity:0.5; margin-left:4px;';\r\n    shortId.textContent = `(${String(p.id || '').substr(-4)})`;\r\n    name.appendChild(document.createTextNode(' '));\r\n    name.appendChild(shortId);\r\n\r\n    if (p.isOp) {\r\n      const op = document.createElement('span');\r\n      op.style.cssText = 'color:var(--primary); font-size:10px; font-weight:bold; margin-left:4px;';\r\n      op.textContent = 'OP';\r\n      name.appendChild(document.createTextNode(' '));\r\n      name.appendChild(op);\r\n    }\r\n\r\n    const statusClass = p.status === 'connected' ? 'active' : 'inactive';\r\n    const statusText = p.status === 'connected' ? 'Connected' : 'Disconnected';\r\n\r\n    const status = document.createElement('span');\r\n    status.className = `d-status ${statusClass}`;\r\n    status.textContent = statusText;\r\n\r\n    row.appendChild(name);\r\n\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) {\r\n      row.appendChild(status);\r\n    } else {\r\n      const right = document.createElement('div');\r\n      right.style.cssText = 'display:flex; gap:4px; align-items:center;';\r\n\r\n      if (!p.isHost && p.status === 'connected') {\r\n        const opBtn = document.createElement('button');\r\n        opBtn.className = `btn-action ${p.isOp ? 'active' : ''}`;\r\n        opBtn.dataset.opPeer = String(p.id || '');\r\n        opBtn.style.cssText = `font-size:10px; padding:4px 8px; margin-right:8px; ${p.isOp ? 'background:var(--primary); color:white; border:none;' : ''}`;\r\n        opBtn.textContent = p.isOp ? 'REVOKE' : 'GRANT';\r\n\r\n        opBtn.addEventListener('click', (e) => {\r\n          e.preventDefault();\r\n          const peerId = opBtn.dataset.opPeer;\r\n          if (peerId) bus.emit('network:toggle-operator', peerId);\r\n        });\r\n\r\n        right.appendChild(opBtn);\r\n      }\r\n\r\n      right.appendChild(status);\r\n      row.appendChild(right);\r\n    }\r\n\r\n    container.appendChild(row);\r\n  });\r\n}\r\n\r\n//  Init \r\n\r\nexport function initSettings(): void {\r\n  const $on = (id: string, evt: string, fn: EventListener) => {\r\n    const el = document.getElementById(id);\r\n    if (el) el.addEventListener(evt, fn);\r\n  };\r\n\r\n  // Theme\r\n  $on('theme-light', 'click', () => setTheme('light'));\r\n  $on('theme-dark', 'click', () => setTheme('dark'));\r\n  $on('theme-system', 'click', () => setTheme('system'));\r\n\r\n  // Language\r\n  $on('lang-ko', 'click', () => setLanguageMode('ko'));\r\n  $on('lang-en', 'click', () => setLanguageMode('en'));\r\n  $on('lang-system', 'click', () => setLanguageMode('system'));\r\n\r\n  // Channel grid (standard)\r\n  document.querySelectorAll<HTMLElement>('#grid-standard .ch-opt[data-ch]').forEach(el => {\r\n    el.addEventListener('click', () => setChannel(parseInt(el.dataset.ch!, 10), el));\r\n  });\r\n\r\n  // Surround toggle\r\n  $on('btn-surround-toggle', 'click', () => {\r\n    const hostConn = getState<DataConnection | null>('network.hostConn');\r\n    if (hostConn) {\r\n      showToast('     .');\r\n      return;\r\n    }\r\n    const current = getState<boolean>('audio.isSurroundMode');\r\n    bus.emit('audio:toggle-surround', !current);\r\n\r\n    // Toggle UI grid visibility\r\n    const stdGrid = document.getElementById('grid-standard');\r\n    const surrGrid = document.getElementById('grid-surround');\r\n    if (stdGrid) stdGrid.style.display = !current ? 'none' : '';\r\n    if (surrGrid) surrGrid.style.display = !current ? '' : 'none';\r\n\r\n    // Toggle button active state\r\n    const btn = document.getElementById('btn-surround-toggle');\r\n    if (btn) btn.classList.toggle('active', !current);\r\n  });\r\n\r\n  // Surround channel grid buttons\r\n  document.querySelectorAll<HTMLElement>('#grid-surround .ch-opt[data-surround-ch]').forEach(el => {\r\n    el.addEventListener('click', () => {\r\n      const idx = parseInt(el.dataset.surroundCh!, 10);\r\n      bus.emit('audio:set-surround-channel', idx);\r\n\r\n      // Highlight active button\r\n      document.querySelectorAll('#grid-surround .ch-opt[data-surround-ch]').forEach(\r\n        e => e.classList.remove('active'),\r\n      );\r\n      el.classList.add('active');\r\n    });\r\n  });\r\n\r\n  // Subwoofer cutoff\r\n  $on('cutoff-slider', 'input', function (this: HTMLInputElement) { bus.emit('audio:update-effect', 'cutoff', 'value', this.value, true); });\r\n  $on('cutoff-slider', 'change', function (this: HTMLInputElement) { bus.emit('audio:update-effect', 'cutoff', 'value', this.value); });\r\n  $on('cutoff-slider', 'dblclick', function (this: HTMLInputElement) { bus.emit('audio:update-effect', 'cutoff', 'value', 120); this.value = '120'; });\r\n\r\n  // Reverb\r\n  $on('btn-reset-reverb', 'click', () => resetReverb());\r\n  const reverbSliders = [\r\n    { id: 'reverb-slider', param: 'mix', resetVal: 0 },\r\n    { id: 'reverb-decay-slider', param: 'decay', resetVal: 5.0 },\r\n    { id: 'reverb-predelay-slider', param: 'predelay', resetVal: 0.1 },\r\n    { id: 'reverb-lowcut-slider', param: 'lowcut', resetVal: 0 },\r\n    { id: 'reverb-highcut-slider', param: 'highcut', resetVal: 0 },\r\n  ];\r\n  reverbSliders.forEach(({ id, param, resetVal }) => {\r\n    $on(id, 'input', function (this: HTMLInputElement) { updateAudioEffect('reverb', param, this.value, true); });\r\n    $on(id, 'change', function (this: HTMLInputElement) { updateAudioEffect('reverb', param, this.value); });\r\n    $on(id, 'dblclick', function (this: HTMLInputElement) { updateAudioEffect('reverb', param, resetVal); this.value = String(resetVal); });\r\n  });\r\n\r\n  // EQ\r\n  $on('btn-reset-eq', 'click', () => resetEQ());\r\n  $on('preamp-slider', 'input', function (this: HTMLInputElement) { setPreamp(this.value, true); });\r\n  $on('preamp-slider', 'change', function (this: HTMLInputElement) { setPreamp(this.value); });\r\n  $on('preamp-slider', 'dblclick', () => { setPreamp(0); const el = document.getElementById('preamp-slider') as HTMLInputElement; if (el) el.value = '0'; });\r\n  for (let i = 0; i < 5; i++) {\r\n    $on(`eq-slider-${i}`, 'input', function (this: HTMLInputElement) { setEQ(i, this.value, true); });\r\n    $on(`eq-slider-${i}`, 'change', function (this: HTMLInputElement) { setEQ(i, this.value); });\r\n    $on(`eq-slider-${i}`, 'dblclick', () => { setEQ(i, 0); const el = document.getElementById(`eq-slider-${i}`) as HTMLInputElement; if (el) el.value = '0'; });\r\n  }\r\n\r\n  // Stereo Width\r\n  $on('btn-reset-stereo', 'click', () => resetStereo());\r\n  $on('width-slider', 'input', function (this: HTMLInputElement) { updateAudioEffect('stereo', 'mix', this.value, true); });\r\n  $on('width-slider', 'change', function (this: HTMLInputElement) { updateAudioEffect('stereo', 'mix', this.value); });\r\n  $on('width-slider', 'dblclick', () => resetStereo());\r\n\r\n  // Virtual Bass\r\n  $on('btn-reset-vbass', 'click', () => resetVBass());\r\n  $on('vbass-slider', 'input', function (this: HTMLInputElement) { updateAudioEffect('vbass', 'mix', this.value, true); });\r\n  $on('vbass-slider', 'change', function (this: HTMLInputElement) { updateAudioEffect('vbass', 'mix', this.value); });\r\n  $on('vbass-slider', 'dblclick', () => { updateAudioEffect('vbass', 'mix', 0); const el = document.getElementById('vbass-slider') as HTMLInputElement; if (el) el.value = '0'; });\r\n\r\n  // Manual sync popup\r\n  $on('btn-nudge-minus10', 'click', () => bus.emit('sync:nudge', -10));\r\n  $on('btn-nudge-minus1', 'click', () => bus.emit('sync:nudge', -1));\r\n  $on('btn-nudge-plus1', 'click', () => bus.emit('sync:nudge', 1));\r\n  $on('btn-nudge-plus10', 'click', () => bus.emit('sync:nudge', 10));\r\n  $on('btn-auto-sync', 'click', () => bus.emit('sync:auto-sync'));\r\n  $on('btn-sync-done', 'click', () => bus.emit('sync:close-manual'));\r\n\r\n  // Device list events\r\n  bus.on('network:device-list-update', ((...args: unknown[]) => {\r\n    const list = args[0] as Array<Record<string, unknown>>;\r\n    if (Array.isArray(list)) renderDeviceList(list);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Theme: listen for system change\r\n  try {\r\n    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\r\n      const themeSystem = document.getElementById('theme-system');\r\n      if (themeSystem?.classList.contains('active')) {\r\n        setTheme('system');\r\n      }\r\n    });\r\n  } catch { /* ignore */ }\r\n\r\n  // Initial theme: restore from localStorage or default to system\r\n  const savedTheme = localStorage.getItem('musixquare-theme');\r\n  setTheme(savedTheme || 'system');\r\n\r\n  log.info('[Settings] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Setup Flow (UI)\r\n * Extracted from original app.js lines 2123-3062\r\n *\r\n * Manages: Setup overlay, host/guest role selection, onboarding slider,\r\n * invite code display, desktop left-panel sync.\r\n */\r\n\r\nimport { log } from '../core/log.ts';\r\nimport { bus } from '../core/events.ts';\r\nimport { getState, setState } from '../core/state.ts';\r\nimport { setManagedTimer, clearManagedTimer } from '../core/timers.ts';\r\nimport { animateTransition, updateOverlayOpenClass } from './dom.ts';\r\nimport { showToast } from './toast.ts';\r\nimport { showDialog } from './dialog.ts';\r\nimport {\r\n  updateRoleBadge, updateInviteCodeUI,\r\n  showPlacementToastForChannel,\r\n} from './player-controls.ts';\r\nimport { selectStandardChannelButton } from './settings.ts';\r\nimport { createHostSessionWithShortCode, leaveSession } from '../network/peer.ts';\r\nimport { joinSession } from '../network/peer.ts';\r\nimport type { DataConnection } from '../types/index.ts';\r\n\r\n//  Constants \r\n\r\nconst PEER_NAME_PREFIX = 'Peer';\r\nconst TOTAL_OB_SLIDES = 4;\r\n\r\n//  State \r\n\r\nlet _currentObSlide = 0;\r\nlet _setupOverlayEverShown = false;\r\nlet _pendingSetupRole: number | null = null;\r\nlet _pendingGuestRoleMode: number | null = null;\r\n\r\n//  Desktop Left Panel Sync \r\n\r\nlet _desktopSyncedDiagram: HTMLElement | null = null;\r\nlet _desktopSyncedDiagramParent: HTMLElement | null = null;\r\nlet _desktopSyncedDiagramNextSibling: Node | null = null;\r\n\r\nfunction isDesktopLayout(): boolean {\r\n  return window.matchMedia('(min-width: 1280px)').matches;\r\n}\r\n\r\nfunction _restoreDesktopDiagram(): void {\r\n  if (_desktopSyncedDiagram && _desktopSyncedDiagramParent) {\r\n    try {\r\n      _desktopSyncedDiagramParent.insertBefore(_desktopSyncedDiagram, _desktopSyncedDiagramNextSibling || null);\r\n    } catch { /* ignore */ }\r\n  }\r\n  _desktopSyncedDiagram = null;\r\n  _desktopSyncedDiagramParent = null;\r\n  _desktopSyncedDiagramNextSibling = null;\r\n  const hc = document.getElementById('desktop-step-header');\r\n  const dc = document.getElementById('desktop-diagram-area');\r\n  if (hc) hc.innerHTML = '';\r\n  if (dc) dc.innerHTML = '';\r\n}\r\n\r\nfunction syncDesktopLeftPanel(): void {\r\n  const headerContainer = document.getElementById('desktop-step-header');\r\n  const diagramContainer = document.getElementById('desktop-diagram-area');\r\n  if (!headerContainer || !diagramContainer) return;\r\n\r\n  if (!isDesktopLayout()) {\r\n    _restoreDesktopDiagram();\r\n    return;\r\n  }\r\n\r\n  if (_desktopSyncedDiagram && _desktopSyncedDiagramParent) {\r\n    try {\r\n      _desktopSyncedDiagramParent.insertBefore(_desktopSyncedDiagram, _desktopSyncedDiagramNextSibling || null);\r\n    } catch { /* ignore */ }\r\n    _desktopSyncedDiagram = null;\r\n    _desktopSyncedDiagramParent = null;\r\n    _desktopSyncedDiagramNextSibling = null;\r\n  }\r\n  diagramContainer.innerHTML = '';\r\n  headerContainer.innerHTML = '';\r\n\r\n  const areas: Array<{ id: string; diagram: (el: HTMLElement) => HTMLElement | null }> = [\r\n    { id: 'setup-welcome-area', diagram: () => document.getElementById('ob-slider-area') },\r\n    { id: 'setup-role-area', diagram: (el) => el.querySelector('.setup-graphic-container') as HTMLElement | null },\r\n    { id: 'setup-join-area', diagram: (el) => el.querySelector('.setup-guide-unified') as HTMLElement | null },\r\n    { id: 'setup-code-area', diagram: (el) => el.querySelector('.setup-guide-unified') as HTMLElement | null },\r\n  ];\r\n\r\n  for (const area of areas) {\r\n    const areaEl = document.getElementById(area.id) as HTMLElement | null;\r\n    if (!areaEl || areaEl.style.display === 'none') continue;\r\n\r\n    const headerSrc = areaEl.querySelector('.setup-header-text');\r\n    if (headerSrc) headerContainer.innerHTML = headerSrc.innerHTML;\r\n\r\n    const diagramEl = area.diagram(areaEl);\r\n    if (diagramEl) {\r\n      _desktopSyncedDiagramParent = diagramEl.parentElement as HTMLElement | null;\r\n      _desktopSyncedDiagramNextSibling = diagramEl.nextSibling;\r\n      _desktopSyncedDiagram = diagramEl;\r\n      diagramContainer.appendChild(diagramEl);\r\n    }\r\n    break;\r\n  }\r\n}\r\n\r\n//  Setup Helpers \r\n\r\nfunction setupEl(id: string): HTMLElement | null {\r\n  return document.getElementById(id);\r\n}\r\n\r\nfunction showSetupOverlay(): void {\r\n  animateTransition(() => {\r\n    const ov = setupEl('setup-overlay');\r\n    if (ov) ov.classList.add('active');\r\n    updateOverlayOpenClass();\r\n    try { document.documentElement.classList.remove('setup-boot-block'); } catch { /* ignore */ }\r\n    _setupOverlayEverShown = true;\r\n  });\r\n}\r\n\r\nfunction hideSetupOverlay(): void {\r\n  animateTransition(() => {\r\n    const overlay = setupEl('setup-overlay');\r\n    if (overlay) overlay.classList.remove('active');\r\n    updateOverlayOpenClass();\r\n    stopObAutoSlide();\r\n    try { document.documentElement.classList.remove('setup-boot-block'); } catch { /* ignore */ }\r\n    try {\r\n      requestAnimationFrame(() => {\r\n        try { void document.documentElement.offsetHeight; } catch { /* ignore */ }\r\n      });\r\n    } catch { /* ignore */ }\r\n  });\r\n}\r\n\r\nfunction setupShowCodeArea(show: boolean): void {\r\n  animateTransition(() => {\r\n    const box = setupEl('setup-code-area');\r\n    if (box) box.style.display = show ? 'flex' : 'none';\r\n    syncDesktopLeftPanel();\r\n  });\r\n}\r\n\r\nfunction setupSetCode(code: string): void {\r\n  const el = setupEl('setup-code');\r\n  if (el) {\r\n    if (el.tagName === 'INPUT') (el as HTMLInputElement).value = code || '------';\r\n    else el.textContent = code || '------';\r\n  }\r\n  setupShowCodeArea(!!code);\r\n}\r\n\r\nfunction setupShowInstruction(show: boolean, text = ''): void {\r\n  const el = setupEl('setup-instruction');\r\n  if (!el) return;\r\n  el.style.display = show ? 'block' : 'none';\r\n  el.textContent = text || '';\r\n}\r\n\r\nfunction setupShowJoinArea(show: boolean): void {\r\n  animateTransition(() => {\r\n    const el = setupEl('setup-join-area');\r\n    if (el) el.style.display = show ? 'flex' : 'none';\r\n    syncDesktopLeftPanel();\r\n  });\r\n}\r\n\r\nfunction setupShowRoleArea(show: boolean): void {\r\n  animateTransition(() => {\r\n    const el = setupEl('setup-role-area');\r\n    if (el) el.style.display = show ? 'flex' : 'none';\r\n    syncDesktopLeftPanel();\r\n  });\r\n}\r\n\r\nfunction setupShowWelcome(show: boolean): void {\r\n  animateTransition(() => {\r\n    const el = setupEl('setup-welcome-area');\r\n    if (el) el.style.display = show ? 'flex' : 'none';\r\n    syncDesktopLeftPanel();\r\n  });\r\n}\r\n\r\nfunction setupSetGuestJoinBusy(busy: boolean): void {\r\n  const input = setupEl('setup-join-code') as HTMLInputElement | null;\r\n  if (input) input.disabled = !!busy;\r\n\r\n  const grid = setupEl('setup-role-grid') as HTMLElement | null;\r\n  if (grid) {\r\n    grid.style.pointerEvents = busy ? 'none' : 'auto';\r\n    grid.style.opacity = busy ? '0.6' : '1';\r\n  }\r\n}\r\n\r\nfunction setupHighlightJoinRole(mode: number | null): void {\r\n  const opts = document.querySelectorAll<HTMLElement>('#setup-role-grid .ch-opt[data-join-ch]');\r\n  opts.forEach(o => o.classList.remove('selected'));\r\n  if (mode !== null && mode !== undefined) {\r\n    const el = document.querySelector(`#setup-role-grid .ch-opt[data-join-ch=\"${mode}\"]`);\r\n    if (el) el.classList.add('selected');\r\n  }\r\n\r\n  const speakers = document.querySelectorAll<HTMLElement>('.setup-graphic-svg .graphic-speaker');\r\n  speakers.forEach(el => el.classList.remove('active'));\r\n\r\n  let targetId: string | null = null;\r\n  if (mode === -1) targetId = 'svg-spk-l';\r\n  else if (mode === 1) targetId = 'svg-spk-r';\r\n  else if (mode === 0) targetId = 'svg-spk-center';\r\n  else if (mode === 2) targetId = 'svg-spk-woofer';\r\n\r\n  if (targetId) {\r\n    const spk = document.getElementById(targetId);\r\n    if (spk) spk.classList.add('active');\r\n  }\r\n}\r\n\r\n//  Button Rendering \r\n\r\ninterface SetupButton {\r\n  id: string;\r\n  text?: string;\r\n  html?: string;\r\n  kind?: 'primary' | 'secondary' | 'text-link' | 'icon-only';\r\n  disabled?: boolean;\r\n  onClick?: (() => void) | null;\r\n}\r\n\r\nfunction setupRenderActions(buttons: SetupButton[], layout: 'row' | 'vertical' | 'horizontal-with-back' = 'row'): void {\r\n  const area = setupEl('setup-actions');\r\n  if (!area) return;\r\n  area.innerHTML = '';\r\n\r\n  area.classList.remove('vertical', 'horizontal-with-back');\r\n  if (layout === 'vertical') area.classList.add('vertical');\r\n  else if (layout === 'horizontal-with-back') area.classList.add('horizontal-with-back');\r\n\r\n  buttons.forEach(btn => {\r\n    const b = document.createElement('button');\r\n    b.id = btn.id;\r\n    b.type = 'button';\r\n\r\n    if (btn.kind === 'secondary') b.className = 'btn-ob-secondary';\r\n    else if (btn.kind === 'text-link') b.className = 'btn-ob-text-link';\r\n    else if (btn.kind === 'icon-only') b.className = 'btn-ob-icon';\r\n    else b.className = 'btn-ob-primary';\r\n\r\n    if (btn.html) b.innerHTML = btn.html;\r\n    else if (btn.text) b.textContent = btn.text;\r\n\r\n    if (btn.disabled) b.disabled = true;\r\n    if (btn.onClick) b.addEventListener('click', btn.onClick);\r\n    area.appendChild(b);\r\n  });\r\n}\r\n\r\nconst BACK_SVG = '<svg viewBox=\"0 0 24 24\"><path d=\"M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z\"/></svg>';\r\n\r\n//  Onboarding Slider \r\n\r\nfunction startObAutoSlide(): void {\r\n  stopObAutoSlide();\r\n  setManagedTimer('obAutoSlideTimer', () => {\r\n    nextObSlide(true);\r\n  }, 5000, { interval: true });\r\n}\r\n\r\nfunction stopObAutoSlide(): void {\r\n  clearManagedTimer('obAutoSlideTimer');\r\n}\r\n\r\nfunction updateObSlider(): void {\r\n  const track = setupEl('ob-slider-track');\r\n  const dots = document.querySelectorAll('.ob-dot');\r\n  if (!track) return;\r\n\r\n  (track as HTMLElement).style.transform = `translateX(-${_currentObSlide * 100}%)`;\r\n  dots.forEach((dot, idx) => {\r\n    dot.classList.toggle('active', idx === _currentObSlide);\r\n  });\r\n}\r\n\r\nfunction nextObSlide(isAuto = false): void {\r\n  if (_currentObSlide < TOTAL_OB_SLIDES - 1) _currentObSlide++;\r\n  else _currentObSlide = 0;\r\n  updateObSlider();\r\n  if (isAuto !== true) startObAutoSlide();\r\n}\r\n\r\nfunction prevObSlide(): void {\r\n  if (_currentObSlide > 0) _currentObSlide--;\r\n  else _currentObSlide = TOTAL_OB_SLIDES - 1;\r\n  updateObSlider();\r\n  startObAutoSlide();\r\n}\r\n\r\n//  Role Selection Buttons \r\n\r\nfunction showRoleSelectionButtons(): void {\r\n  setupRenderActions([\r\n    { id: 'btn-setup-host', text: ' ', kind: 'primary', onClick: startHostFlow },\r\n    { id: 'btn-setup-guest', text: ' ', kind: 'secondary', onClick: startGuestFlow },\r\n  ], 'vertical');\r\n}\r\n\r\n//  Handle Role Preview \r\n\r\nfunction handleSetupRolePreview(mode: number): void {\r\n  const appRole = getState<string>('network.appRole');\r\n  if (appRole !== 'guest' && appRole !== 'host') return;\r\n  _pendingSetupRole = mode;\r\n  setupHighlightJoinRole(mode);\r\n  showPlacementToastForChannel(mode);\r\n\r\n  const nextBtn = document.getElementById('btn-setup-next');\r\n  if (nextBtn) {\r\n    nextBtn.classList.remove('btn-ob-secondary');\r\n    nextBtn.classList.add('btn-ob-primary');\r\n  }\r\n}\r\n\r\n//  Host Flow \r\n\r\nfunction startHostFlow(): void {\r\n  bus.emit('audio:activate');\r\n\r\n  setState('network.appRole', 'host');\r\n  setState('setup.sessionStarted', false);\r\n  _pendingSetupRole = null;\r\n\r\n  setupShowJoinArea(false);\r\n  setupShowCodeArea(false);\r\n  setupShowWelcome(false);\r\n  setupShowRoleArea(true);\r\n  setupShowInstruction(false);\r\n  setupHighlightJoinRole(null);\r\n\r\n  const sliderArea = setupEl('ob-slider-area');\r\n  if (sliderArea) {\r\n    sliderArea.style.display = 'none';\r\n    stopObAutoSlide();\r\n  }\r\n\r\n  setupRenderActions([\r\n    { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => initSetupOverlay() },\r\n    {\r\n      id: 'btn-setup-next', text: '', kind: 'primary',\r\n      onClick: () => {\r\n        if (_pendingSetupRole !== null) proceedToHostCode(_pendingSetupRole);\r\n        else showToast(' ');\r\n      },\r\n    },\r\n  ], 'horizontal-with-back');\r\n}\r\n\r\nasync function proceedToHostCode(mode: number): Promise<void> {\r\n  const appRole = getState<string>('network.appRole');\r\n  if (appRole !== 'host') return;\r\n\r\n  try {\r\n    selectStandardChannelButton(mode);\r\n    bus.emit('audio:set-channel-mode', mode);\r\n  } catch (e) { log.warn(e); }\r\n\r\n  setupShowRoleArea(false);\r\n  setupShowCodeArea(true);\r\n\r\n  const codeEl = setupEl('setup-code');\r\n  if (codeEl) {\r\n    if (codeEl.tagName === 'INPUT') (codeEl as HTMLInputElement).value = '------';\r\n    else codeEl.textContent = '------';\r\n  }\r\n\r\n  setupRenderActions([\r\n    { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => startHostFlow() },\r\n    { id: 'btn-setup-confirm', text: '...', kind: 'secondary', disabled: true },\r\n  ], 'horizontal-with-back');\r\n\r\n  try {\r\n    const code = await createHostSessionWithShortCode();\r\n\r\n    setState('network.sessionCode', code);\r\n    setupSetCode(code);\r\n    updateInviteCodeUI();\r\n    setState('network.myDeviceLabel', 'HOST');\r\n    updateRoleBadge();\r\n    setupShowInstruction(false);\r\n\r\n    setupRenderActions([\r\n      { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => startHostFlow() },\r\n      { id: 'btn-setup-confirm', text: '', kind: 'primary', onClick: () => startSessionFromHost() },\r\n    ], 'horizontal-with-back');\r\n  } catch (e) {\r\n    log.error('[Setup] Host session init failed', e);\r\n    showToast('  ');\r\n    startHostFlow();\r\n  }\r\n}\r\n\r\nfunction startSessionFromHost(): void {\r\n  const appRole = getState<string>('network.appRole');\r\n  if (appRole !== 'host') return;\r\n\r\n  setState('setup.sessionStarted', true);\r\n  hideSetupOverlay();\r\n  showToast('      ');\r\n  updateRoleBadge();\r\n\r\n  setTimeout(() => {\r\n    const btn = document.getElementById('btn-media-source');\r\n    if (btn) {\r\n      btn.classList.add('blink-hint');\r\n      btn.addEventListener('animationend', () => {\r\n        btn.classList.remove('blink-hint');\r\n      }, { once: true });\r\n    }\r\n  }, 400);\r\n}\r\n\r\n//  Guest Flow \r\n\r\nfunction startGuestFlow(): void {\r\n  bus.emit('audio:activate');\r\n\r\n  setState('network.appRole', 'guest');\r\n  setState('setup.sessionStarted', false);\r\n  _pendingSetupRole = null;\r\n\r\n  updateInviteCodeUI();\r\n\r\n  setupShowCodeArea(false);\r\n  setupShowJoinArea(false);\r\n  setupShowWelcome(false);\r\n  setupShowRoleArea(true);\r\n  setupShowInstruction(false);\r\n  setupHighlightJoinRole(null);\r\n  setupSetGuestJoinBusy(false);\r\n\r\n  const sliderArea = setupEl('ob-slider-area');\r\n  if (sliderArea) {\r\n    sliderArea.style.display = 'none';\r\n    stopObAutoSlide();\r\n  }\r\n\r\n  setupRenderActions([\r\n    { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => initSetupOverlay() },\r\n    {\r\n      id: 'btn-setup-next', text: '', kind: 'primary',\r\n      onClick: () => {\r\n        if (_pendingSetupRole !== null) proceedToGuestCode(_pendingSetupRole);\r\n        else showToast(' ');\r\n      },\r\n    },\r\n  ], 'horizontal-with-back');\r\n\r\n  setState('network.myDeviceLabel', '');\r\n  updateRoleBadge();\r\n}\r\n\r\nfunction proceedToGuestCode(mode: number): void {\r\n  _pendingGuestRoleMode = mode;\r\n\r\n  setupShowRoleArea(false);\r\n  setupShowJoinArea(true);\r\n  setupShowInstruction(false);\r\n\r\n  setupRenderActions([\r\n    { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => startGuestFlow() },\r\n    { id: 'btn-setup-confirm', text: '', kind: 'primary', onClick: () => handleSetupJoinWithRole(_pendingGuestRoleMode!) },\r\n  ], 'horizontal-with-back');\r\n\r\n  const input = setupEl('setup-join-code') as HTMLInputElement | null;\r\n  if (input) {\r\n    input.value = '';\r\n    input.focus();\r\n  }\r\n}\r\n\r\nasync function handleSetupJoinWithRole(mode: number | null): Promise<void> {\r\n  if (mode === null || mode === undefined) {\r\n    showToast('  ');\r\n    return;\r\n  }\r\n\r\n  const appRole = getState<string>('network.appRole');\r\n  if (appRole !== 'guest') return;\r\n\r\n  const input = setupEl('setup-join-code') as HTMLInputElement | null;\r\n  const codeRaw = (input ? input.value : '').trim();\r\n  const code = codeRaw.replace(/\\s+/g, '');\r\n\r\n  if (!/^\\d{6}$/.test(code)) {\r\n    showToast('6   ');\r\n    if (input) input.focus();\r\n    return;\r\n  }\r\n\r\n  setState('network.lastJoinCode', code);\r\n  updateInviteCodeUI();\r\n\r\n  setState('setup.selectedJoinChannelMode', mode);\r\n  setState('setup.pendingPlacementToastMode', mode);\r\n\r\n  try {\r\n    selectStandardChannelButton(mode);\r\n    bus.emit('audio:set-channel-mode', mode);\r\n  } catch (e) { log.warn('[Setup] setChannelMode failed', e); }\r\n\r\n  setState('network.myDeviceLabel', PEER_NAME_PREFIX);\r\n  updateRoleBadge();\r\n\r\n  setupSetGuestJoinBusy(true);\r\n  setState('network.isConnecting', true);\r\n  updateRoleBadge();\r\n\r\n  setupRenderActions([\r\n    { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => startGuestFlow() },\r\n    { id: 'btn-setup-confirm', text: ' ...', kind: 'primary', disabled: true },\r\n  ], 'horizontal-with-back');\r\n\r\n  joinSession(code);\r\n}\r\n\r\n//  Init \r\n\r\nfunction initSetupOverlay(): void {\r\n  const sliderArea = setupEl('ob-slider-area');\r\n  if (sliderArea) sliderArea.style.display = 'block';\r\n\r\n  setupShowCodeArea(false);\r\n  setupShowJoinArea(false);\r\n  setupShowRoleArea(false);\r\n  setupShowWelcome(true);\r\n  setupShowInstruction(false, '');\r\n  setupSetGuestJoinBusy(false);\r\n\r\n  setState('network.appRole', 'idle');\r\n  setState('network.sessionCode', '');\r\n  _currentObSlide = 0;\r\n  setState('setup.sessionStarted', false);\r\n  _pendingSetupRole = null;\r\n  _pendingGuestRoleMode = null;\r\n\r\n  updateRoleBadge();\r\n  updateObSlider();\r\n  showRoleSelectionButtons();\r\n\r\n  const showAndStart = () => {\r\n    try { bus.emit('platform:freeze-layout'); } catch { /* ignore */ }\r\n    showSetupOverlay();\r\n    startObAutoSlide();\r\n  };\r\n\r\n  if (!_setupOverlayEverShown) {\r\n    try { document.documentElement.classList.add('setup-boot-block'); } catch { /* ignore */ }\r\n  }\r\n  showAndStart();\r\n\r\n  // Bind slider events\r\n  const btnNext = setupEl('ob-next');\r\n  if (btnNext) btnNext.onclick = () => nextObSlide(false);\r\n  const btnPrev = setupEl('ob-prev');\r\n  if (btnPrev) btnPrev.onclick = () => prevObSlide();\r\n\r\n  document.querySelectorAll<HTMLElement>('.ob-dot').forEach(dot => {\r\n    dot.onclick = (e) => {\r\n      const dotEl = (e.target as HTMLElement).closest('.ob-dot') as HTMLElement | null;\r\n      const idx = parseInt(dotEl?.dataset?.idx || '', 10);\r\n      if (isNaN(idx)) return;\r\n      _currentObSlide = idx;\r\n      updateObSlider();\r\n      startObAutoSlide();\r\n    };\r\n  });\r\n\r\n  // Swipe\r\n  const viewport = setupEl('ob-slider-viewport');\r\n  if (viewport) {\r\n    let startX = 0;\r\n    viewport.ontouchstart = (e) => { startX = (e as TouchEvent).touches[0].clientX; };\r\n    viewport.ontouchend = (e) => {\r\n      const endX = (e as TouchEvent).changedTouches[0].clientX;\r\n      const diff = startX - endX;\r\n      if (Math.abs(diff) > 50) {\r\n        if (diff > 0) nextObSlide(false);\r\n        else prevObSlide();\r\n      }\r\n    };\r\n  }\r\n}\r\n\r\nexport function initSetup(): void {\r\n  // Desktop layout listener\r\n  try {\r\n    const mql = window.matchMedia('(min-width: 1280px)');\r\n    mql.addEventListener('change', () => syncDesktopLeftPanel());\r\n  } catch { /* ignore */ }\r\n\r\n  // Role grid click handler (event delegation)\r\n  const roleGrid = document.getElementById('setup-role-grid');\r\n  if (roleGrid) {\r\n    roleGrid.addEventListener('click', (e) => {\r\n      const item = (e.target as HTMLElement).closest('.ch-opt') as HTMLElement | null;\r\n      if (!item) return;\r\n      const mode = parseInt(item.dataset.joinCh || '', 10);\r\n      if (isNaN(mode)) return;\r\n      handleSetupRolePreview(mode);\r\n    });\r\n  }\r\n\r\n  // SVG speaker click\r\n  function handleSpeakerClick(e: Event): void {\r\n    const item = (e.target as HTMLElement).closest('.graphic-speaker') as HTMLElement | null;\r\n    if (!item) return;\r\n    const SVG_ID_TO_MODE: Record<string, number> = { 'svg-spk-l': -1, 'svg-spk-r': 1, 'svg-spk-center': 0, 'svg-spk-woofer': 2 };\r\n    const mode = SVG_ID_TO_MODE[item.id];\r\n    if (mode !== undefined) handleSetupRolePreview(mode);\r\n  }\r\n\r\n  const roleArea = document.getElementById('setup-role-area');\r\n  if (roleArea) roleArea.addEventListener('click', handleSpeakerClick);\r\n  const desktopDiagramArea = document.getElementById('desktop-diagram-area');\r\n  if (desktopDiagramArea) desktopDiagramArea.addEventListener('click', handleSpeakerClick);\r\n\r\n  // Setup join code input\r\n  const joinInput = document.getElementById('setup-join-code') as HTMLInputElement | null;\r\n  if (joinInput) {\r\n    joinInput.addEventListener('input', () => {\r\n      const raw = joinInput.value || '';\r\n      const digits = raw.replace(/\\D+/g, '').slice(0, 6);\r\n      if (raw !== digits) joinInput.value = digits;\r\n    });\r\n    joinInput.addEventListener('keydown', (e) => {\r\n      if (e.key !== 'Enter') return;\r\n      e.preventDefault();\r\n      if (_pendingGuestRoleMode !== null) {\r\n        handleSetupJoinWithRole(_pendingGuestRoleMode);\r\n      }\r\n    });\r\n  }\r\n\r\n  // PeerJS ready (peer ID assigned)\r\n  bus.on('network:peer-ready', ((...args: unknown[]) => {\r\n    const peerId = args[0] as string;\r\n    const myIdEl = document.getElementById('my-id');\r\n    if (myIdEl && peerId) myIdEl.innerText = peerId;\r\n    updateRoleBadge();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Session started (backward compat with legacy hosts)\r\n  bus.on('setup:hide-overlay', ((..._args: unknown[]) => {\r\n    hideSetupOverlay();\r\n    updateRoleBadge();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Guest join success/failure events\r\n  bus.on('setup:guest-join-success', ((..._args: unknown[]) => {\r\n    setState('network.isConnecting', false);\r\n    updateRoleBadge();\r\n    hideSetupOverlay();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  bus.on('setup:guest-join-failure', ((...args: unknown[]) => {\r\n    setState('network.isConnecting', false);\r\n    updateRoleBadge();\r\n    showToast(' .  WiFi    .');\r\n\r\n    setupRenderActions([\r\n      { id: 'btn-setup-back', html: BACK_SVG, kind: 'icon-only', onClick: () => startGuestFlow() },\r\n      { id: 'btn-setup-confirm', text: '', kind: 'primary', onClick: () => handleSetupJoinWithRole(_pendingGuestRoleMode!) },\r\n    ], 'horizontal-with-back');\r\n\r\n    const input = setupEl('setup-join-code') as HTMLInputElement | null;\r\n    if (input) {\r\n      input.disabled = false;\r\n      input.focus();\r\n    }\r\n    setupSetGuestJoinBusy(false);\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Return to main event\r\n  bus.on('app:return-to-main', ((..._args: unknown[]) => {\r\n    leaveSession();\r\n    initSetupOverlay();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Network error handling (connection failures, timeouts, etc.)\r\n  bus.on('network:error', ((...args: unknown[]) => {\r\n    const err = args[0] as Record<string, unknown> | null;\r\n    const msg = (err as Error | null)?.message || '';\r\n    const peerType = (err && typeof err === 'object') ? String(err.type || '') : '';\r\n    let userMsg = '  ';\r\n\r\n    // Our custom error messages\r\n    if (msg === 'HOST_UNREACHABLE') userMsg = '   .  WiFi   .';\r\n    else if (msg === 'HOST_DISCONNECTED') userMsg = '  ';\r\n    else if (msg === 'HOST_CONNECTION_ERROR') userMsg = '    ';\r\n    else if (msg === 'CONNECT_FAILED') userMsg = ' ';\r\n    else if (msg === 'PEER_NOT_READY') userMsg = '    ';\r\n    else if (msg === 'NETWORK_INIT_FAILED') userMsg = '  ';\r\n    else if (msg === 'NO_HOST_ID') userMsg = ' ID ';\r\n    // PeerJS native error types\r\n    else if (peerType === 'peer-unavailable') userMsg = '   .    .';\r\n    else if (peerType === 'network') userMsg = '   .    .';\r\n    else if (peerType === 'server-error') userMsg = '    .     .';\r\n    else if (peerType === 'socket-error' || peerType === 'socket-closed') userMsg = '  .';\r\n    else if (peerType === 'unavailable-id') userMsg = ' ID   .   .';\r\n    else if (peerType === 'webrtc') userMsg = 'WebRTC  .    .';\r\n\r\n    const isConnecting = getState<boolean>('network.isConnecting');\r\n    if (isConnecting) {\r\n      // Still trying to join  emit failure for UI reset\r\n      showToast(userMsg);\r\n      bus.emit('setup:guest-join-failure', err);\r\n    } else if (msg === 'HOST_DISCONNECTED' || msg === 'HOST_CONNECTION_ERROR') {\r\n      // Post-connection disconnect: show dialog + re-enable join\r\n      showDialog({\r\n        title: ' ',\r\n        message: `${userMsg}\\n ?`,\r\n        buttonText: ' ',\r\n        secondaryText: '',\r\n      }).then(res => {\r\n        if (res.action === 'ok') {\r\n          // Pre-fill the join code and re-enable join flow\r\n          const lastCode = getState<string>('network.lastJoinCode') || '';\r\n          startGuestFlow();\r\n          if (lastCode) {\r\n            const input = setupEl('setup-join-code') as HTMLInputElement | null;\r\n            if (input) { input.value = lastCode; input.focus(); }\r\n          }\r\n        } else {\r\n          initSetupOverlay();\r\n        }\r\n      });\r\n    } else {\r\n      showToast(userMsg);\r\n    }\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Session full (guest rejected by full host)\r\n  bus.on('network:session-full', ((...args: unknown[]) => {\r\n    const msg = args[0] as string || '  ';\r\n    showDialog({ title: '  ', message: String(msg) });\r\n    startGuestFlow();\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Kicked from session (guest removed from host device list)\r\n  bus.on('network:kicked-from-session', ((..._args: unknown[]) => {\r\n    showToast('  ');\r\n    bus.emit('app:return-to-main');\r\n  }) as (...args: unknown[]) => void);\r\n\r\n  // Initial overlay\r\n  initSetupOverlay();\r\n\r\n  log.info('[Setup] Initialized');\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Service Worker Registration\r\n *\r\n * Registers the service worker and handles update checks.\r\n * The service-worker.js itself remains in public/ as plain JS (outside Vite build).\r\n */\r\n\r\nimport { log } from './core/log.ts';\r\nimport { showDialog } from './ui/dialog.ts';\r\n\r\nlet _swWantsReload = false;\r\nlet _swReloading = false;\r\n\r\nexport function registerServiceWorker(): void {\r\n  if (!('serviceWorker' in navigator)) {\r\n    log.info('[SW] Service Worker not supported');\r\n    return;\r\n  }\r\n\r\n  if (!window.isSecureContext) {\r\n    log.info('[SW] Not a secure context, skipping registration');\r\n    return;\r\n  }\r\n\r\n  const doRegister = async () => {\r\n    // Relative URL resolved against current location (works under subpath deployments)\r\n    const swUrl = new URL('service-worker.js', window.location.href);\r\n\r\n    try {\r\n      const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });\r\n      log.info('[SW] Registered:', reg.scope);\r\n\r\n      // Listen for controller changes  reload only when we explicitly want to\r\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\r\n        if (!_swWantsReload || _swReloading) return;\r\n        _swReloading = true;\r\n        window.location.reload();\r\n      });\r\n\r\n      // Update flow\r\n      reg.addEventListener('updatefound', () => {\r\n        const newWorker = reg.installing;\r\n        if (!newWorker) return;\r\n\r\n        newWorker.addEventListener('statechange', async () => {\r\n          // \"installed\" with an existing controller means: update is ready\r\n          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\r\n            try {\r\n              const result = await showDialog({\r\n                title: '',\r\n                message: '  .   .',\r\n                buttonText: '',\r\n                dismissible: true,\r\n              });\r\n\r\n              // Only proceed if user clicked OK\r\n              if (!result || result.action !== 'ok') return;\r\n\r\n              _swWantsReload = true;\r\n              if (reg.waiting) {\r\n                reg.waiting.postMessage({ type: 'SKIP_WAITING' });\r\n              } else {\r\n                // Fallback: reload directly\r\n                if (!_swReloading) {\r\n                  _swReloading = true;\r\n                  window.location.reload();\r\n                }\r\n              }\r\n            } catch {\r\n              // If dialog fails, do nothing\r\n            }\r\n          }\r\n        });\r\n      });\r\n\r\n      // Check for updates periodically (every 60 minutes)\r\n      setInterval(() => {\r\n        reg.update().catch(() => { /* ignore */ });\r\n      }, 60 * 60 * 1000);\r\n      // Immediate update check\r\n      reg.update().catch(() => { /* ignore */ });\r\n    } catch (err) {\r\n      log.warn('[SW] Registration failed:', err);\r\n    }\r\n  };\r\n\r\n  // Handle case where 'load' already fired (readyState complete)\r\n  if (document.readyState === 'complete') {\r\n    doRegister();\r\n  } else {\r\n    window.addEventListener('load', doRegister, { once: true });\r\n  }\r\n}\r\n","/**\r\n * MUSIXQUARE 2.0  Application Bootstrap\r\n *\r\n * Module initialization order:\r\n * 1. core/    constants, log, events, state, platform, session, blob-manager, timers\r\n * 2. audio/   engine, effects, channel\r\n * 3. network/  peer, protocol, sync, relay\r\n * 4. storage/  opfs, transfer, preload, recovery\r\n * 5. player/  playback, playlist, video, media-session\r\n * 6. youtube/  player, sync, search\r\n * 7. ui/      dom, toast, dialog, tabs, i18n, visualizer, chat, playlist-view,\r\n *              player-controls, settings, setup\r\n * 8. sw-register\r\n */\r\n\r\n//  Core \r\nimport { log } from './core/log.ts';\r\nimport { bus } from './core/events.ts';\r\nimport { initPlatform } from './core/platform.ts';\r\nimport { INSTANCE_ID } from './core/session.ts';\r\nimport { getState, snapshot } from './core/state.ts';\r\nimport { APP_STATE } from './core/constants.ts';\r\n\r\n//  Audio \r\nimport { initAudio, isAudioReady } from './audio/engine.ts';\r\nimport { applySettings, initEffectsHandlers } from './audio/effects.ts';\r\nimport { setChannelMode } from './audio/channel.ts';\r\n\r\n//  Network \r\nimport { initProtocol } from './network/protocol.ts';\r\nimport { initPeerHandlers, leaveSession } from './network/peer.ts';\r\nimport { initSync } from './network/sync.ts';\r\nimport { initRelay } from './network/relay.ts';\r\n\r\n//  Storage \r\nimport { setSyncWorker, setTransferWorker } from './storage/opfs.ts';\r\nimport { initTransfer } from './storage/transfer.ts';\r\nimport { initPreload } from './storage/preload.ts';\r\nimport { initRecovery } from './storage/recovery.ts';\r\n\r\n//  Player \r\nimport { initPlayback } from './player/playback.ts';\r\nimport { initPlaylist } from './player/playlist.ts';\r\nimport { initVideo } from './player/video.ts';\r\nimport { initMediaSession } from './player/media-session.ts';\r\n\r\n//  YouTube \r\nimport { initYouTube } from './youtube/player.ts';\r\nimport { initYouTubeSync } from './youtube/sync.ts';\r\n\r\n//  UI \r\nimport { initOverlayOpenObserver } from './ui/dom.ts';\r\nimport { initToast } from './ui/toast.ts';\r\nimport { initDialog } from './ui/dialog.ts';\r\nimport { initTabs } from './ui/tabs.ts';\r\nimport { initI18n } from './ui/i18n.ts';\r\nimport { initVisualizer } from './ui/visualizer.ts';\r\nimport { initChat } from './ui/chat.ts';\r\nimport { initPlaylistView } from './ui/playlist-view.ts';\r\nimport { initPlayerControls } from './ui/player-controls.ts';\r\nimport { initSettings } from './ui/settings.ts';\r\nimport { initSetup } from './ui/setup.ts';\r\n\r\n//  Service Worker \r\nimport { registerServiceWorker } from './sw-register.ts';\r\n\r\n//  System Compatibility Check \r\n\r\nfunction checkSystemCompatibility(): void {\r\n  // HTTPS check\r\n  if (!window.isSecureContext) {\r\n    bus.emit('ui:show-toast', 'HTTPS :   .');\r\n    log.warn('[App] Not a secure context');\r\n  }\r\n\r\n  // OPFS support check\r\n  if (!(navigator.storage && navigator.storage.getDirectory)) {\r\n    bus.emit('ui:show-toast', '   (iOS 15.2+, Chrome 86+)');\r\n    log.warn('[App] OPFS not supported');\r\n  }\r\n\r\n  // Vendor library check\r\n  const errors: string[] = [];\r\n\r\n  if (typeof (window as unknown as Record<string, unknown>).Tone === 'undefined') {\r\n    errors.push('Tone.js ( )');\r\n  }\r\n  if (typeof (window as unknown as Record<string, unknown>).Peer === 'undefined') {\r\n    errors.push('PeerJS (P2P )');\r\n  }\r\n\r\n  if (errors.length > 0) {\r\n    log.error('[App] Missing dependencies:', errors.join(', '));\r\n    bus.emit('ui:show-toast', `   : ${errors.join(', ')}.   .`);\r\n  } else {\r\n    log.info('[App] System compatibility check passed');\r\n  }\r\n}\r\n\r\n//  Keyboard Shortcuts \r\n\r\nfunction initKeyboardShortcuts(): void {\r\n  window.addEventListener('keydown', (e: KeyboardEvent) => {\r\n    // If another handler already claimed this key, don't also treat it as a global shortcut\r\n    if (e.defaultPrevented) return;\r\n\r\n    // Don't intercept when focused on text input elements\r\n    const activeTag = document.activeElement?.tagName;\r\n    if (activeTag && ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeTag)) return;\r\n\r\n    // Don't hijack Space on interactive controls (important for a11y)\r\n    const interactive = (e.target as Element)?.closest?.(\r\n      'button, a, [role=\"button\"], input, textarea, select, [contenteditable=\"true\"]'\r\n    );\r\n    if ((e.key === ' ' || e.code === 'Space') && interactive) return;\r\n\r\n    const currentState = getState<string>('appState');\r\n    const isPlaying = currentState === APP_STATE.PLAYING_AUDIO ||\r\n                      currentState === APP_STATE.PLAYING_VIDEO ||\r\n                      currentState === APP_STATE.PLAYING_YOUTUBE;\r\n\r\n    if (e.key === ' ' || e.code === 'Space') {\r\n      e.preventDefault();\r\n      bus.emit('player:toggle-play');\r\n    } else if (e.key === 'p' || e.key === 'P') {\r\n      if (!isPlaying) bus.emit('player:toggle-play');\r\n    } else if (e.key === 's' || e.key === 'S') {\r\n      if (isPlaying) bus.emit('player:toggle-play');\r\n    }\r\n  });\r\n\r\n  log.info('[App] Keyboard shortcuts registered');\r\n}\r\n\r\n//  Wake Lock (Screen) \r\n\r\nlet _wakeLock: WakeLockSentinel | null = null;\r\n\r\nasync function requestWakeLock(): Promise<void> {\r\n  try {\r\n    if ('wakeLock' in navigator) {\r\n      _wakeLock = await navigator.wakeLock.request('screen');\r\n      log.debug('[App] Screen Wake Lock active');\r\n      _wakeLock.addEventListener('release', () => {\r\n        log.debug('[App] Screen Wake Lock released');\r\n        _wakeLock = null;\r\n      });\r\n    }\r\n  } catch (err: unknown) {\r\n    log.warn(`[App] Wake Lock failed: ${(err as Error).name}, ${(err as Error).message}`);\r\n  }\r\n}\r\n\r\nfunction initWakeLock(): void {\r\n  // Request wake lock initially\r\n  requestWakeLock();\r\n\r\n  // Re-request wake lock when app becomes visible (e.g. after tab switch)\r\n  document.addEventListener('visibilitychange', () => {\r\n    if (_wakeLock === null && document.visibilityState === 'visible') {\r\n      requestWakeLock();\r\n    }\r\n  });\r\n\r\n  log.info('[App] Wake Lock initialized');\r\n}\r\n\r\n//  Global Error Handlers \r\n\r\nwindow.onerror = (msg, src, line, col, err) => {\r\n  log.error(`[Global] ${msg} at ${src}:${line}:${col}`, err);\r\n  return false;\r\n};\r\nwindow.addEventListener('unhandledrejection', (e) => {\r\n  log.error('[Global] Unhandled rejection:', e.reason);\r\n});\r\n\r\n//  Beforeunload Cleanup \r\n\r\nfunction initBeforeUnload(): void {\r\n  window.addEventListener('beforeunload', () => {\r\n    try { leaveSession(); } catch { /* noop */ }\r\n  });\r\n}\r\n\r\n//  Bootstrap \r\n\r\nfunction bootstrap(): void {\r\n  log.info(`[App] MUSIXQUARE 2.0 bootstrap (instance: ${INSTANCE_ID})`);\r\n\r\n  // 1. Platform detection & viewport height\r\n  initPlatform();\r\n\r\n  // 2. Core UI init (must run before other UI modules)\r\n  try { initOverlayOpenObserver(); } catch { /* ignore */ }\r\n  initToast();\r\n  initDialog();\r\n  initTabs();\r\n  initI18n();\r\n\r\n  // 3. Player & Media\r\n  initPlayback();\r\n  initPlaylist();\r\n  initVideo();\r\n  initMediaSession();\r\n\r\n  // 4. Audio engine (deferred init  actual Tone.js init on user interaction)\r\n  // Engine, effects, channel register bus listeners at import time\r\n  initEffectsHandlers();\r\n\r\n  // 5. Network (registers bus listeners; PeerJS init deferred to host/guest flow)\r\n  // initNetwork() is called from setup.ts via createHostSessionWithShortCode() or joinSession()\r\n  initProtocol();\r\n  initPeerHandlers();\r\n  initSync();\r\n  initRelay();\r\n\r\n  // 6. Workers & Storage\r\n  try {\r\n    const syncW = new Worker(\r\n      new URL('./workers/sync.worker.ts', import.meta.url),\r\n      { type: 'module' },\r\n    );\r\n    setSyncWorker(syncW);\r\n    syncW.postMessage({ command: 'INIT_INSTANCE', instanceId: INSTANCE_ID });\r\n    log.info('[App] SyncWorker started');\r\n  } catch (e) {\r\n    log.warn('[App] SyncWorker failed:', e);\r\n  }\r\n\r\n  try {\r\n    const transferW = new Worker(\r\n      new URL('./workers/transfer.worker.ts', import.meta.url),\r\n      { type: 'module' },\r\n    );\r\n    setTransferWorker(transferW);\r\n    transferW.postMessage({ command: 'INIT_INSTANCE', instanceId: INSTANCE_ID });\r\n    log.info('[App] TransferWorker started');\r\n  } catch (e) {\r\n    log.warn('[App] TransferWorker failed:', e);\r\n  }\r\n\r\n  initTransfer();\r\n  initPreload();\r\n  initRecovery();\r\n\r\n  // 7. YouTube\r\n  initYouTube();\r\n  initYouTubeSync();\r\n\r\n  // 8. UI modules (binds DOM events)\r\n  initVisualizer();\r\n  initChat();\r\n  initPlaylistView();\r\n  initPlayerControls();\r\n  initSettings();\r\n  initSetup();\r\n\r\n  // 9. Service Worker\r\n  registerServiceWorker();\r\n\r\n  // 10. Keyboard shortcuts, Wake Lock & Cleanup\r\n  initKeyboardShortcuts();\r\n  initWakeLock();\r\n  initBeforeUnload();\r\n\r\n  // 11. System compatibility check (deferred to not block bootstrap)\r\n  setTimeout(checkSystemCompatibility, 100);\r\n\r\n  // 12. Expose debug helpers on window\r\n  const debugObj = {\r\n    state: snapshot,\r\n    bus,\r\n    initAudio,\r\n    isAudioReady,\r\n    applySettings,\r\n    setChannelMode,\r\n  };\r\n  (window as unknown as Record<string, unknown>).__MXQR = debugObj;\r\n\r\n  log.info('[App] Bootstrap complete  all modules loaded');\r\n}\r\n\r\n// Run bootstrap\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', bootstrap, { once: true });\r\n} else {\r\n  bootstrap();\r\n}\r\n"],"file":"assets/index-DoNP66sO.js"}