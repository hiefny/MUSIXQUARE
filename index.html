<!DOCTYPE html>
<html lang="ko" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MUSIXQUARE</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

    <header>
        <div class="app-logo">MUSI<span class="logo-fade">XQUARE</span></div>
    </header>

    <div class="header-right">
        <button class="help-btn" onclick="openHelpModal()">
            <svg viewBox="0 0 24 24">
                <path
                    d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 6c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" />
            </svg>
        </button>
        <div class="role-badge" id="role-badge">
            <div class="role-dot"></div>
            <span id="role-text">OFFLINE</span>
        </div>
    </div>

    <div id="tab-play" class="tab-content active">
        <div class="vinyl-wrapper">
            <canvas id="visualizerCanvas" width="240" height="240"></canvas>
            <!-- Localized Loader Overlay (visualizer only) -->
            <div class="vinyl-loader" id="loader">
                <div class="progress-ring-container">
                    <svg class="progress-ring" width="60" height="60">
                        <circle class="progress-ring__circle-bg" stroke="rgba(255,255,255,0.1)" stroke-width="4"
                            fill="transparent" r="26" cx="30" cy="30" />
                        <circle class="progress-ring__circle" id="loader-ring" stroke="var(--primary)" stroke-width="4"
                            fill="transparent" r="26" cx="30" cy="30" />
                    </svg>
                </div>
                <div id="loader-text" class="vinyl-loader-text">Loading...</div>
            </div>
        </div>

        <div class="video-wrapper">
            <video id="main-video" class="video-screen" playsinline webkit-playsinline></video>
            <button class="fullscreen-btn" onclick="toggleFullscreen()">
                <svg viewBox="0 0 24 24">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                </svg>
            </button>
        </div>

        <div class="track-box">
            <div class="track-title-wrapper">
                <div class="track-title" id="track-title">No Music</div>
            </div>
            <div class="track-artist" id="track-artist">Select a file or check Playlist</div>
        </div>

        <div class="controls-area">
            <div class="progress-bar">
                <input type="range" id="seek-slider" min="0" max="100" value="0" step="0.1">
                <div class="time-info">
                    <span id="time-curr">0:00</span>
                    <span id="time-dur">0:00</span>
                </div>
            </div>

            <div class="play-controls-left">
                <button class="ctrl-btn" onclick="playPrevTrack()">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                    </svg>
                </button>
                <button class="play-fab" id="play-btn" onclick="togglePlay()" disabled>
                    <svg id="icon-play" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    <svg id="icon-pause" viewBox="0 0 24 24" style="display:none">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                    </svg>
                </button>
                <button class="ctrl-btn" onclick="playNextTrack()">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg>
                </button>

                <div class="vol-group-playback">
                    <svg id="vol-icon-btn" viewBox="0 0 24 24" onclick="toggleMute()" style="cursor: pointer">
                        <path
                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                    </svg>
                    <input type="range" id="volume-slider" min="0" max="100" value="100"
                        oninput="onVolInput(this.value)" onchange="onVolChange(this.value)">
                </div>
            </div>

            <!-- Chat Preview Button -->
            <div class="chat-preview-btn" id="chat-preview-btn" onclick="toggleChatDrawer()">
                <div class="chat-preview-left">
                    <svg viewBox="0 0 24 24" class="chat-preview-icon">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                    </svg>
                    <span class="chat-preview-text" id="chat-preview-text">채팅을 시작하세요</span>
                </div>
                <span class="chat-preview-badge" id="chat-preview-badge"></span>
            </div>

            <!-- Buttons Row: SYNC (left) + Media (right) -->
            <div style="display:flex; gap:8px;">
                <button class="file-select-btn file-select-btn-large" id="btn-sync" onclick="handleManualSync()"
                    style="flex:1;">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" />
                    </svg>
                    <span>SYNC</span>
                </button>
                <button class="file-select-btn file-select-btn-large" onclick="openMediaSourcePopup()" style="flex:1;">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM9 8l7 4-7 4V8z" />
                    </svg>
                    <span>미디어 재생</span>
                </button>
            </div>

            <input type="file" id="file-input" multiple
                accept=".mp3, .wav, .ogg, .m4a, .mp4, .webm, .mkv, audio/*, video/*" style="display:none">
        </div>
    </div>

    <div id="tab-playlist" class="tab-content">
        <div class="tab-header">
            <span class="tab-title">Playlist</span>
            <div class="playlist-title-area">
                <button class="tab-action-btn" id="btn-repeat" onclick="toggleRepeat()">
                    <svg viewBox="0 0 24 24">
                        <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" />
                    </svg>
                </button>
                <button class="tab-action-btn" id="btn-shuffle" onclick="toggleShuffle()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" />
                    </svg>
                </button>
                <button class="tab-action-btn" onclick="openMediaSourcePopup()">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                </button>
            </div>
        </div>
        <ul class="playlist-ul" id="playlist-ui">
            <li style="color:var(--text-sub); font-size:14px; text-align:center; padding:40px 0;">Add music files to
                start.</li>
        </ul>
    </div>

    <div id="tab-connect" class="tab-content">
        <div class="tab-header">
            <span class="tab-title">Connect</span>
        </div>

        <div id="host-panel" class="qr-card">
            <div style="font-size:14px; margin-bottom:16px; font-weight: 600;">Scan to join Session</div>
            <div id="qrcode"></div>
            <div class="id-display" id="my-id"
                style="font-family:monospace; margin-top:16px; font-weight:600; font-size:16px; background:var(--surface-2); color:var(--text-main); padding:8px 16px; border-radius:8px;">
                ID 생성 중...</div>
            <button class="file-select-btn" style="width:100%; margin-top:20px; justify-content:center;"
                onclick="copyLink()">
                <span style="font-size:14px; font-weight:600;">링크 복사하기</span>
            </button>
            <button id="btn-leave-session" class="file-select-btn"
                style="width:100%; margin-top:8px; justify-content:center; background:rgba(255, 85, 85, 0.15); display:none;"
                onclick="leaveSession()">
                <span style="font-size:14px; font-weight:600; color:#ff5555;">이 모임 나가기</span>
            </button>
        </div>

        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Host ID Input</span>
            </div>
            <div style="padding: 10px 20px 20px;">
                <div class="input-group" style="margin:0; display:flex; gap:8px;">
                    <input type="text" class="input-box" id="join-id-input" placeholder="Host ID" style="flex:1;">
                    <button class="btn-action" onclick="joinSession()">Join</button>
                </div>
            </div>
        </div>
        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Connected Devices</span>
            </div>
            <div id="device-list">
                <div class="section-row" style="justify-content:center; color:var(--text-muted);">
                    Waiting for connection...
                </div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="tab-header">
            <span class="tab-title">Settings</span>
        </div>

        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Theme</span>
            </div>
            <div class="theme-selector">
                <div class="theme-opt" onclick="setTheme('light')" id="theme-light">Light</div>
                <div class="theme-opt" onclick="setTheme('dark')" id="theme-dark">Dark</div>
                <div class="theme-opt" onclick="setTheme('system')" id="theme-system">System</div>
            </div>
        </div>

        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Channel Mode & Subwoofer (Local)</span>

                <!-- 7.1 Mode Toggle (In Header) -->
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:11px; font-weight:700; color:var(--text-sub);">7.1 MODE</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="chk-surround" onchange="toggleSurroundMode(this.checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- Standard Channel Grid (Stereo/L/R/Woofer) -->
            <div class="channel-grid" id="grid-standard" style="padding: 10px 20px 20px;">
                <div class="ch-opt" onclick="setChannel(-1, this)">
                    <svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                    </svg>Left (L)
                </div>
                <div class="ch-opt" onclick="setChannel(1, this)">
                    <svg viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                    </svg>Right (R)
                </div>
                <div class="ch-opt active" onclick="setChannel(0, this)">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z" />
                    </svg>Stereo
                </div>
                <div class="ch-opt" onclick="setChannel(2, this)">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>Woofer (Mix)
                </div>
            </div>

            <!-- Surround Grid (7.1) -->
            <div class="channel-grid surround-grid" id="grid-surround"
                style="padding: 10px 20px 20px; display:none; grid-template-columns: repeat(3, 1fr);">
                <!-- Front Row -->
                <div class="ch-opt" onclick="setSurroundChannel(0, this)">FL</div>
                <div class="ch-opt" onclick="setSurroundChannel(2, this)">Center</div>
                <div class="ch-opt" onclick="setSurroundChannel(1, this)">FR</div>

                <!-- Side Row -->
                <div class="ch-opt" onclick="setSurroundChannel(4, this)">Side L</div>
                <div class="ch-opt" onclick="setSurroundChannel(3, this)">LFE</div>
                <div class="ch-opt" onclick="setSurroundChannel(5, this)">Side R</div>

                <!-- Back Row -->
                <div class="ch-opt" onclick="setSurroundChannel(6, this)">Rear L</div>
                <div class="ch-opt" style="visibility:hidden;"></div>
                <div class="ch-opt" onclick="setSurroundChannel(7, this)">Rear R</div>
            </div>

            <div class="slider-wrap" id="woofer-cutoff-control">
                <div class="slider-header">
                    <span>Subwoofer Cutoff (Local)</span>
                    <span class="val-disp" id="val-cutoff">120 Hz</span>
                </div>
                <input type="range" min="60" max="200" value="120" oninput="updateSettings('cutoff', this.value)"
                    ondblclick="updateSettings('cutoff', 120); this.value=120;">
            </div>
        </div>

        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Reverb (Host Synced)</span>
                <button class="btn-action" style="padding:4px 12px; height:28px; font-size:11px;"
                    onclick="resetReverb()">Reset</button>
            </div>
            <div class="slider-wrap">
                <div class="slider-header">
                    <span>Mix <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            0%, 올리면 공간감 증가</span></span>
                    <span class="val-disp" id="val-reverb">0%</span>
                </div>
                <input type="range" id="reverb-slider" min="0" max="100" value="0"
                    oninput="updateAudioEffect('reverb', 'mix', this.value, true)"
                    onchange="updateAudioEffect('reverb', 'mix', this.value)"
                    ondblclick="updateAudioEffect('reverb', 'mix', 0)">
            </div>

            <!-- Decay Slider -->
            <div class="slider-wrap" style="padding-top:0;">
                <div class="slider-header">
                    <span>Decay Time <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            5.0s, 공간의 크기</span></span>
                    <span class="val-disp" id="val-rvb-decay">5.0s</span>
                </div>
                <input type="range" id="reverb-decay-slider" min="0.1" max="10.0" step="0.1" value="5.0"
                    oninput="updateAudioEffect('reverb', 'decay', this.value, true)"
                    onchange="updateAudioEffect('reverb', 'decay', this.value)"
                    ondblclick="updateAudioEffect('reverb', 'decay', 5.0)">
            </div>

            <!-- Pre-Delay Slider -->
            <div class="slider-wrap" style="padding-top:0;">
                <div class="slider-header">
                    <span>Bounce (Pre-Delay) <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            0.1s, 벽면 반사 지연</span></span>
                    <span class="val-disp" id="val-rvb-predelay">0.1s</span>
                </div>
                <input type="range" id="reverb-predelay-slider" min="0" max="0.5" step="0.01" value="0.1"
                    oninput="updateAudioEffect('reverb', 'predelay', this.value, true)"
                    onchange="updateAudioEffect('reverb', 'predelay', this.value)"
                    ondblclick="updateAudioEffect('reverb', 'predelay', 0.1)">
            </div>

            <!-- Low Cut Slider (New) -->
            <div class="slider-wrap" style="padding-top:0;">
                <div class="slider-header">
                    <span>Low Cut <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            20Hz, 올리면 저음 컷(깔끔함)</span></span>
                    <span class="val-disp" id="val-rvb-lowcut">20Hz</span>
                </div>
                <input type="range" id="reverb-lowcut-slider" min="0" max="100" step="1" value="0"
                    oninput="updateAudioEffect('reverb', 'lowcut', this.value, true)"
                    onchange="updateAudioEffect('reverb', 'lowcut', this.value)"
                    ondblclick="updateAudioEffect('reverb', 'lowcut', 0)">
            </div>

            <!-- High Cut Slider (New) -->
            <div class="slider-wrap" style="padding-top:0; padding-bottom:20px;">
                <div class="slider-header">
                    <span>High Cut <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            20.0k, 올리면 고음 컷(부드러움)</span></span>
                    <span class="val-disp" id="val-rvb-highcut">20.0k</span>
                </div>
                <input type="range" id="reverb-highcut-slider" min="0" max="100" step="1" value="0"
                    oninput="updateAudioEffect('reverb', 'highcut', this.value, true)"
                    onchange="updateAudioEffect('reverb', 'highcut', this.value)"
                    ondblclick="updateAudioEffect('reverb', 'highcut', 0)">
            </div>
        </div>

        <!-- Graphic EQ Zone -->
        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Graphic EQ (Host Synced)</span>
                <button class="btn-action" style="padding:4px 12px; height:28px; font-size:11px;"
                    onclick="resetEQ()">Reset</button>
            </div>

            <!-- Preamp (Inlined) -->
            <div class="slider-wrap" style="padding: 10px 20px 0; border-bottom: none;">
                <div class="slider-header">
                    <span style="font-size:11px; font-weight:700; color:var(--text-sub);">PREAMP</span>
                    <span class="val-disp" id="val-preamp" style="font-size:11px;">0dB</span>
                </div>
                <input type="range" id="preamp-slider" min="-12" max="12" value="0"
                    oninput="setPreamp(this.value, true)" onchange="setPreamp(this.value)" ondblclick="setPreamp(0)">
            </div>
            <div class="eq-container">
                <div class="eq-band">
                    <span class="eq-val" id="eq-val-0">0</span>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0"
                        oninput="setEQ(0, this.value, true)" onchange="setEQ(0, this.value)" ondblclick="setEQ(0, 0)">
                    <span class="eq-label">60</span>
                </div>
                <div class="eq-band">
                    <span class="eq-val" id="eq-val-1">0</span>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0"
                        oninput="setEQ(1, this.value, true)" onchange="setEQ(1, this.value)" ondblclick="setEQ(1, 0)">
                    <span class="eq-label">230</span>
                </div>
                <div class="eq-band">
                    <span class="eq-val" id="eq-val-2">0</span>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0"
                        oninput="setEQ(2, this.value, true)" onchange="setEQ(2, this.value)" ondblclick="setEQ(2, 0)">
                    <span class="eq-label">910</span>
                </div>
                <div class="eq-band">
                    <span class="eq-val" id="eq-val-3">0</span>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0"
                        oninput="setEQ(3, this.value, true)" onchange="setEQ(3, this.value)" ondblclick="setEQ(3, 0)">
                    <span class="eq-label">3.6k</span>
                </div>
                <div class="eq-band">
                    <span class="eq-val" id="eq-val-4">0</span>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0"
                        oninput="setEQ(4, this.value, true)" onchange="setEQ(4, this.value)" ondblclick="setEQ(4, 0)">
                    <span class="eq-label">14k</span>
                </div>
            </div>
        </div>

        <!-- Virtual Ste.. Surround Zone -->
        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Virtual Surround (Host Synced)</span>
            </div>
            <div class="slider-wrap">
                <div class="slider-header">
                    <span>Width <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값
                            100, 줄이면 모노, 늘리면 서라운드</span></span>
                    <span class="val-disp" id="val-width">100%</span>
                </div>
                <input type="range" id="width-slider" min="0" max="200" value="100"
                    oninput="updateAudioEffect('stereo', 'mix', this.value, true)"
                    onchange="updateAudioEffect('stereo', 'mix', this.value)" ondblclick="resetStereo()">
            </div>
        </div>

        <div class="section-group">
            <div class="section-header-row">
                <span class="section-title">Virtual Bass (Host Synced)</span>
            </div>
            <div class="slider-wrap">
                <div class="slider-header">
                    <span>Level <span
                            style="font-size:10px; color:var(--text-sub); font-weight:normal; margin-left:4px;">* 기본값 0,
                            늘리면 가상 베이스(왜곡 증가)</span></span>
                    <span class="val-disp" id="val-vbass">0%</span>
                </div>
                <input type="range" id="vbass-slider" min="0" max="100" value="0"
                    oninput="updateAudioEffect('vbass', 'mix', this.value, true)"
                    onchange="updateAudioEffect('vbass', 'mix', this.value)"
                    ondblclick="updateAudioEffect('vbass', 'mix', 0)">
            </div>
        </div>
    </div>


    <!-- Slide-up Chat Drawer -->
    <div class="chat-drawer" id="chat-drawer">
        <div class="chat-drawer-header">
            <span class="chat-drawer-title">Chat</span>
            <button class="chat-drawer-close" onclick="toggleChatDrawer()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
        </div>
        <div class="chat-drawer-messages" id="chat-messages">
            <div class="chat-empty">메시지가 없습니다.<br>첫 메시지를 보내보세요!</div>
        </div>
        <div class="chat-drawer-input">
            <input type="text" class="chat-input" id="chat-input" placeholder="메시지 입력..." maxlength="200">
            <button class="chat-send-btn" onclick="sendChatMessage()">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('play')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z" />
            </svg>
            <span>Play</span>
        </button>
        <button class="nav-item" onclick="switchTab('playlist')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z" />
            </svg>
            <span>Playlist</span>
        </button>
        <button class="nav-item" onclick="switchTab('connect')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z" />
            </svg>
            <span>Connect</span>
        </button>
        <button class="nav-item" onclick="switchTab('settings')">
            <svg viewBox="0 0 24 24">
                <path
                    d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z" />
            </svg>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Help Modal -->
    <div class="help-modal-overlay" id="help-modal" onclick="closeHelpModal(event)">
        <div class="help-modal">
            <div class="help-modal-header">
                <span class="help-modal-title">Help</span>
                <button class="help-modal-close" onclick="closeHelpModal()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                    </svg>
                </button>
            </div>
            <div class="help-modal-content">
                <div class="help-block">
                    <div class="help-title">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                        </svg>
                        What is MUSIXQUARE?
                    </div>
                    <div class="help-desc">
                        MUSIXQUARE는 여러 스마트폰을 연결하여 하나의 거대한 서라운드 오디오 시스템을 구축하는 웹 앱입니다.
                        별도의 앱 설치 없이 브라우저만으로 모든 기기를 동기화하여 음악을 재생합니다.
                    </div>
                </div>

                <div class="help-block">
                    <div class="help-title">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg>
                        Host & Guest
                    </div>
                    <div class="help-desc">
                        <strong>Host (방장):</strong> 음악/영상 파일을 소유하고 있는 기기입니다. 세션을 생성하고 재생을 제어합니다.
                        <ul class="help-list">
                            <li>로컬 파일(오디오 및 비디오) 추가 및 재생</li>
                            <li>모든 게스트 기기(스피커)의 동기화 제어</li>
                            <li>QR코드 생성 및 초대</li>
                            <li>비디오 재생 시 전체화면 지원</li>
                        </ul>
                        <br>
                        <strong>Guest (참여자):</strong> 호스트에 연결되어 스피커 역할을 수행하는 기기입니다.
                        <ul class="help-list">
                            <li>QR코드 스캔 또는 ID 입력으로 간편 접속</li>
                            <li>호스트의 재생 상태와 실시간 동기화</li>
                            <li>비디오 재생 시 오디오 정보만 수신하여 재생</li>
                        </ul>
                    </div>
                </div>

                <div class="help-block">
                    <div class="help-title">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" />
                        </svg>
                        Channel & Settings
                    </div>
                    <div class="help-desc">
                        Settings 탭에서 기기의 역할과 음향 효과를 설정할 수 있습니다.
                        <ul class="help-list">
                            <li><strong>Channel Mode:</strong> Stereo(기본), Left(좌), Right(우), Woofer(저음역 전용)</li>
                            <li><strong>Graphic EQ:</strong> 5밴드 이퀄라이저 + Preamp</li>
                            <li><strong>Reverb:</strong> 공간감 효과 (Hall, Room, Church, Plate)</li>
                            <li><strong>Virtual Surround:</strong> 음장감 확장 효과</li>
                            <li><strong>Virtual Bass:</strong> 가상 저음 강화</li>
                        </ul>
                        * 슬라이더를 더블 클릭하면 기본값으로 초기화됩니다.
                    </div>
                </div>
            </div>
            <!-- Footer outside of scrollable content -->
            <div class="help-footer">
                <div class="help-footer-row">
                    <div class="help-footer-item">
                        <div class="help-footer-label">MADE WITH ❤️ BY HIEFNY</div>
                        <a href="https://buymeacoffee.com/hiefny" target="_blank" class="coffee-btn">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="#000">
                                <path
                                    d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.83 2.95 7.18 6.78 7.29 3.96.12 7.22-3.06 7.22-7v-1h.5c1.93 0 3.5-1.57 3.5-3.5S20.43 3 18.5 3zM16 8v2c0 2.21-1.79 4-4 4s-4-1.79-4-4V5h8v3zm2.5 0h-.5V5h.5c.83 0 1.5.67 1.5 1.5S19.33 8 18.5 8zM2 21h20v2H2z" />
                            </svg>
                            Buy me a coffee
                        </a>
                    </div>
                    <div class="help-footer-item">
                        <div class="help-footer-label">프로그램 체험하기</div>
                        <button class="demo-btn" onclick="loadDemoMedia(); if(!window.hostConn) closeHelpModal();">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path
                                    d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z" />
                            </svg>
                            데모 영상 재생하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="silent-trigger" src="dummy_audio.mp3" preload="auto" x-webkit-airplay="allow" playsinline
        webkit-playsinline></audio>
    <div id="onboarding-overlay" class="onboarding-overlay">
        <div class="onboarding-card">
            <button class="ob-arrow ob-arrow-left" onclick="prevSlide()">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                </svg>
            </button>
            <button class="ob-arrow ob-arrow-right" onclick="nextSlide()">
                <svg viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                </svg>
            </button>



            <!-- 1. Slider -->
            <div class="ob-slider-viewport">
                <div class="ob-slider-track" id="ob-track">
                    <!-- Slide 1: Invite -->
                    <div class="ob-slide">
                        <div class="ob-icon-circle">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                            </svg>
                        </div>
                        <div class="ob-title">초대와 공유</div>
                        <div class="ob-desc">여러 기기를 무선으로 연결하여<br>하나의 거대한 오디오 시스템을 만드세요.<br>QR코드나 링크로 친구를 초대할 수 있습니다.
                        </div>
                    </div>
                    <!-- Slide 2: Play -->
                    <div class="ob-slide">
                        <div class="ob-icon-circle">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z" />
                            </svg>
                        </div>
                        <div class="ob-title">동기화 재생</div>
                        <div class="ob-desc">호스트가 음악이나 영상을 재생하면<br>연결된 모든 스피커에서 동시에 재생됩니다.<br>0.01초 단위의 정밀한 싱크 조절이
                            가능합니다.</div>
                    </div>
                    <!-- Slide 3: Sound -->
                    <div class="ob-slide">
                        <div class="ob-icon-circle">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        </div>
                        <div class="ob-title">입체 음향</div>
                        <div class="ob-desc">각 기기의 역할을 설정해보세요.<br>왼쪽, 오른쪽 채널 분리는 물론<br>우퍼 모드로 웅장한 저음을 즐길 수 있습니다.</div>
                    </div>
                </div>
            </div>

            <!-- 2. Dots -->
            <div class="ob-dots" id="ob-dots">
                <div class="ob-dot active" onclick="goToSlide(0)"></div>
                <div class="ob-dot" onclick="goToSlide(1)"></div>
                <div class="ob-dot" onclick="goToSlide(2)"></div>
            </div>

            <!-- 3. Actions (Dynamic Content) -->
            <div class="ob-actions" id="ob-actions">
                <!-- Javascript will populate this area -->
            </div>
        </div>
    </div>

    <div id="manual-sync-overlay" class="manual-sync-overlay">
        <div class="sync-glass-panel">
            <div class="sync-header">
                <span class="sync-label">TOTAL OFFSET</span>
                <div class="sync-value-wrapper">
                    <span id="manual-sync-value" class="sync-main-val">0</span>
                    <span class="sync-unit">ms</span>
                </div>
                <div id="sync-details" class="sync-details-text"
                    style="font-size:12px; color:var(--text-sub); margin-top:-4px; margin-bottom:12px;">
                    <span style="opacity:0.7">Auto: 0ms</span> <span style="opacity:0.4">|</span> <span
                        style="opacity:0.7">Manual: 0ms</span>
                </div>
            </div>

            <!-- Main Control Row -->
            <div class="sync-control-row">
                <!-- Delay Group -->
                <div class="sync-group-side">
                    <button class="btn-nudge large" onclick="nudgeSync(-10)">
                        <svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                        <span>-10</span>
                    </button>
                    <button class="btn-nudge small" onclick="nudgeSync(-1)">
                        <svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                        </svg>
                        <span>-1</span>
                    </button>
                </div>

                <div class="sync-divider"></div>

                <!-- Rush Group -->
                <div class="sync-group-side">
                    <button class="btn-nudge small" onclick="nudgeSync(1)">
                        <svg viewBox="0 0 24 24">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                        </svg>
                        <span>+1</span>
                    </button>
                    <button class="btn-nudge large" onclick="nudgeSync(10)">
                        <svg viewBox="0 0 24 24">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                        </svg>
                        <span>+10</span>
                    </button>
                </div>
            </div>

            <div class="sync-actions-row">
                <button class="sync-popup-reset-btn" onclick="handleAutoSync()">
                    AUTO
                </button>
                <button class="sync-done-btn" onclick="closeManualSync()">
                    DONE
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toast-msg">메시지</span></div>

    <!-- Media Source Popup -->
    <div id="media-source-overlay" class="manual-sync-overlay">
        <div class="sync-glass-panel">
            <div class="sync-header">
                <span class="sync-label">MEDIA SOURCE</span>
            </div>

            <div class="sync-control-row" style="flex-direction: column; height: auto; gap: 12px; padding: 12px;">
                <button class="file-select-btn file-select-btn-large"
                    onclick="closeMediaSourcePopup(); openFileSelector();"
                    style="width: 100%; height: 56px; justify-content: center;">
                    <svg viewBox="0 0 24 24">
                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                    </svg>
                    <span>로컬 파일</span>
                </button>
                <button class="file-select-btn file-select-btn-large"
                    onclick="closeMediaSourcePopup(); openYouTubePopup();"
                    style="width: 100%; height: 56px; justify-content: center; background: #ff0000; color:white;">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z" />
                    </svg>
                    <span>YouTube</span>
                </button>
            </div>

            <div class="sync-actions-row">
                <button class="sync-done-btn" onclick="closeMediaSourcePopup()">닫기</button>
            </div>
        </div>
    </div>

    <!-- YouTube URL Popup -->
    <div id="youtube-url-overlay" class="manual-sync-overlay">
        <div class="sync-glass-panel">
            <div class="sync-header">
                <span class="sync-label">YOUTUBE URL</span>
            </div>

            <div class="sync-control-row" style="height: auto; padding: 16px;">
                <div style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
                    <input type="text" id="youtube-url-input" placeholder="https://youtube.com/watch?v=..."
                        oninput="fetchYouTubePreview(this.value)"
                        style="width:100%; padding:12px 16px; border-radius:12px; border:1px solid var(--surface-2); 
                        background:var(--surface-1); color:var(--text); font-size:14px; box-sizing:border-box; outline:none;">

                    <!-- Video Preview Container -->
                    <div id="youtube-preview"
                        style="display:none; background:var(--surface-1); border-radius:12px; padding:12px; gap:12px;">
                        <img id="youtube-preview-thumb" src="" alt=""
                            style="width:100%; border-radius:8px; aspect-ratio:16/9; object-fit:cover; background:#000;">
                        <div style="margin-top:8px;">
                            <p id="youtube-preview-title"
                                style="font-size:13px; font-weight:600; color:var(--text); margin:0; line-height:1.3;">
                            </p>
                            <p id="youtube-preview-channel"
                                style="font-size:11px; color:var(--text-sub); margin:4px 0 0 0;"></p>
                        </div>
                    </div>

                    <!-- Loading/Error State -->
                    <p id="youtube-preview-status"
                        style="font-size:11px; color:var(--text-sub); text-align:center; margin:0;">
                        동영상 또는 플레이리스트 링크를 입력하세요
                    </p>
                </div>
            </div>

            <div class="sync-actions-row">
                <button class="sync-popup-reset-btn" onclick="closeYouTubePopup()">취소</button>
                <button id="youtube-play-btn" class="sync-done-btn" onclick="loadYouTubeFromInput()" disabled
                    style="opacity:0.5;">재생</button>
            </div>
        </div>
    </div>


    <script src="js/app.js"></script>
</body>

</html>