(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const He={DEBUG:0,INFO:1,WARN:2,ERROR:3,SILENT:4};let nt=He.INFO;try{const e=globalThis.location?.hostname;(e==="localhost"||e==="127.0.0.1"||e==="0.0.0.0")&&(nt=He.DEBUG)}catch{}const d={debug:(...e)=>{nt<=He.DEBUG&&console.debug(...e)},info:(...e)=>{nt<=He.INFO&&console.info(...e)},warn:(...e)=>{nt<=He.WARN&&console.warn(...e)},error:(...e)=>{nt<=He.ERROR&&console.error(...e)}};class Dr{_listeners=new Map;on(t,n){let o=this._listeners.get(t);return o||(o=new Set,this._listeners.set(t,o)),o.add(n),()=>this.off(t,n)}once(t,n){const o=(...r)=>{this.off(t,o),n(...r)};return this.on(t,o)}off(t,n){const o=this._listeners.get(t);o&&(o.delete(n),o.size===0&&this._listeners.delete(t))}emit(t,...n){const o=this._listeners.get(t);if(o)for(const r of o)try{r(...n)}catch(a){console.error(`[EventBus] Error in handler for "${t}":`,a)}}clear(t){t?this._listeners.delete(t):this._listeners.clear()}debug(){const t={};for(const[n,o]of this._listeners)t[n]=o.size;return t}}const c=new Dr,ct=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Ge=/Android/i.test(navigator.userAgent);function bn(){try{if(navigator.standalone||window.matchMedia?.("(display-mode: standalone)").matches)return!0}catch{}return!1}function Fr(){if(ct)for(const e of["gesturestart","gesturechange","gestureend"])document.addEventListener(e,t=>t.preventDefault(),{passive:!1})}let kt=0,It=0,bo=!1;function Eo(){const e=document.documentElement;if(!bo){try{ct&&e.classList.add("ios"),Ge&&e.classList.add("android"),ct&&bn()&&e.classList.add("ios-standalone"),bn()&&e.classList.add("standalone")}catch{}bo=!0}const t=window.visualViewport,n=bn();let o=!1;try{o=!!window.matchMedia?.("(orientation: landscape)").matches}catch{o=window.innerWidth>window.innerHeight}const r=[];t&&Number.isFinite(t.height)&&t.height>0&&r.push(Math.round(t.height)),Number.isFinite(window.innerHeight)&&window.innerHeight>0&&r.push(Math.round(window.innerHeight)),e&&Number.isFinite(e.clientHeight)&&e.clientHeight>0&&r.push(Math.round(e.clientHeight));let a=r.length>0?Math.min(...r):0,i=0;const l=window.screen||{};if(Ge&&o){if(Number.isFinite(window.outerHeight)&&window.outerHeight>0&&Number.isFinite(window.innerHeight)&&window.innerHeight>0){const f=Math.round(window.outerHeight-window.innerHeight);f<0&&(i=Math.abs(f))}if(i===0&&l.availHeight!=null&&l.availWidth!=null){const f=Math.round((l.height||0)-(l.availHeight||0));f>0&&f<150&&(i=f)}if(i===0){const f=Math.min(l.height||1/0,l.width||1/0);Number.isFinite(f)&&f>100&&Math.abs(a-f)<4&&(i=48)}i>120&&(i=48),i<0&&(i=0),i>0?It=i:It>0&&o&&(i=It),i>0&&a>i&&(a-=i,d.info(`[Viewport] Android landscape softkey compensation: ${i}px`))}else o||(It=0);if(ct&&n&&!o&&window.screen&&Number.isFinite(window.screen.height)&&window.screen.height>0&&(a=Math.max(a,Math.round(window.screen.height))),a>0)try{e.style.setProperty("--app-height",`${a}px`)}catch{}const u=Ge&&o&&i>0?i:0;try{e.style.setProperty("--safe-nav-bottom",`${u}px`)}catch{}}function ie(){if(!kt)try{kt=requestAnimationFrame(()=>{kt=0;try{Eo()}catch{}})}catch{kt=0;try{Eo()}catch{}}}function Mr(){Fr();const e=()=>{ie(),Ge&&(setTimeout(ie,500),setTimeout(ie,1500))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e();try{window.addEventListener("resize",ie,{passive:!0}),window.addEventListener("orientationchange",()=>{ie(),Ge&&setTimeout(ie,500)},{passive:!0}),window.addEventListener("pageshow",ie,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&ie()}),window.visualViewport&&(window.visualViewport.addEventListener("resize",ie,{passive:!0}),window.visualViewport.addEventListener("scroll",ie,{passive:!0}))}catch{}}const Ot=typeof crypto.randomUUID=="function"?crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).slice(2,11);let Yr=Math.floor(Date.now()/1e3)+Math.floor(Math.random()*1e5);function Kt(){return++Yr}const Pt=new Set;function ne(e,t=!1){const n=Number(e),o=Number.isFinite(n)?Math.trunc(n):0;if(!(Number.isSafeInteger(o)&&o>0)){const a=String(e);if(Pt.size>200&&Pt.clear(),Pt.has(a)||(Pt.add(a),d.warn(`[Session] Invalid sessionId (${typeof e}):`,e)),t)throw new Error(`Invalid sessionId: ${e}`);return 0}return o}const b={IDLE:"IDLE",PAUSED:"PAUSED",PLAYING_AUDIO:"PLAYING_AUDIO",PLAYING_VIDEO:"PLAYING_VIDEO",PLAYING_YOUTUBE:"PLAYING_YOUTUBE"},W={IDLE:"IDLE",RECEIVING:"RECEIVING",PROCESSING:"PROCESSING",READY:"READY"},oe=16384,So=12e3,En=3,To=[2e3,5e3,1e4],ue={TICK:10,BACKPRESSURE:50,UI_REFRESH:100,RETRY:200,TRANSITION:300,DEBOUNCE:500,CONNECTION_CHECK:500,BLOB_REVOCATION:1e4,JOIN_TIMEOUT:1e4,RECOVERY_COOLDOWN:5e3},ft=3,$r="Peer",p={ASSIGN_DATA_SOURCE:"assign-data-source",CHAT:"chat",DATA_RELAY:"data-relay",DEVICE_LIST_UPDATE:"device-list-update",EQ_RESET:"eq-reset",EQ_UPDATE:"eq-update",FILE_CHUNK:"file-chunk",FILE_END:"file-end",FILE_PREPARE:"file-prepare",FILE_RESUME:"file-resume",FILE_START:"file-start",FILE_WAIT:"file-wait",FORCE_CLOSE_DUPLICATE:"force-close-duplicate",GET_SYNC_TIME:"get-sync-time",GLOBAL_RESYNC_REQUEST:"global-resync-request",HEARTBEAT:"heartbeat",HEARTBEAT_ACK:"heartbeat-ack",PAUSE:"pause",PING_LATENCY:"ping-latency",PLAY:"play",PLAYLIST:"playlist",PLAYLIST_UPDATE:"playlist-update",PLAY_PRELOADED:"play-preloaded",PONG_LATENCY:"pong-latency",PREAMP:"preamp",PRELOAD_ACK:"preload-ack",PRELOAD_CHUNK:"preload-chunk",PRELOAD_END:"preload-end",PRELOAD_START:"preload-start",REPEAT_MODE:"repeat-mode",REQUEST_CURRENT_FILE:"request-current-file",REQUEST_DATA_RECOVERY:"request-data-recovery",REQUEST_EQ_RESET:"request-eq-reset",REQUEST_REVERB_RESET:"request-reverb-reset",REQUEST_NEXT_TRACK:"request-next-track",REQUEST_PAUSE:"request-pause",REQUEST_PLAY:"request-play",REQUEST_PREV_TRACK:"request-prev-track",REQUEST_SEEK:"request-seek",REQUEST_SETTING:"request-setting",REQUEST_SKIP_TIME:"request-skip-time",REQUEST_TRACK_CHANGE:"request-track-change",REQUEST_YOUTUBE_PAUSE:"request-youtube-pause",REQUEST_YOUTUBE_PLAY:"request-youtube-play",REQUEST_YOUTUBE_PLAYLIST_INFO:"request-youtube-playlist-info",REQUEST_YOUTUBE_SUB_SEEK:"request-youtube-sub-seek",REVERB:"reverb",REVERB_DECAY:"reverb-decay",REVERB_HIGHCUT:"reverb-highcut",REVERB_LOWCUT:"reverb-lowcut",REVERB_PREDELAY:"reverb-predelay",REVERB_TYPE:"reverb-type",SHUFFLE_MODE:"shuffle-mode",STATUS_SYNC:"status-sync",STEREO_WIDTH:"stereo-width",SYNC_RESPONSE:"sync-response",FORCE_SYNC_PLAY:"force-sync-play",OPERATOR_GRANT:"operator-grant",OPERATOR_REVOKE:"operator-revoke",VBASS:"vbass",VOLUME:"volume",WELCOME:"welcome",SESSION_START:"session-start",SESSION_FULL:"session-full",YOUTUBE_PLAY:"youtube-play",YOUTUBE_PLAYLIST_INFO:"youtube-playlist-info",YOUTUBE_STATE:"youtube-state",YOUTUBE_SUB_TITLE_UPDATE:"youtube-sub-title-update",YOUTUBE_STOP:"youtube-stop",YOUTUBE_SYNC:"youtube-sync",SYS_TOAST:"sys-toast"},Hr=[60,230,910,3600,14e3],vo="demo_track.mp3",Vr="Sean Pitaro - Passport (NCS Release)";function qr(){return{appState:b.IDLE,isStateTransitioning:!1,session:{peerId:null,inviteCode:null,hostId:null,started:!1},setup:{sessionStarted:!1},player:{startedAt:0,pausedAt:0,isSeeking:!1,isPlayLocked:!1,activeLoadSessionId:0,currentLoadToken:0,isFirstTrackLoad:!0},transfer:{state:W.IDLE,receivedCount:0,meta:{},localSessionId:0,currentSessionId:0,activeBroadcastSession:null,lastReceivedCountSnapshot:0,skipIncomingFile:!1},preload:{isPreloading:!1,sessionId:0,count:0,meta:null,nextTrackIndex:-1,nextFileBlob:null,skipIncoming:!1,waitingFor:!1,usedForIndex:null,ackSent:new Set,sessionState:new Map,watchdog:null},audio:{masterVolume:1,preMuteVolume:1,channelMode:0,isSurroundMode:!1,surroundChannelIndex:-1,reverbMix:0,reverbDecay:5,reverbPreDelay:.1,reverbLowCut:0,reverbHighCut:0,reverbType:"hall",eqValues:[0,0,0,0,0],stereoWidth:1,virtualBass:0,subFreq:120,userPreampGain:1},sync:{localOffset:0,autoSyncOffset:0,usePingCompensation:!0,lastLatencyMs:0,latencyHistory:[],lastHeartbeatAckAt:0,syncRequestTime:0,resyncTimer:null},network:{myId:null,myDeviceLabel:"HOST",appRole:"idle",sessionCode:"",lastJoinCode:"",hostConn:null,connectedPeers:[],isOperator:!1,isConnecting:!1,isIntentionalDisconnect:!1,lastKnownDeviceList:null,deviceCounter:0,peerLabels:{},peerSlots:[null,null,null,null],peerSlotByPeerId:new Map,activeHostConnByPeerId:new Map},relay:{upstreamDataConn:null,downstreamDataPeers:[],chunkQueue:[],isRelaying:!1},playlist:{items:[],currentTrackIndex:-1,repeatMode:0,isShuffle:!1,isFirstTrackLoad:!0},files:{currentFileBlob:null,currentAudioBuffer:null,currentFileOpfs:{name:null},preloadFileOpfs:{name:null}},youtube:{currentSessionId:0,currentSubIndex:-1,subItemsMap:{},scriptLoading:!1,loadTimeout:null,iosWatchdog:null},recovery:{pending:!1,inProgress:{},lastRequest:{},retryCount:0,pendingFileName:"",pendingFileIndex:void 0,pendingPlayTime:void 0},ui:{animationId:null,uiLoopId:null,isChatDrawerOpen:!1,unreadChatCount:0}}}let Jn=qr();function s(e){const t=e.split(".");let n=Jn;for(const o of t){if(n==null||typeof n!="object")return;n=n[o]}return n}function m(e,t){const n=e.split(".");let o=Jn;for(let l=0;l<n.length-1;l++){const u=n[l];(o[u]==null||typeof o[u]!="object")&&(o[u]={}),o=o[u]}const r=n[n.length-1];if(o[r]===t)return;o[r]=t;let i="";for(const l of n)i=i?`${i}.${l}`:l,c.emit(`state:${i}`,t,e)}function Gr(e){for(const[t,n]of Object.entries(e))m(t,n)}function Wr(){return Jn}let Ue=null,Pe=null,Fe=null,Me=null,G=null,me=null,Nt=null,Ut=null,ot=null,Bt=[],Ye=null,rt=null,Dt=null,Ct=null,Ft=null,Sn=null,Mt=null,Yt=null,$t=null,Dn=null,Ze=null;function Zn(){return G}function Vo(){return Pe}function qo(){return Fe}function Go(){return Me}function eo(){return Ye}function Wo(){return rt}function zr(){return me}function Qr(){return Nt}function jr(){return Ut}function Kr(){return ot}function to(){return Bt}function no(){return Dt}function Xr(){return Ft}function zo(){return Mt}function Jr(){return Yt}function Zr(){return $t}function es(){return Dn}function ts(){return G!==null}function Qo(){return $t||($t=new Tone.Split(8),Dn=new Tone.Gain(1)),{splitter:$t,gain:Dn}}async function Oe(){if(G){if(typeof Tone<"u"&&Tone?.context?.state!=="running")try{await Tone.start()}catch{}return}if(Ze)return Ze;Ze=ns();try{await Ze}finally{Ze=null}}async function ns(){if(typeof Tone>"u"||!Tone?.context)throw new Error("Tone.js not loaded");if(Tone.context.state!=="running"&&await Tone.start(),G)return;Ue=new Tone.Split,Pe=new Tone.Merge,Fe=new Tone.Gain(1),Me=new Tone.Gain(1),Ue.connect(Fe,0),Ue.connect(Me,1),Fe.connect(Pe,0,0),Me.connect(Pe,0,1),G=new Tone.Gain(1),Bt=Hr.map(t=>new Tone.Filter({type:"peaking",frequency:t,Q:1,gain:0})),Ye=new Tone.Gain(1),rt=new Tone.StereoWidener(1),me=new Tone.Reverb({decay:5,preDelay:.1}),me.wet.value=1;try{await me.generate()}catch(t){throw[Ue,Pe,Fe,Me,G,Ye,rt,me].forEach(n=>{try{n&&n.dispose()}catch{}}),Ue=Pe=Fe=Me=G=Ye=rt=null,me=null,Bt=[],t}Nt=new Tone.Filter(20,"highpass",-12),Ut=new Tone.Filter(2e4,"lowpass",-12),ot=new Tone.CrossFade(0),Ft=new Tone.Filter(120,"lowpass",-12),Sn=new Tone.Chebyshev(50),Mt=new Tone.Filter(2e4,"lowpass",-12),Yt=new Tone.Gain(0),rt.connect(Ye),Ye.connect(Ue),Dt=new Tone.Filter(2e4,"lowpass"),Pe.connect(Dt);let e=Dt;for(const t of Bt)e.connect(t),e=t;e.connect(ot.a),e.connect(me),me.connect(Nt),Nt.connect(Ut),Ut.connect(ot.b),ot.connect(G),e.connect(Ft),Ft.connect(Sn),Sn.connect(Mt),Mt.connect(Yt),Yt.connect(G),Ct=new Tone.Analyser("fft",2048),Ct.smoothing=.3,G.connect(Ct),G.toDestination(),m("audio.analyser",Ct);try{const t=document.getElementById("silent-trigger");t&&t.play().catch(o=>d.debug("[Audio] Silent Audio play failed",o));const n=document.getElementById("main-video");n&&n.play().then(()=>n.pause()).catch(o=>d.debug("[Audio] Video unlock failed",o))}catch(t){d.debug("[Audio] iOS unlock attempt failed:",t)}d.info("[Audio] Tone.js graph initialized"),c.emit("audio:ready")}c.on("audio:set-volume",((...e)=>{const t=Number(e[0]);if(!Number.isFinite(t))return;const n=Math.max(0,Math.min(1,t));m("audio.masterVolume",n),G&&G.gain.rampTo(n,.1),c.emit("audio:volume-changed",n),c.emit("youtube:set-volume",Math.round(n*100)),c.emit("player:sync-video-volume",n)}));c.on("audio:apply-youtube-volume",(()=>{const e=s("audio.masterVolume")??1;c.emit("youtube:set-volume",Math.round(e*100))}));c.on("audio:connect-surround",((...e)=>{const t=e[0],n=e[1];if(!t)return;const{splitter:o,gain:r}=Qo(),a=eo();if(a){try{r.disconnect()}catch{}r.connect(a),t.connect(o);try{o.disconnect()}catch{}n===6?(o.connect(r,6,0),o.connect(r,4,0)):n===7?(o.connect(r,7,0),o.connect(r,5,0)):n===3?o.connect(r,3,0):o.connect(r,n,0),d.debug(`[Audio] Surround connected: channel ${n}`)}}));c.on("audio:activate",(async()=>{try{await Oe(),d.info("[Audio] Activated via user interaction")}catch(e){d.warn("[Audio] Activation failed:",e)}}));function jo(e,t=[]){if(!e||typeof e!="object")return!1;const n=e;if(!n.type)return!1;for(const o of t)if(n[o]===void 0||n[o]===null)return d.warn(`[Network] Missing required field '${o}' in message:`,n.type),!1;return!0}const os=[p.PLAY,p.PAUSE,p.VOLUME,p.EQ_UPDATE,p.PREAMP,p.EQ_RESET,p.REVERB,p.REVERB_TYPE,p.REVERB_DECAY,p.REVERB_PREDELAY,p.REVERB_LOWCUT,p.REVERB_HIGHCUT,p.STEREO_WIDTH,p.VBASS,p.REPEAT_MODE,p.SHUFFLE_MODE,p.YOUTUBE_PLAY,p.YOUTUBE_SYNC,p.YOUTUBE_STATE,p.YOUTUBE_STOP,p.YOUTUBE_SUB_TITLE_UPDATE,p.SYS_TOAST,p.STATUS_SYNC,p.CHAT,p.PLAYLIST_UPDATE,p.PLAYLIST],Fn=new Map;function rs(e,t){Fn.has(e)&&d.warn(`[Protocol] Overwriting handler for: ${e}`),Fn.set(e,t)}function J(e){for(const[t,n]of Object.entries(e))rs(t,n)}async function ss(e,t){if(!jo(e,[]))return;const n=e,o=n.type,r=Fn.get(o);if(r)try{await r(n,t)}catch(l){d.error(`Error handling ${o}:`,l)}const a=s("network.hostConn");if(!a)return;const i=s("relay.downstreamDataPeers");i.length>0&&os.includes(o)&&i.forEach(l=>{if(l.open&&l!==t)try{l.send(e)}catch{}}),t&&t!==a&&a.open&&o.startsWith("request-")&&(d.debug(`[Relay] Forwarding request downstream->upstream: ${o}`),a.send(e))}function Q(e){if(!e?.peer)return!1;const n=s("network.connectedPeers").find(o=>o.id===e.peer);return!!(n&&n.isOp)}function is(){c.on("network:data",(e,t)=>{ss(e,t).catch(n=>d.error("[Protocol] handleData error:",n))}),d.info("[Protocol] Message router initialized")}const pt={chunkWatchdog:null,prepareWatchdog:null,autoPlayTimer:null,syncDebounce:null,relayWaitTimeout:null,preloadWatchdog:null,heartbeatMonitor:null,youtubeUILoop:null,youtubeSyncLoop:null,obAutoSlideTimer:null,preloadScheduleTimer:null};function X(e,t,n,o){P(e),pt[e]=o?.interval?setInterval(t,n):setTimeout(t,n)}function P(e){const t=pt[e];t!=null&&(clearTimeout(t),clearInterval(t),pt[e]=null)}function as(){for(const e of Object.keys(pt))P(e)}function cs(e){return pt[e]??null}let Xt=null,Jt=null;const ls=["heartbeat","ping","video-sync"],Ko=Ot;function us(e){Xt=e,Xt.onmessage=ms}function ds(e){Jt=e,Jt.onmessage=ys}function N(e,t){if(!e||!e.command)return;const n=e.command;if(n.startsWith("OPFS_")&&n!=="OPFS_RESET"&&n!=="OPFS_CLEANUP"&&(e.filename||d.warn(`[Worker] Missing filename in ${n}`),e.sessionId=ne(e.sessionId??0),(n==="OPFS_START"||n==="OPFS_WRITE"||n==="OPFS_END")&&!e.sessionId)){d.error(`[Worker] Blocked ${n}: invalid sessionId`,e);return}n.startsWith("OPFS_")?Xt?Xt.postMessage(e,[]):d.warn(`[Worker] TransferWorker not ready. Dropping command: ${n}`):Jt?Jt.postMessage(e,[]):d.warn(`[Worker] SyncWorker not ready. Dropping command: ${n}`)}function fs(e,t=!1){const n=String(e||"").replace(/[^a-z0-9._-]/gi,"_");return(t?"preload_":"current_")+n+"_"+Ko}function Xo(e,t){e&&N({command:"OPFS_CLEANUP",filename:e,isPreload:t,instanceId:Ko})}async function Jo(e,t){if(!e||!(navigator.storage&&navigator.storage.getDirectory))return null;try{const n=await navigator.storage.getDirectory(),o=fs(e,t);return await(await n.getFileHandle(o)).getFile()}catch(n){return d.error("[OPFS] readFileFromOpfs failed:",n),null}}function ps(){ls.forEach(e=>{try{N({command:"STOP_TIMER",id:e})}catch{}})}function ms(e){const t=e.data;if(!(!t||!t.type))switch(t.type){case"OPFS_STARTED":d.debug(`[OPFS] Session started: ${t.filename} (SID: ${t.sessionId})`);break;case"OPFS_FILE_READY":d.debug(`[OPFS] File finalized: ${t.filename} (SID: ${t.sessionId})`),c.emit("opfs:file-ready",t.filename,t.sessionId,t.isPreload||!1);break;case"OPFS_READ_COMPLETE":c.emit("opfs:read-complete",t);break;case"OPFS_WRITE_ERROR":d.warn(`[OPFS] Write error for ${t.filename} chunk ${t.chunk}:`,t.error);break;case"OPFS_READ_ERROR":d.error(`[OPFS] Read error for ${t.filename}:`,t.error),c.emit("opfs:read-error",t);break;case"OPFS_ERROR":d.error(`[OPFS] Worker error: ${t.error} (${t.filename})`),c.emit("opfs:error",t.error,t.filename);break;case"SESSION_MISMATCH":{const n=!!t.isPreload;d.warn(`[OPFS] Session Mismatch: ${t.filename} (${n?"preload":"current"})`),n||c.emit("opfs:session-mismatch",t);break}case"OPFS_RESET_COMPLETE":d.debug("[OPFS] Reset complete");break;case"OPFS_CLEANUP_COMPLETE":d.debug(`[OPFS] Cleanup complete: ${t.filename}`);break;default:d.debug(`[OPFS] Unknown worker message: ${t.type}`)}}function ys(e){const t=e.data;t&&(t.type==="TICK"?c.emit("worker:timer-tick",t.id):t.type==="WORKER_ERROR"&&d.warn("[SyncWorker] Error:",t.error))}function Zt(e,t){if(!e)return null;try{if("name"in e&&typeof e.name=="string"&&e.name)return e;const n=t&&String(t).trim()?String(t).trim():"Track";return new File([e],n,{type:e.type||""})}catch{return e}}c.on("worker:sync-command",((...e)=>{const t=e[0];t&&t.command&&N(t)}));let O=null;function hs(){return O}function gs(e){return`${$r} ${e}`}function bs(e,t){const n=s("network.peerSlots"),o=Number(e);if(Number.isInteger(o)&&o>=1&&o<=ft){const r=n[o];if(!r||r===t)return o}for(let r=1;r<=ft;r++)if(!n[r])return r;return null}function Es(e,t){if(!e)return;const n=Number(t);if(!Number.isInteger(n)||n<1||n>ft)return;const o=s("network.peerSlots");o[n]=e,m("network.peerSlots",o),s("network.peerSlotByPeerId").set(e,n)}function wo(e){if(!e)return;const t=s("network.peerSlotByPeerId"),n=t.get(e);if(n){const o=s("network.peerSlots");o[n]===e&&(o[n]=null)}t.delete(e)}async function Zo(e=null){if(typeof Peer>"u")throw d.error("[Network] PeerJS not found on window."),new Error("PEERJS_NOT_LOADED");if(O){try{O.destroy()}catch{}O=null}const t={debug:2,config:{iceServers:[],sdpSemantics:"unified-plan",bundlePolicy:"max-bundle",iceCandidatePoolSize:0}},n=window.__MUSIXQUARE_PEER_SERVER__;n&&typeof n=="object"&&(n.host&&(t.host=n.host),n.port&&(t.port=n.port),n.path&&(t.path=n.path),typeof n.secure=="boolean"&&(t.secure=n.secure),n.key&&(t.key=n.key)),O=new Peer(e||void 0,t),vs();const o=await new Promise((r,a)=>{const i=u=>{O.off("open",i),O.off("error",l),r(u)},l=u=>{O.off("open",i),O.off("error",l),a(u)};O.on("open",i),O.on("error",l)});return m("network.myId",o),d.info("[Network] Peer opened:",o),c.emit("network:peer-ready",o),o}function Ss(){return String(Math.floor(1e5+Math.random()*9e5))}async function Ts(e=12){for(let t=0;t<e;t++){const n=Ss();try{return await Zo(n),n}catch(o){if(o&&typeof o=="object"&&o.type==="id-taken")continue;throw o}}throw new Error("SESSION_CODE_UNAVAILABLE")}function vs(){O&&(O.on("error",e=>{d.error("[PeerJS] Error:",e);const t=s("network.appRole"),n=s("network.hostConn");if(t==="host"&&!n){if(e&&typeof e=="object"&&e.type==="id-taken")return;c.emit("network:error",e)}}),O.on("disconnected",()=>{d.warn("[PeerJS] Disconnected from signaling server")}),O.on("connection",e=>{if(e.metadata?.type===p.DATA_RELAY){c.emit("relay:incoming-connection",e);return}if(s("network.appRole")!=="host"){try{e.close()}catch{}return}ws(e)}))}function ws(e){const t=e.peer,n=s("network.connectedPeers"),o=s("network.activeHostConnByPeerId"),r=o.get(t);if(r&&r!==e){o.set(t,e);try{r.open&&r.send({type:p.FORCE_CLOSE_DUPLICATE})}catch{}try{r.close()}catch{}}const a=n.filter(E=>E.id!==t);if(m("network.connectedPeers",a),a.length>=ft){const E=()=>{try{e.send({type:p.SESSION_FULL,message:"현재 세션은 연결 가능한 기기 수(방장 제외 3대)에 도달했어요."})}catch{}setTimeout(()=>{try{e.close()}catch{}},500)};e.open?E():e.on("open",E);return}const l=s("network.peerSlotByPeerId").get(t)||null,u=bs(l,t);if(!u){try{e.send({type:p.SESSION_FULL,message:"현재 세션은 연결 가능한 기기 수(방장 제외 3대)에 도달했어요."})}catch{}try{e.close()}catch{}return}Es(t,u);const f=gs(u),y=s("network.peerLabels");y[t]=f,o.set(t,e);const h={id:t,slot:u,label:f,role:"guest",status:"connecting",conn:e,isOp:!1,isDataTarget:!0,joinOrder:u,lastHeartbeat:Date.now(),preloadedIndexes:new Set,currentFileId:null},g=s("network.connectedPeers");g.push(h),m("network.connectedPeers",g),e.on("open",()=>{h.status="connected",h.lastHeartbeat=Date.now();try{e.send({type:p.WELCOME,lockChannel:!1,label:f})}catch{}c.emit("ui:show-toast",`${f}가 연결됐어요`),c.emit("network:peer-connected",e),Ht(),c.emit("network:role-badge-update"),d.info(`[Host] ${f} connected (peer: ${t})`)}),e.on("data",E=>{try{c.emit("network:data",E,e)}catch(v){d.error("[Host] Error in handleData",v)}}),e.on("close",()=>{if(d.info(`[Host] Connection closed: ${t}`),o.get(t)!==e)return;o.delete(t),wo(t);const E=s("network.connectedPeers");m("network.connectedPeers",E.filter(k=>k.id!==t)),c.emit("network:peer-disconnected",t),Ht(),s("setup.sessionStarted")&&c.emit("ui:show-toast",`${f} 연결이 끊겼어요`),d.info(`[Host] ${f} disconnected`)}),e.on("error",E=>{if(d.error("[Host] Connection error:",E),o.get(t)!==e){try{e.close()}catch{}return}o.delete(t),wo(t);const v=s("network.connectedPeers");m("network.connectedPeers",v.filter(w=>w.id!==t)),c.emit("network:peer-disconnected",t),Ht(),s("setup.sessionStarted")&&c.emit("ui:show-toast",`${f} 연결 오류`);try{e.close()}catch{}})}function Mn(e,t=0){const n=s("network.hostConn");if(n&&n.open){d.warn("[Join] Already connected to host.");return}if(!e){c.emit("network:error",new Error("NO_HOST_ID"));return}if(m("network.lastJoinCode",e),!O){if(t>3){c.emit("network:error",new Error("NETWORK_INIT_FAILED"));return}Zo(null).then(()=>Mn(e,t+1)).catch(a=>{d.error("[Join] Failed to init peer",a),c.emit("network:error",new Error("NETWORK_INIT_FAILED"))});return}if(!O.open){t<10?setTimeout(()=>Mn(e,t+1),300):c.emit("network:error",new Error("PEER_NOT_READY"));return}m("network.isConnecting",!0);let o;try{const a=s("audio.channelMode");o=O.connect(e,{reliable:!0,metadata:{label:`mode-${a}`}})}catch(a){d.error("[Join] peer.connect failed",a),m("network.isConnecting",!1),c.emit("network:error",new Error("CONNECT_FAILED"));return}const r=setTimeout(()=>{if(!(!o||o.open||s("network.hostConn"))){try{o.close()}catch{}m("network.isConnecting",!1),c.emit("network:error",new Error("HOST_UNREACHABLE"))}},1e4);o.on("open",()=>{clearTimeout(r),d.info("[Join] Connected to host:",e),m("network.hostConn",o),m("network.isConnecting",!1),m("session.hostId",e),o._errorHandled=!1,o.on("data",a=>{c.emit("network:data",a,o)}),o.on("close",()=>{if(d.warn("[Join] Host connection closed"),m("network.hostConn",null),m("network.isConnecting",!1),o._errorHandled){m("network.isIntentionalDisconnect",!1);return}o._errorHandled=!0,s("network.isIntentionalDisconnect")||c.emit("network:error",new Error("HOST_DISCONNECTED")),m("network.isIntentionalDisconnect",!1)}),o.on("error",a=>{d.error("[Join] Host connection error",a),m("network.hostConn",null),m("network.isConnecting",!1),!o._errorHandled&&(o._errorHandled=!0,c.emit("network:error",new Error("HOST_CONNECTION_ERROR")))}),c.emit("worker:sync-command",{command:"START_TIMER",id:"heartbeat",interval:1e3}),c.emit("worker:sync-command",{command:"START_TIMER",id:"ping",interval:2e3}),c.emit("network:peer-connected",o),c.emit("setup:guest-join-success")})}function er(){d.debug("[Network] Leaving session — full cleanup..."),m("network.isIntentionalDisconnect",!0),ps(),as(),c.emit("player:stop-all-media");const e=s("network.hostConn");if(e)try{e.close()}catch{}if(O){try{O.destroy()}catch{}O=null}s("network.connectedPeers").forEach(f=>{try{const y=f.conn;y&&y.close()}catch{}}),s("relay.downstreamDataPeers").forEach(f=>{try{f.close()}catch{}});const o=s("network.activeHostConnByPeerId"),r=s("network.peerSlotByPeerId");o.clear(),r.clear();const a=s("network.peerSlots");for(let f=1;f<=ft;f++)a[f]=null;const i=s("transfer.fileReorderBuffer"),l=s("transfer.preloadReorderBuffer"),u=s("transfer.preloadSessionState");i&&i.clear(),l&&l.clear(),u&&u.clear(),c.emit("blob:revoke-all"),Gr({"network.myId":null,"network.myDeviceLabel":"HOST","network.hostConn":null,"network.connectedPeers":[],"network.isOperator":!1,"network.isConnecting":!1,"network.lastKnownDeviceList":null,"network.peerLabels":{},"network.isIntentionalDisconnect":!1,"relay.upstreamDataConn":null,"relay.downstreamDataPeers":[],"playlist.items":[],"playlist.currentTrackIndex":-1,"playlist.nextTrackIndex":-1,"transfer.meta":null,"transfer.state":"IDLE","transfer.receivedCount":0,"transfer.localSessionId":0,"files.currentFileBlob":null,"preload.nextFileBlob":null,"preload.meta":null,"sync.localOffset":0,"sync.autoSyncOffset":0,"player.pausedAt":0,"player.currentAudioBuffer":null,appState:b.IDLE}),c.emit("ui:update-playlist"),c.emit("player:state-changed",b.IDLE),d.debug("[Network] Session left — full cleanup complete.")}function T(e,t=!1){s("network.connectedPeers").forEach(o=>{try{if(o.status==="connected"&&o.conn){const r=o.conn;r.open&&(!t||o.isDataTarget!==!1)&&r.send(e)}}catch(r){d.warn(`[broadcast] Send failed for peer ${o.label||o.id}:`,r)}})}function ks(e,t,n=!1){s("network.connectedPeers").forEach(r=>{try{if(r.status==="connected"&&r.conn){const a=r.conn;if(a.open){if(e&&r.id===e)return;(!n||r.isDataTarget!==!1)&&a.send(t)}}}catch(a){d.warn(`[broadcastExcept] Send failed for peer ${r.label||r.id}:`,a)}})}function Ht(){const e=s("network.myId"),t=s("network.connectedPeers"),n=[{id:e,label:"HOST",status:"connected",isHost:!0},...t.sort((r,a)=>r.joinOrder-a.joinOrder).map(r=>({id:r.id,label:r.label,status:r.status,isHost:!1,isOp:r.isOp}))],o={type:p.DEVICE_LIST_UPDATE,list:n};T(o),c.emit("network:device-list",n)}c.on("network:broadcast",((...e)=>{const t=e[0];t&&T(t)}));c.on("network:broadcast-except",((...e)=>{const t=e[0],n=e[1];n&&ks(t,n)}));c.on("network:toggle-operator",((...e)=>{const t=e[0];if(!t||s("network.hostConn"))return;const r=s("network.connectedPeers").find(a=>a.id===t);if(r){r.isOp=!r.isOp;const a=r.conn;a&&a.open?a.send({type:r.isOp?p.OPERATOR_GRANT:p.OPERATOR_REVOKE}):d.warn(`[OP] Cannot notify peer ${t} — connection not open`),Ht(),c.emit("ui:show-toast",`${r.label} 권한 ${r.isOp?"부여됨":"회수됨"}`)}}));window.toggleOperator=e=>{c.emit("network:toggle-operator",e)};c.on("network:device-list",((...e)=>{const t=e[0];Array.isArray(t)&&(m("network.lastKnownDeviceList",t),c.emit("network:device-list-update",t))}));function Is(e){e.label&&m("network.myDeviceLabel",String(e.label)),c.emit("network:role-badge-update")}function Ps(e){const t=e.message?String(e.message):"세션이 가득 찼어요";m("network.isIntentionalDisconnect",!0);const n=s("network.hostConn");if(n){try{n.close()}catch{}m("network.hostConn",null)}m("network.isConnecting",!1),c.emit("network:role-badge-update"),c.emit("network:session-full",t)}function Cs(e){const t=Array.isArray(e.list)?e.list:[];m("network.lastKnownDeviceList",t);const n=s("network.myId");if(s("network.hostConn")&&n){if(!t.find(i=>i&&i.id===n)){d.warn("[Guest] Removed from Host device list. Leaving session..."),m("network.isIntentionalDisconnect",!0),c.emit("network:kicked-from-session");return}const a=t.find(i=>i&&i.id===n);a&&a.label&&m("network.myDeviceLabel",String(a.label))}c.emit("network:device-list-update",t)}function _s(){d.warn("[Guest] Received force-close-duplicate — connection will close")}function Rs(e){e.message&&c.emit("ui:show-toast",String(e.message))}function As(){m("network.isOperator",!0),c.emit("ui:show-toast","Operator 권한이 부여되었습니다."),c.emit("ui:play-btn-state",!0),c.emit("network:role-badge-update")}function Ls(){m("network.isOperator",!1),c.emit("ui:show-toast","Operator 권한이 해제되었습니다."),c.emit("network:role-badge-update")}function xs(){m("setup.sessionStarted",!0),c.emit("setup:hide-overlay"),c.emit("network:role-badge-update"),d.info("[Peer] Session started")}function Os(){J({[p.WELCOME]:Is,[p.SESSION_FULL]:Ps,[p.SESSION_START]:xs,[p.DEVICE_LIST_UPDATE]:Cs,[p.FORCE_CLOSE_DUPLICATE]:_s,[p.SYS_TOAST]:Rs,[p.OPERATOR_GRANT]:As,[p.OPERATOR_REVOKE]:Ls}),d.info("[Peer] Protocol handlers registered")}function fe(){if(!Zn())return;const e=s("audio.reverbMix"),t=s("audio.reverbDecay"),n=s("audio.reverbPreDelay"),o=s("audio.reverbLowCut"),r=s("audio.reverbHighCut"),a=s("audio.stereoWidth"),i=s("audio.virtualBass"),l=s("audio.eqValues"),u=s("audio.userPreampGain"),f=s("audio.channelMode"),y=s("audio.isSurroundMode"),h=s("audio.surroundChannelIndex"),g=s("audio.subFreq"),E=Kr();E&&E.fade.rampTo(e,.1);const v=zr();if(v){let F=!1;v.decay!==t&&(v.decay=t,F=!0),v.preDelay!==n&&(v.preDelay=n,F=!0),F&&v.generate().catch(se=>d.warn("[Reverb] generate() failed:",se))}const k=Qr();if(k){const F=20*Math.pow(50,o/100);k.frequency.rampTo(F,.1)}const w=jr();if(w){const F=2e4*Math.pow(.05,r/100);w.frequency.rampTo(F,.1)}const I=to();I&&l&&I.forEach((F,se)=>{F.gain.value!==l[se]&&F.gain.rampTo(l[se],.1)});let A=1;const _=Wo();_&&(_.wet.rampTo(1,.1),_.width.rampTo(a*.5,.1),a<1&&(A=.6+.4*a));const x=eo();x&&x.gain.rampTo(u*A,.1);const D=f===2||y&&h===3,U=zo();U&&U.frequency.rampTo(D?g:2e4,.1);const q=Jr();q&&q.gain.rampTo(i,.1)}function M(e,t,n=!1){const o=Number(t);if(Number.isFinite(o)){switch(e){case"mix":m("audio.reverbMix",o/100);break;case"decay":m("audio.reverbDecay",o);break;case"predelay":m("audio.reverbPreDelay",o);break;case"lowcut":m("audio.reverbLowCut",o);break;case"highcut":m("audio.reverbHighCut",o);break}n||fe()}}function tr(){M("mix",0,!0),M("decay",5,!0),M("predelay",.1,!0),M("lowcut",0,!0),M("highcut",0,!0),fe()}function oo(e,t){const n=Number(e),o=Number(t),r=s("audio.eqValues");r&&(r[n]=o,m("audio.eqValues",[...r]));const a=to();a?.[n]&&a[n].gain.rampTo(o,.1);const i=document.getElementById(`eq-val-${n}`);i&&(i.innerText=o>0?`+${o}`:String(o));const l=document.querySelectorAll(".eq-band");if(l[n]){const u=l[n].querySelector(".eq-slider");u&&parseFloat(u.value)!==o&&(u.value=String(o))}}function ro(){const e=to(),t=e?e.length:5;m("audio.eqValues",Array(t).fill(0)),m("audio.userPreampGain",1),e?.forEach(n=>n.gain.rampTo(0,.1)),fe()}function so(e){const t=Number(e),n=Math.pow(10,t/20);m("audio.userPreampGain",n),fe()}function ln(e){m("audio.stereoWidth",e/100),fe()}function Ns(){ln(100)}function un(e){m("audio.virtualBass",e/100),fe()}function Us(){un(0)}function Bs(e){const t=Number(e);m("audio.subFreq",t);const n=Xr();n&&n.frequency.rampTo(t,.1);const o=s("audio.channelMode"),r=s("audio.isSurroundMode"),a=s("audio.surroundChannelIndex"),i=o===2&&!r,l=r&&a===3,u=zo();u&&u.frequency.rampTo(i||l?t:2e4,.1);const f=no();f&&(i||l)&&f.frequency.rampTo(t,.1)}function Vt(e,t){const n=s("network.hostConn");n?s("network.isOperator")&&n.send({type:p.REQUEST_SETTING,settingType:e,value:t}):T({type:e,value:t})}function Ds(e,t){const n=s("network.hostConn");n?s("network.isOperator")&&n.send({type:p.REQUEST_SETTING,settingType:"eq",band:e,value:t}):T({type:p.EQ_UPDATE,band:e,value:t})}c.on("audio:update-effect",((...e)=>{const t=e[0],n=e[1],o=Number(e[2]),r=!!e[3];if(Number.isFinite(o))switch(t){case"reverb":if(M(n,o),!r){const i={mix:p.REVERB,decay:p.REVERB_DECAY,predelay:p.REVERB_PREDELAY,lowcut:p.REVERB_LOWCUT,highcut:p.REVERB_HIGHCUT}[n];i&&Vt(i,o)}break;case"stereo":n==="mix"&&(ln(o),r||Vt(p.STEREO_WIDTH,o));break;case"vbass":n==="mix"&&(un(o),r||Vt(p.VBASS,o));break;case"cutoff":n==="value"&&Bs(o);break;default:d.warn("[Effects] Unknown effect type:",t)}}));c.on("audio:set-preamp",((...e)=>{const t=Number(e[0]),n=!!e[1];Number.isFinite(t)&&(so(t),n||Vt(p.PREAMP,t))}));c.on("audio:set-eq",((...e)=>{const t=Number(e[0]),n=Number(e[1]),o=!!e[2];!Number.isFinite(t)||!Number.isFinite(n)||(oo(t,n),o||Ds(t,n))}));c.on("audio:reset-reverb",(()=>{const e=s("network.hostConn");e?s("network.isOperator")&&e.send({type:p.REQUEST_REVERB_RESET}):(tr(),T({type:p.REVERB,value:0}),T({type:p.REVERB_DECAY,value:5}),T({type:p.REVERB_PREDELAY,value:.1}),T({type:p.REVERB_LOWCUT,value:0}),T({type:p.REVERB_HIGHCUT,value:0}))}));c.on("audio:reset-eq",(()=>{const e=s("network.hostConn");e?s("network.isOperator")&&e.send({type:p.REQUEST_EQ_RESET}):(ro(),T({type:p.EQ_RESET}))}));c.on("audio:reset-stereo",(()=>{const e=s("network.hostConn");e?s("network.isOperator")&&e.send({type:p.REQUEST_SETTING,settingType:p.STEREO_WIDTH,value:100}):(Ns(),T({type:p.STEREO_WIDTH,value:100}))}));c.on("audio:reset-vbass",(()=>{const e=s("network.hostConn");e?s("network.isOperator")&&e.send({type:p.REQUEST_SETTING,settingType:p.VBASS,value:0}):(Us(),T({type:p.VBASS,value:0}))}));c.on("audio:ready",(()=>{d.info("[Effects] Audio ready — applying default settings"),fe()}));c.on("network:peer-connected",((...e)=>{const t=e[0];if(!(!t?.open||s("network.hostConn")))try{const o=s("audio.masterVolume");t.send({type:p.VOLUME,value:o});const r=s("audio.reverbMix");t.send({type:p.REVERB,value:r*100});const a=s("audio.reverbDecay");t.send({type:p.REVERB_DECAY,value:a});const i=s("audio.reverbPreDelay");t.send({type:p.REVERB_PREDELAY,value:i});const l=s("audio.reverbLowCut");t.send({type:p.REVERB_LOWCUT,value:l});const u=s("audio.reverbHighCut");t.send({type:p.REVERB_HIGHCUT,value:u});const f=s("audio.eqValues");f&&f.forEach((E,v)=>{t.send({type:p.EQ_UPDATE,band:v,value:E})});const y=s("audio.userPreampGain");t.send({type:p.PREAMP,value:Math.round(20*Math.log10(Math.max(y,1e-6)))});const h=s("audio.stereoWidth");t.send({type:p.STEREO_WIDTH,value:h*100});const g=s("audio.virtualBass");t.send({type:p.VBASS,value:g*100}),d.debug("[Effects] Bootstrap: sent audio settings to new peer")}catch(o){d.warn("[Effects] Bootstrap send failed:",o)}}));function Fs(e){if(e.value===void 0||e.value===null)return;const t=Number(e.value);c.emit("audio:set-volume",t),c.emit("ui:show-toast",`Volume: ${Math.round(t*100)}%`)}function Ms(e){e.band===void 0||e.value===void 0||oo(Number(e.band),Number(e.value))}function Ys(e){e.value!==void 0&&so(Number(e.value))}function $s(){ro()}function Hs(e){e.value!==void 0&&M("mix",Number(e.value))}function Vs(e){if(!e.value)return;const t=String(e.value);switch(t){case"room":m("audio.reverbDecay",1.5),m("audio.reverbPreDelay",.05);break;case"hall":m("audio.reverbDecay",3.5),m("audio.reverbPreDelay",.1);break;case"space":m("audio.reverbDecay",7),m("audio.reverbPreDelay",.2);break;default:return}m("audio.reverbType",t),fe(),c.emit("ui:show-toast",`리버브 타입: ${t}`)}function qs(e){e.value!==void 0&&M("decay",Number(e.value))}function Gs(e){e.value!==void 0&&M("predelay",Number(e.value))}function Ws(e){e.value!==void 0&&M("lowcut",Number(e.value))}function zs(e){e.value!==void 0&&M("highcut",Number(e.value))}function Qs(e){e.value!==void 0&&ln(Number(e.value))}function js(e){e.value!==void 0&&un(Number(e.value))}function Ks(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[Effects] Rejected request-eq-reset from non-OP: ${t?.peer}`);return}ro(),T({type:p.EQ_RESET})}}function Xs(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[Effects] Rejected request-reverb-reset from non-OP: ${t?.peer}`);return}tr(),T({type:p.REVERB,value:0}),T({type:p.REVERB_DECAY,value:5}),T({type:p.REVERB_PREDELAY,value:.1}),T({type:p.REVERB_LOWCUT,value:0}),T({type:p.REVERB_HIGHCUT,value:0})}}function Js(){const e=t=>t;J({[p.VOLUME]:e(Fs),[p.EQ_UPDATE]:e(Ms),[p.PREAMP]:e(Ys),[p.EQ_RESET]:e($s),[p.REVERB]:e(Hs),[p.REVERB_TYPE]:e(Vs),[p.REVERB_DECAY]:e(qs),[p.REVERB_PREDELAY]:e(Gs),[p.REVERB_LOWCUT]:e(Ws),[p.REVERB_HIGHCUT]:e(zs),[p.STEREO_WIDTH]:e(Qs),[p.VBASS]:e(js),[p.REQUEST_EQ_RESET]:Ks,[p.REQUEST_REVERB_RESET]:Xs}),d.info("[Effects] Protocol handlers registered")}function io(e){if(m("audio.channelMode",e),!Zn())return;const n=qo(),o=Go(),r=Vo(),a=no(),i=s("audio.subFreq"),l=.05;a&&(a.frequency.value=2e4);try{n.disconnect()}catch{}try{o.disconnect()}catch{}n.gain.value=1,o.gain.value=1,e===0?(n.connect(r,0,0),o.connect(r,0,1),n.gain.rampTo(1,l),o.gain.rampTo(1,l)):e===-1?(n.connect(r,0,0),n.connect(r,0,1),n.gain.rampTo(1,l)):e===1?(o.connect(r,0,0),o.connect(r,0,1),o.gain.rampTo(1,l)):e===2?(a&&(a.frequency.value=i),n.connect(r,0,0),n.connect(r,0,1),o.connect(r,0,0),o.connect(r,0,1),n.gain.value=.5,o.gain.value=.5):(n.connect(r,0,0),o.connect(r,0,1),n.gain.rampTo(1,l),o.gain.rampTo(1,l)),fe(),c.emit("audio:channel-changed",e)}function Zs(e){if(m("audio.isSurroundMode",e),e){Qo();const n=s("audio.surroundChannelIndex");Yn(n===-1?2:n)}else io(s("audio.channelMode"));const t=s("appState");(t===b.PLAYING_AUDIO||t===b.PLAYING_VIDEO)&&c.emit("audio:surround-toggled")}function Yn(e){m("audio.surroundChannelIndex",e);const t=Zr(),n=es();if(!t||!n||!s("audio.isSurroundMode"))return;const r=qo(),a=Go(),i=Vo(),l=no(),u=s("audio.subFreq"),f=eo();try{n.disconnect(),n.connect(f),t.disconnect(),e===6?(t.connect(n,6,0),t.connect(n,4,0)):e===7?(t.connect(n,7,0),t.connect(n,5,0)):e===3?t.connect(n,3,0):t.connect(n,e,0),l&&(l.frequency.value=e===3?u:2e4);try{r.disconnect()}catch{}try{a.disconnect()}catch{}r.connect(i,0,0),a.connect(i,0,1),r.gain.rampTo(1,.1),a.gain.rampTo(1,.1);const y=["Front Left (L)","Front Right (R)","Center (Dialog)","LFE (Sub)","Side Left","Side Right","Rear Left (Back)","Rear Right (Back)"];d.info(`[Surround] Channel set: ${y[e]}`)}catch(y){d.warn("[Surround] setSurroundChannel error:",y)}c.emit("audio:channel-changed",e)}async function ei(e){Zn()||await Oe(),io(e)}c.on("audio:set-channel-mode",((...e)=>{const t=Number(e[0]);Number.isFinite(t)&&ei(t)}));c.on("audio:toggle-surround",((...e)=>{const t=!!e[0];Zs(t)}));c.on("audio:set-surround-channel",((...e)=>{const t=Number(e[0]);Number.isFinite(t)&&t>=0&&t<=7&&Yn(t)}));const ti="modulepreload",ni=function(e){return"/"+e},ko={},nr=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){let i=function(f){return Promise.all(f.map(y=>Promise.resolve(y).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=l?.nonce||l?.getAttribute("nonce");r=i(n.map(f=>{if(f=ni(f),f in ko)return;ko[f]=!0;const y=f.endsWith(".css"),h=y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${h}`))return;const g=document.createElement("link");if(g.rel=y?"stylesheet":ti,y||(g.as="script"),g.crossOrigin="",g.href=f,u&&g.setAttribute("nonce",u),document.head.appendChild(g),y)return new Promise((E,v)=>{g.addEventListener("load",E),g.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${f}`)))})}))}function a(i){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=i,window.dispatchEvent(l),!l.defaultPrevented)throw i}return r.then(i=>{for(const l of i||[])l.status==="rejected"&&a(l.reason);return t().catch(a)})};function oi(){if(s("appState")===b.PLAYING_YOUTUBE)return;s("network.hostConn")?(m("sync.localOffset",0),m("sync.autoSyncOffset",0),c.emit("sync:display-update"),c.emit("ui:show-toast","최적 싱크 보정 적용 중..."),ao()):(T({type:p.GLOBAL_RESYNC_REQUEST}),c.emit("ui:show-toast","모든 기기 재동기화 요청..."))}function ao(){const e=s("network.hostConn");if(!e||!e.open)return;c.emit("sync:display-update");const t=Date.now();m("sync.syncRequestTime",t),e.send({type:p.GET_SYNC_TIME,ts:t})}function Te(e=1e3){if(s("network.hostConn"))return;const n=s("sync.resyncTimer");n&&clearTimeout(n);const o=setTimeout(()=>{m("sync.resyncTimer",null),s("network.hostConn")||(T({type:p.GLOBAL_RESYNC_REQUEST}),d.debug(`[Sync] Automatic global resync requested (delay: ${e}ms)`))},e);m("sync.resyncTimer",o)}function ri(e,t){try{if(t&&t.peer){const o=s("network.connectedPeers").find(r=>r.id===t.peer);o&&(o.lastHeartbeat=Date.now())}}catch{}t&&t.open&&t.send({type:p.HEARTBEAT_ACK})}function si(){m("sync.lastHeartbeatAckAt",Date.now())}function ii(e,t){typeof e.timestamp=="number"&&t&&t.open&&t.send({type:p.PONG_LATENCY,timestamp:e.timestamp})}function ai(e){if(typeof e.timestamp!="number")return;const t=Date.now()-e.timestamp,n=s("sync.latencyHistory");n.push(t),n.length>10&&n.shift(),m("sync.lastLatencyMs",Math.min(...n)),c.emit("sync:latency-update",t)}function ci(e){if(s("appState")===b.PLAYING_YOUTUBE)return;if(e.reqTs&&typeof e.reqTs=="number"&&e.reqTs>0){const r=Date.now()-e.reqTs;if(r>150){const a=e._syncBusyRetry||0;if(a<3){d.debug(`[AutoSync] Host was busy (${r}ms). Retry ${a+1}/3 in 300ms...`),setTimeout(()=>ao(),300);return}d.warn(`[AutoSync] Host busy retries exhausted (${r}ms). Proceeding with stale data.`)}}let n=0;s("sync.usePingCompensation")&&(n=s("sync.lastLatencyMs")/2/1e3),m("sync.autoSyncOffset",n),c.emit("sync:display-update"),c.emit("sync:response",e.time,e.isPlaying,n)}function li(){c.emit("ui:show-toast","Host 요청: 싱크 초기화 및 재설정..."),m("sync.localOffset",0),c.emit("sync:display-update"),setTimeout(()=>ao(),Math.random()*500)}function ui(e,t){s("network.hostConn")||t&&t.open&&c.emit("sync:get-position",o=>{const r=s("appState"),a=r===b.PLAYING_AUDIO||r===b.PLAYING_VIDEO||r===b.PLAYING_YOUTUBE;t.send({type:p.SYNC_RESPONSE,time:o,isPlaying:a,reqTs:e.ts||0})})}function di(){J({[p.HEARTBEAT]:ri,[p.HEARTBEAT_ACK]:si,[p.PING_LATENCY]:ii,[p.PONG_LATENCY]:ai,[p.SYNC_RESPONSE]:ci,[p.GLOBAL_RESYNC_REQUEST]:li,[p.GET_SYNC_TIME]:ui}),c.on("sync:nudge",((...e)=>{const t=Number(e[0]);Number.isFinite(t)&&nr(()=>Promise.resolve().then(()=>ra),void 0).then(n=>n.adjustSync(t/1e3))})),c.on("sync:auto-sync",(()=>{oi()})),c.on("sync:close-manual",(()=>{const e=document.getElementById("manual-sync-overlay");e&&e.classList.remove("show")})),c.on("sync:display-update",(()=>{const e=s("sync.localOffset")||0,t=s("sync.autoSyncOffset")||0,n=e+t,o=document.getElementById("manual-sync-value");o&&(o.innerText=`${n>=0?"+":""}${(n*1e3).toFixed(0)}ms`)})),c.on("worker:timer-tick",((...e)=>{const t=e[0],n=s("network.hostConn");if(!(!n||!n.open)){if(t==="heartbeat")try{n.send({type:p.HEARTBEAT})}catch{}else if(t==="ping")try{n.send({type:p.PING_LATENCY,timestamp:Date.now()})}catch{}}})),d.info("[Sync] Handlers registered")}const $e=new Map;let ce=0,$n=0,lt=[];function or(){P("chunkWatchdog"),$n=Date.now(),m("transfer.lastReceivedCountSnapshot",s("transfer.receivedCount")),X("chunkWatchdog",()=>{const e=Date.now()-$n,t=s("transfer.receivedCount"),n=s("transfer.lastReceivedCountSnapshot");(t===n&&e>So||e>So)&&(P("chunkWatchdog"),c.emit("storage:request-recovery")),m("transfer.lastReceivedCountSnapshot",t)},1e3,{interval:!0})}function fi(e){s("transfer.waitingForPreload")&&(d.debug("[file-prepare] Clearing stale waitingForPreload flag"),m("transfer.waitingForPreload",!1)),P("preloadWatchdog"),m("recovery.retryCount",0);const t=e.sessionId,n=s("transfer.localSessionId");t&&t>n&&(d.debug(`[file-prepare] New session: ${t} (prev: ${n})`),m("transfer.localSessionId",t));const o=s("preload.meta"),r=s("preload.nextFileBlob"),a=o&&e.index!==void 0&&e.index===o.index,i=o&&e.name&&e.name===o.name;if(o&&e.index!==void 0&&e.index!==o.index&&(d.warn(`[file-prepare] Preload index mismatch! Request: ${e.index}, Preloaded: ${o.index}. Clearing stale preload.`),m("transfer.waitingForPreload",!1),P("preloadWatchdog"),m("preload.nextFileBlob",null),m("preload.meta",null),m("preload.nextTrackIndex",-1),m("preload.count",0)),r&&(a||i)){d.debug("[Guest] Using preloaded track instead of re-downloading:",e.name),c.emit("ui:show-toast","프리로드된 파일 사용!"),c.emit("player:stop-all-media"),e.index!==void 0&&m("playlist.currentTrackIndex",e.index),c.emit("ui:update-playlist"),m("transfer.skipIncomingFile",!0),c.emit("storage:use-preloaded",e.index,e.name),c.emit("ui:show-loader",!1);return}c.emit("player:stop-all-media");const u=o&&e.index!==void 0&&e.index===o.index,f=o&&e.name&&e.name===o.name;if(s("preload.isPreloading")&&(u||f))if(t>n)d.debug("[file-prepare] Preload in progress but Host started Main Session. Prioritizing Main."),m("preload.nextFileBlob",null),m("preload.meta",null),m("preload.nextTrackIndex",-1);else{d.debug("[file-prepare] Preload in progress for this track, waiting..."),c.emit("ui:show-loader",!0,`프리로드 완료 대기 중: ${e.name}`),m("recovery.pendingFileName",e.name||""),m("recovery.pendingFileIndex",e.index),m("transfer.waitingForPreload",!0),m("transfer.skipIncomingFile",!0),e.index!==void 0&&(m("playlist.currentTrackIndex",e.index),c.emit("ui:update-playlist")),X("preloadWatchdog",()=>{if(s("transfer.waitingForPreload")){d.warn("[Guest] Preload wait timed out. Force recovering..."),m("transfer.waitingForPreload",!1),c.emit("ui:show-loader",!1),m("transfer.skipIncomingFile",!1);const w=s("network.hostConn");w&&w.open&&w.send({type:p.REQUEST_CURRENT_FILE,name:e.name,index:e.index})}},1e4);return}m("transfer.skipIncomingFile",!1),m("transfer.waitingForPreload",!1),m("recovery.pendingFileName",e.name||""),m("recovery.pendingFileIndex",e.index);const h=s("transfer.meta"),g=s("transfer.receivedCount"),E=s("recovery.pendingFileIndex");(h.name===e.name||E!==void 0&&E===e.index)&&g>0?(d.debug(`[file-prepare] Same file in progress (${g} chunks), skipping reset`),c.emit("ui:show-loader",!0,`복구 대기 중: ${e.name}`)):(c.emit("storage:clear-previous-track","file-prepare"),e.index!==void 0&&(m("playlist.currentTrackIndex",e.index),c.emit("ui:update-playlist")),m("transfer.meta",{...h,name:e.name||"",index:e.index??s("playlist.currentTrackIndex"),size:e.size||0,mime:e.mime||"",sessionId:e.sessionId||s("transfer.localSessionId")}),s("appState")===b.PLAYING_YOUTUBE&&(d.debug("[file-prepare] Stopping YouTube mode for incoming local file"),c.emit("youtube:stop-mode")),c.emit("ui:show-loader",!0,`준비 중: ${e.name}`)),X("prepareWatchdog",()=>{const w=s("transfer.state"),I=s("transfer.receivedCount");if(w===W.IDLE||I===0){d.warn("[Prepare Watchdog] Timeout waiting for data start!"),c.emit("ui:show-toast","준비 지연 중... Host 복구 요청");const A=s("network.hostConn");if(A&&A.open){const _=Math.random()*1e3+200;setTimeout(()=>{A.open&&!s("files.currentFileBlob")&&c.emit("storage:request-recovery")},_)}}},15e3)}function pi(e){const t=e.sessionId,n=s("transfer.localSessionId");if(!t||t<n){d.warn(`[file-start] Stale session ignored. Current: ${n}, Received: ${t}`);return}if(t>n&&(m("transfer.localSessionId",t),N({command:"OPFS_RESET",isPreload:!1}),c.emit("storage:clear-previous-track","new-session-start")),s("transfer.skipIncomingFile")){P("prepareWatchdog"),P("chunkWatchdog"),s("relay.downstreamDataPeers").forEach(y=>{y.open&&y.send(e)});return}P("prepareWatchdog"),P("chunkWatchdog");const r=s("transfer.meta"),a=s("transfer.receivedCount"),i=r.name===e.name&&r.total===e.total,l=s("files.currentFileOpfs");if(l.name&&l.name!==e.name&&Xo(l.name,!1),l.name=e.name,i&&a>0?(d.debug(`[file-start] Same file detected! Keeping ${a}/${e.total} chunks`),N({command:"OPFS_START",filename:e.name,isPreload:!1,sessionId:ne(t),size:oe,keepExisting:!0}),m("transfer.meta",e),m("transfer.state",W.RECEIVING)):(N({command:"OPFS_START",filename:e.name,isPreload:!1,sessionId:ne(t),size:oe}),m("transfer.receivedCount",0),m("transfer.meta",e),m("transfer.state",W.RECEIVING),$e.clear(),ce=0),or(),lt.length>0){const f=lt.splice(0);d.debug(`[file-start] Replaying ${f.length} early chunks`);for(const y of f)rr(y)}s("relay.downstreamDataPeers").forEach(f=>{f.open&&f.send(e)}),c.emit("ui:show-loader",!0,"수신 중... 0%")}function mi(e){const t=e.sessionId,n=s("transfer.localSessionId");if(!t||t<n)return;t>n&&m("transfer.localSessionId",t),P("prepareWatchdog"),m("transfer.skipIncomingFile",!1),N({command:"OPFS_START",filename:e.name,isPreload:!1,sessionId:ne(t),size:oe});const o=s("files.currentFileOpfs");o.name=e.name,ce=e.startChunk||0,m("transfer.meta",e),m("transfer.state",W.RECEIVING),or(),s("relay.downstreamDataPeers").forEach(a=>{a.open&&a.send(e)})}function rr(e){const t=e.sessionId;if(!t)return;if(s("transfer.skipIncomingFile")){const y=s("transfer.localSessionId");t>y&&m("transfer.localSessionId",t);return}if(s("transfer.state")===W.IDLE&&!$e.has(t)){lt.push(e),lt.length>200&&lt.shift();return}const o=s("transfer.localSessionId");if(t>o&&(m("transfer.localSessionId",t),N({command:"OPFS_RESET",isPreload:!1}),c.emit("storage:clear-previous-track","session-change"),$e.clear(),ce=0,m("transfer.receivedCount",0)),t<o)return;$e.has(t)||($e.set(t,new Map),ce=0);const r=$e.get(t),a=new Uint8Array(e.chunk);r.set(e.index,a);const i=s("transfer.meta"),l=s("files.currentFileOpfs");let u=s("transfer.receivedCount");if(!i||i.total===void 0||i.total===0){if(e.total!==void 0&&Number(e.total)>0){const y={name:e.name||i?.name||"",total:e.total,sessionId:t,size:e.size||0,mime:e.mime||""};m("transfer.meta",y),m("transfer.state",W.RECEIVING);const h=y.name||"";h&&(l.name=h,N({command:"OPFS_START",filename:h,isPreload:!1,sessionId:ne(t),size:oe})),d.debug(`[FileChunk] Recovered meta from chunk: ${h} (${y.total} chunks)`)}else if(!i||i.total===void 0)return}for(;r.has(ce);){const y=r.get(ce),h=s("relay.downstreamDataPeers");let g=null;if(h.length>0&&(g=new Uint8Array(y)),N({command:"OPFS_WRITE",chunk:y instanceof ArrayBuffer?y:y.buffer,index:ce,isPreload:!1,filename:l.name||"",sessionId:ne(t)}),g&&h.length>0){const E={type:p.FILE_CHUNK,chunk:g,index:ce,sessionId:t};h.forEach(v=>{if(v.open)try{v.send(E)}catch{}})}r.delete(ce),ce++,u++}m("transfer.receivedCount",u),$n=Date.now();const f=i.total||0;if(f>0){const y=Math.min(100,Math.floor(u/f*100));c.emit("storage:transfer-progress",y,f)}if(f>0&&u>=f&&s("transfer.state")!==W.PROCESSING){m("transfer.state",W.PROCESSING),m("recovery.retryCount",0);const y=s("network.hostConn"),h=i.index;y&&y.open&&h!==void 0&&y.send({type:p.PRELOAD_ACK,index:h}),N({command:"OPFS_END",filename:i.name||"",isPreload:!1,sessionId:ne(t),totalSize:i.size}),P("chunkWatchdog")}}function yi(e){if(s("transfer.skipIncomingFile"))return;s("relay.downstreamDataPeers").forEach(n=>{n.open&&n.send(e)}),d.debug(`[file-end] Received end signal for: ${e.name}`)}function hi(){d.debug("[Guest] Relay has no data yet, waiting for forwarded data..."),c.emit("ui:show-toast","릴레이 대기 중... 잠시만 기다려주세요"),P("relayWaitTimeout"),X("relayWaitTimeout",()=>{if(s("transfer.receivedCount")===0){d.debug("[Guest] Relay wait timeout - falling back to Host"),c.emit("ui:show-toast","릴레이 응답 없음. Host에서 직접 수신...");const t=s("relay.upstreamDataConn");t&&(t.close(),m("relay.upstreamDataConn",null));const n=s("network.hostConn");if(n&&n.open){const o=s("recovery.pendingFileName")||"",r=s("recovery.pendingFileIndex"),a=s("playlist.currentTrackIndex"),i=r!==void 0?r:a,l=s("playlist.items")||[];if(i<0||i>=l.length){d.warn("[file-wait timeout] Invalid index, skipping recovery:",i),c.emit("ui:show-loader",!1);return}const u=s("preload.meta");if(u&&u.index===i){d.debug("[file-wait timeout] Preload in progress for this track, waiting..."),c.emit("ui:show-toast","프리로드 완료 대기 중...");return}d.debug(`[file-wait timeout] Requesting from Host: ${o} index: ${i}`),n.send({type:p.REQUEST_DATA_RECOVERY,nextChunk:0,fileName:o,index:i})}}},1e4)}async function gi(e,t=null){let n;const o=s("transfer.currentSessionId");if(t!==null?(n=t,n>o&&m("transfer.currentSessionId",n)):(n=o+1,m("transfer.currentSessionId",n)),s("transfer.activeBroadcastSession")===n)return;m("transfer.activeBroadcastSession",n);const a=oe,i=Math.ceil(e.size/a),l=s("playlist.currentTrackIndex"),u={type:p.FILE_START,name:e.name,mime:e.type,total:i,size:e.size,index:l,sessionId:n},y=s("network.connectedPeers").filter(g=>g.status==="connected"&&g.conn?.open&&g.isDataTarget!==!1);if(y.length===0)return;y.forEach(g=>{try{g.conn.send(u)}catch{}});for(let g=0;g<i;g++){if(s("transfer.activeBroadcastSession")!==n)return;const E=g*a,v=Math.min(E+a,e.size),k=await e.slice(E,v).arrayBuffer(),w=new Uint8Array(k),I={type:p.FILE_CHUNK,chunk:w,index:g,sessionId:n,total:i,name:e.name};for(const A of y){const _=A.conn;if(_?.open){for(;_.dataChannel&&_.dataChannel.bufferedAmount>512*1024&&(await new Promise(x=>setTimeout(x,ue.BACKPRESSURE)),!!_.open););try{_.send(I)}catch{}}}g%50===0&&await new Promise(A=>setTimeout(A,ue.TICK))}const h={type:p.FILE_END,name:e.name,mime:e.type,sessionId:n};y.forEach(g=>{const E=g.conn;if(E?.open)try{E.send(h)}catch{}}),m("transfer.activeBroadcastSession",null)}async function mt(e,t,n=0,o=null){if(!e||!e.open){d.error("[Unicast] Connection is not open");return}const r=o??s("transfer.currentSessionId"),a=oe,i=Math.ceil(t.size/a),l=s("playlist.currentTrackIndex"),f=n>0?p.FILE_RESUME:p.FILE_START,y="name"in t?t.name:"Track";try{e.send({type:f,name:y,mime:t.type,total:i,size:t.size,startChunk:n,sessionId:r,index:l})}catch(h){d.error(`[Unicast] Failed to send ${f}:`,h);return}await new Promise(h=>setTimeout(h,100));try{for(let h=n;h<i;h++){if(s("transfer.currentSessionId")!==r||!e.open)return;const g=Date.now();for(;e.dataChannel&&e.dataChannel.bufferedAmount>64*1024&&!(Date.now()-g>3e4);)await new Promise(I=>setTimeout(I,ue.BACKPRESSURE));const E=h*a,v=Math.min(E+a,t.size),k=await t.slice(E,v).arrayBuffer(),w=new Uint8Array(k);e.send({type:p.FILE_CHUNK,chunk:w,index:h,sessionId:r,total:i,name:y}),h%50===0&&await new Promise(I=>setTimeout(I,ue.TICK))}e.open&&(e.send({type:p.FILE_END,name:y,mime:t.type,sessionId:r}),d.debug("[Unicast] Transfer complete:",y))}catch(h){d.error("[Unicast] Transfer error:",h)}}function bi(){J({[p.FILE_PREPARE]:fi,[p.FILE_START]:pi,[p.FILE_RESUME]:mi,[p.FILE_CHUNK]:rr,[p.FILE_END]:yi,[p.FILE_WAIT]:hi}),d.info("[Transfer] Handlers registered")}let ae=null;const en=new Map;function We(e,t=""){const n=en.get(e);n&&(n.active=!1,n._timer&&(clearTimeout(n._timer),n._timer=null),en.delete(e),t&&d.debug(`[OPFS Catchup] Stop ...${e.slice(-4)}: ${t}`))}function Ei(e,t){if(!e||!e.peer)return;const n=e.peer;We(n,"restart");const o=ne(t.sessionId);if(!o){d.warn(`[OPFS Catchup] Invalid sessionId, abort for peer ...${n.slice(-4)}`);return}const r={peerId:n,conn:e,filename:t.filename,sessionId:o,isPreload:!1,nextIndex:Math.max(0,0),endIndex:Math.max(0,(t.endIndexExclusive||0)|0),awaiting:!1,awaitingIndex:null,lastActivity:Date.now(),active:!0,_timer:null};en.set(n,r),tn(r,0)}function tn(e,t){!e||!e.active||(e._timer&&clearTimeout(e._timer),e._timer=setTimeout(()=>Si(e),Math.max(0,t|0)))}function Si(e){if(!e||!e.active)return;const t=e.conn;if(!t||!t.open){We(e.peerId,"peer closed");return}const n=s("transfer.localSessionId");if(e.sessionId&&e.sessionId<n){We(e.peerId,"session advanced");return}if(!e.filename||e.nextIndex>=e.endIndex){We(e.peerId,"complete");return}if(e.awaiting){const i=Date.now()-e.lastActivity;i>6e3&&e.awaitingIndex!==null&&(d.warn(`[OPFS Catchup] Stuck ${i}ms, retry idx=${e.awaitingIndex} for ...${e.peerId.slice(-4)}`),e.awaiting=!1,e.nextIndex=e.awaitingIndex,e.awaitingIndex=null),tn(e,ue.BACKPRESSURE);return}const o=t.dataChannel?t.dataChannel.bufferedAmount:0;if((t._relayQueue?t._relayQueue.length:0)>120||o>256*1024){tn(e,ue.BACKPRESSURE);return}const a=e.nextIndex;e.nextIndex++,e.awaiting=!0,e.awaitingIndex=a,e.lastActivity=Date.now(),N({command:"OPFS_READ",filename:e.filename,index:a,isPreload:e.isPreload,sessionId:e.sessionId,requestId:`${e.peerId}|catchup`})}function Ti(e,t,n){const o=en.get(e);if(!(!o||!o.active)&&n==="catchup"){if(t&&o.sessionId&&t!==o.sessionId){We(e,"session mismatch");return}o.awaiting=!1,o.awaitingIndex=null,o.lastActivity=Date.now(),tn(o,0)}}function vi(e){const t=hs();if(!t)return;const n=s("relay.upstreamDataConn");n&&(d.debug("[Relay] Closing existing relay connection for new assignment"),n.close(),m("relay.upstreamDataConn",null)),ae&&(clearTimeout(ae),ae=null);const o=s("network.myId"),r=t.connect(e,{metadata:{type:p.DATA_RELAY,label:o}});ae=setTimeout(()=>{if(!r.open){d.warn("[Relay] Connect Timeout"),c.emit("ui:show-toast","Relay 연결 시간초과"),r.close(),m("relay.upstreamDataConn",null);const i=s("network.hostConn");if(i&&i.open){const l=s("transfer.meta"),u=s("transfer.receivedCount"),f=s("playlist.currentTrackIndex");i.send({type:p.REQUEST_DATA_RECOVERY,nextChunk:u||0,fileName:l?.name||"",index:f})}}},1e4),r.on("open",()=>{ae&&(clearTimeout(ae),ae=null),m("relay.upstreamDataConn",r),d.info("[Relay] Connected to upstream relay"),c.emit("ui:show-toast","Relay 연결됨"),r.on("data",i=>{c.emit("network:data",i,r)}),r.send({type:p.REQUEST_CURRENT_FILE})}),r.on("error",i=>{d.warn("[Relay] Connection error:",i),ae&&(clearTimeout(ae),ae=null)}),r.on("close",()=>{m("relay.upstreamDataConn",null),c.emit("ui:show-toast","Relay 연결 해제");const i=s("transfer.meta"),l=s("transfer.receivedCount"),u=i?.total||0;if(l<u){const f=s("network.hostConn");f&&f.open&&c.emit("storage:request-recovery")}})}function wi(e){e.on("open",()=>{d.debug("[Relay] Accepted downstream connection from",e.peer);const t=s("relay.downstreamDataPeers");t.find(n=>n.peer===e.peer)||(t.push(e),m("relay.downstreamDataPeers",t))}),e.on("data",t=>{const n=t;n.type===p.REQUEST_CURRENT_FILE?c.emit("relay:serve-current-file",e,n):n.type===p.REQUEST_DATA_RECOVERY&&c.emit("relay:serve-recovery",e,n)}),e.on("close",()=>{We(e.peer,"downstream disconnected");const t=s("relay.downstreamDataPeers");m("relay.downstreamDataPeers",t.filter(n=>n.peer!==e.peer))})}function ki(e){const t=e.targetId,n=s("network.myId");if(t&&t!==n)vi(t);else if(t===n)d.warn("[Relay] Ignored self-assignment request from Host.");else if(t===null){d.debug("[Relay] Fallback to Host requested.");const o=s("relay.upstreamDataConn");o&&(o.close(),m("relay.upstreamDataConn",null)),c.emit("storage:request-recovery")}}function Ii(){J({[p.ASSIGN_DATA_SOURCE]:ki}),c.on("relay:incoming-connection",((...e)=>{const t=e[0];t&&wi(t)})),c.on("relay:serve-current-file",((...e)=>{const t=e[0],n=e[1];if(!t||!t.open)return;const o=n.name?String(n.name):"",r=n.index!==void 0?Number(n.index):void 0,a=s("files.currentFileBlob"),i=s("preload.nextFileBlob"),l=s("transfer.meta"),u=s("preload.meta"),f=s("playlist.currentTrackIndex"),y=a&&(!o||l&&l.name===o),h=i&&(r!==void 0&&u?.index===r||o&&u?.name===o||!o&&u?.index===f);if(y){d.debug(`[Relay] Serving current file to ${t.peer}: ${l?.name}`);const g=Zt(a,l?.name||"Track");g&&mt(t,g,0).catch(E=>d.error("[Relay] unicast current failed:",E))}else if(h){d.debug(`[Relay] Serving preloaded file to ${t.peer}: ${u?.name}`);const g=Zt(i,u?.name||"Track");g&&mt(t,g,0).catch(E=>d.error("[Relay] unicast preload failed:",E))}else if(l?.name){const g=s("transfer.receivedCount"),E=l.name||o;d.debug(`[Relay] Bootstrapping downstream for ${E} (${g}/${l.total||"?"})`),t.send({...l,type:p.FILE_START,name:E,sessionId:l.sessionId||s("transfer.localSessionId")}),g>0&&Ei(t,{filename:E,sessionId:l.sessionId||s("transfer.localSessionId"),endIndexExclusive:g})}else d.debug("[Relay] No matching data yet for",o||"current"),t.send({type:p.FILE_WAIT,message:"Relay source not ready yet"})})),c.on("relay:serve-recovery",((...e)=>{const t=e[0],n=e[1];if(!t||!t.open)return;const o=n.fileName||n.name||"",r=Number(n.nextChunk)||0,a=n.sessionId||s("transfer.localSessionId");d.debug(`[Relay Recovery] Peer ${t.peer} requested chunk ${r} of ${o}`),N({command:"OPFS_READ",filename:o,index:r,isPreload:!1,sessionId:a,requestId:`${t.peer}|recovery`})})),c.on("opfs:read-complete",((...e)=>{const t=e[0];if(!t)return;const n=t.chunk,o=t.index,r=t.filename,a=t.requestId||"",i=t.sessionId,l=a.lastIndexOf("|"),u=l>0?a.slice(0,l):a,f=l>0?a.slice(l+1):"";if(!u||!n)return;const y=s("transfer.localSessionId");if(i&&i<y){d.warn(`[OPFS_READ] Stale session chunk discarded (got ${i}, current ${y})`);return}const g=s("relay.downstreamDataPeers").find(E=>E.peer===u);if(g&&g.open){const E=s("transfer.meta");try{g.send({type:p.FILE_CHUNK,chunk:n,index:o,sessionId:i,total:E?.total,name:E?.name||r})}catch(v){d.warn(`[Relay] Send chunk to ${u} failed:`,v)}}Ti(u,i,f)})),d.info("[Relay] Handlers registered")}const be=new Map;let Hn=0;const Pi=128;function sr(e=500){P("preloadScheduleTimer"),X("preloadScheduleTimer",()=>{Ci()},e)}async function Ci(){const e=s("playlist.items");if(e.length<=1)return;const t=s("playlist.currentTrackIndex"),n=s("playlist.repeatMode"),o=s("playlist.isShuffle"),r=Kt();m("preload.sessionId",r);let a=-1;if(n===2)a=t;else if(o&&e.length>1)do a=Math.floor(Math.random()*e.length);while(a===t);else o&&e.length===1?a=0:(a=t+1,a>=e.length&&(n===1?a=0:a=-1));if(m("preload.nextTrackIndex",a),a<0||a>=e.length){m("preload.isPreloading",!1),m("preload.nextFileBlob",null),m("preload.meta",null);return}const i=e[a];if(!i){m("preload.isPreloading",!1);return}if(i.type==="youtube"){m("preload.isPreloading",!1),m("preload.nextFileBlob",null),m("preload.meta",null);return}const l=i.file;if(!l)return;d.debug("[Preload] Starting for:",l.name,"session:",r),m("preload.isPreloading",!0);const u=Math.ceil(l.size/oe);m("preload.nextFileBlob",l),m("preload.meta",{name:l.name,index:a,mime:l.type,total:u,size:l.size,sessionId:r}),await _i(l,a,r),s("preload.sessionId")===r&&m("preload.isPreloading",!1)}async function _i(e,t,n){const o=oe,r=Math.ceil(e.size/o),a={type:p.PRELOAD_START,name:e.name,mime:e.type,total:r,size:e.size,index:t,sessionId:n},l=s("network.connectedPeers").filter(f=>f.status==="connected"&&f.conn?.open&&f.isDataTarget!==!1);if(l.length===0)return;const u=l.filter(f=>{const y=f.preloadedIndexes;return!y||!y.has(t)});l.forEach(f=>{const y=f.conn,h=u.includes(f);y.open&&y.send({...a,skipped:!h})});for(let f=0;f<r;f++){if(s("preload.sessionId")!==n)return;let y=!0;for(;y;){y=!1;for(const w of l){const I=w.conn;if(I.open&&I.dataChannel&&I.dataChannel.bufferedAmount>256*1024){y=!0;break}}y&&await new Promise(w=>setTimeout(w,ue.BACKPRESSURE))}const h=f*o,g=Math.min(h+o,e.size),E=await e.slice(h,g).arrayBuffer(),v=new Uint8Array(E),k={type:p.PRELOAD_CHUNK,chunk:v,index:f,sessionId:n};u.forEach(w=>{const I=w.conn;I.open&&I.send(k)})}if(s("preload.sessionId")===n){const f={type:p.PRELOAD_END,name:e.name,index:t,sessionId:n};l.forEach(y=>{const h=y.conn;h.open&&h.send(f)}),d.debug("[Preload] Complete for index:",t)}}async function Ri(e,t,n,o){if(!e||!e.open||!t)return;const r=oe,a=Math.ceil(t.size/r),i="name"in t?t.name:"Track";e.send({type:p.PRELOAD_START,name:i,mime:t.type,total:a,size:t.size,index:n,sessionId:o,skipped:!1});for(let l=0;l<a;l++){if(!e.open)return;for(;e.open&&e.dataChannel&&e.dataChannel.bufferedAmount>256*1024;)await new Promise(y=>setTimeout(y,ue.BACKPRESSURE));if(!e.open)return;const u=l*r,f=await t.slice(u,Math.min(u+r,t.size)).arrayBuffer();e.send({type:p.PRELOAD_CHUNK,chunk:new Uint8Array(f),index:l,sessionId:o})}e.open&&e.send({type:p.PRELOAD_END,name:i,index:n,sessionId:o})}function Ai(e){const t=e.sessionId;if(!t){d.warn("[Preload] Start message missing sessionId. Ignoring.");return}if(P("prepareWatchdog"),Hn=t,e.skipped){d.debug(`[Preload] Skipping session ${t}`),s("preload.sessionState").set(t,{skipped:!0,progress:0,total:e.total||0,name:e.name||"",index:e.index||0,size:e.size||0,mime:e.mime||"",nextExpectedChunk:0,finalized:!1});try{be.delete(t)}catch{}return}m("transfer.waitingForPreload",!1),d.debug(`[Preload] Start: ${e.name} (index: ${e.index}, total: ${e.total})`),s("preload.sessionState").set(t,{skipped:!1,progress:0,total:e.total||0,name:e.name||"",index:e.index||0,size:e.size||0,mime:e.mime||"",nextExpectedChunk:0,finalized:!1}),m("preload.meta",{name:e.name,index:e.index,mime:e.mime,total:e.total,size:e.size,sessionId:t}),m("preload.count",0),N({command:"OPFS_RESET",isPreload:!0}),N({command:"OPFS_START",filename:e.name,isPreload:!0,sessionId:ne(t),size:oe});try{ir(t)}catch{}s("relay.downstreamDataPeers").forEach(r=>{r.open&&r.send(e)}),P("preloadWatchdog"),X("preloadWatchdog",()=>{if(d.warn("[Preload] Watchdog: forcing preload loader reset after 30s"),c.emit("ui:show-loader",!1),m("transfer.waitingForPreload",!1),s("transfer.state")===W.RECEIVING){const a=s("transfer.meta"),i=s("transfer.receivedCount"),l=a?.total||0;if(l>0){const u=Math.round(i/l*100);c.emit("ui:update-loader",u)}}},3e4)}function ir(e){const n=s("preload.sessionState").get(e);if(!n||n.skipped)return;const o=be.get(e);if(!o)return;let r=n.nextExpectedChunk||0;for(;o.has(r);){const u=o.get(r),f=new Uint8Array(u),y=n.name;if(!y)break;const h=s("relay.downstreamDataPeers");if(h.length>0){const g=new Uint8Array(u),E={type:p.PRELOAD_CHUNK,chunk:g,index:r,sessionId:e};h.forEach(v=>{v.open&&v.send(E)})}N({command:"OPFS_WRITE",chunk:f.buffer,index:r,isPreload:!0,filename:y,sessionId:ne(e)}),o.delete(r),r++}n.nextExpectedChunk=r,n.progress=r,m("preload.count",n.progress);const a=s("preload.meta");a&&a.total>0&&(P("preloadWatchdog"),X("preloadWatchdog",()=>{const u=s("transfer.state");(u===W.READY||u===W.IDLE)&&c.emit("ui:show-loader",!1)},15e3));const i=n.total||0,l=n.size||0;i>0&&n.progress>=i&&(n.finalized||(d.debug(`[Preload] All chunks received (${n.progress}/${i}). Finalizing...`),n.finalized=!0,N({command:"OPFS_END",filename:n.name,isPreload:!0,sessionId:e,totalSize:l}),be.delete(e)))}function Li(e){let t=e.sessionId;if(!t&&Hn!==0&&(t=Hn),!t)return;const o=s("preload.sessionState").get(t);if(o?.skipped||o?.finalized)return;be.has(t)||be.set(t,new Map);const r=be.get(t);if(r.set(e.index,new Uint8Array(e.chunk)),!o){r.size>Pi&&(d.warn(`[Preload] Too many early chunks without session state (SID: ${t}). Dropping.`),be.delete(t));return}ir(t)}function xi(e){const t=e.sessionId;if(!t)return;const o=s("preload.sessionState").get(t);if(!o||o.skipped)return;o.finalized||(o.finalized=!0,N({command:"OPFS_END",filename:o.name,isPreload:!0,sessionId:ne(t),totalSize:o.size})),be.delete(t),d.debug(`[Preload] End: ${o.name} (${o.progress}/${o.total} chunks)`);const r=s("network.hostConn");if(r&&r.open&&e.index!==void 0){const i=s("preload.ackSent");i.has(e.index)||(i.add(e.index),r.send({type:p.PRELOAD_ACK,index:e.index}))}s("relay.downstreamDataPeers").forEach(i=>{i.open&&i.send(e)}),c.emit("storage:preload-ready",e.index)}function Oi(e,t){if(s("network.hostConn"))return;const r=s("network.connectedPeers").find(a=>a.id===t.peer);if(r&&e.index!==void 0){const a=r.preloadedIndexes;a&&(a.add(Number(e.index)),d.debug(`[Host] Marked index ${e.index} as CACHED for peer ${r.label}`))}}function Ni(e){const t=e.index;d.debug("[Guest] Command: Play Preloaded Track, index:",t),e.index!==void 0&&m("playlist.currentTrackIndex",t),c.emit("storage:play-preloaded",t,e.name,e)}function Ui(){J({[p.PRELOAD_START]:Ai,[p.PRELOAD_CHUNK]:Li,[p.PRELOAD_END]:xi,[p.PRELOAD_ACK]:Oi,[p.PLAY_PRELOADED]:Ni}),c.on("storage:preload-file-ready",(async(...e)=>{const t=e[0],n=e[1];d.debug(`[Preload] OPFS preload ready: ${t} (SID: ${n})`);const o=await Jo(t,!0);if(!o){d.error("[Preload] Failed to read preload file from OPFS:",t);return}m("preload.nextFileBlob",o);const a=s("preload.sessionState").get(n),i=s("preload.meta");m("preload.meta",a||i);const l=a?.index??i?.index??-1;m("preload.nextTrackIndex",l);const u=s("transfer.waitingForPreload"),f=s("recovery.pendingFileIndex");u&&f===l&&(d.debug("[Preload] Guest was waiting for this track. Playing now."),m("transfer.waitingForPreload",!1),c.emit("ui:show-loader",!1),c.emit("storage:play-preloaded",l,t,{}))})),c.on("storage:preload-ready",((...e)=>{const t=e[0];d.debug(`[Preload] Preload ready for index: ${t}`)})),d.info("[Preload] Handlers registered")}function Bi(e=null){if(s("recovery.pending")){d.debug("[Recovery] Request already pending, skipping");return}const n=s("recovery.retryCount");if(n>=En){d.error(`[Recovery] Max retries (${En}) exceeded. Giving up.`),P("chunkWatchdog"),m("transfer.state",W.IDLE),m("recovery.pending",!1),m("recovery.retryCount",0),c.emit("ui:show-loader",!1);return}const o=s("relay.upstreamDataConn"),r=s("network.hostConn"),a=o&&o.open?o:r;if(!a||!a.open){d.warn("[Recovery] No healthy connection for recovery");return}const i=s("transfer.meta"),l=s("recovery.pendingFileName"),u=s("recovery.pendingFileIndex"),f=s("playlist.currentTrackIndex"),y=s("transfer.receivedCount"),h=s("transfer.localSessionId"),g=s("transfer.currentSessionId"),E=i?.name||l||"",v=u!==void 0?u:f,k=h||g;let w=e;w===null&&(w=y||0);const I=To[Math.min(n,To.length-1)];m("recovery.retryCount",n+1),m("recovery.pending",!0);const A=a===o?"Relay":"Host";d.debug(`[Recovery] Attempt ${n+1}/${En} from ${A}: ${E} (Chunk: ${w}, backoff: ${I}ms)`),setTimeout(()=>{if(m("recovery.pending",!1),!a.open){d.warn("[Recovery] Connection closed during backoff");return}const x=s("transfer.meta")?.name||s("recovery.pendingFileName")||"";if(x&&E&&x!==E){d.debug("[Recovery] Track changed during backoff, aborting stale recovery"),m("recovery.retryCount",0);return}a.send({type:p.REQUEST_DATA_RECOVERY,nextChunk:w,fileName:E,index:v,sessionId:k})},I)}async function Di(e,t){if(s("network.hostConn")||!t||!t.open)return;if(s("appState")===b.PLAYING_YOUTUBE){try{t.send({type:p.FILE_WAIT,message:"Host is playing YouTube"})}catch{}return}const r=e.name?String(e.name):"",a=e.index!==void 0?Number(e.index):void 0,i=ar(r,a);if(!i){try{t.send({type:p.FILE_WAIT,message:"Host file is not ready yet"})}catch{}return}const l=cr(),u=lr(i,r),f=Zt(i,u);f&&await mt(t,f,0,l)}async function Fi(e,t){if(s("network.hostConn")||!t||!t.open)return;let o=0;if(e.nextChunk!==void 0){const h=Number(e.nextChunk);Number.isFinite(h)&&h>0&&(o=Math.floor(h))}const r=e.fileName||e.name?String(e.fileName||e.name):"",a=e.index!==void 0?Number(e.index):void 0,i=ar(r,a);if(!i){try{t.send({type:p.FILE_WAIT,message:"Host has no cached file for recovery yet"})}catch{}return}const l=Math.ceil(i.size/oe);if(!Number.isFinite(l)||l<=0){try{t.send({type:p.FILE_WAIT,message:"Invalid file size"})}catch{}return}o>=l&&(o=Math.max(0,l-1));const u=cr(),f=lr(i,r),y=Zt(i,f);y&&await mt(t,y,o,u)}function ar(e,t){const n=s("files.currentFileBlob"),o=s("transfer.meta"),r=s("preload.nextFileBlob"),a=s("preload.meta");let i=null;if(n){const l=t!==void 0&&o&&Number(o.index)===t,u=e&&o&&o.name===e;(l||u||!e&&t===void 0)&&(i=n)}if(!i&&r&&a){const l=t!==void 0&&Number(a.index)===t,u=e&&a.name===e;(l||u)&&(i=r)}return i||(i=n||r),i}function cr(){const e=s("transfer.meta");let t=s("transfer.currentSessionId"),n=e?.sessionId||t;return(!n||n<1)&&(n=Kt(),m("transfer.currentSessionId",n)),n}function lr(e,t){const n=s("files.currentFileBlob"),o=s("transfer.meta"),r=s("preload.nextFileBlob"),a=s("preload.meta");return e===n&&o?.name?o.name:e===r&&a?.name?a.name:t||o?.name||a?.name||"Track"}function Mi(){J({[p.REQUEST_CURRENT_FILE]:Di,[p.REQUEST_DATA_RECOVERY]:Fi}),c.on("storage:request-recovery",()=>{Bi()}),d.info("[Recovery] Handlers registered")}let Io=null;const de={_activeURL:null,_preparingURL:null,_pendingRevocations:new Map,_deferredUntilDetached:new Set,MAX_PENDING:5,_isUrlAttached(e){try{return!!(e&&Io&&Io.src===e)}catch{return!1}},_clearScheduled(e){const t=this._pendingRevocations.get(e);if(t)try{clearTimeout(t)}catch{}this._pendingRevocations.delete(e)},_revokeNow(e,t=""){if(e){this._clearScheduled(e),this._deferredUntilDetached.delete(e);try{URL.revokeObjectURL(e),d.debug(`[BlobURL] Revoked: ${e}${t?` (${t})`:""}`)}catch(n){d.debug("[BlobURL] Revoke failed (non-critical):",n)}this._activeURL===e&&(this._activeURL=null),this._preparingURL===e&&(this._preparingURL=null)}},create(e){return e?(this._preparingURL&&this._revokeNow(this._preparingURL,"abandoned-preparing"),this._preparingURL=URL.createObjectURL(e),d.debug(`[BlobURL] Prepared: ${this._preparingURL}`),this._preparingURL):null},confirm(){if(!this._preparingURL)return;const e=this._preparingURL,t=this._activeURL;this._activeURL=e,this._preparingURL=null,t&&t!==e&&this.safeRevoke(t),d.debug(`[BlobURL] Confirmed Active: ${this._activeURL}`)},safeRevoke(e,t){if(!e)return;const n=t?.force===!0,o=typeof t?.delayMs=="number"&&t.delayMs>=0?t.delayMs:ue.BLOB_REVOCATION;if(this._pendingRevocations.has(e))return;if(!n&&this._isUrlAttached(e)){this._deferredUntilDetached.add(e),d.debug(`[BlobURL] Deferred revocation (still attached): ${e}`);return}if(this._pendingRevocations.size>=this.MAX_PENDING){const a=this._pendingRevocations.keys().next().value;this._isUrlAttached(a)?(this._deferredUntilDetached.add(a),this._pendingRevocations.delete(a)):this._revokeNow(a,"queue-overflow")}if(o===0){this._revokeNow(e,"delay=0");return}const r=setTimeout(()=>{this._revokeNow(e,"scheduled")},o);this._pendingRevocations.set(e,r),d.debug(`[BlobURL] Scheduled for revocation (${o}ms): ${e}`)},flushDeferred(e=""){if(!this._deferredUntilDetached.size)return;const t=Array.from(this._deferredUntilDetached);let n=0;for(const o of t)this._isUrlAttached(o)||(this._deferredUntilDetached.delete(o),this.safeRevoke(o,{force:!0}),n++);n&&d.debug(`[BlobURL] Flushed deferred: ${n}${e?` (${e})`:""}`)},revoke(e){this._preparingURL&&this.safeRevoke(this._preparingURL,{force:!0,delayMs:0}),this._activeURL&&this.safeRevoke(this._activeURL,e)},revokeAllNow(e="force"){for(const t of Array.from(this._pendingRevocations.keys()))this._revokeNow(t,e);for(const t of Array.from(this._deferredUntilDetached))this._revokeNow(t,e);this._activeURL&&this._revokeNow(this._activeURL,e),this._preparingURL&&this._revokeNow(this._preparingURL,e),this._pendingRevocations.clear(),this._deferredUntilDetached.clear(),this._activeURL=null,this._preparingURL=null},get activeURL(){return this._activeURL}};let ye=null;function V(){return ye}function H(e){return e===b.IDLE||e===b.PAUSED}const Yi=["mp4","mkv","webm","mov"];function dn(e,t){if(!e)return!1;if(e.type&&e.type.startsWith("video/")||t&&(typeof t.mime=="string"&&t.mime.startsWith("video/")||typeof t.type=="string"&&t.type.startsWith("video/")))return!0;const o=(t?.name||e.name||"").split(".").pop()?.toLowerCase()||"";return Yi.includes(o)}function co(e){d.debug(`[Engine] Switching mode to: ${e}`);let t;switch(e){case"video":t=b.PLAYING_VIDEO;break;case"youtube":t=b.PLAYING_YOUTUBE;break;case"buffer":case"audio":t=b.PLAYING_AUDIO;break;default:t=b.IDLE}const n=s("appState"),o=H(n)?b.PAUSED:t,r=e==="youtube"?t:o;m("appState",r),c.emit("player:state-changed",r),c.emit("ui:update-playlist")}function $i(e){const t=document.body;t.classList.remove("mode-video","mode-youtube","mode-audio");const n=ye,o=s("files.currentFileBlob"),r=s("transfer.meta"),a=H(e)&&n&&!!n.src&&dn(o,r),i=e===b.PLAYING_VIDEO||e===b.PLAYING_YOUTUBE||a;i&&t.classList.add("mode-video"),e===b.PLAYING_YOUTUBE&&t.classList.add("mode-youtube"),e===b.PLAYING_AUDIO&&t.classList.add("mode-audio");const l=document.getElementById("youtube-player-container");l&&(l.style.opacity="0",l.style.pointerEvents="none",l.style.display="none");const u=document.querySelector(".video-wrapper");if(u&&(u.style.display=i?"flex":"none",i&&(u.style.visibility="visible",u.style.pointerEvents="auto")),n){const f=e===b.PLAYING_VIDEO||a;n.style.display=f?"block":"none"}e===b.PLAYING_YOUTUBE&&l&&(l.style.display="block",l.style.opacity="1",l.style.pointerEvents="auto")}function Hi(){ye=document.getElementById("main-video"),ye||d.warn("[Video] #main-video element not found"),c.on("player:state-changed",((...e)=>{$i(e[0])})),c.on("player:sync-video-volume",((...e)=>{const t=Number(e[0]);if(!(!ye||!Number.isFinite(t)))if(ur())ye.volume=0,ye.muted=!0;else try{ye.volume=t}catch(n){d.debug("[Video] Volume set failed:",n)}})),d.info("[Video] Initialized")}let ee=null,C=null,Y=0,Be=0,et=!1,$,qt=!1;function ur(){return C}function Vi(e){C=e}function dr(){return++Y}function qi(){return Y}function Gi(e){$=e}function Wi(){return $}function Le(e){if(isNaN(e))return"0:00";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n<10?"0":""}${n}`}function j(){const e=s("appState"),t=s("player.pausedAt")||0;if(H(e))return t;if(e===b.PLAYING_YOUTUBE){let f=0;return c.emit("youtube:get-position",y=>{f=y}),f}const n=V(),o=C&&Number.isFinite(C.duration)?C.duration:n&&Number.isFinite(n.duration)?n.duration:0;let r=0;const a=s("player.startedAt")||0,i=s("sync.localOffset")||0,l=s("sync.autoSyncOffset")||0;return typeof a=="number"&&Number.isFinite(a)&&a>0&&typeof Tone<"u"&&Tone?.now?r=Tone.now()-a+i+l:n?.src&&n.readyState>=1&&(r=n.currentTime),isNaN(r)&&(r=0),r<0&&(r=0),o>0&&r>o&&(r=o),r}function Xe(e){c.emit("ui:update-play-state",e)}function Et(){if(ee)try{ee.onended=null,ee.stop(),ee.disconnect(),ee.dispose()}catch(e){d.warn("Error stopping/disposing playerNode:",e)}finally{ee=null}}function K(){const e=V();e&&(e.pause(),e.removeAttribute("src"),e.load());try{de.revoke()}catch{}try{de.flushDeferred("stopAllMedia")}catch{}c.emit("youtube:stop-mode"),P("preloadScheduleTimer"),P("autoPlayTimer"),m("appState",b.IDLE),c.emit("player:state-changed",b.IDLE),Xe(!1),c.emit("worker:sync-command",{command:"STOP_TIMER",id:"video-sync"}),Et(),m("relay.chunkQueue",[]),m("player.startedAt",0),m("player.pausedAt",0)}async function B(e){if(et){d.warn("[Play] Blocked: queuing play request"),$=e;return}et=!0;const t=setTimeout(()=>{et&&(d.warn("[Play] Lock Timeout: Forcing unlock after 5s"),et=!1)},5e3);try{await zi(e)}finally{clearTimeout(t),setTimeout(()=>{et=!1},10)}}async function zi(e){if($=void 0,s("appState")===b.PLAYING_YOUTUBE){d.warn("[Audio] Blocked play() call while in YouTube mode");return}if(typeof Tone>"u"||!Tone?.context){d.error("[Audio] Tone.js not loaded"),c.emit("ui:show-toast","오디오 엔진이 아직 준비되지 않았어요.");return}if(Tone.context.state!=="running")try{await Tone.context.resume()}catch(v){d.warn("Resume failed:",v)}const n=V();if(!!!n?.src?.startsWith("blob:")&&!!!C){d.warn("[Play] No media source available");return}try{await Oe()}catch(v){d.error("[Audio] initAudio failed:",v),c.emit("ui:show-toast","오디오 엔진을 준비하지 못했어요");return}let a=Number(e);(!Number.isFinite(a)||a<0)&&(a=0);const i=C&&Number.isFinite(C.duration)?C.duration:n&&Number.isFinite(n.duration)?n.duration:0;if(i>0&&(a>i&&(a=i),a===i&&(a=Math.max(0,i-.001))),C){Et(),ee=new Tone.BufferSource(C);const v=s("audio.isSurroundMode"),k=s("audio.surroundChannelIndex");if(v)c.emit("audio:connect-surround",ee,k),d.debug(`[BufferMode] Playing in 7.1 Surround (Ch: ${k})`);else{const I=Wo();I&&ee.connect(I),d.debug("[BufferMode] Playing in Stereo")}const w=Y;ee.onended=()=>{if(w!==Y)return;const I=s("appState");(I===b.PLAYING_AUDIO||I===b.PLAYING_VIDEO)&&fr()},ee.start(Tone.now(),a),n?.src&&(n.currentTime=a,n.muted=!0,n.volume=0,n.play().catch(()=>{}))}const l=s("sync.localOffset")||0,u=s("sync.autoSyncOffset")||0,f=Tone.now()-(a-(l+u));m("player.startedAt",f),m("player.pausedAt",a),d.debug(`[BufferMode] Started at ${a}s (startedAt: ${f})`),Xe(!0);const y=s("transfer.meta"),h=s("files.currentFileBlob"),g=dn(h,y),E=g?b.PLAYING_VIDEO:b.PLAYING_AUDIO;m("appState",E),c.emit("player:state-changed",E),c.emit("visualizer:start"),g&&c.emit("worker:sync-command",{command:"START_TIMER",id:"video-sync",interval:2e3}),c.emit("ui:loop-start")}function fn(e){const t=s("appState");if(H(t))return;let n;typeof e=="number"&&isFinite(e)&&e>=0?n=e:n=j(),Et();const o=V();if(o){try{o.pause()}catch{}try{o.currentTime=n}catch{}}m("appState",b.PAUSED),m("player.pausedAt",n),c.emit("player:state-changed",b.PAUSED),Xe(!1),c.emit("ui:show-toast","일시정지"),c.emit("worker:sync-command",{command:"STOP_TIMER",id:"video-sync"})}function fr(){if(s("network.hostConn"))return;const t=s("appState"),n=V(),o=!!(C&&Number.isFinite(C.duration)&&C.duration>.5),r=t===b.PLAYING_VIDEO||t===b.PLAYING_AUDIO;if(!o&&r&&n&&n.readyState<1)return;const a=o?C.duration:n?n.duration:0;if(!a||!Number.isFinite(a)||a<=.5||!n||H(t)||t===b.PLAYING_YOUTUBE)return;const i=j();if(s("player.isSeeking")){d.debug("[handleEnded] Ignoring end signal while seeking");return}i>=a-.2&&(d.debug(`Track ended at ${i.toFixed(2)}s / ${a.toFixed(2)}s`),K(),m("player.pausedAt",0),c.emit("ui:seek-reset"),c.emit("player:ended"))}function Ce(){const e=s("network.hostConn"),t=s("network.isOperator");if(e&&!t){c.emit("ui:show-toast","호스트만 조작할 수 있어요");return}const n=s("appState");if(n===b.PLAYING_YOUTUBE){c.emit("youtube:toggle-play");return}const o=n===b.PLAYING_AUDIO||n===b.PLAYING_VIDEO,r=s("player.pausedAt")||0,a=s("playlist.currentTrackIndex");!e&&cs("autoPlayTimer")&&(P("autoPlayTimer"),c.emit("ui:show-toast","자동 재생을 취소했어요")),o?e?t&&e.send({type:p.REQUEST_PAUSE}):(fn(),T({type:p.PAUSE,time:s("player.pausedAt")})):e?t&&e.send({type:p.REQUEST_PLAY,time:r}):(B(r),T({type:p.PLAY,time:r,index:a}),Te())}function pr(){const e=s("network.hostConn"),t=s("network.isOperator");if(e&&!t){c.emit("ui:show-toast","호스트만 조작할 수 있어요");return}if(e&&t){try{e.send({type:p.REQUEST_SEEK,time:0})}catch{}try{e.send({type:p.REQUEST_PAUSE})}catch{}c.emit("ui:show-toast","정지 요청을 보냈어요");return}if(s("appState")===b.PLAYING_YOUTUBE){c.emit("youtube:stop-playback"),m("player.pausedAt",0),Xe(!1);return}K(),c.emit("ui:seek-reset"),e||T({type:p.PAUSE,time:0}),c.emit("ui:show-toast","정지")}function nn(e){const t=s("network.hostConn"),n=s("network.isOperator");if(t&&!n){c.emit("ui:show-toast","호스트만 조작할 수 있어요");return}if(t&&n){t.send({type:p.REQUEST_SKIP_TIME,sec:e});return}const o=s("appState");if(o===b.PLAYING_YOUTUBE){c.emit("youtube:skip-time",e);return}let a=j()+e;const i=V(),l=C?.duration??(i&&isFinite(i.duration)?i.duration:0);a<0&&(a=0),l>0&&a>l&&(a=l);const u=s("playlist.currentTrackIndex");o===b.PLAYING_AUDIO||o===b.PLAYING_VIDEO?(B(a),T({type:p.PLAY,time:a,index:u}),Te()):(m("player.pausedAt",a),T({type:p.PAUSE,time:a}))}function Qi(e){const t=s("sync.localOffset")||0;m("sync.localOffset",t+e),c.emit("sync:display-update");const n=s("appState");if(!H(n))B(j());else{const o=s("player.pausedAt")||0;m("player.pausedAt",o+e)}}function mr(){const e=s("appState");if(H(e)||e===b.PLAYING_YOUTUBE)return;const t=V();if(!t?.src)return;const n=j(),o=t.currentTime,r=Math.abs(o-n);if(r>.3){if(t.seeking)return;d.debug(`[SyncCheck] Correcting video drift: ${r.toFixed(3)}s`),r>=1.9&&t.paused&&(d.warn("[SyncCheck] Video appears frozen. Attempting kickstart..."),t.play().catch(()=>{})),t.currentTime=n}}async function yr(e,t=null,n=!1,o){Be++;const r=Be,a=o??Y;c.emit("ui:show-loader",!0,`준비 중: ${e.name}`),K(),s("appState")===b.PLAYING_YOUTUBE&&c.emit("youtube:stop-mode");try{await Oe(),Tone.context.state==="suspended"&&await Tone.start();const l=de.create(e)||"";m("files.currentFileBlob",e),d.debug("[BufferMode] Decoding audio for high-precision sync..."),c.emit("ui:show-toast","고정밀 동기화: 오디오를 준비하고 있어요…");const u=await e.arrayBuffer(),f=await Tone.context.decodeAudioData(u);if(o!==void 0&&Y!==a){r===Be&&(d.warn("[Load] Token mismatch after decode. Aborting stale load."),c.emit("ui:show-loader",!1));return}if(C&&(C=null),r!==Be){d.debug("[Load] Stale loading session detected. Aborting.");return}C=f,d.debug(`[BufferMode] Loaded ${f.duration.toFixed(2)}s into RAM.`),f.duration&&isFinite(f.duration)&&c.emit("ui:duration-update",f.duration);const y=V();y&&(y.src=l,y.muted=!0);const h=s("playlist.currentTrackIndex");if(m("transfer.meta",{name:e.name,type:e.type,index:h}),c.emit("ui:update-playlist"),y){const k=()=>{if(y.removeEventListener("loadedmetadata",k),r!==Be)return;const w=C?C.duration:y.duration;w&&isFinite(w)&&c.emit("ui:duration-update",w),de.confirm()};y.addEventListener("loadedmetadata",k),y.load()}const g=s("network.hostConn"),E=s("network.isOperator");c.emit("ui:play-btn-state",!(g&&!E)),(s("network.connectedPeers")||[]).length>0&&t&&(c.emit("ui:show-toast","파일을 보내고 있어요…"),gi(e,t)),g||sr()}catch(l){d.error(l),c.emit("ui:show-toast",`Load Failed: ${l.message}`)}finally{r===Be&&(c.emit("ui:show-loader",!1),m("player.pausedAt",0),Xe(!1));const l=s("network.hostConn"),u=s("network.isOperator");c.emit("ui:play-btn-state",!l||u)}}async function Ke(e,t){const n=s("preload.meta"),o=s("playlist.currentTrackIndex"),r=e??n?.index??o,a=t??Y,i=s("preload.nextFileBlob"),l=n?{...n}:null;if(!i){d.warn("[Preload] No preloaded blob found in cache!");return}qt=!0;try{if(await Oe(),e!==void 0&&o!==-1&&o!==r){d.warn(`[Preload] Index mismatch! Expected ${r}, current is ${o}. Aborting.`);return}C&&(C=null),d.debug("[Preload] Decoding audio for Buffer Mode..."),c.emit("ui:show-toast","오디오 디코딩 중...");const u=await i.arrayBuffer(),f=await Tone.context.decodeAudioData(u);if(t!==void 0&&Y!==a){d.warn("[Preload] Token mismatch after decode. Discarding.");return}if(e!==void 0&&o!==-1&&s("playlist.currentTrackIndex")!==r){d.warn("[Preload] Track changed during decode. Discarding.");return}const y=l||s("transfer.meta");m("files.currentFileBlob",i),m("transfer.meta",y),C=f,d.debug(`[BufferMode] Preloaded ${f.duration.toFixed(2)}s decoded.`);const h=dn(i,y);co(h?"video":"buffer");const g=de.create(i)||"",E=V();E&&(E.src=g,E.muted=!0);const v=f.duration;isFinite(v)&&c.emit("ui:duration-update",v),de.confirm(),E&&E.load(),m("preload.nextFileBlob",null),m("preload.meta",null),m("preload.nextTrackIndex",-1),d.debug("[Preload] Safe clear: nextFileBlob moved to current."),m("transfer.skipIncomingFile",!0),m("transfer.waitingForPreload",!1),P("prepareWatchdog"),P("chunkWatchdog"),P("preloadWatchdog");const k=s("network.hostConn");k?.open&&setTimeout(()=>{k.open&&k.send({type:p.GET_SYNC_TIME})},500),qt=!1;const w=s("sync.localOffset")||0,I=s("sync.autoSyncOffset")||0;if(k&&$!==void 0){const A=$+w+I;d.debug(`[Preload] Found pending play time, starting at ${A.toFixed(2)}s`),B(A),$=void 0}}catch(u){qt=!1,d.error("[Preload] Activation failed:",u),c.emit("ui:show-toast","프리로드 재생 실패 - 다시 로드합니다"),m("preload.nextFileBlob",null),m("preload.meta",null),m("preload.nextTrackIndex",-1),m("transfer.skipIncomingFile",!1),m("transfer.waitingForPreload",!1),P("preloadWatchdog");const f=s("network.hostConn"),y=s("playlist.items")||[],h=s("transfer.meta"),g=s("playlist.currentTrackIndex"),E=y[g]?.name||h?.name||"";f?.open&&f.send({type:p.REQUEST_CURRENT_FILE,name:E,index:g,reason:"preload_activation_failed"})}}function ji(e){const t=Number(e.time)||0,n=e.index;if(qt){$=t,d.debug(`[Guest] Preload in progress, queuing play time: ${t}`);return}const o=s("playlist.currentTrackIndex");if(n!==void 0&&n!==o){d.warn(`[Guest] Index mismatch: current=${o}, play=${n}`),$=t,m("playlist.currentTrackIndex",n),c.emit("ui:update-playlist");const u=s("preload.nextFileBlob"),f=s("preload.nextTrackIndex");if(u&&f===n){d.debug(`[Guest] Found preloaded track for index ${n}`),Y++,Ke(n,Y);return}const y=s("network.hostConn"),g=(s("playlist.items")||[])[n]?.name||"";y?.open&&y.send({type:p.REQUEST_CURRENT_FILE,name:g,index:n,reason:"index_mismatch"});return}const r=s("transfer.meta"),a=s("playlist.items")||[],i=e.name||a[o]?.name||"",l=r?.name||"";if(i&&l&&i!==l&&n!==void 0&&n!==o){d.warn(`[Guest] Stale audio detected: loaded=${l}, expected=${i}`),$=t;return}C||V()?.src?B(t):($=t,d.debug(`[Guest] Storing pending play time: ${t}`))}function Ki(e){const t=Number(e.time)||0;fn(t)}function Xi(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[Playback] Rejected request-play from non-OP: ${t?.peer}`);return}P("autoPlayTimer");const o=s("player.pausedAt")||0,r=Number(e.time)||o,a=s("playlist.currentTrackIndex");B(r),T({type:p.PLAY,time:r,index:a}),Te()}function Ji(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[Playback] Rejected request-pause from non-OP: ${t?.peer}`);return}P("autoPlayTimer"),fn(),T({type:p.PAUSE,time:s("player.pausedAt")})}}function Zi(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[Playback] Rejected request-seek from non-OP: ${t?.peer}`);return}const o=Number(e.time)||0,r=s("appState"),a=s("playlist.currentTrackIndex");if(r===b.PLAYING_YOUTUBE){c.emit("youtube:seek-to",o);return}if(r===b.PLAYING_AUDIO||r===b.PLAYING_VIDEO)B(o),T({type:p.PLAY,time:o,index:a});else{m("player.pausedAt",o);const i=V();if(i)try{i.currentTime=o}catch{}T({type:p.PAUSE,time:o})}Te()}function ea(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[Playback] Rejected request-skip-time from non-OP: ${t?.peer}`);return}const o=Number(e.sec)||0;nn(o)}function ta(e){const t=Number(e.time)||0;c.emit("ui:show-toast",`Host 강제 동기화: ${Le(t)}`),B(t)}async function na(e){if(!jo(e,["playlistMeta","currentTrackIndex"]))return;const t=e.playlistMeta,n=Number(e.currentTrackIndex),o=s("appState"),r=s("playlist.items")||[];if(!t||t.length===0){if(r.length===0&&o===b.IDLE)return;d.debug("[StatusSync] Received empty playlist, clearing local state"),m("playlist.items",[]),m("playlist.currentTrackIndex",-1),c.emit("ui:update-playlist"),K();return}if(e.repeatMode!==void 0){const l=s("playlist.repeatMode")||0;Number(e.repeatMode)!==l&&c.emit("playlist:set-repeat-mode",Number(e.repeatMode),!1)}if(e.isShuffle!==void 0){const l=s("playlist.isShuffle");!!e.isShuffle!==l&&c.emit("playlist:set-shuffle",!!e.isShuffle,!1)}(r.length!==t.length||r.some((l,u)=>l.name!==t[u]?.name))&&(d.debug("[StatusSync] Playlist out of sync, updating..."),m("playlist.items",t),c.emit("ui:update-playlist"));const i=s("playlist.currentTrackIndex");if(n!==-1&&n!==i){d.debug(`[StatusSync] Index mismatch: Host(${n}) vs Me(${i}). Correcting...`),K(),m("playlist.currentTrackIndex",n),c.emit("ui:update-playlist");const u=(s("playlist.items")||[])[n];if(u&&u.type!=="youtube"){const f=s("files.currentFileBlob"),y=!!(f&&f.size>0),h=s("preload.nextFileBlob"),g=s("preload.meta"),E=!!(h&&g&&(g.index===n||g.name===u.name));if(!y&&E){d.debug("[StatusSync] Required track found in preload cache. Activating..."),Y++,await Ke(n,Y);return}const v=s("transfer.meta"),k=y&&v&&v.name!==u.name;if(!y||k){d.debug("[StatusSync] Current track missing, requesting from host:",u.name),c.emit("ui:show-loader",!0,`파일 동기화 중: ${u.name}`),o===b.PLAYING_YOUTUBE&&c.emit("youtube:stop-mode");const w=s("network.hostConn");if(w?.open){const I=Math.random()*1e3+200;setTimeout(()=>{if(!w?.open)return;const A=s("files.currentFileBlob")||s("preload.nextFileBlob");s("playlist.currentTrackIndex")===n&&!A?w.send({type:p.REQUEST_DATA_RECOVERY,nextChunk:0,fileName:u.name,index:n}):A&&(d.debug("[StatusSync] Aborting recovery: file arrived during jitter"),c.emit("ui:show-loader",!1))},I)}}}else u&&u.type==="youtube"&&o!==b.PLAYING_YOUTUBE&&u.videoId&&(d.debug("[StatusSync] Switching to YouTube mode for late-joiner sync"),c.emit("youtube:load",u.videoId,u.playlistId||null,!0,0))}}function Po(e=""){d.debug(`[State Clear] Clearing previous track state. Reason: ${e}`);const t=s("playlist.items")||[],n=s("playlist.currentTrackIndex"),o=s("transfer.meta"),r=t[n]?.name||o?.name||"",a=window;if(e==="redundant-sync"&&r&&a._lastClearedTrackName===r){d.debug(`[State Clear] Skipping redundant clear for: ${r}`);return}if(a._lastClearedTrackName=r,P("chunkWatchdog"),P("prepareWatchdog"),m("relay.chunkQueue",[]),m("transfer.receivedCount",0),m("transfer.meta",{}),m("files.currentFileBlob",null),e==="redundant-sync")return;C&&(d.debug("[State Clear] Clearing currentAudioBuffer"),C=null),Et(),m("transfer.skipIncomingFile",!1),$=void 0;const i=s("appState");(i===b.PLAYING_AUDIO||i===b.PLAYING_VIDEO||i===b.PAUSED)&&(m("appState",b.IDLE),c.emit("player:state-changed",b.IDLE));const l=s("preload.ackSent");l&&l.clear(),de.revoke();const u=V();u&&(u.pause(),u.src="",u.load());try{de.flushDeferred("clearPreviousTrackState")}catch{}const f=s("files.currentFileOpfs");if(f.name){const y=s("preload.meta");f.name!==y?.name&&(N({command:"OPFS_RESET",isPreload:!1}),Xo(f.name,!1),f.name=null)}}async function oa(e){d.debug("[Guest] Finalizing with Buffer Mode..."),c.emit("ui:show-loader",!0,"오디오 메모리 로드 중...");try{await Oe(),Tone.context.state==="suspended"&&await Tone.start();const t=await e.arrayBuffer(),n=await Tone.context.decodeAudioData(t);C&&(C=null),C=n;const o=s("transfer.meta"),r=dn(e,o);co(r?"video":"buffer"),m("files.currentFileBlob",e);const a=de.create(e)||"",i=V();if(i&&(i.src=a,i.muted=!0),n.duration&&isFinite(n.duration)&&c.emit("ui:duration-update",n.duration),de.confirm(),i){const u=()=>{i.removeEventListener("loadedmetadata",u);const f=C?C.duration:i.duration;f&&isFinite(f)&&c.emit("ui:duration-update",f)};i.addEventListener("loadedmetadata",u),i.load()}if(m("transfer.state","READY"),m("transfer.skipIncomingFile",!1),P("prepareWatchdog"),P("chunkWatchdog"),s("network.hostConn")&&$!==void 0){const u=s("sync.localOffset")||0,f=s("sync.autoSyncOffset")||0,y=$+u+f;d.debug(`[Guest] Found pending play time after download, starting at ${y.toFixed(2)}s`),B(y),$=void 0}c.emit("ui:play-btn-state",!0)}catch(t){d.error("[Guest] Decoding failed",t),c.emit("ui:show-toast","오디오 디코딩 실패! 다시 요청합니다.");const n=s("network.hostConn"),o=s("playlist.currentTrackIndex"),a=(s("playlist.items")||[])[o]?.name||"";n?.open&&n.send({type:p.REQUEST_CURRENT_FILE,name:a,index:o,reason:"decoding_failed"})}finally{c.emit("ui:show-loader",!1)}}function hr(){J({[p.PLAY]:ji,[p.PAUSE]:Ki,[p.REQUEST_PLAY]:Xi,[p.REQUEST_PAUSE]:Ji,[p.REQUEST_SEEK]:Zi,[p.REQUEST_SKIP_TIME]:ea,[p.FORCE_SYNC_PLAY]:ta,[p.STATUS_SYNC]:na}),c.on("worker:timer-tick",((...e)=>{e[0]==="video-sync"&&mr()})),c.on("player:stop-all-media",(()=>{K()})),c.on("sync:get-position",((...e)=>{const t=e[0];typeof t=="function"&&t(j())})),c.on("sync:response",((...e)=>{const t=Number(e[0])||0,n=e[1],o=Number(e[2])||0,r=s("sync.localOffset")||0,a=t+o+r;if(n)C||V()?.src?B(a):(m("player.pausedAt",a),d.debug("[Sync] Host playing but no audio data yet, storing position"));else{if($!==void 0){m("player.pausedAt",a),d.debug("[Sync] Host paused, keeping pending play");return}K(),m("player.pausedAt",a)}const i=s("sync.usePingCompensation"),l=s("sync.lastLatencyMs")||0;i?c.emit("ui:show-toast",`자동 싱크 보정 완료, +${Math.round(l/2)}ms`):c.emit("ui:show-toast","직접 동기화 완료 (로컬 네트워크)")})),c.on("sync:nudge-apply",((...e)=>{const t=s("appState");(t===b.PLAYING_AUDIO||t===b.PLAYING_VIDEO)&&B(j())})),c.on("audio:surround-toggled",(()=>{const e=s("appState");(e===b.PLAYING_AUDIO||e===b.PLAYING_VIDEO)&&B(j())})),c.on("player:check-ended",(()=>{fr()})),c.on("storage:clear-previous-track",((...e)=>{const t=e[0]||"";Po(t)})),c.on("opfs:file-ready",(async(...e)=>{const t=e[0],n=e[1];if(e[2]){c.emit("storage:preload-file-ready",t,n);return}if(!s("network.hostConn"))return;const a=await Jo(t,!1);if(!a){d.error("[Playback] Failed to read OPFS file:",t),c.emit("ui:show-loader",!1);return}await oa(a)})),c.on("storage:use-preloaded",((...e)=>{const t=e[0],n=e[1];d.debug(`[Playback] Using preloaded track for index: ${t} (${n})`),m("transfer.skipIncomingFile",!0),m("transfer.waitingForPreload",!0),s("preload.nextFileBlob")?(m("transfer.waitingForPreload",!1),Y++,Ke(t,Y)):d.debug("[Playback] Preload blob not ready yet, waiting...")})),c.on("storage:transfer-progress",((...e)=>{const t=e[0];c.emit("ui:show-loader",!0,`수신 중... ${t}%`)})),c.on("storage:play-preloaded",(async(...e)=>{const t=e[0],n=e[1];if(d.debug(`[Playback] Play preloaded track, index: ${t}`),s("preload.nextFileBlob"))Y++,await Ke(t,Y);else{d.warn("[Playback] No preloaded blob for play-preloaded, requesting from host"),c.emit("ui:show-loader",!0,"파일 요청 중..."),Po("play-preloaded fallback");const r=s("network.hostConn"),a=s("playlist.items")||[],i=n||a[t]?.name||"";if(r?.open){const l=Math.random()*1e3+200;setTimeout(()=>{if(!r?.open)return;s("preload.nextFileBlob")||r.send({type:p.REQUEST_CURRENT_FILE,name:i,index:t})},l)}}})),c.on("network:peer-connected",((...e)=>{const t=e[0];if(!t?.open||s("network.hostConn"))return;const o=s("appState"),r=s("playlist.currentTrackIndex"),a=s("playlist.items")||[];if(r>=0&&a[r]&&a[r].type!=="youtube"){const l=s("files.currentFileBlob"),u=s("transfer.currentSessionId");l&&mt(t,l,0,u).catch(g=>d.error("[Host] unicastFile for late joiner failed",g));const f=s("preload.nextFileBlob"),y=s("preload.meta"),h=s("preload.nextTrackIndex");if(f&&y&&h>=0){const g=y.sessionId||0;Ri(t,f,h,g).catch(E=>d.error("[Host] unicastPreload for late joiner failed",E))}}try{const i=j();if(o===b.PLAYING_AUDIO||o===b.PLAYING_VIDEO){const l=a[r]||{},u=l.name||l.file?.name||null;t.send({type:p.PLAY,time:i,index:r,name:u,state:o,timestamp:Date.now()})}else o!==b.PLAYING_YOUTUBE&&t.send({type:p.PAUSE,time:i,index:r,state:o,timestamp:Date.now()});d.debug("[Playback] Bootstrap: sent playback state to new peer")}catch(i){d.warn("[Playback] Bootstrap send failed:",i)}})),d.info("[Playback] Engine initialized")}const ra=Object.freeze(Object.defineProperty({__proto__:null,adjustSync:Qi,checkVideoSync:mr,fmtTime:Le,getCurrentAudioBuffer:ur,getLoadToken:qi,getPendingPlayTime:Wi,getTrackPosition:j,incrementLoadToken:dr,initPlayback:hr,loadAndBroadcastFile:yr,loadPreloadedTrack:Ke,pause:fn,play:B,setCurrentAudioBuffer:Vi,setPendingPlayTime:Gi,skipTime:nn,stopAllMedia:K,stopPlayback:pr,stopPlayerNode:Et,togglePlay:Ce,updatePlayState:Xe},Symbol.toStringTag,{value:"Module"}));function sa(){const e=s("network.hostConn"),t=s("network.isOperator"),o=((s("playlist.repeatMode")||0)+1)%3;pn(o),e?t&&e.send({type:p.REQUEST_SETTING,settingType:"repeat-mode",value:o}):T({type:p.REPEAT_MODE,value:o})}function pn(e,t=!0){m("playlist.repeatMode",e);const n=document.getElementById("btn-repeat");n&&(n.classList.remove("active","active-one"),e===1?(n.classList.add("active"),t&&c.emit("ui:show-toast","반복 재생: 전체")):e===2?(n.classList.add("active-one"),t&&c.emit("ui:show-toast","반복 재생: 한 곡")):t&&c.emit("ui:show-toast","반복 재생: 끔"))}function ia(){const e=s("network.hostConn"),t=s("network.isOperator"),o=!s("playlist.isShuffle");mn(o),e?t&&e.send({type:p.REQUEST_SETTING,settingType:"shuffle-mode",value:o}):T({type:p.SHUFFLE_MODE,value:o})}function mn(e,t=!0){m("playlist.isShuffle",e);const n=document.getElementById("btn-shuffle");n&&n.classList.toggle("active",e),t&&c.emit("ui:show-toast",e?"셔플: 켜짐":"셔플: 꺼짐")}async function te(e){const t=s("playlist.items")||[];if(e<0||e>=t.length)return;P("autoPlayTimer"),m("preload.isPreloading",!1);const n=s("network.hostConn");n||c.emit("ui:switch-tab","play");const o=dr(),r=s("preload.nextTrackIndex"),a=s("preload.nextFileBlob");if(e===r&&a&&!n){d.debug("[Host] Using Preloaded Track:",e),m("playlist.currentTrackIndex",e),c.emit("ui:update-playlist"),c.emit("player:metadata-update",t[e]);const u=s("preload.meta");u?.sessionId&&Number.isFinite(Number(u.sessionId))?m("transfer.currentSessionId",Number(u.sessionId)):m("transfer.currentSessionId",Kt()),K();const f=t[e],y=f?.file?.name||f?.name||`Track ${e}`;T({type:p.PLAY_PRELOADED,index:e,name:y,mime:f?.file?.type}),await Ke(e,o),await B(0),T({type:p.PLAY,time:0,index:e,name:y}),Te(),sr();return}m("playlist.currentTrackIndex",e),c.emit("ui:update-playlist");const i=t[e];if(c.emit("player:metadata-update",i),i.type==="youtube"){n||(K(),T({type:p.YOUTUBE_PLAY,videoId:i.videoId,playlistId:i.playlistId,name:i.name||i.title,index:e,autoplay:!1}),s("player.isFirstTrackLoad")?(m("player.isFirstTrackLoad",!1),c.emit("youtube:load",i.videoId,i.playlistId,!1),c.emit("ui:show-toast","YouTube가 준비됐어요! 재생 버튼을 눌러 보세요.")):(c.emit("youtube:load",i.videoId,i.playlistId,!1),c.emit("ui:show-toast","3초 후 YouTube 재생..."),X("autoPlayTimer",()=>{c.emit("youtube:auto-play")},3e3)));return}K();const l=i.file;if(!l){d.warn("[Playlist] No file for track",e);return}if(!n){const u=Kt();m("transfer.currentSessionId",u),T({type:p.FILE_PREPARE,name:l.name,index:e,sessionId:u,mime:l.type}),await yr(l,u,!1,o),s("player.isFirstTrackLoad")?(m("player.isFirstTrackLoad",!1),c.emit("ui:show-toast","파일이 준비됐어요! 재생 버튼을 눌러 보세요.")):(c.emit("ui:show-toast","3초 후 재생 시작..."),X("autoPlayTimer",()=>{B(0);const y=s("playlist.currentTrackIndex");T({type:p.PLAY,time:0,index:y,name:l.name}),Te()},3e3))}}function Vn(){const e=s("network.hostConn"),t=s("network.isOperator");if(e&&!t){c.emit("ui:show-toast","호스트만 조작할 수 있어요");return}if(e&&t){e.send({type:p.REQUEST_NEXT_TRACK});return}if(s("appState")===b.PLAYING_YOUTUBE){let f=!1;if(c.emit("youtube:try-next-internal",y=>{f=y}),f)return}const o=s("playlist.items")||[],r=s("playlist.currentTrackIndex"),a=s("playlist.repeatMode")||0,i=s("playlist.isShuffle"),l=s("preload.nextTrackIndex");if(o.length===0)return;let u=-1;if(a===2)u=r;else if(i)if(o.length===1)u=0;else if(l!==-1&&l!==r&&l<o.length)u=l;else do u=Math.floor(Math.random()*o.length);while(u===r);else if(u=r+1,u>=o.length)if(a===1)u=0;else{d.debug("[Host] End of playlist reached (Repeat OFF). Stopping."),K(),T({type:p.PAUSE,time:0});return}u!==-1&&te(u)}function gr(){const e=s("network.hostConn"),t=s("network.isOperator");if(e&&!t){c.emit("ui:show-toast","호스트만 조작할 수 있어요");return}if(e&&t){e.send({type:p.REQUEST_PREV_TRACK});return}const n=s("appState"),o=s("playlist.currentTrackIndex");if(n===b.PLAYING_YOUTUBE){let a=!1;if(c.emit("youtube:try-prev-internal",i=>{a=i}),a)return;o>0?te(o-1):te(0);return}if(j()>3){B(0),T({type:p.PLAY,time:0,index:o});return}o>0?te(o-1):te(0)}function aa(e){pn(Number(e.value)||0)}function ca(e){mn(!!e.value)}function Co(e){const t=Array.isArray(e.list)?e.list:Array.isArray(e.playlist)?e.playlist:null;if(!t){m("playlist.items",[]),c.emit("ui:update-playlist");return}m("playlist.items",t);let n=s("playlist.currentTrackIndex");typeof e.currentTrackIndex=="number"?n=e.currentTrackIndex:typeof e.index=="number"&&(n=e.index),n>=t.length&&(n=t.length-1),n<-1&&(n=-1),n===-1&&t.length>0&&(n=0),m("playlist.currentTrackIndex",n),c.emit("ui:update-playlist")}function la(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[Playlist] Rejected request-track-change from non-OP: ${t?.peer}`);return}const o=Number(e.index),r=s("playlist.items")||[];if(!Number.isFinite(o)||o<0||o>=r.length){d.warn(`[Playlist] Invalid track index: ${e.index}`);return}te(o)}function ua(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[Playlist] Rejected request-next-track from non-OP: ${t?.peer}`);return}Vn()}}function da(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[Playlist] Rejected request-prev-track from non-OP: ${t?.peer}`);return}gr()}}function fa(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[Playlist] Rejected request-setting from non-OP: ${t?.peer}`);return}const o=e.settingType,r=e.value;switch(o){case"repeat-mode":{const a=Number(r)||0;pn(a),T({type:p.REPEAT_MODE,value:a});break}case"shuffle-mode":{const a=!!r;mn(a),T({type:p.SHUFFLE_MODE,value:a});break}case"eq":{const a=parseInt(String(e.band),10),i=parseFloat(String(r));oo(a,i),T({type:p.EQ_UPDATE,band:a,value:i});break}case p.PREAMP:{const a=parseFloat(String(r));so(a),T({type:p.PREAMP,value:a});break}case"stereo":{const a=Number(r);ln(a),T({type:p.STEREO_WIDTH,value:a});break}case p.VBASS:{const a=Number(r);un(a),T({type:p.VBASS,value:a});break}case p.REVERB:{M("mix",Number(r)),T({type:p.REVERB,value:r});break}case p.REVERB_TYPE:{m("audio.reverbType",String(r)),T({type:p.REVERB_TYPE,value:r});break}case p.REVERB_DECAY:{M("decay",Number(r)),T({type:p.REVERB_DECAY,value:r});break}case p.REVERB_PREDELAY:{M("predelay",Number(r)),T({type:p.REVERB_PREDELAY,value:r});break}case p.REVERB_LOWCUT:{M("lowcut",Number(r)),T({type:p.REVERB_LOWCUT,value:r});break}case p.REVERB_HIGHCUT:{M("highcut",Number(r)),T({type:p.REVERB_HIGHCUT,value:r});break}}}async function pa(){if(s("network.hostConn")){c.emit("ui:show-toast","Host만 실행할 수 있습니다.");return}try{c.emit("ui:show-loader",!0,"데모 음원 로딩 중..."),c.emit("ui:update-loader",0);const t=await new Promise((i,l)=>{const u=new XMLHttpRequest;u.open("GET",vo,!0),u.responseType="blob",u.onprogress=f=>{if(f.lengthComputable){const y=Math.round(f.loaded/f.total*100);c.emit("ui:update-loader",y)}},u.onload=()=>{u.status>=200&&u.status<300?i(u.response):l(new Error(`HTTP Error ${u.status}`))},u.onerror=()=>l(new Error("Network Error")),u.send()}),n=new File([t],vo,{type:"audio/mpeg"}),o={type:"file",file:n,name:n.name,title:Vr},r=s("playlist.items")||[];r.push(o),m("playlist.items",r),c.emit("ui:update-playlist");const a=r.map(i=>({type:i.type,name:i.name,title:i.title||i.name,videoId:i.videoId||null,playlistId:i.playlistId||null}));T({type:p.PLAYLIST_UPDATE,list:a}),c.emit("ui:show-toast","데모 음원 로드 완료. 재생을 시작합니다."),c.emit("ui:show-loader",!1),te(r.length-1)}catch(t){d.error("Demo load failed:",t),c.emit("ui:show-toast",`데모 로드 실패: ${t.message}`),c.emit("ui:show-loader",!1)}}function ma(e){if(!e||e.length===0)return;if(s("network.hostConn")){c.emit("ui:show-toast","Host만 파일을 추가할 수 있습니다.");return}const n=s("playlist.items")||[];let o=0;for(let i=0;i<e.length;i++){const l=e[i];if(!l)continue;const u={type:"file",file:l,name:l.name,title:l.name.replace(/\.[^/.]+$/,"")};n.push(u),o++}if(o===0)return;m("playlist.items",n),c.emit("ui:update-playlist");const r=n.map(i=>({type:i.type,name:i.name,title:i.title||i.name,videoId:i.videoId||null,playlistId:i.playlistId||null}));T({type:p.PLAYLIST_UPDATE,list:r}),c.emit("ui:show-toast",`${o}개 파일 추가됨`);const a=s("appState");H(a)&&te(n.length-o)}function ya(){J({[p.REPEAT_MODE]:aa,[p.SHUFFLE_MODE]:ca,[p.PLAYLIST_UPDATE]:Co,[p.PLAYLIST]:Co,[p.REQUEST_TRACK_CHANGE]:la,[p.REQUEST_NEXT_TRACK]:ua,[p.REQUEST_PREV_TRACK]:da,[p.REQUEST_SETTING]:fa}),c.on("player:ended",()=>{if(s("network.hostConn"))return;const t=s("playlist.repeatMode")||0,n=s("playlist.currentTrackIndex");t===2?(d.debug("Repeat One: Replaying current track..."),setTimeout(()=>te(n),300)):(d.debug("Auto-advancing to next track..."),setTimeout(()=>Vn(),500))}),c.on("playlist:prev-track",()=>gr()),c.on("playlist:next-track",()=>Vn()),c.on("playlist:set-repeat-mode",((...e)=>{const t=Number(e[0])||0;pn(t)})),c.on("playlist:set-shuffle",((...e)=>{mn(!!e[0])})),c.on("app:load-demo",((...e)=>{pa()})),c.on("app:files-selected",((...e)=>{ma(e[0])})),c.on("playlist:play-track",((...e)=>{const t=Number(e[0]);Number.isFinite(t)&&t>=0&&te(t)})),c.on("storage:play-preloaded",((...e)=>{const t=Number(e[0]);Number.isFinite(t)&&t>=0&&te(t)})),c.on("network:peer-connected",((...e)=>{const t=e[0];if(!(!t?.open||s("network.hostConn")))try{const o=s("playlist.repeatMode")||0;t.send({type:p.REPEAT_MODE,value:o});const r=s("playlist.isShuffle");t.send({type:p.SHUFFLE_MODE,value:r});const i=(s("playlist.items")||[]).map(l=>({type:l.type,name:l.name,title:l.title||l.name,videoId:l.videoId||null,playlistId:l.playlistId||null}));t.send({type:p.PLAYLIST_UPDATE,list:i}),d.debug("[Playlist] Bootstrap: sent playlist state to new peer")}catch(o){d.warn("[Playlist] Bootstrap send failed:",o)}})),d.info("[Playlist] Initialized")}function ha(e){if(!("mediaSession"in navigator)||!e)return;let t=e.name||e.title||"Unknown Track";const n=e.type==="youtube"?"YouTube":"MUSIXQUARE";let o=[];if(e.type==="youtube"){const r=s("youtube.currentSubIndex")??-1;if(e.playlistId&&r!==-1){const l=(s("youtube.subItemsMap")||{})[e.playlistId];l?.titles?.[r]?t=l.titles[r]:t=`${e.title||"Playlist"} (${r+1})`}const a=e.thumbnail;a&&(o=[{src:a,sizes:"480x360",type:"image/jpeg"}])}else o=[{src:"favicon.svg",sizes:"512x512",type:"image/svg+xml"}];navigator.mediaSession.metadata=new MediaMetadata({title:t,artist:n,album:"MUSIXQUARE",artwork:o})}function ga(){if(!("mediaSession"in navigator))return;d.debug("[MediaSession] Initializing action handlers...");const e=()=>{const t=s("network.hostConn"),n=s("network.isOperator");return!!(t&&!n)};navigator.mediaSession.setActionHandler("play",()=>{if(!e())try{const t=s("appState");if(t===b.PLAYING_YOUTUBE){Ce();return}s("playlist.currentTrackIndex")>=0&&t!==b.IDLE&&Ce()}catch{try{Ce()}catch{}}}),navigator.mediaSession.setActionHandler("pause",()=>{if(!e())try{const t=s("appState");H(t)||Ce()}catch{try{const t=s("appState");H(t)||Ce()}catch{}}}),navigator.mediaSession.setActionHandler("previoustrack",()=>{c.emit("playlist:prev-track")}),navigator.mediaSession.setActionHandler("nexttrack",()=>{c.emit("playlist:next-track")}),navigator.mediaSession.setActionHandler("seekbackward",t=>{nn(-(t.seekOffset||10))}),navigator.mediaSession.setActionHandler("seekforward",t=>{nn(t.seekOffset||10)});try{navigator.mediaSession.setActionHandler("stop",()=>{pr()})}catch(t){d.debug("[MediaSession] Handler setup skipped:",t.message)}c.on("player:metadata-update",((...t)=>{ha(t[0])})),d.info("[MediaSession] Initialized")}const ba=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/];function qn(e){for(const t of ba){const n=e.match(t);if(n)return n[1]}return null}function Gn(e){const t=e.match(/[?&]list=([a-zA-Z0-9_-]+)/);return t?t[1]:null}const Tn=new Map,_t=new Map;async function Wn(e){const t=String(e||"");if(!t)return null;if(Tn.has(t))return Tn.get(t);if(_t.has(t))return _t.get(t);const n=(async()=>{try{const r=`https://www.youtube.com/oembed?url=${encodeURIComponent(t)}&format=json`,a=await fetch(r);if(!a.ok)return null;const i=await a.json();return(i&&typeof i.title=="string"?i.title.trim():"")||null}catch(r){return d.warn("[YouTube oEmbed] Fetch failed:",r),null}finally{_t.delete(t)}})();_t.set(t,n);const o=await n;return o&&Tn.set(t,o),o}let vn=null;function Ea(e){const t=document.getElementById("youtube-preview"),n=document.getElementById("youtube-preview-status"),o=document.getElementById("youtube-play-btn");if(!t||!n)return;const r=l=>{o&&(o.disabled=!l,o.style.opacity=l?"1":"0.5")};if(vn&&clearTimeout(vn),!e||e.trim()===""){t.style.display="none",n.style.display="block",n.innerText="동영상 또는 플레이리스트 링크를 입력하세요",n.style.color="var(--text-sub)",r(!1);return}const a=qn(e),i=Gn(e);if(!a&&!i){t.style.display="none",n.style.display="block",n.innerText="유효한 YouTube 링크가 아닙니다",n.style.color="#ef4444",r(!1);return}n.style.display="block",n.innerText="영상 정보 불러오는 중...",n.style.color="var(--text-sub)",r(!1),vn=setTimeout(async()=>{try{const l=`https://www.youtube.com/oembed?url=${encodeURIComponent(e)}&format=json`,u=await fetch(l);if(!u.ok)throw new Error("Video not found");const f=await u.json(),y=document.getElementById("youtube-preview-thumb"),h=document.getElementById("youtube-preview-title"),g=document.getElementById("youtube-preview-channel");y&&(y.src=f.thumbnail_url),h&&(h.innerText=f.title),g&&(g.innerText=f.author_name),t.style.display="block",n.style.display="none",r(!0)}catch(l){d.error("[YouTube Preview] Error:",l),t.style.display="none",n.style.display="block",n.innerText="영상 정보를 불러올 수 없습니다",n.style.color="#ef4444",r(!1)}},500)}const wn=new Map;let kn=null;async function br(e,t){if(!(!t||t.length===0||!(s("youtube.subItemsMap")||{})[e])&&!wn.get(e)){wn.set(e,!0),d.debug(`[YouTube Feed] Starting title fetch for playlist: ${e} (${t.length} items)`);try{for(let r=0;r<t.length;r++){const i=(s("youtube.subItemsMap")||{})[e];if(!i)break;if(!i.titles[r]){try{const l=t[r],u=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent("https://www.youtube.com/watch?v="+l)}&format=json`);if(!u.ok)continue;const f=await u.json();if(f&&f.title){const y=s("youtube.subItemsMap")||{};y[e]||(y[e]={ids:[],titles:[]}),y[e].titles[r]=f.title,m("youtube.subItemsMap",{...y}),d.debug(`[YouTube Feed] Fetched Title [${r}]: ${f.title}`),kn&&clearTimeout(kn),kn=setTimeout(()=>c.emit("ui:update-playlist"),200),s("network.hostConn")||T({type:p.YOUTUBE_SUB_TITLE_UPDATE,playlistId:e,subIdx:r,title:f.title})}}catch(l){d.warn(`[YouTube Feed] Failed to fetch title for ${t[r]}:`,l)}await new Promise(l=>setTimeout(l,ue.RETRY))}}}finally{wn.delete(e)}}}let S=null,In=0,Pn=!1,ze=null,st=null;function lo(){return S}function Gt(e,t=null,n=!0,o=0){he=0,In++;const r=In;c.emit("player:stop-all-media"),co("youtube"),c.emit("ui:show-toast","YouTube 같이 보기 - 고급 오디오 효과가 비활성화됩니다");const a=document.querySelector(".video-wrapper");if(!a){d.warn("[YouTube] .video-wrapper not found");return}let i=document.getElementById("youtube-player-container");i||(i=document.createElement("div"),i.id="youtube-player-container",i.style.cssText="width:100%; height:100%; position:relative;",a.appendChild(i)),S||(i.innerHTML='<div id="youtube-player"></div>');const l=window;if(!l.YT||!l.YT.Player){if(!Pn){Pn=!0;const f=document.createElement("script");f.src="https://www.youtube.com/iframe_api",f.onload=()=>d.debug("[YouTube] API script loaded"),f.onerror=()=>{d.error("[YouTube] Failed to load API script"),Pn=!1,c.emit("ui:show-toast","YouTube API 로드 실패. 인터넷 연결 확인!")},document.head.appendChild(f)}l.onYouTubeIframeAPIReady=()=>{l.isYouTubeAPIReady=!0,_o(e,t,n,o)}}else _o(e,t,n,o);ze&&clearTimeout(ze),ze=setTimeout(()=>{In===r&&!S&&(d.warn("[YouTube] Load timeout triggered."),c.emit("ui:show-loader",!1),c.emit("ui:show-toast","YouTube 로드 시간 초과. 다시 시도해주세요."))},15e3),c.emit("ui:play-btn-state",!0);const u=document.querySelector(".fullscreen-btn");u&&u.style.setProperty("display","none","important"),setTimeout(()=>Er(),500),d.debug("[YouTube] Loaded:",e||t,"autoplay:",n)}function _o(e,t=null,n=!0,o=0){if(s("appState")!==b.PLAYING_YOUTUBE){d.warn("[YouTube] initYouTubePlayer aborted - not in PLAYING_YOUTUBE state");return}if(S?.loadVideoById){d.debug("[YouTube] Re-using existing player instance");try{t?S.loadPlaylist({list:t,listType:"playlist",index:o,startSeconds:0}):e&&S.loadVideoById(e),n||S.pauseVideo();return}catch(l){d.warn("[YouTube] Failed to reuse player, recreating...",l);const u=document.getElementById("youtube-player-container");u&&(u.innerHTML='<div id="youtube-player"></div>')}}const a={autoplay:n?1:0,controls:1,rel:0,modestbranding:1,playsinline:1,origin:window.location.origin};t&&(a.listType="playlist",a.list=t);const i={width:"100%",height:"100%",playerVars:a,events:{onReady:Sa,onStateChange:Ta}};e&&(i.videoId=e),S=new YT.Player("youtube-player",i)}function Sa(){if(d.debug("[YouTube] Player ready"),s("appState")!==b.PLAYING_YOUTUBE){d.debug("[YouTube] onPlayerReady skipped - mode changed");return}P("youtubeUILoop"),X("youtubeUILoop",va,500,{interval:!0}),P("youtubeSyncLoop"),s("network.hostConn")||X("youtubeSyncLoop",()=>{c.emit("youtube:broadcast-sync")},3e3,{interval:!0}),c.emit("audio:apply-youtube-volume")}function Ta(e){if(s("appState")!==b.PLAYING_YOUTUBE)return;const n=e.data;n===YT.PlayerState.PLAYING?(uo(!1),c.emit("ui:update-play-state",!0)):n===YT.PlayerState.PAUSED?c.emit("ui:update-play-state",!1):n===YT.PlayerState.ENDED&&(m("appState",b.IDLE),c.emit("player:state-changed",b.IDLE),P("youtubeUILoop"),s("network.hostConn")||(d.debug("[YouTube] Ended, playing next track..."),c.emit("playlist:next-track"))),!s("network.hostConn")&&S?.getCurrentTime&&T({type:p.YOUTUBE_STATE,state:n,time:S.getCurrentTime(),subIndex:S.getPlaylistIndex?.()??-1})}let he=0,Ro=-1;function va(){const e=s("appState");if(!(!S||e!==b.PLAYING_YOUTUBE||!S.getCurrentTime))try{const t=S.getCurrentTime(),n=S.getDuration?.()||0,o=S.getPlaylistIndex?.()??-1,r=S.getPlayerState?.()??-1;ct&&(r===5||r===-1)?(st||(st=Date.now()),Date.now()-st>3e3&&uo(!0)):st=null,o!==Ro&&(Ro=o,he=0),n>0&&he===0&&(he=n),he>0&&c.emit("ui:time-update",Le(t),Le(he),t,he)}catch{}}function uo(e){const t="youtube-ios-sync-overlay";let n=document.getElementById(t);if(e){if(!n){n=document.createElement("div"),n.id=t,n.style.cssText=`
        position:absolute;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.6);display:flex;align-items:center;
        justify-content:center;z-index:100;cursor:pointer;
        backdrop-filter:blur(4px);animation:fadeIn 0.3s ease-out;
      `,n.onclick=()=>{S?.playVideo&&(S.playVideo(),uo(!1))},n.innerHTML=`
        <div style="background:var(--primary);color:white;padding:12px 24px;border-radius:100px;font-weight:bold;font-size:14px;box-shadow:0 4px 15px rgba(0,0,0,0.3);display:flex;align-items:center;gap:8px;">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M8 5v14l11-7z"/></svg>
          TAP TO SYNC VIDEO
        </div>
      `;const o=document.querySelector(".video-wrapper");o&&o.appendChild(n)}n.style.display="flex"}else n&&(n.style.display="none",st=null)}function Er(){const e=document.getElementById("youtube-player-container"),t=s("appState");if(!e||t!==b.PLAYING_YOUTUBE)return;d.debug("[YouTube] Refreshing display to prevent black screen...");const n=e.querySelector("iframe");e.style.display="none",e.offsetHeight,e.style.display="block",n&&(n.style.visibility="hidden",n.offsetHeight,n.style.visibility="visible"),window.dispatchEvent(new Event("resize"))}function wa(){if(s("appState")!==b.PLAYING_YOUTUBE)return;if(he=0,m("appState",b.IDLE),c.emit("player:state-changed",b.IDLE),P("youtubeUILoop"),P("youtubeSyncLoop"),ze&&(clearTimeout(ze),ze=null),S){try{d.debug("[YouTube] Destroying player instance..."),S.stopVideo(),typeof S.destroy=="function"&&S.destroy()}catch(i){d.debug("[YouTube] Cleanup error (non-critical):",i.message)}S=null}const t=document.getElementById("youtube-player-container");t&&(t.innerHTML="");const n=document.getElementById("main-video");n&&(n.pause(),n.src="",n.style.display="none",n.load());const o=document.querySelector(".fullscreen-btn");o&&(o.style.removeProperty("display"),o.style.display="");const r=document.getElementById("chat-drawer");r&&r.classList.remove("with-youtube");const a=document.getElementById("chat-youtube-container");a&&a.remove(),c.emit("ui:update-playlist"),d.debug("[YouTube] Mode stopped")}function ka(e){const t=e.videoId,n=e.playlistId,o=e.index,r=e.autoplay;o!==void 0&&m("playlist.currentTrackIndex",o),Gt(t,n,r??!1)}function Ia(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[YouTube] Rejected request-youtube-play from non-OP: ${t?.peer}`);return}S?.playVideo&&(S.playVideo(),T({type:p.YOUTUBE_STATE,state:1,time:S.getCurrentTime?.()||0}))}}function Pa(e,t){if(!s("network.hostConn")){if(!Q(t)){d.warn(`[YouTube] Rejected request-youtube-pause from non-OP: ${t?.peer}`);return}S?.pauseVideo&&(S.pauseVideo(),T({type:p.YOUTUBE_STATE,state:2,time:S.getCurrentTime?.()||0}))}}function Ca(e,t){if(s("network.hostConn"))return;if(!Q(t)){d.warn(`[YouTube] Rejected request-youtube-sub-seek from non-OP: ${t?.peer}`);return}const o=e.subIdx;S?.playVideoAt&&typeof o=="number"&&S.playVideoAt(o)}function _a(e,t){if(s("network.hostConn"))return;const o=e.playlistId;if(!o||!t)return;const r=s("youtube.subItemsMap")||{};r[o]&&t.send({type:p.YOUTUBE_PLAYLIST_INFO,playlistId:o,ids:r[o].ids||[],titles:r[o].titles||[]})}function Ra(){J({[p.YOUTUBE_PLAY]:ka,[p.REQUEST_YOUTUBE_PLAY]:Ia,[p.REQUEST_YOUTUBE_PAUSE]:Pa,[p.REQUEST_YOUTUBE_SUB_SEEK]:Ca,[p.REQUEST_YOUTUBE_PLAYLIST_INFO]:_a}),c.on("youtube:stop-mode",(()=>wa())),c.on("youtube:load",((...e)=>{const[t,n,o]=e;Gt(t,n,o)})),c.on("youtube:toggle-play",(()=>{const e=s("network.hostConn"),t=s("network.isOperator");if(e&&t){try{S?.getPlayerState?.()===YT.PlayerState.PLAYING?e.send({type:p.REQUEST_YOUTUBE_PAUSE}):e.send({type:p.REQUEST_YOUTUBE_PLAY})}catch(n){d.error("[YouTube] OP toggle error:",n)}return}if(S)try{S.getPlayerState()===YT.PlayerState.PLAYING?(S.pauseVideo(),T({type:p.YOUTUBE_STATE,state:2,time:S.getCurrentTime()})):(S.playVideo(),T({type:p.YOUTUBE_STATE,state:1,time:S.getCurrentTime()}))}catch(n){d.error("[YouTube] Toggle play error:",n)}})),c.on("youtube:auto-play",(()=>{S?.playVideo&&(S.playVideo(),c.emit("youtube:broadcast-sync"))})),c.on("youtube:get-position",((...e)=>{const t=e[0];if(typeof t=="function")try{const n=S?.getCurrentTime?.()??0;t(typeof n=="number"&&isFinite(n)&&n>=0?n:0)}catch{t(0)}})),c.on("youtube:stop-playback",(()=>{if(S)try{S.stopVideo();try{S.seekTo(0,!0)}catch{}T({type:p.YOUTUBE_STATE,state:2,time:0})}catch(e){d.error("[YouTube] Stop error:",e)}})),c.on("youtube:skip-time",((...e)=>{const t=Number(e[0])||0;if(S)try{const n=S.getCurrentTime(),o=S.getDuration();let r=n+t;r<0&&(r=0),r>o&&(r=o),S.seekTo(r,!0),T({type:p.YOUTUBE_STATE,state:S.getPlayerState(),time:r})}catch(n){d.error("[YouTube] Skip time error:",n)}})),c.on("youtube:seek-to",((...e)=>{const t=Number(e[0]);if(!(!S?.seekTo||!Number.isFinite(t)))try{S.seekTo(t,!0),s("network.hostConn")||T({type:p.YOUTUBE_STATE,state:S.getPlayerState?.()??1,time:t})}catch(n){d.error("[YouTube] Seek error:",n)}})),c.on("youtube:try-next-internal",((...e)=>{const t=e[0];if(!S?.getPlaylist||typeof t!="function"){t(!1);return}try{const n=S.getPlaylist()||[],o=S.getPlaylistIndex();if(n.length>0&&o<n.length-1){S.nextVideo(),t(!0);return}}catch{}t(!1)})),c.on("youtube:try-prev-internal",((...e)=>{const t=e[0];if(!S||typeof t!="function"){t(!1);return}try{if(S.getCurrentTime()>3){S.seekTo(0,!0),T({type:p.YOUTUBE_STATE,state:S.getPlayerState(),time:0}),t(!0);return}const o=S.getPlaylist?.()||[],r=S.getPlaylistIndex?.()??-1;if(o.length>0&&r>0){S.previousVideo(),t(!0);return}}catch{}t(!1)})),c.on("youtube:broadcast-sync",(()=>{nr(()=>Promise.resolve().then(()=>Ba),void 0).then(e=>e.broadcastYouTubeSync())})),c.on("youtube:preview",((...e)=>{const t=e[0];Ea(t||"")})),c.on("youtube:load-from-input",(()=>{const e=document.getElementById("youtube-url-input");if(!e)return;const t=e.value.trim();if(!t){c.emit("ui:show-toast","YouTube 링크를 입력하세요");return}const n=qn(t),o=Gn(t);if(!n&&!o){c.emit("ui:show-toast","유효한 YouTube 링크가 아닙니다");return}const r=document.getElementById("youtube-url-overlay");r&&r.classList.remove("active"),e.value="";const a=document.getElementById("youtube-preview");a&&(a.style.display="none");const i=document.getElementById("youtube-preview-status");i&&(i.style.display="",i.textContent="링크를 입력하면 미리보기가 표시됩니다");const l=document.getElementById("youtube-play-btn");l&&(l.disabled=!0);const u=s("playlist.items")||[],y=document.getElementById("youtube-preview-title")?.innerText?.trim()||t,h={type:"youtube",name:y,title:y,videoId:n||void 0,playlistId:o||void 0};u.push(h),m("playlist.items",u);const g=u.length-1;if(m("playlist.currentTrackIndex",g),c.emit("ui:update-playlist"),c.emit("player:metadata-update",h),!s("network.hostConn")){const v=u.map(k=>({type:k.type,name:k.name,title:k.title||k.name,videoId:k.videoId||null,playlistId:k.playlistId||null}));T({type:p.PLAYLIST_UPDATE,list:v}),T({type:p.YOUTUBE_PLAY,videoId:n,playlistId:o,index:g,autoplay:!0})}Gt(n,o,!0),Wn(t).then(v=>{v&&u[g]&&(u[g].name=v,u[g].title=v,m("playlist.items",[...u]),c.emit("ui:update-playlist"),c.emit("player:metadata-update",u[g]))})})),c.on("sync:youtube-nudge",((...e)=>{const t=Number(e[0]);if(!(!S?.seekTo||!Number.isFinite(t)))try{const n=S.getCurrentTime();S.seekTo(n+t/1e3,!0)}catch(n){d.error("[YouTube] Nudge error:",n)}})),c.on("youtube:refresh-display",(()=>{Er()})),c.on("youtube:set-volume",((...e)=>{const t=Number(e[0]);S?.setVolume&&Number.isFinite(t)&&S.setVolume(t)})),c.on("youtube:sub-seek",((...e)=>{const t=Number(e[0]),n=Number(e[1]),o=e[2];S&&(o?S.playVideoAt&&(S.playVideoAt(n),T({type:p.YOUTUBE_STATE,state:1,time:0,subIndex:n})):c.emit("playlist:play-track",t))})),c.on("youtube:populate-sub-items",((...e)=>{const t=e[0];if(!t)return;let n=[];const o=s("playlist.items")||[],r=s("playlist.currentTrackIndex"),a=o[r];if(S?.getPlaylist&&a?.playlistId===t)try{n=S.getPlaylist()||[]}catch{}const i=s("youtube.subItemsMap")||{};n.length>0&&(i[t]?(!i[t].ids||i[t].ids.length===0)&&(i[t].ids=n):i[t]={ids:n,titles:[]},m("youtube.subItemsMap",{...i}));const l=s("youtube.subItemsMap")||{};l[t]?.ids?.length>0&&br(t,l[t].ids);const u=s("network.hostConn");u&&(!l[t]||!l[t].ids||l[t].ids.length===0)&&u.send({type:p.REQUEST_YOUTUBE_PLAYLIST_INFO,playlistId:t}),c.emit("ui:update-playlist")})),c.on("youtube:load-from-chat",((...e)=>{const t=e[0];if(!t)return;if(s("network.hostConn")){c.emit("ui:show-toast","방장만 유튜브 링크를 추가할 수 있어요.");return}const o=qn(t),r=Gn(t);if(!o&&!r){c.emit("ui:show-toast","유효하지 않은 YouTube 링크");return}c.emit("ui:close-chat-drawer");const a=s("playlist.items")||[],i={type:"youtube",name:t,title:t,videoId:o||void 0,playlistId:r||void 0};a.push(i),m("playlist.items",a);const l=a.length-1;m("playlist.currentTrackIndex",l),c.emit("ui:update-playlist"),c.emit("player:metadata-update",i);const u=a.map(f=>({type:f.type,name:f.name,title:f.title||f.name,videoId:f.videoId||null,playlistId:f.playlistId||null}));T({type:p.PLAYLIST_UPDATE,list:u}),T({type:p.YOUTUBE_PLAY,videoId:o,playlistId:r,index:l,autoplay:!0}),Gt(o,r,!0),Wn(t).then(f=>{f&&a[l]&&(a[l].name=f,a[l].title=f,m("playlist.items",[...a]),c.emit("ui:update-playlist"),c.emit("player:metadata-update",a[l]))})})),c.on("network:peer-connected",((...e)=>{const t=e[0];if(!t?.open||s("network.hostConn")||s("appState")!==b.PLAYING_YOUTUBE)return;const r=s("playlist.items")||[],a=s("playlist.currentTrackIndex"),i=r[a];if(!(!i||i.type!=="youtube"))try{let l=0,u=2;try{S?.getCurrentTime&&(l=S.getCurrentTime()),S?.getPlayerState&&(u=S.getPlayerState())}catch{}const f=u===1,y=s("youtube.currentSubIndex")??-1,h=y>=0?y:0;t.send({type:p.YOUTUBE_PLAY,videoId:i.videoId||null,playlistId:i.playlistId||null,name:i.name||i.title,index:a,autoplay:f,subIndex:h}),t.send({type:p.YOUTUBE_SYNC,time:l,state:u,subIndex:h}),d.debug("[YouTube] Bootstrap: sent YouTube state to new peer")}catch(l){d.warn("[YouTube] Bootstrap send failed:",l)}})),d.info("[YouTube] Player initialized")}function Aa(){const e=lo(),t=s("network.hostConn");if(!(!e||t||!e.getCurrentTime))try{const n=e.getCurrentTime(),o=e.getPlayerState?e.getPlayerState():-1;if(e.getPlaylistIndex){const r=e.getPlaylistIndex(),a=s("youtube.currentSubIndex")??-1;if(r!==a){m("youtube.currentSubIndex",r);const i=s("playlist.items")||[],l=s("playlist.currentTrackIndex"),u=i[l];if(u?.playlistId){const f=u.playlistId;if(e.getPlaylist)try{const y=e.getPlaylist();if(y?.length>0){const h=s("youtube.subItemsMap")||{};(!h[f]||!h[f].ids?.length)&&(h[f]={ids:y,titles:h[f]?.titles||[]},m("youtube.subItemsMap",{...h}))}}catch{}if(e.getVideoData){const y=e.getVideoData();if(y?.title){const h=s("youtube.subItemsMap")||{};h[f]||(h[f]={ids:[],titles:[]}),h[f].titles[r]!==y.title&&(h[f].titles[r]=y.title,m("youtube.subItemsMap",{...h}),T({type:p.YOUTUBE_SUB_TITLE_UPDATE,playlistId:f,subIdx:r,title:y.title}))}}}c.emit("ui:update-playlist"),c.emit("player:metadata-update",i[l])}}T({type:p.YOUTUBE_SYNC,time:n,state:o,subIndex:s("youtube.currentSubIndex")??-1})}catch{}}function La(e){const t=lo(),n=s("appState");if(!(!t||n!==b.PLAYING_YOUTUBE||!t.getCurrentTime))try{const o=Number(e.time)||0,r=Number(e.state),a=e.subIndex,i=s("youtube.currentSubIndex")??-1;if(a!==void 0&&a!==-1&&a!==i){d.debug(`[YouTube Sync] Sub-index change: ${i} -> ${a}`),m("youtube.currentSubIndex",a),t.playVideoAt&&t.getPlaylistIndex&&t.getPlaylistIndex()!==a&&t.playVideoAt(a),c.emit("ui:update-playlist");const g=s("playlist.items")||[],E=s("playlist.currentTrackIndex");c.emit("player:metadata-update",g[E])}const l=s("sync.localOffset")||0,u=s("sync.autoSyncOffset")||0,f=o+u+l,y=t.getCurrentTime(),h=Math.abs(y-f);if(h>2&&t.seekTo&&(d.debug(`[YouTube Sync] Drift ${h.toFixed(1)}s, seeking to ${f.toFixed(1)}s`),t.seekTo(f,!0)),t.getPlayerState&&t.playVideo&&t.pauseVideo){const g=t.getPlayerState();r===1&&g!==1?t.playVideo():r===2&&g!==2&&t.pauseVideo()}}catch(o){d.error("[YouTube Sync] Error:",o)}}function xa(e){const t=lo(),n=s("appState");if(!(!t||n!==b.PLAYING_YOUTUBE))try{const o=Number(e.state),r=Number(e.time)||0;o===1&&t.playVideo?(t.seekTo&&t.seekTo(r,!0),t.playVideo()):o===2&&t.pauseVideo&&(t.pauseVideo(),t.seekTo&&t.seekTo(r,!0))}catch(o){d.error("[YouTube State] Error:",o)}}function Oa(e){const t=e.playlistId,n=e.subIdx,o=e.title;if(!t||n===void 0||!o)return;const r=s("youtube.subItemsMap")||{};r[t]||(r[t]={ids:[],titles:[]}),r[t].titles[n]=o,m("youtube.subItemsMap",{...r}),c.emit("ui:update-playlist");const a=s("playlist.items")||[],i=s("playlist.currentTrackIndex"),l=a[i],u=s("youtube.currentSubIndex")??-1;l?.playlistId===t&&u===n&&c.emit("player:metadata-update",l)}function Na(e){const t=e.playlistId,n=e.ids,o=e.titles;if(!t)return;const r=s("youtube.subItemsMap")||{};r[t]={ids:n||[],titles:o||[]},m("youtube.subItemsMap",{...r}),c.emit("ui:update-playlist"),n&&n.length>0&&br(t,n)}function Ua(){d.debug("[Guest] Received youtube-stop, switching to local mode"),s("appState")===b.PLAYING_YOUTUBE&&c.emit("youtube:stop-mode"),c.emit("player:stop-all-media")}function Sr(){J({[p.YOUTUBE_SYNC]:La,[p.YOUTUBE_STATE]:xa,[p.YOUTUBE_SUB_TITLE_UPDATE]:Oa,[p.YOUTUBE_PLAYLIST_INFO]:Na,[p.YOUTUBE_STOP]:Ua}),d.info("[YouTube Sync] Initialized")}const Ba=Object.freeze(Object.defineProperty({__proto__:null,broadcastYouTubeSync:Aa,initYouTubeSync:Sr},Symbol.toStringTag,{value:"Module"}));let De=null;function re(e){if(!document.startViewTransition){e();return}if(De!==null){const t=De;De=()=>{t(),e()};return}De=e,Promise.resolve().then(()=>{const t=De;if(De=null,!t)return;let n=!1;try{document.startViewTransition(()=>{n=!0,t()})}catch{n||t()}})}const Da=/[&<>"']/,Fa=/[&<>"']/g,Ma={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function ge(e){if(e==null)return"";const t=String(e);return Da.test(t)?t.replace(Fa,n=>Ma[n]||n):t}const Ya=ge;function Tr(e){const t=document.getElementById("track-title");t&&(t.classList.remove("marquee"),t.style.animation="none",t.innerText=e,t.removeAttribute("data-text"),t.style.removeProperty("--marquee-offset"),t.style.removeProperty("--marquee-duration"),setTimeout(()=>{const n=t.parentElement;if(!n)return;const o=t.scrollWidth-n.clientWidth,r=-(o+32);if(o>0){t.classList.add("marquee"),t.style.setProperty("--marquee-offset",`${r}px`);const l=Math.abs(r)/40*2+4;t.style.setProperty("--marquee-duration",`${l}s`),t.style.animation=""}},100))}async function vr(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0;const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();const n=document.execCommand("copy");return document.body.removeChild(t),n}catch(t){return d.warn("[Clipboard] Copy failed:",t),!1}}const wr=["setup-overlay","media-source-overlay","youtube-url-overlay"];function ve(){try{const e=wr.some(t=>{const n=document.getElementById(t);return!!(n&&n.classList.contains("active"))});document.body&&document.body.classList.toggle("overlay-open",e)}catch{}}function $a(){try{const e=new MutationObserver(()=>ve());wr.forEach(t=>{const n=document.getElementById(t);n&&e.observe(n,{attributes:!0,attributeFilter:["class"]})})}catch{}ve()}let kr="system",Ve=fo();const Cn={", 방장이 알려주는":", provided by the host","동기화 버튼을 눌러서 싱크를 맞춰보세요.":"Press the sync button to adjust the sync.","1개 요청 → 1개 응답":"1 request → 1 response","3초 후 YouTube 재생...":"Playing YouTube in 3 seconds...","3초 후 재생 시작...":"Starting playback in 3 seconds...","6자리 숫자 코드로 연결할 수 있어요.":"You can connect with a 6-digit code.","6자리 코드":"6-digit code","6자리 코드를 입력해 주세요":"Please enter the 6-digit code","HTTPS 필수: 보안 연결에서만 작동합니다.":"HTTPS required: works only on a secure connection.","Host 연결 끊김 - 파일을 받을 수 없습니다":"Host disconnected — can't receive the file","Host 요청: 싱크 초기화 및 재설정...":"Host request: reset and recalibrate sync...","Host 직결로 전환되었습니다 (릴레이 끊김)":"Switched to direct Host connection (relay disconnected)","Host만 실행할 수 있습니다.":"Only Host can run this.","Host에 파일 요청 중...":"Requesting file from Host...","ID 생성 중...":"Generating ID...","L 채널 출력":"L channel output","OP 권한 부여":"Grant OP","OP 권한 회수":"Revoke OP","Operator 권한이 부여되었습니다.":"Operator permission granted.","Operator 권한이 해제되었습니다.":"Operator permission revoked.","R 채널 출력":"R channel output","Relay 응답 없음. Host 직결 전환...":"No relay response. Switching to direct Host...","URL을 입력해 주세요":"Please enter a URL","VPN/사내 보안망이 켜져 있으면 연결이 실패할 수 있어요.":"If a VPN/corporate network is on, the connection may fail.","Wi-Fi가 없다면 호스트의 핫스팟에 연결해주세요":"No Wi‑Fi? Connect to the host's hotspot.","YouTube API 로드 실패. 인터넷 연결 확인!":"Failed to load the YouTube API. Check your connection!","YouTube 같이 보기 - 고급 오디오 효과가 비활성화됩니다":"Watch YouTube together — advanced audio effects are disabled.","YouTube 로드 시간 초과. 다시 시도해주세요.":"YouTube load timed out. Please try again.","YouTube 링크 입력":"Enter YouTube link","YouTube 모드에서는 역할 설정과 음향 효과를 쓸 수 없어요.":"In YouTube mode, role settings and audio effects are unavailable.","YouTube 모드에서는 정밀 동기화를 지원하지 않아요":"High-precision sync isn't available in YouTube mode.","YouTube 미리보기 썸네일":"YouTube preview thumbnail","YouTube 비디오 또는 플레이리스트 링크를 입력하세요.":"Enter a YouTube video or playlist link.","YouTube 이동 실패":"Failed to open YouTube","YouTube 재생 시작":"YouTube playback started","YouTube 함께보기":"Watch YouTube together","YouTube가 준비됐어요! 재생 버튼을 눌러 보세요.":"YouTube is ready! Press Play.","“모임에 참여할래요” → 코드 입력 → 역할 선택(원본/왼쪽/오른쪽/저음)":"“Join a session” → enter the code → choose a role (Original/Left/Right/Bass)","“제가 방장할래요” → 코드 확인 → “시작할래요!”":"“I'll host” → check the code → “Start!”","가상 베이스 강도":"Virtual bass intensity","가상 베이스(방장 제어)":"Virtual bass (host-ctrl)","가상 서라운드 너비 조절":"Adjust virtual surround width","가상 서라운드(방장 제어)":"Virtual surround (host-ctrl)","각 기기의 역할을 설정해 보세요.":"Set a role for each device.",강도:"Intensity","같은 Wi‑Fi인지 확인하고 다시 시도해주세요.":"Check that you're on the same Wi‑Fi and try again.","거대한 오디오 시스템을 만들어 보세요.":"Create a giant audio system.","고급 음향":"Advanced audio","고급 효과를 시스템에 적용할 수 있어요.":"You can apply advanced effects system-wide.","고정밀 동기화: 오디오를 준비하고 있어요…":"High-precision sync: preparing audio…","공개된 링크만 함께 들을 수 있어요.":"Only public links can be played together.",권한:"permission","기기 파일에서 음악/영상을 선택":"Choose music/video from your device","기기를 오른쪽에 놓아주세요":"Place the device on the right","기기를 왼쪽에 놓아주세요":"Place the device on the left","기기를 중앙에 놓아주세요":"Place the device in the center","기본값 0%":"Default 0%","기본값 0, 늘리면 가상 베이스(왜곡 증가)":"Default 0 — Higher = More Distortion","기본값 0.1s":"Default 0.1s","기본값 100, 줄이면 모노, 늘리면 서라운드":"Default 100 — lower = mono, higher = surround","기본값 20.0kHz":"Default 20.0kHz","기본값 20Hz":"Default 20Hz","기본값 5.0s":"Default 5.0s","기타 문의:":"Contact:","나중에 설정에서 바꿀 수 있어요.":"You can change it later in Settings.",남아있기:"Stay",너비:"Width","네트워크 상태를 확인한 후 다시 참가해 주세요.":"Check your network and try joining again.","네트워크 연결 상태와 코드를 확인해주세요.":"Check your network connection and the code.","네트워크 오류가 발생했어요. 같은 Wi‑Fi인지 확인해주세요.":"Network error occurred. Make sure you're on the same Wi‑Fi.","네트워크 초기화 실패":"Network init failed","네트워크 품질이 낮을 수 있어요. 공유기 가까이로 이동해 보세요.":"Network quality may be low. Try moving closer to the router.","다운로드 마무리 중...":"Finishing download...","다운로드 완료 후 재생됩니다":"Will play after download completes","다음 설명":"Next","다음 트랙":"Next track",다음으로:"Next",다크:"Dark",닫기:"Close","데모 로드 실패:":"Demo load failed:","데모 미디어로 프로그램 테스트":"Test the app with demo media","데모 음원 로드 완료. 재생을 시작합니다.":"Demo track loaded. Starting playback.","데모 음원 로딩 중...":"Loading demo track...","데이터 수신 불안정. Host 복구 요청...":"Data reception unstable. Requesting Host recovery...",도움말:"Help","도움이 필요할 때":"Need help?",동기화:"Sync","동시에 재생":"Play together","동영상 또는 플레이리스트 링크를 입력하세요":"Enter a video or playlist link","동일한 네트워크":"same network","두 기기가 같은 네트워크인지 확인해 보세요.":"Make sure both devices are on the same network.",라이트:"Light",로우패스:"Low-pass","로컬 네트워크 전용":"Local network only","로컬 파일 선택":"Choose local file","로컬(같은 Wi‑Fi/핫스팟)":"local (same Wi‑Fi/hotspot)","로컬파일 불러오기":"Load local file","로컬파일 불러오기:":"Load local file:","를 입력해 연결해요.":" and enter it to connect.","리버브 로우컷":"Reverb low-cut","리버브 믹스":"Reverb mix","리버브 반사 시간":"Reverb decay","리버브 프리딜레이":"Reverb pre-delay","리버브 하이컷":"Reverb high-cut","리버브(방장 제어)":"Reverb (host-ctrl)","리버브, 이퀄라이저, 가상 효과 등":"Reverb, EQ, virtual effects, and more","릴레이 대기 중... 잠시만 기다려주세요":"Waiting for relay... please hold on","릴레이 응답 없음. Host에서 직접 수신...":"No relay response. Receiving directly from Host...","릴레이에 파일 요청 중...":"Requesting file via relay...","링크를 붙여넣어 재생 목록에 추가":"Paste a link to add it to the playlist","마지막이에요!":"Last step!",메시지:"Message","메시지 보내기":"Send message","메시지 입력...":"Type a message...",메인:"Home","메인 화면으로 이동":"Go to Home","모든 기기 Auto Sync 요청...":"Requesting Auto Sync on all devices...","모든 기기 재동기화 요청...":"Requesting resync on all devices...","모든 기기가":"All devices must be connected to the","모든 기기를 동일한 Wi-Fi에 연결해주세요":"Connect all devices to the same Wi‑Fi","모임에 참여할래요":"Join a session","Sean Pitaro - Passport [NCS Release]":"Sean Pitaro - Passport [NCS Release]","미디어 없음":"No media","미디어 재생":"Play media","미디어 재생하기":"Play media","미디어 추가":"Add media","미디어를 추가해주세요.":"Please add media.",믹스:"Mix","반복 모드 변경":"Change repeat mode","반복 재생: 끔":"Repeat: Off","반복 재생: 전체":"Repeat: All","반복 재생: 한 곡":"Repeat: One","반사 시간":"Decay time","반사 지연":"Pre-delay","방장 제외 최대 3대":"3 devices excluding the host","방장:":"Host:","방장만 미디어를 추가할 수 있어요.":"Only the host can add media.","방장만 유튜브 링크를 추가할 수 있어요.":"Only the host can add YouTube links.","방장에게는 3가지 선택지가 나와요.":"Hosts see three options.","방장이 알려준 6자리 코드를 입력해주세요":"Enter the 6-digit code from the host",배치:"Placement","백그라운드 작업 오류가 발생했어요":"A background task error occurred","복사하지 못했어요":"Couldn't copy","볼륨 조절":"Adjust volume",부여됨:"granted","브라우저 업데이트 필요: 최신 iOS(15.2+)로 업데이트하세요.":"Browser update required: update to the latest iOS (15.2+).","새 버전이 준비되었습니다. 새로고침하면 업데이트가 적용됩니다.":"A new version is ready. Refresh to update.",새로고침:"Refresh",서브우퍼:"Subwoofer","서브우퍼 조절하기":"Adjust subwoofer","서브우퍼 컷오프 주파수":"Subwoofer cutoff frequency","서브우퍼:":"Subwoofer:",설정:"Settings","설정 · 도움말":"Settings · Help","세션을 만들지 못했어요":"Couldn't create session","세션이 가득 찼어요":"Session is full","세션이 초기화되었습니다.":"Session has been reset.","셔플 모드 변경":"Change shuffle mode","셔플: 꺼짐":"Shuffle: Off","셔플: 켜짐":"Shuffle: On","데모 트랙 정보":"Demo Track","스테레오(기본) 출력":"Stereo (default) output","스피커로 재생하기":"Play through speakers",시스템:"System",시작하기:"Start","아직 메시지가 없어요.":"No messages yet.",안내:"Info","안녕하세요! 본인의 역할을 선택해주세요.":"Hi! Please choose your role.","앱 체험하기 (데모)":"Try it (Demo)","앱 체험하기:":"Try the app:","언어 · Language":"Language · 언어","언제 어디서나 함께 듣는":"Listen together, anywhere",업데이트:"Update","에 연결되어야 해요.":".","에서 역할을 언제든 바꿀 수 있어요.":".","에서만 연결됩니다.":".","여러 기기를 무선으로 연결해":"Connect multiple devices wirelessly",역할:"Role","역할(출력 채널)":"Role (output channel)","역할을 선택해 주세요":"Please select a role","역할을 선택해 참가해 주세요.":"Select a role to join.","역할을 선택해주세요":"Please select a role","역할이 자동 설정되어 변경할 수 없어요.":"Role is auto-assigned and can't be changed.","연결 실패":"Connection failed","연결 오류: 파일 전송 실패":"Connection error: file transfer failed","연결 준비 실패":"Failed to prepare connection","연결 중...":"Connecting...","연결 코드 6자리 입력":"Enter 6-digit code","연결 코드를 입력해주세요.":"Please enter the connection code.","연결된 모든 기기에서 동시에 재생돼요.":"Playback is synchronized on all connected devices.","연결된 모든 기기에서 선택한 미디어가 동시에 재생돼요.":"The selected media plays simultaneously on all connected devices.",연결됨:"connected","연결에 문제가 생겼어요":"Connection issue occurred","연결이 끊어졌어요":"Disconnected","연결이 불안정해요:":"Unstable connection:","연결이 안 되면: Wi‑Fi 재연결 → 앱 새로고침 순서로 확인해 주세요.":"If it won't connect: reconnect Wi‑Fi → refresh the app.","연결하지 못했어요":"Couldn't connect","연결할 수 있는 기기는":"You can connect up to","영상 정보 불러오는 중...":"Loading video info...","영상 정보를 불러올 수 없습니다":"Couldn't load video info","예요.":".","오디오 디코딩 실패!":"Audio decode failed!","오디오 디코딩 중...":"Decoding audio...","오디오 메모리 로드 중...":"Loading audio into memory...","오디오 엔진을 불러오지 못했어요. 네트워크를 확인해 보세요.":"Couldn't load the audio engine. Check your network.","오디오 엔진을 준비하지 못했어요":"Couldn't prepare the audio engine","오디오 엔진이 아직 준비되지 않았어요. 네트워크를 확인해 보세요.":"The audio engine isn't ready yet. Check your network.","오디오를 준비하지 못했어요. 화면을 한 번 터치한 뒤 다시 시도해 보세요.":"Couldn't prepare audio. Tap the screen once and try again.","오른쪽 스피커":"Right speaker","오른쪽 스피커:":"Right speaker:","완벽한 사운드 경험":"A perfect sound experience","왼쪽 스피커":"Left speaker","왼쪽 스피커:":"Left speaker:","왼쪽, 오른쪽 소리를 따로 재생하고":"Play left and right channels separately, and","우퍼 모드로 웅장한 저음을 느껴보세요.":"Feel powerful bass with Woofer mode.","워커 메시지 처리 중 오류":"Error handling worker message","워커 작업 중 오류 발생!":"Worker error occurred!","유튜브 (호환 모드)":"YouTube (compatibility mode)","유튜브(채널분리 미지원):":"YouTube (no channel split):","유효하지 않은 YouTube 링크":"Invalid YouTube link","유효하지 않은 시간입니다":"Invalid time","유효한 YouTube 링크가 아닙니다":"Not a valid YouTube link","을 선택해요.":".","이 기기 역할 설정하기":"Set this device's role","이 기기로 어떤 소리를 낼까요?":"What should this device play?","이 버전은":"This version works only on","이 코드를 다른 기기에 입력해주세요":"Enter this code on your other devices","이렇게 연결해요":"How to connect","이전 설명":"Previous","이전 트랙":"Previous track","이제 다른 기기들과 연결해주세요.":"Now connect your other devices.","이퀄라이저 (방장 제어)":"Equalizer (host-ctrl)",일시정지:"Pause","입체 음향":"Spatial audio","자동 재생 취소됨 (OP)":"Auto-play canceled (OP)","자동 재생을 취소했어요":"Auto-play canceled","잠시 후 다시 시도해주세요.":"Please try again in a moment.","잠시만요...":"Just a moment...","재생 시작":"Play","재생 위치 조절":"Seek","재생 준비 완료":"Ready to play","재생/일시정지":"Play/Pause",재생목록:"Playlist","재생할 미디어를 선택해주세요":"Select media to play","저역 믹스 출력":"Bass mix output","전체화면 전환":"Toggle fullscreen",정지:"Stop","정지 요청을 보냈어요":"Stop request sent","제가 방장할래요":"I'll host","준비 지연 중... Host 복구 요청":"Preparation delayed... requesting Host recovery","중앙 스피커":"Center speaker","중앙 스피커:":"Center speaker:","직접 동기화 완료 (로컬 네트워크)":"Direct sync complete (local network)",참가자:"Guest","참가자:":"Guest:",참가자가:"Guests choose the","참가하는 중...":"Joining...","참가하는 중…":"Joining…","참가하지 못했어요. 같은 Wi‑Fi에 연결되어 있는지 확인해 보세요.":"Couldn't join. Make sure you're connected to the same Wi‑Fi.","참가할 수 없어요":"Can't join",채팅:"Chat","채팅 닫기":"Close chat","채팅 메시지 입력":"Type a chat message","채팅 열기":"Open chat","채팅을 시작하세요":"Start chatting","첫 메시지를 보내 보세요!":"Send your first message!","초기 화면":"Home screen","초기 화면으로 돌아갈까요?":"Return to the start screen?","초기화 및 재보정 시작...":"Starting reset and recalibration...",초기화:"Reset","초대 코드":"Invite code","초대 코드 표시 및 복사":"Show & copy invite code","초대 코드가 아직 없어요":"No invite code yet","초대 코드는 설정과 도움말에서 확인할 수 있어요":"You can find the invite code in Settings and Help.","초대와 공유":"Invite & Share","최적 싱크 보정 적용 중...":"Applying optimal sync calibration...",취소:"Cancel","코드를 입력했는데 연결이 안 돼요:":"I entered the code but can't connect:","클릭하여 초대코드 복사":"Click to copy invite code",테마:"Theme","파일 요청 중...":"Requesting file...","파일을 보내고 있어요…":"Sending file…","파일을 선택하거나 플레이리스트를 확인하세요":"Select a file or check the playlist","파일을 선택할 수 없어요":"Can't select a file","파일이 준비됐어요! 재생 버튼을 눌러 보세요.":"Your file is ready! Press Play.","프리로드 누락 - 파일 수신 중...":"Preload missing — receiving file...","프리로드 완료 대기 중...":"Waiting for preload to complete...","프리로드 재생 실패 - 다시 로드합니다":"Preload playback failed — reloading","프리로드된 파일 사용!":"Using preloaded file!",프리앰프:"Preamp","프리앰프 게인":"Preamp gain","플레이리스트 펼치기/접기":"Expand/collapse playlist","플레이리스트에 추가됨":"added to playlist","필수 라이브러리 로드 실패":"Failed to load required libraries",필요하면:"If needed, you can change the role anytime in",하이패스:"High-pass","현재 세션과 연결이 끊어져요.":"You will be disconnected from the current session.","현재 세션은 연결 가능한 기기 수(방장 제외 3대)에 도달했어요.":"This session has reached the device limit (3 excluding the host).","호스트 연결 없음. 로컬 초기화 완료.":"No host connection. Local reset complete.","호스트가 미디어를 재생하면":"When the host starts playback,","호스트만 조작할 수 있어요":"Only the host can control this","호스트만 파일을 추가할 수 있어요":"Only the host can add files","호스트에 연결할 수 없어요":"Can't connect to the host","호스트에서 연결이 종료되었습니다. 메인 화면으로 이동합니다.":"The host ended the connection. Returning to Home.","호스트의 설정에 맞추어":"In sync with the host's settings","호스트의 코드를 입력해주세요.":"Enter the host's code.","홈 화면에 추가":"Add to Home Screen",확인:"OK","확인/새로고침":"OK / Refresh","환경 제한으로 백그라운드 타이머(Worker)를 사용할 수 없어요.":"Due to environment limits, background timers (Worker) aren't available.","환경 제한으로 파일 저장/전송(Worker)을 사용할 수 없어요.":"Due to environment limits, file save/transfer (Worker) isn't available.",회수됨:"revoked"},Ha=[[/^초대 코드:\s*(\d{6})$/i,(e,t)=>`Invite code: ${t}`],[/^연결된 기기\s*(\d+)대\s*\|\s*초대 코드\s*(\d{6})$/i,(e,t,n)=>`Connected devices: ${t} | Invite code ${n}`],[/^(\d+)곡을 추가했어요$/i,(e,t)=>{const n=Number(t);return Number.isFinite(n)?n===1?"Added 1 track":`Added ${n} tracks`:`Added ${t} tracks`}],[/^"(.+)"\s*플레이리스트에 추가됨$/i,(e,t)=>`Added "${t}" to playlist`],[/^준비 중:\s*(.+)$/i,(e,t)=>`Preparing: ${t}`],[/^복구 대기 중:\s*(.+)$/i,(e,t)=>`Recovery pending: ${t}`],[/^파일 동기화 중:\s*(.+)$/i,(e,t)=>`Syncing file: ${t}`],[/^파일 저장 오류:\s*(.+)$/i,(e,t)=>`File save error: ${t}`],[/^(.+)가\s*연결됐어요$/i,(e,t)=>`${t} connected`],[/^(.+)\s*연결이 끊겼어요$/i,(e,t)=>`${t} disconnected`],[/^(.+)\s*연결 오류$/i,(e,t)=>`${t} connection error`],[/^(.+)로부터\s*전송 이어받기$/i,(e,t)=>`Resume transfer from ${t}`],[/^(.+)로부터\s*파일 수신 시작$/i,(e,t)=>`Started receiving file from ${t}`],[/^(.+)로부터\s*전송 재개\s*\((.+)부터\)$/i,(e,t,n)=>`Resuming transfer from ${t} (from ${n})`],[/^(.+)\s*수신 중\.\.\.\s*(.*)$/i,(e,t,n)=>`Receiving from ${t}... ${n}`],[/^자동 싱크 보정 완료,\s*\+?(\d+)ms$/i,(e,t)=>`Auto sync calibration done, +${t}ms`],[/^리버브 타입:\s*(.+)$/i,(e,t)=>`Reverb type: ${t}`],[/^Host 강제 동기화:\s*(.+)$/i,(e,t)=>`Host force sync: ${t}`],[/^Relay:\s*(.+)\s*연결됨$/i,(e,t)=>`Relay: ${t} connected`],[/^(.+)로\s*이동$/i,(e,t)=>`Seek to ${t}`],[/^다음 곡 준비 중\.\.\.\s*\((.+)\)$/i,(e,t)=>`Preparing next track... (${t})`]];let _n=null,Ae=!1;const yt=new Map,ht=new Map;let Rn=null;function Va(e){return String(e??"").replace(/\s+/g," ").trim()}function Ee(e){if(Ve!=="en"||e==null)return e;const t=String(e),n=t.match(/^\s*/)?.[0]??"",o=t.match(/\s*$/)?.[0]??"",r=t.trim(),a=Va(r);if(!a)return t;let i=Cn[a];if(!i)for(const[u,f]of Ha){const y=a.match(u);if(y){try{i=f(...y)}catch{i=void 0}break}}if(!i){Rn||(Rn=Object.keys(Cn).sort((f,y)=>y.length-f.length));let u=a;for(const f of Rn)u.includes(f)&&(u=u.split(f).join(Cn[f]));i=u}let l=i;return n&&(l=l.replace(/^\s+/,"")),o&&(l=l.replace(/\s+$/,"")),n+l+o}function qa(e){try{const t=e?.parentNode;if(!t||t.nodeType!==1)return!1;const n=t.tagName;return n==="SCRIPT"||n==="STYLE"||n==="NOSCRIPT"}catch{return!1}}function zn(e){if(!e||e.nodeType!==3||qa(e))return;const t=e.data;if(!t||!t.trim())return;const n=Ee(t);n!==t&&(yt.set(e,{raw:t,translated:n}),e.data=n)}function Qn(e){if(!e||e.nodeType!==1)return;const t=e.tagName;if(t==="SCRIPT"||t==="STYLE"||t==="NOSCRIPT")return;const n=["aria-label","title","placeholder","alt"];for(const o of n){if(!e.hasAttribute(o))continue;const r=e.getAttribute(o);if(!r)continue;const a=Ee(r);if(a===r)continue;let i=ht.get(e);i||(i={},ht.set(e,i)),i[o]={raw:r,translated:a},e.setAttribute(o,a)}}function Ao(e){if(Ve==="en"&&e){Ae=!0;try{e.nodeType===1&&(Qn(e),e.querySelectorAll?.("*")?.forEach(o=>Qn(o)));const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let n;for(;n=t.nextNode();)zn(n)}finally{Ae=!1}}}function Ga(){Ae=!0;try{for(const[e,t]of yt.entries())try{if(!t)continue;e.data===t.translated&&(e.data=t.raw)}catch{}for(const[e,t]of ht.entries())try{for(const[n,o]of Object.entries(t||{}))o&&e.getAttribute(n)===o.translated&&e.setAttribute(n,o.raw)}catch{}yt.clear(),ht.clear()}finally{Ae=!1}}function fo(){try{const e=navigator.languages&&navigator.languages.length?navigator.languages:[navigator.language||""];return String(e[0]||"").toLowerCase().startsWith("ko")?"ko":"en"}catch{return"ko"}}function Ir(e){Ve=e==="en"?"en":"ko";try{document.documentElement.setAttribute("lang",Ve)}catch{}if(!_n&&typeof MutationObserver<"u"){_n=new MutationObserver(t=>{if(!Ae&&Ve==="en"){Ae=!0;try{for(const n of t)n.type==="characterData"?zn(n.target):n.type==="attributes"?Qn(n.target):n.type==="childList"&&(n.addedNodes?.forEach(o=>{o.nodeType===3?zn(o):o.nodeType===1&&Ao(o)}),n.removedNodes?.forEach(o=>{if(o.nodeType===3)yt.delete(o);else if(o.nodeType===1){ht.delete(o);try{const r=document.createTreeWalker(o,NodeFilter.SHOW_TEXT);let a;for(;a=r.nextNode();)yt.delete(a)}catch{}}}))}finally{Ae=!1}}});try{_n.observe(document.body||document.documentElement,{subtree:!0,childList:!0,characterData:!0,attributes:!0,attributeFilter:["aria-label","title","placeholder","alt"]})}catch{}}Ve==="en"?Ao(document.body||document.documentElement):Ga()}function Wa(e){try{document.querySelectorAll(".lang-opt").forEach(o=>o.classList.remove("active"));const t=e==="ko"?"lang-ko":e==="en"?"lang-en":"lang-system";document.getElementById(t)?.classList.add("active");const n=e==="ko"?0:e==="en"?1:2;document.querySelectorAll(".lang-selector").forEach(o=>{o.style.setProperty("--pill-index",String(n))})}catch{}}function Wt(e){e!=="ko"&&e!=="en"&&e!=="system"&&(e="system"),kr=e,Wa(e);const t=e==="system"?fo():e;Ir(t)}function za(){Wt("system");try{window.addEventListener("languagechange",()=>{kr==="system"&&Ir(fo())})}catch{}d.info("[i18n] Initialized")}function Qa(e){const t=document.getElementById("header-progress-bg");t&&(t.style.width=`${e}%`)}function ja(e,t){const n=document.getElementById("main-header"),o=document.getElementById("header-loading-text"),r=document.getElementById("header-progress-bg");e?(n?.classList.add("loading"),t&&o&&(o.innerText=Ee(t)??""),r&&(r.style.width==="0px"||r.style.width==="")&&(r.style.width="0%")):(n?.classList.remove("loading"),setTimeout(()=>{r&&(r.style.width="0%")},400))}let An=null;function R(e){try{const t=document.getElementById("toast"),n=document.getElementById("toast-msg"),o=e==null?"":String(e);if(!t||!n){console.info("[Toast]",o);return}n.innerText=Ee(o)??"",t.classList.add("show"),An&&clearTimeout(An),An=setTimeout(()=>{try{t.classList.remove("show")}catch{}},2e3)}catch{console.info("[Toast fallback]",e)}}function Ka(){d.info("[Toast] Initialized")}let on=null;const Pr=[];function po(){if(on)return;const e=Pr.shift();e&&Ja(e.opts,e.resolve)}function Xa(e="close"){const t=document.getElementById("dialog-overlay");t&&(t.classList.remove("show"),t.setAttribute("aria-hidden","true"));const n=on;on=null;try{n&&Array.isArray(n.cleanup)&&n.cleanup.forEach(o=>{try{o()}catch{}})}catch{}if(n?.prevFocus&&typeof n.prevFocus.focus=="function")try{n.prevFocus.focus()}catch{}if(typeof n?.resolve=="function")try{n.resolve({action:e})}catch{}setTimeout(po,0)}function Ja(e,t){const n=document.getElementById("dialog-overlay"),o=document.getElementById("dialog-title"),r=document.getElementById("dialog-message"),a=document.getElementById("btn-dialog-ok"),i=document.getElementById("btn-dialog-secondary"),l=document.getElementById("btn-dialog-close");if(!n||!o||!r||!a||!l){R(typeof e=="string"?e:e?.message||"안내"),t({action:"fallback"}),setTimeout(po,0);return}const u=typeof e=="object"&&e?e:{message:String(e??"")},f=typeof e=="string"?"안내":u.title||"안내",y=String(typeof e=="string"?e??"":u.message||""),h=u.buttonText?String(u.buttonText):"확인",g=u.secondaryText!==void 0&&u.secondaryText!==null?u.secondaryText:u.cancelText!==void 0&&u.cancelText!==null?u.cancelText:"",E=String(g??"").trim(),v=!!E,k=u.dismissible!==void 0?!!u.dismissible:!0,w=u.defaultFocus?String(u.defaultFocus):v?"secondary":"primary";o.textContent=Ee(f)??"",r.textContent=Ee(y)??"",a.textContent=Ee(h)??"",i&&(v?(i.textContent=Ee(E)??"",i.style.display=""):i.style.display="none");const I=document.activeElement;n.classList.add("show"),n.setAttribute("aria-hidden","false");const A=[],_=(D,U,q)=>{D&&(D.addEventListener(U,q),A.push(()=>{try{D.removeEventListener(U,q)}catch{}}))};on={resolve:t,prevFocus:I,cleanup:A};const x=D=>Xa(D);_(n,"click",D=>{k&&D.target===n&&x("overlay")}),_(a,"click",()=>x("ok")),v&&i&&_(i,"click",()=>x("secondary")),_(l,"click",()=>{if(!k)return x("ok");x("close")}),_(window,"keydown",D=>{const U=D;if(U.key==="Escape"){if(!k)return;U.preventDefault(),x("escape");return}if(U.key==="Tab"){const q=[l,v?i:null,a].filter(Je=>Je!=null&&Je.offsetParent!==null);if(q.length===0)return;const F=q[0],se=q[q.length-1],Ne=document.activeElement;U.shiftKey?(Ne===F||!n.contains(Ne))&&(U.preventDefault(),se.focus()):Ne===se&&(U.preventDefault(),F.focus())}}),setTimeout(()=>{try{((w==="secondary"&&v&&i?i:w==="close"?l:a)||a).focus()}catch{}},0)}function rn(e={}){return new Promise(t=>{Pr.push({opts:e,resolve:t}),po()})}function Za(){d.info("[Dialog] Initialized")}function gt(e){re(()=>{document.querySelectorAll(".tab-content").forEach(r=>r.classList.remove("active")),document.querySelectorAll(".nav-item").forEach(r=>r.classList.remove("active"));const t=document.getElementById(`tab-${e}`);t&&t.classList.add("active");const o=["play","playlist","settings","guide"].indexOf(e);o>=0&&document.querySelectorAll(".nav-item")[o]?.classList.add("active"),e==="settings"&&c.emit("ui:settings-tab-opened"),e==="play"&&setTimeout(()=>{s("appState")===b.PLAYING_YOUTUBE&&c.emit("youtube:refresh-display"),c.emit("ui:visualizer-check")},50)})}function ec(){document.querySelectorAll(".bottom-nav .nav-item[data-tab]").forEach(e=>{e.addEventListener("click",()=>{try{e.blur()}catch{}if(e.classList.contains("active")){const t=document.querySelector(`#tab-${e.dataset.tab} .tab-body`);t&&t.scrollTo({top:0,behavior:"smooth"})}else gt(e.dataset.tab)})}),c.on("ui:switch-tab",((...e)=>{const t=e[0];t&&gt(t)})),d.info("[Tabs] Initialized")}let Ie=null,Ln=0;const Lo=120;let xn=null;function tc(){return s("audio.analyser")}function it(){Ie&&(cancelAnimationFrame(Ie),Ie=null);const e=document.getElementById("visualizerCanvas");if(!e)return;const t=e.getContext("2d");if(!t)return;const n=t,o=tc();if(!o){if(++Ln>Lo){d.warn("[Visualizer] Gave up waiting for analyser after",Lo,"frames"),Ln=0;return}Ie=requestAnimationFrame(it);return}Ln=0;const r=typeof o.getValue=="function",a=r?o.size||1024:o.frequencyBinCount;let i=0;const l=document.querySelector(".vinyl-wrapper"),u=l&&l.clientWidth>10?l.clientWidth:240,f=window.devicePixelRatio||1;(e.width!==u*f||e.height!==u*f)&&(e.width=u*f,e.height=u*f,e.style.width="",e.style.height="",n.setTransform(1,0,0,1,0,0),n.scale(f,f));function y(){const h=s("appState");if(H(h)){Ie=null;return}if(!r){Ie=null;return}Ie=requestAnimationFrame(y);const g=o.getValue(),v=document.documentElement.getAttribute("data-theme")==="light";n.globalCompositeOperation="source-over",n.clearRect(0,0,u,u);let k=0,w=12;w>a&&(w=a);for(let ke=0;ke<w;ke++){let Z=(g[ke]+100)*2.5;Z<0&&(Z=0),Z>255&&(Z=255),k+=Z}const I=k/w;i=i*.8+I*.2;const A=Math.pow(i/255,2.5);let _=0;const x=Math.floor(a*.7),D=a;let U=D-x;U<1&&(U=1);for(let ke=x;ke<D;ke++){let Z=(g[ke]+100)*2.5;Z<0&&(Z=0),Z>255&&(Z=255),_+=Z}const F=_/U/255;n.globalCompositeOperation=v?"source-over":"lighter",n.shadowBlur=0;const se=u/2,Ne=u/2,Je=u/240,Or=(55+A*200)*Je,Nr=20+A*60;n.fillStyle=v?"rgba(59, 130, 246, 0.6)":`hsla(217, 91%, ${Nr+40}%, 0.4)`,n.beginPath(),n.arc(se,Ne,Or,0,2*Math.PI),n.fill();const Ur=(40+F*130)*Je,Br=40+F*60;n.fillStyle=v?"rgba(96, 165, 250, 0.6)":`hsla(217, 100%, ${Br+30}%, 0.4)`,n.beginPath(),n.arc(se,Ne,Ur,0,2*Math.PI),n.fill()}y()}function Rt(){const e=document.getElementById("visualizerCanvas");if(!e)return;const t=e.getContext("2d");if(!t)return;const n=t,o=document.querySelector(".vinyl-wrapper"),r=o?o.clientWidth:240,a=window.devicePixelRatio||1;(e.width!==r*a||e.height!==r*a)&&(e.width=r*a,e.height=r*a,e.style.width="",e.style.height="",n.setTransform(1,0,0,1,0,0),n.scale(a,a));const l=document.documentElement.getAttribute("data-theme")==="light";n.globalCompositeOperation="source-over",n.clearRect(0,0,r,r),n.globalCompositeOperation=l?"source-over":"lighter",n.shadowBlur=0;const u=r/2,f=r/2,y=r/240,h=55*y;n.fillStyle=l?"rgba(59, 130, 246, 0.6)":"hsla(217, 91%, 60%, 0.4)",n.beginPath(),n.arc(u,f,h,0,2*Math.PI),n.fill();const g=40*y;n.fillStyle=l?"rgba(96, 165, 250, 0.6)":"hsla(217, 100%, 70%, 0.4)",n.beginPath(),n.arc(u,f,g,0,2*Math.PI),n.fill()}function nc(){Rt(),window.addEventListener("resize",()=>{xn&&clearTimeout(xn),xn=setTimeout(()=>{const e=document.querySelector(".vinyl-wrapper");if(!e||e.clientWidth<10)return;const t=s("appState");H(t)?Rt():it()},250)}),c.on("ui:visualizer-check",((...e)=>{const t=s("appState");H(t)?Rt():it()})),c.on("player:state-changed",((...e)=>{const t=s("appState");H(t)?Rt():it()})),c.on("visualizer:start",((...e)=>{it()})),d.info("[Visualizer] Initialized")}const sn="Peer",xo={0:{label:"Original"},"-1":{label:"Left"},1:{label:"Right"},2:{label:"Woofer"}};function at(e){return(xo[String(e)]||xo[0]).label}let zt=0,qe=!1;function oc(){if(!s("network.hostConn"))return"Host";const n=(s("network.myDeviceLabel")||"").trim();if(!n||n==="HOST"||n==="Guest"||n==="참가자")return sn;const o=at(0),r=at(-1),a=at(1),i=at(2);return n===o||n===r||n===a||n===i?sn:n}function Cr(e){return e&&e.trim()?e.trim():sn}function rc(e){const t=e.split(":").map(Number);return t.length===3?t[0]*3600+t[1]*60+t[2]:t.length===2?t[0]*60+t[1]:0}function sc(e){const t=/(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)[a-zA-Z0-9_-]{11}[^\s]*/gi,n=/\b(\d{1,2}:\d{2}(?::\d{2})?)\b/g,o=new RegExp(`(${t.source})|(${n.source})`,"gi");let r="",a=0,i;for(;(i=o.exec(e))!==null;){i.index>a&&(r+=ge(e.slice(a,i.index)));const l=i[0];if(t.lastIndex=0,t.test(l)){const u=l.startsWith("http")?l:"https://"+l,f="yt-"+Math.random().toString(36).substr(2,9);r+=`
        <button type="button" class="chat-youtube-btn" data-youtube-url="${Ya(u)}" aria-label="YouTube 링크 열기" aria-describedby="${f}">
          <div class="chat-yt-play-row">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
            YouTube
          </div>
          <div id="${f}" class="chat-yt-title">${ge(l)}</div>
        </button>
      `,setTimeout(()=>ic(f,u),100)}else if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(l)){const u=rc(l);r+=`<span class="chat-timestamp" role="button" tabindex="0" data-seek="${u}">${ge(l)}</span>`}else r+=ge(l);a=o.lastIndex}return a<e.length&&(r+=ge(e.slice(a))),r}async function ic(e,t){try{const n=await Wn(t);if(n){const o=document.getElementById(e);o&&(o.textContent=n)}}catch{}}function ac(e,t){const n=document.getElementById("chat-preview-btn");if(!n)return;const o=n.querySelector(".chat-preview-text");o&&(o.textContent=`${e}: ${t}`)}function cc(){if(qe)return;zt++;const e=document.getElementById("chat-preview-badge");e&&(e.textContent=zt>9?"9+":String(zt),e.classList.add("show"))}function lc(){zt=0;const e=document.getElementById("chat-preview-badge");e&&(e.textContent="0",e.classList.remove("show"))}function At(){const e=document.getElementById("chat-drawer");if(e&&(qe=!qe,e.classList.toggle("open",qe),qe)){lc();const t=document.getElementById("chat-messages");t&&(t.scrollTop=t.scrollHeight);const n=document.getElementById("chat-input");n&&setTimeout(()=>n.focus(),300)}}function Oo(){const e=document.getElementById("chat-input");if(!e)return;const t=e.value.trim();if(!t)return;const n=oc(),o=s("audio.channelMode")??0,r=at(o),a=Cr(n);_r(a,t,!0);const i=s("network.myId")||"",l={type:p.CHAT,senderId:i,sender:n,senderLabel:n,senderRole:r,text:t,ts:Date.now()},u=s("network.hostConn");u?u.open&&u.send(l):c.emit("network:broadcast",l),e.value=""}function _r(e,t,n){const o=document.getElementById("chat-messages");if(o){const r=o.querySelector(".chat-empty");r&&r.remove();const a=new Date,i=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`,l=document.createElement("div");if(l.className=`chat-group ${n?"mine":"others"}`,!n){const g=document.createElement("div");g.className="chat-sender",g.innerText=e,l.appendChild(g)}const u=document.createElement("div");u.className="chat-row";const f=document.createElement("div");f.className=`chat-bubble ${n?"mine":"others"}`;const y=document.createElement("div");y.className="chat-text",y.innerHTML=sc(t),f.appendChild(y);try{f.querySelector(".chat-youtube-btn")&&f.classList.add("has-youtube")}catch{}const h=document.createElement("div");h.className="chat-time",h.innerText=i,n?(u.appendChild(h),u.appendChild(f)):(u.appendChild(f),u.appendChild(h)),l.appendChild(u),o.appendChild(l),o.scrollTop=o.scrollHeight}ac(e,t),n||cc()}function uc(e,t){const n=s("network.myId")||"",o=e.senderId||"",r=o===n,a=e.senderLabel||e.sender||sn,i=Cr(a),l=e.text||"";if(_r(i,l,r),!s("network.hostConn")){const f=t?.peer||o||"";c.emit("network:broadcast-except",f,e)}}function dc(){document.addEventListener("click",e=>{const t=e.target?.closest?.(".chat-timestamp[data-seek]");if(!t)return;const n=Number(t.getAttribute("data-seek"));Number.isFinite(n)&&c.emit("player:seek-to-time",n)}),document.addEventListener("keydown",e=>{const t=e.target?.closest?.(".chat-timestamp[data-seek]");if(!t||e.key!=="Enter"&&e.key!==" ")return;e.preventDefault(),e.stopPropagation();const n=Number(t.getAttribute("data-seek"));Number.isFinite(n)&&c.emit("player:seek-to-time",n)}),document.addEventListener("click",e=>{const t=e.target?.closest?.(".chat-youtube-btn[data-youtube-url]");if(!t)return;const n=t.getAttribute("data-youtube-url");n&&c.emit("youtube:load-from-chat",n)})}function fc(e){const t=document.getElementById("chat-input");t&&(t.value+=e,t.focus())}window.insertEmoji=fc;function pc(){J({[p.CHAT]:uc}),dc();const e=document.getElementById("btn-chat-send");e&&e.addEventListener("click",Oo);const t=document.getElementById("btn-chat-close");t&&t.addEventListener("click",At);const n=document.getElementById("chat-preview-btn");n&&n.addEventListener("click",At);const o=document.getElementById("chat-input");o&&o.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),Oo())}),c.on("ui:toggle-chat-drawer",((...r)=>{At()})),c.on("ui:close-chat-drawer",((...r)=>{qe&&At()})),d.info("[Chat] Initialized")}function mc(e){const t=s("playlist.items");t[e]&&(t[e].isExpanded=!t[e].isExpanded,t[e].isExpanded&&t[e].playlistId&&c.emit("youtube:populate-sub-items",t[e].playlistId,e),Rr())}function Rr(){const e=document.getElementById("playlist-ui");if(!e)return;const t=s("playlist.items");if(!Array.isArray(t)){d.warn("[Playlist] playlist is not an array. Resetting."),m("playlist.items",[]);return}if(e.innerHTML="",t.length===0){e.innerHTML='<li class="list-empty-state">미디어를 추가해주세요.</li>';return}const n=s("playlist.currentTrackIndex"),o=s("youtube.currentSubIndex")??-1,r=s("network.hostConn"),a=s("network.isOperator"),i=s("youtube.subItemsMap")||{};t.forEach((u,f)=>{const y=f===n,h=document.createElement("li");h.className=`track-item ${y?"active":""} ${u.playlistId?"is-playlist":""}`;let g="";u.playlistId&&(g=`
        <button type="button" class="expand-toggle ${u.isExpanded?"active":""}" data-expand-idx="${f}" aria-label="플레이리스트 펼치기/접기">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></svg>
        </button>
      `);const E=u.type==="youtube"?'<svg class="type-icon" viewBox="0 0 24 24" style="fill:#ff0000;"><path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47-.13-1.33-.22-2.65-.28-1.3-.07-2.49-.1-3.59-.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/></svg>':'<svg class="type-icon" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.16-1.75 4.45-4H15V6h4V3h-7z"/></svg>',v=u.name||u.title||"Unknown";h.onclick=()=>{r?a&&r.send({type:p.REQUEST_TRACK_CHANGE,index:f}):c.emit("playlist:play-track",f)},h.innerHTML=`
      <div class="track-idx">${f+1}</div>
      <div class="track-name">${E} ${ge(v)}</div>
      ${g}
      <div class="playing-indicator">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
    `,e.appendChild(h);const k=h.querySelector(".expand-toggle[data-expand-idx]");if(k&&k.addEventListener("click",w=>{w.preventDefault(),w.stopPropagation(),mc(f)}),u.playlistId&&u.isExpanded){const w=document.createElement("ul");w.className="sub-playlist";const I=i[u.playlistId];I&&I.ids?I.ids.forEach((A,_)=>{const x=document.createElement("li"),D=y&&_===o;x.className=`sub-track-item ${D?"active":""}`;const U=I.titles&&I.titles[_]?I.titles[_]:`Video ${_+1}`;x.innerHTML=`
            <span class="sub-idx">${_+1}</span>
            <span class="sub-name">${ge(U)}</span>
            <div class="playing-indicator">
              <div class="bar"></div>
              <div class="bar"></div>
              <div class="bar"></div>
            </div>
          `,x.onclick=q=>{q.stopPropagation(),!(r&&!a)&&(r?r.send({type:p.REQUEST_YOUTUBE_SUB_SEEK,playlistIdx:f,subIdx:_}):c.emit("youtube:sub-seek",f,_,y))},w.appendChild(x)}):w.innerHTML='<li class="sub-track-item loading">재생 정보 대기 중...</li>',e.appendChild(w)}});const l=s("transfer.meta");if(n!==-1){const u=t[n];let f="Unknown";l&&l.index===n&&l.name?f=l.name:u&&(f=u.name||u.title||"Unknown"),Tr(f);const y=document.getElementById("track-artist");y&&(u&&u.artist?y.innerText=u.artist:y.innerText=u&&u.type==="youtube"?"YouTube Video":`Track ${n+1}`)}}function yc(){c.on("ui:update-playlist",((...e)=>{Rr()})),d.info("[PlaylistView] Initialized")}const No={0:{label:"Original",placementToast:"기기를 중앙에 놓아주세요"},"-1":{label:"Left",placementToast:"기기를 왼쪽에 놓아주세요"},1:{label:"Right",placementToast:"기기를 오른쪽에 놓아주세요"},2:{label:"Woofer",placementToast:"기기를 중앙에 놓아주세요"}};function hc(e){return No[String(e)]||No[0]}function gc(e){R(hc(e).placementToast)}let On=.5;function bc(){const e=document.getElementById("vol-icon-btn");if(!e)return;const t=e.querySelector("path");if(!t)return;(s("audio.masterVolume")??1)===0?t.setAttribute("d","M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"):t.setAttribute("d","M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z")}function Ec(e){c.emit("audio:set-volume",e/100)}function Sc(e){s("network.hostConn")||(c.emit("network:broadcast",{type:p.VOLUME,value:e/100}),R(`Volume: ${Math.round(e)}%`))}function Tc(){const e=s("audio.masterVolume")??1;if(e>0)On=e,c.emit("audio:set-volume",0),R("Muted"),s("network.hostConn")||c.emit("network:broadcast",{type:p.VOLUME,value:0});else{c.emit("audio:set-volume",On||.5);const t=On||.5;R(`Volume: ${Math.round(t*100)}%`),s("network.hostConn")||c.emit("network:broadcast",{type:p.VOLUME,value:t})}}function z(){const e=document.getElementById("role-badge"),t=document.getElementById("role-text");if(!e||!t)return;if(e.classList.remove("connected"),s("network.isConnecting")){t.innerText="연결 중...";return}if(s("network.hostConn")){const a=s("sync.lastLatencyMs"),i=a&&Number.isFinite(a)?` (${Math.round(a)}ms)`:"",u=(s("network.myDeviceLabel")||"").trim()||"Peer";t.innerText=`${u}${i}`,e.classList.add("connected");return}const r=s("network.appRole");if(r==="host"){t.innerText="Host",e.classList.add("connected");return}if(r==="guest"){t.innerText="Guest";return}t.innerText="SETUP"}function mo(){const e=s("network.sessionCode")||"",t=s("network.lastJoinCode")||"";return e&&/^\d{6}$/.test(e)?e:t&&/^\d{6}$/.test(t)?t:"------"}function bt(){const e=mo();document.querySelectorAll(".invite-code-value").forEach(n=>{n.textContent=e,n.setAttribute("data-code",e)})}function Ar(){const e=s("network.lastKnownDeviceList");if(Array.isArray(e)&&e.length)return e.filter(i=>i&&i.status==="connected").length;const t=s("network.connectedPeers"),n=s("network.hostConn"),o=s("network.appRole"),r=s("setup.sessionStarted"),a=t.filter(i=>i&&i.status==="connected").length;return!n&&(o==="host"||r||a>0)?1+a:n&&n.open?2:1}async function vc(){const e=mo();if(e==="------")return;if(await vr(e)){const n=Ar();R(`연결된 기기 ${n}대 | 초대 코드 ${e}`),document.querySelectorAll(".invite-code-value").forEach(o=>{o.classList.add("copied"),setTimeout(()=>o.classList.remove("copied"),1e3)})}else R("복사하지 못했어요")}function Uo(){if(s("network.hostConn")){R("방장만 미디어를 추가할 수 있어요.");return}re(()=>{const t=document.getElementById("media-source-overlay");t&&(t.classList.add("active"),ve())})}function Lt(){re(()=>{const e=document.getElementById("media-source-overlay");e&&(e.classList.remove("active"),ve())})}function wc(){if(s("network.hostConn")){R("방장만 유튜브 링크를 추가할 수 있어요.");return}re(()=>{const t=document.getElementById("youtube-url-overlay");t&&(t.classList.add("active"),ve());const n=document.getElementById("youtube-url-input");n&&setTimeout(()=>n.focus(),100)})}function kc(){re(()=>{const e=document.getElementById("youtube-url-overlay");e&&(e.classList.remove("active"),ve())})}function Ic(){if(s("network.hostConn")){R("Host만 실행할 수 있습니다.");return}const t=document.getElementById("file-input");if(!t){d.warn("[UI] #file-input not found"),R("파일을 선택할 수 없어요");return}t.click()}function Pc(){if(s("appState")===b.PLAYING_YOUTUBE){R("YouTube 모드에서는 정밀 동기화를 지원하지 않아요");return}s("network.hostConn")?c.emit("sync:auto-sync"):(R("모든 기기 재동기화 요청..."),c.emit("network:broadcast",{type:p.GLOBAL_RESYNC_REQUEST}))}let Nn=!1;async function Bo(){if(!Nn){Nn=!0;try{const e=document.getElementById("setup-overlay");if(!!(e&&e.classList.contains("active"))){gt("play");return}const n=s("network.hostConn"),o=s("network.appRole");if(!!(n||o==="host")&&(await rn({title:"초기 화면",message:`초기 화면으로 돌아갈까요?
현재 세션과 연결이 끊어져요.`,buttonText:"확인",secondaryText:"남아있기",defaultFocus:"secondary"})).action!=="ok")return;c.emit("app:return-to-main")}finally{Nn=!1}}}function Cc(){if(Ge)try{Array.from(document.querySelectorAll('input[type="range"]')).forEach(t=>{const n=t.closest(".tab-content");if(!n)return;let o=null;const r=()=>{o===null&&(o=n.style.overflowY),n.style.overflowY="hidden"},a=()=>{n.style.overflowY=o!==null?o:"",o=null};t.addEventListener("touchstart",r,{passive:!0}),t.addEventListener("touchend",a,{passive:!0}),t.addEventListener("touchcancel",a,{passive:!0})})}catch(e){d.debug("[Android] Range scroll fix init failed:",e)}}function _c(){const e=document.getElementById("seek-slider");if(!e){d.warn("[UI] #seek-slider not found");return}e.addEventListener("mousedown",()=>m("player.isSeeking",!0)),e.addEventListener("touchstart",()=>m("player.isSeeking",!0)),e.addEventListener("input",()=>{const t=document.getElementById("time-curr");t&&(t.innerText=Le(parseFloat(e.value)))}),e.addEventListener("change",()=>{m("player.isSeeking",!1);const t=parseFloat(e.value),n=s("network.hostConn"),o=s("network.isOperator");if(n&&!o)return;if(n&&o){n.send({type:p.REQUEST_SEEK,time:t});return}const r=s("appState");if(r===b.PLAYING_YOUTUBE){c.emit("youtube:seek-to",t);return}r===b.PLAYING_AUDIO||r===b.PLAYING_VIDEO?c.emit("player:seek",t):c.emit("player:seek-to-time",t)}),e.addEventListener("mouseup",()=>m("player.isSeeking",!1)),e.addEventListener("touchend",()=>m("player.isSeeking",!1))}function Rc(){const e=s("audio.masterVolume")??1,t=document.getElementById("volume-slider");t&&(t.value=String(e*100)),bc()}function Ac(){const e=(i,l,u)=>{const f=document.getElementById(i);f&&f.addEventListener(l,u)};e("btn-help","click",()=>gt("guide")),e("btn-fullscreen","click",()=>{try{const i=document,l=document.documentElement,f=document.querySelector(".video-wrapper")||l;!!(document.fullscreenElement||i.webkitFullscreenElement)?document.exitFullscreen?document.exitFullscreen():i.webkitExitFullscreen&&i.webkitExitFullscreen():f.requestFullscreen?f.requestFullscreen():f.webkitRequestFullscreen&&f.webkitRequestFullscreen()}catch{}});const t=document.getElementById("role-badge");if(t){t.setAttribute("role","button"),t.setAttribute("tabindex","0");const i=async l=>{try{l?.preventDefault?.(),l?.stopPropagation?.()}catch{}const u=mo();if(!u||u==="------"){R("초대 코드가 아직 없어요");return}if(await vr(u)){const y=Ar();R(`연결된 기기 ${y}대 | 초대 코드 ${u}`)}else R(`초대 코드: ${u}`)};t.addEventListener("click",i),t.addEventListener("keydown",l=>{l.key!=="Enter"&&l.key!==" "||i(l)})}const n=document.getElementById("app-logo")||document.querySelector(".app-logo");n&&(n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),Bo()}),n.addEventListener("keydown",i=>{i.key!=="Enter"&&i.key!==" "||(i.preventDefault(),Bo())})),e("btn-prev","click",()=>c.emit("playlist:prev-track")),e("play-btn","click",()=>c.emit("player:toggle-play")),e("btn-next","click",()=>c.emit("playlist:next-track")),e("vol-icon-btn","click",()=>Tc()),e("volume-slider","input",function(){Ec(Number(this.value))}),e("volume-slider","change",function(){Sc(Number(this.value))}),e("btn-sync","click",()=>Pc()),e("btn-media-source","click",()=>Uo()),e("btn-repeat","click",()=>c.emit("playlist:toggle-repeat")),e("btn-shuffle","click",()=>c.emit("playlist:toggle-shuffle")),e("btn-add-media","click",()=>Uo()),e("btn-local-file","click",()=>Ic()),e("btn-youtube-source","click",()=>{Lt(),wc()}),e("btn-demo-media","click",()=>{Lt(),c.emit("app:load-demo")}),e("btn-close-media-popup","click",()=>Lt()),e("youtube-url-input","input",function(){c.emit("youtube:preview",this.value)}),e("btn-yt-cancel","click",()=>kc()),e("youtube-play-btn","click",()=>c.emit("youtube:load-from-input")),e("btn-demo-guide","click",()=>{gt("play"),c.emit("app:load-demo")}),_c(),Cc(),c.on("audio:volume-changed",((...i)=>{Rc()})),c.on("network:role-badge-update",((...i)=>{z()})),c.on("sync:latency-update",((...i)=>{z()})),c.on("network:peer-disconnected",((...i)=>{const l=i[0];d.info(`[UI] Peer disconnected: ${l}`),z(),bt()})),document.addEventListener("click",i=>{i.target?.closest?.(".invite-code-container")&&(i.preventDefault(),vc())}),c.on("ui:settings-tab-opened",((...i)=>{bt()}));const o=document.getElementById("file-input");o&&o.addEventListener("change",i=>{Lt(),c.emit("app:files-selected",i.target.files),i.target.value=""}),c.on("opfs:error",((...i)=>{const l=i[0],u=i[1];d.error(`[OPFS] Error for ${l}:`,u),R(`파일 저장 오류: ${l||"unknown"}`)})),c.on("ui:show-toast",((...i)=>{R(i[0])})),c.on("ui:show-loader",((...i)=>{ja(i[0],i[1])})),c.on("ui:update-loader",((...i)=>{Qa(i[0])})),c.on("ui:play-btn-state",((...i)=>{const l=i[0],u=document.getElementById("play-btn");u&&(u.disabled=!l,u.style.opacity=l?"1":"0.4")})),c.on("ui:update-play-state",((...i)=>{const l=i[0],u=document.getElementById("play-btn");u&&u.classList.toggle("playing",l);const f=u?.querySelector("path");f&&f.setAttribute("d",l?"M6 19h4V5H6v14zm8-14v14h4V5h-4z":"M8 5v14l11-7z")})),c.on("ui:duration-update",((...i)=>{const l=i[0],u=document.getElementById("seek-slider"),f=document.getElementById("time-dur");u&&(u.max=String(l)),f&&(f.innerText=Le(l))})),c.on("ui:seek-reset",((...i)=>{const l=document.getElementById("seek-slider"),u=document.getElementById("time-curr");l&&(l.value="0"),u&&(u.innerText="0:00")}));let r=null,a=0;c.on("ui:loop-start",((...i)=>{r&&clearInterval(r),a=0,r=setInterval(()=>{const l=s("appState");if(H(l)){r&&(clearInterval(r),r=null);return}const u=j(),f=document.getElementById("seek-slider"),y=document.getElementById("time-curr");document.getElementById("time-dur");const h=s("player.isSeeking");f&&!h&&(f.value=String(u)),y&&!h&&(y.innerText=Le(u)),a++,a>=2&&(a=0,c.emit("player:check-ended"))},250)})),c.on("player:toggle-play",((...i)=>{Ce()})),c.on("player:seek",((...i)=>{const l=i[0];if(!s("network.hostConn")){B(l);const f=s("playlist.currentTrackIndex");T({type:p.PLAY,time:l,index:f}),Te()}})),c.on("player:seek-to-time",((...i)=>{const l=i[0],u=s("network.hostConn"),f=s("network.isOperator");if(u&&f)u.send({type:p.REQUEST_SEEK,time:l});else if(!u){const y=s("appState"),h=s("playlist.currentTrackIndex");y===b.PLAYING_AUDIO||y===b.PLAYING_VIDEO?(B(l),T({type:p.PLAY,time:l,index:h}),Te()):m("player.pausedAt",l)}})),c.on("playlist:toggle-repeat",((...i)=>{sa()})),c.on("playlist:toggle-shuffle",((...i)=>{ia()})),c.on("player:metadata-update",((...i)=>{const l=i[0];if(!l)return;const u=l.title||l.name||"Unknown";Tr(u)})),c.on("ui:time-update",((...i)=>{const l=i[0],u=i[1],f=i[2],y=i[3],h=document.getElementById("seek-slider"),g=document.getElementById("time-curr"),E=document.getElementById("time-dur"),v=s("player.isSeeking");h&&y>0&&(h.max=String(y),v||(h.value=String(f))),g&&!v&&(g.innerText=l),E&&(E.innerText=u)})),d.info("[PlayerControls] Initialized")}function tt(e){document.querySelectorAll(".theme-opt").forEach(i=>i.classList.remove("active"));const t=e==="light"?"theme-light":e==="dark"?"theme-dark":"theme-system";document.getElementById(t)?.classList.add("active");const n=e==="light"?0:e==="dark"?1:2;document.querySelectorAll(".theme-selector").forEach(i=>{i.style.setProperty("--pill-index",String(n))});let o=e;e==="system"&&(o=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-theme",o);try{localStorage.setItem("musixquare-theme",e)}catch{}document.documentElement.style.colorScheme=o;const r=document.querySelector('meta[name="theme-color"]');r&&r.setAttribute("content",o==="dark"?"#000000":"#f2f2f7");const a=document.querySelector('meta[name="color-scheme"]');a&&a.setAttribute("content",o)}function yo(e){document.querySelectorAll("#grid-standard .ch-opt[data-ch]").forEach(o=>o.classList.remove("active"));const n=document.querySelector(`#grid-standard .ch-opt[data-ch="${e}"]`);n&&n.classList.add("active")}function Lc(e,t){if(s("network.hostConn")){R("역할이 자동 설정되어 변경할 수 없어요.");return}yo(e),c.emit("audio:set-channel-mode",e)}function pe(e,t,n,o=!1){c.emit("audio:update-effect",e,t,n,o)}function Un(e,t=!1){c.emit("audio:set-preamp",e,t)}function Bn(e,t,n=!1){c.emit("audio:set-eq",e,t,n)}function xc(){c.emit("audio:reset-reverb");const e={"reverb-slider":0,"reverb-decay-slider":5,"reverb-predelay-slider":.1,"reverb-lowcut-slider":0,"reverb-highcut-slider":0};for(const[t,n]of Object.entries(e)){const o=document.getElementById(t);o&&(o.value=String(n))}}function Oc(){c.emit("audio:reset-eq");const e=document.getElementById("preamp-slider");e&&(e.value="0");for(let t=0;t<5;t++){const n=document.getElementById(`eq-slider-${t}`);n&&(n.value="0")}}function Do(){c.emit("audio:reset-stereo");const e=document.getElementById("width-slider");e&&(e.value="100")}function Nc(){c.emit("audio:reset-vbass");const e=document.getElementById("vbass-slider");e&&(e.value="0")}function Uc(e){const t=document.getElementById("device-list");t&&(t.innerHTML="",e.forEach(n=>{const o=document.createElement("div");o.className="section-row";const r=document.createElement("span");r.className="d-name",r.textContent=String(n.label||"Device");const a=document.createElement("span");if(a.style.cssText="font-size:11px; opacity:0.5; margin-left:4px;",a.textContent=`(${String(n.id||"").substr(-4)})`,r.appendChild(document.createTextNode(" ")),r.appendChild(a),n.isOp){const y=document.createElement("span");y.style.cssText="color:var(--primary); font-size:10px; font-weight:bold; margin-left:4px;",y.textContent="OP",r.appendChild(document.createTextNode(" ")),r.appendChild(y)}const i=n.status==="connected"?"active":"inactive",l=n.status==="connected"?"Connected":"Disconnected",u=document.createElement("span");if(u.className=`d-status ${i}`,u.textContent=l,o.appendChild(r),s("network.hostConn"))o.appendChild(u);else{const y=document.createElement("div");if(y.style.cssText="display:flex; gap:4px; align-items:center;",!n.isHost&&n.status==="connected"){const h=document.createElement("button");h.className=`btn-action ${n.isOp?"active":""}`,h.dataset.opPeer=String(n.id||""),h.style.cssText=`font-size:10px; padding:4px 8px; margin-right:8px; ${n.isOp?"background:var(--primary); color:white; border:none;":""}`,h.textContent=n.isOp?"REVOKE":"GRANT",h.addEventListener("click",g=>{g.preventDefault();const E=h.dataset.opPeer;E&&c.emit("network:toggle-operator",E)}),y.appendChild(h)}y.appendChild(u),o.appendChild(y)}t.appendChild(o)}))}function Bc(){const e=(o,r,a)=>{const i=document.getElementById(o);i&&i.addEventListener(r,a)};e("theme-light","click",()=>tt("light")),e("theme-dark","click",()=>tt("dark")),e("theme-system","click",()=>tt("system")),e("lang-ko","click",()=>Wt("ko")),e("lang-en","click",()=>Wt("en")),e("lang-system","click",()=>Wt("system")),document.querySelectorAll("#grid-standard .ch-opt[data-ch]").forEach(o=>{o.addEventListener("click",()=>Lc(parseInt(o.dataset.ch,10)))}),e("btn-surround-toggle","click",()=>{if(s("network.hostConn")){R("역할이 자동 설정되어 변경할 수 없어요.");return}const r=s("audio.isSurroundMode");c.emit("audio:toggle-surround",!r);const a=document.getElementById("grid-standard"),i=document.getElementById("grid-surround");a&&(a.style.display=r?"":"none"),i&&(i.style.display=r?"none":"");const l=document.getElementById("btn-surround-toggle");l&&l.classList.toggle("active",!r)}),document.querySelectorAll("#grid-surround .ch-opt[data-surround-ch]").forEach(o=>{o.addEventListener("click",()=>{const r=parseInt(o.dataset.surroundCh,10);c.emit("audio:set-surround-channel",r),document.querySelectorAll("#grid-surround .ch-opt[data-surround-ch]").forEach(a=>a.classList.remove("active")),o.classList.add("active")})}),e("cutoff-slider","input",function(){c.emit("audio:update-effect","cutoff","value",this.value,!0)}),e("cutoff-slider","change",function(){c.emit("audio:update-effect","cutoff","value",this.value)}),e("cutoff-slider","dblclick",function(){c.emit("audio:update-effect","cutoff","value",120),this.value="120"}),e("btn-reset-reverb","click",()=>xc()),[{id:"reverb-slider",param:"mix",resetVal:0},{id:"reverb-decay-slider",param:"decay",resetVal:5},{id:"reverb-predelay-slider",param:"predelay",resetVal:.1},{id:"reverb-lowcut-slider",param:"lowcut",resetVal:0},{id:"reverb-highcut-slider",param:"highcut",resetVal:0}].forEach(({id:o,param:r,resetVal:a})=>{e(o,"input",function(){pe("reverb",r,this.value,!0)}),e(o,"change",function(){pe("reverb",r,this.value)}),e(o,"dblclick",function(){pe("reverb",r,a),this.value=String(a)})}),e("btn-reset-eq","click",()=>Oc()),e("preamp-slider","input",function(){Un(this.value,!0)}),e("preamp-slider","change",function(){Un(this.value)}),e("preamp-slider","dblclick",()=>{Un(0);const o=document.getElementById("preamp-slider");o&&(o.value="0")});for(let o=0;o<5;o++)e(`eq-slider-${o}`,"input",function(){Bn(o,this.value,!0)}),e(`eq-slider-${o}`,"change",function(){Bn(o,this.value)}),e(`eq-slider-${o}`,"dblclick",()=>{Bn(o,0);const r=document.getElementById(`eq-slider-${o}`);r&&(r.value="0")});e("btn-reset-stereo","click",()=>Do()),e("width-slider","input",function(){pe("stereo","mix",this.value,!0)}),e("width-slider","change",function(){pe("stereo","mix",this.value)}),e("width-slider","dblclick",()=>Do()),e("btn-reset-vbass","click",()=>Nc()),e("vbass-slider","input",function(){pe("vbass","mix",this.value,!0)}),e("vbass-slider","change",function(){pe("vbass","mix",this.value)}),e("vbass-slider","dblclick",()=>{pe("vbass","mix",0);const o=document.getElementById("vbass-slider");o&&(o.value="0")}),e("btn-nudge-minus10","click",()=>c.emit("sync:nudge",-10)),e("btn-nudge-minus1","click",()=>c.emit("sync:nudge",-1)),e("btn-nudge-plus1","click",()=>c.emit("sync:nudge",1)),e("btn-nudge-plus10","click",()=>c.emit("sync:nudge",10)),e("btn-auto-sync","click",()=>c.emit("sync:auto-sync")),e("btn-sync-done","click",()=>c.emit("sync:close-manual")),c.on("network:device-list-update",((...o)=>{const r=o[0];Array.isArray(r)&&Uc(r)}));try{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{document.getElementById("theme-system")?.classList.contains("active")&&tt("system")})}catch{}const n=localStorage.getItem("musixquare-theme");tt(n||"system"),d.info("[Settings] Initialized")}const Dc="Peer",Lr=4;let le=0,xr=!1,Se=null,Qe=null,_e=null,Re=null,ut=null;function Fc(){return window.matchMedia("(min-width: 1280px)").matches}function Mc(){if(_e&&Re)try{Re.insertBefore(_e,ut||null)}catch{}_e=null,Re=null,ut=null;const e=document.getElementById("desktop-step-header"),t=document.getElementById("desktop-diagram-area");e&&(e.innerHTML=""),t&&(t.innerHTML="")}function St(){const e=document.getElementById("desktop-step-header"),t=document.getElementById("desktop-diagram-area");if(!e||!t)return;if(!Fc()){Mc();return}if(_e&&Re){try{Re.insertBefore(_e,ut||null)}catch{}_e=null,Re=null,ut=null}t.innerHTML="",e.innerHTML="";const n=[{id:"setup-welcome-area",diagram:()=>document.getElementById("ob-slider-area")},{id:"setup-role-area",diagram:o=>o.querySelector(".setup-graphic-container")},{id:"setup-join-area",diagram:o=>o.querySelector(".setup-guide-unified")},{id:"setup-code-area",diagram:o=>o.querySelector(".setup-guide-unified")}];for(const o of n){const r=document.getElementById(o.id);if(!r||r.style.display==="none")continue;const a=r.querySelector(".setup-header-text");a&&(e.innerHTML=a.innerHTML);const i=o.diagram(r);i&&(Re=i.parentElement,ut=i.nextSibling,_e=i,t.appendChild(i));break}}function L(e){return document.getElementById(e)}function Yc(){re(()=>{const e=L("setup-overlay");e&&e.classList.add("active"),ve();try{document.documentElement.classList.remove("setup-boot-block")}catch{}xr=!0})}function jn(){re(()=>{const e=L("setup-overlay");e&&e.classList.remove("active"),ve(),gn();try{document.documentElement.classList.remove("setup-boot-block")}catch{}try{requestAnimationFrame(()=>{try{document.documentElement.offsetHeight}catch{}})}catch{}})}function Tt(e){re(()=>{const t=L("setup-code-area");t&&(t.style.display=e?"flex":"none"),St()})}function $c(e){const t=L("setup-code");t&&(t.tagName==="INPUT"?t.value=e||"------":t.textContent=e||"------"),Tt(!!e)}function vt(e,t=""){const n=L("setup-instruction");n&&(n.style.display="none",n.textContent=t||"")}function yn(e){re(()=>{const t=L("setup-join-area");t&&(t.style.display=e?"flex":"none"),St()})}function wt(e){re(()=>{const t=L("setup-role-area");t&&(t.style.display=e?"flex":"none"),St()})}function ho(e){re(()=>{const t=L("setup-welcome-area");t&&(t.style.display=e?"flex":"none"),St()})}function hn(e){const t=L("setup-join-code");t&&(t.disabled=!!e);const n=L("setup-role-grid");n&&(n.style.pointerEvents=e?"none":"auto",n.style.opacity=e?"0.6":"1")}function go(e){if(document.querySelectorAll("#setup-role-grid .ch-opt[data-join-ch]").forEach(r=>r.classList.remove("selected")),e!=null){const r=document.querySelector(`#setup-role-grid .ch-opt[data-join-ch="${e}"]`);r&&r.classList.add("selected")}document.querySelectorAll(".setup-graphic-svg .graphic-speaker").forEach(r=>r.classList.remove("active"));let o=null;if(e===-1?o="svg-spk-l":e===1?o="svg-spk-r":e===0?o="svg-spk-center":e===2&&(o="svg-spk-woofer"),o){const r=document.getElementById(o);r&&r.classList.add("active")}}function we(e,t="row"){const n=L("setup-actions");n&&(n.innerHTML="",n.classList.remove("vertical","horizontal-with-back"),t==="vertical"?n.classList.add("vertical"):t==="horizontal-with-back"&&n.classList.add("horizontal-with-back"),e.forEach(o=>{const r=document.createElement("button");r.id=o.id,r.type="button",o.kind==="secondary"?r.className="btn-ob-secondary":o.kind==="text-link"?r.className="btn-ob-text-link":o.kind==="icon-only"?r.className="btn-ob-icon":r.className="btn-ob-primary",o.html?r.innerHTML=o.html:o.text&&(r.textContent=o.text),o.disabled&&(r.disabled=!0),o.onClick&&r.addEventListener("click",o.onClick),n.appendChild(r)}))}const xe='<svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>';function an(){gn(),X("obAutoSlideTimer",()=>{Kn(!0)},5e3,{interval:!0})}function gn(){P("obAutoSlideTimer")}function cn(){const e=L("ob-slider-track"),t=document.querySelectorAll(".ob-dot");e&&(e.style.transform=`translateX(-${le*100}%)`,t.forEach((n,o)=>{n.classList.toggle("active",o===le)}))}function Kn(e=!1){le<Lr-1?le++:le=0,cn(),e!==!0&&an()}function Fo(){le>0?le--:le=Lr-1,cn(),an()}function Hc(){we([{id:"btn-setup-host",text:"제가 방장할래요",kind:"primary",onClick:Qt},{id:"btn-setup-guest",text:"모임에 참여할래요",kind:"secondary",onClick:je}],"vertical")}function Mo(e){const t=s("network.appRole");if(t!=="guest"&&t!=="host")return;Se=e,go(e),gc(e);const n=document.getElementById("btn-setup-next");n&&(n.classList.remove("btn-ob-secondary"),n.classList.add("btn-ob-primary"))}function Qt(){c.emit("audio:activate"),m("network.appRole","host"),m("setup.sessionStarted",!1),Se=null,yn(!1),Tt(!1),ho(!1),wt(!0),vt(),go(null);const e=L("ob-slider-area");e&&(e.style.display="none",gn()),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>dt()},{id:"btn-setup-next",text:"다음으로",kind:"primary",onClick:()=>{Se!==null?Vc(Se):R("역할을 선택해주세요")}}],"horizontal-with-back")}async function Vc(e){if(s("network.appRole")!=="host")return;try{yo(e),c.emit("audio:set-channel-mode",e)}catch(o){d.warn(o)}wt(!1),Tt(!0);const n=L("setup-code");n&&(n.tagName==="INPUT"?n.value="------":n.textContent="------"),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>Qt()},{id:"btn-setup-confirm",text:"잠시만요...",kind:"secondary",disabled:!0}],"horizontal-with-back");try{const o=await Ts();m("network.sessionCode",o),$c(o),bt(),m("network.myDeviceLabel","HOST"),z(),vt(!1),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>Qt()},{id:"btn-setup-confirm",text:"시작하기",kind:"primary",onClick:()=>qc()}],"horizontal-with-back")}catch(o){d.error("[Setup] Host session init failed",o),R("세션을 만들지 못했어요"),Qt()}}function qc(){s("network.appRole")==="host"&&(m("setup.sessionStarted",!0),jn(),R("초대 코드는 설정과 도움말에서 확인할 수 있어요"),z(),setTimeout(()=>{const t=document.getElementById("btn-media-source");t&&(t.classList.add("blink-hint"),t.addEventListener("animationend",()=>{t.classList.remove("blink-hint")},{once:!0}))},400))}function je(){c.emit("audio:activate"),m("network.appRole","guest"),m("setup.sessionStarted",!1),Se=null,bt(),Tt(!1),yn(!1),ho(!1),wt(!0),vt(),go(null),hn(!1);const e=L("ob-slider-area");e&&(e.style.display="none",gn()),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>dt()},{id:"btn-setup-next",text:"다음으로",kind:"primary",onClick:()=>{Se!==null?Gc(Se):R("역할을 선택해주세요")}}],"horizontal-with-back"),m("network.myDeviceLabel","참가자"),z()}function Gc(e){Qe=e,wt(!1),yn(!0),vt(),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>je()},{id:"btn-setup-confirm",text:"시작하기",kind:"primary",onClick:()=>Xn(Qe)}],"horizontal-with-back");const t=L("setup-join-code");t&&(t.value="",t.focus())}async function Xn(e){if(e==null){R("역할을 선택해 주세요");return}if(s("network.appRole")!=="guest")return;const n=L("setup-join-code"),r=(n?n.value:"").trim().replace(/\s+/g,"");if(!/^\d{6}$/.test(r)){R("6자리 코드를 입력해 주세요"),n&&n.focus();return}m("network.lastJoinCode",r),bt(),m("setup.selectedJoinChannelMode",e),m("setup.pendingPlacementToastMode",e);try{yo(e),c.emit("audio:set-channel-mode",e)}catch(a){d.warn("[Setup] setChannelMode failed",a)}m("network.myDeviceLabel",Dc),z(),hn(!0),m("network.isConnecting",!0),z(),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>je()},{id:"btn-setup-confirm",text:"참가하는 중...",kind:"primary",disabled:!0}],"horizontal-with-back"),Mn(r)}function dt(){const e=L("ob-slider-area");e&&(e.style.display="block"),Tt(!1),yn(!1),wt(!1),ho(!0),vt(!1,""),hn(!1),m("network.appRole","idle"),m("network.sessionCode",""),le=0,m("setup.sessionStarted",!1),Se=null,Qe=null,z(),cn(),Hc();const t=()=>{try{c.emit("platform:freeze-layout")}catch{}Yc(),an()};if(!xr)try{document.documentElement.classList.add("setup-boot-block")}catch{}t();const n=L("ob-next");n&&(n.onclick=()=>Kn(!1));const o=L("ob-prev");o&&(o.onclick=()=>Fo()),document.querySelectorAll(".ob-dot").forEach(a=>{a.onclick=i=>{const l=i.target.closest(".ob-dot"),u=parseInt(l?.dataset?.idx||"",10);isNaN(u)||(le=u,cn(),an())}});const r=L("ob-slider-viewport");if(r){let a=0;r.ontouchstart=i=>{a=i.touches[0].clientX},r.ontouchend=i=>{const l=i.changedTouches[0].clientX,u=a-l;Math.abs(u)>50&&(u>0?Kn(!1):Fo())}}}function Wc(){try{window.matchMedia("(min-width: 1280px)").addEventListener("change",()=>St())}catch{}const e=document.getElementById("setup-role-grid");e&&e.addEventListener("click",a=>{const i=a.target.closest(".ch-opt");if(!i)return;const l=parseInt(i.dataset.joinCh||"",10);isNaN(l)||Mo(l)});function t(a){const i=a.target.closest(".graphic-speaker");if(!i)return;const u={"svg-spk-l":-1,"svg-spk-r":1,"svg-spk-center":0,"svg-spk-woofer":2}[i.id];u!==void 0&&Mo(u)}const n=document.getElementById("setup-role-area");n&&n.addEventListener("click",t);const o=document.getElementById("desktop-diagram-area");o&&o.addEventListener("click",t);const r=document.getElementById("setup-join-code");r&&(r.addEventListener("input",()=>{const a=r.value||"",i=a.replace(/\D+/g,"").slice(0,6);a!==i&&(r.value=i)}),r.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),Qe!==null&&Xn(Qe))})),c.on("network:peer-ready",((...a)=>{const i=a[0],l=document.getElementById("my-id");l&&i&&(l.innerText=i),z()})),c.on("setup:hide-overlay",((...a)=>{jn(),z()})),c.on("setup:guest-join-success",((...a)=>{m("network.isConnecting",!1),z(),jn()})),c.on("setup:guest-join-failure",((...a)=>{m("network.isConnecting",!1),z(),R("참가하지 못했어요. 같은 Wi‑Fi에 연결되어 있는지 확인해 보세요."),we([{id:"btn-setup-back",html:xe,kind:"icon-only",onClick:()=>je()},{id:"btn-setup-confirm",text:"시작하기",kind:"primary",onClick:()=>Xn(Qe)}],"horizontal-with-back");const i=L("setup-join-code");i&&(i.disabled=!1,i.focus()),hn(!1)})),c.on("app:return-to-main",((...a)=>{er(),dt()})),c.on("network:error",((...a)=>{const i=a[0],l=i?.message||"",u=i&&typeof i=="object"?String(i.type||""):"";let f="네트워크 오류가 발생했어요";l==="HOST_UNREACHABLE"?f="호스트에 연결할 수 없어요. 같은 Wi‑Fi에 있는지 확인해 보세요.":l==="HOST_DISCONNECTED"?f="호스트와 연결이 끊어졌어요":l==="HOST_CONNECTION_ERROR"?f="호스트 연결 중 오류가 발생했어요":l==="CONNECT_FAILED"?f="연결에 실패했어요":l==="PEER_NOT_READY"?f="피어 연결이 아직 준비되지 않았어요":l==="NETWORK_INIT_FAILED"?f="네트워크 초기화에 실패했어요":l==="NO_HOST_ID"?f="호스트 ID가 없어요":u==="peer-unavailable"?f="상대방을 찾을 수 없어요. 코드를 다시 확인해 주세요.":u==="network"?f="네트워크 연결에 문제가 있어요. 인터넷 연결을 확인해 주세요.":u==="server-error"?f="시그널링 서버에 연결할 수 없어요. 잠시 후 다시 시도해 주세요.":u==="socket-error"||u==="socket-closed"?f="서버와의 연결이 끊어졌어요.":u==="unavailable-id"?f="세션 ID를 사용할 수 없어요. 다시 시도해 주세요.":u==="webrtc"&&(f="WebRTC 연결에 실패했어요. 브라우저 설정을 확인해 주세요."),s("network.isConnecting")?(R(f),c.emit("setup:guest-join-failure",i)):l==="HOST_DISCONNECTED"||l==="HOST_CONNECTION_ERROR"?rn({title:"연결이 끊어졌어요",message:`${f}
다시 연결하시겠어요?`,buttonText:"다시 연결",secondaryText:"돌아가기"}).then(h=>{if(h.action==="ok"){const g=s("network.lastJoinCode")||"";if(je(),g){const E=L("setup-join-code");E&&(E.value=g,E.focus())}}else dt()}):R(f)})),c.on("network:session-full",((...a)=>{const i=a[0]||"세션이 가득 찼어요";rn({title:"참가할 수 없어요",message:String(i)}),je()})),c.on("network:kicked-from-session",((...a)=>{R("호스트에서 연결이 종료되었습니다"),c.emit("app:return-to-main")})),dt(),d.info("[Setup] Initialized")}let Yo=!1,xt=!1;function zc(){if(!("serviceWorker"in navigator)){d.info("[SW] Service Worker not supported");return}if(!window.isSecureContext){d.info("[SW] Not a secure context, skipping registration");return}const e=async()=>{const t=new URL("service-worker.js",window.location.href);try{const n=await navigator.serviceWorker.register(t,{scope:"./"});d.info("[SW] Registered:",n.scope),navigator.serviceWorker.addEventListener("controllerchange",()=>{!Yo||xt||(xt=!0,window.location.reload())}),n.addEventListener("updatefound",()=>{const o=n.installing;o&&o.addEventListener("statechange",async()=>{if(o.state==="installed"&&navigator.serviceWorker.controller)try{const r=await rn({title:"업데이트",message:"새 버전이 준비되었습니다. 새로고침하면 업데이트가 적용됩니다.",buttonText:"새로고침",dismissible:!0});if(!r||r.action!=="ok")return;Yo=!0,n.waiting?n.waiting.postMessage({type:"SKIP_WAITING"}):xt||(xt=!0,window.location.reload())}catch{}})}),setInterval(()=>{n.update().catch(()=>{})},3600*1e3),n.update().catch(()=>{})}catch(n){d.warn("[SW] Registration failed:",n)}};document.readyState==="complete"?e():window.addEventListener("load",e,{once:!0})}function Qc(){window.isSecureContext||(c.emit("ui:show-toast","HTTPS 필수: 보안 연결에서만 작동합니다."),d.warn("[App] Not a secure context")),navigator.storage&&navigator.storage.getDirectory||(c.emit("ui:show-toast","브라우저를 업데이트해 주세요 (iOS 15.2+, Chrome 86+)"),d.warn("[App] OPFS not supported"));const e=[];typeof window.Tone>"u"&&e.push("Tone.js (오디오 엔진)"),typeof window.Peer>"u"&&e.push("PeerJS (P2P 연결)"),e.length>0?(d.error("[App] Missing dependencies:",e.join(", ")),c.emit("ui:show-toast",`필수 라이브러리를 불러오지 못했어요: ${e.join(", ")}. 네트워크를 확인해 주세요.`)):d.info("[App] System compatibility check passed")}function jc(){window.addEventListener("keydown",e=>{if(e.defaultPrevented)return;const t=document.activeElement?.tagName;if(t&&["INPUT","TEXTAREA","SELECT"].includes(t))return;const n=e.target?.closest?.('button, a, [role="button"], input, textarea, select, [contenteditable="true"]');if((e.key===" "||e.code==="Space")&&n)return;const o=s("appState"),r=o===b.PLAYING_AUDIO||o===b.PLAYING_VIDEO||o===b.PLAYING_YOUTUBE;e.key===" "||e.code==="Space"?(e.preventDefault(),c.emit("player:toggle-play")):e.key==="p"||e.key==="P"?r||c.emit("player:toggle-play"):(e.key==="s"||e.key==="S")&&r&&c.emit("player:toggle-play")}),d.info("[App] Keyboard shortcuts registered")}let jt=null;async function $o(){try{"wakeLock"in navigator&&(jt=await navigator.wakeLock.request("screen"),d.debug("[App] Screen Wake Lock active"),jt.addEventListener("release",()=>{d.debug("[App] Screen Wake Lock released"),jt=null}))}catch(e){d.warn(`[App] Wake Lock failed: ${e.name}, ${e.message}`)}}function Kc(){$o(),document.addEventListener("visibilitychange",()=>{jt===null&&document.visibilityState==="visible"&&$o()}),d.info("[App] Wake Lock initialized")}window.onerror=(e,t,n,o,r)=>(d.error(`[Global] ${e} at ${t}:${n}:${o}`,r),!1);window.addEventListener("unhandledrejection",e=>{d.error("[Global] Unhandled rejection:",e.reason)});function Xc(){window.addEventListener("beforeunload",()=>{try{er()}catch{}})}function Ho(){d.info(`[App] MUSIXQUARE 2.0 bootstrap (instance: ${Ot})`),Mr();try{$a()}catch{}Ka(),Za(),ec(),za(),hr(),ya(),Hi(),ga(),Js(),is(),Os(),di(),Ii();try{const t=new Worker(new URL("/assets/sync.worker-CXNdTmrZ.js",import.meta.url),{type:"module"});ds(t),t.postMessage({command:"INIT_INSTANCE",instanceId:Ot}),d.info("[App] SyncWorker started")}catch(t){d.warn("[App] SyncWorker failed:",t)}try{const t=new Worker(new URL("/assets/transfer.worker-2Kp7_Zkv.js",import.meta.url),{type:"module"});us(t),t.postMessage({command:"INIT_INSTANCE",instanceId:Ot}),d.info("[App] TransferWorker started")}catch(t){d.warn("[App] TransferWorker failed:",t)}bi(),Ui(),Mi(),Ra(),Sr(),nc(),pc(),yc(),Ac(),Bc(),Wc(),zc(),jc(),Kc(),Xc(),setTimeout(Qc,100);const e={state:Wr,bus:c,initAudio:Oe,isAudioReady:ts,applySettings:fe,setChannelMode:io};window.__MXQR=e,d.info("[App] Bootstrap complete — all modules loaded")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ho,{once:!0}):Ho();
//# sourceMappingURL=index-DoNP66sO.js.map
